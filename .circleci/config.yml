version: 2.1

orbs:
  slack: circleci/slack@4.10.1
  utils: ethereum-optimism/circleci-utils@0.0.12

executors:
  base:
    machine:
      image: ubuntu-2404:current
  builder:
    docker:
      - image: us-docker.pkg.dev/oplabs-tools-artifacts/images/ci-builder-rust:22ebfb824d959a27a372cca10fe39aeb0b610343

commands:
  install-dependencies:
    description: Install dependencies
    steps:
      # We enable corepack, a nodejs package manager manager
      # that is reponsible for automatically determining the correct version of pnpm to use
      - run:
          name: Enable corepack
          command: corepack enable
      - run:
          name: Install dependencies
          command: just deps
  notify-failures-on-develop:
    description: "Notify Slack"
    parameters:
      channel:
        type: string
        default: C03N11M0BBN
    steps:
      - slack/notify:
          channel: << parameters.channel >>
          event: fail
          template: basic_fail_1
          branch_pattern: develop

jobs:
  lint-specs:
    executor: builder
    steps:
      - checkout
      - run:
          name: markdown lint
          command: just lint-specs-md-check
      - run:
          name: markdown toc
          command: just lint-specs-toc-check

  lint-links:
    executor: builder
    steps:
      - checkout
      - run:
          name: Lint check
          command: just lint-links
      - notify-failures-on-develop:
          channel: C055R639XT9 #notify-link-check

  build-book:
    executor: builder
    steps:
      - checkout
      - install-dependencies
      - run:
          name: Build
          command: just build
      - run:
          name: Add CNAME file
          command: echo "specs.optimism.io" > ./book/html/CNAME
      - persist_to_workspace:
          root: ./book
          paths:
            - html

  publish-book:
    executor: base
    steps:
      - checkout
      - attach_workspace:
          at: /tmp/book
      - utils/get-github-access-token
      - utils/github-pages-deploy:
          src-pages-dir: /tmp/book/html
          pages-branch: gh-pages-test

workflows:
  specs-check:
    when:
      not:
        equal: [scheduled_pipeline, << pipeline.trigger_source >>]
    jobs:
      - lint-specs
      - build-book
  scheduled-links-check:
    when:
      equal: [build_daily, <<pipeline.schedule.name>>]
    jobs:
      - lint-links:
          context: slack

  publish:
    jobs:
      - build-book
      - publish-book:
          requires:
            - build-book
          context: 
            - circleci-repo-specs
          # filters: 
          #   branches:
          #     only: main
