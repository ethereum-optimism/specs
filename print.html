<!DOCTYPE HTML>
<html lang="en" class="ayu sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>OP Stack Specification</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-YNLKSPKGWN"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag() { dataLayer.push(arguments); }
            gtag('js', new Date());
            gtag('config', 'G-YNLKSPKGWN');
        </script>
        <meta name="google-site-verification" content="1XjEcxxHshd6NM_mxbl_uv-SyamI6_99aOpILYI3_mk" />

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="theme/css/footer.css">


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "ayu";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">OP Stack Specification</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/ethereum-optimism/specs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="op-stack-specification"><a class="header" href="#op-stack-specification">OP Stack Specification</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="root.html#about-optimism">About Optimism</a></li>
<li><a href="root.html#about-the-op-stack">About the OP Stack</a></li>
<li><a href="root.html#site-navigation">Site Navigation</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="about-optimism"><a class="header" href="#about-optimism">About Optimism</a></h2>
<p><a href="https://www.optimism.io/">Optimism</a> is a project dedicated to scaling Ethereum's technology and expanding its ability to
coordinate people from across the world to build effective decentralized economies and governance systems. The
<a href="https://www.optimism.io/vision">Optimism Collective</a> builds open-source software that powers scalable blockchains and
aims to address key governance and economic challenges in the wider Ethereum ecosystem. Optimism operates on the
principle of <strong>impact=profit</strong>, the idea that individuals who positively impact the Collective should be proportionally
rewarded with profit.</p>
<p><strong>Change the incentives and you change the world.</strong></p>
<h2 id="about-the-op-stack"><a class="header" href="#about-the-op-stack">About the OP Stack</a></h2>
<p>The OP Stack is a decentralized software stack maintained by the OP Stack that forms the backbone of blockchains like
<a href="https://explorer.optimism.io/">OP Mainnet</a> and <a href="https://base.org">Base</a>. The OP Stack is designed to be aggressively
open-source â€” you are welcome to explore, modify, and extend the OP Stack to your heart's content.</p>
<h2 id="site-navigation"><a class="header" href="#site-navigation">Site Navigation</a></h2>
<p>Navigate this site using the sidebar on the left, the search icon found at the top of this page, or the left/right
navigation buttons found to the sides of each page.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="background"><a class="header" href="#background">Background</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="background.html#overview">Overview</a></li>
<li><a href="background.html#foundations">Foundations</a>
<ul>
<li><a href="background.html#ethereum-scalability">Ethereum Scalability</a></li>
<li><a href="background.html#optimistic-rollups">Optimistic Rollups</a></li>
<li><a href="background.html#evm-equivalence">EVM Equivalence</a></li>
</ul>
</li>
<li><a href="background.html#protocol-guarantees">Protocol Guarantees</a>
<ul>
<li><a href="background.html#liveness">Liveness</a></li>
<li><a href="background.html#validity">Validity</a></li>
<li><a href="background.html#availability">Availability</a></li>
</ul>
</li>
<li><a href="background.html#network-participants">Network Participants</a>
<ul>
<li><a href="background.html#users">Users</a></li>
<li><a href="background.html#sequencers">Sequencers</a></li>
<li><a href="background.html#verifiers">Verifiers</a></li>
</ul>
</li>
<li><a href="background.html#key-interaction-diagrams">Key Interaction Diagrams</a>
<ul>
<li><a href="background.html#depositing-and-sending-transactions">Depositing and Sending Transactions</a></li>
<li><a href="background.html#withdrawing">Withdrawing</a></li>
</ul>
</li>
<li><a href="background.html#next-steps">Next Steps</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>The OP Stack is a decentralized software stack maintained by the OP Stack that forms the backbone of blockchains like
<a href="https://explorer.optimism.io/">OP Mainnet</a> and <a href="https://base.org">Base</a>. The OP Stack provides the infrastructure for
operating EVM equivalent rollup blockchains designed to scale Ethereum while remaining maximally compatible with
existing Ethereum infrastructure. This document provides an overview of the protocol to provide context for the rest of
the specification.</p>
<h2 id="foundations"><a class="header" href="#foundations">Foundations</a></h2>
<h3 id="ethereum-scalability"><a class="header" href="#ethereum-scalability">Ethereum Scalability</a></h3>
<p>Scaling Ethereum means increasing the number of useful transactions the Ethereum network can process. Ethereum's
limited resources, specifically bandwidth, computation, and storage, constrain the number of transactions which can be
processed on the network. Of the three resources, computation and storage are currently the most significant
bottlenecks. These bottlenecks limit the supply of transactions, leading to extremely high fees. Scaling ethereum and
reducing fees can be achieved by better utilizing bandwidth, computation and storage.</p>
<h3 id="optimistic-rollups"><a class="header" href="#optimistic-rollups">Optimistic Rollups</a></h3>
<p>An <a href="https://vitalik.eth.limo/general/2021/01/05/rollup.html">Optimistic Rollup</a> is a layer 2 scalability construction which
increases the computation &amp; storage capacity of Ethereum while aiming to minimize sacrifices to scalability or
decentralization. In a nutshell, an Optimistic Rollup utilizes Ethereum (or some other data availability layer) to host
transaction data. Layer 2 nodes then execute a state transition function over this data. Users can propose the result of
this off-chain execution to a smart contract on L1. A "fault proving" process can then demonstrate that a user's proposal
is (or is not) valid.</p>
<h3 id="evm-equivalence"><a class="header" href="#evm-equivalence">EVM Equivalence</a></h3>
<p><a href="https://medium.com/ethereum-optimism/introducing-evm-equivalence-5c2021deb306">EVM Equivalence</a> is complete compliance
with the state transition function described in the Ethereum yellow paper, the formal definition of the protocol. By
conforming to the Ethereum standard across EVM equivalent rollups, smart contract developers can write once and deploy
anywhere.</p>
<h2 id="protocol-guarantees"><a class="header" href="#protocol-guarantees">Protocol Guarantees</a></h2>
<p>We strive to preserve three critical properties: liveness, validity, and availability.
A protocol that can maintain these properties can, effectively, scale Ethereum without sacrificing security.</p>
<h3 id="liveness"><a class="header" href="#liveness">Liveness</a></h3>
<p>Liveness is defined as the ability for any party to be able to extend the rollup chain by including a transaction within
a bounded amount of time. It should not be possible for an actor to block the inclusion of any given transaction for more
than this bounded time period. This bounded time period should also be acceptable such that inclusion is not just
theoretically possible but practically useful.</p>
<h3 id="validity"><a class="header" href="#validity">Validity</a></h3>
<p>Validity is defined as the ability for any party to execute the rollup state transition function, subject to certain lower
bound expectations for available computing and bandwidth resources. Validity is also extended to refer to the ability for
a smart contract on Ethereum to be able to validate this state transition function economically.</p>
<h3 id="availability"><a class="header" href="#availability">Availability</a></h3>
<p>Availability is defined as the ability for any party to retrieve the inputs that are necessary to execute the rollup state
transition function correctly. Availability is essentially an element of validity and is required to be able to guarantee
validity in general. Similar to validity, availability is subject to lower bound resource requirements.</p>
<h2 id="network-participants"><a class="header" href="#network-participants">Network Participants</a></h2>
<p>Generally speaking, there are three primary actors that interact with an OP Stack chain: users, sequencers, and verifiers.</p>
<pre class="mermaid">graph TD
    EthereumL1(Ethereum L1)

    subgraph &quot;L2 Participants&quot;
        Users(Users)
        Sequencers(Sequencers)
        Verifiers(Verifiers)
    end

    Verifiers -.-&gt;|fetch transaction batches| EthereumL1
    Verifiers -.-&gt;|fetch deposit data| EthereumL1
    Verifiers --&gt;|submit/validate/challenge output proposals| EthereumL1
    Verifiers -.-&gt;|fetch realtime P2P updates| Sequencers
    
    Users --&gt;|submit deposits/withdrawals| EthereumL1
    Users --&gt;|submit transactions| Sequencers
    Users --&gt;|query data| Verifiers


    Sequencers --&gt;|submit transaction batches| EthereumL1
    Sequencers -.-&gt;|fetch deposit data| EthereumL1

    classDef l1Contracts stroke:#bbf,stroke-width:2px;
    classDef l2Components stroke:#333,stroke-width:2px;
    classDef systemUser stroke:#f9a,stroke-width:2px;

    class EthereumL1 l1Contracts;
    class Users,Sequencers,Verifiers l2Components;
</pre>
<h3 id="users"><a class="header" href="#users">Users</a></h3>
<p>Users are the general class of network participants who:</p>
<ul>
<li>Submit transactions through a Sequencer or by interacting with contracts on Ethereum.</li>
<li>Query transaction data from interfaces operated by verifiers.</li>
</ul>
<h3 id="sequencers"><a class="header" href="#sequencers">Sequencers</a></h3>
<p>Sequencers fill the role of the block producer on an OP Stack chain. Chains may have a single Sequencer or may choose to
utilize some consensus protocol that coordinates multiple Sequencers. The OP Stack currently officially only supports a
single active Sequencer at any given time. In general, specifications may use the term "the Sequencer" as a stand-in for
either a single Sequencer or a consensus protocol of multiple Sequencers.</p>
<p>The Sequencer:</p>
<ul>
<li>Accepts transactions directly from Users.</li>
<li>Observes "deposit" transactions generated on Ethereum.</li>
<li>Consolidates both transaction streams into ordered L2 blocks.</li>
<li>Submits information to L1 that is sufficient to fully reproduce those L2 blocks.</li>
<li>Provides real-time access to pending L2 blocks that have not yet been confirmed on L1.</li>
</ul>
<p>The Sequencer serves an important role for the operation of an L2 chain but is not a trusted actor. The Sequencer is generally
responsible for improving the user experience by ordering transactions much more quickly and cheaply than would currently
be possible if users were to submit all transactions directly to L1.</p>
<h3 id="verifiers"><a class="header" href="#verifiers">Verifiers</a></h3>
<p>Verifiers download and execute the L2 state transition function independently of the Sequencer. Verifiers help to maintain
the integrity of the network and serve blockchain data to Users.</p>
<p>Verifiers generally:</p>
<ul>
<li>Download rollup data from L1 and the Sequencer.</li>
<li>Use rollup data to execute the L2 state transition function.</li>
<li>Serve rollup data and computed L2 state information to Users.</li>
</ul>
<p>Verifiers can also act as Proposers and/or Challengers who:</p>
<ul>
<li>Submit assertions about the state of the L2 to a smart contract on L1.</li>
<li>Validate assertions made by other participants.</li>
<li>Dispute invalid assertions made by other participants.</li>
</ul>
<h2 id="key-interaction-diagrams"><a class="header" href="#key-interaction-diagrams">Key Interaction Diagrams</a></h2>
<h3 id="depositing-and-sending-transactions"><a class="header" href="#depositing-and-sending-transactions">Depositing and Sending Transactions</a></h3>
<p>Users will often begin their L2 journey by depositing ETH from L1.
Once they have ETH to pay fees, they'll start sending transactions on L2.
The following diagram demonstrates this interaction and all key OP Stack components which are or should be utilized:</p>
<pre class="mermaid">graph TD
    subgraph &quot;Ethereum L1&quot;
        OptimismPortal(&lt;a href=&quot;./protocol/withdrawals.html#the-optimism-portal-contract&quot;&gt;OptimismPortal&lt;/a&gt;)
        BatchInbox(&lt;a href=&quot;../glossary.html#batcher-transaction&quot;&gt;Batch Inbox Address&lt;/a&gt;)
    end

    Sequencer(Sequencer)
    Users(Users)

    %% Interactions
    Users --&gt;|&lt;b&gt;1.&lt;/b&gt; submit deposit| OptimismPortal
    Sequencer -.-&gt;|&lt;b&gt;2.&lt;/b&gt; fetch deposit events| OptimismPortal
    Sequencer --&gt;|&lt;b&gt;3.&lt;/b&gt; generate deposit block| Sequencer
    Users --&gt;|&lt;b&gt;4.&lt;/b&gt; send transactions| Sequencer
    Sequencer --&gt;|&lt;b&gt;5.&lt;/b&gt; submit transaction batches| BatchInbox

    classDef l1Contracts stroke:#bbf,stroke-width:2px;
    classDef l2Components stroke:#333,stroke-width:2px;
    classDef systemUser stroke:#f9a,stroke-width:2px;

    class OptimismPortal,BatchInbox l1Contracts;
    class Sequencer l2Components;
    class Users systemUser;
</pre>
<h3 id="withdrawing"><a class="header" href="#withdrawing">Withdrawing</a></h3>
<p>Users may also want to withdraw ETH or ERC20 tokens from an OP Stack chain back to Ethereum. Withdrawals are initiated
as standard transactions on L2 but are then completed using transactions on L1. Withdrawals must reference a valid
<code>FaultDisputeGame</code> contract that proposes the state of the L2 at a given point in time.</p>
<pre class="mermaid">graph LR
    subgraph &quot;Ethereum L1&quot;
        BatchInbox(&lt;a href=&quot;../glossary.html#batcher-transaction&quot;&gt;Batch Inbox Address&lt;/a&gt;)
        DisputeGameFactory(&lt;a href=&quot;../fault-proof/stage-one/dispute-game-interface.html#disputegamefactory-interface&quot;&gt;DisputeGameFactory&lt;/a&gt;)
        FaultDisputeGame(&lt;a href=&quot;../fault-proof/stage-one/fault-dispute-game.html&quot;&gt;FaultDisputeGame&lt;/a&gt;)
        OptimismPortal(&lt;a href=&quot;./protocol/withdrawals.html#the-optimism-portal-contract&quot;&gt;OptimismPortal&lt;/a&gt;)
        ExternalContracts(External Contracts)
    end

    Sequencer(Sequencer)
    Proposers(Proposers)
    Users(Users)

    %% Interactions
    Users --&gt;|&lt;b&gt;1.&lt;/b&gt; send withdrawal initialization txn| Sequencer
    Sequencer --&gt;|&lt;b&gt;2.&lt;/b&gt; submit transaction batch| BatchInbox
    Proposers --&gt;|&lt;b&gt;3.&lt;/b&gt; submit output proposal| DisputeGameFactory
    DisputeGameFactory --&gt;|&lt;b&gt;4.&lt;/b&gt; generate game| FaultDisputeGame
    Users --&gt;|&lt;b&gt;5.&lt;/b&gt; submit withdrawal proof| OptimismPortal
    Users --&gt;|&lt;b&gt;6.&lt;/b&gt; wait for finalization| FaultDisputeGame
    Users --&gt;|&lt;b&gt;7.&lt;/b&gt; submit withdrawal finalization| OptimismPortal
    OptimismPortal --&gt;|&lt;b&gt;8.&lt;/b&gt; check game validity| FaultDisputeGame
    OptimismPortal --&gt;|&lt;b&gt;9.&lt;/b&gt; execute withdrawal transaction| ExternalContracts

    %% Styling
    classDef l1Contracts stroke:#bbf,stroke-width:2px;
    classDef l2Components stroke:#333,stroke-width:2px;
    classDef systemUser stroke:#f9a,stroke-width:2px;

    class BatchInbox,DisputeGameFactory,FaultDisputeGame,OptimismPortal l1Contracts;
    class Sequencer l2Components;
    class Users,Proposers systemUser;
</pre>
<h2 id="next-steps"><a class="header" href="#next-steps">Next Steps</a></h2>
<p>Check out the sidebar to the left to find any specification you might want to read, or click one of the links embedded
in one of the above diagrams to learn about particular components that have been mentioned.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="optimism-overview"><a class="header" href="#optimism-overview">Optimism Overview</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/overview.html#architecture-design-goals">Architecture Design Goals</a></li>
<li><a href="protocol/overview.html#architecture-overview">Architecture Overview</a>
<ul>
<li><a href="protocol/overview.html#core-l1-smart-contracts">Core L1 Smart Contracts</a>
<ul>
<li><a href="protocol/overview.html#notes-for-core-l1-smart-contracts">Notes for Core L1 Smart Contracts</a></li>
</ul>
</li>
<li><a href="protocol/overview.html#core-l2-smart-contracts">Core L2 Smart Contracts</a>
<ul>
<li><a href="protocol/overview.html#notes-for-core-l2-smart-contracts">Notes for Core L2 Smart Contracts</a></li>
</ul>
</li>
<li><a href="protocol/overview.html#smart-contract-proxies">Smart Contract Proxies</a></li>
<li><a href="protocol/overview.html#l2-node-components">L2 Node Components</a></li>
<li><a href="protocol/overview.html#transactionblock-propagation">Transaction/Block Propagation</a></li>
</ul>
</li>
<li><a href="protocol/overview.html#key-interactions-in-depth">Key Interactions In Depth</a>
<ul>
<li><a href="protocol/overview.html#deposits">Deposits</a></li>
<li><a href="protocol/overview.html#block-derivation">Block Derivation</a>
<ul>
<li><a href="protocol/overview.html#overview">Overview</a></li>
<li><a href="protocol/overview.html#epochs-and-the-sequencing-window">Epochs and the Sequencing Window</a></li>
<li><a href="protocol/overview.html#block-derivation-loop">Block Derivation Loop</a></li>
</ul>
</li>
<li><a href="protocol/overview.html#engine-api">Engine API</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<p>This document is a high-level technical overview of the Optimism protocol. It aims to explain how the protocol works in
an informal manner, and direct readers to other parts of the specification so that they may learn more.</p>
<p>This document assumes you've read the <a href="protocol/../background.html">background</a>.</p>
<h2 id="architecture-design-goals"><a class="header" href="#architecture-design-goals">Architecture Design Goals</a></h2>
<ul>
<li><strong>Execution-Level EVM Equivalence:</strong> The developer experience should be identical to L1 except where L2 introduces a
fundamental difference.
<ul>
<li>No special compiler.</li>
<li>No unexpected gas costs.</li>
<li>Transaction traces work out-of-the-box.</li>
<li>All existing Ethereum tooling works - all you have to do is change the chain ID.</li>
</ul>
</li>
<li><strong>Maximal compatibility with ETH1 nodes:</strong> The implementation should minimize any differences with a vanilla Geth
node, and leverage as many existing L1 standards as possible.
<ul>
<li>The execution engine/rollup node uses the ETH2 Engine API to build the canonical L2 chain.</li>
<li>The execution engine leverages Geth's existing mempool and sync implementations, including snap sync.</li>
</ul>
</li>
<li><strong>Minimize state and complexity:</strong>
<ul>
<li>Whenever possible, services contributing to the rollup infrastructure are stateless.</li>
<li>Stateful services can recover to full operation from a fresh DB using the peer-to-peer network and on-chain sync
mechanisms.</li>
<li>Running a replica is as simple as running a Geth node.</li>
</ul>
</li>
</ul>
<h2 id="architecture-overview"><a class="header" href="#architecture-overview">Architecture Overview</a></h2>
<h3 id="core-l1-smart-contracts"><a class="header" href="#core-l1-smart-contracts">Core L1 Smart Contracts</a></h3>
<p>Below you'll find an architecture diagram describing the core L1 smart contracts for the OP Stack.
Smart contracts that are considered "peripheral" and not core to the operation of the OP Stack system are described separately.</p>
<pre class="mermaid">graph LR
    subgraph &quot;External Contracts&quot;
        ExternalERC20(External ERC20 Contracts)
        ExternalERC721(External ERC721 Contracts)
    end

    subgraph &quot;L1 Smart Contracts&quot;
        BatchDataEOA(&lt;a href=&quot;../glossary.html#batcher-transaction&quot;&gt;Batch Inbox Address&lt;/a&gt;)
        L1StandardBridge(&lt;a href=&quot;./bridges.html&quot;&gt;L1StandardBridge&lt;/a&gt;)
        L1ERC721Bridge(&lt;a href=&quot;./bridges.html&quot;&gt;L1ERC721Bridge&lt;/a&gt;)
        L1CrossDomainMessenger(&lt;a href=&quot;./messengers.html&quot;&gt;L1CrossDomainMessenger&lt;/a&gt;)
        OptimismPortal(&lt;a href=&quot;./withdrawals.html#the-optimism-portal-contract&quot;&gt;OptimismPortal&lt;/a&gt;)
        SuperchainConfig(&lt;a href=&quot;./superchain-config.html&quot;&gt;SuperchainConfig&lt;/a&gt;)
        SystemConfig(&lt;a href=&quot;./system-config.html&quot;&gt;SystemConfig&lt;/a&gt;)
        DisputeGameFactory(&lt;a href=&quot;../fault-proof/stage-one/dispute-game-interface.html#disputegamefactory-interface&quot;&gt;DisputeGameFactory&lt;/a&gt;)
        FaultDisputeGame(&lt;a href=&quot;../fault-proof/stage-one/fault-dispute-game.html&quot;&gt;FaultDisputeGame&lt;/a&gt;)
        AnchorStateRegistry(&lt;a href=&quot;../fault-proof/stage-one/fault-dispute-game.html#anchor-state-registry&quot;&gt;AnchorStateRegistry&lt;/a&gt;)
        DelayedWETH(&lt;a href=&quot;../fault-proof/stage-one/bond-incentives.html#delayedweth#de&quot;&gt;DelayedWETH&lt;/a&gt;)
    end

    subgraph &quot;User Interactions (Permissionless)&quot;
        Users(Users)
        Challengers(Challengers)
    end

    subgraph &quot;System Interactions&quot;
        Guardian(Guardian)
        Batcher(&lt;a href=&quot;./batcher.html&quot;&gt;Batcher&lt;/a&gt;)
    end

    subgraph &quot;Layer 2 Interactions&quot;
        L2Nodes(Layer 2 Nodes)
    end

    L2Nodes -.-&gt;|fetch transaction batches| BatchDataEOA
    L2Nodes -.-&gt;|fetch deposit events| OptimismPortal

    Batcher --&gt;|publish transaction batches| BatchDataEOA

    ExternalERC20 &lt;--&gt;|mint/burn/transfer tokens| L1StandardBridge
    ExternalERC721 &lt;--&gt;|mint/burn/transfer tokens| L1ERC721Bridge

    L1StandardBridge &lt;--&gt;|send/receive messages| L1CrossDomainMessenger
    L1StandardBridge -.-&gt;|query pause state| SuperchainConfig

    L1ERC721Bridge &lt;--&gt;|send/receive messages| L1CrossDomainMessenger
    L1ERC721Bridge -.-&gt;|query pause state| SuperchainConfig

    L1CrossDomainMessenger &lt;--&gt;|send/receive messages| OptimismPortal
    L1CrossDomainMessenger -.-&gt;|query pause state| SuperchainConfig

    OptimismPortal -.-&gt;|query pause state| SuperchainConfig
    OptimismPortal -.-&gt;|query config| SystemConfig
    OptimismPortal -.-&gt;|query state proposals| DisputeGameFactory

    DisputeGameFactory --&gt;|generate instances| FaultDisputeGame

    FaultDisputeGame --&gt;|store bonds| DelayedWETH
    FaultDisputeGame --&gt;|query/update anchor states| AnchorStateRegistry

    Users &lt;--&gt;|deposit/withdraw ETH/ERC20s| L1StandardBridge
    Users &lt;--&gt;|deposit/withdraw ERC721s| L1ERC721Bridge
    Users --&gt;|prove/execute withdrawals| OptimismPortal

    Challengers --&gt;|propose output roots| DisputeGameFactory
    Challengers --&gt;|verify/challenge/defend proposals| FaultDisputeGame

    Guardian --&gt;|pause/unpause| SuperchainConfig
    Guardian --&gt;|safety net actions| OptimismPortal
    Guardian --&gt;|safety net actions| DisputeGameFactory
    Guardian --&gt;|safety net actions| DelayedWETH

    classDef extContracts stroke:#ff9,stroke-width:2px;
    classDef l1Contracts stroke:#bbf,stroke-width:2px;
    classDef l1EOA stroke:#bbb,stroke-width:2px;
    classDef userInt stroke:#f9a,stroke-width:2px;
    classDef systemUser stroke:#f9a,stroke-width:2px;
    classDef l2Nodes stroke:#333,stroke-width:2px
    class ExternalERC20,ExternalERC721 extContracts;
    class L1StandardBridge,L1ERC721Bridge,L1CrossDomainMessenger,OptimismPortal,SuperchainConfig,SystemConfig,DisputeGameFactory,FaultDisputeGame,DelayedWETH,AnchorStateRegistry l1Contracts;
    class BatchDataEOA l1EOA;
    class Users,Challengers userInt;
    class Batcher,Guardian systemUser;
    class L2Nodes l2Nodes;
</pre>
<h4 id="notes-for-core-l1-smart-contracts"><a class="header" href="#notes-for-core-l1-smart-contracts">Notes for Core L1 Smart Contracts</a></h4>
<ul>
<li>The <code>Batch Inbox Address</code> described above (<strong>highlighted in GREY</strong>) is <em>not</em> a smart contract and is instead an arbitrarily
selected account that is assumed to have no known private key. The convention for deriving this account's address is
provided on the <a href="protocol/./configurability.html#consensus-parameters">Configurability</a> page.
<ul>
<li>Historically, it was often derived as
<code>0xFF0000....&lt;L2 chain ID&gt;</code> where <code>&lt;L2 chain ID&gt;</code> is chain ID of the Layer 2 network for which the data is being posted.
This is why many chains, such as OP Mainnet, have a batch inbox address of this form.</li>
</ul>
</li>
<li>Smart contracts that sit behind <code>Proxy</code> contracts are <strong>highlighted in BLUE</strong>. Refer to the
<a href="protocol/overview.html#smart-contract-proxies">Smart Contract Proxies</a> section below to understand how these proxies are designed.
<ul>
<li>The <code>L1CrossDomainMessenger</code> contract sits behind the <a href="https://github.com/ethereum-optimism/optimism/tree/develop/packages/contracts-bedrock/src/legacy/ResolvedDelegateProxy.sol"><code>ResolvedDelegateProxy</code></a>
contract, a legacy proxy contract type used within older versions of the OP Stack. This proxy type is used exclusively
for the <code>L1CrossDomainMessenger</code> to maintain backwards compatibility.</li>
<li>The <code>L1StandardBridge</code> contract sits behind the <a href="https://github.com/ethereum-optimism/optimism/tree/develop/packages/contracts-bedrock/src/legacy/L1ChugSplashProxy.sol"><code>L1ChugSplashProxy</code></a>
contract, a legacy proxy contract type used within older versions of the OP Stack. This proxy type is used exclusively
for the <code>L1StandardBridge</code> contract to maintain backwards compatibility.</li>
</ul>
</li>
</ul>
<h3 id="core-l2-smart-contracts"><a class="header" href="#core-l2-smart-contracts">Core L2 Smart Contracts</a></h3>
<p>Here you'll find an architecture diagram describing the core OP Stack smart contracts that exist natively on the L2 chain
itself.</p>
<pre class="mermaid">graph LR
    subgraph &quot;Layer 1 (Ethereum)&quot;
        L1SmartContracts(L1 Smart Contracts)
    end

    subgraph &quot;L2 Client&quot;
        L2Node(L2 Node)
    end

    subgraph &quot;L2 System Contracts&quot;
        L1Block(&lt;a href=&quot;./predeploys.html#l1block&quot;&gt;L1Block&lt;/a&gt;)
        GasPriceOracle(&lt;a href=&quot;./predeploys.html#gaspriceoracle&quot;&gt;GasPriceOracle&lt;/a&gt;)
        L1FeeVault(&lt;a href=&quot;./predeploys.html#l1feevault&quot;&gt;L1FeeVault&lt;/a&gt;)
        BaseFeeVault(&lt;a href=&quot;./predeploys.html#basefeevault&quot;&gt;BaseFeeVault&lt;/a&gt;)
        SequencerFeeVault(&lt;a href=&quot;./predeploys.html#sequencerfeevault&quot;&gt;SequencerFeeVault&lt;/a&gt;)
    end

    subgraph &quot;L2 Bridge Contracts&quot;
        L2CrossDomainMessenger(&lt;a href=&quot;./predeploys.html#l2crossdomainmessenger&quot;&gt;L2CrossDomainMessenger&lt;/a&gt;)
        L2ToL1MessagePasser(&lt;a href=&quot;./predeploys.html#l2tol1messagepasser&quot;&gt;L2ToL1MessagePasser&lt;/a&gt;)
        L2StandardBridge(&lt;a href=&quot;./predeploys.html#l2standardbridge&quot;&gt;L2StandardBridge&lt;/a&gt;)
        L2ERC721Bridge(&lt;a href=&quot;./predeploys.html&quot;&gt;L2ERC721Bridge&lt;/a&gt;)
    end

    subgraph &quot;Transactions&quot;
        DepositTransaction(Deposit Transaction)
        UserTransaction(User Transaction)
    end

    subgraph &quot;External Contracts&quot;
        ExternalERC20(External ERC20 Contracts)
        ExternalERC721(External ERC721 Contracts)
    end

    subgraph &quot;Remaining L2 Universe&quot;
        OtherContracts(Any Contracts and Addresses)
    end

    L2Node -.-&gt;|derives chain from| L1SmartContracts
    L2Node --&gt;|updates| L1Block
    L2Node --&gt;|distributes fees to| L1FeeVault
    L2Node --&gt;|distributes fees to| BaseFeeVault
    L2Node --&gt;|distributes fees to| SequencerFeeVault
    L2Node --&gt;|derives from deposits| DepositTransaction
    L2Node --&gt;|derives from chain data| UserTransaction

    UserTransaction --&gt;|can trigger| OtherContracts
    DepositTransaction --&gt;|maybe triggers| L2CrossDomainMessenger
    DepositTransaction --&gt;|can trigger| OtherContracts

    ExternalERC20 &lt;--&gt;|mint/burn/transfer| L2StandardBridge
    ExternalERC721 &lt;--&gt;|mint/burn/transfer| L2ERC721Bridge

    L2StandardBridge &lt;--&gt;|sends/receives messages| L2CrossDomainMessenger
    L2ERC721Bridge &lt;--&gt;|sends/receives messages| L2CrossDomainMessenger
    GasPriceOracle -.-&gt;|queries| L1Block
    L2CrossDomainMessenger --&gt;|sends messages| L2ToL1MessagePasser

    classDef extContracts stroke:#ff9,stroke-width:2px;
    classDef l2Contracts stroke:#bbf,stroke-width:2px;
    classDef transactions stroke:#fba,stroke-width:2px;
    classDef l2Node stroke:#f9a,stroke-width:2px;

    class ExternalERC20,ExternalERC721 extContracts;
    class L2CrossDomainMessenger,L2ToL1MessagePasser,L2StandardBridge,L2ERC721Bridge l2Contracts;
    class L1Block,L1FeeVault,BaseFeeVault,SequencerFeeVault,GasPriceOracle l2Contracts;
    class UserTransaction,DepositTransaction transactions;
    class L2Node l2Node;
</pre>
<h4 id="notes-for-core-l2-smart-contracts"><a class="header" href="#notes-for-core-l2-smart-contracts">Notes for Core L2 Smart Contracts</a></h4>
<ul>
<li>Contracts highlighted as "L2 System Contracts" are updated or mutated automatically as part of the chain derivation
process. Users typically do not mutate these contracts directly, except in the case of the <code>FeeVault</code> contracts where
any user may trigger a withdrawal of collected fees to the pre-determined withdrawal address.</li>
<li>Smart contracts that sit behind <code>Proxy</code> contracts are <strong>highlighted in BLUE</strong>. Refer to the
<a href="protocol/overview.html#smart-contract-proxies">Smart Contract Proxies</a> section below to understand how these proxies are designed.</li>
<li>User interactions for the "L2 Bridge Contracts" have been omitted from this diagram but largely follow the same user
interactions described in the architecture diagram for the <a href="protocol/overview.html#core-l1-smart-contracts">Core L1 Smart Contracts</a>.</li>
</ul>
<h3 id="smart-contract-proxies"><a class="header" href="#smart-contract-proxies">Smart Contract Proxies</a></h3>
<p>Most OP Stack smart contracts sit behind <code>Proxy</code> contracts that are managed by a <code>ProxyAdmin</code> contract.
The <code>ProxyAdmin</code> contract is controlled by some <code>owner</code> address that can be any EOA or smart contract.
Below you'll find a diagram that explains the behavior of the typical proxy contract.</p>
<pre class="mermaid">graph LR
    ProxyAdminOwner(Proxy Admin Owner)
    ProxyAdmin(&lt;a href=&quot;https://github.com/ethereum-optimism/optimism/blob/develop/packages/contracts-bedrock/src/universal/ProxyAdmin.sol&quot;&gt;ProxyAdmin&lt;/a&gt;)

    subgraph &quot;Logical Smart Contract&quot;
        Proxy(&lt;a href=&quot;https://github.com/ethereum-optimism/optimism/blob/develop/packages/contracts-bedrock/src/universal/Proxy.sol&quot;&gt;Proxy&lt;/a&gt;)
        Implementation(Implementation)
    end

    ProxyAdminOwner --&gt;|manages| ProxyAdmin
    ProxyAdmin --&gt;|upgrades| Proxy
    Proxy --&gt;|delegatecall| Implementation

    classDef l1Contracts stroke:#bbf,stroke-width:2px;
    classDef systemUser stroke:#f9a,stroke-width:2px;
    class Proxy l1Contracts;
    class ProxyAdminOwner systemUser;
</pre>
<h3 id="l2-node-components"><a class="header" href="#l2-node-components">L2 Node Components</a></h3>
<p>Below you'll find a diagram illustrating the basic interactions between the components that make up an L2 node as well
as demonstrations of how different actors use these components to fulfill their roles.</p>
<pre class="mermaid">graph LR
    subgraph &quot;L2 Node&quot;
        RollupNode(&lt;a href=&quot;./rollup-node.html&quot;&gt;Rollup Node&lt;/a&gt;)
        ExecutionEngine(&lt;a href=&quot;./exec-engine.html&quot;&gt;Execution Engine&lt;/a&gt;)
    end

    subgraph &quot;System Interactions&quot;
        BatchSubmitter(&lt;a href=&quot;./batcher.html&quot;&gt;Batch Submitter&lt;/a&gt;)
        OutputSubmitter(Output Submitter)
        Challenger(Challenger)
    end

    subgraph &quot;L1 Smart Contracts&quot;
        BatchDataEOA(&lt;a href=&quot;../glossary.html#batcher-transaction&quot;&gt;Batch Inbox Address&lt;/a&gt;)
        OptimismPortal(&lt;a href=&quot;./withdrawals.html#the-optimism-portal-contract&quot;&gt;OptimismPortal&lt;/a&gt;)
        DisputeGameFactory(&lt;a href=&quot;../fault-proof/stage-one/dispute-game-interface.html#disputegamefactory-interface&quot;&gt;DisputeGameFactory&lt;/a&gt;)
        FaultDisputeGame(&lt;a href=&quot;../fault-proof/stage-one/fault-dispute-game.html&quot;&gt;FaultDisputeGame&lt;/a&gt;)
    end

    BatchSubmitter -.-&gt;|fetch transaction batch info| RollupNode
    BatchSubmitter -.-&gt;|fetch transaction batch info| ExecutionEngine
    BatchSubmitter --&gt;|send transaction batches| BatchDataEOA

    RollupNode -.-&gt;|fetch transaction batches| BatchDataEOA
    RollupNode -.-&gt;|fetch deposit transactions| OptimismPortal
    RollupNode --&gt;|drives| ExecutionEngine

    OutputSubmitter -.-&gt;|fetch outputs| RollupNode
    OutputSubmitter --&gt;|send output proposals| DisputeGameFactory

    Challenger -.-&gt;|fetch dispute games| DisputeGameFactory
    Challenger --&gt;|verify/challenge/defend games| FaultDisputeGame

    classDef l2Components stroke:#333,stroke-width:2px;
    classDef systemUser stroke:#f9a,stroke-width:2px;
    classDef l1Contracts stroke:#bbf,stroke-width:2px;

    class RollupNode,ExecutionEngine l2Components;
    class BatchSubmitter,OutputSubmitter,Challenger systemUser;
    class BatchDataEOA,OptimismPortal,DisputeGameFactory,FaultDisputeGame l1Contracts;
</pre>
<h3 id="transactionblock-propagation"><a class="header" href="#transactionblock-propagation">Transaction/Block Propagation</a></h3>
<p><strong>Spec links:</strong></p>
<ul>
<li><a href="protocol/exec-engine.html">Execution Engine</a></li>
</ul>
<p>Since the EE uses Geth under the hood, Optimism uses Geth's built-in peer-to-peer network and transaction pool to
propagate transactions. The same network can also be used to propagate submitted blocks and support snap-sync.</p>
<p>Unsubmitted blocks, however, are propagated using a separate peer-to-peer network of Rollup Nodes. This is optional,
however, and is provided as a convenience to lower latency for verifiers and their JSON-RPC clients.</p>
<p>The below diagram illustrates how the sequencer and verifiers fit together:</p>
<p><img src="protocol/../static/assets/propagation.svg" alt="Propagation" /></p>
<h2 id="key-interactions-in-depth"><a class="header" href="#key-interactions-in-depth">Key Interactions In Depth</a></h2>
<h3 id="deposits"><a class="header" href="#deposits">Deposits</a></h3>
<p><strong>Spec links:</strong></p>
<ul>
<li><a href="protocol/deposits.html">Deposits</a></li>
</ul>
<p>Optimism supports two types of deposits: user deposits, and L1 attributes deposits. To perform a user deposit, users
call the <code>depositTransaction</code> method on the <code>OptimismPortal</code> contract. This in turn emits <code>TransactionDeposited</code> events,
which the rollup node reads during block derivation.</p>
<p>L1 attributes deposits are used to register L1 block attributes (number, timestamp, etc.) on L2 via a call to the L1
Attributes Predeploy. They cannot be initiated by users, and are instead added to L2 blocks automatically by the rollup
node.</p>
<p>Both deposit types are represented by a single custom EIP-2718 transaction type on L2.</p>
<h3 id="block-derivation"><a class="header" href="#block-derivation">Block Derivation</a></h3>
<h4 id="overview-1"><a class="header" href="#overview-1">Overview</a></h4>
<p>The rollup chain can be deterministically derived given an L1 Ethereum chain. The fact that the entire rollup chain can
be derived based on L1 blocks is <em>what makes Optimism a rollup</em>. This process can be represented as:</p>
<pre><code class="language-text">derive_rollup_chain(l1_blockchain) -&gt; rollup_blockchain
</code></pre>
<p>Optimism's block derivation function is designed such that it:</p>
<ul>
<li>Requires no state other than what is easily accessible using L1 and L2 execution engine APIs.</li>
<li>Supports sequencers and sequencer consensus.</li>
<li>Is resilient to sequencer censorship.</li>
</ul>
<h4 id="epochs-and-the-sequencing-window"><a class="header" href="#epochs-and-the-sequencing-window">Epochs and the Sequencing Window</a></h4>
<p>The rollup chain is subdivided into epochs. There is a 1:1 correspondence between L1 block numbers and epoch numbers.</p>
<p>For L1 block number <code>n</code>, there is a corresponding rollup epoch <code>n</code> which can only be derived after a <em>sequencing window</em>
worth of blocks has passed, i.e. after L1 block number <code>n + SEQUENCING_WINDOW_SIZE</code> is added to the L1 chain.</p>
<p>Each epoch contains at least one block. Every block in the epoch contains an L1 info transaction which contains
contextual information about L1 such as the block hash and timestamp. The first block in the epoch also contains all
deposits initiated via the <code>OptimismPortal</code> contract on L1. All L2 blocks can also contain <em>sequenced transactions</em>,
i.e. transactions submitted directly to the sequencer.</p>
<p>Whenever the sequencer creates a new L2 block for a given epoch, it must submit it to L1 as part of a <em>batch</em>, within
the epoch's sequencing window (i.e. the batch must land before L1 block <code>n + SEQUENCING_WINDOW_SIZE</code>). These batches are
(along with the <code>TransactionDeposited</code> L1 events) what allows the derivation of the L2 chain from the L1 chain.</p>
<p>The sequencer does not need for a L2 block to be batch-submitted to L1 in order to build on top of it. In fact, batches
typically contain multiple L2 blocks worth of sequenced transactions. This is what enables
<em>fast transaction confirmations</em> on the sequencer.</p>
<p>Since transaction batches for a given epoch can be submitted anywhere within the sequencing window, verifiers must
search all blocks within the window for transaction batches. This protects against the uncertainty of transaction
inclusion of L1. This uncertainty is also why we need the sequencing window in the first place: otherwise the sequencer
could retroactively add blocks to an old epoch, and validators wouldn't know when they can finalize an epoch.</p>
<p>The sequencing window also prevents censorship by the sequencer: deposits made on a given L1 block will be included in
the L2 chain at worst after <code>SEQUENCING_WINDOW_SIZE</code> L1 blocks have passed.</p>
<p>The following diagram describes this relationship, and how L2 blocks are derived from L1 blocks (L1 info transactions
have been elided):</p>
<p><img src="protocol/../static/assets/sequencer-block-gen.svg" alt="Epochs and Sequencing Windows" /></p>
<h4 id="block-derivation-loop"><a class="header" href="#block-derivation-loop">Block Derivation Loop</a></h4>
<p>A sub-component of the rollup node called the <em>rollup driver</em> is actually responsible for performing block derivation.
The rollup driver is essentially an infinite loop that runs the block derivation function. For each epoch, the block
derivation function performs the following steps:</p>
<ol>
<li>Downloads deposit and transaction batch data for each block in the sequencing window.</li>
<li>Converts the deposit and transaction batch data into payload attributes for the Engine API.</li>
<li>Submits the payload attributes to the Engine API, where they are converted into blocks and added to the canonical
chain.</li>
</ol>
<p>This process is then repeated with incrementing epochs until the tip of L1 is reached.</p>
<h3 id="engine-api"><a class="header" href="#engine-api">Engine API</a></h3>
<p>The rollup driver doesn't actually create blocks. Instead, it directs the execution engine to do so via the Engine API.
For each iteration of the block derivation loop described above, the rollup driver will craft a <em>payload attributes</em>
object and send it to the execution engine. The execution engine will then convert the payload attributes object into a
block, and add it to the chain. The basic sequence of the rollup driver is as follows:</p>
<ol>
<li>Call <a href="protocol/derivation.html#engine-api-usage">fork choice updated</a> with the payload attributes object. We'll skip over the details of the
fork choice state parameter for now - just know that one of its fields is the L2 chain's <code>headBlockHash</code>, and that it
is set to the block hash of the tip of the L2 chain. The Engine API returns a payload ID.</li>
<li>Call <a href="protocol/derivation.html#engine-api-usage">get payload</a> with the payload ID returned in step 1. The engine API returns a payload object
that includes a block hash as one of its fields.</li>
<li>Call <a href="protocol/derivation.html#engine-api-usage">new payload</a> with the payload returned in step 2. (Ecotone blocks, must use V3, pre-Ecotone
blocks MUST use the V2 version)</li>
<li>Call <a href="protocol/derivation.html#engine-api-usage">fork choice updated</a> with the fork choice parameter's <code>headBlockHash</code> set to the block hash
returned in step 2. The tip of the L2 chain is now the block created in step 1.</li>
</ol>
<p>The swimlane diagram below visualizes the process:</p>
<p><img src="protocol/../static/assets/engine.svg" alt="Engine API" /></p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="standard-bridges"><a class="header" href="#standard-bridges">Standard Bridges</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/bridges.html#overview">Overview</a></li>
<li><a href="protocol/bridges.html#token-depositing">Token Depositing</a></li>
<li><a href="protocol/bridges.html#upgradability">Upgradability</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-2"><a class="header" href="#overview-2">Overview</a></h2>
<p>The standard bridges are responsible for allowing cross domain
ETH and ERC20 token transfers. They are built on top of the cross domain
messenger contracts and give a standard interface for depositing tokens.</p>
<p>The bridge works for both L1 native tokens and L2 native tokens. The legacy API
is preserved to ensure that existing applications will not experience any
problems with the Bedrock <code>StandardBridge</code> contracts.</p>
<p>The <code>L2StandardBridge</code> is a predeploy contract located at
<code>0x4200000000000000000000000000000000000010</code>.</p>
<pre><code class="language-solidity">interface StandardBridge {
    event ERC20BridgeFinalized(address indexed localToken, address indexed remoteToken, address indexed from, address to, uint256 amount, bytes extraData);
    event ERC20BridgeInitiated(address indexed localToken, address indexed remoteToken, address indexed from, address to, uint256 amount, bytes extraData);
    event ETHBridgeFinalized(address indexed from, address indexed to, uint256 amount, bytes extraData);
    event ETHBridgeInitiated(address indexed from, address indexed to, uint256 amount, bytes extraData);

    function bridgeERC20(address _localToken, address _remoteToken, uint256 _amount, uint32 _minGasLimit, bytes memory _extraData) external;
    function bridgeERC20To(address _localToken, address _remoteToken, address _to, uint256 _amount, uint32 _minGasLimit, bytes memory _extraData) external;
    function bridgeETH(uint32 _minGasLimit, bytes memory _extraData) payable external;
    function bridgeETHTo(address _to, uint32 _minGasLimit, bytes memory _extraData) payable external;
    function deposits(address, address) view external returns (uint256);
    function finalizeBridgeERC20(address _localToken, address _remoteToken, address _from, address _to, uint256 _amount, bytes memory _extraData) external;
    function finalizeBridgeETH(address _from, address _to, uint256 _amount, bytes memory _extraData) payable external;
    function messenger() view external returns (address);
    function OTHER_BRIDGE() view external returns (address);
}
</code></pre>
<h2 id="token-depositing"><a class="header" href="#token-depositing">Token Depositing</a></h2>
<p>The <code>bridgeERC20</code> function is used to send a token from one domain to another
domain. An <code>OptimismMintableERC20</code> token contract must exist on the remote
domain to be able to deposit tokens to that domain. One of these tokens can be
deployed using the <code>OptimismMintableERC20Factory</code> contract.</p>
<h2 id="upgradability"><a class="header" href="#upgradability">Upgradability</a></h2>
<p>Both the L1 and L2 standard bridges should be behind upgradable proxies.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="cross-domain-messengers"><a class="header" href="#cross-domain-messengers">Cross Domain Messengers</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/messengers.html#overview">Overview</a></li>
<li><a href="protocol/messengers.html#message-passing">Message Passing</a></li>
<li><a href="protocol/messengers.html#upgradability">Upgradability</a></li>
<li><a href="protocol/messengers.html#message-versioning">Message Versioning</a>
<ul>
<li><a href="protocol/messengers.html#message-version-0">Message Version 0</a></li>
<li><a href="protocol/messengers.html#message-version-1">Message Version 1</a></li>
</ul>
</li>
<li><a href="protocol/messengers.html#backwards-compatibility-notes">Backwards Compatibility Notes</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-3"><a class="header" href="#overview-3">Overview</a></h2>
<p>The cross domain messengers are responsible for providing a higher level API for
developers who are interested in sending cross domain messages. They allow for
the ability to replay cross domain messages and sit directly on top of the lower
level system contracts responsible for cross domain messaging on L1 and L2.</p>
<p>The <code>CrossDomainMessenger</code> is extended to create both an
<code>L1CrossDomainMessenger</code> as well as a <code>L2CrossDomainMessenger</code>.
These contracts are then extended with their legacy APIs to provide backwards
compatibility for applications that integrated before the Bedrock system
upgrade.</p>
<p>The <code>L2CrossDomainMessenger</code> is a predeploy contract located at
<code>0x4200000000000000000000000000000000000007</code>.</p>
<p>The base <code>CrossDomainMessenger</code> interface is:</p>
<pre><code class="language-solidity">interface CrossDomainMessenger {
    event FailedRelayedMessage(bytes32 indexed msgHash);
    event RelayedMessage(bytes32 indexed msgHash);
    event SentMessage(address indexed target, address sender, bytes message, uint256 messageNonce, uint256 gasLimit);
    event SentMessageExtension1(address indexed sender, uint256 value);

    function MESSAGE_VERSION() external view returns (uint16);
    function MIN_GAS_CALLDATA_OVERHEAD() external view returns (uint64);
    function MIN_GAS_CONSTANT_OVERHEAD() external view returns (uint64);
    function MIN_GAS_DYNAMIC_OVERHEAD_DENOMINATOR() external view returns (uint64);
    function MIN_GAS_DYNAMIC_OVERHEAD_NUMERATOR() external view returns (uint64);
    function OTHER_MESSENGER() external view returns (address);
    function baseGas(bytes memory _message, uint32 _minGasLimit) external pure returns (uint64);
    function failedMessages(bytes32) external view returns (bool);
    function messageNonce() external view returns (uint256);
    function relayMessage(
        uint256 _nonce,
        address _sender,
        address _target,
        uint256 _value,
        uint256 _minGasLimit,
        bytes memory _message
    ) external payable returns (bytes memory returnData_);
    function sendMessage(address _target, bytes memory _message, uint32 _minGasLimit) external payable;
    function successfulMessages(bytes32) external view returns (bool);
    function xDomainMessageSender() external view returns (address);
}
</code></pre>
<h2 id="message-passing"><a class="header" href="#message-passing">Message Passing</a></h2>
<p>The <code>sendMessage</code> function is used to send a cross domain message. To trigger
the execution on the other side, the <code>relayMessage</code> function is called.
Successful messages have their hash stored in the <code>successfulMessages</code> mapping
while unsuccessful messages have their hash stored in the <code>failedMessages</code>
mapping.</p>
<p>The user experience when sending from L1 to L2 is a bit different than when
sending a transaction from L2 to L1. When going from L1 into L2, the user does
not need to call <code>relayMessage</code> on L2 themselves. The user pays for L2 gas on L1
and the transaction is automatically pulled into L2 where it is executed on L2.
When going from L2 into L1, the user proves their withdrawal on OptimismPortal,
then waits for the finalization window to pass, and then finalizes the withdrawal
on the OptimismPortal, which calls <code>relayMessage</code> on the
<code>L1CrossDomainMessenger</code> to finalize the withdrawal.</p>
<h2 id="upgradability-1"><a class="header" href="#upgradability-1">Upgradability</a></h2>
<p>The L1 and L2 cross domain messengers should be deployed behind upgradable
proxies. This will allow for updating the message version.</p>
<h2 id="message-versioning"><a class="header" href="#message-versioning">Message Versioning</a></h2>
<p>Messages are versioned based on the first 2 bytes of their nonce. Depending on
the version, messages can have a different serialization and hashing scheme.
The first two bytes of the nonce are reserved for version metadata because
a version field was not originally included in the messages themselves, but
a <code>uint256</code> nonce is so large that we can very easily pack additional data
into that field.</p>
<h3 id="message-version-0"><a class="header" href="#message-version-0">Message Version 0</a></h3>
<pre><code class="language-solidity">abi.encodeWithSignature(
    "relayMessage(address,address,bytes,uint256)",
    _target,
    _sender,
    _message,
    _messageNonce
);
</code></pre>
<h3 id="message-version-1"><a class="header" href="#message-version-1">Message Version 1</a></h3>
<pre><code class="language-solidity">abi.encodeWithSignature(
    "relayMessage(uint256,address,address,uint256,uint256,bytes)",
    _nonce,
    _sender,
    _target,
    _value,
    _gasLimit,
    _data
);
</code></pre>
<h2 id="backwards-compatibility-notes"><a class="header" href="#backwards-compatibility-notes">Backwards Compatibility Notes</a></h2>
<p>An older version of the messenger contracts had the concept of blocked messages
in a <code>blockedMessages</code> mapping. This functionality was removed from the
messengers because a smart attacker could get around any message blocking
attempts. It also saves gas on finalizing withdrawals.</p>
<p>The concept of a "relay id" and the <code>relayedMessages</code> mapping was removed.
It was built as a way to be able to fund third parties who relayed messages
on the behalf of users, but it was improperly implemented as it was impossible
to know if the relayed message actually succeeded.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="deposits-1"><a class="header" href="#deposits-1">Deposits</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/deposits.html#overview">Overview</a></li>
<li><a href="protocol/deposits.html#the-deposited-transaction-type">The Deposited Transaction Type</a>
<ul>
<li><a href="protocol/deposits.html#source-hash-computation">Source hash computation</a></li>
<li><a href="protocol/deposits.html#kinds-of-deposited-transactions">Kinds of Deposited Transactions</a></li>
<li><a href="protocol/deposits.html#validation-and-authorization-of-deposited-transactions">Validation and Authorization of Deposited Transactions</a></li>
<li><a href="protocol/deposits.html#execution">Execution</a>
<ul>
<li><a href="protocol/deposits.html#nonce-handling">Nonce Handling</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="protocol/deposits.html#deposit-receipt">Deposit Receipt</a></li>
<li><a href="protocol/deposits.html#l1-attributes-deposited-transaction">L1 Attributes Deposited Transaction</a>
<ul>
<li><a href="protocol/deposits.html#l1-attributes-deposited-transaction-calldata">L1 Attributes Deposited Transaction Calldata</a>
<ul>
<li><a href="protocol/deposits.html#l1-attributes---bedrock-canyon-delta">L1 Attributes - Bedrock, Canyon, Delta</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="protocol/deposits.html#special-accounts-on-l2">Special Accounts on L2</a>
<ul>
<li><a href="protocol/deposits.html#l1-attributes-depositor-account">L1 Attributes Depositor Account</a></li>
<li><a href="protocol/deposits.html#l1-attributes-predeployed-contract">L1 Attributes Predeployed Contract</a>
<ul>
<li><a href="protocol/deposits.html#l1-attributes-predeployed-contract-reference-implementation">L1 Attributes Predeployed Contract: Reference Implementation</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="protocol/deposits.html#user-deposited-transactions">User-Deposited Transactions</a>
<ul>
<li><a href="protocol/deposits.html#deposit-contract">Deposit Contract</a>
<ul>
<li><a href="protocol/deposits.html#address-aliasing">Address Aliasing</a></li>
<li><a href="protocol/deposits.html#deposit-contract-implementation-optimism-portal">Deposit Contract Implementation: Optimism Portal</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<!-- All glossary references in this file. -->
<h2 id="overview-4"><a class="header" href="#overview-4">Overview</a></h2>
<p><a href="protocol/../glossary.html#deposited">Deposited transactions</a>, also known as <a href="protocol/../glossary.html#deposits">deposits</a> are transactions which
are initiated on L1, and executed on L2. This document outlines a new <a href="protocol/../glossary.html#transaction-type">transaction
type</a> for deposits. It also describes how deposits are initiated on L1, along
with the authorization and validation conditions on L2.</p>
<p><strong>Vocabulary note</strong>: <em>deposited transaction</em> refers specifically to an L2 transaction, while
<em>deposit</em> can refer to the transaction at various stages (for instance when it is deposited on L1).</p>
<h2 id="the-deposited-transaction-type"><a class="header" href="#the-deposited-transaction-type">The Deposited Transaction Type</a></h2>
<p><a href="protocol/../glossary.html#deposited">Deposited transactions</a> have the following notable distinctions from existing
transaction types:</p>
<ol>
<li>They are derived from Layer 1 blocks, and must be included as part of the protocol.</li>
<li>They do not include signature validation (see <a href="protocol/deposits.html#user-deposited-transactions">User-Deposited Transactions</a>
for the rationale).</li>
<li>They buy their L2 gas on L1 and, as such, the L2 gas is not refundable.</li>
</ol>
<p>We define a new <a href="https://eips.ethereum.org/EIPS/eip-2718">EIP-2718</a> compatible transaction type with the prefix <code>0x7E</code> to represent a deposit transaction.</p>
<p>A deposit has the following fields
(rlp encoded in the order they appear here):</p>
<ul>
<li><code>bytes32 sourceHash</code>: the source-hash, uniquely identifies the origin of the deposit.</li>
<li><code>address from</code>: The address of the sender account.</li>
<li><code>address to</code>: The address of the recipient account, or the null (zero-length) address if the
deposited transaction is a contract creation.</li>
<li><code>uint256 mint</code>: The ETH value to mint on L2.</li>
<li><code>uint256 value</code>: The ETH value to send to the recipient account.</li>
<li><code>uint64 gas</code>: The gas limit for the L2 transaction.</li>
<li><code>bool isSystemTx</code>: If true, the transaction does not interact with the L2 block gas pool.
<ul>
<li>Note: boolean is disabled (enforced to be <code>false</code>) starting from the Regolith upgrade.</li>
</ul>
</li>
<li><code>bytes data</code>: The calldata.</li>
</ul>
<p>In contrast to <a href="https://eips.ethereum.org/EIPS/eip-155">EIP-155</a> transactions, this transaction type:</p>
<ul>
<li>Does not include a <code>nonce</code>, since it is identified by the <code>sourceHash</code>.
API responses still include a <code>nonce</code> attribute:
<ul>
<li>Before Regolith: the <code>nonce</code> is always <code>0</code></li>
<li>With Regolith: the <code>nonce</code> is set to the <code>depositNonce</code> attribute of the corresponding transaction receipt.</li>
</ul>
</li>
<li>Does not include signature information, and makes the <code>from</code> address explicit.
API responses contain zeroed signature <code>v</code>, <code>r</code>, <code>s</code> values for backwards compatibility.</li>
<li>Includes new <code>sourceHash</code>, <code>from</code>, <code>mint</code>, and <code>isSystemTx</code> attributes.
API responses contain these as additional fields.</li>
</ul>
<p>We select <code>0x7E</code> because transaction type identifiers are currently allowed to go up to <code>0x7F</code>.
Picking a high identifier minimizes the risk that the identifier will be used by another
transaction type on the L1 chain in the future. We don't pick <code>0x7F</code> itself in case it becomes used
for a variable-length encoding scheme.</p>
<h3 id="source-hash-computation"><a class="header" href="#source-hash-computation">Source hash computation</a></h3>
<p>The <code>sourceHash</code> of a deposit transaction is computed based on the origin:</p>
<ul>
<li>User-deposited:
<code>keccak256(bytes32(uint256(0)), keccak256(l1BlockHash, bytes32(uint256(l1LogIndex))))</code>.
Where the <code>l1BlockHash</code>, and <code>l1LogIndex</code> all refer to the inclusion of the deposit log event on L1.
<code>l1LogIndex</code> is the index of the deposit event log in the combined list of log events of the block.</li>
<li>L1 attributes deposited:
<code>keccak256(bytes32(uint256(1)), keccak256(l1BlockHash, bytes32(uint256(seqNumber))))</code>.
Where <code>l1BlockHash</code> refers to the L1 block hash of which the info attributes are deposited.
And <code>seqNumber = l2BlockNum - l2EpochStartBlockNum</code>,
where <code>l2BlockNum</code> is the L2 block number of the inclusion of the deposit tx in L2,
and <code>l2EpochStartBlockNum</code> is the L2 block number of the first L2 block in the epoch.</li>
<li>Upgrade-deposited: <code>keccak256(bytes32(uint256(2)), keccak256(intent))</code>.
Where <code>intent</code> is a UTF-8 byte string, identifying the upgrade intent.</li>
</ul>
<p>Without a <code>sourceHash</code> in a deposit, two different deposited transactions could have the same exact hash.</p>
<p>The outer <code>keccak256</code> hashes the actual uniquely identifying information with a domain,
to avoid collisions between different types of sources.</p>
<p>The <a href="protocol/./derivation.html">Interop derivation spec</a> introduces two additional kinds of system deposits,
with domains <code>3</code> and <code>4</code>.</p>
<p>We do not use the sender's nonce to ensure uniqueness because this would require an extra L2 EVM state read from the
<a href="protocol/../glossary.html#execution-engine">execution engine</a> during block-derivation.</p>
<h3 id="kinds-of-deposited-transactions"><a class="header" href="#kinds-of-deposited-transactions">Kinds of Deposited Transactions</a></h3>
<p>Although we define only one new transaction type, we can distinguish between two kinds of deposited
transactions, based on their positioning in the L2 block:</p>
<ol>
<li>The first transaction MUST be a <a href="protocol/deposits.html#l1-attributes-deposited-transaction">L1 attributes deposited transaction</a>, followed by</li>
<li>an array of zero-or-more <a href="protocol/deposits.html#user-deposited-transactions">user-deposited transactions</a>
submitted to the deposit feed contract on L1 (called <code>OptimismPortal</code>).
User-deposited transactions are only present in the first block of a L2 epoch.</li>
</ol>
<p>We only define a single new transaction type in order to minimize modifications to L1 client
software, and complexity in general.</p>
<h3 id="validation-and-authorization-of-deposited-transactions"><a class="header" href="#validation-and-authorization-of-deposited-transactions">Validation and Authorization of Deposited Transactions</a></h3>
<p>As noted above, the deposited transaction type does not include a signature for validation. Rather,
authorization is handled by the <a href="protocol/../glossary.html#L2-chain-derivation">L2 chain derivation</a> process, which when correctly
applied will only derive transactions with a <code>from</code> address attested to by the logs of the <a href="protocol/deposits.html#deposit-contract">L1
deposit contract</a>.</p>
<h3 id="execution"><a class="header" href="#execution">Execution</a></h3>
<p>In order to execute a deposited transaction:</p>
<p>First, the balance of the <code>from</code> account MUST be increased by the amount of <code>mint</code>.
This is unconditional, and does not revert on deposit failure.</p>
<p>Then, the execution environment for a deposited transaction is initialized based on the
transaction's attributes, in exactly the same manner as it would be for an EIP-155 transaction.</p>
<p>The deposit transaction is processed exactly like a type-2 (EIP-1559) transaction, with the exception of:</p>
<ul>
<li>No fee fields are verified: the deposit does not have any, as it pays for gas on L1.</li>
<li>No <code>nonce</code> field is verified: the deposit does not have any, it's uniquely identified by its <code>sourceHash</code>.</li>
<li>No access-list is processed: the deposit has no access-list, and it is thus processed as if the access-list is empty.</li>
<li>No check if <code>from</code> is an Externally Owner Account (EOA): the deposit is ensured not to be an EOA through L1 address
masking, this may change in future L1 contract-deployments to e.g. enable an account-abstraction like mechanism.</li>
<li>Before the Regolith upgrade:
<ul>
<li>The execution output states a non-standard gas usage:
<ul>
<li>If <code>isSystemTx</code> is false: execution output states it uses <code>gasLimit</code> gas.</li>
<li>If <code>isSystemTx</code> is true: execution output states it uses <code>0</code> gas.</li>
</ul>
</li>
</ul>
</li>
<li>No gas is refunded as ETH. (either by not refunding or utilizing the fact the gas-price of the deposit is <code>0</code>)</li>
<li>No transaction priority fee is charged. No payment is made to the block fee-recipient.</li>
<li>No L1-cost fee is charged, as deposits are derived from L1 and do not have to be submitted as data back to it.</li>
<li>No base fee is charged. The total base fee accounting does not change.</li>
</ul>
<p>Note that this includes contract-deployment behavior like with regular transactions, and gas
metering is the same (with the exception of fee related changes above), including metering of
intrinsic gas.</p>
<p>Any non-EVM state-transition error emitted by the EVM execution is processed in a special way:</p>
<ul>
<li>It is transformed into an EVM-error:
i.e. the deposit will always be included, but its receipt will indicate a failure
if it runs into a non-EVM state-transition error, e.g. failure to transfer the specified
<code>value</code> amount of ETH due to insufficient account-balance.</li>
<li>The world state is rolled back to the start of the EVM processing, after the minting part of the deposit.</li>
<li>The <code>nonce</code> of <code>from</code> in the world state is incremented by 1, making the error equivalent to a native EVM failure.
Note that a previous <code>nonce</code> increment may have happened during EVM processing, but this would be rolled back first.</li>
</ul>
<p>Finally, after the above processing, the execution post-processing runs the same:
i.e. the gas pool and receipt are processed identical to a regular transaction.
Starting with the Regolith upgrade however, the receipt of deposit transactions is extended with an additional
<code>depositNonce</code> value, storing the <code>nonce</code> value of the <code>from</code> sender as registered <em>before</em> the EVM processing.</p>
<p>Note that the gas used as stated by the execution output is subtracted from the gas pool,
but this execution output value has special edge cases before the Regolith upgrade.</p>
<p>Note for application developers: because <code>CALLER</code> and <code>ORIGIN</code> are set to <code>from</code>, the
semantics of using the <code>tx.origin == msg.sender</code> check will not work to determine whether
or not a caller is an EOA during a deposit transaction. Instead, the check could only be useful for
identifying the first call in the L2 deposit transaction. However this check does still satisfy
the common case in which developers are using this check to ensure that the <code>CALLER</code> is unable to
execute code before and after the call.</p>
<h4 id="nonce-handling"><a class="header" href="#nonce-handling">Nonce Handling</a></h4>
<p>Despite the lack of signature validation, we still increment the nonce of the <code>from</code> account when a
deposit transaction is executed. In the context of a deposit-only roll up, this is not necessary
for transaction ordering or replay prevention, however it maintains consistency with the use of
nonces during <a href="https://github.com/ethereum/execution-specs/blob/617903a8f8d7b50cf71bf1aa733c37897c8d75c1/src/ethereum/frontier/utils/address.py#L40">contract creation</a>. It may also simplify integration with downstream
tooling (such as wallets and block explorers).</p>
<h2 id="deposit-receipt"><a class="header" href="#deposit-receipt">Deposit Receipt</a></h2>
<p>Transaction receipts use standard typing as per <a href="https://eips.ethereum.org/EIPS/eip-2718">EIP-2718</a>.
The Deposit transaction receipt type is equal to a regular receipt,
but extended with an optional <code>depositNonce</code> field.</p>
<p>The RLP-encoded consensus-enforced fields are:</p>
<ul>
<li><code>postStateOrStatus</code> (standard): this contains the transaction status, see <a href="https://eips.ethereum.org/EIPS/eip-658">EIP-658</a>.</li>
<li><code>cumulativeGasUsed</code> (standard): gas used in the block thus far, including this transaction.
<ul>
<li>The actual gas used is derived from the difference in <code>CumulativeGasUsed</code> with the previous transaction.</li>
<li>Starting with Regolith, this accounts for the actual gas usage by the deposit, like regular transactions.</li>
</ul>
</li>
<li><code>bloom</code> (standard): bloom filter of the transaction logs.</li>
<li><code>logs</code> (standard): log events emitted by the EVM processing.</li>
<li><code>depositNonce</code> (unique extension): Optional field. The deposit transaction persists the nonce used during execution.</li>
<li><code>depositNonceVersion</code> (unique extension): Optional field. The value must be 1 if the field is present
<ul>
<li>Before Canyon, these <code>depositNonce</code> &amp; <code>depositNonceVersion</code> fields must always be omitted.</li>
<li>With Canyon, these <code>depositNonce</code> &amp; <code>depositNonceVersion</code> fields must always be included.</li>
</ul>
</li>
</ul>
<p>Starting with Regolith, the receipt API responses utilize the receipt changes for more accurate response data:</p>
<ul>
<li>The <code>depositNonce</code> is included in the receipt JSON data in API responses</li>
<li>For contract-deployments (when <code>to == null</code>), the <code>depositNonce</code> helps derive the correct <code>contractAddress</code> meta-data,
instead of assuming the nonce was zero.</li>
<li>The <code>cumulativeGasUsed</code> accounts for the actual gas usage, as metered in the EVM processing.</li>
</ul>
<h2 id="l1-attributes-deposited-transaction"><a class="header" href="#l1-attributes-deposited-transaction">L1 Attributes Deposited Transaction</a></h2>
<p>An <a href="protocol/../glossary.html#l1-attributes-deposited-transaction">L1 attributes deposited transaction</a> is a deposit transaction sent to the <a href="protocol/deposits.html#l1-attributes-predeployed-contract">L1
attributes predeployed contract</a>.</p>
<p>This transaction MUST have the following values:</p>
<ol>
<li><code>from</code> is <code>0xdeaddeaddeaddeaddeaddeaddeaddeaddead0001</code> (the address of the
<a href="protocol/deposits.html#l1-attributes-depositor-account">L1 Attributes depositor account</a>)</li>
<li><code>to</code> is <code>0x4200000000000000000000000000000000000015</code> (the address of the <a href="protocol/deposits.html#l1-attributes-predeployed-contract">L1 attributes predeployed
contract</a>).</li>
<li><code>mint</code> is <code>0</code></li>
<li><code>value</code> is <code>0</code></li>
<li><code>gasLimit</code> is set to 150,000,000 prior to the Regolith upgrade, and 1,000,000 after.</li>
<li><code>isSystemTx</code> is set to <code>true</code> prior to the Regolith upgrade, and <code>false</code> after.</li>
<li><code>data</code> is an encoded call to the <a href="protocol/deposits.html#l1-attributes-predeployed-contract">L1 attributes predeployed contract</a> that
depends on the upgrades that are active (see below).</li>
</ol>
<p>This system-initiated transaction for L1 attributes is not charged any ETH for its allocated
<code>gasLimit</code>, as it is considered part of state-transition processing.</p>
<h3 id="l1-attributes-deposited-transaction-calldata"><a class="header" href="#l1-attributes-deposited-transaction-calldata">L1 Attributes Deposited Transaction Calldata</a></h3>
<h4 id="l1-attributes---bedrock-canyon-delta"><a class="header" href="#l1-attributes---bedrock-canyon-delta">L1 Attributes - Bedrock, Canyon, Delta</a></h4>
<p>The <code>data</code> field of the L1 attributes deposited transaction is an <a href="https://docs.soliditylang.org/en/v0.8.10/abi-spec.html">ABI</a> encoded call to the
<code>setL1BlockValues()</code> function with correct values associated with the corresponding L1 block
(cf. <a href="protocol/deposits.html#l1-attributes-predeployed-contract-reference-implementation">reference implementation</a>).</p>
<h2 id="special-accounts-on-l2"><a class="header" href="#special-accounts-on-l2">Special Accounts on L2</a></h2>
<p>The L1 attributes deposit transaction involves two special purpose accounts:</p>
<ol>
<li>The L1 attributes depositor account</li>
<li>The L1 attributes predeployed contract</li>
</ol>
<h3 id="l1-attributes-depositor-account"><a class="header" href="#l1-attributes-depositor-account">L1 Attributes Depositor Account</a></h3>
<p>The depositor account is an <a href="protocol/../glossary.html#eoa">EOA</a> with no known private key. It has the address
<code>0xdeaddeaddeaddeaddeaddeaddeaddeaddead0001</code>. Its value is returned by the <code>CALLER</code> and <code>ORIGIN</code>
opcodes during execution of the L1 attributes deposited transaction.</p>
<h3 id="l1-attributes-predeployed-contract"><a class="header" href="#l1-attributes-predeployed-contract">L1 Attributes Predeployed Contract</a></h3>
<p>A predeployed contract on L2 at address <code>0x4200000000000000000000000000000000000015</code>, which holds
certain block variables from the corresponding L1 block in storage, so that they may be accessed
during the execution of the subsequent deposited transactions.</p>
<p>The predeploy stores the following values:</p>
<ul>
<li>L1 block attributes:
<ul>
<li><code>number</code> (<code>uint64</code>)</li>
<li><code>timestamp</code> (<code>uint64</code>)</li>
<li><code>basefee</code> (<code>uint256</code>)</li>
<li><code>hash</code> (<code>bytes32</code>)</li>
</ul>
</li>
<li><code>sequenceNumber</code> (<code>uint64</code>): This equals the L2 block number relative to the start of the epoch,
i.e. the L2 block distance to the L2 block height that the L1 attributes last changed,
and reset to 0 at the start of a new epoch.</li>
<li>System configurables tied to the L1 block, see <a href="protocol/system-config.html">System configuration specification</a>:
<ul>
<li><code>batcherHash</code> (<code>bytes32</code>): A versioned commitment to the batch-submitter(s) currently operating.</li>
<li><code>overhead</code> (<code>uint256</code>): The L1 fee overhead to apply to L1 cost computation of transactions in this L2 block.</li>
<li><code>scalar</code> (<code>uint256</code>): The L1 fee scalar to apply to L1 cost computation of transactions in this L2 block.</li>
</ul>
</li>
</ul>
<p>The contract implements an authorization scheme, such that it only accepts state-changing calls from
the <a href="protocol/deposits.html#l1-attributes-depositor-account">depositor account</a>.</p>
<p>The contract has the following solidity interface, and can be interacted with according to the
<a href="https://docs.soliditylang.org/en/v0.8.10/abi-spec.html">contract ABI specification</a>.</p>
<h4 id="l1-attributes-predeployed-contract-reference-implementation"><a class="header" href="#l1-attributes-predeployed-contract-reference-implementation">L1 Attributes Predeployed Contract: Reference Implementation</a></h4>
<p>A reference implementation of the L1 Attributes predeploy contract can be found in <a href="https://github.com/ethereum-optimism/optimism/blob/d48b45954c381f75a13e61312da68d84e9b41418/packages/contracts-bedrock/src/L2/L1Block.sol">L1Block.sol</a>.</p>
<h2 id="user-deposited-transactions"><a class="header" href="#user-deposited-transactions">User-Deposited Transactions</a></h2>
<p><a href="protocol/../glossary.html#user-deposited-transaction">User-deposited transactions</a> are <a href="protocol/deposits.html#the-deposited-transaction-type">deposited transactions</a>
generated by the <a href="protocol/../glossary.html#L2-chain-derivation">L2 Chain Derivation</a> process. The content of each user-deposited
transaction are determined by the corresponding <code>TransactionDeposited</code> event emitted by the
<a href="protocol/deposits.html#deposit-contract">deposit contract</a> on L1.</p>
<ol>
<li><code>from</code> is unchanged from the emitted value (though it may
have been transformed to an alias in <code>OptimismPortal</code>, the deposit feed contract).</li>
<li><code>to</code> is any 20-byte address (including the zero address)
<ul>
<li>In case of a contract creation (cf. <code>isCreation</code>), this address is set to <code>null</code>.</li>
</ul>
</li>
<li><code>mint</code> is set to the emitted value.</li>
<li><code>value</code> is set to the emitted value.</li>
<li><code>gaslimit</code> is unchanged from the emitted value. It must be at least 21000.</li>
<li><code>isCreation</code> is set to <code>true</code> if the transaction is a contract creation, <code>false</code> otherwise.</li>
<li><code>data</code> is unchanged from the emitted value. Depending on the value of <code>isCreation</code> it is handled
as either calldata or contract initialization code.</li>
<li><code>isSystemTx</code> is set by the rollup node for certain transactions that have unmetered execution.
It is <code>false</code> for user deposited transactions</li>
</ol>
<h3 id="deposit-contract"><a class="header" href="#deposit-contract">Deposit Contract</a></h3>
<p>The deposit contract is deployed to L1. Deposited transactions are derived from the values in
the <code>TransactionDeposited</code> event(s) emitted by the deposit contract.</p>
<p>The deposit contract is responsible for maintaining the <a href="protocol/guaranteed-gas-market.html">guaranteed gas market</a>,
charging deposits for gas to be used on L2, and ensuring that the total amount of guaranteed
gas in a single L1 block does not exceed the L2 block gas limit.</p>
<p>The deposit contract handles two special cases:</p>
<ol>
<li>A contract creation deposit, which is indicated by setting the <code>isCreation</code> flag to <code>true</code>.
In the event that the <code>to</code> address is non-zero, the contract will revert.</li>
<li>A call from a contract account, in which case the <code>from</code> value is transformed to its L2
<a href="protocol/deposits.html#address-aliasing">alias</a>.</li>
</ol>
<h4 id="address-aliasing"><a class="header" href="#address-aliasing">Address Aliasing</a></h4>
<p>If the caller is a contract, the address will be transformed by adding
<code>0x1111000000000000000000000000000000001111</code> to it. The math is <code>unchecked</code> and done on a
Solidity <code>uint160</code> so the value will overflow. This prevents attacks in which a
contract on L1 has the same address as a contract on L2 but doesn't have the same code. We can safely ignore this
for EOAs because they're guaranteed to have the same "code" (i.e. no code at all). This also makes
it possible for users to interact with contracts on L2 even when the Sequencer is down.</p>
<h4 id="deposit-contract-implementation-optimism-portal"><a class="header" href="#deposit-contract-implementation-optimism-portal">Deposit Contract Implementation: Optimism Portal</a></h4>
<p>A reference implementation of the deposit contract can be found in <a href="https://github.com/ethereum-optimism/optimism/blob/d48b45954c381f75a13e61312da68d84e9b41418/packages/contracts-bedrock/src/L1/OptimismPortal.sol">OptimismPortal.sol</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="withdrawals"><a class="header" href="#withdrawals">Withdrawals</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/withdrawals.html#overview">Overview</a></li>
<li><a href="protocol/withdrawals.html#withdrawal-flow">Withdrawal Flow</a>
<ul>
<li><a href="protocol/withdrawals.html#on-l2">On L2</a></li>
<li><a href="protocol/withdrawals.html#on-l1">On L1</a></li>
</ul>
</li>
<li><a href="protocol/withdrawals.html#the-l2tol1messagepasser-contract">The L2ToL1MessagePasser Contract</a>
<ul>
<li><a href="protocol/withdrawals.html#addresses-are-not-aliased-on-withdrawals">Addresses are not Aliased on Withdrawals</a></li>
</ul>
</li>
<li><a href="protocol/withdrawals.html#the-optimism-portal-contract">The Optimism Portal Contract</a></li>
<li><a href="protocol/withdrawals.html#withdrawal-verification-and-finalization">Withdrawal Verification and Finalization</a></li>
<li><a href="protocol/withdrawals.html#security-considerations">Security Considerations</a>
<ul>
<li><a href="protocol/withdrawals.html#key-properties-of-withdrawal-verification">Key Properties of Withdrawal Verification</a></li>
<li><a href="protocol/withdrawals.html#handling-successfully-verified-messages-that-fail-when-relayed">Handling Successfully Verified Messages That Fail When Relayed</a></li>
<li><a href="protocol/withdrawals.html#optimismportal-can-send-arbitrary-messages-on-l1">OptimismPortal can send arbitrary messages on L1</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<!-- All glossary references in this file. -->
<h2 id="overview-5"><a class="header" href="#overview-5">Overview</a></h2>
<p><a href="protocol/../glossary.html#withdrawal">Withdrawals</a> are cross domain transactions which are initiated on L2, and finalized by a transaction
executed on L1. Notably, withdrawals may be used by an L2 account to call an L1 contract, or to transfer ETH from
an L2 account to an L1 account.</p>
<p><strong>Vocabulary note</strong>: <em>withdrawal</em> can refer to the transaction at various stages of the process, but we introduce
more specific terms to differentiate:</p>
<ul>
<li>A <em>withdrawal initiating transaction</em> refers specifically to a transaction on L2 sent to the Withdrawals predeploy.</li>
<li>A <em>withdrawal proving transaction</em> refers specifically to an L1 transaction
which proves the withdrawal is correct (that it has been included in a merkle
tree whose root is available on L1).</li>
<li>A <em>withdrawal finalizing transaction</em> refers specifically to an L1 transaction which finalizes and relays the
withdrawal.</li>
</ul>
<p>Withdrawals are initiated on L2 via a call to the Message Passer predeploy contract, which records the important
properties of the message in its storage.
Withdrawals are proven on L1 via a call to the <code>OptimismPortal</code>, which proves the inclusion of this withdrawal message.
Withdrawals are finalized on L1 via a call to the <code>OptimismPortal</code> contract,
which verifies that the fault challenge period has passed since the withdrawal message has been proved.</p>
<p>In this way, withdrawals are different from <a href="protocol/../glossary.html#deposits">deposits</a> which make use of a special transaction type in the
<a href="protocol/../glossary.html#execution-engine">execution engine</a> client. Rather, withdrawals transaction must use smart contracts on L1 for
finalization.</p>
<h2 id="withdrawal-flow"><a class="header" href="#withdrawal-flow">Withdrawal Flow</a></h2>
<p>We first describe the end to end flow of initiating and finalizing a withdrawal:</p>
<h3 id="on-l2"><a class="header" href="#on-l2">On L2</a></h3>
<p>An L2 account sends a withdrawal message (and possibly also ETH) to the <code>L2ToL1MessagePasser</code> predeploy contract.
This is a very simple contract that stores the hash of the withdrawal data.</p>
<h3 id="on-l1"><a class="header" href="#on-l1">On L1</a></h3>
<ol>
<li>A <a href="protocol/../glossary.html#withdrawals">relayer</a> submits a withdrawal proving transaction with the required inputs
to the <code>OptimismPortal</code> contract.
The relayer is not necessarily the same entity which initiated the withdrawal on L2.
These inputs include the withdrawal transaction data, inclusion proofs, and a block number. The block number
must be one for which an L2 output root exists, which commits to the withdrawal as registered on L2.</li>
<li>The <code>OptimismPortal</code> contract retrieves the output root for the given block number from the <code>L2OutputOracle</code>'s
<code>getL2Output()</code> function, and performs the remainder of the verification process internally.</li>
<li>If proof verification fails, the call reverts. Otherwise the hash is recorded to prevent it from being re-proven.
Note that the withdrawal can be proven more than once if the corresponding output root changes.</li>
<li>After the withdrawal is proven, it enters a 7 day challenge period, allowing time for other network participants
to challenge the integrity of the corresponding output root.</li>
<li>Once the challenge period has passed, a relayer submits a withdrawal finalizing transaction to the
<code>OptimismPortal</code> contract.
The relayer doesn't need to be the same entity that initiated the withdrawal on L2.</li>
<li>The <code>OptimismPortal</code> contract receives the withdrawal transaction data and verifies that the withdrawal has
both been proven and passed the challenge period.</li>
<li>If the requirements are not met, the call reverts. Otherwise the call is forwarded, and the hash is recorded to
prevent it from being replayed.</li>
</ol>
<h2 id="the-l2tol1messagepasser-contract"><a class="header" href="#the-l2tol1messagepasser-contract">The L2ToL1MessagePasser Contract</a></h2>
<p>A withdrawal is initiated by calling the L2ToL1MessagePasser contract's <code>initiateWithdrawal</code> function.
The L2ToL1MessagePasser is a simple predeploy contract at <code>0x4200000000000000000000000000000000000016</code>
which stores messages to be withdrawn.</p>
<pre><code class="language-js">interface L2ToL1MessagePasser {
    event MessagePassed(
        uint256 indexed nonce, // this is a global nonce value for all withdrawal messages
        address indexed sender,
        address indexed target,
        uint256 value,
        uint256 gasLimit,
        bytes data,
        bytes32 withdrawalHash
    );

    event WithdrawerBalanceBurnt(uint256 indexed amount);

    function burn() external;

    function initiateWithdrawal(address _target, uint256 _gasLimit, bytes memory _data) payable external;

    function messageNonce() public view returns (uint256);

    function sentMessages(bytes32) view external returns (bool);
}

</code></pre>
<p>The <code>MessagePassed</code> event includes all of the data that is hashed and
stored in the <code>sentMessages</code> mapping, as well as the hash itself.</p>
<h3 id="addresses-are-not-aliased-on-withdrawals"><a class="header" href="#addresses-are-not-aliased-on-withdrawals">Addresses are not Aliased on Withdrawals</a></h3>
<p>When a contract makes a deposit, the sender's address is <a href="protocol/deposits.html#address-aliasing">aliased</a>. The same is not true
of withdrawals, which do not modify the sender's address. The difference is that:</p>
<ul>
<li>on L2, the deposit sender's address is returned by the <code>CALLER</code> opcode, meaning a contract cannot easily tell if the
call originated on L1 or L2, whereas</li>
<li>on L1, the withdrawal sender's address is accessed by calling the <code>l2Sender()</code> function on the <code>OptimismPortal</code>
contract.</li>
</ul>
<p>Calling <code>l2Sender()</code> removes any ambiguity about which domain the call originated from. Still, developers will need to
recognize that having the same address does not imply that a contract on L2 will behave the same as a contract on L1.</p>
<h2 id="the-optimism-portal-contract"><a class="header" href="#the-optimism-portal-contract">The Optimism Portal Contract</a></h2>
<p>The Optimism Portal serves as both the entry and exit point to the Optimism L2. It is a contract which inherits from
the <a href="protocol/deposits.html#deposit-contract">OptimismPortal</a> contract, and in addition provides the following interface for
withdrawals:</p>
<ul>
<li><a href="https://github.com/ethereum-optimism/optimism/blob/08daf8dbd38c9ffdbd18fc9a211c227606cdb0ad/packages/contracts-bedrock/src/libraries/Types.sol#L62-L69"><code>WithdrawalTransaction</code> type</a></li>
<li><a href="https://github.com/ethereum-optimism/optimism/blob/08daf8dbd38c9ffdbd18fc9a211c227606cdb0ad/packages/contracts-bedrock/src/libraries/Types.sol#L25-L30"><code>OutputRootProof</code> type</a></li>
</ul>
<pre><code class="language-js">interface OptimismPortal {

    event WithdrawalFinalized(bytes32 indexed withdrawalHash, bool success);


    function l2Sender() returns(address) external;

    function proveWithdrawalTransaction(
        Types.WithdrawalTransaction memory _tx,
        uint256 _l2OutputIndex,
        Types.OutputRootProof calldata _outputRootProof,
        bytes[] calldata _withdrawalProof
    ) external;

    function finalizeWithdrawalTransaction(
        Types.WithdrawalTransaction memory _tx
    ) external;
}
</code></pre>
<h2 id="withdrawal-verification-and-finalization"><a class="header" href="#withdrawal-verification-and-finalization">Withdrawal Verification and Finalization</a></h2>
<p>The following inputs are required to prove and finalize a withdrawal:</p>
<ul>
<li>Withdrawal transaction data:
<ul>
<li><code>nonce</code>: Nonce for the provided message.</li>
<li><code>sender</code>: Message sender address on L2.</li>
<li><code>target</code>: Target address on L1.</li>
<li><code>value</code>: ETH to send to the target.</li>
<li><code>data</code>: Data to send to the target.</li>
<li><code>gasLimit</code>: Gas to be forwarded to the target.</li>
</ul>
</li>
<li>Proof and verification data:
<ul>
<li><code>l2OutputIndex</code>: The index in the L2 outputs where the applicable output root may be found.</li>
<li><code>outputRootProof</code>: Four <code>bytes32</code> values which are used to derive the output root.</li>
<li><code>withdrawalProof</code>: An inclusion proof for the given withdrawal in the L2ToL1MessagePasser contract.</li>
</ul>
</li>
</ul>
<p>These inputs must satisfy the following conditions:</p>
<ol>
<li>The <code>l2OutputIndex</code> must be the index in the L2 outputs that contains the applicable output root.</li>
<li><code>L2OutputOracle.getL2Output(l2OutputIndex)</code> returns a non-zero <code>OutputProposal</code>.</li>
<li>The keccak256 hash of the <code>outputRootProof</code> values is equal to the <code>outputRoot</code>.</li>
<li>The <code>withdrawalProof</code> is a valid inclusion proof demonstrating that a hash of the Withdrawal transaction data
is contained in the storage of the L2ToL1MessagePasser contract on L2.</li>
</ol>
<h2 id="security-considerations"><a class="header" href="#security-considerations">Security Considerations</a></h2>
<h3 id="key-properties-of-withdrawal-verification"><a class="header" href="#key-properties-of-withdrawal-verification">Key Properties of Withdrawal Verification</a></h3>
<ol>
<li>
<p>It should not be possible to 'double spend' a withdrawal, ie. to relay a withdrawal on L1 which does not
correspond to a message initiated on L2. For reference, see <a href="https://gerhard-wagner.medium.com/double-spending-bug-in-polygons-plasma-bridge-2e0954ccadf1">this writeup</a> of a vulnerability
of this type found on Polygon.</p>
</li>
<li>
<p>For each withdrawal initiated on L2 (i.e. with a unique <code>messageNonce()</code>), the following properties must hold:</p>
<ol>
<li>It should only be possible to prove the withdrawal once, unless the outputRoot for the withdrawal
has changed.</li>
<li>It should only be possible to finalize the withdrawal once.</li>
<li>It should not be possible to relay the message with any of its fields modified, ie.
<ol>
<li>Modifying the <code>sender</code> field would enable a 'spoofing' attack.</li>
<li>Modifying the <code>target</code>, <code>data</code>, or <code>value</code> fields would enable an attacker to dangerously change the
intended outcome of the withdrawal.</li>
<li>Modifying the <code>gasLimit</code> could make the cost of relaying too high, or allow the relayer to cause execution
to fail (out of gas) in the <code>target</code>.</li>
</ol>
</li>
</ol>
</li>
</ol>
<h3 id="handling-successfully-verified-messages-that-fail-when-relayed"><a class="header" href="#handling-successfully-verified-messages-that-fail-when-relayed">Handling Successfully Verified Messages That Fail When Relayed</a></h3>
<p>If the execution of the relayed call fails in the <code>target</code> contract, it is unfortunately not possible to determine
whether or not it was 'supposed' to fail, and whether or not it should be 'replayable'. For this reason, and to
minimize complexity, we have not provided any replay functionality, this may be implemented in external utility
contracts if desired.</p>
<h3 id="optimismportal-can-send-arbitrary-messages-on-l1"><a class="header" href="#optimismportal-can-send-arbitrary-messages-on-l1">OptimismPortal can send arbitrary messages on L1</a></h3>
<p>The <code>L2ToL1MessagePasser</code> contract's <code>initiateWithdrawal</code> function accepts a <code>_target</code> address and <code>_data</code> bytes,
which is passed to a <code>CALL</code> opcode on L1 when <code>finalizeWithdrawalTransaction</code> is called after the challenge
period. This means that, by design, the <code>OptimismPortal</code> contract can be used to send arbitrary transactions on
the L1, with the <code>OptimismPortal</code> as the <code>msg.sender</code>.</p>
<p>This means users of the <code>OptimismPortal</code> contract should be careful what permissions they grant to the portal.
For example, any ERC20 tokens mistakenly sent to the <code>OptimismPortal</code> contract are essentially lost, as they can
be claimed by anybody that pre-approves transfers of this token out of the portal, using the L2 to initiate the
approval and the L1 to prove and finalize the approval (after the challenge period).</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="guaranteed-gas-fee-market"><a class="header" href="#guaranteed-gas-fee-market">Guaranteed Gas Fee Market</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/guaranteed-gas-market.html#overview">Overview</a></li>
<li><a href="protocol/guaranteed-gas-market.html#gas-stipend">Gas Stipend</a></li>
<li><a href="protocol/guaranteed-gas-market.html#default-values">Default Values</a></li>
<li><a href="protocol/guaranteed-gas-market.html#limiting-guaranteed-gas">Limiting Guaranteed Gas</a></li>
<li><a href="protocol/guaranteed-gas-market.html#rationale-for-burning-l1-gas">Rationale for burning L1 Gas</a></li>
<li><a href="protocol/guaranteed-gas-market.html#on-preventing-griefing-attacks">On Preventing Griefing Attacks</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-6"><a class="header" href="#overview-6">Overview</a></h2>
<p><a href="protocol/../glossary.html#deposited-transaction">Deposited transactions</a> are transactions on L2 that are
initiated on L1. The gas that they use on L2 is bought on L1 via a gas burn (or a direct payment
in the future). We maintain a fee market and hard cap on the amount of gas provided to all deposits
in a single L1 block.</p>
<p>The gas provided to deposited transactions is sometimes called "guaranteed gas". The gas provided to
deposited transactions is unique in the regard that it is not refundable. It cannot be refunded as
it is sometimes paid for with a gas burn and there may not be any ETH left to refund.</p>
<p>The <strong>guaranteed gas</strong> is composed of a gas stipend, and of any guaranteed gas the user would like
to purchase (on L1) on top of that.</p>
<p>Guaranteed gas on L2 is bought in the following manner. An L2 gas price is calculated via an
EIP-1559-style algorithm. The total amount of ETH required to buy that gas is then calculated as
(<code>guaranteed gas * L2 deposit base fee</code>). The contract then accepts that amount of ETH (in a future
upgrade) or (only method right now), burns an amount of L1 gas that corresponds to the L2 cost (<code>L2 cost / L1 base fee</code>). The L2 gas price for guaranteed gas is not synchronized with the base fee on
L2 and will likely be different.</p>
<h2 id="gas-stipend"><a class="header" href="#gas-stipend">Gas Stipend</a></h2>
<p>To offset the gas spent on the deposit event, we credit <code>gas spent * L1 base fee</code> ETH to the cost
of the L2 gas, where <code>gas spent</code> is the amount of L1 gas spent processing the deposit. If the ETH
value of this credit is greater than the ETH value of the requested guaranteed gas (<code>requested guaranteed gas * L2 gas price</code>), no L1 gas is burnt.</p>
<h2 id="default-values"><a class="header" href="#default-values">Default Values</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Variable</th><th>Value</th></tr></thead><tbody>
<tr><td><code>MAX_RESOURCE_LIMIT</code></td><td>20,000,000</td></tr>
<tr><td><code>ELASTICITY_MULTIPLIER</code></td><td>10</td></tr>
<tr><td><code>BASE_FEE_MAX_CHANGE_DENOMINATOR</code></td><td>8</td></tr>
<tr><td><code>MINIMUM_BASE_FEE</code></td><td>1 gwei</td></tr>
<tr><td><code>MAXIMUM_BASE_FEE</code></td><td>type(uint128).max</td></tr>
<tr><td><code>SYSTEM_TX_MAX_GAS</code></td><td>1,000,000</td></tr>
<tr><td><code>TARGET_RESOURCE_LIMIT</code></td><td><code>MAX_RESOURCE_LIMIT</code> / <code>ELASTICITY_MULTIPLIER</code></td></tr>
</tbody></table>
</div>
<h2 id="limiting-guaranteed-gas"><a class="header" href="#limiting-guaranteed-gas">Limiting Guaranteed Gas</a></h2>
<p>The total amount of guaranteed gas that can be bought in a single L1 block must be limited to
prevent a denial of service attack against L2 as well as ensure the total amount of guaranteed gas
stays below the L2 block gas limit.</p>
<p>We set a guaranteed gas limit of <code>MAX_RESOURCE_LIMIT</code> gas per L1 block and a target of
<code>MAX_RESOURCE_LIMIT</code> / <code>ELASTICITY_MULTIPLIER</code> gas per L1 block. These numbers enabled
occasional large transactions while staying within our target and maximum gas usage on L2.</p>
<p>Because the amount of guaranteed L2 gas that can be purchased in a single block is now limited,
we implement an EIP-1559-style fee market to reduce congestion on deposits. By setting the limit
at a multiple of the target, we enable deposits to temporarily use more L2 gas at a greater cost.</p>
<pre><code class="language-python"># Pseudocode to update the L2 deposit base fee and cap the amount of guaranteed gas
# bought in a block. Calling code must handle the gas burn and validity checks on
# the ability of the account to afford this gas.

# prev_base fee is a u128, prev_bought_gas and prev_num are u64s
prev_base_fee, prev_bought_gas, prev_num = &lt;values from previous update&gt;
now_num = block.number

# Clamp the full base fee to a specific range. The minimum value in the range should be around 100-1000
# to enable faster responses in the base fee. This replaces the `max` mechanism in the ethereum 1559
# implementation (it also serves to enable the base fee to increase if it is very small).
def clamp(v: i256, min: u128, max: u128) -&gt; u128:
    if v &lt; i256(min):
        return min
    elif v &gt; i256(max):
        return max
    else:
        return u128(v)

# If this is a new block, update the base fee and reset the total gas
# If not, just update the total gas
if prev_num == now_num:
    now_base_fee = prev_base_fee
    now_bought_gas = prev_bought_gas + requested_gas
elif prev_num != now_num:
    # Width extension and conversion to signed integer math
    gas_used_delta = int128(prev_bought_gas) - int128(TARGET_RESOURCE_LIMIT)
    # Use truncating (round to 0) division - solidity's default.
    # Sign extend gas_used_delta &amp; prev_base_fee to 256 bits to avoid overflows here.
    base_fee_per_gas_delta = prev_base_fee * gas_used_delta / TARGET_RESOURCE_LIMIT / BASE_FEE_MAX_CHANGE_DENOMINATOR
    now_base_fee_wide = prev_base_fee + base_fee_per_gas_delta

    now_base_fee = clamp(now_base_fee_wide, min=MINIMUM_BASE_FEE, max=UINT_128_MAX_VALUE)
    now_bought_gas =  requested_gas

    # If we skipped multiple blocks between the previous block and now update the base fee again.
    # This is not exactly the same as iterating the above function, but quite close for reasonable
    # gas target values. It is also constant time wrt the number of missed blocks which is important
    # for keeping gas usage stable.
    if prev_num + 1 &lt; now_num:
        n = now_num - prev_num - 1
        # Apply 7/8 reduction to prev_base_fee for the n empty blocks in a row.
        now_base_fee_wide = now_base_fee * pow(1-(1/BASE_FEE_MAX_CHANGE_DENOMINATOR), n)
        now_base_fee = clamp(now_base_fee_wide, min=MINIMUM_BASE_FEE, max=type(uint128).max)

require(now_bought_gas &lt; MAX_RESOURCE_LIMIT)

store_values(now_base_fee, now_bought_gas, now_num)
</code></pre>
<h2 id="rationale-for-burning-l1-gas"><a class="header" href="#rationale-for-burning-l1-gas">Rationale for burning L1 Gas</a></h2>
<p>There must be a sybil resistance mechanism for usage of the network. If it is very cheap to get
guaranteed gas on L2, then it would be possible to spam the network. Burning a dynamic amount
of gas on L1 acts as a sybil resistance mechanism as it becomes more expensive with more demand.</p>
<p>If we collect ETH directly to pay for L2 gas, every (indirect) caller of the deposit function will need
to be marked with the payable selector. This won't be possible for many existing projects. Unfortunately
this is quite wasteful. As such, we will provide two options to buy L2 gas:</p>
<ol>
<li>Burn L1 Gas</li>
<li>Send ETH to the Optimism Portal (Not yet supported)</li>
</ol>
<p>The payable version (Option 2) will likely have discount applied to it (or conversely, #1 has a
premium applied to it).</p>
<p>For the initial release of bedrock, only #1 is supported.</p>
<h2 id="on-preventing-griefing-attacks"><a class="header" href="#on-preventing-griefing-attacks">On Preventing Griefing Attacks</a></h2>
<p>The cost of purchasing all of the deposit gas in every block must be expensive
enough to prevent attackers from griefing all deposits to the network.
An attacker would observe a deposit in the mempool and frontrun it with a deposit
that purchases enough gas such that the other deposit reverts.
The smaller the max resource limit is, the easier this attack is to pull off.
This attack is mitigated by having a large resource limit as well as a large
elasticity multiplier. This means that the target resource usage is kept small,
giving a lot of room for the deposit base fee to rise when the max resource limit
is being purchased.</p>
<p>This attack should be too expensive to pull off in practice, but if an extremely
wealthy adversary does decide to grief network deposits for an extended period
of time, efforts will be placed to ensure that deposits are able to be processed
on the network.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="l2-output-root-proposals-specification"><a class="header" href="#l2-output-root-proposals-specification">L2 Output Root Proposals Specification</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/proposals.html#overview">Overview</a></li>
<li><a href="protocol/proposals.html#proposing-l2-output-commitments">Proposing L2 Output Commitments</a>
<ul>
<li><a href="protocol/proposals.html#l2outputoracle-v100">L2OutputOracle v1.0.0</a></li>
</ul>
</li>
<li><a href="protocol/proposals.html#l2-output-commitment-construction">L2 Output Commitment Construction</a></li>
<li><a href="protocol/proposals.html#l2-output-oracle-smart-contract">L2 Output Oracle Smart Contract</a>
<ul>
<li><a href="protocol/proposals.html#configuration">Configuration</a></li>
</ul>
</li>
<li><a href="protocol/proposals.html#security-considerations">Security Considerations</a>
<ul>
<li><a href="protocol/proposals.html#l1-reorgs">L1 Reorgs</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<!-- All glossary references in this file. -->
<h2 id="overview-7"><a class="header" href="#overview-7">Overview</a></h2>
<p>After processing one or more blocks the outputs will need to be synchronized with the settlement layer (L1)
for trustless execution of L2-to-L1 messaging, such as withdrawals.
These output proposals act as the bridge's view into the L2 state.
Actors called "Proposers" submit the output roots to the settlement layer (L1) and can be contested with a fault proof,
with a bond at stake if the proof is wrong. The <a href="https://github.com/ethereum-optimism/optimism/tree/d48b45954c381f75a13e61312da68d84e9b41418/op-proposer">op-proposer</a> in one such implementation of a proposer.</p>
<p><em>Note</em>: Fault proofs on Optimism are not fully specified at this time. Although fault proof
construction and verification <a href="https://github.com/ethereum-optimism/cannon">is implemented in Cannon</a>,
the fault proof game specification and integration of a output-root challenger into the <a href="protocol/../glossary.html#rollup-node">rollup-node</a>
are part of later specification milestones.</p>
<h2 id="proposing-l2-output-commitments"><a class="header" href="#proposing-l2-output-commitments">Proposing L2 Output Commitments</a></h2>
<p>The proposer's role is to construct and submit output roots, which are commitments to the L2's state,
to the <code>L2OutputOracle</code> contract on L1 (the settlement layer). To do this, the proposer periodically
queries the <a href="protocol/rollup-node.html">rollup node</a> for the latest output root derived from the latest
<a href="protocol/rollup-node.html#finalization-guarantees">finalized</a> L1 block. It then takes the output root and
submits it to the <code>L2OutputOracle</code> contract on the settlement layer (L1).</p>
<h3 id="l2outputoracle-v100"><a class="header" href="#l2outputoracle-v100">L2OutputOracle v1.0.0</a></h3>
<p>The submission of output proposals is permissioned to a single account. It is expected that this
account will continue to submit output proposals over time to ensure that user withdrawals do not halt.</p>
<p>The <a href="https://github.com/ethereum-optimism/optimism/tree/d48b45954c381f75a13e61312da68d84e9b41418/op-proposer">L2 output proposer</a> is expected to submit output roots on a deterministic
interval based on the configured <code>SUBMISSION_INTERVAL</code> in the <code>L2OutputOracle</code>. The larger
the <code>SUBMISSION_INTERVAL</code>, the less often L1 transactions need to be sent to the <code>L2OutputOracle</code>
contract, but L2 users will need to wait a bit longer for an output root to be included in L1 (the settlement layer)
that includes their intention to withdraw from the system.</p>
<p>The honest <code>op-proposer</code> algorithm assumes a connection to the <code>L2OutputOracle</code> contract to know
the L2 block number that corresponds to the next output proposal that must be submitted. It also
assumes a connection to an <code>op-node</code> to be able to query the <code>optimism_syncStatus</code> RPC endpoint.</p>
<pre><code class="language-python">import time

while True:
    next_checkpoint_block = L2OutputOracle.nextBlockNumber()
    rollup_status = op_node_client.sync_status()
    if rollup_status.finalized_l2.number &gt;= next_checkpoint_block:
        output = op_node_client.output_at_block(next_checkpoint_block)
        tx = send_transaction(output)
    time.sleep(poll_interval)
</code></pre>
<p>A <code>CHALLENGER</code> account can delete multiple output roots by calling the <code>deleteL2Outputs()</code> function
and specifying the index of the first output to delete, this will also delete all subsequent outputs.</p>
<h2 id="l2-output-commitment-construction"><a class="header" href="#l2-output-commitment-construction">L2 Output Commitment Construction</a></h2>
<p>The <code>output_root</code> is a 32 byte string, which is derived based on the a versioned scheme:</p>
<pre><code class="language-pseudocode">output_root = keccak256(version_byte || payload)
</code></pre>
<p>where:</p>
<ol>
<li>
<p><code>version_byte</code> (<code>bytes32</code>) a simple version string which increments anytime the construction of the output root
is changed.</p>
</li>
<li>
<p><code>payload</code> (<code>bytes</code>) is a byte string of arbitrary length.</p>
</li>
</ol>
<p>In the initial version of the output commitment construction, the version is <code>bytes32(0)</code>, and the payload is defined
as:</p>
<pre><code class="language-pseudocode">payload = state_root || withdrawal_storage_root || latest_block_hash
</code></pre>
<p>where:</p>
<ol>
<li>
<p>The <code>latest_block_hash</code> (<code>bytes32</code>) is the block hash for the latest L2 block.</p>
</li>
<li>
<p>The <code>state_root</code> (<code>bytes32</code>) is the Merkle-Patricia-Trie (<a href="protocol/../glossary.html#merkle-patricia-trie">MPT</a>) root of all execution-layer accounts.
This value is frequently used and thus elevated closer to the L2 output root, which removes the need to prove its
inclusion in the pre-image of the <code>latest_block_hash</code>. This reduces the merkle proof depth and cost of accessing the
L2 state root on L1.</p>
</li>
<li>
<p>The <code>withdrawal_storage_root</code> (<code>bytes32</code>) elevates the Merkle-Patricia-Trie (<a href="protocol/../glossary.html#merkle-patricia-trie">MPT</a>) root of the <a href="protocol/withdrawals.html#the-l2tol1messagepasser-contract">Message
Passer contract</a> storage. Instead of making an MPT proof for a
withdrawal against the state root (proving first the storage root of the L2toL1MessagePasser against the state root,
then the withdrawal against that storage root), we can prove against the L2toL1MessagePasser's storage root directly,
thus reducing the verification cost of withdrawals on L1.</p>
<p>After Isthmus hard fork, the <code>withdrawal_storage_root</code> is present in the
<a href="protocol/../protocol/isthmus/exec-engine.html#l2tol1messagepasser-storage-root-in-header">block header as <code>withdrawalsRoot</code></a> and can be used directly, instead of computing
the storage root of the L2toL1MessagePasser contract.</p>
<p>Similarly, if Isthmus hard fork is active at the genesis block, the <code>withdrawal_storage_root</code> is present
in the <a href="protocol/../protocol/isthmus/exec-engine.html#l2tol1messagepasser-storage-root-in-header">block header as <code>withdrawalsRoot</code></a>.</p>
</li>
</ol>
<h2 id="l2-output-oracle-smart-contract"><a class="header" href="#l2-output-oracle-smart-contract">L2 Output Oracle Smart Contract</a></h2>
<p>L2 blocks are produced at a constant rate of <code>L2_BLOCK_TIME</code> (2 seconds).
A new L2 output MUST be appended to the chain once per <code>SUBMISSION_INTERVAL</code> which is based on a number of blocks.
The exact number is yet to be determined, and will depend on the design of the fault proving game.</p>
<p>The L2 Output Oracle contract implements the following interface:</p>
<pre><code class="language-solidity">/**
 * @notice The number of the first L2 block recorded in this contract.
 */
uint256 public startingBlockNumber;

/**
 * @notice The timestamp of the first L2 block recorded in this contract.
 */
uint256 public startingTimestamp;

/**
 * @notice Accepts an L2 outputRoot and the timestamp of the corresponding L2 block. The
 * timestamp must be equal to the current value returned by `nextTimestamp()` in order to be
 * accepted.
 * This function may only be called by the Proposer.
 *
 * @param _l2Output      The L2 output of the checkpoint block.
 * @param _l2BlockNumber The L2 block number that resulted in _l2Output.
 * @param _l1Blockhash   A block hash which must be included in the current chain.
 * @param _l1BlockNumber The block number with the specified block hash.
*/
  function proposeL2Output(
      bytes32 _l2Output,
      uint256 _l2BlockNumber,
      bytes32 _l1Blockhash,
      uint256 _l1BlockNumber
  )

/**
 * @notice Deletes all output proposals after and including the proposal that corresponds to
 *         the given output index. Only the challenger address can delete outputs.
 *
 * @param _l2OutputIndex Index of the first L2 output to be deleted. All outputs after this
 *                       output will also be deleted.
 */
function deleteL2Outputs(uint256 _l2OutputIndex) external

/**
 * @notice Computes the block number of the next L2 block that needs to be checkpointed.
 */
function nextBlockNumber() public view returns (uint256)
</code></pre>
<h3 id="configuration"><a class="header" href="#configuration">Configuration</a></h3>
<p>The <code>startingBlockNumber</code> must be at least the number of the first Bedrock block.
The <code>startingTimestamp</code> MUST be the same as the timestamp of the start block.</p>
<p>The first <code>outputRoot</code> proposed will thus be at height <code>startingBlockNumber + SUBMISSION_INTERVAL</code></p>
<h2 id="security-considerations-1"><a class="header" href="#security-considerations-1">Security Considerations</a></h2>
<h3 id="l1-reorgs"><a class="header" href="#l1-reorgs">L1 Reorgs</a></h3>
<p>If the L1 has a reorg after an output has been generated and submitted, the L2 state and correct output may change
leading to a faulty proposal. This is mitigated against by allowing the proposer to submit an
L1 block number and hash to the Output Oracle when appending a new output; in the event of a reorg, the block hash
will not match that of the block with that number and the call will revert.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="l2-execution-engine"><a class="header" href="#l2-execution-engine">L2 Execution Engine</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/exec-engine.html#1559-parameters">1559 Parameters</a></li>
<li><a href="protocol/exec-engine.html#extra-data">Extra Data</a></li>
<li><a href="protocol/exec-engine.html#deposited-transaction-processing">Deposited transaction processing</a>
<ul>
<li><a href="protocol/exec-engine.html#deposited-transaction-boundaries">Deposited transaction boundaries</a></li>
</ul>
</li>
<li><a href="protocol/exec-engine.html#fees">Fees</a>
<ul>
<li><a href="protocol/exec-engine.html#fee-vaults">Fee Vaults</a></li>
<li><a href="protocol/exec-engine.html#priority-fees-sequencer-fee-vault">Priority fees (Sequencer Fee Vault)</a></li>
<li><a href="protocol/exec-engine.html#base-fees-base-fee-vault">Base fees (Base Fee Vault)</a></li>
<li><a href="protocol/exec-engine.html#l1-cost-fees-l1-fee-vault">L1-Cost fees (L1 Fee Vault)</a>
<ul>
<li><a href="protocol/exec-engine.html#pre-ecotone">Pre-Ecotone</a></li>
<li><a href="protocol/exec-engine.html#ecotone-l1-cost-fee-changes-eip-4844-da">Ecotone L1-Cost fee changes (EIP-4844 DA)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="protocol/exec-engine.html#engine-api">Engine API</a>
<ul>
<li><a href="protocol/exec-engine.html#engine_forkchoiceupdatedv2"><code>engine_forkchoiceUpdatedV2</code></a>
<ul>
<li><a href="protocol/exec-engine.html#extended-payloadattributesv2">Extended PayloadAttributesV2</a></li>
</ul>
</li>
<li><a href="protocol/exec-engine.html#engine_forkchoiceupdatedv3"><code>engine_forkchoiceUpdatedV3</code></a>
<ul>
<li><a href="protocol/exec-engine.html#extended-payloadattributesv3">Extended PayloadAttributesV3</a></li>
</ul>
</li>
<li><a href="protocol/exec-engine.html#engine_newpayloadv2"><code>engine_newPayloadV2</code></a></li>
<li><a href="protocol/exec-engine.html#engine_newpayloadv3"><code>engine_newPayloadV3</code></a></li>
<li><a href="protocol/exec-engine.html#engine_newpayloadv4"><code>engine_newPayloadV4</code></a></li>
<li><a href="protocol/exec-engine.html#engine_getpayloadv2"><code>engine_getPayloadV2</code></a></li>
<li><a href="protocol/exec-engine.html#engine_getpayloadv3"><code>engine_getPayloadV3</code></a>
<ul>
<li><a href="protocol/exec-engine.html#extended-response">Extended Response</a></li>
</ul>
</li>
<li><a href="protocol/exec-engine.html#engine_getpayloadv4"><code>engine_getPayloadV4</code></a></li>
<li><a href="protocol/exec-engine.html#engine_signalsuperchainv1"><code>engine_signalSuperchainV1</code></a></li>
</ul>
</li>
<li><a href="protocol/exec-engine.html#networking">Networking</a></li>
<li><a href="protocol/exec-engine.html#sync">Sync</a>
<ul>
<li><a href="protocol/exec-engine.html#happy-path-sync">Happy-path sync</a></li>
<li><a href="protocol/exec-engine.html#worst-case-sync">Worst-case sync</a></li>
</ul>
</li>
<li><a href="protocol/exec-engine.html#ecotone-disable-blob-transactions">Ecotone: disable Blob-transactions</a></li>
<li><a href="protocol/exec-engine.html#ecotone-beacon-block-root">Ecotone: Beacon Block Root</a></li>
<li><a href="protocol/exec-engine.html#p2p-modifications">P2P Modifications</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<p>This document outlines the modifications, configuration and usage of a L1 execution engine for L2.</p>
<h2 id="1559-parameters"><a class="header" href="#1559-parameters">1559 Parameters</a></h2>
<p>The execution engine must be able to take a per chain configuration which specifies the EIP-1559 Denominator
and EIP-1559 elasticity. After Canyon it should also take a new value <code>EIP1559DenominatorCanyon</code> and use that as
the denominator in the 1559 formula rather than the prior denominator.</p>
<p>The formula for EIP-1559 is otherwise not modified.</p>
<p>Starting with Holocene, the EIP-1559 parameters become <a href="protocol/holocene/exec-engine.html#dynamic-eip-1559-parameters">dynamically configurable</a>.</p>
<p>Starting with Jovian, a <a href="protocol/jovian/exec-engine.html#minimum-base-fee">configurable minimum base fee</a> is introduced.</p>
<h2 id="extra-data"><a class="header" href="#extra-data">Extra Data</a></h2>
<p>Before Holocene, the genesis block may contain an arbitrary <code>extraData</code> value whereas all normal
blocks must have an <strong>empty</strong> <code>extraData</code> field.</p>
<p>With Holocene, the <code>extraData</code> field <a href="protocol/holocene/exec-engine.html#dynamic-eip-1559-parameters">encodes the EIP-1559 parameters</a>.</p>
<p>With Jovian, the <code>extraData</code> encoding is extended to <a href="protocol/jovian/exec-engine.html#minimum-base-fee">include <code>minBaseFee</code></a>.</p>
<h2 id="deposited-transaction-processing"><a class="header" href="#deposited-transaction-processing">Deposited transaction processing</a></h2>
<p>The Engine interfaces abstract away transaction types with <a href="https://eips.ethereum.org/EIPS/eip-2718">EIP-2718</a>.</p>
<p>To support rollup functionality, processing of a new Deposit <a href="https://eips.ethereum.org/EIPS/eip-2718#transactions"><code>TransactionType</code></a>
is implemented by the engine, see the <a href="protocol/deposits.html">deposits specification</a>.</p>
<p>This type of transaction can mint L2 ETH, run EVM,
and introduce L1 information to enshrined contracts in the execution state.</p>
<h3 id="deposited-transaction-boundaries"><a class="header" href="#deposited-transaction-boundaries">Deposited transaction boundaries</a></h3>
<p>Transactions cannot be blindly trusted, trust is established through authentication.
Unlike other transaction types deposits are not authenticated by a signature:
the rollup node authenticates them, outside of the engine.</p>
<p>To process deposited transactions safely, the deposits MUST be authenticated first:</p>
<ul>
<li>Ingest directly through trusted Engine API</li>
<li>Part of sync towards a trusted block hash (trusted through previous Engine API instruction)</li>
</ul>
<p>Deposited transactions MUST never be consumed from the transaction pool.
<em>The transaction pool can be disabled in a deposits-only rollup</em></p>
<h2 id="fees"><a class="header" href="#fees">Fees</a></h2>
<p>Sequenced transactions (i.e. not applicable to deposits) are charged with 3 types of fees:
priority fees, base fees, and L1-cost fees.</p>
<h3 id="fee-vaults"><a class="header" href="#fee-vaults">Fee Vaults</a></h3>
<p>The three types of fees are collected in 3 distinct L2 fee-vault deployments for accounting purposes:
fee payments are not registered as internal EVM calls, and thus distinguished better this way.</p>
<p>These are hardcoded addresses, pointing at pre-deployed proxy contracts.
The proxies are backed by vault contract deployments, based on <code>FeeVault</code>, to route vault funds to L1 securely.</p>
<div class="table-wrapper"><table><thead><tr><th>Vault Name</th><th>Predeploy</th></tr></thead><tbody>
<tr><td>Sequencer Fee Vault</td><td><a href="protocol/predeploys.html#sequencerfeevault"><code>SequencerFeeVault</code></a></td></tr>
<tr><td>Base Fee Vault</td><td><a href="protocol/predeploys.html#basefeevault"><code>BaseFeeVault</code></a></td></tr>
<tr><td>L1 Fee Vault</td><td><a href="protocol/predeploys.html#l1feevault"><code>L1FeeVault</code></a></td></tr>
</tbody></table>
</div>
<h3 id="priority-fees-sequencer-fee-vault"><a class="header" href="#priority-fees-sequencer-fee-vault">Priority fees (Sequencer Fee Vault)</a></h3>
<p>Priority fees follow the <a href="https://eips.ethereum.org/EIPS/eip-1559">eip-1559</a> specification, and are collected by the fee-recipient of the L2 block.
The block fee-recipient (a.k.a. coinbase address) is set to the Sequencer Fee Vault address.</p>
<h3 id="base-fees-base-fee-vault"><a class="header" href="#base-fees-base-fee-vault">Base fees (Base Fee Vault)</a></h3>
<p>Base fees largely follow the <a href="https://eips.ethereum.org/EIPS/eip-1559">eip-1559</a> specification, with the exception that base fees are not burned,
but add up to the Base Fee Vault ETH account balance.</p>
<h3 id="l1-cost-fees-l1-fee-vault"><a class="header" href="#l1-cost-fees-l1-fee-vault">L1-Cost fees (L1 Fee Vault)</a></h3>
<p>The protocol funds batch-submission of sequenced L2 transactions by charging L2 users an additional fee
based on the estimated batch-submission costs.
This fee is charged from the L2 transaction-sender ETH balance, and collected into the L1 Fee Vault.</p>
<p>The exact L1 cost function to determine the L1-cost fee component of a L2 transaction depends on
the upgrades that are active.</p>
<h4 id="pre-ecotone"><a class="header" href="#pre-ecotone">Pre-Ecotone</a></h4>
<p>Before Ecotone activation, L1 cost is calculated as:
<code>(rollupDataGas + l1FeeOverhead) * l1BaseFee * l1FeeScalar / 1e6</code> (big-int computation, result
in Wei and <code>uint256</code> range)
Where:</p>
<ul>
<li><code>rollupDataGas</code> is determined from the <em>full</em> encoded transaction
(standard EIP-2718 transaction encoding, including signature fields):
<ul>
<li>Before Regolith fork: <code>rollupDataGas = zeroes * 4 + (ones + 68) * 16</code>
<ul>
<li>The addition of <code>68</code> non-zero bytes is a remnant of a pre-Bedrock L1-cost accounting function,
which accounted for the worst-case non-zero bytes addition to complement unsigned transactions, unlike Bedrock.</li>
</ul>
</li>
<li>With Regolith fork: <code>rollupDataGas = zeroes * 4 + ones * 16</code></li>
</ul>
</li>
<li><code>l1FeeOverhead</code> is the Gas Price Oracle <code>overhead</code> value.</li>
<li><code>l1FeeScalar</code> is the Gas Price Oracle <code>scalar</code> value.</li>
<li><code>l1BaseFee</code> is the L1 base fee of the latest L1 origin registered in the L2 chain.</li>
</ul>
<p>Note that the <code>rollupDataGas</code> uses the same byte cost accounting as defined in <a href="https://eips.ethereum.org/EIPS/eip-2028">eip-2028</a>,
except the full L2 transaction now counts towards the bytes charged in the L1 calldata.
This behavior matches pre-Bedrock L1-cost estimation of L2 transactions.</p>
<p>Compression, batching, and intrinsic gas costs of the batch transactions are accounted for by the protocol
with the Gas Price Oracle <code>overhead</code> and <code>scalar</code> parameters.</p>
<p>The Gas Price Oracle <code>l1FeeOverhead</code> and <code>l1FeeScalar</code>, as well as the <code>l1BaseFee</code> of the L1 origin,
can be accessed in two interchangeable ways:</p>
<ul>
<li>read from the deposited L1 attributes (<code>l1FeeOverhead</code>, <code>l1FeeScalar</code>, <code>basefee</code>) of the current L2 block</li>
<li>read from the L1 Block Info contract (<code>0x4200000000000000000000000000000000000015</code>)
<ul>
<li>using the respective solidity <code>uint256</code>-getter functions (<code>l1FeeOverhead</code>, <code>l1FeeScalar</code>, <code>basefee</code>)</li>
<li>using direct storage-reads:
<ul>
<li>L1 basefee as big-endian <code>uint256</code> in slot <code>1</code></li>
<li>Overhead as big-endian <code>uint256</code> in slot <code>5</code></li>
<li>Scalar as big-endian <code>uint256</code> in slot <code>6</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="ecotone-l1-cost-fee-changes-eip-4844-da"><a class="header" href="#ecotone-l1-cost-fee-changes-eip-4844-da">Ecotone L1-Cost fee changes (EIP-4844 DA)</a></h4>
<p>Ecotone allows posting batches via Blobs which are subject to a new fee market. To account for this feature,
L1 cost is computed as:</p>
<p><code>(zeroes*4 + ones*16) * (16*l1BaseFee*l1BaseFeeScalar + l1BlobBaseFee*l1BlobBaseFeeScalar) / 16e6</code></p>
<p>Where:</p>
<ul>
<li>
<p>the computation is an unlimited precision integer computation, with the result in Wei and having
<code>uint256</code> range.</p>
</li>
<li>
<p>zeroes and ones are the count of zero and non-zero bytes respectively in the <em>full</em> encoded
signed transaction.</p>
</li>
<li>
<p><code>l1BaseFee</code> is the L1 base fee of the latest L1 origin registered in the L2 chain.</p>
</li>
<li>
<p><code>l1BlobBaseFee</code> is the blob gas price, computed as described in <a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-4844.md#gas-accounting">EIP-4844</a> from the
header of the latest registered L1 origin block.</p>
</li>
</ul>
<p>Conceptually what the above function captures is the formula below, where <code>compressedTxSize = (zeroes*4 + ones*16) / 16</code> can be thought of as a rough approximation of how many bytes the
transaction occupies in a compressed batch.</p>
<p><code>(compressedTxSize) * (16*l1BaseFee*lBaseFeeScalar + l1BlobBaseFee*l1BlobBaseFeeScalar) / 1e6</code></p>
<p>The precise cost function used by Ecotone at the top of this section preserves precision under
integer arithmetic by postponing the inner division by 16 until the very end.</p>
<p>The two base fee values and their respective scalars can be accessed in two interchangeable ways:</p>
<ul>
<li>read from the deposited L1 attributes (<code>l1BaseFeeScalar</code>, <code>l1BlobBaseFeeScalar</code>, <code>basefee</code>,
<code>blobBaseFee</code>) of the current L2 block</li>
<li>read from the L1 Block Info contract (<code>0x4200000000000000000000000000000000000015</code>)
<ul>
<li>using the respective solidity getter functions</li>
<li>using direct storage-reads:
<ul>
<li>basefee <code>uint256</code> in slot <code>1</code></li>
<li>blobBaseFee <code>uint256</code> in slot <code>7</code></li>
<li>l1BaseFeeScalar big-endian <code>uint32</code> slot <code>3</code> at offset <code>12</code></li>
<li>l1BlobBaseFeeScalar big-endian <code>uint32</code> in slot <code>3</code> at offset <code>8</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="engine-api-1"><a class="header" href="#engine-api-1">Engine API</a></h2>
<h3 id="engine_forkchoiceupdatedv2"><a class="header" href="#engine_forkchoiceupdatedv2"><code>engine_forkchoiceUpdatedV2</code></a></h3>
<p>This updates which L2 blocks the engine considers to be canonical (<code>forkchoiceState</code> argument),
and optionally initiates block production (<code>payloadAttributes</code> argument).</p>
<p>Within the rollup, the types of forkchoice updates translate as:</p>
<ul>
<li><code>headBlockHash</code>: block hash of the head of the canonical chain. Labeled <code>"unsafe"</code> in user JSON-RPC.
Nodes may apply L2 blocks out of band ahead of time, and then reorg when L1 data conflicts.</li>
<li><code>safeBlockHash</code>: block hash of the canonical chain, derived from L1 data, unlikely to reorg.</li>
<li><code>finalizedBlockHash</code>: irreversible block hash, matches lower boundary of the dispute period.</li>
</ul>
<p>To support rollup functionality, one backwards-compatible change is introduced
to <a href="https://github.com/ethereum/execution-apis/blob/584905270d8ad665718058060267061ecfd79ca5/src/engine/shanghai.md#engine_forkchoiceupdatedv2"><code>engine_forkchoiceUpdatedV2</code></a>: the extended <code>PayloadAttributesV2</code></p>
<h4 id="extended-payloadattributesv2"><a class="header" href="#extended-payloadattributesv2">Extended PayloadAttributesV2</a></h4>
<p><a href="https://github.com/ethereum/execution-apis/blob/584905270d8ad665718058060267061ecfd79ca5/src/engine/shanghai.md#PayloadAttributesV2"><code>PayloadAttributesV2</code></a> is extended to:</p>
<pre><code class="language-js">PayloadAttributesV2: {
    timestamp: QUANTITY
    prevRandao: DATA (32 bytes)
    suggestedFeeRecipient: DATA (20 bytes)
    withdrawals: array of WithdrawalV1
    transactions: array of DATA
    noTxPool: bool
    gasLimit: QUANTITY or null
}
</code></pre>
<p>The type notation used here refers to the <a href="https://ethereum.org/en/developers/docs/apis/json-rpc/#hex-encoding">HEX value encoding</a> used by the <a href="https://github.com/ethereum/execution-apis">Ethereum JSON-RPC API
specification</a>, as this structure will need to be sent over JSON-RPC. <code>array</code> refers
to a JSON array.</p>
<p>Each item of the <code>transactions</code> array is a byte list encoding a transaction: <code>TransactionType || TransactionPayload</code> or <code>LegacyTransaction</code>, as defined in <a href="https://eips.ethereum.org/EIPS/eip-2718">EIP-2718</a>.
This is equivalent to the <code>transactions</code> field in <a href="https://github.com/ethereum/execution-apis/blob/main/src/engine/shanghai.md#executionpayloadv2"><code>ExecutionPayloadV2</code></a></p>
<p>The <code>transactions</code> field is optional:</p>
<ul>
<li>If empty or missing: no changes to engine behavior. The sequencers will (if enabled) build a block
by consuming transactions from the transaction pool.</li>
<li>If present and non-empty: the payload MUST be produced starting with this exact list of transactions.
The <a href="protocol/rollup-node.html">rollup driver</a> determines the transaction list based on deterministic L1 inputs.</li>
</ul>
<p>The <code>noTxPool</code> is optional as well, and extends the <code>transactions</code> meaning:</p>
<ul>
<li>If <code>false</code>, the execution engine is free to pack additional transactions from external sources like the tx pool
into the payload, after any of the <code>transactions</code>. This is the default behavior a L1 node implements.</li>
<li>If <code>true</code>, the execution engine must not change anything about the given list of <code>transactions</code>.</li>
</ul>
<p>If the <code>transactions</code> field is present, the engine must execute the transactions in order and return <code>STATUS_INVALID</code>
if there is an error processing the transactions. It must return <code>STATUS_VALID</code> if all of the transactions could
be executed without error. <strong>Note</strong>: The state transition rules have been modified such that deposits will never fail
so if <code>engine_forkchoiceUpdatedV2</code> returns <code>STATUS_INVALID</code> it is because a batched transaction is invalid.</p>
<p>The <code>gasLimit</code> is optional w.r.t. compatibility with L1, but required when used as rollup.
This field overrides the gas limit used during block-building.
If not specified as rollup, a <code>STATUS_INVALID</code> is returned.</p>
<h3 id="engine_forkchoiceupdatedv3"><a class="header" href="#engine_forkchoiceupdatedv3"><code>engine_forkchoiceUpdatedV3</code></a></h3>
<p>See <a href="protocol/exec-engine.html#engine_forkchoiceupdatedv2"><code>engine_forkchoiceUpdatedV2</code></a> for a description of the forkchoice updated method.
<code>engine_forkchoiceUpdatedV3</code> <strong>must only be called with Ecotone payload.</strong></p>
<p>To support rollup functionality, one backwards-compatible change is introduced
to <a href="https://github.com/ethereum/execution-apis/blob/cea7eeb642052f4c2e03449dc48296def4aafc24/src/engine/cancun.md#engine_forkchoiceupdatedv3"><code>engine_forkchoiceUpdatedV3</code></a>: the extended <code>PayloadAttributesV3</code></p>
<h4 id="extended-payloadattributesv3"><a class="header" href="#extended-payloadattributesv3">Extended PayloadAttributesV3</a></h4>
<p><a href="https://github.com/ethereum/execution-apis/blob/cea7eeb642052f4c2e03449dc48296def4aafc24/src/engine/cancun.md#payloadattributesv3"><code>PayloadAttributesV3</code></a> is extended to:</p>
<pre><code class="language-js">PayloadAttributesV3: {
    timestamp: QUANTITY
    prevRandao: DATA (32 bytes)
    suggestedFeeRecipient: DATA (20 bytes)
    withdrawals: array of WithdrawalV1
    parentBeaconBlockRoot: DATA (32 bytes)
    transactions: array of DATA
    noTxPool: bool
    gasLimit: QUANTITY or null
    eip1559Params: DATA (8 bytes) or null
    minBaseFee: QUANTITY or null
}
</code></pre>
<p>The requirements of this object are the same as extended <a href="protocol/exec-engine.html#extended-payloadattributesv2"><code>PayloadAttributesV2</code></a> with
the addition of <code>parentBeaconBlockRoot</code> which is the parent beacon block root from the L1 origin block of the L2 block.</p>
<p>Starting at Ecotone, the <code>parentBeaconBlockRoot</code> must be set to the L1 origin <code>parentBeaconBlockRoot</code>,
or a zero <code>bytes32</code> if the Dencun functionality with <code>parentBeaconBlockRoot</code> is not active on L1.</p>
<p>Starting with Holocene, the <code>eip1559Params</code> field must encode the EIP1559 parameters. It must be <code>null</code> before.
See <a href="protocol/holocene/exec-engine.html#dynamic-eip-1559-parameters">Dynamic EIP-1559 Parameters</a> for details.</p>
<p>Starting with Jovian, the <code>minBaseFee</code> field is added. It must be <code>null</code> before Jovian.
See <a href="protocol/jovian/exec-engine.html#minimum-base-fee">Jovian Minimum Base Fee</a> for details.</p>
<h3 id="engine_newpayloadv2"><a class="header" href="#engine_newpayloadv2"><code>engine_newPayloadV2</code></a></h3>
<p>No modifications to <a href="https://github.com/ethereum/execution-apis/blob/584905270d8ad665718058060267061ecfd79ca5/src/engine/shanghai.md#engine_newpayloadv2"><code>engine_newPayloadV2</code></a>.
Applies a L2 block to the engine state.</p>
<h3 id="engine_newpayloadv3"><a class="header" href="#engine_newpayloadv3"><code>engine_newPayloadV3</code></a></h3>
<p><a href="https://github.com/ethereum/execution-apis/blob/cea7eeb642052f4c2e03449dc48296def4aafc24/src/engine/cancun.md#engine_newpayloadv3"><code>engine_newPayloadV3</code></a> applies an Ecotone L2 block to the engine state. There are no
modifications to this API.
<code>engine_newPayloadV3</code> <strong>must only be called with Ecotone payload.</strong></p>
<p>The additional parameters should be set as follows:</p>
<ul>
<li><code>expectedBlobVersionedHashes</code> MUST be an empty array.</li>
<li><code>parentBeaconBlockRoot</code> MUST be the parent beacon block root from the L1 origin block of the L2 block.</li>
</ul>
<h3 id="engine_newpayloadv4"><a class="header" href="#engine_newpayloadv4"><code>engine_newPayloadV4</code></a></h3>
<p><a href="https://github.com/ethereum/execution-apis/blob/869b7f062830ba51a7fd8a51dfa4678c6d36b6ec/src/engine/prague.md#engine_newpayloadv4"><code>engine_newPayloadV4</code></a> applies an Isthmus L2 block to the engine state.
The <code>ExecutionPayload</code> parameter will contain an extra field, <code>withdrawalsRoot</code>, after the Isthmus hardfork.</p>
<p><code>engine_newPayloadV4</code> <strong>must only be called with Isthmus payload.</strong></p>
<p>The additional parameters should be set as follows:</p>
<ul>
<li><code>executionRequests</code> MUST be an empty array.</li>
</ul>
<h3 id="engine_getpayloadv2"><a class="header" href="#engine_getpayloadv2"><code>engine_getPayloadV2</code></a></h3>
<p>No modifications to <a href="https://github.com/ethereum/execution-apis/blob/584905270d8ad665718058060267061ecfd79ca5/src/engine/shanghai.md#engine_getpayloadv2"><code>engine_getPayloadV2</code></a>.
Retrieves a payload by ID, prepared by <code>engine_forkchoiceUpdatedV2</code> when called with <code>payloadAttributes</code>.</p>
<h3 id="engine_getpayloadv3"><a class="header" href="#engine_getpayloadv3"><code>engine_getPayloadV3</code></a></h3>
<p><a href="https://github.com/ethereum/execution-apis/blob/a0d03086564ab1838b462befbc083f873dcf0c0f/src/engine/cancun.md#engine_getpayloadv3"><code>engine_getPayloadV3</code></a> retrieves a payload by ID, prepared by <code>engine_forkchoiceUpdatedV3</code>
when called with <code>payloadAttributes</code>.
<code>engine_getPayloadV3</code> <strong>must only be called with Ecotone payload.</strong></p>
<h4 id="extended-response"><a class="header" href="#extended-response">Extended Response</a></h4>
<p>The <a href="https://github.com/ethereum/execution-apis/blob/main/src/engine/cancun.md#response-2">response</a> is extended to:</p>
<pre><code class="language-js">{
    executionPayload: ExecutionPayload
    blockValue: QUANTITY
    blobsBundle: BlobsBundle
    shouldOverrideBuilder: BOOLEAN
    parentBeaconBlockRoot: DATA (32 bytes)
}
</code></pre>
<p>In Ecotone it MUST be set to the parentBeaconBlockRoot from the L1 Origin block of the L2 block.</p>
<h3 id="engine_getpayloadv4"><a class="header" href="#engine_getpayloadv4"><code>engine_getPayloadV4</code></a></h3>
<p><a href="https://github.com/ethereum/execution-apis/blob/869b7f062830ba51a7fd8a51dfa4678c6d36b6ec/src/engine/prague.md#engine_getpayloadv4"><code>engine_getPayloadV4</code></a> retrieves a payload by ID, prepared by <code>engine_forkchoiceUpdatedV3</code>
when called with <code>payloadAttributes</code>.
<code>engine_getPayloadV4</code> <strong>must only be called with Isthmus payload.</strong></p>
<h3 id="engine_signalsuperchainv1"><a class="header" href="#engine_signalsuperchainv1"><code>engine_signalSuperchainV1</code></a></h3>
<p>Optional extension to the Engine API. Signals superchain information to the Engine:
V1 signals which protocol version is recommended and required.</p>
<p>Types:</p>
<pre><code class="language-javascript">SuperchainSignal: {
  recommended: ProtocolVersion;
  required: ProtocolVersion;
}
</code></pre>
<p><code>ProtocolVersion</code>: encoded for RPC as defined in
<a href="protocol/superchain-upgrades.html#protocol-version-format">Protocol Version format specification</a>.</p>
<p>Parameters:</p>
<ul>
<li><code>signal</code>: <code>SuperchainSignal</code>, the signaled superchain information.</li>
</ul>
<p>Returns:</p>
<ul>
<li><code>ProtocolVersion</code>: the latest supported OP-Stack protocol version of the execution engine.</li>
</ul>
<p>The execution engine SHOULD warn the user when the recommended version is newer than
the current version supported by the execution engine.</p>
<p>The execution engine SHOULD take safety precautions if it does not meet the required protocol version.
This may include halting the engine, with consent of the execution engine operator.</p>
<h2 id="networking"><a class="header" href="#networking">Networking</a></h2>
<p>The execution engine can acquire all data through the rollup node, as derived from L1:
<em>P2P networking is strictly optional.</em></p>
<p>However, to not bottleneck on L1 data retrieval speed, the P2P network functionality SHOULD be enabled, serving:</p>
<ul>
<li>Peer discovery (<a href="https://github.com/ethereum/devp2p/blob/master/discv5/discv5.md">Disc v5</a>)</li>
<li><a href="https://github.com/ethereum/devp2p/blob/master/caps/eth.md"><code>eth/66</code></a>:
<ul>
<li>Transaction pool (consumed by sequencer nodes)</li>
<li>State sync (happy-path for fast trustless db replication)</li>
<li>Historical block header and body retrieval</li>
<li><em>New blocks are acquired through the consensus layer instead (rollup node)</em></li>
</ul>
</li>
</ul>
<p>No modifications to L1 network functionality are required, except configuration:</p>
<ul>
<li><a href="https://github.com/ethereum/devp2p/blob/master/caps/eth.md#status-0x00"><code>networkID</code></a>: Distinguishes the L2 network from L1 and testnets.
Equal to the <a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-155.md"><code>chainID</code></a> of the rollup network.</li>
<li>Activate Merge fork: Enables Engine API and disables propagation of blocks,
as block headers cannot be authenticated without consensus layer.</li>
<li>Bootnode list: DiscV5 is a shared network,
<a href="https://github.com/ethereum/devp2p/blob/master/discv5/discv5-rationale.md">bootstrap</a> is faster through connecting with L2 nodes first.</li>
</ul>
<h2 id="sync"><a class="header" href="#sync">Sync</a></h2>
<p>The execution engine can operate sync in different ways:</p>
<ul>
<li>Happy-path: rollup node informs engine of the desired chain head as determined by L1, completes through engine P2P.</li>
<li>Worst-case: rollup node detects stalled engine, completes sync purely from L1 data, no peers required.</li>
</ul>
<p>The happy-path is more suitable to bring new nodes online quickly,
as the engine implementation can sync state faster through methods like <a href="https://github.com/ethereum/devp2p/blob/master/caps/snap.md">snap-sync</a>.</p>
<h3 id="happy-path-sync"><a class="header" href="#happy-path-sync">Happy-path sync</a></h3>
<ol>
<li>The rollup node informs the engine of the L2 chain head, unconditionally (part of regular node operation):
<ul>
<li>Bedrock / Canyon / Delta Payloads
<ul>
<li><a href="https://github.com/ethereum/execution-apis/blob/584905270d8ad665718058060267061ecfd79ca5/src/engine/shanghai.md#engine_newpayloadv2"><code>engine_newPayloadV2</code></a> is called with latest L2 block received from P2P.</li>
<li><a href="https://github.com/ethereum/execution-apis/blob/584905270d8ad665718058060267061ecfd79ca5/src/engine/shanghai.md#engine_forkchoiceupdatedv2"><code>engine_forkchoiceUpdatedV2</code></a> is called with the current
<code>unsafe</code>/<code>safe</code>/<code>finalized</code> L2 block hashes.</li>
</ul>
</li>
<li>Ecotone Payloads
<ul>
<li><a href="https://github.com/ethereum/execution-apis/blob/cea7eeb642052f4c2e03449dc48296def4aafc24/src/engine/cancun.md#engine_newpayloadv3"><code>engine_newPayloadV3</code></a> is called with latest L2 block received from P2P.</li>
<li><a href="https://github.com/ethereum/execution-apis/blob/cea7eeb642052f4c2e03449dc48296def4aafc24/src/engine/cancun.md#engine_forkchoiceupdatedv3"><code>engine_forkchoiceUpdatedV3</code></a> is called with the current
<code>unsafe</code>/<code>safe</code>/<code>finalized</code> L2 block hashes.</li>
</ul>
</li>
</ul>
</li>
<li>The engine requests headers from peers, in reverse till the parent hash matches the local chain</li>
<li>The engine catches up:
a) A form of state sync is activated towards the finalized or head block hash
b) A form of block sync pulls block bodies and processes towards head block hash</li>
</ol>
<p>The exact P2P based sync is out of scope for the L2 specification:
the operation within the engine is the exact same as with L1 (although with an EVM that supports deposits).</p>
<h3 id="worst-case-sync"><a class="header" href="#worst-case-sync">Worst-case sync</a></h3>
<ol>
<li>Engine is out of sync, not peered and/or stalled due other reasons.</li>
<li>The rollup node maintains latest head from engine (poll <code>eth_getBlockByNumber</code> and/or maintain a header subscription)</li>
<li>The rollup node activates sync if the engine is out of sync but not syncing through P2P (<code>eth_syncing</code>)</li>
<li>The rollup node inserts blocks, derived from L1, one by one, potentially adapting to L1 reorg(s),
as outlined in the <a href="protocol/rollup-node.html">rollup node spec</a>.</li>
</ol>
<h2 id="ecotone-disable-blob-transactions"><a class="header" href="#ecotone-disable-blob-transactions">Ecotone: disable Blob-transactions</a></h2>
<p><a href="https://eips.ethereum.org/EIPS/eip-4844">EIP-4844</a> introduces Blob transactions: featuring all the functionality of an <a href="https://eips.ethereum.org/EIPS/eip-1559">EIP-1559</a> transaction,
plus a list of "blobs": "Binary Large Object", i.e. a dedicated data type for serving Data-Availability as base-layer.</p>
<p>With the Ecotone upgrade, all Cancun L1 execution features are enabled, with <a href="https://eips.ethereum.org/EIPS/eip-4844">EIP-4844</a> as exception:
as a L2, the OP-Stack does not serve blobs, and thus disables this new transaction type.</p>
<p>EIP-4844 is disabled as following:</p>
<ul>
<li>Transaction network-layer announcements, announcing blob-type transactions, are ignored.</li>
<li>Transactions of the blob-type, through the RPC or otherwise, are not allowed into the transaction pool.</li>
<li>Block-building code does not select EIP-4844 transactions.</li>
<li>An L2 block state-transition with EIP-4844 transactions is invalid.</li>
</ul>
<p>The <a href="https://eips.ethereum.org/EIPS/eip-7516">BLOBBASEFEE opcode</a> is present but its semantics are
altered because there are no blobs processed by L2. The opcode will always push a value of 1 onto
the stack.</p>
<h2 id="ecotone-beacon-block-root"><a class="header" href="#ecotone-beacon-block-root">Ecotone: Beacon Block Root</a></h2>
<p><a href="https://eips.ethereum.org/EIPS/eip-4788">EIP-4788</a> introduces a "beacon block root" into the execution-layer block-header and EVM.
This block root is an <a href="https://github.com/ethereum/consensus-specs/blob/dev/ssz/simple-serialize.md#merkleization">SSZ hash-tree-root</a> of the consensus-layer contents of the previous consensus block.</p>
<p>With the adoption of <a href="https://eips.ethereum.org/EIPS/eip-4399">EIP-4399</a> in the Bedrock upgrade the OP-Stack already includes the <code>PREVRANDAO</code> of L1.
And thus with <a href="https://eips.ethereum.org/EIPS/eip-4788">EIP-4788</a> the L1 beacon block root is made available.</p>
<p>For the Ecotone upgrade, this entails that:</p>
<ul>
<li>The <code>parent_beacon_block_root</code> of the L1 origin is now embedded in the L2 block header.</li>
<li>The "Beacon roots contract" is deployed at Ecotone upgrade-time, or embedded at genesis if activated at genesis.</li>
<li>The block state-transition process now includes the same special beacon-block-root EVM processing as L1 ethereum.</li>
</ul>
<h2 id="p2p-modifications"><a class="header" href="#p2p-modifications">P2P Modifications</a></h2>
<p>The Ethereum Node Record (ENR) for an Optimism execution node must contain an <code>opel</code> key-value pair where the key is
<code>opel</code> and the value is a <a href="https://eips.ethereum.org/EIPS/eip-2124">EIP-2124</a> fork id.
The EL uses a different key from the CL in order to stop EL and CL nodes from connecting to each other.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="rollup-node-specification"><a class="header" href="#rollup-node-specification">Rollup Node Specification</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/rollup-node.html#overview">Overview</a></li>
<li><a href="protocol/rollup-node.html#driver">Driver</a>
<ul>
<li><a href="protocol/rollup-node.html#derivation">Derivation</a></li>
</ul>
</li>
<li><a href="protocol/rollup-node.html#l2-output-rpc-method">L2 Output RPC method</a>
<ul>
<li><a href="protocol/rollup-node.html#structures">Structures</a>
<ul>
<li><a href="protocol/rollup-node.html#blockid">BlockID</a></li>
<li><a href="protocol/rollup-node.html#l1blockref">L1BlockRef</a></li>
<li><a href="protocol/rollup-node.html#l2blockref">L2BlockRef</a></li>
<li><a href="protocol/rollup-node.html#syncstatus">SyncStatus</a></li>
</ul>
</li>
<li><a href="protocol/rollup-node.html#output-method-api">Output Method API</a></li>
</ul>
</li>
<li><a href="protocol/rollup-node.html#protocol-version-tracking">Protocol Version tracking</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<!-- All glossary references in this file. -->
<h2 id="overview-8"><a class="header" href="#overview-8">Overview</a></h2>
<p>The <a href="protocol/../glossary.html#rollup-node">rollup node</a> is the component responsible for <a href="protocol/../glossary.html#L2-chain-derivation">deriving the L2 chain</a> from L1 blocks
(and their associated <a href="protocol/../glossary.html#receipt">receipts</a>).</p>
<p>The part of the rollup node that derives the L2 chain is called the <a href="protocol/../glossary.html#rollup-driver">rollup driver</a>. This document is
currently only concerned with the specification of the rollup driver.</p>
<h2 id="driver"><a class="header" href="#driver">Driver</a></h2>
<p>The task of the <a href="protocol/../glossary.html#rollup-driver">driver</a> in the <a href="protocol/../glossary.html#rollup-node">rollup node</a>
is to manage the <a href="protocol/../glossary.html#L2-chain-derivation">derivation</a> process:</p>
<ul>
<li>Keep track of L1 head block</li>
<li>Keep track of the L2 chain sync progress</li>
<li>Iterate over the derivation steps as new inputs become available</li>
</ul>
<h3 id="derivation"><a class="header" href="#derivation">Derivation</a></h3>
<p>This process happens in three steps:</p>
<ol>
<li>Select inputs from the L1 chain, on top of the last L2 block:
a list of blocks, with transactions and associated data and receipts.</li>
<li>Read L1 information, deposits, and sequencing batches in order to generate <a href="protocol/../glossary.html#payload-attributes">payload attributes</a>
(essentially <a href="protocol/../glossary.html#block">a block without output properties</a>).</li>
<li>Pass the payload attributes to the <a href="protocol/../glossary.html#execution-engine">execution engine</a>, so that the L2 block (including <a href="protocol/../glossary.html#block">output block
properties</a>) may be computed.</li>
</ol>
<p>While this process is conceptually a pure function from the L1 chain to the L2 chain, it is in practice incremental. The
L2 chain is extended whenever new L1 blocks are added to the L1 chain. Similarly, the L2 chain re-organizes whenever the
L1 chain <a href="protocol/../glossary.html#re-organization">re-organizes</a>.</p>
<p>For a complete specification of the L2 block derivation, refer to the <a href="protocol/derivation.html">L2 block derivation document</a>.</p>
<h2 id="l2-output-rpc-method"><a class="header" href="#l2-output-rpc-method">L2 Output RPC method</a></h2>
<p>The Rollup node has its own RPC method, <code>optimism_outputAtBlock</code> which returns a 32
byte hash corresponding to the <a href="protocol/proposals.html#l2-output-commitment-construction">L2 output root</a>.</p>
<h3 id="structures"><a class="header" href="#structures">Structures</a></h3>
<p>These define the types used by rollup node API methods.
The types defined here are extended from the <a href="https://github.com/ethereum/execution-apis/blob/main/src/engine/paris.md#structures">engine API specs</a>.</p>
<h4 id="blockid"><a class="header" href="#blockid">BlockID</a></h4>
<ul>
<li><code>hash</code>: <code>DATA</code>, 32 Bytes</li>
<li><code>number</code>: <code>QUANTITY</code>, 64 Bits</li>
</ul>
<h4 id="l1blockref"><a class="header" href="#l1blockref">L1BlockRef</a></h4>
<ul>
<li><code>hash</code>: <code>DATA</code>, 32 Bytes</li>
<li><code>number</code>: <code>QUANTITY</code>, 64 Bits</li>
<li><code>parentHash</code>: <code>DATA</code>, 32 Bytes</li>
<li><code>timestamp</code>: <code>QUANTITY</code>, 64 Bits</li>
</ul>
<h4 id="l2blockref"><a class="header" href="#l2blockref">L2BlockRef</a></h4>
<ul>
<li><code>hash</code>: <code>DATA</code>, 32 Bytes</li>
<li><code>number</code>: <code>QUANTITY</code>, 64 Bits</li>
<li><code>parentHash</code>: <code>DATA</code>, 32 Bytes</li>
<li><code>timestamp</code>: <code>QUANTITY</code>, 64 Bits</li>
<li><code>l1origin</code>: <code>BlockID</code></li>
<li><code>sequenceNumber</code>: <code>QUANTITY</code>, 64 Bits - distance to first block of epoch</li>
</ul>
<h4 id="syncstatus"><a class="header" href="#syncstatus">SyncStatus</a></h4>
<p>Represents a snapshot of the rollup driver.</p>
<ul>
<li><code>current_l1</code>: <code>Object</code> - instance of <a href="protocol/rollup-node.html#l1blockref"><code>L1BlockRef</code></a>.</li>
<li><code>current_l1_finalized</code>: <code>Object</code> - instance of <a href="protocol/rollup-node.html#l1blockref"><code>L1BlockRef</code></a>.</li>
<li><code>head_l1</code>: <code>Object</code> - instance of <a href="protocol/rollup-node.html#l1blockref"><code>L1BlockRef</code></a>.</li>
<li><code>safe_l1</code>: <code>Object</code> - instance of <a href="protocol/rollup-node.html#l1blockref"><code>L1BlockRef</code></a>.</li>
<li><code>finalized_l1</code>: <code>Object</code> - instance of <a href="protocol/rollup-node.html#l1blockref"><code>L1BlockRef</code></a>.</li>
<li><code>unsafe_l2</code>: <code>Object</code> - instance of <a href="protocol/rollup-node.html#l2blockref"><code>L2BlockRef</code></a>.</li>
<li><code>safe_l2</code>: <code>Object</code> - instance of <a href="protocol/rollup-node.html#l2blockref"><code>L2BlockRef</code></a>.</li>
<li><code>finalized_l2</code>: <code>Object</code> - instance of <a href="protocol/rollup-node.html#l2blockref"><code>L2BlockRef</code></a>.</li>
<li><code>pending_safe_l2</code>: <code>Object</code> - instance of <a href="protocol/rollup-node.html#l2blockref"><code>L2BlockRef</code></a>.</li>
<li><code>queued_unsafe_l2</code>: <code>Object</code> - instance of <a href="protocol/rollup-node.html#l2blockref"><code>L2BlockRef</code></a>.</li>
</ul>
<h3 id="output-method-api"><a class="header" href="#output-method-api">Output Method API</a></h3>
<p>The input and return types here are as defined by the <a href="https://github.com/ethereum/execution-apis/blob/main/src/engine/paris.md#structures">engine API specs</a>.</p>
<ul>
<li>method: <code>optimism_outputAtBlock</code></li>
<li>params:
<ol>
<li><code>blockNumber</code>: <code>QUANTITY</code>, 64 bits - L2 integer block number.</li>
</ol>
</li>
<li>returns:
<ol>
<li><code>version</code>: <code>DATA</code>, 32 Bytes - the output root version number, beginning with 0.</li>
<li><code>outputRoot</code>: <code>DATA</code>, 32 Bytes - the output root.</li>
<li><code>blockRef</code>: <code>Object</code> - instance of <a href="protocol/rollup-node.html#l2blockref"><code>L2BlockRef</code></a>.</li>
<li><code>withdrawalStorageRoot</code>: 32 bytes - storage root of the <code>L2toL1MessagePasser</code> contract.</li>
<li><code>stateRoot</code>: <code>DATA</code>: 32 bytes - the state root.</li>
<li><code>syncStatus</code>: <code>Object</code> - instance of <a href="protocol/rollup-node.html#syncstatus"><code>SyncStatus</code></a>.</li>
</ol>
</li>
</ul>
<h2 id="protocol-version-tracking"><a class="header" href="#protocol-version-tracking">Protocol Version tracking</a></h2>
<p>The rollup-node should monitor the recommended and required protocol version by monitoring
the Protocol Version contract on L1, as specified in the <a href="protocol/superchain-upgrades.html#superchain-version-signaling">Superchain Version Signaling specifications</a>.</p>
<p>This can be implemented through polling in the <a href="protocol/rollup-node.html#driver">Driver</a> loop.
After polling the Protocol Version, the rollup node SHOULD communicate it with the execution-engine through an
<a href="protocol/exec-engine.html#enginesignalsuperchainv1"><code>engine_signalSuperchainV1</code></a> call.</p>
<p>The rollup node SHOULD warn the user when the recommended version is newer than
the current version supported by the rollup node.</p>
<p>The rollup node SHOULD take safety precautions if it does not meet the required protocol version.
This may include halting the engine, with consent of the rollup node operator.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="rollup-node-p2p-interface"><a class="header" href="#rollup-node-p2p-interface">Rollup-node P2P interface</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/rollup-node-p2p.html#overview">Overview</a></li>
<li><a href="protocol/rollup-node-p2p.html#p2p-configuration">P2P configuration</a>
<ul>
<li><a href="protocol/rollup-node-p2p.html#identification">Identification</a></li>
<li><a href="protocol/rollup-node-p2p.html#discv5">Discv5</a>
<ul>
<li><a href="protocol/rollup-node-p2p.html#consensus-layer-structure">Consensus Layer Structure</a></li>
</ul>
</li>
<li><a href="protocol/rollup-node-p2p.html#libp2p">LibP2P</a>
<ul>
<li><a href="protocol/rollup-node-p2p.html#transport">Transport</a></li>
<li><a href="protocol/rollup-node-p2p.html#dialing">Dialing</a></li>
<li><a href="protocol/rollup-node-p2p.html#nat">NAT</a></li>
<li><a href="protocol/rollup-node-p2p.html#peer-management">Peer management</a></li>
<li><a href="protocol/rollup-node-p2p.html#transport-security">Transport security</a></li>
<li><a href="protocol/rollup-node-p2p.html#protocol-negotiation">Protocol negotiation</a></li>
<li><a href="protocol/rollup-node-p2p.html#identify">Identify</a></li>
<li><a href="protocol/rollup-node-p2p.html#ping">Ping</a></li>
<li><a href="protocol/rollup-node-p2p.html#multiplexing">Multiplexing</a></li>
<li><a href="protocol/rollup-node-p2p.html#gossipsub">GossipSub</a>
<ul>
<li><a href="protocol/rollup-node-p2p.html#content-based-message-identification">Content-based message identification</a></li>
<li><a href="protocol/rollup-node-p2p.html#message-compression-and-limits">Message compression and limits</a></li>
<li><a href="protocol/rollup-node-p2p.html#message-id-computation">Message ID computation</a></li>
</ul>
</li>
<li><a href="protocol/rollup-node-p2p.html#heartbeat-and-parameters">Heartbeat and parameters</a></li>
<li><a href="protocol/rollup-node-p2p.html#topic-configuration">Topic configuration</a></li>
<li><a href="protocol/rollup-node-p2p.html#topic-validation">Topic validation</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="protocol/rollup-node-p2p.html#gossip-topics">Gossip Topics</a>
<ul>
<li><a href="protocol/rollup-node-p2p.html#blocksv1"><code>blocksv1</code></a></li>
<li><a href="protocol/rollup-node-p2p.html#blocksv2"><code>blocksv2</code></a></li>
<li><a href="protocol/rollup-node-p2p.html#blocksv3"><code>blocksv3</code></a></li>
<li><a href="protocol/rollup-node-p2p.html#blocksv4"><code>blocksv4</code></a></li>
<li><a href="protocol/rollup-node-p2p.html#block-encoding">Block encoding</a></li>
<li><a href="protocol/rollup-node-p2p.html#block-signatures">Block signatures</a></li>
<li><a href="protocol/rollup-node-p2p.html#block-validation">Block validation</a>
<ul>
<li><a href="protocol/rollup-node-p2p.html#block-processing">Block processing</a></li>
<li><a href="protocol/rollup-node-p2p.html#branch-selection">Branch selection</a></li>
<li><a href="protocol/rollup-node-p2p.html#block-topic-scoring-parameters">Block topic scoring parameters</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="protocol/rollup-node-p2p.html#req-resp">Req-Resp</a>
<ul>
<li><a href="protocol/rollup-node-p2p.html#payload_by_number"><code>payload_by_number</code></a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-9"><a class="header" href="#overview-9">Overview</a></h2>
<p>The <a href="protocol/rollup-node.html">rollup node</a> has an optional peer-to-peer (P2P) network service to improve the latency between
the view of sequencers and the rest of the network by bypassing the L1 in the happy case,
without relying on a single centralized endpoint.</p>
<p>This also enables faster historical sync to be bootstrapped by providing block headers to sync towards,
and only having to compare the L2 chain inputs to the L1 data as compared to processing everything one block at a time.</p>
<p>The rollup node will <em>always</em> prioritize L1 and reorganize to match the canonical chain.
The L2 data retrieved via the P2P interface is strictly a speculative extension, also known as the "unsafe" chain,
to improve the happy case performance.</p>
<p>This also means that P2P behavior is a soft-rule: nodes keep each other in check with scoring and eventual banning
of malicious peers by identity or IP. Any behavior on the P2P layer does not affect the rollup security, at worst nodes
rely on higher-latency data from L1 to serve.</p>
<p>In summary, the P2P stack looks like:</p>
<ul>
<li>Discovery to find peers: <a href="https://github.com/ethereum/devp2p/blob/master/discv5/discv5.md">Discv5</a></li>
<li>Connections, peering, transport security, multiplexing, gossip: <a href="https://libp2p.io/">LibP2P</a></li>
<li>Application-layer publishing and validation of gossiped messages like L2 blocks.</li>
</ul>
<p>This document only specifies the composition and configuration of these network libraries.
These components have their own standards, implementations in Go/Rust/Java/Nim/JS/more,
and are adopted by several other blockchains, most notably the <a href="https://github.com/ethereum/consensus-specs/blob/dev/specs/phase0/p2p-interface.md">L1 consensus layer (Eth2)</a>.</p>
<h2 id="p2p-configuration"><a class="header" href="#p2p-configuration">P2P configuration</a></h2>
<h3 id="identification"><a class="header" href="#identification">Identification</a></h3>
<p>Nodes have a <strong>separate</strong> network- and consensus-identity.
The network identity is a <code>secp256k1</code> key, used for both discovery and active LibP2P connections.</p>
<p>Common representations of network identity:</p>
<ul>
<li><code>PeerID</code>: a LibP2P specific ID derived from the pubkey (through protobuf encoding, typing and hashing)</li>
<li><code>NodeID</code>: a Discv5 specific ID derived from the pubkey (through hashing, used in the DHT)</li>
<li><code>Multi-address</code>: an unsigned address, containing: IP, TCP port, PeerID</li>
<li><code>ENR</code>: a signed record used for discovery, containing: IP, TCP port, UDP port, signature (pubkey can be derived)
and L2 network identification. Generally encoded in base64.</li>
</ul>
<h3 id="discv5"><a class="header" href="#discv5">Discv5</a></h3>
<h4 id="consensus-layer-structure"><a class="header" href="#consensus-layer-structure">Consensus Layer Structure</a></h4>
<p>The Ethereum Node Record (ENR) for an Optimism rollup node must contain the following values, identified by unique keys:</p>
<ul>
<li>An IPv4 address (<code>ip</code> field) and/or IPv6 address (<code>ip6</code> field).</li>
<li>A TCP port (<code>tcp</code> field) representing the local libp2p listening port.</li>
<li>A UDP port (<code>udp</code> field) representing the local discv5 listening port.</li>
<li>An OpStack (<code>opstack</code> field) L2 network identifier</li>
</ul>
<p>The <code>opstack</code> value is encoded as a single RLP <code>bytes</code> value, the concatenation of:</p>
<ul>
<li>chain ID (<code>unsigned varint</code>)</li>
<li>fork ID (<code>unsigned varint</code>)</li>
</ul>
<p>Note that DiscV5 is a shared DHT (Distributed Hash Table): the L1 consensus and execution nodes,
as well as testnet nodes, and even external IOT nodes, all communicate records in this large common DHT.
This makes it more difficult to censor the discovery of node records.</p>
<p>The discovery process in Optimism is a pipeline of node records:</p>
<ol>
<li>Fill the table with <code>FINDNODES</code> if necessary (Performed by Discv5 library)</li>
<li>Pull additional records with searches to random Node IDs if necessary
(e.g. iterate <a href="https://pkg.go.dev/github.com/ethereum/go-ethereum@v1.10.12/p2p/discover#UDPv5.RandomNodes"><code>RandomNodes()</code></a> in Go implementation)</li>
<li>Pull records from the DiscV5 module when looking for peers</li>
<li>Check if the record contains the <code>opstack</code> entry, verify it matches the chain ID and current or future fork number</li>
<li>If not already connected, and not recently disconnected or put on deny-list, attempt to dial.</li>
</ol>
<h3 id="libp2p"><a class="header" href="#libp2p">LibP2P</a></h3>
<h4 id="transport"><a class="header" href="#transport">Transport</a></h4>
<p>TCP transport. Additional transports are supported by LibP2P, but not required.</p>
<h4 id="dialing"><a class="header" href="#dialing">Dialing</a></h4>
<p>Nodes should be publicly dialable, not rely on relay extensions, and able to dial both IPv4 and IPv6.</p>
<h4 id="nat"><a class="header" href="#nat">NAT</a></h4>
<p>The listening endpoint must be publicly facing, but may be configured behind a NAT.
LibP2P will use PMP / UPNP based techniques to track the external IP of the node.
It is recommended to disable the above if the external IP is static and configured manually.</p>
<h4 id="peer-management"><a class="header" href="#peer-management">Peer management</a></h4>
<p>The default is to maintain a peer count with a tide-system based on active peer count:</p>
<ul>
<li>At "low tide" the node starts to actively search for additional peer connections.</li>
<li>At "high tide" the node starts to prune active connections,
except those that are marked as trusted or have a grace period.</li>
</ul>
<p>Peers will have a grace period for a configurable amount of time after joining.
In an emergency, when memory runs low, the node should start pruning more aggressively.</p>
<p>Peer records can be persisted to disk to quickly reconnect with known peers after restarting the rollup node.</p>
<p>The discovery process feeds the peerstore with peer records to connect to, tagged with a time-to-live (TTL).
The current P2P processes do not require selective topic-specific peer connections,
other than filtering for the basic network participation requirement.</p>
<p>Peers may be banned if their performance score is too low, or if an objectively malicious action was detected.</p>
<p>Banned peers will be persisted to the same data-store as the peerstore records.</p>
<p>TODO: the connection gater does currently not gate by IP address on the dial Accept-callback.</p>
<h4 id="transport-security"><a class="header" href="#transport-security">Transport security</a></h4>
<p><a href="https://github.com/libp2p/specs/tree/master/noise">Libp2p-noise</a>, <code>XX</code> handshake, with the <code>secp256k1</code> P2P identity, as popularized in Eth2.
The TLS option is available as well, but <code>noise</code> should be prioritized in negotiation.</p>
<h4 id="protocol-negotiation"><a class="header" href="#protocol-negotiation">Protocol negotiation</a></h4>
<p><a href="https://github.com/multiformats/multistream-select/">Multistream-select 1.0</a> (<code>/multistream/1.0.0</code>) is an interactive protocol
used to negotiate sub-protocols supported in LibP2P peers. Multistream-select 2.0 may be used in the future.</p>
<h4 id="identify"><a class="header" href="#identify">Identify</a></h4>
<p>LibP2P offers a minimal identification module to share client version and programming language.
This is optional and can be disabled for enhanced privacy.
It also includes the same protocol negotiation information, which can speed up initial connections.</p>
<h4 id="ping"><a class="header" href="#ping">Ping</a></h4>
<p>LibP2P includes a simple ping protocol to track latency between connections.
This should be enabled to help provide insight into the network health.</p>
<h4 id="multiplexing"><a class="header" href="#multiplexing">Multiplexing</a></h4>
<p>For async communication over different channels over the same connection, multiplexing is used.
<a href="https://github.com/libp2p/specs/tree/master/mplex">mplex</a> (<code>/mplex/6.7.0</code>) is required, and <a href="https://github.com/hashicorp/yamux/blob/master/spec.md">yamux</a> (<code>/yamux/1.0.0</code>) is recommended but optional</p>
<h4 id="gossipsub"><a class="header" href="#gossipsub">GossipSub</a></h4>
<p><a href="https://github.com/libp2p/specs/blob/master/pubsub/gossipsub/gossipsub-v1.1.md">GossipSub 1.1</a> (<code>/meshsub/1.1.0</code>, i.e. with peer-scoring extension) is a pubsub protocol for mesh-networks,
deployed on L1 consensus (Eth2) and other protocols such as Filecoin, offering lots of customization options.</p>
<h5 id="content-based-message-identification"><a class="header" href="#content-based-message-identification">Content-based message identification</a></h5>
<p>Messages are deduplicated, and filtered through application-layer signature verification.
Thus origin-stamping is disabled and published messages must only contain application data,
enforced through a <a href="https://github.com/libp2p/specs/blob/master/pubsub/README.md#signature-policy-options"><code>StrictNoSign</code> Signature Policy</a></p>
<p>This provides greater privacy, and allows sequencers (consensus identity) to maintain
multiple network identities for redundancy.</p>
<h5 id="message-compression-and-limits"><a class="header" href="#message-compression-and-limits">Message compression and limits</a></h5>
<p>The application contents are compressed with <a href="https://github.com/google/snappy">snappy</a> single-block-compression
(as opposed to frame-compression), and constrained to 10 MiB.</p>
<h5 id="message-id-computation"><a class="header" href="#message-id-computation">Message ID computation</a></h5>
<p><a href="https://github.com/ethereum/consensus-specs/blob/dev/specs/phase0/p2p-interface.md#topics-and-messages">Same as L1</a>, with recognition of compression:</p>
<ul>
<li>If <code>message.data</code> has a valid snappy decompression, set <code>message-id</code> to the first 20 bytes of the <code>SHA256</code> hash of
the concatenation of <code>MESSAGE_DOMAIN_VALID_SNAPPY</code> with the snappy decompressed message data,
i.e. <code>SHA256(MESSAGE_DOMAIN_VALID_SNAPPY + snappy_decompress(message.data))[:20]</code>.</li>
<li>Otherwise, set <code>message-id</code> to the first 20 bytes of the <code>SHA256</code> hash of
the concatenation of <code>MESSAGE_DOMAIN_INVALID_SNAPPY</code> with the raw message data,
i.e. <code>SHA256(MESSAGE_DOMAIN_INVALID_SNAPPY + message.data)[:20]</code>.</li>
</ul>
<h4 id="heartbeat-and-parameters"><a class="header" href="#heartbeat-and-parameters">Heartbeat and parameters</a></h4>
<p>GossipSub <a href="https://github.com/libp2p/specs/blob/master/pubsub/gossipsub/gossipsub-v1.0.md#parameters">parameters</a>:</p>
<ul>
<li><code>D</code> (topic stable mesh target count): 8</li>
<li><code>D_low</code> (topic stable mesh low watermark): 6</li>
<li><code>D_high</code> (topic stable mesh high watermark): 12</li>
<li><code>D_lazy</code> (gossip target): 6</li>
<li><code>heartbeat_interval</code> (interval of heartbeat, in seconds): 0.5</li>
<li><code>fanout_ttl</code> (ttl for fanout maps for topics we are not subscribed to but have published to, in seconds): 24</li>
<li><code>mcache_len</code> (number of windows to retain full messages in cache for <code>IWANT</code> responses): 12</li>
<li><code>mcache_gossip</code> (number of windows to gossip about): 3</li>
<li><code>seen_ttl</code> (number of heartbeat intervals to retain message IDs): 130 (= 65 seconds)</li>
</ul>
<p>Notable differences from L1 consensus (Eth2):</p>
<ul>
<li><code>seen_ttl</code> does not need to cover a full L1 epoch (6.4 minutes), but rather just a small window covering latest blocks</li>
<li><code>fanout_ttl</code>: adjusted to lower than <code>seen_ttl</code></li>
<li><code>mcache_len</code>: a larger number of heartbeats can be retained since the gossip is much less noisy.</li>
<li><code>heartbeat_interval</code>: faster interval to reduce latency, bandwidth should still be reasonable since
there are far fewer messages to gossip about each interval than on L1 which uses an interval of 0.7 seconds.</li>
</ul>
<h4 id="topic-configuration"><a class="header" href="#topic-configuration">Topic configuration</a></h4>
<p>Topics have string identifiers and are communicated with messages and subscriptions.
<code>/optimism/chain_id/hardfork_version/Name</code></p>
<ul>
<li><code>chain_id</code>: replace with decimal representation of chain ID</li>
<li><code>hardfork_version</code>: replace with decimal representation of hardfork, starting at <code>0</code></li>
<li><code>Name</code>: topic application-name</li>
</ul>
<p>Note that the topic encoding depends on the topic, unlike L1,
since there are less topics, and all are snappy-compressed.</p>
<h4 id="topic-validation"><a class="header" href="#topic-validation">Topic validation</a></h4>
<p>To ensure only valid messages are relayed, and malicious peers get scored based on application behavior,
an <a href="https://github.com/libp2p/specs/blob/master/pubsub/gossipsub/gossipsub-v1.1.md#extended-validators">extended validator</a> checks the message before it is relayed or processed.
The extended validator emits one of the following validation signals:</p>
<ul>
<li><code>ACCEPT</code> valid, relayed to other peers and passed to local topic subscriber</li>
<li><code>IGNORE</code> scored like inactivity, message is dropped and not processed</li>
<li><code>REJECT</code> score penalties, message is dropped</li>
</ul>
<h2 id="gossip-topics"><a class="header" href="#gossip-topics">Gossip Topics</a></h2>
<p>Listed below are the topics for distributing blocks to other nodes faster than proxying through L1 would. These are:</p>
<h3 id="blocksv1"><a class="header" href="#blocksv1"><code>blocksv1</code></a></h3>
<p>Pre-Canyon/Shanghai blocks are broadcast on <code>/optimism/&lt;chainId&gt;/0/blocks</code>.</p>
<h3 id="blocksv2"><a class="header" href="#blocksv2"><code>blocksv2</code></a></h3>
<p>Canyon/Delta blocks are broadcast on <code>/optimism/&lt;chainId&gt;/1/blocks</code>.</p>
<h3 id="blocksv3"><a class="header" href="#blocksv3"><code>blocksv3</code></a></h3>
<p>Ecotone blocks are broadcast on <code>/optimism/&lt;chainId&gt;/2/blocks</code>.</p>
<h3 id="blocksv4"><a class="header" href="#blocksv4"><code>blocksv4</code></a></h3>
<p>Isthmus blocks are broadcast on <code>/optimism/&lt;chainId&gt;/3/blocks</code>.</p>
<h3 id="block-encoding"><a class="header" href="#block-encoding">Block encoding</a></h3>
<p>A block is structured as the concatenation of:</p>
<ul>
<li>V1 and V2 topics
<ul>
<li><code>signature</code>: A <code>secp256k1</code> signature, always 65 bytes, <code>r (uint256), s (uint256), y_parity (uint8)</code></li>
<li><code>payload</code>: A SSZ-encoded <code>ExecutionPayload</code>, always the remaining bytes.</li>
</ul>
</li>
<li>V3 topic
<ul>
<li><code>signature</code>: A <code>secp256k1</code> signature, always 65 bytes, <code>r (uint256), s (uint256), y_parity (uint8)</code></li>
<li><code>parentBeaconBlockRoot</code>: L1 origin parent beacon block root, always 32 bytes</li>
<li><code>payload</code>: A SSZ-encoded <code>ExecutionPayload</code>, always the remaining bytes.</li>
</ul>
</li>
<li>V4 topic
<ul>
<li><code>signature</code>: A <code>secp256k1</code> signature, always 65 bytes, <code>r (uint256), s (uint256), y_parity (uint8)</code></li>
<li><code>parentBeaconBlockRoot</code>: L1 origin parent beacon block root, always 32 bytes</li>
<li><code>payload</code>: A SSZ-encoded <code>ExecutionPayload</code>, always the remaining bytes.
<ul>
<li><em>Note</em> - the <code>ExecutionPayload</code> is modified for the first time in Isthmus. See
<a href="protocol/./isthmus/exec-engine.html#update-to-executionpayload">"Update to <code>ExecutionPayload</code>"</a> in the Isthmus spec.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>All topics use Snappy block-compression (i.e. no snappy frames):
the above needs to be compressed after encoding, and decompressed before decoding.</p>
<h3 id="block-signatures"><a class="header" href="#block-signatures">Block signatures</a></h3>
<p>The <code>signature</code> is a <code>secp256k1</code> signature, and signs over a message:
<code>keccak256(domain ++ chain_id ++ payload_hash)</code>, where:</p>
<ul>
<li><code>domain</code> is 32 bytes, reserved for message types and versioning info. All zero for this signature.</li>
<li><code>chain_id</code> is a big-endian encoded <code>uint256</code>.</li>
<li><code>payload_hash</code> is <code>keccak256(payload)</code>, where <code>payload</code> is:
<ul>
<li>the <code>payload</code> in V1 and V2,</li>
<li><code>parentBeaconBlockRoot ++ payload</code> in V3 + V4 (<em>NOTE</em>: In V4, <code>payload</code> is extended to include the
<code>withdrawalsRoot</code>).</li>
</ul>
</li>
</ul>
<p>The <code>secp256k1</code> signature must have <code>y_parity = 1 or 0</code>, the <code>chain_id</code> is already signed over.</p>
<h3 id="block-validation"><a class="header" href="#block-validation">Block validation</a></h3>
<p>An <a href="https://github.com/libp2p/specs/blob/master/pubsub/gossipsub/gossipsub-v1.1.md#extended-validators">extended-validator</a> checks the incoming messages as follows, in order of operation:</p>
<ul>
<li><code>[REJECT]</code> if the compression is not valid</li>
<li><code>[REJECT]</code> if the block encoding is not valid</li>
<li><code>[REJECT]</code> if the <code>payload.timestamp</code> is older than 60 seconds in the past
(graceful boundary for worst-case propagation and clock skew)</li>
<li><code>[REJECT]</code> if the <code>payload.timestamp</code> is more than 5 seconds into the future</li>
<li><code>[REJECT]</code> if the <code>block_hash</code> in the <code>payload</code> is not valid</li>
<li><code>[REJECT]</code> if the block is on the V1 topic and has withdrawals</li>
<li><code>[REJECT]</code> if the block is on the V1 topic and has a withdrawals list</li>
<li><code>[REJECT]</code> if the block is on a topic &gt;= V2 and does not have an empty withdrawals list</li>
<li><code>[REJECT]</code> if the block is on a topic &lt;= V2 and has a blob gas-used value set</li>
<li><code>[REJECT]</code> if the block is on a topic &lt;= V2 and has an excess blob gas value set</li>
<li><code>[REJECT]</code> if the block is on a topic &lt;= V2 and the parent beacon block root is not nil</li>
<li><code>[REJECT]</code> if the block is on a topic &gt;= V3 and has a blob gas-used value that is not zero</li>
<li><code>[REJECT]</code> if the block is on a topic &gt;= V3 and has an excess blob gas value that is not zero</li>
<li><code>[REJECT]</code> if the block is on a topic &gt;= V3 and the parent beacon block root is nil</li>
<li><code>[REJECT]</code> if the block is on a topic &lt;= V3 and the l2 withdrawals root is not nil</li>
<li><code>[REJECT]</code> if the block is on a topic &gt;= V4 and the l2 withdrawals root is nil</li>
<li><code>[REJECT]</code> if more than 5 different blocks have been seen with the same block height</li>
<li><code>[IGNORE]</code> if the block has already been seen</li>
<li><code>[REJECT]</code> if the signature by the sequencer is not valid</li>
<li>Mark the block as seen for the given block height</li>
</ul>
<p>The block is signed by the corresponding sequencer, to filter malicious messages.
The sequencer model is singular but may change to multiple sequencers in the future.
A default sequencer pubkey is distributed with rollup nodes and should be configurable.</p>
<p>Note that blocks that a block may still be propagated even if the L1 already confirmed a different block.
The local L1 view of the node may be wrong, and the time and signature validation will prevent spam.
Hence, calling into the execution engine with a block lookup every propagation step is not worth the added delay.</p>
<h4 id="block-processing"><a class="header" href="#block-processing">Block processing</a></h4>
<p>A node may apply the block to their local engine ahead of L1 availability, if it ensures that:</p>
<ul>
<li>The application of the block is reversible, in case of a conflict with delayed L1 information</li>
<li>The subsequent forkchoice-update ensures this block is recognized as "unsafe"
(see <a href="protocol/derivation.html#engine-api-usage">fork choice updated</a>)</li>
</ul>
<h4 id="branch-selection"><a class="header" href="#branch-selection">Branch selection</a></h4>
<p>Nodes expect that the sequencer will not equivocate, and therefore the fork choice rule for unsafe blocks
is a "first block wins" model, where the unsafe chain will not change once it has been extended, unless
invalidated by safe data published to the L1.</p>
<p>Nodes who see a different initial unsafe block will not reach consensus until the L1 is published,
which resolves the disagreement. Because the L1 published data depends on the batcher's view of the data,
the safe head will be based on whatever the batcher's source's unsafe head is.</p>
<h4 id="block-topic-scoring-parameters"><a class="header" href="#block-topic-scoring-parameters">Block topic scoring parameters</a></h4>
<p>TODO: GossipSub per-topic scoring to fine-tune incentives for ideal propagation delay and bandwidth usage.</p>
<h2 id="req-resp"><a class="header" href="#req-resp">Req-Resp</a></h2>
<p>The op-node implements a similar request-response encoding for its sync protocols as the L1 ethereum Beacon-Chain.
See <a href="https://github.com/ethereum/consensus-specs/blob/dev/specs/phase0/p2p-interface.md#the-reqresp-domain">L1 P2P-interface req-resp specification</a> and <a href="https://github.com/ethereum/consensus-specs/blob/dev/specs/altair/p2p-interface.md#the-reqresp-domain">Altair P2P update</a>.</p>
<p>However, the protocol is simplified, to avoid several issues seen in L1:</p>
<ul>
<li>Error strings in responses, if there is any alternative response,
should not need to be compressed or have an artificial global length limit.</li>
<li>Payload lengths should be fixed-length: byte-by-byte uvarint reading from the underlying stream is undesired.</li>
<li><code>&lt;context-bytes&gt;</code> are relaxed to encode a <code>uint32</code>, rather than a beacon-chain <code>ForkDigest</code>.</li>
<li>Payload-encoding may change per hardfork, so is not part of the protocol-ID.</li>
<li>Usage of response-chunks is specific to the req-resp method: most basic req-resp does not need chunked responses.</li>
<li>Compression is encouraged to be part of the payload-encoding, specific to the req-resp method, where necessary:
pings and such do not need streaming frame compression etc.</li>
</ul>
<p>And the protocol ID format follows the same scheme as L1,
except the trailing encoding schema part, which is now message-specific:</p>
<pre><code class="language-text">/ProtocolPrefix/MessageName/SchemaVersion/
</code></pre>
<p>The req-resp protocols served by the op-node all have <code>/ProtocolPrefix</code> set to <code>/opstack/req</code>.</p>
<p>Individual methods may include the chain ID as part of the <code>/MessageName</code> segment,
so it's immediately clear which chain the method applies to, if the communication is chain-specific.
Other methods may include chain-information in the request and/or response data,
such as the <code>ForkDigest</code> <code>&lt;context-bytes&gt;</code> in L1 beacon chain req-resp protocols.</p>
<p>Each segment starts with a <code>/</code>, and may contain multiple <code>/</code>, and the final protocol ID is suffixed with a <code>/</code>.</p>
<h3 id="payload_by_number"><a class="header" href="#payload_by_number"><code>payload_by_number</code></a></h3>
<p>This is an optional chain syncing method, to request/serve execution payloads by number.
This serves as a method to fill gaps upon missed gossip, and sync short to medium ranges of unsafe L2 blocks.</p>
<p>Protocol ID: <code>/opstack/req/payload_by_number/&lt;chain-id&gt;/0/</code></p>
<ul>
<li><code>/MessageName</code> is <code>/block_by_number/&lt;chain-id&gt;</code> where <code>&lt;chain-id&gt;</code> is set to the op-node L2 chain ID.</li>
<li><code>/SchemaVersion</code> is <code>/0</code></li>
</ul>
<p>Request format: <code>&lt;num&gt;</code>: a little-endian <code>uint64</code> - the block number to request.</p>
<p>Response format: <code>&lt;response&gt; = &lt;res&gt;&lt;version&gt;&lt;payload&gt;</code></p>
<ul>
<li><code>&lt;res&gt;</code> is a byte code describing the result.
<ul>
<li><code>0</code> on success, <code>&lt;version&gt;&lt;payload&gt;</code> should follow.</li>
<li><code>1</code> if valid request, but unavailable payload.</li>
<li><code>2</code> if invalid request</li>
<li><code>3+</code> if other error</li>
<li>The <code>&gt;= 128</code> range is reserved for future use.</li>
</ul>
</li>
<li><code>&lt;version&gt;</code> is a little-endian <code>uint32</code>, identifying the response type (fork-specific)</li>
<li><code>&lt;payload&gt;</code> is an encoded block, read till stream EOF.</li>
</ul>
<p>The input of <code>&lt;response&gt;</code> should be limited, as well as any generated decompressed output,
to avoid unexpected resource usage or zip-bomb type attacks.
A 10 MB limit is recommended, to ensure all blocks may be synced.
Implementations may opt for a different limit, since this sync method is optional.</p>
<p><code>&lt;version&gt;</code> list:</p>
<ul>
<li><code>0</code>: SSZ-encoded <code>ExecutionPayload</code>, with Snappy framing compression,
matching the <code>ExecutionPayload</code> SSZ definition of the L1 Merge, L2 Bedrock and L2 Regolith, L2 Canyon versions.</li>
<li><code>1</code>: SSZ-encoded <code>ExecutionPayloadEnvelope</code> with Snappy framing compression,
matching the <code>ExecutionPayloadEnvelope</code> SSZ definition of the L2 Ecotone version.</li>
<li><code>2</code>: SSZ-encoded <code>ExecutionPayload</code> with Snappy framing compression,
matching the <code>ExecutionPayload</code> SSZ definition of the L2 Isthmus version.</li>
</ul>
<p>The request is by block-number, enabling parallel fetching of a chain across many peers.</p>
<p>A <code>res = 0</code> response should be verified to:</p>
<ul>
<li>Have a block-number matching the requested block number.</li>
<li>Have a consistent <code>blockhash</code> w.r.t. the other block contents.</li>
<li>Build towards a known canonical block.
<ul>
<li>This can be verified by checking if the parent-hash of a previous trusted canonical block matches
that of the verified hash of the retrieved block.</li>
<li>For unsafe blocks this may be relaxed to verification against the parent-hash of any previously trusted block:
<ul>
<li>The gossip validation process limits the amount of blocks that may be trusted to sync towards.</li>
<li>The unsafe blocks should be queued for processing, the latest received L2 unsafe blocks should always
override any previous chain, until the final L2 chain can be reproduced from L1 data.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>A <code>res &gt; 0</code> response code should not be accepted. The result code is helpful for debugging,
but the client should regard any error like any other unanswered request, as the responding peer cannot be trusted.</p>
<hr />
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="l2-chain-derivation-specification"><a class="header" href="#l2-chain-derivation-specification">L2 Chain Derivation Specification</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/derivation.html#overview">Overview</a>
<ul>
<li><a href="protocol/derivation.html#eager-block-derivation">Eager Block Derivation</a></li>
<li><a href="protocol/derivation.html#protocol-parameters">Protocol Parameters</a></li>
</ul>
</li>
<li><a href="protocol/derivation.html#batch-submission">Batch Submission</a>
<ul>
<li><a href="protocol/derivation.html#sequencing--batch-submission-overview">Sequencing &amp; Batch Submission Overview</a></li>
<li><a href="protocol/derivation.html#batch-submission-wire-format">Batch Submission Wire Format</a>
<ul>
<li><a href="protocol/derivation.html#batcher-transaction-format">Batcher Transaction Format</a></li>
<li><a href="protocol/derivation.html#frame-format">Frame Format</a></li>
<li><a href="protocol/derivation.html#channel-format">Channel Format</a></li>
<li><a href="protocol/derivation.html#batch-format">Batch Format</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="protocol/derivation.html#architecture">Architecture</a>
<ul>
<li><a href="protocol/derivation.html#l2-chain-derivation-pipeline">L2 Chain Derivation Pipeline</a>
<ul>
<li><a href="protocol/derivation.html#l1-traversal">L1 Traversal</a></li>
<li><a href="protocol/derivation.html#l1-retrieval">L1 Retrieval</a></li>
<li><a href="protocol/derivation.html#frame-queue">Frame Queue</a></li>
<li><a href="protocol/derivation.html#channel-bank">Channel Bank</a>
<ul>
<li><a href="protocol/derivation.html#pruning">Pruning</a></li>
<li><a href="protocol/derivation.html#timeouts">Timeouts</a></li>
<li><a href="protocol/derivation.html#reading">Reading</a></li>
<li><a href="protocol/derivation.html#loading-frames">Loading frames</a></li>
</ul>
</li>
<li><a href="protocol/derivation.html#channel-reader-batch-decoding">Channel Reader (Batch Decoding)</a></li>
<li><a href="protocol/derivation.html#batch-queue">Batch Queue</a></li>
<li><a href="protocol/derivation.html#payload-attributes-derivation">Payload Attributes Derivation</a></li>
<li><a href="protocol/derivation.html#engine-queue">Engine Queue</a>
<ul>
<li><a href="protocol/derivation.html#engine-api-usage">Engine API usage</a>
<ul>
<li><a href="protocol/derivation.html#bedrock-canyon-delta-api-usage">Bedrock, Canyon, Delta: API Usage</a></li>
<li><a href="protocol/derivation.html#ecotone-api-usage">Ecotone: API Usage</a></li>
</ul>
</li>
<li><a href="protocol/derivation.html#forkchoice-synchronization">Forkchoice synchronization</a></li>
<li><a href="protocol/derivation.html#l1-consolidation-payload-attributes-matching">L1-consolidation: payload attributes matching</a></li>
<li><a href="protocol/derivation.html#l1-sync-payload-attributes-processing">L1-sync: payload attributes processing</a></li>
<li><a href="protocol/derivation.html#processing-unsafe-payload-attributes">Processing unsafe payload attributes</a></li>
</ul>
</li>
<li><a href="protocol/derivation.html#resetting-the-pipeline">Resetting the Pipeline</a>
<ul>
<li><a href="protocol/derivation.html#finding-the-sync-starting-point">Finding the sync starting point</a></li>
<li><a href="protocol/derivation.html#resetting-derivation-stages">Resetting derivation stages</a></li>
<li><a href="protocol/derivation.html#about-reorgs-post-merge">About reorgs Post-Merge</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="protocol/derivation.html#deriving-payload-attributes">Deriving Payload Attributes</a>
<ul>
<li><a href="protocol/derivation.html#deriving-the-transaction-list">Deriving the Transaction List</a>
<ul>
<li><a href="protocol/derivation.html#network-upgrade-automation-transactions">Network upgrade automation transactions</a></li>
</ul>
</li>
<li><a href="protocol/derivation.html#building-individual-payload-attributes">Building Individual Payload Attributes</a></li>
<li><a href="protocol/derivation.html#on-future-proof-transaction-log-derivation">On Future-Proof Transaction Log Derivation</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<!-- All glossary references in this file. -->
<h1 id="overview-10"><a class="header" href="#overview-10">Overview</a></h1>
<blockquote>
<p><strong>Note</strong> the following assumes a single sequencer and batcher. In the future, the design will be adapted to
accommodate multiple such entities.</p>
</blockquote>
<p><a href="protocol/../glossary.html#l2-chain-derivation">L2 chain derivation</a> â€” deriving L2 <a href="protocol/../glossary.html#block">blocks</a> from L1 data â€” is one of the main responsibilities
of the <a href="protocol/../glossary.html#rollup-node">rollup node</a>, both in validator mode, and in sequencer mode (where derivation acts as a sanity
check on sequencing, and enables detecting L1 chain <a href="protocol/../glossary.html#chain-re-organization">re-organizations</a>).</p>
<p>The L2 chain is derived from the L1 chain. In particular, each L1 block following <a href="protocol/../glossary.html#l2-chain-inception">L2 chain
inception</a> is mapped to a <a href="protocol/../glossary.html#sequencing-epoch">sequencing epoch</a> comprising
at least one L2 block. Each L2 block belongs to exactly one epoch, and we call the corresponding L1
block its <a href="protocol/../glossary.html#l1-origin">L1 origin</a>. The epoch's number equals that of its L1 origin block.</p>
<p>To derive the L2 blocks of epoch number <code>E</code>, we need the following inputs:</p>
<ul>
<li>L1 blocks in the range <code>[E, E + SWS)</code>, called the <a href="protocol/../glossary.html#sequencing-window">sequencing window</a> of the epoch, and <code>SWS</code>
the sequencing window size. (Note that sequencing windows overlap.)</li>
<li><a href="protocol/../glossary.html#batcher-transaction">Batcher transactions</a> from blocks in the sequencing window.
<ul>
<li>These transactions allow us to reconstruct the epoch's <a href="protocol/../glossary.html#sequencer-batch">sequencer batches</a>, each of
which will produce one L2 block. Note that:
<ul>
<li>The L1 origin will never contain any data needed to construct sequencer batches since
each batch <a href="protocol/derivation.html#batch-format">must contain</a> the L1 origin hash.</li>
<li>An epoch may have no sequencer batches.</li>
</ul>
</li>
</ul>
</li>
<li><a href="protocol/../glossary.html#deposits">Deposits</a> made in the L1 origin (in the form of events emitted by the <a href="protocol/../glossary.html#deposit-contract">deposit
contract</a>).</li>
<li>L1 block attributes from the L1 origin (to derive the <a href="protocol/../glossary.html#l1-attributes-deposited-transaction">L1 attributes deposited transaction</a>).</li>
<li>The state of the L2 chain after the last L2 block of the previous epoch, or the <a href="protocol/../glossary.html#l2-genesis-block">L2 genesis state</a>
if <code>E</code> is the first epoch.</li>
</ul>
<p>To derive the whole L2 chain from scratch, we start with the <a href="protocol/../glossary.html#l2-genesis-block">L2 genesis state</a> and
the <a href="protocol/../glossary.html#l2-genesis-block">L2 genesis block</a> as the first L2 block. We then derive L2 blocks from each epoch in order,
starting at the first L1 block following <a href="protocol/../glossary.html#l2-chain-inception">L2 chain inception</a>. Refer to the
<a href="protocol/derivation.html#architecture">Architecture section</a> for more information on how we implement this in practice.
The L2 chain may contain pre-Bedrock history, but the L2 genesis here refers to the Bedrock L2
genesis block.</p>
<p>Each L2 <code>block</code> with origin <code>l1_origin</code> is subject to the following constraints (whose values are
denominated in seconds):</p>
<ul>
<li>
<p><code>block.timestamp = prev_l2_timestamp + l2_block_time</code></p>
<ul>
<li><code>prev_l2_timestamp</code> is the timestamp of the L2 block immediately preceding this one. If there
is no preceding block, then this is the genesis block, and its timestamp is explicitly
specified.</li>
<li><code>l2_block_time</code> is a configurable parameter of the time between L2 blocks (2s on Optimism).</li>
</ul>
</li>
<li>
<p><code>l1_origin.timestamp &lt;= block.timestamp &lt;= max_l2_timestamp</code>, where</p>
<ul>
<li><code>max_l2_timestamp = max(l1_origin.timestamp + max_sequencer_drift, prev_l2_timestamp + l2_block_time)</code>
<ul>
<li><code>max_sequencer_drift</code> is a configurable parameter that bounds how far the sequencer can get ahead of
the L1.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Finally, each epoch must have at least one L2 block.</p>
<p>The first constraint means there must be an L2 block every <code>l2_block_time</code> seconds following L2
chain inception.</p>
<p>The second constraint ensures that an L2 block timestamp never precedes its L1 origin timestamp,
and is never more than <code>max_sequencer_drift</code> ahead of it, except only in the unusual case where it
might prohibit an L2 block from being produced every l2_block_time seconds. (Such cases might arise
for example under a proof-of-work L1 that sees a period of rapid L1 block production.) In either
case, the sequencer enforces <code>len(batch.transactions) == 0</code> while <code>max_sequencer_drift</code> is
exceeded. See <a href="protocol/derivation.html#batch-queue">Batch Queue</a> for more details.</p>
<p>The final requirement that each epoch must have at least one L2 block ensures that all relevant
information from the L1 (e.g. deposits) is represented in the L2, even if it has no sequencer
batches.</p>
<p>Post-merge, Ethereum has a fixed 12s <a href="protocol/../glossary.html#block-time">block time</a>, though some slots can be
skipped. Under a 2s L2 block time, we thus expect each epoch to typically contain <code>12/2 = 6</code> L2
blocks. The sequencer will however produce bigger epochs in order to maintain liveness in case of
either a skipped slot on the L1 or a temporary loss of connection to it. For the lost connection
case, smaller epochs might be produced after the connection was restored to keep L2 timestamps from
drifting further and further ahead.</p>
<h2 id="eager-block-derivation"><a class="header" href="#eager-block-derivation">Eager Block Derivation</a></h2>
<p>Deriving an L2 block requires that we have constructed its sequencer batch and derived all L2
blocks and state updates prior to it. This means we can typically derive the L2 blocks of an epoch
<em>eagerly</em> without waiting on the full sequencing window. The full sequencing window is required
before derivation only in the very worst case where some portion of the sequencer batch for the
first block of the epoch appears in the very last L1 block of the window. Note that this only
applies to <em>block</em> derivation. Sequencer batches can still be derived and tentatively queued
without deriving blocks from them.</p>
<h2 id="protocol-parameters"><a class="header" href="#protocol-parameters">Protocol Parameters</a></h2>
<p>The following table gives an overview of some protocol parameters, and how they are affected by
protocol upgrades.</p>
<div class="table-wrapper"><table><thead><tr><th>Parameter</th><th>Bedrock (default) value</th><th>Latest (default) value</th><th>Changes</th><th>Notes</th></tr></thead><tbody>
<tr><td><code>max_sequencer_drift</code></td><td>600</td><td>1800</td><td><a href="protocol/./fjord/derivation.html#constant-maximum-sequencer-drift">Fjord</a></td><td>Changed from a chain parameter to a constant with Fjord.</td></tr>
<tr><td><code>MAX_RLP_BYTES_PER_CHANNEL</code></td><td>10,000,000</td><td>100,000,000</td><td><a href="protocol/./fjord/derivation.html#increasing-max_rlp_bytes_per_channel-and-max_channel_bank_size">Fjord</a></td><td>Constant increased with Fjord.</td></tr>
<tr><td><code>MAX_CHANNEL_BANK_SIZE</code></td><td>100,000,000</td><td>1,000,000,000</td><td><a href="protocol/./fjord/derivation.html#increasing-max_rlp_bytes_per_channel-and-max_channel_bank_size">Fjord</a></td><td>Constant increased with Fjord.</td></tr>
<tr><td><code>MAX_SPAN_BATCH_ELEMENT_COUNT</code></td><td>10,000,000</td><td>10,000,000</td><td>Effectively introduced in <a href="protocol/./fjord/derivation.html#increasing-max_rlp_bytes_per_channel-and-max_channel_bank_size">Fjord</a></td><td>Number of elements</td></tr>
</tbody></table>
</div>
<hr />
<h1 id="batch-submission"><a class="header" href="#batch-submission">Batch Submission</a></h1>
<h2 id="sequencing--batch-submission-overview"><a class="header" href="#sequencing--batch-submission-overview">Sequencing &amp; Batch Submission Overview</a></h2>
<p>The <a href="protocol/../glossary.html#sequencer">sequencer</a> accepts L2 transactions from users. It is responsible for building blocks out of these. For
each such block, it also creates a corresponding <a href="protocol/../glossary.html#sequencer-batch">sequencer batch</a>. It is also responsible for
submitting each batch to a <a href="protocol/../glossary.html#data-availability-provider">data availability provider</a> (e.g. Ethereum calldata), which it does via
its <a href="protocol/../glossary.html#batcher">batcher</a> component.</p>
<p>The difference between an L2 block and a batch is subtle but important: the block includes an L2 state root, whereas the
batch only commits to transactions at a given L2 timestamp (equivalently: L2 block number). A block also includes a
reference to the previous block (*).</p>
<p>(*) This matters in some edge case where a L1 reorg would occur and a batch would be reposted to the L1 chain but not
the preceding batch, whereas the predecessor of an L2 block cannot possibly change.</p>
<p>This means that even if the sequencer applies a state transition incorrectly, the transactions in the batch will still
be considered part of the canonical L2 chain. Batches are still subject to validity checks (i.e. they have to be encoded
correctly), and so are individual transactions within the batch (e.g. signatures have to be valid). Invalid batches and
invalid individual transactions within an otherwise valid batch are discarded by correct nodes.</p>
<p>If the sequencer applies a state transition incorrectly and posts an <a href="protocol/../glossary.html#l2-output-root">output root</a>, then this output root
will be incorrect. The incorrect output root will be challenged by a <a href="protocol/../glossary.html#fault-proof">fault proof</a>, then replaced
by a correct output root <strong>for the existing sequencer batches.</strong></p>
<p>Refer to the <a href="protocol/batcher.html">Batch Submission specification</a> for more information.</p>
<h2 id="batch-submission-wire-format"><a class="header" href="#batch-submission-wire-format">Batch Submission Wire Format</a></h2>
<p>Batch submission is closely tied to L2 chain derivation because the derivation process must decode the batches that have
been encoded for the purpose of batch submission.</p>
<p>The <a href="protocol/../glossary.html#batcher">batcher</a> submits <a href="protocol/../glossary.html#batcher-transaction">batcher transactions</a> to a <a href="protocol/../glossary.html#data-availability-provider">data availability
provider</a>. These transactions contain one or multiple <a href="protocol/../glossary.html#channel-frame">channel frames</a>, which are
chunks of data belonging to a <a href="protocol/../glossary.html#channel">channel</a>.</p>
<p>A <a href="protocol/../glossary.html#channel">channel</a> is a sequence of <a href="protocol/../glossary.html#sequencer-batch">sequencer batches</a> (for any L2 blocks) compressed
together. The reason to group multiple batches together is simply to obtain a better compression rate, hence reducing
data availability costs.</p>
<p>Channels might be too large to fit in a single <a href="protocol/../glossary.html#batcher-transaction">batcher transaction</a>, hence we need to split it
into chunks known as <a href="protocol/../glossary.html#channel-frame">channel frames</a>. A single batcher transaction can also carry multiple frames
(belonging to the same or to different channels).</p>
<p>This design gives use the maximum flexibility in how we aggregate batches into channels, and split channels over batcher
transactions. It notably allows us to maximize data utilization in a batcher transaction: for instance it allows us to
pack the final (small) frame of one channel with one or more frames from the next channel.</p>
<p>Also note that we use a streaming compression scheme, and we do not need to know how many batches a channel will end up
containing when we start a channel, or even as we send the first frames in the channel.</p>
<p>And by splitting channels across multiple data transactions, the L2 can have larger block data than the
data-availability layer may support.</p>
<p>All of this is illustrated in the following diagram. Explanations below.</p>
<p><img src="protocol/../static/assets/batch-deriv-chain.svg" alt="batch derivation chain diagram" /></p>
<p>The first line represents L1 blocks with their numbers. The boxes under the L1 blocks represent <a href="protocol/../glossary.html#batcher-transaction">batcher
transactions</a> included within the block. The squiggles under the L1 blocks represent
<a href="protocol/../glossary.html#deposits">deposits</a> (more specifically, events emitted by the <a href="protocol/../glossary.html#deposit-contract">deposit contract</a>).</p>
<p>Each colored chunk within the boxes represents a <a href="protocol/../glossary.html#channel-frame">channel frame</a>. So <code>A</code> and <code>B</code> are
<a href="protocol/../glossary.html#channel">channels</a> whereas <code>A0</code>, <code>A1</code>, <code>B0</code>, <code>B1</code>, <code>B2</code> are frames. Notice that:</p>
<ul>
<li>multiple channels are interleaved</li>
<li>frames do not need to be transmitted in order</li>
<li>a single batcher transaction can carry frames from multiple channels</li>
</ul>
<p>In the next line, the rounded boxes represent individual <a href="protocol/../glossary.html#sequencer-batch">sequencer batches</a> that were extracted from
the channels. The four blue/purple/pink were derived from channel <code>A</code> while the other were derived from channel <code>B</code>.
These batches are here represented in the order they were decoded from batches (in this case <code>B</code> is decoded first).</p>
<blockquote>
<p><strong>Note</strong> The caption here says "Channel B was seen first and will be decoded into batches first", but this is not a
requirement. For instance, it would be equally acceptable for an implementation to peek into the channels and decode
the one that contains the oldest batches first.</p>
</blockquote>
<p>The rest of the diagram is conceptually distinct from the first part and illustrates L2 chain derivation after the
channels have been reordered.</p>
<p>The first line shows batcher transactions. Note that in this case, there exists an ordering of the batches that makes
all frames within the channels appear contiguously. This is not true in general. For instance, in the second
transaction, the position of <code>A1</code> and <code>B0</code> could have been inverted for exactly the same result â€” no changes needed in
the rest of the diagram.</p>
<p>The second line shows the reconstructed channels in proper order. The third line shows the batches extracted from the
channel. Because the channels are ordered and the batches within a channel are sequential, this means the batches are
ordered too. The fourth line shows the <a href="protocol/../glossary.html#block">L2 block</a> derived from each batch. Note that we have a 1-1 batch to
block mapping here but, as we'll see later, empty blocks that do not map to batches can be inserted in cases where there
are "gaps" in the batches posted on L1.</p>
<p>The fifth line shows the <a href="protocol/../glossary.html#l1-attributes-deposited-transaction">L1 attributes deposited transaction</a> which, within each L2 block, records
information about the L1 block that matches the L2 block's epoch. The first number denotes the epoch/L1x number, while
the second number (the "sequence number") denotes the position within the epoch.</p>
<p>Finally, the sixth line shows <a href="protocol/../glossary.html#user-deposited-transaction">user-deposited transactions</a> derived from the <a href="protocol/../glossary.html#deposit-contract">deposit
contract</a> event mentioned earlier.</p>
<p>Note the <code>101-0</code> L1 attributes transaction on the bottom right of the diagram. Its presence there is only possible if
frame <code>B2</code> indicates that it is the last frame within the channel and (2) no empty blocks must be inserted.</p>
<p>The diagram does not specify the sequencing window size in use, but from this we can infer that it must be at least 4
blocks, because the last frame of channel <code>A</code> appears in block 102, but belong to epoch 99.</p>
<p>As for the comment on "security types", it explains the classification of blocks as used on L1 and L2.</p>
<ul>
<li><a href="protocol/../glossary.html#unsafe-l2-block">Unsafe L2 blocks</a>:</li>
<li><a href="protocol/../glossary.html#safe-l2-block">Safe L2 blocks</a>:</li>
<li>Finalized L2 blocks: refer to block that have been derived from <a href="protocol/../glossary.html#finalized-l2-head">finalized</a> L1 data.</li>
</ul>
<p>These security levels map to the <code>headBlockHash</code>, <code>safeBlockHash</code> and <code>finalizedBlockHash</code> values transmitted when
interacting with the <a href="protocol/exec-engine.html">execution-engine API</a>.</p>
<h3 id="batcher-transaction-format"><a class="header" href="#batcher-transaction-format">Batcher Transaction Format</a></h3>
<p>Batcher transactions are encoded as <code>version_byte ++ rollup_payload</code> (where <code>++</code> denotes concatenation).</p>
<div class="table-wrapper"><table><thead><tr><th><code>version_byte</code></th><th><code>rollup_payload</code></th></tr></thead><tbody>
<tr><td>0</td><td><code>frame ...</code> (one or more frames, concatenated)</td></tr>
<tr><td>1</td><td><code>da_commitment</code> (experimental, see <a href="protocol/../experimental/alt-da.html#input-commitment-submission">alt-da</a>)</td></tr>
</tbody></table>
</div>
<p>Unknown versions make the batcher transaction invalid (it must be ignored by the rollup node).
All frames in a batcher transaction must be parseable. If any one frame fails to parse, the all frames in the
transaction are rejected.</p>
<p>Batch transactions are authenticated by verifying that the <code>to</code> address of the transaction matches the batch inbox
address, and the <code>from</code> address matches the batch-sender address in the <a href="protocol/../glossary.html#system-configuration">system configuration</a> at the
time of the L1 block that the transaction data is read from.</p>
<h3 id="frame-format"><a class="header" href="#frame-format">Frame Format</a></h3>
<p>A <a href="protocol/../glossary.html#channel-frame">channel frame</a> is encoded as:</p>
<pre><code class="language-text">frame = channel_id ++ frame_number ++ frame_data_length ++ frame_data ++ is_last

channel_id        = bytes16
frame_number      = uint16
frame_data_length = uint32
frame_data        = bytes
is_last           = bool
</code></pre>
<p>Where <code>uint32</code> and <code>uint16</code> are all big-endian unsigned integers. Type names should be interpreted to and
encoded according to <a href="https://docs.soliditylang.org/en/v0.8.16/abi-spec.html">the Solidity ABI</a>.</p>
<p>All data in a frame is fixed-size, except the <code>frame_data</code>. The fixed overhead is <code>16 + 2 + 4 + 1 = 23 bytes</code>.
Fixed-size frame metadata avoids a circular dependency with the target total data length,
to simplify packing of frames with varying content length.</p>
<p>where:</p>
<ul>
<li><code>channel_id</code> is an opaque identifier for the channel. It should not be reused and is suggested to be random; however,
outside of timeout rules, it is not checked for validity</li>
<li><code>frame_number</code> identifies the index of the frame within the channel</li>
<li><code>frame_data_length</code> is the length of <code>frame_data</code> in bytes. It is capped to 1,000,000 bytes.</li>
<li><code>frame_data</code> is a sequence of bytes belonging to the channel, logically after the bytes from the previous frames</li>
<li><code>is_last</code> is a single byte with a value of 1 if the frame is the last in the channel, 0 if there are frames in the
channel. Any other value makes the frame invalid (it must be ignored by the rollup node).</li>
</ul>
<h3 id="channel-format"><a class="header" href="#channel-format">Channel Format</a></h3>
<p>A channel is encoded by applying a streaming compression algorithm to a list of batches:</p>
<pre><code class="language-text">encoded_batches = []
for batch in batches:
    encoded_batches ++ batch.encode()
rlp_batches = rlp_encode(encoded_batches)
</code></pre>
<p>where:</p>
<ul>
<li><code>batches</code> is the input, a sequence of batches each with a byte-encoder
function <code>.encode()</code> as per the next section ("Batch Encoding")</li>
<li><code>encoded_batches</code> is a byte array: the concatenation of the encoded batches</li>
<li><code>rlp_batches</code> is the rlp encoding of the concatenated encoded batches</li>
</ul>
<pre><code class="language-text">channel_encoding = zlib_compress(rlp_batches)
</code></pre>
<p>where zlib_compress is the ZLIB algorithm (as specified in <a href="https://www.rfc-editor.org/rfc/rfc1950.html">RFC-1950</a>) with no dictionary.</p>
<p>The Fjord upgrade introduces an additional <a href="protocol/./fjord/derivation.html#brotli-channel-compression">versioned channel encoding
format</a> to support alternate compression
algorithms.</p>
<p>When decompressing a channel, we limit the amount of decompressed data to <code>MAX_RLP_BYTES_PER_CHANNEL</code> (defined in the
<a href="protocol/derivation.html#protocol-parameters">Protocol Parameters table</a>), in order to avoid "zip-bomb" types of attack (where a small
compressed input decompresses to a humongous amount of data).
If the decompressed data exceeds the limit, things proceeds as though the channel contained
only the first <code>MAX_RLP_BYTES_PER_CHANNEL</code> decompressed bytes. The limit is set on RLP decoding, so all batches that
can be decoded in <code>MAX_RLP_BYTES_PER_CHANNEL</code> will be accepted even if the size of the channel is greater than
<code>MAX_RLP_BYTES_PER_CHANNEL</code>. The exact requirement is that <code>length(input) &lt;= MAX_RLP_BYTES_PER_CHANNEL</code>.</p>
<p>While the above pseudocode implies that all batches are known in advance, it is possible to perform streaming
compression and decompression of RLP-encoded batches. This means it is possible to start including channel frames in a
<a href="protocol/../glossary.html#batcher-transaction">batcher transaction</a> before we know how many batches (and how many frames) the channel will
contain.</p>
<h3 id="batch-format"><a class="header" href="#batch-format">Batch Format</a></h3>
<p>Recall that a batch contains a list of transactions to be included in a specific L2 block.</p>
<p>A batch is encoded as <code>batch_version ++ content</code>, where <code>content</code> depends on the <code>batch_version</code>.
Prior to the Delta upgrade, batches all have batch_version 0 and are encoded as described below.</p>
<div class="table-wrapper"><table><thead><tr><th><code>batch_version</code></th><th><code>content</code></th></tr></thead><tbody>
<tr><td>0</td><td><code>rlp_encode([parent_hash, epoch_number, epoch_hash, timestamp, transaction_list])</code></td></tr>
</tbody></table>
</div>
<p>where:</p>
<ul>
<li><code>batch_version</code> is a single byte, prefixed before the RLP contents, alike to transaction typing.</li>
<li><code>rlp_encode</code> is a function that encodes a batch according to the <a href="https://ethereum.org/en/developers/docs/data-structures-and-encoding/rlp/">RLP format</a>, and <code>[x, y, z]</code> denotes a list
containing items <code>x</code>, <code>y</code> and <code>z</code></li>
<li><code>parent_hash</code> is the block hash of the previous L2 block</li>
<li><code>epoch_number</code> and <code>epoch_hash</code> are the number and hash of the L1 block corresponding to the <a href="protocol/../glossary.html#sequencing-epoch">sequencing
epoch</a> of the L2 block</li>
<li><code>timestamp</code> is the timestamp of the L2 block</li>
<li><code>transaction_list</code> is an RLP-encoded list of <a href="https://eips.ethereum.org/EIPS/eip-2718">EIP-2718</a> encoded transactions.</li>
</ul>
<p>The Delta upgrade introduced an additional batch type, <a href="protocol/./delta/span-batches.html">span batches</a>.</p>
<p>Unknown versions make the batch invalid (it must be ignored by the rollup node), as do malformed contents.</p>
<blockquote>
<p><strong>Note</strong> if the batch version and contents can be RLP decoded correctly but extra content exists beyond the batch,
the additional data may be ignored during parsing. Data <em>between</em> RLP encoded batches may not be ignored
(as they are seen as malformed batches), but if a batch can be fully described by the RLP decoding,
extra content does not invalidate the decoded batch.</p>
</blockquote>
<p>The <code>epoch_number</code> and the <code>timestamp</code> must also respect the constraints listed in the <a href="protocol/derivation.html#batch-queue">Batch Queue</a>
section, otherwise the batch is considered invalid and will be ignored.</p>
<hr />
<h1 id="architecture"><a class="header" href="#architecture">Architecture</a></h1>
<p>The above primarily describes the general encodings used in L2 chain derivation,
primarily how batches are encoded within <a href="protocol/../glossary.html#batcher-transaction">batcher transactions</a>.</p>
<p>This section describes how the L2 chain is produced from the L1 batches using a pipeline architecture.</p>
<p>A verifier may implement this differently, but must be semantically equivalent to not diverge from the L2 chain.</p>
<h2 id="l2-chain-derivation-pipeline"><a class="header" href="#l2-chain-derivation-pipeline">L2 Chain Derivation Pipeline</a></h2>
<p>Our architecture decomposes the derivation process into a pipeline made up of the following stages:</p>
<ol>
<li>L1 Traversal</li>
<li>L1 Retrieval</li>
<li>Frame Queue</li>
<li>Channel Bank</li>
<li>Channel Reader (Batch Decoding)</li>
<li>Batch Queue</li>
<li>Payload Attributes Derivation</li>
<li>Engine Queue</li>
</ol>
<p>The data flows from the start (outer) of the pipeline towards the end (inner).
From the innermost stage the data is pulled from the outermost stage.</p>
<p>However, data is <em>processed</em> in reverse order. Meaning that if there is any data to be processed in the last stage, it
will be processed first. Processing proceeds in "steps" that can be taken at each stage. We try to take as many steps as
possible in the last (most inner) stage before taking any steps in its outer stage, etc.</p>
<p>This ensures that we use the data we already have before pulling more data and minimizes the latency of data traversing
the derivation pipeline.</p>
<p>Each stage can maintain its own inner state as necessary. In particular, each stage maintains a L1 block reference
(number + hash) to the latest L1 block such that all data originating from previous blocks has been fully processed, and
the data from that block is being or has been processed. This allows the innermost stage to account for finalization of
the L1 data-availability used to produce the L2 chain, to reflect in the L2 chain forkchoice when the L2 chain inputs
become irreversible.</p>
<p>Let's briefly describe each stage of the pipeline.</p>
<h3 id="l1-traversal"><a class="header" href="#l1-traversal">L1 Traversal</a></h3>
<p>In the <em>L1 Traversal</em> stage, we simply read the header of the next L1 block. In normal operations, these will be new
L1 blocks as they get created, though we can also read old blocks while syncing, or in case of an L1 <a href="protocol/../glossary.html#chain-re-organization">re-org</a>.</p>
<p>Upon traversal of the L1 block, the <a href="protocol/../glossary.html#system-configuration">system configuration</a> copy used by the L1 retrieval stage is
updated, such that the batch-sender authentication is always accurate to the exact L1 block that is read by the stage.</p>
<h3 id="l1-retrieval"><a class="header" href="#l1-retrieval">L1 Retrieval</a></h3>
<p>In the <em>L1 Retrieval</em> stage, we read the block we get from the outer stage (L1 traversal), and
extract data from its <a href="protocol/../glossary.html#batcher-transaction">batcher transactions</a>. A batcher
transaction is one with the following properties:</p>
<ul>
<li>
<p>The <a href="https://github.com/ethereum/execution-specs/blob/3fe6514f2d9d234e760d11af883a47c1263eff51/src/ethereum/frontier/fork_types.py#L52C31-L52C31"><code>to</code></a> field is equal to the configured batcher inbox address.</p>
</li>
<li>
<p>The transaction type is one of <code>0</code>, <code>1</code>, <code>2</code>, <code>3</code>, or <code>0x7e</code> (L2 <a href="protocol/../glossary.html#deposited-transaction-type">Deposited transaction type</a>, to
support force-inclusion of batcher transactions on nested OP Stack chains).</p>
</li>
<li>
<p>The sender, as recovered from the transaction signature (<code>v</code>, <code>r</code>, and <code>s</code>), is the batcher
address loaded from the system config matching the L1 block of the data.</p>
</li>
</ul>
<p>Each batcher transaction is versioned and contains a series of <a href="protocol/../glossary.html#channel-frame">channel frames</a> to
be read by the Frame Queue, see <a href="protocol/derivation.html#batch-submission-wire-format">Batch Submission Wire Format</a>. Each batcher
transaction in the block is processed in the order they appear in the block by passing its calldata
on to the next phase.</p>
<h3 id="frame-queue"><a class="header" href="#frame-queue">Frame Queue</a></h3>
<p>The Frame Queue buffers one data-transaction at a time,
decoded into <a href="protocol/../glossary.html#channel-frame">channel frames</a>, to be consumed by the next stage.
See <a href="protocol/derivation.html#batcher-transaction-format">Batcher transaction format</a> and <a href="protocol/derivation.html#frame-format">Frame format</a> specifications.</p>
<h3 id="channel-bank"><a class="header" href="#channel-bank">Channel Bank</a></h3>
<p>The <em>Channel Bank</em> stage is responsible for managing buffering from the channel bank that was written to by the L1
retrieval stage. A step in the channel bank stage tries to read data from channels that are "ready".</p>
<p>Channels are currently fully buffered until read or dropped,
streaming channels may be supported in a future version of the ChannelBank.</p>
<p>To bound resource usage, the Channel Bank prunes based on channel size, and times out old channels.</p>
<p>Channels are recorded in FIFO order in a structure called the <em>channel queue</em>. A channel is added to the channel
queue the first time a frame belonging to the channel is seen.</p>
<h4 id="pruning"><a class="header" href="#pruning">Pruning</a></h4>
<p>After successfully inserting a new frame, the ChannelBank is pruned:
channels are dropped in FIFO order, until <code>total_size &lt;= MAX_CHANNEL_BANK_SIZE</code>, where:</p>
<ul>
<li><code>total_size</code> is the sum of the sizes of each channel, which is the sum of all buffered frame data of the channel,
with an additional frame-overhead of <code>200</code> bytes per frame.</li>
<li><code>MAX_CHANNEL_BANK_SIZE</code> is a protocol constant defined in the <a href="protocol/derivation.html#protocol-parameters">Protocol Parameters table</a>.</li>
</ul>
<h4 id="timeouts"><a class="header" href="#timeouts">Timeouts</a></h4>
<p>The L1 origin that the channel was opened in is tracked with the channel as <code>channel.open_l1_block</code>,
and determines the maximum span of L1 blocks that the channel data is retained for, before being pruned.</p>
<p>A channel is timed out if: <code>current_l1_block.number &gt; channel.open_l1_block.number + CHANNEL_TIMEOUT</code>, where:</p>
<ul>
<li><code>current_l1_block</code> is the L1 origin that the stage is currently traversing.</li>
<li><code>CHANNEL_TIMEOUT</code> is a rollup-configurable, expressed in number of L1 blocks.</li>
</ul>
<p>New frames for timed-out channels are dropped instead of buffered.</p>
<h4 id="reading"><a class="header" href="#reading">Reading</a></h4>
<p>Upon reading, while the first opened channel is timed-out, remove it from the channel-bank.</p>
<p>Prior to the Canyon network upgrade, once the first opened channel, if any, is not timed-out and is ready,
then it is read and removed from the channel-bank. After the Canyon network upgrade, the entire channel bank
is scanned in FIFO order (by open time) &amp; the first ready (i.e. not timed-out) channel will be returned.</p>
<p>The canyon behavior will activate when frames from a L1 block whose timestamp is greater than or equal to the
canyon time first enter the channel queue.</p>
<p>A channel is ready if:</p>
<ul>
<li>The channel is closed</li>
<li>The channel has a contiguous sequence of frames until the closing frame</li>
</ul>
<p>If no channel is ready, the next frame is read and ingested into the channel bank.</p>
<h4 id="loading-frames"><a class="header" href="#loading-frames">Loading frames</a></h4>
<p>When a channel ID referenced by a frame is not already present in the Channel Bank,
a new channel is opened, tagged with the current L1 block, and appended to the channel-queue.</p>
<p>Frame insertion conditions:</p>
<ul>
<li>New frames matching timed-out channels that have not yet been pruned from the channel-bank are dropped.</li>
<li>Duplicate frames (by frame number) for frames that have not been pruned from the channel-bank are dropped.</li>
<li>Duplicate closes (new frame <code>is_last == 1</code>, but the channel has already seen a closing frame and has not yet been
pruned from the channel-bank) are dropped.</li>
</ul>
<p>If a frame is closing (<code>is_last == 1</code>) any existing higher-numbered frames are removed from the channel.</p>
<p>Note that while this allows channel IDs to be reused once they have been pruned from the channel-bank, it is recommended
that batcher implementations use unique channel IDs.</p>
<h3 id="channel-reader-batch-decoding"><a class="header" href="#channel-reader-batch-decoding">Channel Reader (Batch Decoding)</a></h3>
<p>In this stage, we decompress the channel we pull from the last stage, and then parse
<a href="protocol/../glossary.html#sequencer-batch">batches</a> from the decompressed byte stream.</p>
<p>See <a href="protocol/derivation.html#channel-format">Channel Format</a> and <a href="protocol/derivation.html#batch-format">Batch Format</a> for decompression and
decoding specification.</p>
<h3 id="batch-queue"><a class="header" href="#batch-queue">Batch Queue</a></h3>
<p>During the <em>Batch Buffering</em> stage, we reorder batches by their timestamps. If batches are missing for some <a href="protocol/../glossary.html#time-slot">time
slots</a> and a valid batch with a higher timestamp exists, this stage also generates empty batches to fill
the gaps.</p>
<p>Batches are pushed to the next stage whenever there is one sequential batch directly following the timestamp
of the current <a href="protocol/../glossary.html#safe-l2-head">safe L2 head</a> (the last block that can be derived from the canonical L1 chain).
The parent hash of the batch must also match the hash of the current safe L2 head.</p>
<p>Note that the presence of any gaps in the batches derived from L1 means that this stage will need to buffer for a whole
<a href="protocol/../glossary.html#sequencing-window">sequencing window</a> before it can generate empty batches (because the missing batch(es) could have
data in the last L1 block of the window in the worst case).</p>
<p>A batch can have 4 different forms of validity:</p>
<ul>
<li><code>drop</code>: the batch is invalid, and will always be in the future, unless we reorg. It can be removed from the buffer.</li>
<li><code>accept</code>: the batch is valid and should be processed.</li>
<li><code>undecided</code>: we are lacking L1 information until we can proceed batch filtering.</li>
<li><code>future</code>: the batch may be valid, but cannot be processed yet and should be checked again later.</li>
</ul>
<p>The batches are processed in order of the inclusion on L1: if multiple batches can be <code>accept</code>-ed the first is applied.
An implementation can defer <code>future</code> batches a later derivation step to reduce validation work.</p>
<p>The batches validity is derived as follows:</p>
<p>Definitions:</p>
<ul>
<li><code>batch</code> as defined in the <a href="protocol/derivation.html#batch-format">Batch format section</a>.</li>
<li><code>epoch = safe_l2_head.l1_origin</code> a <a href="protocol/../glossary.html#l1-origin">L1 origin</a> coupled to the batch, with properties:
<code>number</code> (L1 block number), <code>hash</code> (L1 block hash), and <code>timestamp</code> (L1 block timestamp).</li>
<li><code>inclusion_block_number</code> is the L1 block number when <code>batch</code> was first <em>fully</em> derived,
i.e. decoded and output by the previous stage.</li>
<li><code>next_timestamp = safe_l2_head.timestamp + block_time</code> is the expected L2 timestamp the next batch should have,
see <a href="protocol/../glossary.html#block-time">block time information</a>.</li>
<li><code>next_epoch</code> may not be known yet, but would be the L1 block after <code>epoch</code> if available.</li>
<li><code>batch_origin</code> is either <code>epoch</code> or <code>next_epoch</code>, depending on validation.</li>
</ul>
<p>Note that processing of a batch can be deferred until <code>batch.timestamp &lt;= next_timestamp</code>,
since <code>future</code> batches will have to be retained anyway.</p>
<p>Rules, in validation order:</p>
<ul>
<li><code>batch.timestamp &gt; next_timestamp</code> -&gt; <code>future</code>: i.e. the batch must be ready to process.</li>
<li><code>batch.timestamp &lt; next_timestamp</code> -&gt; <code>drop</code>: i.e. the batch must not be too old.</li>
<li><code>batch.parent_hash != safe_l2_head.hash</code> -&gt; <code>drop</code>: i.e. the parent hash must be equal to the L2 safe head block hash.</li>
<li><code>batch.epoch_num + sequence_window_size &lt; inclusion_block_number</code> -&gt; <code>drop</code>: i.e. the batch must be included timely.</li>
<li><code>batch.epoch_num &lt; epoch.number</code> -&gt; <code>drop</code>: i.e. the batch origin is not older than that of the L2 safe head.</li>
<li><code>batch.epoch_num == epoch.number</code>: define <code>batch_origin</code> as <code>epoch</code>.</li>
<li><code>batch.epoch_num == epoch.number+1</code>:
<ul>
<li>If <code>next_epoch</code> is not known -&gt; <code>undecided</code>:
i.e. a batch that changes the L1 origin cannot be processed until we have the L1 origin data.</li>
<li>If known, then define <code>batch_origin</code> as <code>next_epoch</code></li>
</ul>
</li>
<li><code>batch.epoch_num &gt; epoch.number+1</code> -&gt; <code>drop</code>: i.e. the L1 origin cannot change by more than one L1 block per L2 block.</li>
<li><code>batch.epoch_hash != batch_origin.hash</code> -&gt; <code>drop</code>: i.e. a batch must reference a canonical L1 origin,
to prevent batches from being replayed onto unexpected L1 chains.</li>
<li><code>batch.timestamp &lt; batch_origin.time</code> -&gt; <code>drop</code>: enforce the min L2 timestamp rule.</li>
<li><code>batch.timestamp &gt; batch_origin.time + max_sequencer_drift</code>: enforce the L2 timestamp drift rule,
but with exceptions to preserve above min L2 timestamp invariant:
<ul>
<li><code>len(batch.transactions) == 0</code>:
<ul>
<li><code>epoch.number == batch.epoch_num</code>:
this implies the batch does not already advance the L1 origin, and must thus be checked against <code>next_epoch</code>.
<ul>
<li>If <code>next_epoch</code> is not known -&gt; <code>undecided</code>:
without the next L1 origin we cannot yet determine if time invariant could have been kept.</li>
<li>If <code>batch.timestamp &gt;= next_epoch.time</code> -&gt; <code>drop</code>:
the batch could have adopted the next L1 origin without breaking the <code>L2 time &gt;= L1 time</code> invariant.</li>
</ul>
</li>
</ul>
</li>
<li><code>len(batch.transactions) &gt; 0</code>: -&gt; <code>drop</code>:
when exceeding the sequencer time drift, never allow the sequencer to include transactions.</li>
</ul>
</li>
<li><code>batch.transactions</code>: <code>drop</code> if the <code>batch.transactions</code> list contains a transaction
that is invalid or derived by other means exclusively:
<ul>
<li>any transaction that is empty (zero length byte string)</li>
<li>any <a href="protocol/../glossary.html#deposited-transaction-type">deposited transactions</a> (identified by the transaction type prefix byte)</li>
<li>any transaction of a future type &gt; 2 (note that
<a href="protocol/isthmus/derivation.html#activation">Isthmus adds support</a>
for <code>SetCode</code> transactions of type 4)</li>
</ul>
</li>
</ul>
<p>If no batch can be <code>accept</code>-ed, and the stage has completed buffering of all batches that can fully be read from the L1
block at height <code>epoch.number + sequence_window_size</code>, and the <code>next_epoch</code> is available,
then an empty batch can be derived with the following properties:</p>
<ul>
<li><code>parent_hash = safe_l2_head.hash</code></li>
<li><code>timestamp = next_timestamp</code></li>
<li><code>transactions</code> is empty, i.e. no sequencer transactions. Deposited transactions may be added in the next stage.</li>
<li>If <code>next_timestamp &lt; next_epoch.time</code>: the current L1 origin is repeated, to preserve the L2 time invariant.
<ul>
<li><code>epoch_num = epoch.number</code></li>
<li><code>epoch_hash = epoch.hash</code></li>
</ul>
</li>
<li>If the batch is the first batch of the epoch, that epoch is used instead of advancing the epoch to ensure that
there is at least one L2 block per epoch.
<ul>
<li><code>epoch_num = epoch.number</code></li>
<li><code>epoch_hash = epoch.hash</code></li>
</ul>
</li>
<li>Otherwise,
<ul>
<li><code>epoch_num = next_epoch.number</code></li>
<li><code>epoch_hash = next_epoch.hash</code></li>
</ul>
</li>
</ul>
<h3 id="payload-attributes-derivation"><a class="header" href="#payload-attributes-derivation">Payload Attributes Derivation</a></h3>
<p>In the <em>Payload Attributes Derivation</em> stage, we convert the batches we get from the previous stage into instances of
the <a href="protocol/../glossary.html#payload-attributes"><code>PayloadAttributes</code></a> structure. Such a structure encodes the transactions that need to figure into
a block, as well as other block inputs (timestamp, fee recipient, etc). Payload attributes derivation is detailed in the
section <a href="protocol/derivation.html#deriving-payload-attributes">Deriving Payload Attributes section</a> below.</p>
<p>This stage maintains its own copy of the <a href="protocol/../glossary.html#system-configuration">system configuration</a>, independent of the L1 retrieval stage.
The system configuration is updated with L1 log events whenever the L1 epoch referenced by the batch input changes.</p>
<h3 id="engine-queue"><a class="header" href="#engine-queue">Engine Queue</a></h3>
<p>In the <em>Engine Queue</em> stage, the previously derived <code>PayloadAttributes</code> structures are buffered and sent to the
<a href="protocol/../glossary.html#execution-engine">execution engine</a> to be executed and converted into a proper L2 block.</p>
<p>The stage maintains references to three L2 blocks:</p>
<ul>
<li>The <a href="protocol/../glossary.html#finalized-l2-head">finalized L2 head</a>: everything up to and including this block can be fully derived from the
<a href="https://ethereum.org/en/developers/docs/consensus-mechanisms/pos/#finality">finalized</a> (i.e. canonical and forever irreversible) part of the L1 chain.</li>
<li>The <a href="protocol/../glossary.html#safe-l2-head">safe L2 head</a>: everything up to and including this block can be fully derived from the
currently canonical L1 chain.</li>
<li>The <a href="protocol/../glossary.html#unsafe-l2-head">unsafe L2 head</a>: blocks between the safe and unsafe heads are <a href="protocol/../glossary.html#unsafe-l2-block">unsafe
blocks</a> that have not been derived from L1. These blocks either come from sequencing (in sequencer
mode) or from <a href="protocol/../glossary.html#unsafe-sync">unsafe sync</a> to the sequencer (in validator mode).
This is also known as the "latest" head.</li>
</ul>
<p>Additionally, it buffers a short history of references to recently processed safe L2 blocks, along with references
from which L1 blocks each was derived.
This history does not have to be complete, but enables later L1 finality signals to be translated into L2 finality.</p>
<h4 id="engine-api-usage"><a class="header" href="#engine-api-usage">Engine API usage</a></h4>
<p>To interact with the engine, the <a href="protocol/exec-engine.html">execution engine API</a> is used, with the following JSON-RPC methods:</p>
<h5 id="bedrock-canyon-delta-api-usage"><a class="header" href="#bedrock-canyon-delta-api-usage">Bedrock, Canyon, Delta: API Usage</a></h5>
<ul>
<li><a href="protocol/exec-engine.html#engine_forkchoiceupdatedv2"><code>engine_forkchoiceUpdatedV2</code></a> â€” updates the forkchoice (i.e. the chain head) to <code>headBlockHash</code> if different, and
instructs the engine to start building an execution payload if the payload attributes parameter is not <code>null</code>.</li>
<li><a href="protocol/exec-engine.html#engine_getpayloadv2"><code>engine_getPayloadV2</code></a> â€” retrieves a previously requested execution payload build.</li>
<li><a href="protocol/exec-engine.html#engine_newpayloadv2"><code>engine_newPayloadV2</code></a> â€” executes an execution payload to create a block.</li>
</ul>
<h5 id="ecotone-api-usage"><a class="header" href="#ecotone-api-usage">Ecotone: API Usage</a></h5>
<ul>
<li><a href="protocol/exec-engine.html#engine_forkchoiceupdatedv3"><code>engine_forkchoiceUpdatedV3</code></a> â€” updates the forkchoice (i.e. the chain head) to <code>headBlockHash</code> if different, and
instructs the engine to start building an execution payload if the payload attributes parameter is not <code>null</code>.</li>
<li><a href="protocol/exec-engine.html#engine_getpayloadv3"><code>engine_getPayloadV3</code></a> â€” retrieves a previously requested execution payload build.</li>
<li><code>engine_newPayload</code>
<ul>
<li><a href="protocol/exec-engine.html#engine_newpayloadv2"><code>engine_newPayloadV2</code></a> â€” executes a Bedrock/Canyon/Delta execution payload to create a block.</li>
<li><a href="protocol/exec-engine.html#engine_newpayloadv3"><code>engine_newPayloadV3</code></a> â€” executes an Ecotone execution payload to create a block.</li>
<li><a href="protocol/exec-engine.html#engine_newpayloadv4"><code>engine_newPayloadV4</code></a> - executes an Isthmus execution payload to create a block.</li>
</ul>
</li>
</ul>
<p>The current version of <code>op-node</code> uses the <code>v4</code> Engine API RPC methods as well as <code>engine_newPayloadV3</code> and
<code>engine_newPayloadV2</code>, due to <code>engine_newPayloadV4</code> only supporting Isthmus execution payloads. Both
<code>engine_forkchoiceUpdatedV4</code> and <code>engine_getPayloadV4</code> are backwards compatible with Ecotone, Bedrock,
Canyon &amp; Delta payloads.</p>
<p>Prior versions of <code>op-node</code> used <code>v3</code>, <code>v2</code> and <code>v1</code> methods.</p>
<p>The execution payload is an object of type <a href="https://github.com/ethereum/execution-apis/blob/main/src/engine/cancun.md"><code>ExecutionPayloadV3</code></a>.</p>
<p>The <code>ExecutionPayload</code> has the following requirements:</p>
<ul>
<li>Bedrock
<ul>
<li>The withdrawals field MUST be nil</li>
<li>The blob gas used field MUST be nil</li>
<li>The blob gas limit field MUST be nil</li>
</ul>
</li>
<li>Canyon, Delta
<ul>
<li>The withdrawals field MUST be non-nil</li>
<li>The withdrawals field MUST be an empty list</li>
<li>The blob gas used field MUST be nil</li>
<li>The blob gas limit field MUST be nil</li>
</ul>
</li>
<li>Ecotone
<ul>
<li>The withdrawals field MUST be non-nil</li>
<li>The withdrawals field MUST be an empty list</li>
<li>The blob gas used field MUST be 0</li>
<li>The blob gas limit field MUST be 0</li>
</ul>
</li>
</ul>
<h4 id="forkchoice-synchronization"><a class="header" href="#forkchoice-synchronization">Forkchoice synchronization</a></h4>
<p>If there are any forkchoice updates to be applied, before additional inputs are derived or processed, then these are
applied to the engine first.</p>
<p>This synchronization may happen when:</p>
<ul>
<li>A L1 finality signal finalizes one or more L2 blocks: updating the "finalized" L2 block.</li>
<li>A successful consolidation of unsafe L2 blocks: updating the "safe" L2 block.</li>
<li>The first thing after a derivation pipeline reset, to ensure a consistent execution engine forkchoice state.</li>
</ul>
<p>The new forkchoice state is applied by calling <a href="protocol/derivation.html#engine-api-usage">fork choice updated</a> on the engine API.
On forkchoice-state validity errors the derivation pipeline must be reset to recover to consistent state.</p>
<h4 id="l1-consolidation-payload-attributes-matching"><a class="header" href="#l1-consolidation-payload-attributes-matching">L1-consolidation: payload attributes matching</a></h4>
<p>If the unsafe head is ahead of the safe head, then <a href="protocol/../glossary.html#unsafe-block-consolidation">consolidation</a> is attempted, verifying that
existing unsafe L2 chain matches the derived L2 inputs as derived from the canonical L1 data.</p>
<p>During consolidation, we consider the oldest unsafe L2 block, i.e. the unsafe L2 block directly after the safe head. If
the payload attributes match this oldest unsafe L2 block, then that block can be considered "safe" and becomes the new
safe head.</p>
<p>The following fields of the derived L2 payload attributes are checked for equality with the L2 block:</p>
<ul>
<li>Bedrock, Canyon, Delta, Ecotone Blocks
<ul>
<li><code>parent_hash</code></li>
<li><code>timestamp</code></li>
<li><code>randao</code></li>
<li><code>fee_recipient</code></li>
<li><code>transactions_list</code> (first length, then equality of each of the encoded transactions, including deposits)</li>
<li><code>gas_limit</code></li>
</ul>
</li>
<li>Canyon, Delta, Ecotone Blocks
<ul>
<li><code>withdrawals</code> (first presence, then length, then equality of each of the encoded withdrawals)</li>
</ul>
</li>
<li>Ecotone Blocks
<ul>
<li><code>parent_beacon_block_root</code></li>
</ul>
</li>
</ul>
<p>If consolidation succeeds, the forkchoice change will synchronize as described in the section above.</p>
<p>If consolidation fails, the L2 payload attributes will be processed immediately as described in the section below.
The payload attributes are chosen in favor of the previous unsafe L2 block, creating an L2 chain reorg on top of the
current safe block. Immediately processing the new alternative attributes enables execution engines like go-ethereum to
enact the change, as linear rewinds of the tip of the chain may not be supported.</p>
<h4 id="l1-sync-payload-attributes-processing"><a class="header" href="#l1-sync-payload-attributes-processing">L1-sync: payload attributes processing</a></h4>
<p>If the safe and unsafe L2 heads are identical (whether because of failed consolidation or not), we send the L2 payload
attributes to the execution engine to be constructed into a proper L2 block.
This L2 block will then become both the new L2 safe and unsafe head.</p>
<p>If a payload attributes created from a batch cannot be inserted into the chain because of a validation error (i.e. there
was an invalid transaction or state transition in the block) the batch should be dropped &amp; the safe head should not be
advanced. The engine queue will attempt to use the next batch for that timestamp from the batch queue. If no valid batch
is found, the rollup node will create a deposit only batch which should always pass validation because deposits are
always valid.</p>
<p>Interaction with the execution engine via the execution engine API is detailed in the <a href="protocol/exec-engine.html#engine-api">Communication with the Execution
Engine</a> section.</p>
<p>The payload attributes are then processed with a sequence of:</p>
<ul>
<li><a href="protocol/derivation.html#engine-api-usage">Engine: Fork choice updated</a> with current forkchoice state of the stage, and the attributes to
start block building.
<ul>
<li>Non-deterministic sources, like the tx-pool, must be disabled to reconstruct the expected block.</li>
</ul>
</li>
<li><a href="protocol/derivation.html#engine-api-usage">Engine: Get Payload</a> to retrieve the payload, by the payload-ID in the result of the previous
step.</li>
<li><a href="protocol/derivation.html#engine-api-usage">Engine: New Payload</a> to import the new payload into the execution engine.</li>
<li><a href="protocol/derivation.html#engine-api-usage">Engine: Fork Choice Updated</a> to make the new payload canonical,
now with a change of both <code>safe</code> and <code>unsafe</code> fields to refer to the payload, and no payload attributes.</li>
</ul>
<p>Engine API Error handling:</p>
<ul>
<li>On RPC-type errors the payload attributes processing should be re-attempted in a future step.</li>
<li>On payload processing errors the attributes must be dropped, and the forkchoice state must be left unchanged.
<ul>
<li>Eventually the derivation pipeline will produce alternative payload attributes, with or without batches.</li>
<li>If the payload attributes only contained deposits, then it is a critical derivation error if these are invalid.</li>
</ul>
</li>
<li>On forkchoice-state validity errors the derivation pipeline must be reset to recover to consistent state.</li>
</ul>
<h4 id="processing-unsafe-payload-attributes"><a class="header" href="#processing-unsafe-payload-attributes">Processing unsafe payload attributes</a></h4>
<p>If no forkchoice updates or L1 data remain to be processed, and if the next possible L2 block is already available
through an unsafe source such as the sequencer publishing it via the p2p network, then it is optimistically processed as
an "unsafe" block. This reduces later derivation work to just consolidation with L1 in the happy case, and enables the
user to see the head of the L2 chain faster than the L1 may confirm the L2 batches.</p>
<p>To process unsafe payloads, the payload must:</p>
<ul>
<li>Have a block number higher than the current safe L2 head.
<ul>
<li>The safe L2 head may only be reorged out due to L1 reorgs.</li>
</ul>
</li>
<li>Have a parent blockhash that matches the current unsafe L2 head.
<ul>
<li>This prevents the execution engine individually syncing a larger gap in the unsafe L2 chain.</li>
<li>This prevents unsafe L2 blocks from reorging other previously validated L2 blocks.</li>
<li>This check may change in the future versions to adopt e.g. the L1 snap-sync protocol.</li>
</ul>
</li>
</ul>
<p>The payload is then processed with a sequence of:</p>
<ul>
<li>Bedrock/Canyon/Delta Payloads
<ul>
<li><code>engine_newPayloadV2</code>: process the payload. It does not become canonical yet.</li>
<li><code>engine_forkchoiceUpdatedV2</code>: make the payload the canonical unsafe L2 head, and keep the safe/finalized L2 heads.</li>
</ul>
</li>
<li>Ecotone Payloads
<ul>
<li><code>engine_newPayloadV3</code>: process the payload. It does not become canonical yet.</li>
<li><code>engine_forkchoiceUpdatedV3</code>: make the payload the canonical unsafe L2 head, and keep the safe/finalized L2 heads.</li>
</ul>
</li>
<li>Isthmus Payloads
<ul>
<li><code>engine_newPayloadV4</code>: process the payload. It does not become canonical yet.</li>
</ul>
</li>
</ul>
<p>Engine API Error handling:</p>
<ul>
<li>On RPC-type errors the payload processing should be re-attempted in a future step.</li>
<li>On payload processing errors the payload must be dropped, and not be marked as canonical.</li>
<li>On forkchoice-state validity errors the derivation pipeline must be reset to recover to consistent state.</li>
</ul>
<h3 id="resetting-the-pipeline"><a class="header" href="#resetting-the-pipeline">Resetting the Pipeline</a></h3>
<p>It is possible to reset the pipeline, for instance if we detect an L1 <a href="protocol/../glossary.html#chain-re-organization">reorg (reorganization)</a>.
<strong>This enables the rollup node to handle L1 chain reorg events.</strong></p>
<p>Resetting will recover the pipeline into a state that produces the same outputs as a full L2 derivation process,
but starting from an existing L2 chain that is traversed back just enough to reconcile with the current L1 chain.</p>
<p>Note that this algorithm covers several important use-cases:</p>
<ul>
<li>Initialize the pipeline without starting from 0, e.g. when the rollup node restarts with an existing engine instance.</li>
<li>Recover the pipeline if it becomes inconsistent with the execution engine chain, e.g. when the engine syncs/changes.</li>
<li>Recover the pipeline when the L1 chain reorganizes, e.g. a late L1 block is orphaned, or a larger attestation failure.</li>
<li>Initialize the pipeline to derive a disputed L2 block with prior L1 and L2 history inside a fault-proof program.</li>
</ul>
<p>Handling these cases also means a node can be configured to eagerly sync L1 data with 0 confirmations,
as it can undo the changes if the L1 later does recognize the data as canonical, enabling safe low-latency usage.</p>
<p>The Engine Queue is first reset, to determine the L1 and L2 starting points to continue derivation from.
After this, the other stages are reset independent of each other.</p>
<h4 id="finding-the-sync-starting-point"><a class="header" href="#finding-the-sync-starting-point">Finding the sync starting point</a></h4>
<p>To find the starting point, there are several steps, relative to the head of the chain traversing back:</p>
<ol>
<li>Find the current L2 forkchoice state
<ul>
<li>If no <code>finalized</code> block can be found, start at the Bedrock genesis block.</li>
<li>If no <code>safe</code> block can be found, fallback to the <code>finalized</code> block.</li>
<li>The <code>unsafe</code> block should always be available and consistent with the above
(it may not be in rare engine-corruption recovery cases, this is being reviewed).</li>
</ul>
</li>
<li>Find the first L2 block with plausible L1 reference to be the new <code>unsafe</code> starting point,
starting from previous <code>unsafe</code>, back to <code>finalized</code> and no further.
<ul>
<li>Plausible iff: the L1 origin of the L2 block is known and canonical, or unknown and has a block-number ahead of L1.</li>
</ul>
</li>
<li>Find the first L2 block with an L1 reference older than the sequencing window, to be the new <code>safe</code> starting point,
starting at the above plausible <code>unsafe</code> head, back to <code>finalized</code> and no further.
<ul>
<li>If at any point the L1 origin is known but not canonical, the <code>unsafe</code> head is revised to parent of the current.</li>
<li>The highest L2 block with known canonical L1 origin is remembered as <code>highest</code>.</li>
<li>If at any point the L1 origin in the block is corrupt w.r.t. derivation rules, then error. Corruption includes:
<ul>
<li>Inconsistent L1 origin block number or parent-hash with parent L1 origin</li>
<li>Inconsistent L1 sequence number (always changes to <code>0</code> for a L1 origin change, or increments by <code>1</code> if not)</li>
</ul>
</li>
<li>If the L1 origin of the L2 block <code>n</code> is older than the L1 origin of <code>highest</code> by more than a sequence window,
and <code>n.sequence_number == 0</code>, then the parent L2 block of <code>n</code> will be the <code>safe</code> starting point.</li>
</ul>
</li>
<li>The <code>finalized</code> L2 block persists as the <code>finalized</code> starting point.</li>
<li>Find the first L2 block with an L1 reference older than the channel-timeout
<ul>
<li>The L1 origin referenced by this block which we call <code>l2base</code> will be the <code>base</code> for the L2 pipeline derivation:
By starting here, the stages can buffer any necessary data, while dropping incomplete derivation outputs until
L1 traversal has caught up with the actual L2 safe head.</li>
</ul>
</li>
</ol>
<p>While traversing back the L2 chain, an implementation may sanity-check that the starting point is never set too far
back compared to the existing forkchoice state, to avoid an intensive reorg because of misconfiguration.</p>
<p>Implementers note: step 1-4 are known as <code>FindL2Heads</code>. Step 5 is currently part of the Engine Queue reset.
This may change to isolate the starting-point search from the bare reset logic.</p>
<h4 id="resetting-derivation-stages"><a class="header" href="#resetting-derivation-stages">Resetting derivation stages</a></h4>
<ol>
<li>L1 Traversal: start at L1 <code>base</code> as first block to be pulled by next stage.</li>
<li>L1 Retrieval: empty previous data, and fetch the <code>base</code> L1 data, or defer the fetching work to a later pipeline step.</li>
<li>Frame Queue: empty the queue.</li>
<li>Channel Bank: empty the channel bank.</li>
<li>Channel Reader: reset any batch decoding state.</li>
<li>Batch Queue: empty the batch queue, use <code>base</code> as initial L1 point of reference.</li>
<li>Payload Attributes Derivation: empty any batch/attributes state.</li>
<li>Engine Queue:
<ul>
<li>Initialize L2 forkchoice state with syncing start point state. (<code>finalized</code>/<code>safe</code>/<code>unsafe</code>)</li>
<li>Initialize the L1 point of reference of the stage to <code>base</code>.</li>
<li>Require a forkchoice update as first task</li>
<li>Reset any finality data</li>
</ul>
</li>
</ol>
<p>Where necessary, stages starting at <code>base</code> can initialize their system-config from data encoded in the <code>l2base</code> block.</p>
<h4 id="about-reorgs-post-merge"><a class="header" href="#about-reorgs-post-merge">About reorgs Post-Merge</a></h4>
<p>Note that post-<a href="https://ethereum.org/en/upgrades/merge/">merge</a>, the depth of reorgs will be bounded by the <a href="https://ethereum.org/en/developers/docs/consensus-mechanisms/pos/#finality">L1 finality delay</a>
(2 L1 beacon epochs, or approximately 13 minutes, unless more than 1/3 of the network consistently disagrees).
New L1 blocks may be finalized every L1 beacon epoch (approximately 6.4 minutes), and depending on these
finality-signals and batch-inclusion, the derived L2 chain will become irreversible as well.</p>
<p>Note that this form of finalization only affects inputs, and nodes can then subjectively say the chain is irreversible,
by reproducing the chain from these irreversible inputs and the set protocol rules and parameters.</p>
<p>This is however completely unrelated to the outputs posted on L1, which require a form of proof like a fault-proof or
zk-proof to finalize. Optimistic-rollup outputs like withdrawals on L1 are only labeled "finalized" after passing a week
without dispute (fault proof challenge window), a name-collision with the proof-of-stake finalization.</p>
<hr />
<h1 id="deriving-payload-attributes"><a class="header" href="#deriving-payload-attributes">Deriving Payload Attributes</a></h1>
<p>For every L2 block derived from L1 data, we need to build <a href="protocol/../glossary.html#payload-attributes">payload attributes</a>,
represented by an <a href="protocol/exec-engine.html#extended-payloadattributesv1">expanded version</a> of the <a href="https://github.com/ethereum/execution-apis/blob/main/src/engine/cancun.md"><code>PayloadAttributesV2</code></a> object,
which includes additional <code>transactions</code> and <code>noTxPool</code> fields.</p>
<p>This process happens during the payloads-attributes queue ran by a verifier node, as well as during block-production
ran by a sequencer node (the sequencer may enable the tx-pool usage if the transactions are batch-submitted).</p>
<h2 id="deriving-the-transaction-list"><a class="header" href="#deriving-the-transaction-list">Deriving the Transaction List</a></h2>
<p>For each L2 block to be created by the sequencer, we start from a <a href="protocol/../glossary.html#sequencer-batch">sequencer batch</a> matching the
target L2 block number. This could potentially be an empty auto-generated batch, if the L1 chain did not include a batch
for the target L2 block number. <a href="protocol/derivation.html#batch-format">Remember</a> that the batch includes a <a href="protocol/../glossary.html#sequencing-epoch">sequencing
epoch</a> number, an L2 timestamp, and a transaction list.</p>
<p>This block is part of a <a href="protocol/../glossary.html#sequencing-epoch">sequencing epoch</a>,
whose number matches that of an L1 block (its <em><a href="protocol/../glossary.html#l1-origin">L1 origin</a></em>).
This L1 block is used to derive L1 attributes and (for the first L2 block in the epoch) user deposits.</p>
<p>Therefore, a <a href="protocol/exec-engine.html#extended-payloadattributesv1"><code>PayloadAttributesV2</code></a> object must include the following transactions:</p>
<ul>
<li>one or more <a href="protocol/../glossary.html#deposited-transaction">deposited transactions</a>, of two kinds:
<ul>
<li>a single <em><a href="protocol/../glossary.html#l1-attributes-deposited-transaction">L1 attributes deposited transaction</a></em>, derived from the L1 origin.</li>
<li>for the first L2 block in the epoch, zero or more <em><a href="protocol/../glossary.html#user-deposited-transaction">user-deposited transactions</a></em>, derived from
the <a href="protocol/../glossary.html#receipt">receipts</a> of the L1 origin.</li>
</ul>
</li>
<li>zero or more <a href="protocol/derivation.html#network-upgrade-automation-transactions">network upgrade automation transactions</a>: special transactions to perform network upgrades.</li>
<li>zero or more <em><a href="protocol/../glossary.html#sequencing">sequenced transactions</a></em>: regular transactions signed by L2 users, included in the
sequencer batch.</li>
</ul>
<p>Transactions <strong>must</strong> appear in this order in the payload attributes.</p>
<p>The L1 attributes are read from the L1 block header, while deposits are read from the L1 block's <a href="protocol/../glossary.html#receipt">receipts</a>.
Refer to the <a href="protocol/deposits.html#deposit-contract"><strong>deposit contract specification</strong></a> for details on how deposits are encoded as log
entries.</p>
<p>Logs are derived from transactions following the future-proof best-effort process described in
<a href="protocol/derivation.html#on-future-proof-transaction-log-derivation">On Future Proof Transaction Log Derivation</a></p>
<h3 id="network-upgrade-automation-transactions"><a class="header" href="#network-upgrade-automation-transactions">Network upgrade automation transactions</a></h3>
<p>Some network upgrades require automated contract changes or deployments at specific blocks.
To automate these, without adding persistent changes to the execution-layer,
special transactions may be inserted as part of the derivation process.</p>
<h2 id="building-individual-payload-attributes"><a class="header" href="#building-individual-payload-attributes">Building Individual Payload Attributes</a></h2>
<p>After deriving the transactions list, the rollup node constructs a <a href="protocol/exec-engine.html#extended-payloadattributesv1"><code>PayloadAttributesV2</code></a> as
follows:</p>
<ul>
<li><code>timestamp</code> is set to the batch's timestamp.</li>
<li><code>random</code> is set to the <code>prev_randao</code> L1 block attribute.</li>
<li><code>suggestedFeeRecipient</code> is set to the Sequencer Fee Vault address. See <a href="protocol/exec-engine.html#fee-vaults">Fee Vaults</a> specification.</li>
<li><code>transactions</code> is the array of the derived transactions: deposited transactions and sequenced transactions, all
encoded with <a href="https://eips.ethereum.org/EIPS/eip-2718">EIP-2718</a>.</li>
<li><code>noTxPool</code> is set to <code>true</code>, to use the exact above <code>transactions</code> list when constructing the block.</li>
<li><code>gasLimit</code> is set to the current <code>gasLimit</code> value in the <a href="protocol/../glossary.html#system-configuration">system configuration</a> of this payload.</li>
<li><code>withdrawals</code> is set to nil prior to Canyon and an empty array after Canyon</li>
</ul>
<h2 id="on-future-proof-transaction-log-derivation"><a class="header" href="#on-future-proof-transaction-log-derivation">On Future-Proof Transaction Log Derivation</a></h2>
<p>As described in <a href="protocol/derivation.html#l1-retrieval">L1 Retrieval</a>, batcher transactions' types are required to be from a fixed allow-list.</p>
<p>However, we want to allow deposit transactions and <code>SystemConfig</code> update events to get derived even from receipts of
future transaction types, as long as the receipts can be decoded following a best-effort process:</p>
<p>As long as a future transaction type follows the <a href="https://eips.ethereum.org/EIPS/eip-2718">EIP-2718</a> specification, the
type can be decoded from the first byte of the transaction's (or its receipt's) binary encoding. We can then proceed as
follows to get the logs of such a future transaction, or discard the transaction's receipt as invalid.</p>
<ul>
<li>If it's a known transaction type, that is, legacy (first byte of the encoding is in the range <code>[0xc0, 0xfe]</code>) or its
first byte is in the range <code>[0, 4]</code> or <code>0x7e</code> (<em>deposited</em>), then it's not a <em>future transaction</em> and we know how to
decode the receipt and this process is irrelevant.</li>
<li>If a transaction's first byte is in the range <code>[0x05, 0x7d]</code>, it is expected to be a <em>future</em> EIP-2718 transaction, so
we can proceed to the receipt. Note that we excluded <code>0x7e</code> because that's the deposit transaction type, which is known.</li>
<li>The <em>future</em> receipt encoding's first byte must be the same byte as the transaction encoding's first byte, or it is
discarded as invalid, because we require it to be an EIP-2718-encoded receipt to continue.</li>
<li>The receipt payload is decoded as if it is encoded as <code>rlp([status, cumulative_transaction_gas_used, logs_bloom, logs])</code>, which is the encoding of the known non-legacy transaction types.
<ul>
<li>If this decoding fails, the transaction's receipt is discarded as invalid.</li>
<li>If this decoding succeeds, the <code>logs</code> have been obtained and can be processed as those of known transaction types.</li>
</ul>
</li>
</ul>
<p>The intention of this best-effort decoding process is to future-proof the protocol for new L1 transaction types.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="batch-submitter"><a class="header" href="#batch-submitter">Batch Submitter</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/batcher.html#overview">Overview</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-11"><a class="header" href="#overview-11">Overview</a></h2>
<p>The batch submitter, also referred to as the batcher, is the entity submitting the L2 sequencer data to L1,
to make it available for verifiers.</p>
<p>The format of the data transactions is defined in the <a href="protocol/derivation.html">derivation spec</a>:
the data is constructed from L2 blocks in the reverse order as it is derived from data into L2 blocks.</p>
<p>The timing, operation and transaction signing is implementation-specific: any data can be submitted at any time,
but only the data that matches the <a href="protocol/derivation.html">derivation spec</a> rules will be valid from the verifier perspective.</p>
<p>The most minimal batcher implementation can be defined as a loop of the following operations:</p>
<ol>
<li>See if the <code>unsafe</code> L2 block number is past the <code>safe</code> block number: <code>unsafe</code> data needs to be submitted.</li>
<li>Iterate over all unsafe L2 blocks, skip any that were previously submitted.</li>
<li>Open a channel, buffer all the L2 block data to be submitted,
while applying the encoding and compression as defined in the <a href="protocol/derivation.html">derivation spec</a>.</li>
<li>Pull frames from the channel to fill data transactions with, until the channel is empty.</li>
<li>Submit the data transactions to L1</li>
</ol>
<p>The L2 view of safe/unsafe does not instantly update after data is submitted, nor when it gets confirmed on L1,
so special care may have to be taken to not duplicate data submissions.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="flashblocks"><a class="header" href="#flashblocks">Flashblocks</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/flashblocks.html#abstract">Abstract</a></li>
<li><a href="protocol/flashblocks.html#prerequisites">Prerequisites</a></li>
<li><a href="protocol/flashblocks.html#motivation">Motivation</a></li>
<li><a href="protocol/flashblocks.html#specification">Specification</a>
<ul>
<li><a href="protocol/flashblocks.html#terminology">Terminology</a></li>
<li><a href="protocol/flashblocks.html#parameters">Parameters</a></li>
<li><a href="protocol/flashblocks.html#data-structures">Data structures</a>
<ul>
<li><a href="protocol/flashblocks.html#flashblockspayloadv1"><strong><code>FlashblocksPayloadV1</code></strong></a></li>
<li><a href="protocol/flashblocks.html#executionpayloadflashblockdeltav1"><strong><code>ExecutionPayloadFlashblockDeltaV1</code></strong></a></li>
<li><a href="protocol/flashblocks.html#executionpayloadstaticv1"><strong><code>ExecutionPayloadStaticV1</code></strong></a></li>
<li><a href="protocol/flashblocks.html#metadata"><strong><code>Metadata</code></strong></a></li>
<li><a href="protocol/flashblocks.html#accountmetadata"><strong><code>AccountMetadata</code></strong></a></li>
<li><a href="protocol/flashblocks.html#storageslot"><strong><code>StorageSlot</code></strong></a></li>
<li><a href="protocol/flashblocks.html#transactionmetadata"><strong><code>TransactionMetadata</code></strong></a></li>
</ul>
</li>
<li><a href="protocol/flashblocks.html#system-architecture">System architecture</a></li>
<li><a href="protocol/flashblocks.html#out-of-protocol-design">Out-of-Protocol Design</a>
<ul>
<li><a href="protocol/flashblocks.html#in-protocol-vs-out-of-protocol">In-Protocol vs. Out-of-Protocol</a></li>
<li><a href="protocol/flashblocks.html#design-rationale-and-benefits">Design Rationale and Benefits</a></li>
<li><a href="protocol/flashblocks.html#implications-for-this-specification">Implications for This Specification</a></li>
</ul>
</li>
<li><a href="protocol/flashblocks.html#assumptions-about-op-stack">Assumptions About Op Stack</a></li>
<li><a href="protocol/flashblocks.html#flashblock-lifecycle">Flashblock Lifecycle</a></li>
<li><a href="protocol/flashblocks.html#flashblock-construction-process">Flashblock Construction Process</a>
<ul>
<li><a href="protocol/flashblocks.html#handling-of-sequencer-transactions">Handling of Sequencer Transactions</a></li>
<li><a href="protocol/flashblocks.html#transaction-inclusion-heuristics">Transaction Inclusion Heuristics</a>
<ul>
<li><a href="protocol/flashblocks.html#linear-gas-limit-increase-and-transaction-inclusion-guarantees">Linear Gas Limit Increase and Transaction Inclusion Guarantees</a></li>
</ul>
</li>
<li><a href="protocol/flashblocks.html#post-block-execution-rules">Post-block Execution Rules</a></li>
<li><a href="protocol/flashblocks.html#construction-steps">Construction Steps</a></li>
</ul>
</li>
<li><a href="protocol/flashblocks.html#flashblocks-metadata">Flashblocks Metadata</a>
<ul>
<li><a href="protocol/flashblocks.html#alternative-design-consideration">Alternative Design Consideration</a></li>
</ul>
</li>
<li><a href="protocol/flashblocks.html#rationale-for-including-state-roots-in-flashblocks">Rationale for Including State Roots in Flashblocks</a>
<ul>
<li><a href="protocol/flashblocks.html#non-blocking-block-production">Non-Blocking Block Production</a></li>
<li><a href="protocol/flashblocks.html#builder-availability-and-system-reliability">Builder Availability and System Reliability</a></li>
<li><a href="protocol/flashblocks.html#future-design-considerations">Future Design Considerations</a></li>
</ul>
</li>
<li><a href="protocol/flashblocks.html#builder-to-rollup-boost-communication-flow">Builder-to-Rollup-boost Communication Flow</a></li>
<li><a href="protocol/flashblocks.html#flashblock-validity-rules">Flashblock Validity Rules</a></li>
<li><a href="protocol/flashblocks.html#flashblock-system-invariants">Flashblock System Invariants</a></li>
<li><a href="protocol/flashblocks.html#flashblock-propagation">Flashblock Propagation</a>
<ul>
<li><a href="protocol/flashblocks.html#secure-propagation">Secure propagation</a></li>
</ul>
</li>
<li><a href="protocol/flashblocks.html#flashblock-json-rpc-apis">Flashblock JSON-RPC APIs</a>
<ul>
<li><a href="protocol/flashblocks.html#ethereum-json-rpc-modifications">Ethereum JSON RPC Modifications</a></li>
<li><a href="protocol/flashblocks.html#op_supportedcapabilities">op_supportedCapabilities</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="protocol/flashblocks.html#reliability-and-operational-considerations">Reliability and Operational Considerations</a>
<ul>
<li><a href="protocol/flashblocks.html#transaction-propagation">Transaction Propagation</a></li>
<li><a href="protocol/flashblocks.html#failover-scenarios">Failover scenarios</a>
<ul>
<li><a href="protocol/flashblocks.html#block-builder">Block Builder</a></li>
<li><a href="protocol/flashblocks.html#the-sequencer-or-rollup-boost">The Sequencer or Rollup-boost</a></li>
</ul>
</li>
<li><a href="protocol/flashblocks.html#integration-with-high-availability-sequencer-setups">Integration with High Availability Sequencer Setups</a></li>
<li><a href="protocol/flashblocks.html#faults">Faults</a>
<ul>
<li><a href="protocol/flashblocks.html#safety-faults"><strong>Safety Faults</strong></a></li>
<li><a href="protocol/flashblocks.html#liveness-faults"><strong>Liveness Faults</strong></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="protocol/flashblocks.html#rationale">Rationale</a>
<ul>
<li><a href="protocol/flashblocks.html#why-out-of-protocol">Why out-of-protocol</a>
<ul>
<li><a href="protocol/flashblocks.html#why-not-shorter-block-times">Why not shorter block times</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="protocol/flashblocks.html#backwards-compatibility">Backwards Compatibility</a>
<ul>
<li><a href="protocol/flashblocks.html#end-users">End Users</a></li>
<li><a href="protocol/flashblocks.html#infrastructure-operators">Infrastructure Operators</a></li>
</ul>
</li>
<li><a href="protocol/flashblocks.html#implementation">Implementation</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h1 id="abstract"><a class="header" href="#abstract">Abstract</a></h1>
<p>Introduces a standard for partial blocks called â€œFlashblocks,â€ inspired but not entirely identical to <a href="https://github.com/solana-foundation/specs/blob/main/p2p/shred.md">Solana
Shreds</a>, enabling rapid preconfirmations on Ethereum
Layer 2 networks such as OP Stack. Flashblocks propagate transaction batches incrementally and expose their state via a
modified Ethereum JSON-RPC interface, giving users immediate feedback equivalent to drastically reduced block times
without modifying the underlying OP Stack protocol. Flashblocks can be combined with Trusted Execution Environment
technology to enable quick verifiability over various networks of machines in addition to protection from equivocation.</p>
<h1 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h1>
<p>This document assumes knowledge of the terminology, definitions, and other material in</p>
<ul>
<li><a href="https://github.com/ethereum-optimism/">ðŸ”— Ethereum Optimism Protocol Specs</a></li>
<li><a href="https://specs.optimism.io/protocol/exec-engine.html#engine-api">ðŸ”—Â OP Stack Engine API</a></li>
<li><a href="https://github.com/ethereum-optimism/">ðŸ”— External Block Production in OP Stack Design Doc</a></li>
<li><a href="https://github.com/ethereum/execution-apis/tree/main">ðŸ”—Â Ethereum Execution APIs</a></li>
<li><a href="https://writings.flashbots.net/introducing-rollup-boost">ðŸ”—Â Introducing Rollup-Boost - Launching on Unichain</a></li>
<li><a href="https://www.notion.so/RFD-1-Rollup-boost-1996b4a0d876802f95d1c98387e38162?pvs=21">ðŸ”—Â Rollup-boost design doc</a></li>
</ul>
<h1 id="motivation"><a class="header" href="#motivation">Motivation</a></h1>
<p>As of April 2025, Layer 2 (L2) protocols built with the OP Stack have a minimum block time of one second, imposing
significant constraints on user experience. The limitation on minimum block times is primarily historical and
architectural, reflecting earlier assumptions of Ethereum network as well as deeply-integrated type definitions, from
the L2 blockchain client all the way down to smart contracts on the L1, making modification a very large task.</p>
<p>Due to similar constraints on Ethereum Layer 1, preconfirmations have gained attention as a promising method to
decouple blockchain user experiences from rigid block-time limitations and sidestep the longstanding debate between
block time and block size. Existing preconfirmation solutions predominantly depend on economic security in the form of
cryptoeconomic mechanisms such as staking. As well as focus on per-transaction preconfirmations, inadvertently pushing
protocols into the â€œLatency Auctionâ€ region of the <a href="https://writings.flashbots.net/introducing-rollup-boost">MEV
Trilemma</a>. Furthermore, previous approaches have often
introduced entirely new Ethereum JSON-RPC methods, presenting substantial integration barriers and hindering practical
adoption.</p>
<p>Inspired by modern blockchain networks like Solana and Celestia, Flashblocks introduce an â€œout-of-protocolâ€ standard
for incremental delivery of partial blocks containing batches of transactions. This approach significantly reduces
perceived latency for end-users  and improves network bandwidth without modifying underlying protocol rules, offering a
streamlined path for incremental adoption by node operators and existing infrastructure.</p>
<h1 id="specification"><a class="header" href="#specification">Specification</a></h1>
<h2 id="terminology"><a class="header" href="#terminology">Terminology</a></h2>
<p>All terms, actors, and components are used in this document identically to how they are defined in the <a href="https://github.com/ethereum-optimism/">OP Stack
protocol definition</a></p>
<p>Additional terms introduced:</p>
<ul>
<li><strong>External Block Builder</strong> - External Block Builders are first introduced to the OP Stack in the <a href="https://github.com/ethereum-optimism/">External Block
Production Design Document</a> where
they are described as an external party that the Sequencer can request blocks from.</li>
<li><strong>Rollup Boost</strong> - A sidecar piece of software first introduced without name in the <a href="https://github.com/ethereum-optimism/">External Block Production Design
Document</a> with two
roles:
<ol>
<li>obfuscate the presence of External Block Builder software from theÂ <code>op-node</code>Â andÂ <code>op-geth</code>Â software</li>
<li>manage communication from the sequencer with External Block Builders and handle block delivery toÂ <code>op-node</code> .</li>
</ol>
</li>
<li><strong>Fallback EL</strong> - The standard Execution Layer of the Sequencer, used by Rollup Boost as a fallback mechanism when it
cannot successfully build a block through the External Block Builder. This is an unmodified EL node that maintains the
ability to construct valid blocks according to standard OP Stack protocol rules.</li>
<li><strong>RPC Provider</strong> - Ethereum RPC software operator with the purpose of serving Ethereum state.</li>
</ul>
<h2 id="parameters"><a class="header" href="#parameters">Parameters</a></h2>
<div class="table-wrapper"><table><thead><tr><th><strong>Constant</strong></th><th><strong>Value</strong></th><th><strong>Description</strong></th></tr></thead><tbody>
<tr><td><code>FLASHBLOCKS_TIME</code></td><td>200ms</td><td>Default wall clock time per flashblock.</td></tr>
<tr><td><code>FLASHBLOCKS_PER_L2_BLOCK</code></td><td><code>L2_BLOCK_TIME</code>/<code>FLASHBLOCKS_TIME</code></td><td>Supported number of flashblocks per L2 block. (Ex: 2s/200ms = 10 Flashblocks)</td></tr>
<tr><td><code>MAX_EXTRA_DATA_BYTES</code></td><td>32</td><td>Extra data size in an Optimism block</td></tr>
<tr><td><code>BYTES_PER_LOGS_BLOOM</code></td><td>256</td><td>Size of a logs bloom field in an Optimism block</td></tr>
</tbody></table>
</div>
<h2 id="data-structures"><a class="header" href="#data-structures">Data structures</a></h2>
<h3 id="flashblockspayloadv1"><a class="header" href="#flashblockspayloadv1"><strong><code>FlashblocksPayloadV1</code></strong></a></h3>
<p>The core data structure sent from the Block Builder to Rollup Boost and then external parties.  A container
representing a Flashblock payload, encapsulating block deltas, base configuration, and additional metadata.</p>
<pre><code class="language-python">class FlashblocksPayloadV1():
    version: Bytes4
    payload_id: Bytes8
    parent_flash_hash: Optional[Bytes32]
    index: uint64
    static: Optional[ExecutionPayloadStaticV1]
    diff: ExecutionPayloadFlashblockDeltaV1
    metadata: FlashblocksMetadata
**Field descriptions:**

</code></pre>
<ul>
<li><code>payload_id</code>: PayloadID is an identifier of the payload build process. The same for all flashblocks.</li>
<li><code>index</code>: Index of the Flashblock within the parent block.</li>
<li><code>parent_flash_hash</code>: SSZ hash of the parent flashblock in the sequence. For the first flashblock (index 0), the field
is empty.</li>
<li><code>base</code> <em>(Optional)</em>: Reference execution payload serving as the unchanging base configuration.</li>
<li><code>diff</code>: Container with fields representing changes from the base payload.</li>
<li><code>metadata</code>: Supplementary information about the execution of the flashblock. For example: account state changes,
storage modifications, transaction receipts.</li>
</ul>
<h3 id="executionpayloadflashblockdeltav1"><a class="header" href="#executionpayloadflashblockdeltav1"><strong><code>ExecutionPayloadFlashblockDeltaV1</code></strong></a></h3>
<p>Container encoding only the mutable portions of the execution payload updated during Flashblock construction.</p>
<pre><code class="language-python">class ExecutionPayloadFlashblockDeltaV1():
    state_root: Bytes32
    receipts_root: Bytes32
    logs_bloom: ByteVector[BYTES_PER_LOGS_BLOOM]
    gas_used: uint64
    block_hash: Bytes32
    transactions: List[Transaction]
    withdrawals: List[Withdrawal]
    withdrawals_root: Bytes32
</code></pre>
<p><strong>Field descriptions:</strong></p>
<ul>
<li><code>state_root</code>: Root hash of the post-execution state trie.</li>
<li><code>receipts_root</code>: Root hash of the transaction receipts trie.</li>
<li><code>logs_bloom</code>: Bloom filter of all logs emitted by the block.</li>
<li><code>gas_used</code>: Gas consumed by included transactions.</li>
<li><code>block_hash</code>: Final hash of the completed execution block.</li>
<li><code>transactions</code>: List of transactions included in the Flashblock.</li>
<li><code>withdrawals</code>: Withdrawals included (as per Optimism specification). Must be non-nil but empty when
<code>withdrawals_root</code> is used directly.</li>
<li><code>withdrawals_root</code>: OP-Stack Isthmus specific field: instead of computing the root from a withdrawals list, set it
directly. The "withdrawals" list attribute must be non-nil but empty.</li>
</ul>
<p><strong>Supporting Type Definitions</strong></p>
<ul>
<li><code>Transaction</code>: Transaction bytes as per execution payload specification.</li>
<li><code>Withdrawal</code>: Standard Ethereum Capella withdrawal container.</li>
</ul>
<p>All fields in this structure represent the cumulative state of the entire block up to and including the current
flashblock, not just the changes from this specific flashblock.</p>
<h3 id="executionpayloadstaticv1"><a class="header" href="#executionpayloadstaticv1"><strong><code>ExecutionPayloadStaticV1</code></strong></a></h3>
<p>Container representing immutable fundamental block properties established at initial block creation, unchanged
throughout construction.</p>
<pre><code class="language-python">class ExecutionPayloadStaticV1():
    parent_beacon_block_root: Bytes32
    parent_hash: Bytes32
    fee_recipient: ExecutionAddress
    prev_randao: Bytes32
    block_number: uint64
    gas_limit: uint64
    timestamp: uint64
    extra_data: ByteList[MAX_EXTRA_DATA_BYTES]
    base_fee_per_gas: uint256
</code></pre>
<p><strong>Field descriptions:</strong></p>
<ul>
<li><code>parent_beacon_block_root</code>: Ecotone parent beacon block root.</li>
<li><code>parent_hash</code>: Hash of the parent execution block.</li>
<li><code>fee_recipient</code>: Address receiving transaction fees.</li>
<li><code>prev_randao</code>: Previous blockâ€™s RANDAO reveal for randomness.</li>
<li><code>block_number</code>: Sequential execution block number.</li>
<li><code>gas_limit</code>: Maximum allowable gas consumption for the block.</li>
<li><code>timestamp</code>: Unix timestamp at block creation.</li>
<li><code>extra_data</code>: Arbitrary extra data bytes included in the block header.</li>
<li><code>base_fee_per_gas</code>: Base fee per gas unit at the block.</li>
</ul>
<h3 id="metadata"><a class="header" href="#metadata"><strong><code>Metadata</code></strong></a></h3>
<p>Container encapsulating all metadata for a flashblock, including account state changes and transaction results.</p>
<pre><code class="language-python">class FlashblockMetadata():
         accounts: List[AccountMetadata]
  transactions: List[TransactionMetadata]
</code></pre>
<p><strong>Field descriptions:</strong></p>
<ul>
<li><code>accounts</code>: List of accounts with modified state in this flashblock.</li>
<li><code>transactions</code>: List of transaction execution results in this flashblock.</li>
</ul>
<h3 id="accountmetadata"><a class="header" href="#accountmetadata"><strong><code>AccountMetadata</code></strong></a></h3>
<p>Container representing account state changes included in the Flashblock metadata. It is used by providers to fulfill
the RPC requests.</p>
<pre><code class="language-python">class AccountMetadata():
    address: ExecutionAddress
    balance: Optional[uint256]
    nonce: uint64
    code: Optional[Bytes]
    storage_slots: List[StorageSlot]
</code></pre>
<p><strong>Field descriptions:</strong></p>
<ul>
<li><code>address</code>: Ethereum address of the affected account.</li>
<li><code>balance</code>: Updated account balance after the Flashblock's execution (None if unchanged).</li>
<li><code>nonce</code>: Updated account nonce (transaction count) after the Flashblock's execution.</li>
<li><code>code_created</code>:  Contract bytecode if created in this Flashblock.</li>
<li><code>storage_slots</code>: List of modified storage slots and their new values.</li>
</ul>
<p>Storage slot keys must be de-duplicated (only the final value for each key should be included) and sorted in ascending
byte order for deterministic processing.</p>
<h3 id="storageslot"><a class="header" href="#storageslot"><strong><code>StorageSlot</code></strong></a></h3>
<p>Container representing a single modified storage slot within an account.</p>
<pre><code class="language-python">class StorageSlot():
    key: Bytes32
    value: Bytes32
</code></pre>
<p><strong>Field descriptions:</strong></p>
<ul>
<li><code>key</code>: Storage slot location (32-byte key).</li>
<li><code>value</code>: New value stored at this slot after the Flashblock's execution.</li>
</ul>
<h3 id="transactionmetadata"><a class="header" href="#transactionmetadata"><strong><code>TransactionMetadata</code></strong></a></h3>
<p>Container representing succinct transaction execution results.</p>
<pre><code class="language-python">class TransactionMetadata():
    status: uint8
    gas_used: uint64
    contract_address: Optional[ExecutionAddress]
</code></pre>
<p><strong>Field descriptions:</strong></p>
<ul>
<li><code>status</code>: Execution status (1 for success, 0 for failure).</li>
<li><code>gas_used</code>: Amount of gas used by this specific transaction.</li>
<li><code>contract_address</code>: Address of created contract (None for non-creation transactions).</li>
</ul>
<h2 id="system-architecture"><a class="header" href="#system-architecture">System architecture</a></h2>
<p>The following diagram illustrates the Flashblocks system architecture, showing the relationships between key components:</p>
<pre class="mermaid">
flowchart LR
    subgraph Sequencer
        ON[OP Node]
        RB[Rollup Boost]
        FEL[Fallback EL]
        BB[Block Builder]
    end

    subgraph Network
        WSP[WebSocket Proxy]
    end

    subgraph Clients
        RPC[RPC Providers]
        Users[End Users]
    end

    ON --&gt; RB
    RB --&gt; FEL
    RB &lt;--&gt; BB
    RB --&gt; WSP
    WSP --&gt; RPC
    RPC --&gt; Users
</pre>
<p>This architecture shows the flow of data through the Flashblocks system:</p>
<ol>
<li>The <strong>OP Node</strong> initiates block production and sends requests to <strong>Rollup Boost</strong></li>
<li><strong>Rollup Boost</strong> coordinates between multiple components:
<ul>
<li>It communicates with the <strong>Block Builder</strong> to create Flashblocks</li>
<li>It maintains a connection to the <strong>Fallback EL</strong> for reliability if the Block Builder fails</li>
<li>It propagates validated Flashblocks to the network via the <strong>WebSocket Proxy</strong></li>
</ul>
</li>
<li>The <strong>WebSocket Proxy</strong> distributes Flashblocks to multiple <strong>RPC Providers</strong></li>
<li><strong>RPC Providers</strong> serve preconfirmation data to <strong>End Users</strong></li>
</ol>
<p>The rest of this document provides detailed specifications for each component and their interactions, explaining the
protocols, data structures, and operational considerations.</p>
<h2 id="out-of-protocol-design"><a class="header" href="#out-of-protocol-design">Out-of-Protocol Design</a></h2>
<p>The Flashblocks specification follows a deliberate "out-of-protocol" design philosophy. This section clarifies what we
mean by this term and explains its implications for the OP Stack ecosystem.</p>
<h3 id="in-protocol-vs-out-of-protocol"><a class="header" href="#in-protocol-vs-out-of-protocol">In-Protocol vs. Out-of-Protocol</a></h3>
<p>In the context of OP Stack, "in-protocol" components form the core protocol itself. These components implement
fundamental consensus rules, are required for basic rollup functionality, and need standardization across all
participants. Modifying in-protocol components requires protocol-level changes and network-wide upgrades.</p>
<p>By contrast, "out-of-protocol" components like Flashblocks operate as optional extensions to the core protocol. They
can be added or removed without breaking the consensus rules of the network, though they may still impact network
performance or operations if implemented poorly.</p>
<p>The only in-protocol guarantee that Flashblocks must uphold is producing valid blocks at the established block time
interval (typically 1-2 seconds in current OP Stack implementations).</p>
<h3 id="design-rationale-and-benefits"><a class="header" href="#design-rationale-and-benefits">Design Rationale and Benefits</a></h3>
<p>The out-of-protocol design for Flashblocks emerged from practical constraints during initial development. Without
strong coordination with the OP Stack team at the outset, and given the complexity of the challenge, working within the
existing protocol boundaries was the most pragmatic approach.</p>
<p>This constraint ultimately proved beneficial, as it forced the design to be minimally invasive. Flashblocks can be
implemented immediately on any OP Stack chain without waiting for protocol upgrades or network-wide consensus.</p>
<p>Any issues with the Flashblocks implementation remain isolated from the core protocol, protecting overall network
stability. In case of serious problems, Flashblocks can be disabled entirely, allowing the system to revert to normal
operation without disrupting the underlying rollup. This clean fallback mechanism benefits from the centralized trust
model of L2s, where the sequencer has the authority to quickly enact such operational changes without requiring
network-wide consensus.</p>
<p>Now that the usefulness of the system has been proven, as more collaboration venues with the OP Stack team emerge,
integrating parts of Flashblocks directly into the protocol could provide even stronger guarantees and open the design
space for future innovations. We are considering that approach too in the future.</p>
<h3 id="implications-for-this-specification"><a class="header" href="#implications-for-this-specification">Implications for This Specification</a></h3>
<p>Most elements defined in this document are out-of-protocol components that operate as extensions to the core OP Stack.
The only hard guarantee the system must provide is that valid blocks are delivered at the expected intervals.</p>
<p>Everything elseâ€”from how Flashblocks are constructed and propagated to how RPC providers implement preconfirmation
cachesâ€”represents iterative improvements designed to achieve the goal of faster user feedback as efficiently and
impactfully as possible.</p>
<p>This means the specification describes a recommended implementation path rather than rigid protocol requirements.
Components can evolve independently without requiring protocol-level coordination, and implementations may vary in how
they achieve the same functional goals.</p>
<h2 id="assumptions-about-op-stack"><a class="header" href="#assumptions-about-op-stack">Assumptions About Op Stack</a></h2>
<p>The Flashblocks design makes several assumptions about OP Stack behavior:</p>
<ul>
<li><strong>Quick Response for engine_getPayload</strong>: We assume that <code>engine_getPayload</code> requests should return as quickly as
possible for a normal and healthy chain.</li>
<li><strong>Deterministic Payload IDs</strong>: While not specific to Flashblocks but to Rollup Boost in general, we assume that
payload IDs from different execution layer nodes are deterministically computed for the same ForkChoiceUpdate request.
This is not explicitly enforced in specifications, but execution layers tend to maintain this consistency as a
practical implementation detail.</li>
</ul>
<h2 id="flashblock-lifecycle"><a class="header" href="#flashblock-lifecycle">Flashblock Lifecycle</a></h2>
<p>Note that familiarity with Rollup-boost is expected throughout this entire document, as Flashblocks is designed as an
extension built on top of the existing Rollup-boost architecture.</p>
<p>The lifecycle of a Flashblock begins with the Sequencer initiating block creation and ends with a normal L2 block
consisting of all delivered flashblocks propagating according to the OP Stack protocol. The process proceeds as follows:</p>
<ol>
<li>
<p><strong>Fork Choice Update</strong>:</p>
<p>The Sequencer initiates the block-building cycle by sending an <code>engine_forkchoiceUpdated</code> with attributes call to
Rollup Boost as it normally would to its local Execution Engine.</p>
</li>
<li>
<p><strong>Fork Choice Update Forwarding</strong>:</p>
<p>Rollup Boost forwards the <code>engine_forkchoiceUpdated</code> call concurrently to:</p>
<ul>
<li>The Sequencer's local Execution Engine</li>
<li>The External Block Builder</li>
</ul>
</li>
<li>
<p><strong>Flashblock Construction</strong>:</p>
<p>Upon receiving the fork choice update, the External Block Builder constructs and continuously delivers
<code>FlashblocksPayloadV1</code> at intervals defined by <code>FLASHBLOCKS_TIME</code> following the <strong>Flashblocks Construction Process</strong>
defined in this document.</p>
<p>It's important to emphasize that during this process, the External Block Builder sends only the incremental changes
in each Flashblock, not the full block state each time. EachÂ <code>FlashblocksPayloadV1</code>Â contains just the delta from the
previous state (new transactions, updated state roots, etc.), allowing for efficient bandwidth usage and faster
propagation.</p>
<p>Only the first Flashblock (with <code>index</code> 0) includes the <code>static</code> field containing immutable block data, while
subsequent Flashblocks omit this field since this information remains constant throughout the block's construction.
Each Flashblock includes a <code>parent_flash_hash</code> that references the SSZ hash of the previous Flashblock in the sequence,
creating a hash-linked chain within the block.</p>
<p>The combined information received across all flashblocks is sufficient to fully reconstruct the complete block
without any additional data.</p>
</li>
<li>
<p><strong>Flashblock Validation and Propagation</strong>:</p>
<p>For each received <code>FlashblocksPayloadV1</code>, Rollup Boost validates it against the Sequencerâ€™s local Execution Engine
and according to the <strong>Flashblocks Validity Rules</strong> defined in this document. Upon successful validation, Rollup Boost
propagates the payload to all subscribed Flashblock-compatible RPC providers.</p>
</li>
<li>
<p><strong>Preconfirmed State Updates</strong>:</p>
<p>Flashblock-compatible RPC providers insert validated payloads into their local Preconfirmed State Overlay,
providing immediate preconfirmation states to end-users via Flashblock-enhanced Ethereum JSON-RPC endpoints.</p>
</li>
<li>
<p><strong>Final L2 Block Delivery</strong>:</p>
<p>When the Sequencer calls <code>engine_getPayload</code>, Rollup Boost returns a single coherent block payload based on the
validated Flashblocks received since the last fork choice update. Note that this does not require additional external
requests or any last-minute processing.</p>
</li>
<li>
<p><strong>Full Block Propagation</strong>:</p>
<p>The Sequencer propagates the aggregated block following standard OP Stack protocol rules.</p>
</li>
</ol>
<pre class="mermaid">sequenceDiagram
    participant S as Sequencer Driver (op-node)
    participant RB as Rollup Boost
    participant EE as Sequencer Execution Engine (op-geth)
    participant BB as External Block Builder
    participant RPC as Flashblock RPC Providers
    participant U as End Users

    rect rgb(230,247,255)
        Note over S: 1. **Fork Choice Update**
        S-&gt;&gt;RB: engine_forkchoiceUpdated
    end

    rect rgb(255,242,230)
        Note over RB: 2. **Fork Choice Update Forwarding**
        RB-&gt;&gt;EE: engine_forkchoiceUpdated
        RB-&gt;&gt;BB: engine_forkchoiceUpdated
    end

    rect rgb(230,255,235)
    loop **Flashblock Construction** (every FLASHBLOCKS_TIME)
        Note over BB: **3. Flashblock Construction**
        BB-&gt;&gt;RB: FlashblocksPayloadV1

        rect rgb(252,244,255)
            Note over RB, EE: 4. **Flashblock Validation and Propagation**
            RB-&gt;&gt;EE: Validate Payload
            EE--&gt;&gt;RB: Validation Result

            alt Success
                RB-&gt;&gt;RPC: Propagate Valid Payload
                Note over RPC: 5. **Preconfirmed State Updates**
                RPC-&gt;&gt;RPC: Update State Overlay
                RPC-&gt;&gt;U: Serve Preconfirmed State
            else Failure
                RB--&gt;&gt;RB: Discard and fallback
            end
        end
    end
    end

    rect rgb(255,249,196)
        Note over S, RB: 6. **Final L2 Block Delivery**
        S-&gt;&gt;RB: engine_getPayload
        RB-&gt;&gt;S: Aggregate Payload
    end

    rect rgb(240,240,240)
        Note over S: 7. **Full Block Propagation**
        S-&gt;&gt;S: Propagate Block (standard OP Stack)
    end
</pre>
<h2 id="flashblock-construction-process"><a class="header" href="#flashblock-construction-process">Flashblock Construction Process</a></h2>
<p>The External Block Builder initiates the construction of Flashblocks upon receiving a fork choice update
(<code>engine_forkchoiceUpdated</code>) call forwarded by Rollup Boost. The construction of Flashblocks follows a defined sequence
of steps repeated every <code>FLASHBLOCKS_TIME</code> interval, ensuring consistent, incremental, and ordered propagation of
preconfirmed state to end-users. It's important to note that <code>FLASHBLOCKS_TIME</code> serves as a target interval rather than
a strictly enforced rule in Rollup Boost.</p>
<h3 id="handling-of-sequencer-transactions"><a class="header" href="#handling-of-sequencer-transactions">Handling of Sequencer Transactions</a></h3>
<p>An important protocol rule that the Flashblock construction process must adhere to involves handling "system
transactions" within the OP Stack. These include deposits and system transactions that arrive with the Fork Choice
Update (FCU) and must always be executed as the first transactions in any valid block.</p>
<p>From an "in-protocol" perspective, a block is not considered valid if these sequencer transactions are missing.
Consequently, the minimum valid block that can be constructed must include the execution of these transactions.</p>
<p>The External Block Builder follows this mandate by executing these sequencer transactions first and including them in
the initial Flashblock (index 0). This serves as the foundation upon which all subsequent Flashblocks in the sequence
will build.</p>
<p>When processing these mandatory sequencer transactions, the builder does not apply the same gas allocation heuristics
used for regular transactions in later Flashblocks. While these transactions do consume gas like any other transaction,
they receive special handling as they must be included regardless of gas considerations to maintain protocol validity.</p>
<h3 id="transaction-inclusion-heuristics"><a class="header" href="#transaction-inclusion-heuristics">Transaction Inclusion Heuristics</a></h3>
<p>As part of the flashblock construction process, the External Block Builder makes sophisticated decisions about
transaction inclusion. Unlike rigid gas limit enforcement, the decision of when to stop including transactions in a
flashblock involves nuanced heuristics that may evolve over time.</p>
<p>The builder must balance multiple factors when deciding which transactions to include in each flashblock:</p>
<ul>
<li>Optimizing for user experience by providing quick feedback</li>
<li>Ensuring transactions with higher gas usage aren't permanently excluded</li>
<li>Maintaining efficient gas utilization across the entire block</li>
<li>Accounting for execution time constraints within the <code>FLASHBLOCKS_TIME</code> window</li>
</ul>
<p>In some cases, the builder might include a transaction that exceeds what would be a strict per-flashblock gas limit
because executing that transaction is important for user experience or economic reasons. This flexibility is a key
advantage of the out-of-protocol approach.</p>
<p>While the specific heuristics for transaction allocation across flashblocks are not mandated by this specification,
the following section examines a common approach with linear gas limit allocation and its implications for transaction
inclusion. Builders may adopt this or alternative strategies based on their chain's transaction patterns, user
expectations, and economic models.</p>
<h4 id="linear-gas-limit-increase-and-transaction-inclusion-guarantees"><a class="header" href="#linear-gas-limit-increase-and-transaction-inclusion-guarantees">Linear Gas Limit Increase and Transaction Inclusion Guarantees</a></h4>
<p>A common heuristic for gas allocation defines the gas limit for flashblock <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> (where <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6986em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="mclose">]</span></span></span></span>) as:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"></span><span class="mord text"><span class="mord">flashblock_gas_limit</span></span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em;"></span><span class="mord text"><span class="mord">block_gas_limit</span></span></span></span></span></span></p>
<p>This linear increase means cumulative gas usage for flashblock <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> is bounded by:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"></span><span class="mord text"><span class="mord">cumulative_gas_limit</span></span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0804em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3944em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">F</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.7em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord text"><span class="mord">block_gas_limit</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:2.113em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">i</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>When optimally filling each flashblock's gas allocation, the block gas limit is reached at flashblock index <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8095em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">i</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>
and incidentally the theoretical maximum transaction gas limit <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7651em;vertical-align:-0.15em;"></span><span class="mord mathnormal">t</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> that can be included is:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:5.6241em;vertical-align:-2.562em;"></span><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.062em;"><span style="top:-5.062em;"><span class="pstrut" style="height:3.562em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">i</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.562em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:2.562em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.062em;"><span style="top:-5.062em;"><span class="pstrut" style="height:3.562em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">âŒˆ</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.562em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">âˆ’</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.885em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">8</span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span></span></span><span style="top:-2.845em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width='400em' height='1.08em' viewBox='0 0 400000 1080' preserveAspectRatio='xMinYMin slice'><path d='M95,702 c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14 c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54 c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10 s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429 c69,-144,104.5,-217.7,106.5,-221 l0 -0 c5.3,-9.3,12,-14,20,-14 H400000v40H845.2724 s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7 c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z M834 80h400000v40h-400000z'/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.155em;"><span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">âŒ‰</span></span></span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.562em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">âŒŠ</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.562em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">âˆ’</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.885em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">8</span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span></span></span><span style="top:-2.845em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width='400em' height='1.08em' viewBox='0 0 400000 1080' preserveAspectRatio='xMinYMin slice'><path d='M95,702 c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14 c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54 c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10 s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429 c69,-144,104.5,-217.7,106.5,-221 l0 -0 c5.3,-9.3,12,-14,20,-14 H400000v40H845.2724 s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7 c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z M834 80h400000v40h-400000z'/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.155em;"><span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">âŒ‹</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord text"><span class="mord">block_gas_limit</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:2.562em;"><span></span></span></span></span></span></span></span><span class="tag"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.062em;"><span style="top:-5.062em;"><span class="pstrut" style="height:3.562em;"></span><span class="eqn-num"></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.562em;"></span><span class="eqn-num"></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:2.562em;"><span></span></span></span></span></span></span></span></span></p>
<p>For example, with <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">10</span></span></span></span> flashblocks we have <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8095em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">i</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">4</span></span></span></span>.
This means that if each flashblock is optimally filled, the block gas limit is reached by flashblock 4.
The theoretical maximum transaction gas limit would be
<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord">â€˜</span><span class="mord mathnormal">t</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">4/10</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em;"></span><span class="mord text"><span class="mord">block_gas_limit</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8056em;vertical-align:-0.0556em;"></span><span class="mord">40%â€˜</span></span></span></span> of the block gas limit.</p>
<p><strong>Large Transaction Inclusion Guarantees</strong></p>
<p>A potential concern is the difficulty of including large transactions with gas limits greater than
<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">â€˜</span><span class="mopen">(</span><span class="mord">1/</span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em;"></span><span class="mord text"><span class="mord">block_gas_limit</span></span><span class="mord">â€˜</span></span></span></span> when the chain experiences heavy loads of smaller transactions.
Due to the linear increase of gas limits across flashblocks, even transactions with higher priority
may not fit in the earlier, smaller flashblocks.
If subsequent flashblocks fill up with smaller transactions, large transactions may be excluded
entirely from the block.</p>
<p>No perfect solution exists for this issue, but certain design choices can mitigate it.
With <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">10</span></span></span></span>, the theoretical maximum transaction gas limit is <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8056em;vertical-align:-0.0556em;"></span><span class="mord">40%</span></span></span></span> of the block gas limit.
Since this maximum only occurs under optimal filling conditions, transactions requiring up
to <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8056em;vertical-align:-0.0556em;"></span><span class="mord">50%</span></span></span></span> of the block gas limit can reasonably expect inclusion even under high load.
This <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8056em;vertical-align:-0.0556em;"></span><span class="mord">50%</span></span></span></span> threshold aligns with the transaction gas limit cap proposed in
<a href="https://eips.ethereum.org/EIPS/eip-7825">EIP-7825</a>.</p>
<p>A maximum of <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">6</span></span></span></span> flashblocks ensures that <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.786em;vertical-align:-0.15em;"></span><span class="mord mathnormal">t</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â‰¥</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8056em;vertical-align:-0.0556em;"></span><span class="mord">50%</span></span></span></span> of the block gas limit,
eliminating potential inclusion discrimination for transactions that comply with EIP-7825,
at the cost of slower flashblock cadence.</p>
<h3 id="post-block-execution-rules"><a class="header" href="#post-block-execution-rules">Post-block Execution Rules</a></h3>
<p>In the OP Stack protocol, certain operations such as withdrawals and system requests are applied at the end of block
execution. Since each flashblock must function as a valid standalone block for preconfirmation purposes, these
post-block execution rules must be applied at the end of each flashblock's construction.</p>
<p>When constructing a flashblock, the builder applies all required post-block operations after executing the selected
transactions. These operations modify the state according to protocol rules, ensuring the flashblock represents a
complete and valid block state.</p>
<p>However, an important implementation detail is that these post-block changes must be reverted before beginning
execution for the next flashblock. This reversion is necessary because the post-block operations should only be applied
once per actual L2 block, not cumulatively for each flashblock. Failing to revert these changes would lead to their
repeated application across multiple flashblocks, potentially creating invalid cumulative state and ultimately an
invalid final block.</p>
<h3 id="construction-steps"><a class="header" href="#construction-steps">Construction Steps</a></h3>
<p>After handling the mandatory sequencer transactions in the initial Flashblock, the External Block Builder proceeds with
constructing subsequent Flashblocks by following these steps for each interval:</p>
<ol>
<li>
<p><strong>Transaction Selection</strong></p>
<ul>
<li>Retrieve transactions from local or external mempool:</li>
<li>Prioritize and sort transactions based on predefined sequencing policies, such as priority ordering or by MEV paid.</li>
</ul>
</li>
<li>
<p><strong>Transaction Execution</strong></p>
<ul>
<li>Sequentially execute selected transactions against a state snapshot derived from the current execution payload base
(ExecutionPayloadBaseV1) or the last validated flashblock</li>
<li>Apply the transaction inclusion heuristics described earlier to determine when to stop including transactions</li>
<li>After transaction execution completes, apply all post-block execution rules as described in the Post-Block Execution
Rules section</li>
</ul>
</li>
<li>
<p><strong>Flashblock Payload Assembly</strong></p>
<ul>
<li>After transaction execution, compute and record the following execution state updates:</li>
<li><code>state_root</code>: The new post-execution state root resulting from the executed transactions.</li>
<li><code>receipts_root</code>: The receipts trie root derived from execution outcomes.</li>
<li><code>logs_bloom</code>: Aggregated logs bloom from all emitted transaction logs within this flashblock.</li>
<li><code>gas_used</code>: Total gas consumed by executed transactions.</li>
<li><code>transactions</code>: Serialized transaction payloads included within the flashblock.</li>
<li><code>withdrawals</code> (if applicable): Withdrawals executed during the current flashblock interval (as per OP Stack
withdrawal specification).</li>
<li><code>block_hash</code>: Computed block hash uniquely identifying this flashblock execution state.</li>
</ul>
<p>Note that each flashblock builds upon the state of all previous flashblocks, with these fields reflecting the
cumulative state after applying the new transactions in this particular flashblock.</p>
<ul>
<li>Encapsulate these computed updates into <code>ExecutionPayloadFlashblockDeltaV1</code>.</li>
</ul>
</li>
<li>
<p><strong>Flashblock Indexing and Metadata</strong></p>
<ul>
<li>Assign a monotonically incremented <code>index</code> to the newly constructed Flashblock payload.</li>
<li>Compute the SSZ hash of the previous Flashblock and assign it as the <code>parent_flash_hash</code> (for the first Flashblock
with index 0, this field is empty)</li>
</ul>
</li>
<li>
<p><strong>Flashblock Delivery</strong></p>
<ul>
<li>Package the <code>index</code>, <code>payload_id</code>,  <code>ExecutionPayloadFlashblockDeltaV1</code>, and metadata into a <code>FlashblocksPayloadV1</code>
payload.</li>
<li>Deliver the assembled <code>FlashblocksPayloadV1</code> payload promptly to Rollup Boost via the designated Flashblocks
submission API.</li>
</ul>
</li>
<li>
<p><strong>Subsequent Flashblock Construction</strong></p>
<ul>
<li>Immediately after successful delivery, increment the Flashblock <code>index</code>.</li>
<li>Revert any post-block execution changes as described in the Post-Block Execution Rules section</li>
<li>Reset the transaction execution context based on the newly delivered state.</li>
<li>Begin constructing the next <code>FlashblocksPayloadV1</code> payload, repeating from step 1 until a termination condition is
reached (e.g., end of block building period via <code>engine_getPayload</code> request).</li>
</ul>
</li>
<li>
<p><strong>Flashblock Construction Termination</strong></p>
<ul>
<li>Flashblock construction continues iteratively until:</li>
<li>Rollup Boost signals final block aggregation and propagation via <code>engine_getPayload</code>.</li>
<li>A failure or timeout condition arises requiring failover procedures, detailed separately.</li>
</ul>
</li>
</ol>
<pre class="mermaid">sequenceDiagram
    participant BB as External Block Builder
    participant RB as Rollup Boost
    participant EE as Execution Engine (local)
    participant M as Mempool

    loop Every FLASHBLOCKS_TIME
        BB-&gt;&gt;M: Retrieve and Prioritize Transactions
        M--&gt;&gt;BB: Transactions batch
        Note over BB: Execute transactions sequentially
        BB-&gt;&gt;EE: Execute transactions and compute state root
        EE--&gt;&gt;BB: Execution results (state root, receipts, gas used)

        Note over BB: Construct Flashblock Delta
        BB-&gt;&gt;BB: Assemble FlashblocksPayloadV1 (state_root, receipts_root, logs_bloom, gas_used, block_hash, txs,
withdrawals, metadata)

        BB-&gt;&gt;RB: Submit FlashblocksPayloadV1
        RB--&gt;&gt;BB: Acknowledge reception (async)
        Note over BB: Increment index, prepare next Flashblock
    end
</pre>
<h2 id="flashblocks-metadata"><a class="header" href="#flashblocks-metadata">Flashblocks Metadata</a></h2>
<p>TheÂ <code>FlashblocksPayloadV1</code>Â structure defined above contains the minimum required data for Rollup Boost to return a
valid block. TheÂ <code>metadata</code>Â field provides additional information to enable preconfirmations.</p>
<p>This metadata contains supplementary information about the execution state that is not strictly necessary for block
construction but is valuable for RPC providers to offer comprehensive preconfirmation services. Examples of such
metadata include:</p>
<ul>
<li>Account state changes (which accounts have been modified)</li>
<li>Updated account balances</li>
<li>Storage slot modifications</li>
<li>Contract deployment information</li>
<li>Detailed transaction execution results</li>
</ul>
<h3 id="alternative-design-consideration"><a class="header" href="#alternative-design-consideration">Alternative Design Consideration</a></h3>
<p>While this specification includes detailed metadata in Flashblocks, a viable alternative would be for RPC providers to
execute transactions themselves as they receive them through the stream. In this approach, providers would receive only
transaction data, execute them in order, maintain their own state cache, and use it to fulfill RPC requests. This would
significantly reduce bandwidth requirements by eliminating metadata transmission.</p>
<h2 id="rationale-for-including-state-roots-in-flashblocks"><a class="header" href="#rationale-for-including-state-roots-in-flashblocks">Rationale for Including State Roots in Flashblocks</a></h2>
<p>One of the most discussed aspects of the Flashblocks design is the decision to include state roots with every
flashblock. This section explains the rationale behind this design choice.</p>
<h3 id="non-blocking-block-production"><a class="header" href="#non-blocking-block-production">Non-Blocking Block Production</a></h3>
<p>We operate under the assumption that <code>engine_getPayload</code> requests should return quickly with a valid, complete block.
This assumption, which we believe to be correct based on our understanding of the OP Stack, guides our design decisions.</p>
<p>Currently in OP Stack implementations, execution layer nodes compute payloads in the background and can return them
immediately when requested via <code>engine_getPayload</code>. This allows for near-instant responses, maintaining the flow of
block production without delays. For Flashblocks to provide similar performance, it must have all block components -
including state roots - readily available when <code>engine_getPayload</code> is called.</p>
<p>Without pre-computed state roots for each flashblock, Rollup Boost would face a critical decision when handling
<code>engine_getPayload</code>:</p>
<ol>
<li><strong>Request the state root from the Execution Layer</strong>: This approach would be problematic because the Execution Layer
does not maintain a "hot" state that matches the current flashblock sequence. It would need to apply all pending
transactions and compute a new state root, which is exactly the operation we're trying to optimize with flashblocks.</li>
<li><strong>Request the state root from the External Block Builder</strong>: This would require an additional synchronous request to
the builder with a protocol which is not engine-specific. Not only does this introduce an extra communication hop and
latency, but it also creates a single point of failure - if the builder is unavailable at that moment, Rollup Boost
cannot fulfill the request and we fall into the failure path rather than the happy path.</li>
</ol>
<h3 id="builder-availability-and-system-reliability"><a class="header" href="#builder-availability-and-system-reliability">Builder Availability and System Reliability</a></h3>
<p>The key advantage of including state roots with each flashblock is system reliability. By having state roots
immediately available, Rollup Boost can respond to <code>engine_getPayload</code> requests without additional external
dependencies at that critical moment.</p>
<p>Without pre-included state roots, a builder failure at the moment of block production would force the system to either:</p>
<ol>
<li>Recompute the entire state from scratch (time-consuming and potentially disruptive)</li>
<li>Fail to produce a block on time (violating protocol assumptions)</li>
<li>Be unable to fulfill the preconfirmations that have already been exposed to users</li>
</ol>
<h3 id="future-design-considerations"><a class="header" href="#future-design-considerations">Future Design Considerations</a></h3>
<p>This approach represents our current understanding of the optimal design given existing constraints. However, as
mentioned in the Out-of-Protocol Design section, alternative approaches may be worth exploring as we gain production
experience. Future iterations might consider different state root handling approaches, particularly in the context of
high-availability sequencer setups and deeper integration with OP Stack components.</p>
<h2 id="builder-to-rollup-boost-communication-flow"><a class="header" href="#builder-to-rollup-boost-communication-flow">Builder-to-Rollup-boost Communication Flow</a></h2>
<p>Rollup Boost maintains an open WebSocket connection with the External Block Builder. Through this persistent
connection, the builder pushes theÂ <code>FlashblocksPayloadV1</code>Â payloads as soon as they're constructed, without waiting for
requests from Rollup Boost.</p>
<p>If the WebSocket connection goes down, the builder buffers (queues) the messages internally and attempts to resend them
once the connection is restored. This buffering only applies for the current block being built; when a new block cycle
begins, any queued messages from the previous block are discarded as they are no longer relevant to the current state.</p>
<p><strong>SSZ Encoding for Flashblocks Messages</strong></p>
<p>Flashblocks messages transmitted between the Block Builder and Rollup Boost use Simple Serialize (SSZ) for binary
encoding. Unlike JSON or other self-describing formats, SSZ is schema-less and does not embed field names or type
information in the serialized data. This makes explicit versioning necessary, especially in a streaming context where
message types cannot be inferred from surrounding context.</p>
<p>For the <code>FlashblocksPayloadV1</code> structure, a version field is placed as the first field in the container.</p>
<p>This design leverages SSZ's deterministic encoding characteristics, where fixed-size fields like <code>Bytes4</code> appear at
predictable offsets in the serialized data. When a recipient receives a serialized Flashblocks message over the
WebSocket stream:</p>
<ol>
<li>It first reads the initial 4 bytes to determine the message version</li>
<li>Based on the version identifier, it selects the appropriate container structure for deserializing the remainder of
the data</li>
</ol>
<h2 id="flashblock-validity-rules"><a class="header" href="#flashblock-validity-rules">Flashblock Validity Rules</a></h2>
<p>For a flashblock to be considered valid the following must hold:</p>
<ul>
<li>
<p><strong>Monotonically Increasing Payload Index:</strong> Each successive Flashblock payload delivered within the same L2 block
cycle must have an index exactly one greater than the previous payload. Any skipped indices or duplicated indices
constitute a violation. When a violation occurs, Rollup Boost will ignore the invalid flashblock and maintain its
internal state, only updating when it receives a new flashblock with the correct next index value.</p>
</li>
<li>
<p><strong>Immutable Payload Base:</strong> Immutable block header fields (<code>parent_hash</code>, <code>block_number</code>, <code>prev_randao</code>, etc.) set by
the initial <code>ExecutionPayloadBaseV1</code> cannot be altered by subsequent Flashblocks during the same L2 block period.</p>
</li>
<li>
<p><strong>Execution Validity:</strong> Every Flashblock must be validated successfully against the Sequencerâ€™s local execution
engine state to ensure OP protocol-level correctness.</p>
</li>
<li>
<p><strong>Valid Full Block:</strong> Every flashblock, when combined with prior flashblocks, should be a valid L2 Block without
requiring Rollup Boost to perform any additional operations other than repackaging the data structure. This means that
state roots are calculated on each Flashblock contrary to publication due to the out-of-protocol nature of the
implementation.</p>
<p>A flashblock is considered a valid block if:</p>
</li>
<li>
<p>It includes the first flashblock (with index 0 containing the base data)</p>
</li>
<li>
<p>It comprises a continuous sequence of flashblocks with incrementing indices.</p>
</li>
</ul>
<h2 id="flashblock-system-invariants"><a class="header" href="#flashblock-system-invariants">Flashblock System Invariants</a></h2>
<p>The following invariants must hold true for the Flashblocks protocol to function reliably:</p>
<ul>
<li><strong>No Equivocation:</strong> At no point should multiple distinct Flashblocks for the same payload index be delivered or
propagated to RPC subscribers.</li>
<li><strong>Preconfirmation Preservation:</strong>Â The system always gives strong preference to maintaining the integrity of issued
preconfirmations. Once a transaction has been included in a flashblock and made visible to users as preconfirmed, the
system will prioritize preserving this state over other considerations such as block value optimization or alternative
builder selection.</li>
</ul>
<h2 id="flashblock-propagation"><a class="header" href="#flashblock-propagation">Flashblock Propagation</a></h2>
<p>Once Rollup Boost has validated a flashblock, it is then propagated to the rest of the network to be included in each
RPC Providerâ€™s Preconfirmation state.</p>
<pre class="mermaid">sequenceDiagram
    participant B as Block Builder
    participant R as Rollup-boost
    box Node
    participant RPC as JSON-RPC Interface
    end
    participant U as Users

    B-&gt;&gt;R: Preconfirmation batches
    R-&gt;&gt;R: Validate batches
    R-&gt;&gt;RPC: Preconfirmation updates
    U-&gt;&gt;RPC: Standard RPC queries
    note right of U: Regular users
</pre>
<p>Flashblocks Compatible RPC Providers subscribe to the Flashblocks websocket stream from Rollup Boost and maintain an
in-memory representation of the preconfirmation state. RPC providers validate that the flashblock sequence is correct
before updating their preconfirmation state. This preconfirmation state is ephemeral, maintained only until the
corresponding block is propagated and the information becomes available through standard chain state.</p>
<p>Throughout the entire propagation path, flashblocks are transmitted in binary SSZ-encoded format.</p>
<h3 id="secure-propagation"><a class="header" href="#secure-propagation">Secure propagation</a></h3>
<p>Since the preconfirmation data originates directly from the Sequencer's Rollup Boost instance, exposing this WebSocket
endpoint directly to external parties presents security and scalability concerns. Instead, a reverse proxy should be
implemented between Rollup Boost and external RPC providers to relay this information securely.</p>
<p>This mirror simply relays WebSocket data without requiring any Flashblocks-specific knowledge, acting purely as a
transport layer that forwards WebSocket messages from Rollup Boost to subscribed RPC providers. You can find an example
implementation in the <a href="https://github.com/base/flashblocks-websocket-proxy">flashblocks-websocket-proxy repository</a>.</p>
<pre class="mermaid">flowchart TD
    subgraph Sequencer
        BB[Block Builder]
        RB[Rollup Boost]
        Mirror[Flashblocks Mirror]
    end

    subgraph RPC Providers
        RPC1[RPC Provider 1]
        RPC2[RPC Provider 2]
        RPC3[RPC Provider 3]
        RPCN[RPC Provider N]
    end

    BB --&gt;|Flashblocks| RB
    RB --&gt;|Flashblocks| Mirror
    Mirror --&gt;|Flashblocks| RPC1
    Mirror --&gt;|Flashblocks| RPC2
    Mirror --&gt;|Flashblocks| RPC3
    Mirror --&gt;|Flashblocks| RPCN
</pre>
<h2 id="flashblock-json-rpc-apis"><a class="header" href="#flashblock-json-rpc-apis">Flashblock JSON-RPC APIs</a></h2>
<h3 id="ethereum-json-rpc-modifications"><a class="header" href="#ethereum-json-rpc-modifications">Ethereum JSON RPC Modifications</a></h3>
<p>All modifications done to the existing Ethereum JSON RPC methods are confined to overloading the existing <code>pending</code>
tag except a few JSON RPC methods which become inherently aware of preconfirmation state.
Originally, this tag was designed to return block data being processed by the node's internal miner. It's fitting
that we now use it for a similar purpose: exposing blocks in their preconfirmation stage. When queried with the
<code>pending</code> tag, the endpoint uses the preconfirmation state state to construct the response. The response might include
not only transactions but also block metadata like state root and receipt root.</p>
<p>The tag is currently in a soft-deprecated state due to inconsistent implementations across clients, particularly after
The Merge. However, it's worth noting that it's still actively used for certain endpoints, particularly
<code>eth_getTransactionCount</code> where it serves the important function of returning the next available nonce for an account
(including transactions in the mempool). This presents an opportunity: the tag is well-defined enough to be supported
by client libraries, yet loosely defined enough to allow for our preconfirmation use case. While there's a possibility
of the tag being removed in the future (seeÂ <a href="https://github.com/ethereum/execution-apis/issues/495">EIP discussions</a>),
the design could adapt by introducing a flashblocks-specific tag if needed.</p>
<p>We repurpose the <code>pending</code> tag in the following RPC calls to enable consuming preconfirmed state:</p>
<ul>
<li>eth_call</li>
<li>eth_estimateGas</li>
<li>eth_getBlockByNumber</li>
<li>eth_getBalance</li>
<li>eth_getTransactionCount</li>
<li>eth_getCode</li>
<li>eth_getStorageAt</li>
</ul>
<p><strong>Note: not all RPC methods explicitly require a "pending" tag to tap into the Flashblocks' state's awareness</strong></p>
<p>The following RPC methods implicitly incorporate Flashblocks awareness like that whenever possible:</p>
<ul>
<li>eth_getTransactionReceipt</li>
<li>eth_getTransactionByHash</li>
</ul>
<h3 id="op_supportedcapabilities"><a class="header" href="#op_supportedcapabilities">op_supportedCapabilities</a></h3>
<p>This endpoint allows clients to discover whether the RPC provider supports certain features, including Flashblocks.</p>
<p><strong>Request</strong></p>
<pre><code class="language-json">{
  "method": "op_supportedCapabilities",
  "params": [],
  "id": 1,
  "jsonrpc": "2.0"
}
</code></pre>
<p><strong>Response</strong></p>
<pre><code class="language-json">{
  "id": 1,
  "jsonrpc": "2.0",
  "result": ["flashblocksv1"]
}
</code></pre>
<p>When this method is called on a Flashblocks-compatible RPC provider, the response includes "flashblocksv1" in the
returned array of supported capabilities. This allows clients to programmatically determine whether they can utilize
Flashblocks functionality before making related requests.</p>
<p>This endpoint follows a similar pattern to the Engine API's <code>engine_exchangeCapabilities</code> method, which allows
consensus and execution clients to exchange information about supported features.</p>
<p>This is the only new RPC endpoint introduced by the Flashblocks specification. We consider this addition acceptable
because it provides necessary feature discovery while keeping the name abstract enough to accommodate future extensions
to the protocol or for other protocols.</p>
<p><strong><code>eth_getTransactionReceipt</code></strong></p>
<p><strong>Request</strong></p>
<pre><code class="language-json">{
  "method": "eth_getTransactionReceipt",
  "params": ["0x..."],// Transaction hash
  "id": 1,
  "jsonrpc": "2.0"
}
</code></pre>
<p><strong>Response</strong></p>
<pre><code class="language-json">{
  "transactionHash": "0x...",
  "blockHash": "0x0",  // Empty hash as placeholder
  "blockNumber": "0x...",       // Current pending block number
  "transactionIndex": "0x0",
  "from": "0x...",
  "to": "0x...",
  "gasUsed": "0x...",
  "status": "0x1",
  "cumulativeGasUsed": "0x...",
  "effectiveGasPrice": "0x...",
  "contractAddress": "0x...",   // For contract creations
  "logs": [],
  "logsBloom": "0x..."
}
</code></pre>
<p>When queried, this endpoint first checks the preconfirmation state for the requested transaction hash before falling
back to the standard chain state lookup.</p>
<p>Some fields in the response cannot be final at the preconfirmation stage and require placeholder values:</p>
<ul>
<li><code>blockHash</code>: Uses empty hash as placeholder</li>
<li><code>blockNumber</code>: Can be set to the current block number being processed</li>
</ul>
<p><strong><code>eth_getTransactionByHash</code></strong></p>
<p><strong>Request</strong></p>
<pre><code class="language-json">{
  "method": "eth_getTransactionByHash",
  "params": ["0x..."], // Transaction hash of the potentially pre-confirmed transaction
  "id": 1,
  "jsonrpc": "2.0"
}
</code></pre>
<p><strong>Response</strong></p>
<pre><code class="language-json">{
  "id": 1,
  "result": {
    "blockHash": "0x...", 
    "blockNumber": "0x...",
    "hash": "0x...",
    "transactionIndex": "0x0",
    "type": "0x2",
    "nonce": "0x...",
    "from": "0x...",
    "to": "0x...",
    "gas": "0x...",
    "value": "0x...",
    "gasPrice": "0x...",
    "chainId": "0x..."
  },
  "jsonrpc": "2.0"
}
</code></pre>
<p>When queried, this endpoint first checks the preconfirmation state for the requested transaction hash before falling
back to the standard chain state lookup.</p>
<p>Some fields in the response cannot be final at the preconfirmation stage and require placeholder values:</p>
<ul>
<li><code>blockHash</code>: Uses the block hash of pending block at the time transaction was pre-confirmed.</li>
<li><code>blockNumber</code>: Can be set to the current block number being processed</li>
</ul>
<p><strong><code>eth_getBlockByNumber</code></strong></p>
<p><strong>Request</strong></p>
<pre><code class="language-json">{
  "method": "eth_getBlockByNumber",
  "params": ["pending", false],  // Second parameter indicates full transaction objects (true) or only hashes (false)
  "id": 1,
  "jsonrpc": "2.0"
}
</code></pre>
<p><strong>Response</strong></p>
<pre><code class="language-json">{
  "hash": "0x0",  // Empty hash as placeholder
  "parentHash": "0x...",
  "stateRoot": "0x...",
  "transactionsRoot": "0x...",
  "receiptsRoot": "0x...",
  "number": "0x...",  // Current pending block number
  "gasUsed": "0x...",
  "gasLimit": "0x...",
  "timestamp": "0x...",
  "extraData": "0x...",
  "mixHash": "0x...",
  "nonce": "0x...", // // Used to signal flashblock index
  "transactions": []  // Array of transaction hashes or full transaction objects
}
</code></pre>
<p>The endpoint implements an append-only pattern - multiple queries during the same block's preconfirmation phase will
show an expanding list of transactions as new flashblocks are processed. Each query reflects the current state of all
preconfirmed transactions at that moment.</p>
<pre class="mermaid">sequenceDiagram
    participant U as User
    participant RPC
    participant R as Rollup-boost

    Note over R: Block building starts
    R-&gt;&gt;RPC: Batch 1 (txs: A, B)

    U-&gt;&gt;RPC: Query 1
    RPC--&gt;&gt;U: Block with txs: A, B

    R-&gt;&gt;RPC: Batch 2 (txs: C, D)
    U-&gt;&gt;RPC: Query 2
    RPC--&gt;&gt;U: Block with txs: A, B, C, D

    R-&gt;&gt;RPC: Batch 3 (txs: E)
    U-&gt;&gt;RPC: Query 3
    RPC--&gt;&gt;U: Block with txs: A, B, C, D, E

    R-&gt;&gt;RPC: Batch 4 (txs: F, G)
    U-&gt;&gt;RPC: Query 4
    RPC--&gt;&gt;U: Block with txs: A, B, C, D, E, F, G

    Note over R: Block sealed
</pre>
<p><strong><code>eth_getBalance</code></strong></p>
<p><strong>Request</strong></p>
<pre><code class="language-json">{
  "method": "eth_getBalance",
  "params": ["0x...", "pending"],  // Account address and block parameter
  "id": 1,
  "jsonrpc": "2.0"
}
</code></pre>
<p><strong>Response</strong></p>
<pre><code class="language-json">"0x..." // Balance in wei
</code></pre>
<p>When queried with the "pending" tag, the endpoint uses the preconfirmation state state to return the account balance.
If the requested account appears in theÂ <code>AccountMetadata</code>Â of a received Flashblock with a non-nullÂ <code>balance</code>Â field, the
RPC provider can directly return this value without needing to access the full state. The response reflects all changes
from preconfirmed transactions that affect the requested account's balance.</p>
<p><strong><code>eth_call</code></strong></p>
<p><strong>Request</strong></p>
<pre><code class="language-json">{
  "method": "eth_call",
  "params": [{"to": "0x...", "data": "0x..."}, "pending"],  // Transaction call object and block parameter
  "id": 1,
  "jsonrpc": "2.0"
}
</code></pre>
<p><strong>Response</strong></p>
<pre><code class="language-json">"0x..." // Return data from the call
</code></pre>
<p>When queried with the "pending" tag, the endpoint uses the preconfirmation state state to return the call result. For
this endpoint to work, the preconfirmation stream needs to include state differences for both accounts and storage
after each flashblock.</p>
<p>Similar to the current override functionality in <code>eth_call</code> where EVM transitions are executed on top of modified
state, this implementation executes the call on top of the preconfirmation state changes.</p>
<p><strong><code>eth_estimateGas</code></strong></p>
<p>Generates and returns an estimate of how much gas is necessary to allow the
transaction to complete considering the latest pre-confirmed state.</p>
<p><strong>Request</strong></p>
<pre><code class="language-json">{
  "jsonrpc": "2.0",
  "method": "eth_estimateGas",
  "params": [{"from":"0x...","to":"0x...","value":"0x..."}, "pending"],
  "id": 1
}
</code></pre>
<p><strong>Response</strong></p>
<pre><code class="language-json">{
  "jsonrpc": "2.0",
  "id": "1",
  "result": "0x..." // The estimated amount of gas required for the transaction, as a hexadecimal string.
}
</code></pre>
<p><strong><code>eth_getCode</code></strong></p>
<p><strong>Request</strong></p>
<pre><code class="language-json">{
  "method": "eth_getCode",
  "params": ["0x...", "pending"],// Contract address and block parameter
  "id": 1,
  "jsonrpc": "2.0"
}
</code></pre>
<p><strong>Response</strong></p>
<pre><code class="language-json">"0x..."// Contract bytecode
</code></pre>
<p>When queried with the "pending" tag, the endpoint returns the contract bytecode from the preconfirmation state state.
If the requested account appears in theÂ <code>AccountMetadata</code>Â of a received Flashblock with a non-nullÂ <code>code</code>Â field, the
RPC provider can directly return this value without accessing the full state.</p>
<p><strong><code>eth_getTransactionCount</code></strong></p>
<p><strong>Request</strong></p>
<pre><code class="language-json">{
  "method": "eth_getTransactionCount",
  "params": ["0x...", "pending"],// Account address and block parameter
  "id": 1,
  "jsonrpc": "2.0"
}
</code></pre>
<p><strong>Response</strong></p>
<pre><code class="language-json">"0x..."// Nonce value as a hex string
</code></pre>
<p>When queried with the "pending" tag, the endpoint returns the transaction count (nonce) of the account from the
preconfirmation state. If the requested account appears in theÂ <code>AccountMetadata</code>Â of a received Flashblock, the RPC
provider can directly use theÂ <code>nonce</code>Â field without additional state access.</p>
<p><strong><code>eth_getStorageAt</code></strong></p>
<p><strong>Request</strong></p>
<pre><code class="language-json">{
  "method": "eth_getStorageAt",
  "params": ["0x...", "0x...", "pending"],// Contract address, storage position, and block parameter
  "id": 1,
  "jsonrpc": "2.0"
}
</code></pre>
<p><strong>Response</strong></p>
<pre><code class="language-json">"0x..." // Storage value as a hex string
</code></pre>
<p>When queried with the "pending" tag, the endpoint returns the value from the specified storage slot using the
preconfirmation state state. If the requested account appears in theÂ <code>AccountMetadata</code>Â of a received Flashblock, the
RPC provider scans theÂ <code>storage_slots</code>Â list for the requested key and returns the corresponding value directly.</p>
<h1 id="reliability-and-operational-considerations"><a class="header" href="#reliability-and-operational-considerations">Reliability and Operational Considerations</a></h1>
<h2 id="transaction-propagation"><a class="header" href="#transaction-propagation">Transaction Propagation</a></h2>
<p>Similar to the design laid out in the <a href="https://github.com/ethereum-optimism/">External Block Production</a> design
document, Flashblocks makes no assumptions about how transactions are delivered to the block builder. A non-exhaustive
list of valid approaches:</p>
<ul>
<li>transaction forwarding via mutliplexâ€™ing software at the Rollup Operatorâ€™s RPC</li>
<li>Private p2p connections between Sequencer transaction ingress nodes and block building nodes</li>
</ul>
<h2 id="failover-scenarios"><a class="header" href="#failover-scenarios">Failover scenarios</a></h2>
<h3 id="block-builder"><a class="header" href="#block-builder">Block Builder</a></h3>
<p>As per the normal Rollup-boost behavior, if the builder is down, the Rollup-boost picks up the block from the fallback
builder. However, since we are dealing with preconfirmations, we must consider the relative value of preserving
preconfirmations versus building a potentially more valuable block.</p>
<p>In this design document, we follow the invariant that preserving preconfirmations takes precedence. If the block
builder goes down after the first flashblocks have been delivered, we still return those flashblocks to maintain the
integrity of any preconfirmations already issued to users. The next block would work as expected through the normal
fallback mechanism, as the builder is down and the fallback builder would be used.</p>
<p>We could technically discard the partial flashblocks and use the fallback block entirely, but this would violate the
preconfirmations commitment. Our design assumes normal execution conditions. If losing the builder mid-flashblock
becomes a common occurrence, this would indicate fundamental architectural issues that require separate improvements
beyond the scope of this failover mechanism.</p>
<h3 id="the-sequencer-or-rollup-boost"><a class="header" href="#the-sequencer-or-rollup-boost">The Sequencer or Rollup-boost</a></h3>
<p>These failure scenarios are addressed as part of the High Availability (HA) sequencer setups. The HA architecture
ensures continuity of operations by automatically failing over to standby instances when failures occur.</p>
<h2 id="integration-with-high-availability-sequencer-setups"><a class="header" href="#integration-with-high-availability-sequencer-setups">Integration with High Availability Sequencer Setups</a></h2>
<p>The integration of Flashblocks with High Availability (HA) Sequencer setups is outside the scope of this initial
specification document. For details on managing Flashblock state across multiple sequencer instances and maintaining
preconfirmation integrity during failovers, please refer to the resources linked below.</p>
<ul>
<li>what do with a rotating set of sequencers like with OP conductor
<a href="https://github.com/ethereum-optimism/optimism/tree/develop/op-conductor">op-conductor</a></li>
<li>World HA design discussion<a href="https://github.com/flashbots/">flashbots</a></li>
<li>Base Technical Design Document <a href="https://www.notion.so/TDD-Rollup-Boost-Integration-with-HA-Sequencer-1d0c9d820ca380348f21e44a5442feaf?pvs=21">TDD: Rollup Boost Integration with HA
Sequencer</a></li>
</ul>
<h2 id="faults"><a class="header" href="#faults">Faults</a></h2>
<h3 id="safety-faults"><a class="header" href="#safety-faults"><strong>Safety Faults</strong></a></h3>
<p>In the rollup security vocabulary <em>safety</em> implies that â€œ<strong>no one can create or withdraw assets they are not entitled
to.</strong>â€ A <strong>safety fault</strong> therefore occurs the moment an <strong>invalid L2 state root</strong> is accepted on Ethereum <strong>and</strong> at
least one L2â†’L1 action (withdrawal, message relay, etc.) that depends on that root is executed <strong>and</strong> the dispute game
period has ended. After that point the canonical record on Ethereum says the invalid state is <em>final</em> and the rollupâ€™s
honesty assumption is broken.</p>
<p>The safety of a flashblock is directly equivalent to the safety of an L2 block. Additionally, on each submission of a
flashblock to Rollup Boost, it is simulated against the Sequencerâ€™s local execution engine, ensuring the Block
Builderâ€™s view is equivalent to the Sequencerâ€™s.</p>
<p>The real thing we are interested in regards to safety faults for the Flashblock stream is whether they can be reorged.
The answer to this question is that the preconfirmed state can be reorged out if the Sequencer reorgs. Given that the
sequencer is the one validating the block builder blocks, then there is no additional risk of reorg from the
introduction of the External Block Builder and Flashblocks stream, as in both cases, the reorg is due to Sequencer
Operator error.</p>
<h3 id="liveness-faults"><a class="header" href="#liveness-faults"><strong>Liveness Faults</strong></a></h3>
<p>In the rollup vocabulary *Liveness implies that â€œ*every honest user can (a) get a transaction included within a bounded
time and (b) complete a withdrawal within the 7â€‘day challenge window.â€ A <strong>liveness fault</strong> is any condition that makes
either promise untrue <em>without violating safety</em> (no invalid state is accepted).</p>
<p>The liveness of a flashblock is therefore directly equivalent to the liveness of L2 blocks as userâ€™s are able to force
include via the L1 as normal.</p>
<h1 id="rationale"><a class="header" href="#rationale">Rationale</a></h1>
<h2 id="why-out-of-protocol"><a class="header" href="#why-out-of-protocol">Why out-of-protocol</a></h2>
<p>The design is implemented as an out-of-protocol solution rather than a core protocol modification to allow for faster
iteration and development. This approach respects the stability guarantees of the OP Stack while allowing participants
to adopt the features at their own pace.</p>
<p>We do not, however, discard the possibility of enshrining these features inside the OP Stack protocol as both teams
become more comfortable working together and more familiar with the specification. This out-of-protocol approach serves
as a proving ground that can inform a potential future core integration.</p>
<h3 id="why-not-shorter-block-times"><a class="header" href="#why-not-shorter-block-times">Why not shorter block times</a></h3>
<p>While reducing block times is a potential solution, it would require non-trivial changes to the OP Stack codebase,
where the current minimum timestamp used is 1 second. Additionally, extremely short block times (sub-200ms) might
introduce significant performance issues in other blockchain infrastructure like block explorers and indexers.</p>
<p>Flashblocks provide a more balanced approach: they maintain reasonable block times for network decentralization and
stability, while offering a fast-lane feedback mechanism for users who need immediate transaction status.</p>
<p>This approach also opens the door to an interesting possibility: chains could potentially implement longer block times
(tens of seconds) while still maintaining quick preconfirmations via Flashblocks. This combination might enable new and
interesting use cases that benefit from both paradigms.</p>
<h1 id="backwards-compatibility"><a class="header" href="#backwards-compatibility">Backwards Compatibility</a></h1>
<h2 id="end-users"><a class="header" href="#end-users">End Users</a></h2>
<p>At present, consuming Flashblocks data is completely opt-in through the use of the <code>pending</code> tag, therefore once turned
on, no applications will require changes to how they consume data from their RPC. Instead an additional opt-in flow is
enabled.</p>
<h2 id="infrastructure-operators"><a class="header" href="#infrastructure-operators">Infrastructure Operators</a></h2>
<p>For Sequencer Operators, Flashblocks and Rollup Boost can be enabled and disabled with no additional harm to the system.</p>
<p>For RPC Operators, Flashblocks will require a modified RPC node that subscribes to the Flashblock stream in addition to
maintaining a Preconfirmation state and responding with the relevant data on request with the <code>pending</code> tag.</p>
<h1 id="implementation"><a class="header" href="#implementation">Implementation</a></h1>
<p>A feature complete implementation of all components described in this document can be found in the
<a href="https://github.com/flashbots/">rollup-boost</a>
<a href="https://github.com/flashbots/">op-rbuilder</a>
<a href="https://github.com/base/flashblocks-websocket-proxy">flashblocks-websocket-proxy</a>, and
<a href="https://github.com/danyalprout/reth-flashblocks">reth-flashblocks</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="fault-proof"><a class="header" href="#fault-proof">Fault Proof</a></h1>
<!-- markdownlint-disable -->
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="fault-proof/index.html#overview">Overview</a></li>
<li><a href="fault-proof/index.html#pre-image-oracle">Pre-image Oracle</a>
<ul>
<li><a href="fault-proof/index.html#pre-image-key-types">Pre-image key types</a>
<ul>
<li><a href="fault-proof/index.html#type-0-zero-key">Type <code>0</code>: Zero key</a></li>
<li><a href="fault-proof/index.html#type-1-local-key">Type <code>1</code>: Local key</a></li>
<li><a href="fault-proof/index.html#type-2-global-keccak256-key">Type <code>2</code>: Global keccak256 key</a></li>
<li><a href="fault-proof/index.html#type-3-global-generic-key">Type <code>3</code>: Global generic key</a></li>
<li><a href="fault-proof/index.html#type-4-global-sha2-256-key">Type <code>4</code>: Global SHA2-256 key</a></li>
<li><a href="fault-proof/index.html#type-5-global-eip-4844-point-evaluation-key">Type <code>5</code>: Global EIP-4844 Point-evaluation key</a></li>
<li><a href="fault-proof/index.html#type-6-global-precompile-key">Type <code>6</code>: Global Precompile key</a></li>
<li><a href="fault-proof/index.html#type-7-128-reserved-range">Type <code>7-128</code>: reserved range</a></li>
<li><a href="fault-proof/index.html#type-129-255-application-usage">Type <code>129-255</code>: application usage</a></li>
</ul>
</li>
<li><a href="fault-proof/index.html#bootstrapping">Bootstrapping</a></li>
<li><a href="fault-proof/index.html#hinting">Hinting</a></li>
<li><a href="fault-proof/index.html#pre-image-communication">Pre-image communication</a></li>
</ul>
</li>
<li><a href="fault-proof/index.html#fault-proof-program">Fault Proof Program</a>
<ul>
<li><a href="fault-proof/index.html#prologue">Prologue</a></li>
<li><a href="fault-proof/index.html#main-content">Main content</a></li>
<li><a href="fault-proof/index.html#epilogue">Epilogue</a></li>
<li><a href="fault-proof/index.html#pre-image-hinting-routes">Pre-image hinting routes</a>
<ul>
<li><a href="fault-proof/index.html#l1-block-header-blockhash"><code>l1-block-header &lt;blockhash&gt;</code></a></li>
<li><a href="fault-proof/index.html#l1-transactions-blockhash"><code>l1-transactions &lt;blockhash&gt;</code></a></li>
<li><a href="fault-proof/index.html#l1-receipts-blockhash"><code>l1-receipts &lt;blockhash&gt;</code></a></li>
<li><a href="fault-proof/index.html#l1-precompile-precompile--inputbytes"><code>l1-precompile &lt;precompile ++ inputbytes&gt;</code></a></li>
<li><a href="fault-proof/index.html#l2-block-header-blockhash-chainid"><code>l2-block-header &lt;blockhash&gt; &lt;chainID&gt;?</code></a></li>
<li><a href="fault-proof/index.html#l2-transactions-blockhash-chainid"><code>l2-transactions &lt;blockhash&gt; &lt;chainID&gt;?</code></a></li>
<li><a href="fault-proof/index.html#l2-receipts-blockhash-chainid"><code>l2-receipts &lt;blockhash&gt; &lt;chainID&gt;</code></a></li>
<li><a href="fault-proof/index.html#l2-code-codehash-chainid"><code>l2-code &lt;codehash&gt; &lt;chainID&gt;?</code></a></li>
<li><a href="fault-proof/index.html#l2-state-node-nodehash-chainid"><code>l2-state-node &lt;nodehash&gt; &lt;chainID&gt;?</code></a></li>
<li><a href="fault-proof/index.html#l2-output-outputroot-chainid"><code>l2-output &lt;outputroot&gt; &lt;chainID&gt;?</code></a></li>
<li><a href="fault-proof/index.html#l2-payload-witness-payload_attributes"><code>l2-payload-witness &lt;payload_attributes&gt;</code></a></li>
<li><a href="fault-proof/index.html#l2-account-proof-blockhash_and_address"><code>l2-account-proof &lt;blockhash_and_address&gt;</code></a></li>
<li><a href="fault-proof/index.html#l2-block-data-blockhash"><code>l2-block-data &lt;blockhash&gt;</code></a></li>
</ul>
</li>
<li><a href="fault-proof/index.html#precompile-accelerators">Precompile Accelerators</a></li>
</ul>
</li>
<li><a href="fault-proof/index.html#fault-proof-vm">Fault Proof VM</a></li>
<li><a href="fault-proof/index.html#fault-proof-interactive-dispute-game">Fault Proof Interactive Dispute Game</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<!-- markdownlint-enable -->
<h2 id="overview-12"><a class="header" href="#overview-12">Overview</a></h2>
<p>A fault proof, also known as fraud proof or interactive game, consists of 3 components:</p>
<ul>
<li><a href="fault-proof/index.html#fault-proof-program">Program</a>: given a commitment to all rollup inputs (L1 data) and the dispute, verify the dispute statelessly.</li>
<li><a href="fault-proof/index.html#fault-proof-vm">VM</a>: given a stateless program and its inputs, trace any instruction step, and prove it on L1.</li>
<li><a href="fault-proof/index.html#fault-proof-interactive-dispute-game">Interactive Dispute Game</a>: bisect a dispute down to a single instruction, and resolve the base-case using the VM.</li>
</ul>
<p>Each of these 3 components may have different implementations, which can be combined into different proof stacks,
and contribute to proof diversity when resolving a dispute.</p>
<p>"Stateless execution" of the program, and its individual instructions, refers to reproducing
the exact same computation by authenticating the inputs with a <a href="fault-proof/index.html#pre-image-oracle">Pre-image Oracle</a>.</p>
<p><img src="fault-proof/../static/assets/fault-proof.svg" alt="Diagram of Program and VM architecture" /></p>
<h2 id="pre-image-oracle"><a class="header" href="#pre-image-oracle">Pre-image Oracle</a></h2>
<p>The pre-image oracle is the only form of communication between
the <a href="fault-proof/index.html#fault-proof-program">Program</a> (in the Client role) and the <a href="fault-proof/index.html#fault-proof-vm">VM</a> (in the Server role).</p>
<p>The program uses the pre-image oracle to query any input data that is understood to be available to the user:</p>
<ul>
<li>The initial inputs to bootstrap the program. See <a href="fault-proof/index.html#bootstrapping">Bootstrapping</a>.</li>
<li>External data not already part of the program code. See <a href="fault-proof/index.html#pre-image-hinting-routes">Pre-image hinting routes</a>.</li>
</ul>
<p>The communication happens over a simple request-response wire protocol,
see <a href="fault-proof/index.html#pre-image-communication">Pre-image communication</a>.</p>
<h3 id="pre-image-key-types"><a class="header" href="#pre-image-key-types">Pre-image key types</a></h3>
<p>Pre-images are identified by a <code>bytes32</code> type-prefixed key:</p>
<ul>
<li>The first byte identifies the type of request.</li>
<li>The remaining 31 bytes identify the pre-image key.</li>
</ul>
<h4 id="type-0-zero-key"><a class="header" href="#type-0-zero-key">Type <code>0</code>: Zero key</a></h4>
<p>The zero prefix is illegal. This ensures all pre-image keys are non-zero,
enabling storage lookup optimizations and avoiding easy mistakes with invalid zeroed keys in the EVM.</p>
<h4 id="type-1-local-key"><a class="header" href="#type-1-local-key">Type <code>1</code>: Local key</a></h4>
<p>Information specific to the dispute: the remainder of the key may be an index, a string, a hash, etc.
Only the contract(s) managing this dispute instance may serve the value for this key:
it is localized and context-dependent.</p>
<p>This type of key is used for program bootstrapping, to identify the initial input arguments by index or name.</p>
<h4 id="type-2-global-keccak256-key"><a class="header" href="#type-2-global-keccak256-key">Type <code>2</code>: Global keccak256 key</a></h4>
<p>This type of key uses a global pre-image store contract, and is fully context-independent and permissionless.
I.e. every key must have a single unique value, regardless of chain history or time.</p>
<p>Using a global store reduces duplicate pre-image registration work,
and avoids unnecessary contract redeployments per dispute.</p>
<p>This global store contract should be non-upgradeable.</p>
<p>Since <code>keccak256</code> is a safe 32-byte hash input, the first byte is overwritten with a <code>2</code> to derive the key,
while keeping the rest of the key "readable" (matching the original hash).</p>
<h4 id="type-3-global-generic-key"><a class="header" href="#type-3-global-generic-key">Type <code>3</code>: Global generic key</a></h4>
<p>Reserved. This scheme allows for unlimited application-layer pre-image types without fault-proof VM redeployments.</p>
<p>This is a generic version of a global key store: <code>key = 0x03 ++ keccak256(x, sender)[1:]</code>, where:</p>
<ul>
<li><code>x</code> is a <code>bytes32</code>, which can be a hash of an arbitrary-length type of cryptographically secure commitment.</li>
<li><code>sender</code> is a <code>bytes32</code> identifying the pre-image inserter address (left-padded to 32 bytes)</li>
</ul>
<p>This global store contract should be non-upgradeable.</p>
<p>The global contract is permissionless: users can standardize around external contracts that verify pre-images
(i.e. a specific <code>sender</code> will always be trusted for a specific kind of pre-image).
The external contract verifies the pre-image before inserting it into the global store for usage by all
fault proof VMs without requiring the VM or global store contract to be changed.</p>
<p>Users may standardize around upgradeable external pre-image contracts,
in case the implementation of the verification of the pre-image is expected to change.</p>
<p>The store update function is <code>update(x bytes32, offset uint64, span uint8, value bytes32)</code>:</p>
<ul>
<li><code>x</code> is the <code>bytes32</code> <code>x</code> that the pre-image <code>key</code> is computed with.</li>
<li>Only part of the pre-image, starting at <code>offset</code>, and up to (incl.) 32 bytes <code>span</code> can be inserted at a time.</li>
<li>Pre-images may have an undefined length (e.g. a stream), we only need to know how many bytes of <code>value</code> are usable.</li>
<li>The key and offset will be hashed together to uniquely store the <code>value</code> and <code>span</code>, for later pre-image serving.</li>
</ul>
<p>This enables fault proof programs to adopt any new pre-image schemes without VM update or contract redeployment.</p>
<p>It is up to the user to index the special pre-image values by this key scheme,
as there is no way to revert it to the original commitment without knowing said commitment or value.</p>
<h4 id="type-4-global-sha2-256-key"><a class="header" href="#type-4-global-sha2-256-key">Type <code>4</code>: Global SHA2-256 key</a></h4>
<p>A SHA-256 pre-image.</p>
<p>Key: the SHA-256 hash, with the first byte overwritten with the type byte: <code>4 ++ sha256(data)[1:]</code>.</p>
<h4 id="type-5-global-eip-4844-point-evaluation-key"><a class="header" href="#type-5-global-eip-4844-point-evaluation-key">Type <code>5</code>: Global EIP-4844 Point-evaluation key</a></h4>
<p>An EIP-4844 point-evaluation.
In an EIP-4844 blob, 4096 field elements represent the blob data.</p>
<p>It verifies <code>p(z) = y</code> given <code>commitment</code> that corresponds to the polynomial <code>p(x)</code> and a KZG proof.
The value <code>y</code> is the pre-image.
The value <code>z</code> is part of the key; the index of the point within the blob.
The <code>commitment</code> is part of the key.</p>
<p>Each element is proven with a point-evaluation.</p>
<p>Key: <code>5 ++ keccak256(commitment ++ z)[1:]</code>, where:</p>
<ul>
<li><code>5</code> is the type byte</li>
<li><code>++</code> is concatenation</li>
<li><code>commitment</code> is a bytes48, representing the KZG commitment.</li>
<li><code>z</code> is a big-endian <code>uint256</code></li>
</ul>
<h4 id="type-6-global-precompile-key"><a class="header" href="#type-6-global-precompile-key">Type <code>6</code>: Global Precompile key</a></h4>
<p>A precompile result. It maps directly to precompiles on Ethereum.</p>
<p>This preimage key can be used to avoid running expensive precompile operations in the program.</p>
<p>Key: <code>6 ++ keccak256(precompile ++ input)[1:]</code>, where:</p>
<ul>
<li><code>6</code> is the type byte</li>
<li><code>++</code> is concatenation</li>
<li><code>precompile</code> is the 20-byte address of the precompile contract</li>
<li><code>input</code> is the input to the precompile contract</li>
</ul>
<p>The result is identical to that of a call to the precompile contract, prefixed with a revert indicator:</p>
<ul>
<li><code>reverted ++ precompile_result</code>.</li>
</ul>
<p><code>reverted</code> is a 1-byte indicator with a <code>0</code> value if the precompile reverts for the given input, otherwise it's <code>1</code>.</p>
<h4 id="type-7-128-reserved-range"><a class="header" href="#type-7-128-reserved-range">Type <code>7-128</code>: reserved range</a></h4>
<p>Range start and end both inclusive.</p>
<p>This range of key types is reserved for future usage by the core protocol.
E.g. version changes, contract migrations, chain-data, additional core features, etc.</p>
<p><code>128</code> specifically (<code>1000 0000</code> in binary) is reserved for key-type length-extension
(reducing the content part to <code>30</code> or less key bytes), if the need arises.</p>
<h4 id="type-129-255-application-usage"><a class="header" href="#type-129-255-application-usage">Type <code>129-255</code>: application usage</a></h4>
<p>This range of key types may be used by forks or customized versions of the fault proof protocol.</p>
<h3 id="bootstrapping"><a class="header" href="#bootstrapping">Bootstrapping</a></h3>
<p>Initial inputs are deterministic, but not necessarily singular or global:
there may be multiple different disputes at the same time, each with its own disputed claims and L1 context.</p>
<p>To bootstrap, the program requests the initial inputs from the VM, using pre-image key type <code>1</code>.</p>
<p>The VM is aware of the external context, and maps requested pre-image keys based on their type, i.e.
a local lookup for type <code>1</code>, or global one for <code>2</code>, and optionally support other key-types.</p>
<h3 id="hinting"><a class="header" href="#hinting">Hinting</a></h3>
<p>There is one more form of optional communication between client and server: pre-image hinting.
Hinting is optional, and <em>is a no-op</em> in a L1 VM implementation.</p>
<p>The hint itself comes at very low cost onchain: the hint can be a single <code>write</code> sys-call,
which is instant as the memory to write as hint does not actually need to be loaded as part of the onchain proof.</p>
<p>Hinting allows the program, when generating a proof offchain,
to instruct the VM what data it is interested in.</p>
<p>The VM can choose to execute the requested hint at any time: either locally (for standard requests),
or in a modular form by redirecting the hint to tooling that may come with the VM program.</p>
<p>Hints do not have to be executed directly: they may first just be logged to show the intents of the program,
and the latest hint may be buffered for lazy execution, or dropped entirely when in read-only mode (like onchain).</p>
<p>When the pre-image oracle serves a request, and the request cannot be served from an existing collection of pre-images
(e.g. a local pre-image cache) then the VM can execute the hint to retrieve the missing pre-image(s).
It is the responsibility of the program to provide sufficient hinting for every pre-image request.
Some hints may have to be repeated: the VM only has to execute the last hint when handling a missing pre-image.</p>
<p>Note that hints may produce multiple pre-images:
e.g. a hint for an ethereum block with transaction list may prepare pre-images for the header,
each of the transactions, and the intermediate merkle-nodes that form the transactions-list Merkle Patricia Trie.</p>
<p>Hinting is implemented with a request-acknowledgement wire-protocol over a blocking two-way stream:</p>
<pre><code class="language-text">&lt;request&gt; := &lt;length prefix&gt; &lt;hint bytes&gt;

&lt;response&gt; := &lt;ack&gt;

&lt;length prefix&gt; := big-endian uint32  # length of &lt;hint bytes&gt;
&lt;hint bytes&gt; := byte sequence
&lt;ack&gt; := 1-byte zero value
</code></pre>
<p>The ack informs the client that the hint has been processed. Servers may respond to hints and pre-image (see below)
requests asynchronously as they are on separate streams. To avoid requesting pre-images that are not yet fetched,
clients should request the pre-image only after it has observed the hint acknowledgement.</p>
<h3 id="pre-image-communication"><a class="header" href="#pre-image-communication">Pre-image communication</a></h3>
<p>Pre-images are communicated with a minimal wire-protocol over a blocking two-way stream.
This protocol can be implemented with blocking read/write syscalls.</p>
<pre><code class="language-text">&lt;request&gt; := &lt;bytes32&gt;  # the type-prefixed pre-image key

&lt;response&gt; := &lt;length prefix&gt; &lt;pre-image bytes&gt;

&lt;length prefix&gt; := big-endian uint64  # length of &lt;pre-image bytes&gt;, note: uint64
</code></pre>
<p>The <code>&lt;length prefix&gt;</code> here may be arbitrarily high:
the client can stop reading at any time if the required part of the pre-image has been read.</p>
<p>After the client writes new <code>&lt;request&gt;</code> bytes, the server should be prepared to respond with
the pre-image starting from <code>offset == 0</code> upon <code>read</code> calls.</p>
<p>The server may limit <code>read</code> results artificially to only a small amount of bytes at a time,
even though the full pre-image is ready: this is expected regular IO protocol,
and the client will just have to continue to read the small results at a time,
until 0 bytes are read, indicating EOF.
This enables the server to serve e.g. at most 32 bytes at a time or align reads with VM memory structure,
to limit the amount of VM state that changes per syscall instruction,
and thus keep the proof size per instruction bounded.</p>
<h2 id="fault-proof-program"><a class="header" href="#fault-proof-program">Fault Proof Program</a></h2>
<p>The Fault Proof Program defines the verification of claims of the state-transition outputs
of the L2 rollup as a pure function of L1 data.</p>
<p>The <code>op-program</code> is the reference implementation of the program, based on <code>op-node</code> and <code>op-geth</code> implementations.</p>
<p>The program consists of:</p>
<ul>
<li>Prologue: load the inputs, given minimal bootstrapping, with possible test-overrides.</li>
<li>Main content: process the L2 state-transition, i.e. derive the state changes from the L1 inputs.</li>
<li>Epilogue: inspect the state changes to verify the claim.</li>
</ul>
<h3 id="prologue"><a class="header" href="#prologue">Prologue</a></h3>
<p>The program is bootstrapped with two primary inputs:</p>
<ul>
<li><code>l1_head</code>: the L1 block hash that will be perceived as the tip of the L1 chain,
authenticating all prior L1 history.</li>
<li><code>dispute</code>: identity of the claim to verify.</li>
</ul>
<p>Bootstrapping happens through special input requests to the host of the program.</p>
<p>Additionally, there are <em>implied</em> inputs, which are <em>derived from the above primary inputs</em>,
but can be overridden for testing purposes:</p>
<ul>
<li><code>l2_head</code>: the L2 block hash that will be perceived as the previously agreed upon tip of the L2 chain,
authenticating all prior L2 history.</li>
<li>Chain configurations: chain configuration may be baked into the program,
or determined from attributes of the identified <code>dispute</code> on L1.
<ul>
<li><code>l1_chain_config</code>: The chain-configuration of the L1 chain (also known as <code>l1_genesis.json</code>)</li>
<li><code>l2_chain_config</code>: The chain-configuration of the L2 chain (also known as <code>l2_genesis.json</code>)</li>
<li><code>rollup_config</code>: The rollup configuration used by the rollup-node (also known as <code>rollup.json</code>)</li>
</ul>
</li>
</ul>
<p>The implied inputs rely on L1-introspection to load attributes of the <code>dispute</code> through the
<a href="fault-proof/stage-one/dispute-game-interface.html">dispute game interface</a>, in the L1 history up and till the specified <code>l1_head</code>.
The <code>dispute</code> may be the claim itself, or a pointer to specific prior claimed data in L1,
depending on the dispute game interface.</p>
<p>Implied inputs are loaded in a "prologue" before the actual core state-transition function executes.
During testing a simplified prologue that loads the overrides may be used.</p>
<blockquote>
<p>Note: only the test-prologues are currently supported, since the dispute game interface is actively changing.</p>
</blockquote>
<h3 id="main-content"><a class="header" href="#main-content">Main content</a></h3>
<p>To verify a claim about L2 state, the program first reproduces
the L2 state by applying L1 data to prior agreed L2 history.</p>
<p>This process is also known as the <a href="fault-proof/../protocol/derivation.html">L2 derivation process</a>,
and matches the processing in the <a href="fault-proof/../protocol/rollup-node.html">rollup node</a> and
<a href="fault-proof/../protocol/exec-engine.html">execution-engine</a>.</p>
<p>The difference is that rather than retrieving inputs from an RPC and applying state changes to disk,
the inputs are loaded through the <a href="fault-proof/index.html#pre-image-oracle">pre-image oracle</a> and the changes accumulate in memory.</p>
<p>The derivation executes with two data-sources:</p>
<ul>
<li>Interface to read-only L1 chain, backed by the pre-image oracle:
<ul>
<li>The <code>l1_head</code> determines the view over the available L1 data: no later L1 data is available.</li>
<li>The implementation of the chain traverses the header-chain from the <code>l1_head</code> down to serve by-number queries.</li>
<li>The <code>l1_head</code> is the L1 unsafe head, safe head, and finalized head.</li>
</ul>
</li>
<li>Interface to L2 engine API
<ul>
<li>Prior L2 chain history is backed by the pre-image oracle, similar to the L1 chain:
<ul>
<li>The initial <code>l2_head</code> determines the view over the initial available L2 history: no later L2 data is available.</li>
<li>The implementation of the chain traverses the header-chain from the <code>l2_head</code> down to serve by-number queries.</li>
<li>The <code>l2_head</code> is the initial L2 unsafe head, safe head, and finalized head.</li>
</ul>
</li>
<li>New L2 chain history accumulates in memory.
<ul>
<li>Although the pre-image oracle can be used to retrieve data by hash if memory is limited,
the program should prefer to keep the newly created chain data in memory, to minimize pre-image oracle access.</li>
<li>The L2 unsafe head, safe head, and finalized L2 head will potentially change as derivation progresses.</li>
<li>L2 state consists of the diff of changes in memory,
and any unchanged state nodes accessible through the read-only L2 history view.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>See <a href="fault-proof/index.html#pre-image-hinting-routes">Pre-image routes</a> for specifications of the pre-image oracle backing of these data sources.</p>
<p>Using these data-sources, the derivation pipeline is processed till we hit one of two conditions:</p>
<ul>
<li><code>EOF</code>: when we run out of L1 data, the L2 chain will not change further, and the epilogue can start.</li>
<li>Eager epilogue condition: depending on the type of claim to verify,
if the L2 result is irreversible (i.e. no later L1 inputs can override it),
the processing may end early when the result is ready.
E.g. when asserting state at a specific L2 block, rather than the very tip of the L2 chain.</li>
</ul>
<h3 id="epilogue"><a class="header" href="#epilogue">Epilogue</a></h3>
<p>While the main-content produces the disputed L2 state already,
the epilogue concludes what this means for the disputed claim.</p>
<p>The program produces a binary output to verify the claim, using a standard single-byte Unix exit-code:</p>
<ul>
<li>a <code>0</code> for success, i.e. the claim is correct.</li>
<li>a non-zero code for failure, i.e. the claim is incorrect.
<ul>
<li><code>1</code> should be preferred for identifying an incorrect claim.</li>
<li>Other non-zero exit codes may indicate runtime failure,
e.g. a bug in the program code may resolve in a kind of <code>panic</code> or unexpected error.
Safety should be preferred over liveness in this case, and the <code>claim</code> will fail.</li>
</ul>
</li>
</ul>
<p>To assert the disputed claim, the epilogue, like the main content,
can introspect L1 and L2 chain data and post-process it further,
to then make a statement about the claim with the final exit code.</p>
<p>A disputed output-root may be disproven by first producing the output-root, and then comparing it:</p>
<ol>
<li>Retrieve the output attributes from the L2 chain view: the state-root, block-hash, withdrawals storage-root.</li>
<li>Compute the output-root, as the
<a href="fault-proof/../protocol/proposals.html#l2-output-commitment-construction">proposer should compute it</a>.</li>
<li>If the output-root matches the <code>claim</code>, exit with code 0. Otherwise, exit with code 1.</li>
</ol>
<blockquote>
<p>Note: the dispute game interface is actively changing, and may require additional claim assertions.
the output-root epilogue may be replaced or extended for general L2 message proving.</p>
</blockquote>
<h3 id="pre-image-hinting-routes"><a class="header" href="#pre-image-hinting-routes">Pre-image hinting routes</a></h3>
<p>The fault proof program implements hint handling for the VM to use,
as well as any program testing outside of VM environment.
This can be exposed via a CLI, or alternative inter-process API.</p>
<p>Every instance of <code>&lt;blockhash&gt;</code> in the below routes is <code>0x</code>-prefixed, lowercase, hex-encoded.</p>
<h4 id="l1-block-header-blockhash"><a class="header" href="#l1-block-header-blockhash"><code>l1-block-header &lt;blockhash&gt;</code></a></h4>
<p>Requests the host to prepare the L1 block header RLP pre-image of the block <code>&lt;blockhash&gt;</code>.</p>
<h4 id="l1-transactions-blockhash"><a class="header" href="#l1-transactions-blockhash"><code>l1-transactions &lt;blockhash&gt;</code></a></h4>
<p>Requests the host to prepare the list of transactions of the L1 block with <code>&lt;blockhash&gt;</code>:
prepare the RLP pre-images of each of them, including transactions-list MPT nodes.</p>
<h4 id="l1-receipts-blockhash"><a class="header" href="#l1-receipts-blockhash"><code>l1-receipts &lt;blockhash&gt;</code></a></h4>
<p>Requests the host to prepare the list of receipts of the L1 block with <code>&lt;blockhash&gt;</code>:
prepare the RLP pre-images of each of them, including receipts-list MPT nodes.</p>
<h4 id="l1-precompile-precompile--inputbytes"><a class="header" href="#l1-precompile-precompile--inputbytes"><code>l1-precompile &lt;precompile ++ inputbytes&gt;</code></a></h4>
<p>Requests the host to prepare the result of an L1 call to the <code>precompile</code> address given
<code>&lt;inputbytes&gt;</code> as the input. The host also prepares a <a href="fault-proof/index.html#type-2-global-keccak256-key">global keccak256 preimage</a>
of the hint data <code>&lt;precompile ++ inputbytes&gt;</code>.</p>
<h4 id="l2-block-header-blockhash-chainid"><a class="header" href="#l2-block-header-blockhash-chainid"><code>l2-block-header &lt;blockhash&gt; &lt;chainID&gt;?</code></a></h4>
<p>Requests the host to prepare the L2 block header RLP pre-image of the block <code>&lt;blockhash&gt;</code>.</p>
<p>The <code>&lt;chainID&gt;</code> is optionally concatenated after the <code>&lt;blockHash&gt;</code> as a big endian uint64 value to specify which L2
chain to retrieve data from. <code>&lt;chainID&gt;</code> must be specified when the interop hard fork is active.</p>
<h4 id="l2-transactions-blockhash-chainid"><a class="header" href="#l2-transactions-blockhash-chainid"><code>l2-transactions &lt;blockhash&gt; &lt;chainID&gt;?</code></a></h4>
<p>Requests the host to prepare the list of transactions of the L2 block with <code>&lt;blockhash&gt;</code>:
prepare the RLP pre-images of each of them, including transactions-list MPT nodes.</p>
<p>The <code>&lt;chainID&gt;</code> is optionally concatenated after the <code>&lt;blockHash&gt;</code> as a big endian uint64 value to specify which L2
chain to retrieve data from. <code>&lt;chainID&gt;</code> must be specified when the interop hard fork is active.</p>
<h4 id="l2-receipts-blockhash-chainid"><a class="header" href="#l2-receipts-blockhash-chainid"><code>l2-receipts &lt;blockhash&gt; &lt;chainID&gt;</code></a></h4>
<p>Requests the host to prepare the list of receipts of the L2 block with <code>&lt;blockhash&gt;</code> for the specified <code>&lt;chainID&gt;</code>:
prepare the RLP pre-images of each of them, including receipts-list MPT nodes.</p>
<p>This hint is used only when the interop hard fork is active.</p>
<h4 id="l2-code-codehash-chainid"><a class="header" href="#l2-code-codehash-chainid"><code>l2-code &lt;codehash&gt; &lt;chainID&gt;?</code></a></h4>
<p>Requests the host to prepare the L2 smart-contract code with the given <code>&lt;codehash&gt;</code>.</p>
<p>The <code>&lt;chainID&gt;</code> is optionally concatenated after the <code>&lt;blockHash&gt;</code> as a big endian uint64 value to specify which L2
chain to retrieve data from. <code>&lt;chainID&gt;</code> must be specified when the interop hard fork is active.</p>
<h4 id="l2-state-node-nodehash-chainid"><a class="header" href="#l2-state-node-nodehash-chainid"><code>l2-state-node &lt;nodehash&gt; &lt;chainID&gt;?</code></a></h4>
<p>Requests the host to prepare the L2 MPT node preimage with the given <code>&lt;nodehash&gt;</code>.</p>
<p>The <code>&lt;chainID&gt;</code> is optionally concatenated after the <code>&lt;blockHash&gt;</code> as a big endian uint64 value to specify which L2
chain to retrieve data from. <code>&lt;chainID&gt;</code> must be specified when the interop hard fork is active.</p>
<h4 id="l2-output-outputroot-chainid"><a class="header" href="#l2-output-outputroot-chainid"><code>l2-output &lt;outputroot&gt; &lt;chainID&gt;?</code></a></h4>
<p>Requests the host to prepare the L2 Output at the l2 output root <code>&lt;outputroot&gt;</code>.
The L2 Output is the preimage of a
<a href="fault-proof/../protocol/proposals.html#l2-output-commitment-construction">computed output root</a>.</p>
<p>The <code>&lt;chainID&gt;</code> is optionally concatenated after the <code>&lt;blockHash&gt;</code> as a big endian uint64 value to specify which L2
chain to retrieve data from. <code>&lt;chainID&gt;</code> must be specified when the interop hard fork is active.</p>
<h4 id="l2-payload-witness-payload_attributes"><a class="header" href="#l2-payload-witness-payload_attributes"><code>l2-payload-witness &lt;payload_attributes&gt;</code></a></h4>
<p>Requests the host to prepare all preimages used in the building of the payload specified by <code>&lt;payload_attributes&gt;</code>.
<code>&lt;payload_attributes&gt;</code> is a JSON object with the fields <code>parentBlockHash</code>, <code>payloadAttributes</code> and optionally <code>chainID</code>.
The <code>chainID</code> must be specific when the interop hard fork is active.</p>
<h4 id="l2-account-proof-blockhash_and_address"><a class="header" href="#l2-account-proof-blockhash_and_address"><code>l2-account-proof &lt;blockhash_and_address&gt;</code></a></h4>
<p>Requests the host send account proof for a certain block hash and address. <code>&lt;blockhash_and_address&gt;</code> is hex
encoded: 32-byte block hash + 20-byte address + 8 byte big endian chain ID.</p>
<p><code>l2-payload-witness</code> and <code>l2-account-proof</code> hints are preferred over the more granular <code>l2-code</code> and <code>l2-state-node</code>,
and they should be sent before the more granular hints to ensure proper handling.</p>
<h4 id="l2-block-data-blockhash"><a class="header" href="#l2-block-data-blockhash"><code>l2-block-data &lt;blockhash&gt;</code></a></h4>
<p>Requests the host to prepare all preimages used in the building of the block specified by <code>&lt;blockhash&gt;</code>.
<code>&lt;blockhash&gt;</code> is a hex encoded concatenation of the following:</p>
<ul>
<li>32-byte parent block hash</li>
<li>32-byte block hash of the block to be prepared</li>
<li>8-byte big-endian chain ID</li>
</ul>
<p>This hint is used only when the interop hard fork is active.</p>
<h3 id="precompile-accelerators"><a class="header" href="#precompile-accelerators">Precompile Accelerators</a></h3>
<p>Precompiles that are too expensive to be executed in a fault-proof VM can be executed
more efficiently using the pre-image oracle.
This approach ensures that the fault proof program can complete a state transition in a reasonable
amount of time.</p>
<p>During program execution, the precompiles are substituted with interactions with pre-image oracle.
The program hints the host for a precompile input. Which it the subsequently retrieves the result of the precompile
operation using the <a href="fault-proof/index.html#type-6-global-precompile-key">type 6 global precompile key</a>.
All accelerated precompiles must be functionally equivalent to their EVM equivalent.</p>
<h2 id="fault-proof-vm"><a class="header" href="#fault-proof-vm">Fault Proof VM</a></h2>
<p>A fault proof VM implements:</p>
<ul>
<li>a smart-contract to verify a single execution-trace step, e.g. a single MIPS instruction.</li>
<li>a CLI command to generate a proof of a single execution-trace step.</li>
<li>a CLI command to compute a VM state-root at step N</li>
</ul>
<p>A fault proof VM relies on a fault proof program to provide an interface
for fetching any missing pre-images based on hints.</p>
<p>The VM emulates the program, as prepared for the VM target architecture,
and generates the state-root or instruction proof data as requested through the VM CLI.</p>
<p>Refer to the documentation of the fault proof VM for further usage information.</p>
<p>Fault Proof VMs:</p>
<ul>
<li><a href="https://github.com/ethereum-optimism/cannon">Cannon</a>: big-endian 64-bit MIPS64 architecture, by OP Labs, in active development.</li>
<li><a href="https://github.com/anton-rs/cannon-rs">cannon-rs</a>: Rust implementation of <code>Cannon</code>, by <code>@clabby</code>, deprecated.</li>
<li><a href="https://github.com/protolambda/asterisc">Asterisc</a>: little-endian 64-bit RISC-V architecture, by <code>@protolambda</code>, in active development.</li>
</ul>
<h2 id="fault-proof-interactive-dispute-game"><a class="header" href="#fault-proof-interactive-dispute-game">Fault Proof Interactive Dispute Game</a></h2>
<p>The interactive dispute game allows actors to resolve a dispute with an onchain challenge-response game
that bisects to a disagreed block <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â†’</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> state transition, and then over the execution trace of the VM
which models this state transition, bounded with a base-case that proves a single VM trace step.</p>
<p>The game is multi-player: different non-aligned actors may participate when bonded.</p>
<p>Response time is allocated based on the remaining time in the branch of the tree and alignment with the claim.
The allocated response time is limited by the dispute-game window,
and any additional time necessary based on L1 fee changes when bonds are insufficient.</p>
<blockquote>
<p>Note: the timed, bonded, bisection dispute game is in development.
Also see <a href="fault-proof/stage-one/fault-dispute-game.html">fault dispute-game specs</a> for fault dispute game system specifications,
And <a href="fault-proof/stage-one/dispute-game-interface.html">dispute-game-interface specs</a></p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="multithreaded-cannon-fault-proof-virtual-machine"><a class="header" href="#multithreaded-cannon-fault-proof-virtual-machine">Multithreaded Cannon Fault Proof Virtual Machine</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="fault-proof/cannon-fault-proof-vm.html#overview">Overview</a>
<ul>
<li><a href="fault-proof/cannon-fault-proof-vm.html#definitions">Definitions</a>
<ul>
<li><a href="fault-proof/cannon-fault-proof-vm.html#concepts">Concepts</a>
<ul>
<li><a href="fault-proof/cannon-fault-proof-vm.html#natural-alignment">Natural Alignment</a></li>
</ul>
</li>
<li><a href="fault-proof/cannon-fault-proof-vm.html#data-types">Data types</a></li>
<li><a href="fault-proof/cannon-fault-proof-vm.html#constants">Constants</a></li>
</ul>
</li>
<li><a href="fault-proof/cannon-fault-proof-vm.html#new-features">New Features</a>
<ul>
<li><a href="fault-proof/cannon-fault-proof-vm.html#multithreading">Multithreading</a></li>
<li><a href="fault-proof/cannon-fault-proof-vm.html#64-bit-architecture">64-bit Architecture</a></li>
<li><a href="fault-proof/cannon-fault-proof-vm.html#robustness">Robustness</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="fault-proof/cannon-fault-proof-vm.html#multithreading-1">Multithreading</a>
<ul>
<li><a href="fault-proof/cannon-fault-proof-vm.html#thread-management">Thread Management</a></li>
<li><a href="fault-proof/cannon-fault-proof-vm.html#thread-traversal-mechanics">Thread Traversal Mechanics</a>
<ul>
<li><a href="fault-proof/cannon-fault-proof-vm.html#thread-preemption">Thread Preemption</a></li>
</ul>
</li>
<li><a href="fault-proof/cannon-fault-proof-vm.html#exited-threads">Exited Threads</a></li>
<li><a href="fault-proof/cannon-fault-proof-vm.html#futex-operations">Futex Operations</a>
<ul>
<li><a href="fault-proof/cannon-fault-proof-vm.html#wait">Wait</a></li>
<li><a href="fault-proof/cannon-fault-proof-vm.html#wake">Wake</a></li>
</ul>
</li>
<li><a href="fault-proof/cannon-fault-proof-vm.html#voluntary-preemption">Voluntary Preemption</a></li>
<li><a href="fault-proof/cannon-fault-proof-vm.html#forced-preemption">Forced Preemption</a></li>
</ul>
</li>
<li><a href="fault-proof/cannon-fault-proof-vm.html#stateful-instructions">Stateful Instructions</a>
<ul>
<li><a href="fault-proof/cannon-fault-proof-vm.html#load-linked--store-conditional-word">Load Linked / Store Conditional Word</a></li>
<li><a href="fault-proof/cannon-fault-proof-vm.html#load-linked--store-conditional-doubleword">Load Linked / Store Conditional Doubleword</a></li>
</ul>
</li>
<li><a href="fault-proof/cannon-fault-proof-vm.html#fpvm-state">FPVM State</a>
<ul>
<li><a href="fault-proof/cannon-fault-proof-vm.html#state">State</a></li>
<li><a href="fault-proof/cannon-fault-proof-vm.html#state-hash">State Hash</a></li>
<li><a href="fault-proof/cannon-fault-proof-vm.html#thread-state">Thread State</a></li>
<li><a href="fault-proof/cannon-fault-proof-vm.html#thread-hash">Thread Hash</a></li>
<li><a href="fault-proof/cannon-fault-proof-vm.html#thread-stack-hashing">Thread Stack Hashing</a></li>
</ul>
</li>
<li><a href="fault-proof/cannon-fault-proof-vm.html#memory">Memory</a>
<ul>
<li><a href="fault-proof/cannon-fault-proof-vm.html#heap">Heap</a>
<ul>
<li><a href="fault-proof/cannon-fault-proof-vm.html#mmap-hints">mmap hints</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="fault-proof/cannon-fault-proof-vm.html#delay-slots">Delay Slots</a></li>
<li><a href="fault-proof/cannon-fault-proof-vm.html#syscalls">Syscalls</a>
<ul>
<li><a href="fault-proof/cannon-fault-proof-vm.html#supported-syscalls">Supported Syscalls</a></li>
<li><a href="fault-proof/cannon-fault-proof-vm.html#noop-syscalls">Noop Syscalls</a></li>
</ul>
</li>
<li><a href="fault-proof/cannon-fault-proof-vm.html#io">I/O</a>
<ul>
<li><a href="fault-proof/cannon-fault-proof-vm.html#standard-streams">Standard Streams</a></li>
<li><a href="fault-proof/cannon-fault-proof-vm.html#hint-communication">Hint Communication</a></li>
<li><a href="fault-proof/cannon-fault-proof-vm.html#pre-image-communication">Pre-image Communication</a>
<ul>
<li><a href="fault-proof/cannon-fault-proof-vm.html#pre-image-io-alignment">Pre-image I/O Alignment</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="fault-proof/cannon-fault-proof-vm.html#exceptions">Exceptions</a></li>
<li><a href="fault-proof/cannon-fault-proof-vm.html#security-model">Security Model</a>
<ul>
<li><a href="fault-proof/cannon-fault-proof-vm.html#compiler-correctness">Compiler Correctness</a></li>
<li><a href="fault-proof/cannon-fault-proof-vm.html#compiler-assumptions">Compiler Assumptions</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-13"><a class="header" href="#overview-13">Overview</a></h2>
<p>This is a description of the second iteration of the Cannon Fault Proof Virtual Machine (FPVM).
When necessary to distinguish this version from the initial implementation,
it can be referred to as Multithreaded Cannon (MTCannon). Similarly,
the original Cannon implementation can be referred to as Singlethreaded Cannon (STCannon) where necessary for clarity.</p>
<p>The MTCannon FPVM emulates a minimal uniprocessor Linux-based system running on big-endian 64-bit MIPS64 architecture.
A lot of its behaviors are copied from Linux/MIPS with a few tweaks made for fault proofs.
For the rest of this doc, we refer to the MTCannon FPVM as simply the FPVM.</p>
<p>Operationally, the FPVM is a state transition function. This state transition is referred to as a <em>Step</em>,
that executes a single instruction. We say the VM is a function <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span>, given an input state <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">re</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>, steps on a
single instruction encoded in the state to produce a new state <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">os</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>.
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">re</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â†’</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">os</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p>Thus, the trace of a program executed by the FPVM is an ordered set of VM states.</p>
<h3 id="definitions"><a class="header" href="#definitions">Definitions</a></h3>
<h4 id="concepts"><a class="header" href="#concepts">Concepts</a></h4>
<h5 id="natural-alignment"><a class="header" href="#natural-alignment">Natural Alignment</a></h5>
<p>A memory address is said to be "naturally aligned" in the context of some data type
if it is a multiple of that data type's byte size.
For example, the address of a 32-bit (4-byte) value is naturally aligned if it is a multiple of 4 (e.g. <code>0x1000</code>, <code>0x1004</code>).
Similarly, the address of a 64-bit (8-byte) value is naturally aligned if it is a multiple of 8 (e.g. <code>0x1000</code>, <code>0x1008</code>).</p>
<p>A non-aligned address can be naturally aligned by dropping the least significant bits of the address:
<code>aligned = unaligned &amp; ^(byteSize - 1)</code>.
For example, to align the address <code>0x1002</code> targeting a 32-bit value:
<code>aligned = 0x1002 &amp; ^(0x3) = 0x1000</code>.</p>
<h4 id="data-types"><a class="header" href="#data-types">Data types</a></h4>
<ul>
<li><code>Boolean</code> - An 8-bit boolean value equal to 0 (false) or 1 (true).</li>
<li><code>Hash</code> - A 256-bit fixed-size value produced by the Keccak-256 cryptographic hash function.</li>
<li><code>UInt8</code> - An 8-bit unsigned integer value.</li>
<li><code>UInt64</code> - A 64-bit unsigned integer value.</li>
<li><code>Word</code> - A 64-bit value.</li>
</ul>
<h4 id="constants"><a class="header" href="#constants">Constants</a></h4>
<ul>
<li><code>EBADF</code> - A Linux error number indicating a bad file descriptor: <code>0x9</code>.</li>
<li><code>MaxWord</code> - A <code>Word</code> with all bits set to 1: <code>0xFFFFFFFFFFFFFFFF</code>.
When interpreted as a signed value, this is equivalent to -1.</li>
<li><code>ProgramBreakAddress</code> - The fixed memory address for the program break: <code>Word(0x0000_4000_0000_0000)</code>.</li>
<li><code>WordSize</code> - The number of bytes in a <code>Word</code> (8).</li>
</ul>
<h3 id="new-features"><a class="header" href="#new-features">New Features</a></h3>
<h4 id="multithreading"><a class="header" href="#multithreading">Multithreading</a></h4>
<p>MTCannon adds support for <a href="https://en.wikipedia.org/wiki/Thread_(computing)">multithreading</a>.
Thread management and scheduling are typically handled by the
<a href="https://en.wikipedia.org/wiki/Kernel_%28operating_system%29">operating system (OS) kernel</a>:
programs make thread-related requests to the OS kernel via <a href="https://en.wikipedia.org/wiki/System_call">syscalls</a>.
As such, this implementation includes a few new Linux-specific thread-related <a href="fault-proof/cannon-fault-proof-vm.html#syscalls">syscalls</a>.
Additionally, the <a href="fault-proof/cannon-fault-proof-vm.html#fpvm-state">FPVM state</a> has been modified in order to track the set of active threads
and thread-related global state.</p>
<h4 id="64-bit-architecture"><a class="header" href="#64-bit-architecture">64-bit Architecture</a></h4>
<p>MTCannon emulates a MIPS64 machine whereas STCannon emulates a MIPS32 machine.  The transition from MIPS32 to MIPS64
means the address space goes from 32-bit to 64-bit, greatly expanding addressable memory.</p>
<h4 id="robustness"><a class="header" href="#robustness">Robustness</a></h4>
<p>In the initial implementation of Cannon, unrecognized syscalls were treated as
noops (see <a href="fault-proof/cannon-fault-proof-vm.html#noop-syscalls">"Noop Syscalls"</a>). To ensure no unexpected behaviors are triggered,
MTCannon will now raise an exception if unrecognized syscalls are encountered during program execution.</p>
<h2 id="multithreading-1"><a class="header" href="#multithreading-1">Multithreading</a></h2>
<p>The MTCannon FPVM rotates between threads to provide
<a href="https://en.wikipedia.org/wiki/Computer_multitasking">multitasking</a> rather than
true <a href="https://en.wikipedia.org/wiki/Parallel_computing">parallel processing</a>.
The VM state holds an ordered set of thread state objects representing all executing threads.</p>
<p>On any given step, there is one active thread that will be processed.</p>
<h3 id="thread-management"><a class="header" href="#thread-management">Thread Management</a></h3>
<p>The FPVM state contains two thread stacks that are used to represent the set of all threads: <code>leftThreadStack</code> and
<code>rightThreadStack</code>. An additional boolean value (<code>traverseRight</code>) determines which stack contains the currently active
thread and how threads are rearranged when the active thread is preempted (see <a href="fault-proof/cannon-fault-proof-vm.html#thread-preemption">"Thread Preemption"</a>
for details).</p>
<p>When traversing right, the thread on the top of the right stack is the active thread, the right stack is referred to as
the "active" stack,
and the left the "inactive" stack.  Conversely, when traversing left, the active thread is on top of the left stack,
the left stack is "active", and the right is "inactive".</p>
<p>Representing the set of threads as two stacks allows for a succinct commitment to the contents of all threads.
For details, see <a href="fault-proof/cannon-fault-proof-vm.html#thread-stack-hashing">â€œThread Stack Hashingâ€</a>.</p>
<h3 id="thread-traversal-mechanics"><a class="header" href="#thread-traversal-mechanics">Thread Traversal Mechanics</a></h3>
<p>Threads are traversed deterministically by moving from the first thread to the last thread,
then from the last thread to the first thread repeatedly.  For example, given the set of threads: {0,1,2,3},
the FPVM would traverse to each as follows: 0, 1, 2, 3, 3, 2, 1, 0, 0, 1, 2, 3, 3, 2, â€¦.</p>
<h4 id="thread-preemption"><a class="header" href="#thread-preemption">Thread Preemption</a></h4>
<p>Threads are traversed via "preemption": the currently active thread is popped from the active stack and pushed to the
inactive stack.  If the active stack is empty, the FPVM state's <code>traverseRight</code> field is flipped ensuring that
there is always an active thread.</p>
<h3 id="exited-threads"><a class="header" href="#exited-threads">Exited Threads</a></h3>
<p>When the VM encounters an active thread that has exited, it is popped from the active thread stack, removing it from
the VM state.</p>
<h3 id="futex-operations"><a class="header" href="#futex-operations">Futex Operations</a></h3>
<p>The VM supports <a href="https://www.man7.org/linux/man-pages/man2/futex.2.html">futex syscall</a> operations
<code>FUTEX_WAIT_PRIVATE</code> and <code>FUTEX_WAKE_PRIVATE</code>.</p>
<p>Futexes are commonly used to implement locks in user space.
In this scenario, a shared 32-bit value (the "futex value") represents the state of a lock.
If a thread cannot acquire the lock, it calls a futex wait, which puts the thread to sleep.
To release the lock, the owning thread updates the futex value and then calls a futex wake
to notify any other waiting threads.</p>
<p>Because wake-ups may be spurious or could be triggered by unrelated operations on the same memory,
waiting threads must always re-check the futex value after waking up to decide if they can proceed.</p>
<h4 id="wait"><a class="header" href="#wait">Wait</a></h4>
<p>When a futex wait is successfully executed, the current thread is simply <a href="fault-proof/cannon-fault-proof-vm.html#thread-preemption">preempted</a>.
This gives other threads a chance to run and potentially change the shared futex value (for example, by releasing a lock).
When the thread is eventually scheduled again, if the futex value has not changed the wakeup will be considered spurious
and the thread will simply call futex wait again.</p>
<h4 id="wake"><a class="header" href="#wake">Wake</a></h4>
<p>When a futex wake is executed, the current thread is <a href="fault-proof/cannon-fault-proof-vm.html#thread-preemption">preempted</a>. This allows the scheduler to move
on to other threads which may potentially be ready to run (for example, because a shared lock was released).</p>
<h3 id="voluntary-preemption"><a class="header" href="#voluntary-preemption">Voluntary Preemption</a></h3>
<p>In addition to the <a href="fault-proof/cannon-fault-proof-vm.html#futex-operations">futex syscall</a>, there are a few other syscalls that
will cause a thread to be "voluntarily" preempted: <code>sched_yield</code>, <code>nanosleep</code>.</p>
<h3 id="forced-preemption"><a class="header" href="#forced-preemption">Forced Preemption</a></h3>
<p>To avoid thread starvation (for example where a thread hogs resources by never executing a sleep, yield, wait, etc.),
the FPVM will force a context switch if the active thread has been executing too long.</p>
<p>For each step executed on a particular thread, the state field <code>stepsSinceLastContextSwitch</code> is incremented.
When a thread is preempted, <code>StepsSinceLastContextSwitch</code> is reset to 0.
If <code>StepsSinceLastContextSwitch</code> reaches a maximum value (<code>SchedQuantum</code> = 100_000),
the FPVM preempts the active thread.</p>
<h2 id="stateful-instructions"><a class="header" href="#stateful-instructions">Stateful Instructions</a></h2>
<h3 id="load-linked--store-conditional-word"><a class="header" href="#load-linked--store-conditional-word">Load Linked / Store Conditional Word</a></h3>
<p>The Load Linked Word (<code>ll</code>) and Store Conditional Word (<code>sc</code>) instructions provide the low-level
primitives used to implement atomic read-modify-write (RMW) operations.  A typical RMW sequence might play out as
follows:</p>
<ul>
<li><code>ll</code> places a "reservation" targeting a 32-bit value in memory and returns the current value at this location.</li>
<li>Subsequent instructions take this value and perform some operation on it:
<ul>
<li>For example, maybe a counter variable is loaded and then incremented.</li>
</ul>
</li>
<li><code>sc</code> is called and the modified value overwrites the original value in memory
only if the memory reservation is still intact.</li>
</ul>
<p>This RMW sequence ensures that if another thread or process modifies a reserved value while
an atomic update is being performed, the reservation will be invalidated and the atomic update will fail.</p>
<p>Prior to MTCannon, we could be assured that no intervening process would modify such a reserved value because
STCannon is singlethreaded.  With the introduction of multithreading, additional fields need to be stored in the
FPVM state to track memory reservations initiated by <code>ll</code> operations.</p>
<p>When an <code>ll</code> instruction is executed:</p>
<ul>
<li><code>llReservationStatus</code> is set to <code>1</code>.</li>
<li><code>llAddress</code> is set to the virtual memory address specified by <code>ll</code>.</li>
<li><code>llOwnerThread</code> is set to the <code>threadID</code> of the active thread.</li>
</ul>
<p>Only a single memory reservation can be active at a given time - a new reservation will clear any previous reservation.</p>
<p>When the VM writes any data to memory, these <code>ll</code>-related fields are checked and any existing memory reservation
is cleared if a memory write touches the naturally-aligned <code>Word</code> that contains <code>llAddress</code>.</p>
<p>When an <code>sc</code> instruction is executed, the operation will only succeed if:</p>
<ul>
<li>The <code>llReservationStatus</code> field is equal to <code>1</code>.</li>
<li>The active thread's <code>threadID</code> matches <code>llOwnerThread</code>.</li>
<li>The virtual address specified by <code>sc</code> matches <code>llAddress</code>.</li>
</ul>
<p>On success, <code>sc</code> stores a value to the specified address after it is naturally aligned,
clears the memory reservation by zeroing out <code>llReservationStatus</code>, <code>llOwnerThread</code>, and <code>llAddress</code>
and returns <code>1</code>.</p>
<p>On failure, <code>sc</code> returns <code>0</code>.</p>
<h3 id="load-linked--store-conditional-doubleword"><a class="header" href="#load-linked--store-conditional-doubleword">Load Linked / Store Conditional Doubleword</a></h3>
<p>With the transition to MIPS64, Load Linked Doubleword (<code>lld</code>), and Store Conditional Doubleword (<code>scd</code>) instructions
are also now supported.
These instructions are similar to <code>ll</code> and <code>sc</code>, but they operate on 64-bit rather than 32-bit values.</p>
<p>The <code>lld</code> instruction functions similarly to <code>ll</code>, but the <code>llReservationStatus</code> is set to <code>2</code>.
The <code>scd</code> instruction functions similarly to <code>sc</code>, but the <code>llReservationStatus</code> must be equal to <code>2</code>
for the operation to succeed.  In other words, an <code>scd</code> instruction must be preceded by a matching <code>lld</code> instruction
just as the <code>sc</code> instruction must be preceded by a matching <code>ll</code> instruction if the store operation is to succeed.</p>
<h2 id="fpvm-state"><a class="header" href="#fpvm-state">FPVM State</a></h2>
<h3 id="state"><a class="header" href="#state">State</a></h3>
<p>The FPVM is a state transition function that operates on a state object consisting of the following fields:</p>
<ol>
<li><code>memRoot</code> - [<code>Hash</code>] A value representing the merkle root of VM memory.</li>
<li><code>preimageKey</code> - [<code>Hash</code>] The value of the last requested pre-image key.</li>
<li><code>preimageOffset</code> - [<code>Word</code>] The value of the last requested pre-image offset.</li>
<li><code>heap</code> - [<code>Word</code>] The base address of the most recent memory allocation via mmap.</li>
<li><code>llReservationStatus</code> - [<code>UInt8</code>] The current memory reservation status where: <code>0</code> means there is no
reservation, <code>1</code> means an <code>ll</code>/<code>sc</code>-compatible reservation is active,
and <code>2</code> means an <code>lld</code>/<code>scd</code>-compatible reservation is active.
Memory is reserved via Load Linked Word (<code>ll</code>)  and Load Linked Doubleword (<code>lld</code>) instructions.</li>
<li><code>llAddress</code> - [<code>Word</code>] If a memory reservation is active, the value of
the address specified by the last <code>ll</code> or <code>lld</code> instruction.
Otherwise, set to <code>0</code>.</li>
<li><code>llOwnerThread</code> - [<code>Word</code>] The id of the thread that initiated the current memory reservation
or <code>0</code> if there is no active reservation.</li>
<li><code>exitCode</code> - [<code>UInt8</code>] The exit code value.</li>
<li><code>exited</code> - [<code>Boolean</code>] Indicates whether the VM has exited.</li>
<li><code>step</code> - [<code>UInt64</code>] A step counter.</li>
<li><code>stepsSinceLastContextSwitch</code> - [<code>UInt64</code>] A step counter that tracks the number of steps executed on the current
thread since the last <a href="fault-proof/cannon-fault-proof-vm.html#thread-preemption">preemption</a>.</li>
<li><code>traverseRight</code> - [<code>Boolean</code>] Indicates whether the currently active thread is on the left or right thread
stack, as well as some details on thread traversal mechanics.
See <a href="fault-proof/cannon-fault-proof-vm.html#thread-traversal-mechanics">"Thread Traversal Mechanics"</a> for details.</li>
<li><code>leftThreadStack</code> - [<code>Hash</code>] A hash of the contents of the left thread stack.
For details, see the <a href="fault-proof/cannon-fault-proof-vm.html#thread-stack-hashing">â€œThread Stack Hashingâ€ section.</a></li>
<li><code>rightThreadStack</code> - [<code>Hash</code>] A hash of the contents of the right thread stack.
For details, see the <a href="fault-proof/cannon-fault-proof-vm.html#thread-stack-hashing">â€œThread Stack Hashingâ€ section.</a></li>
<li><code>nextThreadID</code> - [<code>Word</code>] The value defining the id to assign to the next thread that is created.</li>
</ol>
<p>The state is represented by packing the above fields, in order, into a 188-byte buffer.</p>
<h3 id="state-hash"><a class="header" href="#state-hash">State Hash</a></h3>
<p>The state hash is computed by hashing the 188-byte state buffer with the Keccak256 hash function
and then setting the high-order byte to the respective VM status.</p>
<p>The VM status can be derived from the state's <code>exited</code> and <code>exitCode</code> fields.</p>
<pre><code class="language-rs">enum VmStatus {
    Valid = 0,
    Invalid = 1,
    Panic = 2,
    Unfinished = 3,
}

fn vm_status(exit_code: u8, exited: bool) -&gt; u8 {
    if exited {
        match exit_code {
            0 =&gt; VmStatus::Valid,
            1 =&gt; VmStatus::Invalid,
            _ =&gt; VmStatus::Panic,
        }
    } else {
        VmStatus::Unfinished
    }
}
</code></pre>
<h3 id="thread-state"><a class="header" href="#thread-state">Thread State</a></h3>
<p>The state of a single thread is tracked and represented by a thread state object consisting of the following fields:</p>
<ol>
<li><code>threadID</code> - [<code>Word</code>] A unique thread identifier.</li>
<li><code>exitCode</code> - [<code>UInt8</code>] The exit code value.</li>
<li><code>exited</code> - [<code>Boolean</code>] Indicates whether the thread has exited.</li>
<li><code>pc</code> - [<code>Word</code>] The program counter.</li>
<li><code>nextPC</code> - [<code>Word</code>] The next program counter. Note that this value may not always be <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">4</span></span></span></span>
when executing a branch/jump delay slot.</li>
<li><code>lo</code> - [<code>Word</code>] The MIPS LO special register.</li>
<li><code>hi</code> - [<code>Word</code>] The MIPS HI special register.</li>
<li><code>registers</code> - 32 general-purpose MIPS registers numbered 0 - 31. Each register contains a <code>Word</code> value.</li>
</ol>
<p>A thread is represented by packing the above fields, in order, into a 298-byte buffer.</p>
<h3 id="thread-hash"><a class="header" href="#thread-hash">Thread Hash</a></h3>
<p>A thread hash is computed by hashing the 298-byte thread state buffer with the Keccak256 hash function.</p>
<h3 id="thread-stack-hashing"><a class="header" href="#thread-stack-hashing">Thread Stack Hashing</a></h3>
<blockquote>
<p><strong>Note:</strong> The <code>++</code> operation represents concatenation of 2 byte string arguments</p>
</blockquote>
<p>Each thread stack is represented in the FPVM state by a "hash onion" construction using the Keccak256 hash
function. This construction provides a succinct commitment to the contents of a thread stack using a single <code>bytes32</code>
value:</p>
<ul>
<li>An empty stack is represented by the value:
<ul>
<li><code>c0 = hash(bytes32(0) ++ bytes32(0))</code></li>
</ul>
</li>
<li>To push a thread to the stack, hash the concatenation of the current stack commitment with the thread hash:
<ul>
<li><code>push(c0, el0) =&gt; c1 = hash(c0 ++ hash(el0))</code>.</li>
</ul>
</li>
<li>To push another thread:
<ul>
<li><code>push(c1, el1) =&gt; c2 = hash(c1 ++ hash(el1))</code>.</li>
</ul>
</li>
<li>To pop an element from the stack, peel back the last hash (push) operation:
<ul>
<li><code>pop(c2) =&gt; c3 = c1</code></li>
</ul>
</li>
<li>To prove the top value <code>elTop</code> on the stack, given some commitment <code>c</code>, you just need to reveal the <code>bytes32</code>
commitment <code>c'</code> for the stack without <code>elTop</code> and verify:
<ul>
<li><code>c = hash(c' ++ hash(elTop))</code></li>
</ul>
</li>
</ul>
<h2 id="memory"><a class="header" href="#memory">Memory</a></h2>
<p>Memory is represented as a binary merkle tree.
The tree has a fixed-depth of 59 levels, with leaf values of 32 bytes each.
This spans the full 64-bit address space, where each leaf contains the memory at that part of the tree.
The state <code>memRoot</code> represents the merkle root of the tree, reflecting the effects of memory writes.
As a result of this memory representation, all memory operations are <code>WordSize</code>-byte aligned.
Memory access doesn't require any privileges. An instruction step can access any memory
location as the entire address space is unprotected.</p>
<h3 id="heap"><a class="header" href="#heap">Heap</a></h3>
<p>FPVM state contains a <code>heap</code> that tracks the base address of the most recent memory allocation.
Heap pages are bump allocated at the page boundary, per <code>mmap</code> syscall.
mmap-ing is purely to satisfy program runtimes that need the memory-pointer
result of the syscall to locate free memory. The page size is 4096.</p>
<p>The FPVM has a fixed program break at <code>ProgramBreakAddress</code>. However, the FPVM is permitted to extend the
heap beyond this limit via mmap syscalls.
For simplicity, there are no memory protections against "heap overruns" against other memory segments.
Such VM steps are still considered valid state transitions.</p>
<p>Specification of memory mappings is outside the scope of this document as it is irrelevant to
the VM state. FPVM implementers may refer to the Linux/MIPS kernel for inspiration.</p>
<h4 id="mmap-hints"><a class="header" href="#mmap-hints">mmap hints</a></h4>
<p>When a process issues an mmap(2) syscall with a non-NULL addr parameter, the FPVM honors this hint as a strict requirement
rather than a suggestion. The VM unconditionally maps memory at exactly the requested address,
creating the mapping without performing address validity checks.</p>
<p>The VM does not validate whether the specified address range overlaps with existing mappings.
As this is a single-process execution environment, collision detection is delegated to userspace.
The calling process must track its own page mappings to avoid mapping conflicts, as the usual
kernel protections against overlapping mappings are not implemented.</p>
<h2 id="delay-slots"><a class="header" href="#delay-slots">Delay Slots</a></h2>
<p>The post-state of a step updates the <code>nextPC</code>, indicating the instruction following the <code>pc</code>.
However, in the case of where a branch instruction is being stepped, the <code>nextPC</code> post-state is
set to the branch target. And the <code>pc</code> post-state set to the branch delay slot as usual.</p>
<p>A VM state transition is invalid whenever the current instruction is a delay slot that is filled
with jump or branch type instruction.
That is, where <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">n</span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mord mathnormal" style="margin-right:0.07153em;">tPC</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel"><span class="mrel"><span class="mord vbox"><span class="thinbox"><span class="rlap"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="inner"><span class="mord"><span class="mrel">î€ </span></span></span><span class="fix"></span></span></span></span></span><span class="mrel">=</span></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">4</span></span></span></span> while stepping on a jump/branch instruction.
Otherwise, there would be two consecutive delay slots. While this is considered "undefined"
behavior in typical MIPS implementations, FPVM must raise an exception when stepping on such states.</p>
<h2 id="syscalls"><a class="header" href="#syscalls">Syscalls</a></h2>
<p>Syscalls work similar to <a href="https://www.linux-mips.org/wiki/Syscall">Linux/MIPS</a>, including the
syscall calling conventions and general syscall handling behavior.
However, the FPVM supports a subset of Linux/MIPS syscalls with slightly different behaviors.
These syscalls have identical syscall numbers and ABIs as Linux/MIPS.</p>
<p>For all of the following syscalls, an error is indicated by setting the return
register (<code>$v0</code>) to <code>MaxWord</code> and <code>errno</code> (<code>$a3</code>) is set accordingly.
The VM must not modify any register other than <code>$v0</code> and <code>$a3</code> during syscall handling.</p>
<p>The following tables summarize supported syscalls and their behaviors.
If an unsupported syscall is encountered, the VM will raise an exception.</p>
<h3 id="supported-syscalls"><a class="header" href="#supported-syscalls">Supported Syscalls</a></h3>
<!-- cspell:disable -->
<div class="table-wrapper"><table><thead><tr><th>$v0</th><th>system call</th><th>$a0</th><th>$a1</th><th>$a2</th><th>$a3</th><th>Effect</th></tr></thead><tbody>
<tr><td>5009</td><td>mmap</td><td>uint64 addr</td><td>uint64 len</td><td>ðŸš«</td><td>ðŸš«</td><td>Allocates a page from the heap. See <a href="fault-proof/cannon-fault-proof-vm.html#heap">heap</a> for details.</td></tr>
<tr><td>5012</td><td>brk</td><td>ðŸš«</td><td>ðŸš«</td><td>ðŸš«</td><td>ðŸš«</td><td>Returns a fixed address for the program break at <code>ProgramBreakAddress</code></td></tr>
<tr><td>5205</td><td>exit_group</td><td>uint8 exit_code</td><td>ðŸš«</td><td>ðŸš«</td><td>ðŸš«</td><td>Sets the exited and exitCode state fields to <code>true</code> and <code>$a0</code> respectively.</td></tr>
<tr><td>5000</td><td>read</td><td>uint64 fd</td><td>char *buf</td><td>uint64 count</td><td>ðŸš«</td><td>Similar behavior as Linux/MIPS with support for unaligned reads. See <a href="fault-proof/cannon-fault-proof-vm.html#io">I/O</a> for more details.</td></tr>
<tr><td>5001</td><td>write</td><td>uint64 fd</td><td>char *buf</td><td>uint64 count</td><td>ðŸš«</td><td>Similar behavior as Linux/MIPS with support for unaligned writes. See <a href="fault-proof/cannon-fault-proof-vm.html#io">I/O</a> for more details.</td></tr>
<tr><td>5070</td><td>fcntl</td><td>uint64 fd</td><td>int64 cmd</td><td>ðŸš«</td><td>ðŸš«</td><td>Similar behavior as Linux/MIPS. Only the <code>F_GETFD</code>(1) and <code>F_GETFL</code> (3) cmds are supported. Sets errno to <code>0x16</code> for all other commands.</td></tr>
<tr><td>5055</td><td>clone</td><td>uint64 flags</td><td>uint64 stack_ptr</td><td>ðŸš«</td><td>ðŸš«</td><td>Creates a new thread based on the currently active thread's state.  Supports a <code>flags</code> argument equal to <code>0x00050f00</code>, other values cause the VM to exit with exit_code <code>VmStatus.PANIC</code>.</td></tr>
<tr><td>5058</td><td>exit</td><td>uint8 exit_code</td><td>ðŸš«</td><td>ðŸš«</td><td>ðŸš«</td><td>Sets the active thread's exited and exitCode state fields to <code>true</code> and <code>$a0</code> respectively.</td></tr>
<tr><td>5023</td><td>sched_yield</td><td>ðŸš«</td><td>ðŸš«</td><td>ðŸš«</td><td>ðŸš«</td><td>Preempts the active thread and returns 0.</td></tr>
<tr><td>5178</td><td>gettid</td><td>ðŸš«</td><td>ðŸš«</td><td>ðŸš«</td><td>ðŸš«</td><td>Returns the active thread's threadID field.</td></tr>
<tr><td>5194</td><td>futex</td><td>uint64 addr</td><td>uint64 futex_op</td><td>uint64 val</td><td>uint64 *timeout</td><td>Supports <code>futex_op</code>'s <code>FUTEX_WAIT_PRIVATE</code> (128) and <code>FUTEX_WAKE_PRIVATE</code> (129). Other operations set errno to <code>0x16</code>.</td></tr>
<tr><td>5002</td><td>open</td><td>ðŸš«</td><td>ðŸš«</td><td>ðŸš«</td><td>ðŸš«</td><td>Sets errno to <code>EBADF</code>.</td></tr>
<tr><td>5034</td><td>nanosleep</td><td>ðŸš«</td><td>ðŸš«</td><td>ðŸš«</td><td>ðŸš«</td><td>Preempts the active thread and returns 0.</td></tr>
<tr><td>5222</td><td>clock_gettime</td><td>uint64 clock_id</td><td>uint64 addr</td><td>ðŸš«</td><td>ðŸš«</td><td>Supports <code>clock_id</code>'s <code>REALTIME</code>(0) and <code>MONOTONIC</code>(1). For other <code>clock_id</code>'s, sets errno to <code>0x16</code>.  Calculates a deterministic time value based on the state's <code>step</code> field and a constant <code>HZ</code> (10,000,000) where <code>HZ</code> represents the approximate clock rate (steps / second) of the FPVM:<br/><br/><code>seconds = step/HZ</code><br/><code>nsecs = (step % HZ) * 10^9/HZ</code><br/><br/>Seconds are set at memory address <code>addr</code> and nsecs are set at <code>addr + WordSize</code>.</td></tr>
<tr><td>5038</td><td>getpid</td><td>ðŸš«</td><td>ðŸš«</td><td>ðŸš«</td><td>ðŸš«</td><td>Returns 0.</td></tr>
<tr><td>5313</td><td>getrandom</td><td>char *buf</td><td>uint64 buflen</td><td>ðŸš«</td><td>ðŸš«</td><td>Generates pseudorandom bytes and writes them to the buffer at <code>buf</code>. Uses splitmix64 seeded with the current step count. Returns the number of bytes written, which is at most <code>buflen</code> and limited by alignment boundaries.</td></tr>
<tr><td>5284</td><td>eventfd2</td><td>uint64 initval</td><td>int64 flags</td><td>ðŸš«</td><td>ðŸš«</td><td>Creates an eventfd file descriptor. Only non-blocking mode is supported: if <code>flags</code> does not include <code>EFD_NONBLOCK</code> (0x80), sets errno to <code>0x16</code>. On success, returns file descriptor 100.</td></tr>
</tbody></table>
</div><!-- cspell:enable -->
<h3 id="noop-syscalls"><a class="header" href="#noop-syscalls">Noop Syscalls</a></h3>
<!-- cspell:disable -->
<p>For the following noop syscalls, the VM must do nothing except to zero out the syscall return (<code>$v0</code>)
and errno (<code>$a3</code>) registers.</p>
<div class="table-wrapper"><table><thead><tr><th>$v0</th><th>system call</th></tr></thead><tbody>
<tr><td>5011</td><td>munmap</td></tr>
<tr><td>5010</td><td>mprotect</td></tr>
<tr><td>5196</td><td>sched_get_affinity</td></tr>
<tr><td>5027</td><td>madvise</td></tr>
<tr><td>5014</td><td>rt_sigprocmask</td></tr>
<tr><td>5129</td><td>sigaltstack</td></tr>
<tr><td>5013</td><td>rt_sigaction</td></tr>
<tr><td>5297</td><td>prlimit64</td></tr>
<tr><td>5003</td><td>close</td></tr>
<tr><td>5016</td><td>pread64</td></tr>
<tr><td>5004</td><td>stat</td></tr>
<tr><td>5005</td><td>fstat</td></tr>
<tr><td>5247</td><td>openat</td></tr>
<tr><td>5087</td><td>readlink</td></tr>
<tr><td>5257</td><td>readlinkat</td></tr>
<tr><td>5015</td><td>ioctl</td></tr>
<tr><td>5285</td><td>epoll_create1</td></tr>
<tr><td>5287</td><td>pipe2</td></tr>
<tr><td>5208</td><td>epoll_ctl</td></tr>
<tr><td>5272</td><td>epoll_pwait</td></tr>
<tr><td>5061</td><td>uname</td></tr>
<tr><td>5100</td><td>getuid</td></tr>
<tr><td>5102</td><td>getgid</td></tr>
<tr><td>5026</td><td>mincore</td></tr>
<tr><td>5225</td><td>tgkill</td></tr>
<tr><td>5095</td><td>getrlimit</td></tr>
<tr><td>5008</td><td>lseek</td></tr>
<tr><td>5036</td><td>setitimer</td></tr>
<tr><td>5216</td><td>timer_create</td></tr>
<tr><td>5217</td><td>timer_settime</td></tr>
<tr><td>5220</td><td>timer_delete</td></tr>
</tbody></table>
</div><!-- cspell:enable -->
<h2 id="io"><a class="header" href="#io">I/O</a></h2>
<p>The VM does not support Linux open(2). However, the VM can read from and write to a predefined set of file descriptors.</p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>File descriptor</th><th>Description</th></tr></thead><tbody>
<tr><td>stdin</td><td>0</td><td>read-only standard input stream.</td></tr>
<tr><td>stdout</td><td>1</td><td>write-only standard output stream.</td></tr>
<tr><td>stderr</td><td>2</td><td>write-only standard error stream.</td></tr>
<tr><td>hint response</td><td>3</td><td>read-only. Used to read the status of <a href="fault-proof/../fault-proof/index.html#hinting">pre-image hinting</a>.</td></tr>
<tr><td>hint request</td><td>4</td><td>write-only. Used to provide <a href="fault-proof/../fault-proof/index.html#hinting">pre-image hints</a></td></tr>
<tr><td>pre-image response</td><td>5</td><td>read-only. Used to <a href="fault-proof/../fault-proof/index.html#pre-image-communication">read pre-images</a>.</td></tr>
<tr><td>pre-image request</td><td>6</td><td>write-only. Used to <a href="fault-proof/../fault-proof/index.html#pre-image-communication">request pre-images</a>.</td></tr>
<tr><td>eventfd</td><td>100</td><td>read-write. Created by <code>eventfd2</code> syscall. Reads return <code>EAGAIN</code>. Writes return <code>EAGAIN</code>.</td></tr>
</tbody></table>
</div>
<p>Syscalls referencing unknown file descriptors fail with an <code>EBADF</code> errno as done on Linux.</p>
<p>Writing to and reading from standard output, input and error streams have no effect on the FPVM state.
FPVM implementations may use them for debugging purposes as long as I/O is stateless.</p>
<p>All I/O operations are restricted to a maximum of <code>WordSize</code> bytes per operation.
Any read or write syscall request exceeding this limit will be truncated to <code>WordSize</code> bytes.
Consequently, the return value of read/write syscalls is at most <code>WordSize</code> bytes,
indicating the actual number of bytes read/written.</p>
<h3 id="standard-streams"><a class="header" href="#standard-streams">Standard Streams</a></h3>
<p>Writing to stderr/stdout standard stream always succeeds with the write count input returned,
effectively continuing execution without writing work.
Reading from stdin has no effect other than to return zero and errno set to 0, signalling that there is no input.</p>
<h3 id="hint-communication"><a class="header" href="#hint-communication">Hint Communication</a></h3>
<p>Hint requests and responses have no effect on the VM state other than setting the <code>$v0</code> return
register to the requested read/write count.
VM implementations may utilize hints to setup subsequent pre-image requests.</p>
<h3 id="pre-image-communication-1"><a class="header" href="#pre-image-communication-1">Pre-image Communication</a></h3>
<p>The <code>preimageKey</code> and <code>preimageOffset</code> state are updated via read/write syscalls to the pre-image
read and write file descriptors (see <a href="fault-proof/cannon-fault-proof-vm.html#io">I/O</a>).
The <code>preimageKey</code> buffers the stream of bytes written to the pre-image write fd.
The <code>preimageKey</code> buffer is shifted to accommodate new bytes written to the end of it.
A write also resets the <code>preimageOffset</code> to 0, indicating the intent to read a new pre-image.</p>
<p>When handling pre-image reads, the <code>preimageKey</code> is used to lookup the pre-image data from an Oracle.
A max <code>WordSize</code>-byte chunk of the pre-image at the <code>preimageOffset</code> is read to the specified address.
Each read operation increases the <code>preimageOffset</code> by the number of bytes requested
(truncated to <code>WordSize</code> bytes and subject to alignment constraints).</p>
<h4 id="pre-image-io-alignment"><a class="header" href="#pre-image-io-alignment">Pre-image I/O Alignment</a></h4>
<p>As mentioned earlier in <a href="fault-proof/cannon-fault-proof-vm.html#memory">memory</a>, all memory operations are <code>WordSize</code>-byte aligned.
Since pre-image I/O occurs on memory, all pre-image I/O operations must strictly adhere to alignment boundaries.
This means the start and end of a read/write operation must fall within the same alignment boundary.
If an operation were to violate this, the input <code>count</code> of the read/write syscall must be
truncated such that the effective address of the last byte read/written matches the input effective address.</p>
<p>The VM must read/write the maximum amount of bytes possible without crossing the input address alignment boundary.
For example, the effect of a write request for a 3-byte aligned buffer must be exactly 3 bytes.
If the buffer is misaligned, then the VM may write less than 3 bytes depending on the size of the misalignment.</p>
<h2 id="exceptions"><a class="header" href="#exceptions">Exceptions</a></h2>
<p>The FPVM may raise an exception rather than output a post-state to signal an invalid state
transition. Nominally, the FPVM must raise an exception in at least the following cases:</p>
<ul>
<li>Invalid instruction (either via an invalid opcode or an instruction referencing registers
outside the general purpose registers).</li>
<li>Unsupported syscall.</li>
<li>Pre-image read at an offset larger than the size of the pre-image.</li>
<li>Delay slot contains branch/jump instruction types.</li>
<li>Invalid thread state: the active thread stack is empty.</li>
</ul>
<p>VM implementations may raise an exception in other cases that is specific to the implementation.
For example, an on-chain FPVM that relies on pre-supplied merkle proofs for memory access may
raise an exception if the supplied merkle proof does not match the pre-state <code>memRoot</code>.</p>
<h2 id="security-model"><a class="header" href="#security-model">Security Model</a></h2>
<h3 id="compiler-correctness"><a class="header" href="#compiler-correctness">Compiler Correctness</a></h3>
<p>MTCannon is designed to prove the correctness of a particular state transition that emulates a MIPS64 machine.
MTCannon does not guarantee that the MIPS64 instructions correctly implement the program that the user intends to prove.
As a result, MTCannon's use as a Fault Proof system inherently depends to some extent on the correctness of the compiler
used to generate the MIPS64 instructions over which MTCannon operates.</p>
<p>To illustrate this concept, suppose that a user intends to prove simple program <code>input + 1 = output</code>.
Suppose then that the user's compiler for this program contains a bug and errantly generates the MIPS instructions for a
slightly different program <code>input + 2 = output</code>. Although MTCannon would correctly prove the operation of this compiled program,
the result proven would differ from the user's intent. MTCannon proves the MIPS state transition but makes no assertion about
the correctness of the translation between the user's high-level code and the resulting MIPS program.</p>
<p>As a consequence of the above, it is the responsibility of a program developer to develop tests that demonstrate that MTCannon
is capable of proving their intended program correctly over a large number of possible inputs. Such tests defend against
bugs in the user's compiler as well as ways in which the compiler may inadvertently break one of MTCannon's
<a href="fault-proof/cannon-fault-proof-vm.html#compiler-assumptions">Compiler Assumptions</a>. Users of Fault Proof systems are strongly encouraged to utilize multiple
proof systems and/or compilers to mitigate the impact of errant behavior in any one toolchain.</p>
<h3 id="compiler-assumptions"><a class="header" href="#compiler-assumptions">Compiler Assumptions</a></h3>
<p>MTCannon makes the simplifying assumption that users are utilizing compilers that do not rely on MIPS exception states for
standard program behavior. In other words, MTCannon generally assumes that the user's compiler generates spec-compliant
instructions that would not trigger an exception. Refer to <a href="fault-proof/cannon-fault-proof-vm.html#exceptions">Exceptions</a> for a list of conditions that are
explicitly handled.</p>
<p>Certain cases that would typically be asserted by a strict implementation of the MIPS64 specification are not handled by
MTCannon as follows:</p>
<ul>
<li><code>add</code>, <code>addi</code>, and <code>sub</code> do not trigger an exception on signed integer overflow.</li>
<li>Instruction encoding validation does not trigger an exception for fields that should be zero.</li>
<li>Memory instructions do not trigger an exception when addresses are not naturally aligned.</li>
</ul>
<p>Many compilers, including the Golang compiler, will not generate code that would trigger these conditions under bug-free
operation. Given the inherent reliance on <a href="fault-proof/cannon-fault-proof-vm.html#compiler-correctness">Compiler Correctness</a> in applications using MTCannon, the
tests and defense mechanisms that must necessarily be employed by MTCannon users to protect their particular programs
against compiler bugs should also suffice to surface bugs that would break these compiler assumptions. Stated simply, MTCannon
can rely on specific compiler behaviors because users inherently must employ safety nets to guard against compiler bugs.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<!-- DOCTOC SKIP -->
<h1 id="stage-one-decentralization"><a class="header" href="#stage-one-decentralization">Stage One Decentralization</a></h1>
<p>This section of the specification contains the system design for stage one decentralization, with a fault-proof system
for <a href="fault-proof/stage-one/../../glossary.html#l2-output-root-proposals">output proposals</a> and the integration with the <code>OptimismPortal</code> contract, which is the arbiter of
withdrawals on L1.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="anchorstateregistry"><a class="header" href="#anchorstateregistry">AnchorStateRegistry</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#overview">Overview</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#definitions">Definitions</a>
<ul>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#dispute-game">Dispute Game</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#respected-game-type">Respected Game Type</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#dispute-game-finality-delay-airgap">Dispute Game Finality Delay (Airgap)</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#registered-game">Registered Game</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#respected-game">Respected Game</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#blacklisted-game">Blacklisted Game</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#retirement-timestamp">Retirement Timestamp</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#retired-game">Retired Game</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#proper-game">Proper Game</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#resolved-game">Resolved Game</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#finalized-game">Finalized Game</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#valid-claim">Valid Claim</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#truly-valid-claim">Truly Valid Claim</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#starting-anchor-state">Starting Anchor State</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#anchor-game">Anchor Game</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#anchor-root">Anchor Root</a></li>
</ul>
</li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#assumptions">Assumptions</a>
<ul>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#aasr-001-dispute-game-contracts-properly-report-important-properties">aASR-001: Dispute Game contracts properly report important properties</a>
<ul>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#mitigations">Mitigations</a></li>
</ul>
</li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#aasr-002-disputegamefactory-properly-reports-its-created-games">aASR-002: DisputeGameFactory properly reports its created games</a>
<ul>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#mitigations-1">Mitigations</a></li>
</ul>
</li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#aasr-003-incorrectly-resolving-games-will-be-invalidated-before-they-have-valid-claims">aASR-003: Incorrectly resolving games will be invalidated before they have Valid Claims</a>
<ul>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#mitigations-2">Mitigations</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#invariants">Invariants</a>
<ul>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#iasr-001-games-are-represented-as-proper-games-accurately">iASR-001: Games are represented as Proper Games accurately</a>
<ul>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#impact">Impact</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#dependencies">Dependencies</a></li>
</ul>
</li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#iasr-002-all-valid-claims-are-truly-valid-claims">iASR-002: All Valid Claims are Truly Valid Claims</a>
<ul>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#impact-1">Impact</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#dependencies-1">Dependencies</a></li>
</ul>
</li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#iasr-003-the-anchor-game-is-a-truly-valid-claim">iASR-003: The Anchor Game is a Truly Valid Claim</a>
<ul>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#impact-2">Impact</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#dependencies-2">Dependencies</a></li>
</ul>
</li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#iasr-004-invalidation-functions-operate-correctly">iASR-004: Invalidation functions operate correctly</a>
<ul>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#impact-3">Impact</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#dependencies-3">Dependencies</a></li>
</ul>
</li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#iasr-005-the-anchor-game-is-recent-enough-to-be-fault-provable">iASR-005: The Anchor Game is recent enough to be fault provable</a>
<ul>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#impact-4">Impact</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#function-specification">Function Specification</a>
<ul>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#constructor">constructor</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#initialize">initialize</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#paused">paused</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#respectedgametype">respectedGameType</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#retirementtimestamp">retirementTimestamp</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#disputegamefinalitydelayseconds">disputeGameFinalityDelaySeconds</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#setrespectedgametype">setRespectedGameType</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#updateretirementtimestamp">updateRetirementTimestamp</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#blacklistdisputegame">blacklistDisputeGame</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#isgameregistered">isGameRegistered</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#isgamerespected">isGameRespected</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#isgameblacklisted">isGameBlacklisted</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#isgameretired">isGameRetired</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#isgameproper">isGameProper</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#isgameresolved">isGameResolved</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#isgamefinalized">isGameFinalized</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#isgameclaimvalid">isGameClaimValid</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#getanchorroot">getAnchorRoot</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#anchors">anchors</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#setanchorstate">setAnchorState</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-14"><a class="header" href="#overview-14">Overview</a></h2>
<p>The <code>AnchorStateRegistry</code> was designed as a registry where <code>DisputeGame</code> contracts could store and
register their results so that these results could be used as the starting states for new
<code>DisputeGame</code> instances. These starting states, called "anchor states", allow new <code>DisputeGame</code>
contracts to use a newer starting state to bound the size of the execution trace for any given
game.</p>
<p>We are generally aiming to shift the <code>AnchorStateRegistry</code> to act as a unified source of truth for
the validity of <code>DisputeGame</code> contracts and their corresponding root claims. This specification
corresponds to the first iteration of the <code>AnchorStateRegistry</code> that will move us in this
direction.</p>
<h2 id="definitions-1"><a class="header" href="#definitions-1">Definitions</a></h2>
<h3 id="dispute-game"><a class="header" href="#dispute-game">Dispute Game</a></h3>
<blockquote>
<p>See <a href="fault-proof/stage-one/fault-dispute-game.html">Fault Dispute Game</a></p>
</blockquote>
<p>A Dispute Game is a smart contract that makes a determination about the validity of some claim. In
the context of the OP Stack, the claim is generally assumed to be a claim about the value of an
output root at a given L2 block height. We assume that all Dispute Game contracts using the same
AnchorStateRegistry contract are arguing over the same underlying state/claim structure.</p>
<h3 id="respected-game-type"><a class="header" href="#respected-game-type">Respected Game Type</a></h3>
<p>The <code>AnchorStateRegistry</code> contract defines a <strong>Respected Game Type</strong> which is the Dispute Game type
that is considered to be the correct by the <code>AnchorStateRegistry</code> and, by extension, other
contracts that may rely on the assertions made within the <code>AnchorStateRegistry</code>. The Respected Game
Type is, in a more general sense, a game type that the system believes will resolve correctly. For
now, the <code>AnchorStateRegistry</code> only allows a single Respected Game Type.</p>
<h3 id="dispute-game-finality-delay-airgap"><a class="header" href="#dispute-game-finality-delay-airgap">Dispute Game Finality Delay (Airgap)</a></h3>
<p>The <strong>Dispute Game Finality Delay</strong> or <strong>Airgap</strong> is the amount of time that must elapse after a
game resolves before the game's result is considered "final".</p>
<h3 id="registered-game"><a class="header" href="#registered-game">Registered Game</a></h3>
<p>A Dispute Game is considered to be a <strong>Registered Game</strong> if the game contract was created by the
system's <code>DisputeGameFactory</code> contract.</p>
<h3 id="respected-game"><a class="header" href="#respected-game">Respected Game</a></h3>
<p>A Dispute Game is considered to be a <strong>Respected Game</strong> if the game contract's game type <strong>was</strong>
the Respected Game Type defined by the <code>AnchorStateRegistry</code> contract at the time of the game's
creation. Games that are not Respected Games cannot be used as an Anchor Game. See
<a href="fault-proof/stage-one/anchor-state-registry.html#respected-game-type">Respected Game Type</a> for more information.</p>
<h3 id="blacklisted-game"><a class="header" href="#blacklisted-game">Blacklisted Game</a></h3>
<p>A Dispute Game is considered to be a <strong>Blacklisted Game</strong> if the game contract's address is marked
as blacklisted inside of the <code>AnchorStateRegistry</code> contract.</p>
<h3 id="retirement-timestamp"><a class="header" href="#retirement-timestamp">Retirement Timestamp</a></h3>
<p>The <strong>Retirement Timestamp</strong> is a timestamp value maintained within the <code>AnchorStateRegistry</code> that
can be used to invalidate games. Games with a creation timestamp less than or equal to the
Retirement Timestamp are automatically considered to be invalid.</p>
<p>The RetirementTimestamp has the effect of retiring all games created before the specific
transaction in which the retirement timestamp was set. This includes all games created in the same
block as the transaction that set the Retirement Timestamp. We acknowledge the edge-case that games
created in the same block <em>after</em> the Retirement Timestamp was set will be considered Retired Games
even though they were technically created "after" the Retirement Timestamp was set.</p>
<h3 id="retired-game"><a class="header" href="#retired-game">Retired Game</a></h3>
<p>A Dispute Game is considered to be a <strong>Retired Game</strong> if the game contract was created with a
timestamp less than or equal to the <a href="fault-proof/stage-one/anchor-state-registry.html#retirement-timestamp">Retirement Timestamp</a>.</p>
<h3 id="proper-game"><a class="header" href="#proper-game">Proper Game</a></h3>
<p>A Dispute Game is considered to be a <strong>Proper Game</strong> if it has not been invalidated through any of
the mechanisms defined by the <code>AnchorStateRegistry</code> contract. A Proper Game is, in a sense, a
"clean" game that exists in the set of games that are playing out correctly in a bug-free manner. A
Dispute Game can be a Proper Game even if it has not yet resolved or resolves in favor of the
Challenger.</p>
<p>A Dispute Game that is <strong>NOT</strong> a Proper Game can also be referred to as an <strong>Improper Game</strong> for
brevity. A Dispute Game can go from being a Proper Game to later <em>not</em> being an <strong>Improper Game</strong>
if it is invalidated by being <a href="fault-proof/stage-one/anchor-state-registry.html#blacklisted-game">blacklisted</a> or <a href="fault-proof/stage-one/anchor-state-registry.html#retired-game">retired</a>.</p>
<p><strong>ALL</strong> Dispute Games <strong>TEMPORARILY</strong> become Improper Games while the
<a href="fault-proof/stage-one/../../protocol/stage-1.html#pause-mechanism">Pause Mechanism</a> is active. However, this is
a <em>temporary</em> condition such that Registered Games that are not invalidated by
<a href="fault-proof/stage-one/anchor-state-registry.html#blacklisted-game">blacklisting</a> or <a href="fault-proof/stage-one/anchor-state-registry.html#retired-game">retirement</a> will become Proper Games again
once the pause is lifted. The Pause Mechanism is therefore a way to <em>temporarily</em> prevent Dispute
Games from being used by consumers like the <code>OptimismPortal</code> while relevant parties coordinate the
use of some other invalidation mechanism.</p>
<p>A Game is considered to be a Proper Game if all of the following are true:</p>
<ul>
<li>The game is a <a href="fault-proof/stage-one/anchor-state-registry.html#registered-game">Registered Game</a></li>
<li>The game is <strong>NOT</strong> a <a href="fault-proof/stage-one/anchor-state-registry.html#blacklisted-game">Blacklisted Game</a></li>
<li>The game is <strong>NOT</strong> a <a href="fault-proof/stage-one/anchor-state-registry.html#retired-game">Retired Game</a></li>
<li>The <a href="fault-proof/stage-one/../../protocol/stage-1.html#pause-mechanism">Pause Mechanism</a> is not active</li>
</ul>
<h3 id="resolved-game"><a class="header" href="#resolved-game">Resolved Game</a></h3>
<p>A Dispute Game is considered to be a <strong>Resolved Game</strong> if the game has resolved a result in favor
of either the Challenger or the Defender.</p>
<h3 id="finalized-game"><a class="header" href="#finalized-game">Finalized Game</a></h3>
<p>A Dispute Game is considered to be a <strong>Finalized Game</strong> if all of the following are true:</p>
<ul>
<li>The game is a <a href="fault-proof/stage-one/anchor-state-registry.html#resolved-game">Resolved Game</a></li>
<li>The game resolved a result more than
<a href="fault-proof/stage-one/anchor-state-registry.html#dispute-game-finality-delay-airgap">Dispute Game Finality Delay</a> seconds ago as defined by the
<code>disputeGameFinalityDelaySeconds</code> variable in the <code>AnchorStateRegistry</code> contract.</li>
</ul>
<h3 id="valid-claim"><a class="header" href="#valid-claim">Valid Claim</a></h3>
<p>A Dispute Game is considered to have a <strong>Valid Claim</strong> if all of the following are true:</p>
<ul>
<li>The game is a <a href="fault-proof/stage-one/anchor-state-registry.html#proper-game">Proper Game</a></li>
<li>The game is a <a href="fault-proof/stage-one/anchor-state-registry.html#respected-game">Respected Game</a></li>
<li>The game is a <a href="fault-proof/stage-one/anchor-state-registry.html#finalized-game">Finalized Game</a></li>
<li>The game resolved in favor of the root claim (i.e., in favor of the Defender)</li>
</ul>
<h3 id="truly-valid-claim"><a class="header" href="#truly-valid-claim">Truly Valid Claim</a></h3>
<p>A Truly Valid Claim is a claim that accurately represents the correct root for the L2 block height
on the L2 system as would be reported by a perfect oracle for the L2 system state.</p>
<h3 id="starting-anchor-state"><a class="header" href="#starting-anchor-state">Starting Anchor State</a></h3>
<p>The Starting Anchor State is the anchor state (root and L2 block height) that is used as the
starting state for new Dispute Game instances when there is no current Anchor Game. The Starting
Anchor State is set during the initialization of the <code>AnchorStateRegistry</code> contract.</p>
<h3 id="anchor-game"><a class="header" href="#anchor-game">Anchor Game</a></h3>
<p>The Anchor Game is a game whose claim is used as the starting state for new Dispute Game instances.
A Game can become the Anchor Game if it has a Valid Claim and the claim's L2 block height is
greater than the claim of the current Anchor Game. If there is no current Anchor Game, a Game can
become the Anchor Game if it has a Valid Claim and the claim's L2 block height is greater than the
current Starting Anchor State's L2 block height.</p>
<p>After a Game becomes the Anchor Game, it will remain the Anchor Game until it is replaced by some
other Game. A Game that is retired after becoming the Anchor Game will remain the Anchor Game.</p>
<h3 id="anchor-root"><a class="header" href="#anchor-root">Anchor Root</a></h3>
<p>The Anchor Root is the root and L2 block height that is used as the starting state for new Dispute
Game instances. The value of the Anchor Root is the Starting Anchor State if no Anchor Game has
been set. Otherwise, the value of the Anchor Root is the root and L2 block height of the current
Anchor Game.</p>
<h2 id="assumptions"><a class="header" href="#assumptions">Assumptions</a></h2>
<blockquote>
<p><strong>NOTE:</strong> Assumptions are utilized by specific invariants and do not apply globally. Invariants
typically only rely on a subset of the following assumptions. Different invariants may rely on
different assumptions. Refer to individual invariants for their dependencies.</p>
</blockquote>
<h3 id="aasr-001-dispute-game-contracts-properly-report-important-properties"><a class="header" href="#aasr-001-dispute-game-contracts-properly-report-important-properties">aASR-001: Dispute Game contracts properly report important properties</a></h3>
<p>We assume that the <code>FaultDisputeGame</code> and <code>PermissionedDisputeGame</code> contracts properly and
faithfully report the following properties:</p>
<ul>
<li>Game type</li>
<li>L2 block number</li>
<li>Root claim value</li>
<li>Game extra data</li>
<li>Creation timestamp</li>
<li>Resolution timestamp</li>
<li>Resolution result</li>
<li>Whether the game was the respected game type at creation</li>
</ul>
<p>We also specifically assume that the game creation timestamp and the resolution timestamp are not
set to values in the future.</p>
<h4 id="mitigations"><a class="header" href="#mitigations">Mitigations</a></h4>
<ul>
<li>Existing audit on the <code>FaultDisputeGame</code> contract</li>
<li>Integration testing</li>
</ul>
<h3 id="aasr-002-disputegamefactory-properly-reports-its-created-games"><a class="header" href="#aasr-002-disputegamefactory-properly-reports-its-created-games">aASR-002: DisputeGameFactory properly reports its created games</a></h3>
<p>We assume that the <code>DisputeGameFactory</code> contract properly and faithfully reports the games it has
created.</p>
<h4 id="mitigations-1"><a class="header" href="#mitigations-1">Mitigations</a></h4>
<ul>
<li>Existing audit on the <code>DisputeGameFactory</code> contract</li>
<li>Integration testing</li>
</ul>
<h3 id="aasr-003-incorrectly-resolving-games-will-be-invalidated-before-they-have-valid-claims"><a class="header" href="#aasr-003-incorrectly-resolving-games-will-be-invalidated-before-they-have-valid-claims">aASR-003: Incorrectly resolving games will be invalidated before they have Valid Claims</a></h3>
<p>We assume that any games that are resolved incorrectly will be invalidated either by
<a href="fault-proof/stage-one/anchor-state-registry.html#blacklisted-game">blacklisting</a> or by <a href="fault-proof/stage-one/anchor-state-registry.html#retired-game">retirement</a> BEFORE they are considered to
have <a href="fault-proof/stage-one/anchor-state-registry.html#valid-claim">Valid Claims</a>.</p>
<p>Proper Games that resolve in favor the Defender will be considered to have Valid Claims after the
<a href="fault-proof/stage-one/anchor-state-registry.html#dispute-game-finality-delay-airgap">Dispute Game Finality Delay</a> has elapsed UNLESS the
Pause Mechanism is active. Therefore, in the absence of the Pause Mechanism, parties responsible
for game invalidation have exactly the Dispute Game Finality Delay to invalidate a withdrawal after
it resolves incorrectly. If the Pause Mechanism is active, then any incorrectly resolving games
must be invalidated before the pause is deactivated.</p>
<h4 id="mitigations-2"><a class="header" href="#mitigations-2">Mitigations</a></h4>
<ul>
<li>Stakeholder incentives / processes</li>
<li>Incident response plan</li>
<li>Monitoring</li>
</ul>
<h2 id="invariants"><a class="header" href="#invariants">Invariants</a></h2>
<h3 id="iasr-001-games-are-represented-as-proper-games-accurately"><a class="header" href="#iasr-001-games-are-represented-as-proper-games-accurately">iASR-001: Games are represented as Proper Games accurately</a></h3>
<p>When asked if a game is a Proper Game, the <code>AnchorStateRegistry</code> must serve a response that is
identical to the response that would be given by a perfect oracle for this query.</p>
<h4 id="impact"><a class="header" href="#impact">Impact</a></h4>
<p><strong>Severity: High</strong></p>
<p>If this invariant is broken, the Anchor Game could be set to an incorrect value, which would cause
future Dispute Game instances to use an incorrect starting state. This would lead games to resolve
incorrectly. Additionally, this could cause a <code>FaultDisputeGame</code> to incorrectly choose the wrong
bond refunding mode.</p>
<h4 id="dependencies"><a class="header" href="#dependencies">Dependencies</a></h4>
<ul>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#aasr-001-dispute-game-contracts-properly-report-important-properties">aASR-001</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#aasr-002-disputegamefactory-properly-reports-its-created-games">aASR-002</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#aasr-003-incorrectly-resolving-games-will-be-invalidated-before-they-have-valid-claims">aASR-003</a></li>
</ul>
<h3 id="iasr-002-all-valid-claims-are-truly-valid-claims"><a class="header" href="#iasr-002-all-valid-claims-are-truly-valid-claims">iASR-002: All Valid Claims are Truly Valid Claims</a></h3>
<p>When asked if a game has a Valid Claim, the <code>AnchorStateRegistry</code> must serve a response that is
identical to the response that would be given by a perfect oracle for this query. However, it is
important to note that we do NOT say that all Truly Valid Claims are Valid Claims. It is possible
that a game has a Truly Valid Claim but the <code>AnchorStateRegistry</code> reports that the claim is not
a Valid Claim. This permits the <code>AnchorStateRegistry</code> and system-wide safety net actions to err on
the side of caution.</p>
<p>In a nutshell, the set of Valid Claims is a subset of the set of Truly Valid Claims.</p>
<h4 id="impact-1"><a class="header" href="#impact-1">Impact</a></h4>
<p><strong>Severity: Critical</strong></p>
<p>If this invariant is broken, then any component that relies on the correctness of this function may
allow actions to occur based on invalid dispute games.</p>
<p>Some examples of strong negative impact are:</p>
<ul>
<li>Invalid Dispute Game could be used as the Anchor Game, which would cause future Dispute Game
instances to use an incorrect starting state. This would lead these games to resolve incorrectly.
<strong>(HIGH)</strong></li>
<li>Invalid Dispute Game could be used to prove or finalize withdrawals within the <code>OptimismPortal</code>
contract. This would lead to a critical vulnerability in the bridging system. <strong>(CRITICAL)</strong></li>
</ul>
<h4 id="dependencies-1"><a class="header" href="#dependencies-1">Dependencies</a></h4>
<ul>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#aasr-001-dispute-game-contracts-properly-report-important-properties">aASR-001</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#aasr-002-disputegamefactory-properly-reports-its-created-games">aASR-002</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#aasr-003-incorrectly-resolving-games-will-be-invalidated-before-they-have-valid-claims">aASR-003</a></li>
</ul>
<h3 id="iasr-003-the-anchor-game-is-a-truly-valid-claim"><a class="header" href="#iasr-003-the-anchor-game-is-a-truly-valid-claim">iASR-003: The Anchor Game is a Truly Valid Claim</a></h3>
<p>We require that the Anchor Game is a Truly Valid Claim. This makes it possible to use the Anchor
Game as the starting state for new Dispute Game instances. Notably, given the allowance that not
all Truly Valid Claims are Valid Claims, this invariant does not imply that the Anchor Game is a
Valid Claim.</p>
<p>We allow retired games to be used as the Anchor Game because the retirement mechanism is broad in a
way that commonly causes Truly Valid Claims to no longer be considered Valid Claims. We allow both
blacklisted games and retired games to remain the Anchor Game if they are already the Anchor Game.
This is because we assume games that become the Anchor Game would be invalidated <em>before</em> becoming
the Anchor Game. After the game becomes the Anchor Game, it would be possible to use that game to
execute withdrawals from the system, which would already be a critical bug in the system.</p>
<h4 id="impact-2"><a class="header" href="#impact-2">Impact</a></h4>
<p><strong>Severity: High</strong></p>
<p>If this invariant is broken, an invalid Anchor Game could be used as the starting state for new
Dispute Game instances. This would lead games to resolve incorrectly.</p>
<h4 id="dependencies-2"><a class="header" href="#dependencies-2">Dependencies</a></h4>
<ul>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#aasr-001-dispute-game-contracts-properly-report-important-properties">aASR-001</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#aasr-002-disputegamefactory-properly-reports-its-created-games">aASR-002</a></li>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#aasr-003-incorrectly-resolving-games-will-be-invalidated-before-they-have-valid-claims">aASR-003</a></li>
</ul>
<h3 id="iasr-004-invalidation-functions-operate-correctly"><a class="header" href="#iasr-004-invalidation-functions-operate-correctly">iASR-004: Invalidation functions operate correctly</a></h3>
<p>We require that the blacklisting and retirement functions operate correctly. Games that are
blacklisted must not be used as the Anchor Game, must not be considered Valid Games, and must not
be usable to prove or finalize withdrawals. Any game created before a transaction that updates the
retirement timestamp must not be set as the Anchor Game, must not be considered Valid Games, and
must not be usable to prove or finalize withdrawals.</p>
<h4 id="impact-3"><a class="header" href="#impact-3">Impact</a></h4>
<p><strong>Severity: High/Critical</strong></p>
<p>If this invariant is broken, the Anchor Game could be set to an incorrect value, which would cause
future Dispute Game instances to use an incorrect starting state. This would lead games to resolve
incorrectly and would be considered a High Severity issue. Issues that would allow users to
finalize withdrawals with invalidated games would be considered Critical Severity.</p>
<h4 id="dependencies-3"><a class="header" href="#dependencies-3">Dependencies</a></h4>
<ul>
<li><a href="fault-proof/stage-one/anchor-state-registry.html#aasr-003-incorrectly-resolving-games-will-be-invalidated-before-they-have-valid-claims">aASR-003</a></li>
</ul>
<h3 id="iasr-005-the-anchor-game-is-recent-enough-to-be-fault-provable"><a class="header" href="#iasr-005-the-anchor-game-is-recent-enough-to-be-fault-provable">iASR-005: The Anchor Game is recent enough to be fault provable</a></h3>
<p>We require that the Anchor Game corresponds to an L2 block with an L1 origin timestamp that is no
older than 6 months from the current timestamp. This time constraint is necessary because the fault
proof VM must walk backwards through L1 blocks to verify derivation, and processing 7 months worth
of L1 blocks approaches the maximum time available to challengers in the dispute game process.</p>
<h4 id="impact-4"><a class="header" href="#impact-4">Impact</a></h4>
<p><strong>Severity: High</strong></p>
<p>If this invariant is broken, challengers will be unable to participate in fault proofs within the
allotted response time, and resolution would require intervention from the Proxy Admin Owner.</p>
<h2 id="function-specification"><a class="header" href="#function-specification">Function Specification</a></h2>
<h3 id="constructor"><a class="header" href="#constructor">constructor</a></h3>
<ul>
<li>MUST set the value of the <a href="fault-proof/stage-one/anchor-state-registry.html#dispute-game-finality-delay-airgap">Dispute Game Finality Delay</a>.</li>
</ul>
<h3 id="initialize"><a class="header" href="#initialize">initialize</a></h3>
<ul>
<li>MUST only be callable by the ProxyAdmin or its owner.</li>
<li>MUST only be triggerable once.</li>
<li>MUST set the value of the <code>SystemConfig</code> contract that stores the address of the Guardian.</li>
<li>MUST set the value of the <code>DisputeGameFactory</code> contract that creates Dispute Game instances.</li>
<li>MUST set the value of the <a href="fault-proof/stage-one/anchor-state-registry.html#starting-anchor-state">Starting Anchor State</a>.</li>
<li>MUST set the value of the initial <a href="fault-proof/stage-one/anchor-state-registry.html#respected-game-type">Respected Game Type</a>.</li>
<li>MUST set the value of the <a href="fault-proof/stage-one/anchor-state-registry.html#retirement-timestamp">Retirement Timestamp</a> to the current block
timestamp. NOTE that this is a safety mechanism that invalidates all existing Dispute Game
contracts to support the safe transition away from the <code>OptimismPortal</code> as the source of truth
for game validity. In this way, the <code>AnchorStateRegistry</code> does not need to consider the state of
the legacy blacklisting/retirement mechanisms within the <code>OptimismPortal</code> and starts from a clean
slate.</li>
</ul>
<h3 id="paused"><a class="header" href="#paused">paused</a></h3>
<p>Returns the value of <code>paused()</code> from the <code>SystemConfig</code> contract.</p>
<h3 id="respectedgametype"><a class="header" href="#respectedgametype">respectedGameType</a></h3>
<p>Returns the value of the currently <a href="fault-proof/stage-one/anchor-state-registry.html#respected-game-type">Respected Game Type</a>.</p>
<h3 id="retirementtimestamp"><a class="header" href="#retirementtimestamp">retirementTimestamp</a></h3>
<p>Returns the value of the current <a href="fault-proof/stage-one/anchor-state-registry.html#retirement-timestamp">Retirement Timestamp</a>.</p>
<h3 id="disputegamefinalitydelayseconds"><a class="header" href="#disputegamefinalitydelayseconds">disputeGameFinalityDelaySeconds</a></h3>
<p>Returns the value of the <a href="fault-proof/stage-one/anchor-state-registry.html#dispute-game-finality-delay-airgap">Dispute Game Finality Delay</a>.</p>
<h3 id="setrespectedgametype"><a class="header" href="#setrespectedgametype">setRespectedGameType</a></h3>
<p>Permits the Guardian role to set the <a href="fault-proof/stage-one/anchor-state-registry.html#respected-game-type">Respected Game Type</a>.</p>
<ul>
<li>MUST revert if called by any address other than the Guardian.</li>
<li>MUST update the respected game type with the provided type.</li>
<li>MUST emit an event showing that the game type was updated.</li>
</ul>
<h3 id="updateretirementtimestamp"><a class="header" href="#updateretirementtimestamp">updateRetirementTimestamp</a></h3>
<p>Permits the Guardian role to update the <a href="fault-proof/stage-one/anchor-state-registry.html#retirement-timestamp">Retirement Timestamp</a>.</p>
<ul>
<li>MUST revert if called by any address other than the Guardian.</li>
<li>MUST set the retirement timestamp to the current block timestamp.</li>
<li>MUST emit an event showing that the retirement timestamp was updated.</li>
</ul>
<h3 id="blacklistdisputegame"><a class="header" href="#blacklistdisputegame">blacklistDisputeGame</a></h3>
<p>Permits the Guardian role to <a href="fault-proof/stage-one/anchor-state-registry.html#blacklisted-game">blacklist</a> a Dispute Game.</p>
<ul>
<li>MUST revert if called by any address other than the Guardian.</li>
<li>MUST mark the game as blacklisted.</li>
<li>MUST emit an event showing that the game was blacklisted.</li>
</ul>
<h3 id="isgameregistered"><a class="header" href="#isgameregistered">isGameRegistered</a></h3>
<p>Determines if a game is a Registered Game.</p>
<ul>
<li>MUST return <code>true</code> if and only if the game was created by the system's <code>DisputeGameFactory</code>
contract AND the game's <code>AnchorStateRegistry</code> address matches the address of this contract.</li>
</ul>
<h3 id="isgamerespected"><a class="header" href="#isgamerespected">isGameRespected</a></h3>
<p>Determines if a game is a Respected Game.</p>
<ul>
<li>MUST return <code>true</code> if and only if the game's game type was the respected game type defined by the
<code>AnchorStateRegistry</code> contract at the time of the game's creation as per a call to
<code>AnchorStateRegistry.respectedGameType()</code>.</li>
</ul>
<h3 id="isgameblacklisted"><a class="header" href="#isgameblacklisted">isGameBlacklisted</a></h3>
<p>Determines if a game is a Blacklisted Game.</p>
<ul>
<li>MUST return <code>true</code> if and only if the game's address is marked as blacklisted inside of the
<code>AnchorStateRegistry</code> contract.</li>
</ul>
<h3 id="isgameretired"><a class="header" href="#isgameretired">isGameRetired</a></h3>
<p>Determines if a game is a Retired Game.</p>
<ul>
<li>MUST return <code>true</code> if and only if the game was created before or at the retirement timestamp
defined by the <code>AnchorStateRegistry</code> contract as per a call to
<code>AnchorStateRegistry.retirementTimestamp()</code>. We check for less than or equal to the current
retirement timestamp to prevent games from being created in the same block but before the
transaction in which the retirement timestamp was set. Note that this has the side effect of also
invalidating any games created in the same block <em>after</em> the retirement timestamp was set but
this is an acceptable tradeoff.</li>
</ul>
<h3 id="isgameproper"><a class="header" href="#isgameproper">isGameProper</a></h3>
<p>Determines if a game is a Proper Game.</p>
<ul>
<li>MUST return <code>true</code> if and only if <code>isGameRegistered(game)</code> is <code>true</code>, <code>isGameBlacklisted(game)</code>
and <code>isGameRetired(game)</code> are both <code>false</code>, and <code>paused()</code> is <code>false</code>.</li>
</ul>
<h3 id="isgameresolved"><a class="header" href="#isgameresolved">isGameResolved</a></h3>
<p>Determines if a game is a Resolved Game.</p>
<ul>
<li>MUST return <code>true</code> if and only if the game has resolved a result in favor of either the
Challenger or the Defender as determined by the <code>FaultDisputeGame.status()</code> function.</li>
</ul>
<h3 id="isgamefinalized"><a class="header" href="#isgamefinalized">isGameFinalized</a></h3>
<p>Determines if a game is a Finalized Game.</p>
<ul>
<li>MUST return <code>true</code> if and only if <code>isGameResolved(game)</code> and the game has resolved a result more
than the airgap delay seconds ago as defined by the <code>disputeGameFinalityDelaySeconds</code> variable in
the <code>AnchorStateRegistry</code> contract.</li>
</ul>
<h3 id="isgameclaimvalid"><a class="header" href="#isgameclaimvalid">isGameClaimValid</a></h3>
<p>Determines if a game has a Valid Claim.</p>
<ul>
<li>MUST return <code>true</code> if and only if <code>isGameProper(game)</code> is <code>true</code>, <code>isGameRespected(game)</code> is
<code>true</code>, <code>isGameFinalized(game)</code> is <code>true</code>, and the game resolved in favor of the root claim
(i.e., in favor of the Defender).</li>
</ul>
<h3 id="getanchorroot"><a class="header" href="#getanchorroot">getAnchorRoot</a></h3>
<p>Retrieves the current anchor root.</p>
<ul>
<li>MUST return the root hash and L2 block height of the current anchor state.</li>
</ul>
<h3 id="anchors"><a class="header" href="#anchors">anchors</a></h3>
<p>Legacy function. Accepts a game type as a parameter but does not use it.</p>
<ul>
<li>MUST return the current value of <code>getAnchorRoot()</code>.</li>
</ul>
<h3 id="setanchorstate"><a class="header" href="#setanchorstate">setAnchorState</a></h3>
<p>Allows any address to attempt to update the Anchor Game with a new Game as input.</p>
<ul>
<li>MUST revert if the provided game does not have a Valid Claim for any reason.</li>
<li>MUST revert if the provided game corresponds to an L2 block height that is less than or equal
to the current anchor state's L2 block height.</li>
<li>MUST otherwise update the anchor state to match the game's result.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="dispute-game-interface"><a class="header" href="#dispute-game-interface">Dispute Game Interface</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="fault-proof/stage-one/dispute-game-interface.html#overview">Overview</a></li>
<li><a href="fault-proof/stage-one/dispute-game-interface.html#types">Types</a></li>
<li><a href="fault-proof/stage-one/dispute-game-interface.html#disputegamefactory-interface"><code>DisputeGameFactory</code> Interface</a></li>
<li><a href="fault-proof/stage-one/dispute-game-interface.html#disputegame-interface"><code>DisputeGame</code> Interface</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-15"><a class="header" href="#overview-15">Overview</a></h2>
<p>A dispute game is played between multiple parties when contesting the truthiness
of a claim. In the context of an optimistic rollup, claims are made about the
state of the layer two network to enable withdrawals to the layer one. A proposer
makes a claim about the layer two state such that they can withdraw and a
challenger can dispute the validity of the claim. The security of the layer two
comes from the ability of fraudulent withdrawals being able to be disputed.</p>
<p>A dispute game interface is defined to allow for multiple implementations of
dispute games to exist. If multiple dispute games run in production, it gives
a similar security model as having multiple protocol clients, as a bug in a
single dispute game will not result in the bug becoming consensus.</p>
<h2 id="types"><a class="header" href="#types">Types</a></h2>
<p>For added context, we define a few types that are used in the following snippets.</p>
<pre><code class="language-solidity">/// @notice A `Claim` type represents a 32 byte hash or other unique identifier for a claim about
///         a certain piece of information.
type Claim is bytes32;

/// @notice A custom type for a generic hash.
type Hash is bytes32;

/// @notice A dedicated timestamp type.
type Timestamp is uint64;

/// @notice A `GameType` represents the type of game being played.
type GameType is uint32;

/// @notice A `GameId` represents a packed 4 byte game type, a 8 byte timestamp, and a 20 byte address.
/// @dev The packed layout of this type is as follows:
/// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
/// â”‚   Bits    â”‚   Value   â”‚
/// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
/// â”‚ [0, 32)   â”‚ Game Type â”‚
/// â”‚ [32, 96)  â”‚ Timestamp â”‚
/// â”‚ [96, 256) â”‚ Address   â”‚
/// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
type GameId is bytes32;

/// @title GameTypes
/// @notice A library that defines the IDs of games that can be played.
library GameTypes {
    /// @dev A dispute game type the uses the cannon vm.
    GameType internal constant CANNON = GameType.wrap(0);

    /// @dev A dispute game type that performs output bisection and then uses the cannon vm.
    GameType internal constant OUTPUT_CANNON = GameType.wrap(1);

    /// @notice A dispute game type that performs output bisection and then uses an alphabet vm.
    ///         Not intended for production use.
    GameType internal constant OUTPUT_ALPHABET = GameType.wrap(254);

    /// @notice A dispute game type that uses an alphabet vm.
    ///         Not intended for production use.
    GameType internal constant ALPHABET = GameType.wrap(255);
}

/// @notice The current status of the dispute game.
enum GameStatus {
    /// @dev The game is currently in progress, and has not been resolved.
    IN_PROGRESS,
    /// @dev The game has concluded, and the `rootClaim` was challenged successfully.
    CHALLENGER_WINS,
    /// @dev The game has concluded, and the `rootClaim` could not be contested.
    DEFENDER_WINS
}
</code></pre>
<h2 id="disputegamefactory-interface"><a class="header" href="#disputegamefactory-interface"><code>DisputeGameFactory</code> Interface</a></h2>
<p>The dispute game factory is responsible for creating new <code>DisputeGame</code> contracts
given a <code>GameType</code> and a root <code>Claim</code>. Challenger agents listen to the <code>DisputeGameCreated</code> events in order to
keep up with on-going disputes in the protocol and participate accordingly.</p>
<p>A <a href="https://github.com/Vectorized/solady/blob/main/src/utils/LibClone.sol"><code>clones-with-immutable-args</code></a> factory
(originally by @wighawag, but forked and improved by @Vectorized) is used to create Clones. Each <code>GameType</code> has
a corresponding implementation within the factory, and when a new game is created, the factory creates a
clone of the <code>GameType</code>'s pre-deployed implementation contract.</p>
<p>The <code>rootClaim</code> of created dispute games can either be a claim that the creator agrees or disagrees with.
This is an implementation detail that is left up to the <code>IDisputeGame</code> to handle within its <code>resolve</code> function.</p>
<p>When the <code>DisputeGameFactory</code> creates a new <code>DisputeGame</code> contract, it calls <code>initialize()</code> on the clone to
set up the game. The factory passes immutable arguments to the clone using the CWIA (Clone With Immutable Args)
pattern. There are two CWIA layouts depending on whether the game type has implementation args configured:</p>
<p><strong>Standard CWIA Layout</strong> (when <code>gameArgs[_gameType]</code> is empty):</p>
<div class="table-wrapper"><table><thead><tr><th>Bytes</th><th>Description</th></tr></thead><tbody>
<tr><td>[0, 20)</td><td>Game creator address</td></tr>
<tr><td>[20, 52)</td><td>Root claim</td></tr>
<tr><td>[52, 84)</td><td>Parent block hash at creation time</td></tr>
<tr><td>[84, 84 + n)</td><td>Extra data (opaque)</td></tr>
</tbody></table>
</div>
<p><strong>Extended CWIA Layout</strong> (when <code>gameArgs[_gameType]</code> is non-empty):</p>
<div class="table-wrapper"><table><thead><tr><th>Bytes</th><th>Description</th></tr></thead><tbody>
<tr><td>[0, 20)</td><td>Game creator address</td></tr>
<tr><td>[20, 52)</td><td>Root claim</td></tr>
<tr><td>[52, 84)</td><td>Parent block hash at creation time</td></tr>
<tr><td>[84, 88)</td><td>Game type</td></tr>
<tr><td>[88, 88 + n)</td><td>Extra data (opaque)</td></tr>
<tr><td>[88 + n, 88 + n + m)</td><td>Implementation args (opaque)</td></tr>
</tbody></table>
</div>
<p>The implementation args allow chain-specific configuration to be passed to the game implementation at clone
creation time, enabling a single implementation contract to be reused across different chain configurations.</p>
<pre><code class="language-solidity">/// @title IDisputeGameFactory
/// @notice The interface for a DisputeGameFactory contract.
interface IDisputeGameFactory {
    /// @notice Emitted when a new dispute game is created
    /// @param disputeProxy The address of the dispute game proxy
    /// @param gameType The type of the dispute game proxy's implementation
    /// @param rootClaim The root claim of the dispute game
    event DisputeGameCreated(address indexed disputeProxy, GameType indexed gameType, Claim indexed rootClaim);

    /// @notice Emitted when a new game implementation added to the factory
    /// @param impl The implementation contract for the given `GameType`.
    /// @param gameType The type of the DisputeGame.
    event ImplementationSet(address indexed impl, GameType indexed gameType);

    /// @notice Emitted when a game type's implementation args are set
    /// @param gameType The type of the DisputeGame.
    /// @param args The constructor args for the game type.
    event ImplementationArgsSet(GameType indexed gameType, bytes args);

    /// @notice Emitted when a game type's initialization bond is updated
    /// @param gameType The type of the DisputeGame.
    /// @param newBond The new bond (in wei) for initializing the game type.
    event InitBondUpdated(GameType indexed gameType, uint256 indexed newBond);

    /// @notice Information about a dispute game found in a `findLatestGames` search.
    struct GameSearchResult {
        uint256 index;
        GameId metadata;
        Timestamp timestamp;
        Claim rootClaim;
        bytes extraData;
    }

    /// @notice The total number of dispute games created by this factory.
    /// @return gameCount_ The total number of dispute games created by this factory.
    function gameCount() external view returns (uint256 gameCount_);

    /// @notice `games` queries an internal mapping that maps the hash of
    ///         `gameType ++ rootClaim ++ extraData` to the deployed `DisputeGame` clone.
    /// @dev `++` equates to concatenation.
    /// @param _gameType The type of the DisputeGame - used to decide the proxy implementation
    /// @param _rootClaim The root claim of the DisputeGame.
    /// @param _extraData Any extra data that should be provided to the created dispute game.
    /// @return proxy_ The clone of the `DisputeGame` created with the given parameters.
    ///         Returns `address(0)` if nonexistent.
    /// @return timestamp_ The timestamp of the creation of the dispute game.
    function games(
        GameType _gameType,
        Claim _rootClaim,
        bytes calldata _extraData
    )
        external
        view
        returns (IDisputeGame proxy_, Timestamp timestamp_);

    /// @notice `gameAtIndex` returns the dispute game contract address and its creation timestamp
    ///          at the given index. Each created dispute game increments the underlying index.
    /// @param _index The index of the dispute game.
    /// @return gameType_ The type of the DisputeGame - used to decide the proxy implementation.
    /// @return timestamp_ The timestamp of the creation of the dispute game.
    /// @return proxy_ The clone of the `DisputeGame` created with the given parameters.
    ///         Returns `address(0)` if nonexistent.
    function gameAtIndex(uint256 _index)
        external
        view
        returns (GameType gameType_, Timestamp timestamp_, IDisputeGame proxy_);

    /// @notice `gameImpls` is a mapping that maps `GameType`s to their respective
    ///         `IDisputeGame` implementations.
    /// @param _gameType The type of the dispute game.
    /// @return impl_ The address of the implementation of the game type.
    ///         Will be cloned on creation of a new dispute game with the given `gameType`.
    function gameImpls(GameType _gameType) external view returns (IDisputeGame impl_);

    /// @notice Returns the required bonds for initializing a dispute game of the given type.
    /// @param _gameType The type of the dispute game.
    /// @return bond_ The required bond for initializing a dispute game of the given type.
    function initBonds(GameType _gameType) external view returns (uint256 bond_);

    /// @notice Returns the chain-specific configuration arguments for a given game type's implementation.
    /// @dev These arguments are typically passed to the game implementation during proxy creation using CWIA.
    /// @param _gameType The type of the dispute game.
    /// @return args_ The chain-specific configuration arguments.
    function gameArgs(GameType _gameType) external view returns (bytes memory args_);

    /// @notice Creates a new DisputeGame proxy contract.
    /// @param _gameType The type of the DisputeGame - used to decide the proxy implementation.
    /// @param _rootClaim The root claim of the DisputeGame.
    /// @param _extraData Any extra data that should be provided to the created dispute game.
    /// @return proxy_ The address of the created DisputeGame proxy.
    function create(
        GameType _gameType,
        Claim _rootClaim,
        bytes calldata _extraData
    )
        external
        payable
        returns (IDisputeGame proxy_);

    /// @notice Sets the implementation contract for a specific `GameType`.
    /// @dev May only be called by the `owner`.
    /// @param _gameType The type of the DisputeGame.
    /// @param _impl The implementation contract for the given `GameType`.
    /// @param _args The chain-specific configuration arguments for this game type's implementation.
    function setImplementation(GameType _gameType, IDisputeGame _impl, bytes calldata _args) external;

    /// @notice Sets the bond (in wei) for initializing a game type.
    /// @dev May only be called by the `owner`.
    /// @param _gameType The type of the DisputeGame.
    /// @param _initBond The bond (in wei) for initializing a game type.
    function setInitBond(GameType _gameType, uint256 _initBond) external;

    /// @notice Returns a unique identifier for the given dispute game parameters.
    /// @dev Hashes the concatenation of `gameType . rootClaim . extraData`
    ///      without expanding memory.
    /// @param _gameType The type of the DisputeGame.
    /// @param _rootClaim The root claim of the DisputeGame.
    /// @param _extraData Any extra data that should be provided to the created dispute game.
    /// @return uuid_ The unique identifier for the given dispute game parameters.
    function getGameUUID(
        GameType _gameType,
        Claim _rootClaim,
        bytes memory _extraData
    )
        external
        pure
        returns (Hash uuid_);

    /// @notice Finds the `_n` most recent `GameId`'s of type `_gameType` starting at `_start`. If there are less than
    ///         `_n` games of type `_gameType` starting at `_start`, then the returned array will be shorter than `_n`.
    /// @param _gameType The type of game to find.
    /// @param _start The index to start the reverse search from.
    /// @param _n The number of games to find.
    function findLatestGames(
        GameType _gameType,
        uint256 _start,
        uint256 _n
    )
        external
        view
        returns (GameSearchResult[] memory games_);
}
</code></pre>
<h2 id="disputegame-interface"><a class="header" href="#disputegame-interface"><code>DisputeGame</code> Interface</a></h2>
<p>The dispute game interface defines a generic, black-box dispute. It exposes stateful information such as the status of
the dispute, when it was created, as well as the bootstrap data and dispute type. This interface exposes one state
mutating function, <code>resolve</code>, which when implemented should deterministically yield an opinion about the <code>rootClaim</code>
and reflect the opinion by updating the <code>status</code> to <code>CHALLENGER_WINS</code> or <code>DEFENDER_WINS</code>.</p>
<p>Clones of the <code>IDisputeGame</code>'s <code>initialize</code> functions will be called by the <code>DisputeGameFactory</code> atomically upon
creation.</p>
<pre><code class="language-solidity">/// @title IDisputeGame
/// @notice The generic interface for a DisputeGame contract.
interface IDisputeGame is IInitializable {
    /// @notice Emitted when the game is resolved.
    /// @param status The status of the game after resolution.
    event Resolved(GameStatus indexed status);

    /// @notice Returns the timestamp that the DisputeGame contract was created at.
    /// @return createdAt_ The timestamp that the DisputeGame contract was created at.
    function createdAt() external view returns (Timestamp createdAt_);

    /// @notice Returns the timestamp that the DisputeGame contract was resolved at.
    /// @return resolvedAt_ The timestamp that the DisputeGame contract was resolved at.
    function resolvedAt() external view returns (Timestamp resolvedAt_);

    /// @notice Returns the current status of the game.
    /// @return status_ The current status of the game.
    function status() external view returns (GameStatus status_);

    /// @notice Getter for the game type.
    /// @dev The reference impl should be entirely different depending on the type (fault, validity)
    ///      i.e. The game type should indicate the security model.
    /// @return gameType_ The type of proof system being used.
    function gameType() external view returns (GameType gameType_);

    /// @notice Getter for the creator of the dispute game.
    /// @dev `clones-with-immutable-args` argument #1
    /// @return creator_ The creator of the dispute game.
    function gameCreator() external pure returns (address creator_);

    /// @notice Getter for the root claim.
    /// @dev `clones-with-immutable-args` argument #2
    /// @return rootClaim_ The root claim of the DisputeGame.
    function rootClaim() external pure returns (Claim rootClaim_);

    /// @notice Getter for the parent hash of the L1 block when the dispute game was created.
    /// @dev `clones-with-immutable-args` argument #3
    /// @return l1Head_ The parent hash of the L1 block when the dispute game was created.
    function l1Head() external pure returns (Hash l1Head_);

    /// @notice Getter for the L2 sequence number (typically the L2 block number).
    /// @dev Extracted from the extra data supplied to the dispute game contract by the creator.
    /// @return l2SequenceNumber_ The L2 sequence number for this dispute game.
    function l2SequenceNumber() external pure returns (uint256 l2SequenceNumber_);

    /// @notice Getter for the extra data.
    /// @dev `clones-with-immutable-args` argument #4
    /// @return extraData_ Any extra data supplied to the dispute game contract by the creator.
    function extraData() external pure returns (bytes memory extraData_);

    /// @notice If all necessary information has been gathered, this function should mark the game
    ///         status as either `CHALLENGER_WINS` or `DEFENDER_WINS` and return the status of
    ///         the resolved game. It is at this stage that the bonds should be awarded to the
    ///         necessary parties.
    /// @dev May only be called if the `status` is `IN_PROGRESS`.
    /// @return status_ The status of the game after resolution.
    function resolve() external returns (GameStatus status_);

    /// @notice A compliant implementation of this interface should return the components of the
    ///         game UUID's preimage provided in the cwia payload. The preimage of the UUID is
    ///         constructed as `keccak256(gameType . rootClaim . extraData)` where `.` denotes
    ///         concatenation.
    /// @return gameType_ The type of proof system being used.
    /// @return rootClaim_ The root claim of the DisputeGame.
    /// @return extraData_ Any extra data supplied to the dispute game contract by the creator.
    function gameData() external view returns (GameType gameType_, Claim rootClaim_, bytes memory extraData_);

    /// @notice Returns whether the game type was respected when this game was created.
    /// @dev Used as a withdrawal finality condition - games created when their type wasn't
    ///      respected cannot be used to finalize withdrawals.
    /// @return wasRespected_ True if the game type was the respected game type when created.
    function wasRespectedGameTypeWhenCreated() external view returns (bool wasRespected_);
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="fault-dispute-game"><a class="header" href="#fault-dispute-game">Fault Dispute Game</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="fault-proof/stage-one/fault-dispute-game.html#overview">Overview</a></li>
<li><a href="fault-proof/stage-one/fault-dispute-game.html#definitions">Definitions</a>
<ul>
<li><a href="fault-proof/stage-one/fault-dispute-game.html#virtual-machine-vm">Virtual Machine (VM)</a></li>
<li><a href="fault-proof/stage-one/fault-dispute-game.html#preimageoracle">PreimageOracle</a></li>
<li><a href="fault-proof/stage-one/fault-dispute-game.html#execution-trace">Execution Trace</a></li>
<li><a href="fault-proof/stage-one/fault-dispute-game.html#claims">Claims</a></li>
<li><a href="fault-proof/stage-one/fault-dispute-game.html#anchor-state">Anchor State</a></li>
<li><a href="fault-proof/stage-one/fault-dispute-game.html#anchor-state-registry">Anchor State Registry</a></li>
<li><a href="fault-proof/stage-one/fault-dispute-game.html#respected-game-type">Respected Game Type</a></li>
<li><a href="fault-proof/stage-one/fault-dispute-game.html#dag">DAG</a></li>
<li><a href="fault-proof/stage-one/fault-dispute-game.html#subgame">Subgame</a></li>
<li><a href="fault-proof/stage-one/fault-dispute-game.html#game-tree">Game Tree</a></li>
<li><a href="fault-proof/stage-one/fault-dispute-game.html#position">Position</a></li>
<li><a href="fault-proof/stage-one/fault-dispute-game.html#max_clock_duration">MAX_CLOCK_DURATION</a></li>
<li><a href="fault-proof/stage-one/fault-dispute-game.html#clock_extension">CLOCK_EXTENSION</a></li>
<li><a href="fault-proof/stage-one/fault-dispute-game.html#freeloader-claims">Freeloader Claims</a></li>
</ul>
</li>
<li><a href="fault-proof/stage-one/fault-dispute-game.html#core-game-mechanics">Core Game Mechanics</a>
<ul>
<li><a href="fault-proof/stage-one/fault-dispute-game.html#actors">Actors</a></li>
<li><a href="fault-proof/stage-one/fault-dispute-game.html#moves">Moves</a>
<ul>
<li><a href="fault-proof/stage-one/fault-dispute-game.html#attack">Attack</a></li>
<li><a href="fault-proof/stage-one/fault-dispute-game.html#defend">Defend</a></li>
</ul>
</li>
<li><a href="fault-proof/stage-one/fault-dispute-game.html#l2-block-number-challenge">L2 Block Number Challenge</a></li>
<li><a href="fault-proof/stage-one/fault-dispute-game.html#step">Step</a></li>
<li><a href="fault-proof/stage-one/fault-dispute-game.html#step-types">Step Types</a></li>
<li><a href="fault-proof/stage-one/fault-dispute-game.html#preimageoracle-interaction">PreimageOracle Interaction</a></li>
<li><a href="fault-proof/stage-one/fault-dispute-game.html#team-dynamics">Team Dynamics</a></li>
<li><a href="fault-proof/stage-one/fault-dispute-game.html#game-clock">Game Clock</a></li>
<li><a href="fault-proof/stage-one/fault-dispute-game.html#resolution">Resolution</a>
<ul>
<li><a href="fault-proof/stage-one/fault-dispute-game.html#resolving-the-l2-block-number-challenge">Resolving the L2 Block Number Challenge</a></li>
</ul>
</li>
<li><a href="fault-proof/stage-one/fault-dispute-game.html#finalization">Finalization</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<!-- Glossary References -->
<h2 id="overview-16"><a class="header" href="#overview-16">Overview</a></h2>
<p>The Fault Dispute Game (FDG) is a specific type of <a href="fault-proof/stage-one/dispute-game-interface.html">dispute game</a> that verifies the
validity of a root claim by iteratively bisecting over <a href="fault-proof/stage-one/../../glossary.html#l2-output-root">output roots</a> and execution traces of single
block state transitions down to a single instruction step. It relies on a Virtual Machine (VM) to falsify invalid
claims made at a single instruction step.</p>
<p>Actors, i.e. Players, interact with the game by making claims that dispute other claims in the FDG.
Each claim made narrows the range over the entire historical state of L2, until the source of dispute is a single
state transition. Once a time limit is reached, the dispute game is <em>resolved</em>, based on claims made that are disputed
and which aren't, to determine the winners of the game.</p>
<h2 id="definitions-2"><a class="header" href="#definitions-2">Definitions</a></h2>
<h3 id="virtual-machine-vm"><a class="header" href="#virtual-machine-vm">Virtual Machine (VM)</a></h3>
<p>This is a state transition function (STF) that takes a <em>pre-state</em> and computes the post-state.
The VM may access data referenced during the STF and as such, it also accepts a <em>proof</em> of this data.
Typically, the pre-state contains a commitment to the <em>proof</em> to verify the integrity of the data referenced.</p>
<p>Mathematically, we define the STF as <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> where</p>
<ul>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is the pre-state</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is an optional proof needed for the transition from <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> to <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8917em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span></span></span></span>.</li>
</ul>
<h3 id="preimageoracle"><a class="header" href="#preimageoracle">PreimageOracle</a></h3>
<p>This is a pre-image data store. It is often used by VMs to read external data during its STF.
Before successfully executing a VM STF, it may be necessary to preload the PreimageOracle with pertinent data.
The method for key-based retrieval of these pre-images varies according to the specific VM.</p>
<h3 id="execution-trace"><a class="header" href="#execution-trace">Execution Trace</a></h3>
<p>An execution trace <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span> is a sequence <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> where each <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is a VM state and
for each <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span>, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7804em;vertical-align:-0.136em;"></span><span class="mord">0</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â‰¤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6986em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span>, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8917em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>.
Every execution trace has a unique starting state, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, that's preset to a FDG implementation.
We refer to this state as the <strong>ABSOLUTE_PRESTATE</strong>.</p>
<h3 id="claims"><a class="header" href="#claims">Claims</a></h3>
<p>Claims assert an <a href="fault-proof/stage-one/../../glossary.html#l2-output-root">output root</a> or the state of the FPVM at a given instruction. This is represented as
a <code>Hash</code> type, a <code>bytes32</code> representing either an <a href="fault-proof/stage-one/../../glossary.html#l2-output-root">output root</a> or a commitment to the last VM state in a
trace. A FDG is initialized with an output root that corresponds to the state of L2 at a given L2 block number, and
execution trace subgames at <code>SPLIT_DEPTH + 1</code> are initialized with a claim that commits to the entire execution trace
between two consecutive output roots (a block <code>n -&gt; n+1</code> state transition). As we'll see later, there can be multiple
claims, committing to different output roots and FPVM states in the FDG.</p>
<h3 id="anchor-state"><a class="header" href="#anchor-state">Anchor State</a></h3>
<p>An anchor state, or anchor output root, is a previous output root that is assumed to be valid. An
FDG is always initialized with an anchor state and execution is carried out between this anchor
state and the <a href="fault-proof/stage-one/fault-dispute-game.html#claims">claimed output root</a>. FDG contracts pull their anchor state from the
<a href="fault-proof/stage-one/fault-dispute-game.html#anchor-state-registry">Anchor State Registry</a> contract. The initial anchor state for a FDG is the
genesis state of the L2.</p>
<p>Clients must currently gather L1 data for the window between the anchor state and the claimed
state. In order to reduce this L1 data requirement, <a href="fault-proof/stage-one/fault-dispute-game.html#claims">claims</a> about the state of the L2
become new anchor states when dispute games resolve in their favor. FDG contracts set their anchor
states at initialization time so that these updates do not impact active games.</p>
<h3 id="anchor-state-registry"><a class="header" href="#anchor-state-registry">Anchor State Registry</a></h3>
<p>The Anchor State Registry is a registry that the FDG uses to determine its <a href="fault-proof/stage-one/fault-dispute-game.html#anchor-state">anchor state</a>. It also
determines if the game is <a href="fault-proof/stage-one/anchor-state-registry.html#finalized-game">finalized</a> and
<a href="fault-proof/stage-one/anchor-state-registry.html#proper-game">"proper"</a> for purposes of <a href="fault-proof/stage-one/./bond-incentives.html#game-finalization">Bond
Distribution</a>. See <a href="fault-proof/stage-one/anchor-state-registry.html">Anchor State Registry</a> for more
details.</p>
<h3 id="respected-game-type-1"><a class="header" href="#respected-game-type-1">Respected Game Type</a></h3>
<p>A Fault Dispute Game must record whether its game type is respected at the time of its creation. See
<a href="fault-proof/stage-one/./anchor-state-registry.html#respected-game-type">Respected Game Type</a> for more details.</p>
<h3 id="dag"><a class="header" href="#dag">DAG</a></h3>
<p>A Directed Acyclic Graph <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">G</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mclose">)</span></span></span></span> representing the relationship between claims, where:</p>
<ul>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span> is the set of nodes, each representing a claim. Formally, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">}</span></span></span></span>,
where <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is a claim.</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span></span> is the set of <em>directed</em> edges. An edge <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> exists if <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> is a direct dispute
against <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> through either an "Attack" or "Defend" <a href="fault-proof/stage-one/fault-dispute-game.html#moves">move</a>.</li>
</ul>
<h3 id="subgame"><a class="header" href="#subgame">Subgame</a></h3>
<p>A sub-game is a DAG of depth 1, where the root of the DAG is a <code>Claim</code> and the children are <code>Claim</code>s that counter the
root. A good mental model around this structure is that it is a fundamental dispute between two parties over a single
piece of information. These subgames are chained together such that a child within a subgame is the root of its own
subgame, which is visualized in the <a href="fault-proof/stage-one/fault-dispute-game.html#resolution">resolution</a> section. There are two types of sub-games in the fault
dispute game:</p>
<ol>
<li>Output Roots</li>
<li>Execution Trace Commitments</li>
</ol>
<p>At and above the split depth, all subgame roots correspond to <a href="fault-proof/stage-one/../../glossary.html#l2-output-root">output roots</a>, or commitments to the full
state of L2 at a given L2 block number. Below the split depth, subgame roots correspond to commitments to the fault
proof VM's state at a given instruction step.</p>
<h3 id="game-tree"><a class="header" href="#game-tree">Game Tree</a></h3>
<p>The Game Tree is a binary tree of positions. Every claim in the DAG references a position in the Game Tree.
The Game Tree has a split depth and maximum depth, <code>SPLIT_DEPTH</code> and <code>MAX_GAME_DEPTH</code> respectively, that are both
preset to an FDG implementation. The split depth defines the maximum depth at which claims about
<a href="fault-proof/stage-one/../../glossary.html#l2-output-root">output roots</a> can occur, and below it, execution trace bisection occurs. Thus, the Game Tree contains
<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9324em;vertical-align:-0.0833em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> positions, where <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span> is the <code>MAX_GAME_DEPTH</code> (unless <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span>, in which case there's only 1 position).</p>
<p>The full game tree, with a layer of the tree allocated to output bisection, and sub-trees after an arbitrary split
depth, looks like:</p>
<p><img src="fault-proof/stage-one/../../static/assets/ob-tree.png" alt="ob-tree" /></p>
<h3 id="position"><a class="header" href="#position">Position</a></h3>
<p>A position represents the location of a claim in the Game Tree. This is represented by a
"generalized index" (or <strong>gindex</strong>) where the high-order bit is the level in the tree and the remaining
bits is a unique bit pattern, allowing a unique identifier for each node in the tree.</p>
<p>The <strong>gindex</strong> of a position <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> can be calculated as <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9713em;vertical-align:-0.0833em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">n</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mord mathnormal">x</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span>, where:</p>
<ul>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> is a function returning the depth of the position in the Game Tree</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mord mathnormal">x</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> is a function returning the index of the position at its depth (starting from the left).</li>
</ul>
<p>Positions at the deepest level of the game tree correspond to indices in the execution trace, whereas claims at the
split depth represent single L2 blocks' <a href="fault-proof/stage-one/../../glossary.html#l2-output-root">output roots</a>.
Positions higher up the game tree also cover the deepest, right-most positions relative to the current position.
We refer to this coverage as the <strong>trace index</strong> of a Position.</p>
<blockquote>
<p>This means claims commit to an execution trace that terminates at the same index as their Position's trace index.
That is, for a given trace index <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span>, its state witness hash corresponds to the <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> th state in the trace.</p>
</blockquote>
<p>Note that there can be multiple positions covering the same <em>trace index</em>.</p>
<h3 id="max_clock_duration"><a class="header" href="#max_clock_duration">MAX_CLOCK_DURATION</a></h3>
<p>This is an immutable, preset to a FDG implementation, representing the maximum amount of time that may accumulate on a
team's <a href="fault-proof/stage-one/fault-dispute-game.html#game-clock">chess clock</a>.</p>
<h3 id="clock_extension"><a class="header" href="#clock_extension">CLOCK_EXTENSION</a></h3>
<p>This is an immutable, preset to a FDG implementation, representing the flat credit that is given to a team's clock if
their clock has less than <code>CLOCK_EXTENSION</code> seconds remaining.</p>
<h3 id="freeloader-claims"><a class="header" href="#freeloader-claims">Freeloader Claims</a></h3>
<p>Due to the subgame resolution logic, there are certain moves which result in the correct final resolution of the game,
but do not pay out bonds to the correct parties.</p>
<p>An example of this is as follows:</p>
<ol>
<li>Alice creates a dispute game with an honest root claim.</li>
<li>Bob counters the honest root with a correct claim at the implied L2 block number.</li>
<li>Alice performs a defense move against Bob's counter, as the divergence exists later in Bob's view of the chain state.</li>
<li>Bob attacks his own claim.</li>
</ol>
<p>Bob's attack against his own claim <em>is</em> a counter to a bad claim, but with the incorrect pivot direction. If left
untouched, because it exists at a position further left than Alice's, he will reclaim his own bond upon resolution.
Because of this, the honest challenger must always counter freeloader claims for incentive compatibility to be
preserved.</p>
<p>Critically, freeloader claims, if left untouched, do not influence incorrect resolution of the game globally.</p>
<h2 id="core-game-mechanics"><a class="header" href="#core-game-mechanics">Core Game Mechanics</a></h2>
<p>This section specifies the core game mechanics of the FDG. The full FDG mechanics includes a
<a href="fault-proof/stage-one/bond-incentives.html">specification for Bonds</a>. Readers should understand basic game mechanics before
reading up on the Bond specification.</p>
<h3 id="actors"><a class="header" href="#actors">Actors</a></h3>
<p>The game involves two types of participants (or Players): <strong>Challengers</strong> and <strong>Defenders</strong>.
These players are grouped into separate teams, each employing distinct strategies to interact with the game.
Team members share a common goal regarding the game's outcome. Players interact with the game primarily through
<em>moves</em>.</p>
<h3 id="moves"><a class="header" href="#moves">Moves</a></h3>
<p>A Move is a challenge against an existing claim and must include an alternate claim asserting a different trace.
Moves can either be attacks or defenses and serve to update to DAG by adding nodes and edges targeting the disputed
claim.</p>
<p>Moves within the fault dispute game can claim two separate values: <a href="fault-proof/stage-one/../../glossary.html#l2-output-root">output roots</a> and execution trace
commitments. At and above the <code>SPLIT_DEPTH</code>, claims correspond to output roots, while below the split depth, they
correspond to execution trace commitments.</p>
<p>Initially, claims added to the DAG are <em>uncontested</em> (i.e. not <strong>countered</strong>). Once a move targets a claim, that claim
is considered countered.
The status of a claim â€” whether it's countered or not â€” helps determine its validity and, ultimately, the
game's winner.</p>
<h4 id="attack"><a class="header" href="#attack">Attack</a></h4>
<p>A logical move made when a claim is disagreed with.
A claim at the relative attack position to a node, <code>n</code>, in the Game Tree commits to half
of the trace of the <code>n</code>â€™s claim.
The attack position relative to a node can be calculated by multiplying its gindex by 2.</p>
<p>To illustrate this, here's a Game Tree highlighting an attack on a Claim positioned at 6.</p>
<p><img src="fault-proof/stage-one/../../static/assets/attack.png" alt="Attacking node 6" /></p>
<p>Attacking the node at 6 moves creates a new claim positioned at 12.</p>
<h4 id="defend"><a class="header" href="#defend">Defend</a></h4>
<p>The logical move against a claim when you agree with both it and its parent.
A defense at the relative position to a node, <code>n</code>, in the Game Tree commits to the first half of n + 1â€™s trace range.</p>
<p><img src="fault-proof/stage-one/../../static/assets/defend.png" alt="Defend at 4" /></p>
<p>Note that because of this, some nodes may never exist within the Game Tree.
However, they're not necessary as these nodes have complimentary, valid positions
with the same trace index within the tree. For example, a Position with gindex 5 has the same
trace index as another Position with gindex 2. We can verify that all trace indices have valid moves within the game:</p>
<p><img src="fault-proof/stage-one/../../static/assets/valid-moves.png" alt="Game Tree Showing All Valid Move Positions" /></p>
<p>There may be multiple claims at the same position, so long as their state witness hashes are unique.</p>
<p>Each move adds new claims to the Game Tree at strictly increasing depth.
Once a claim is at <code>MAX_GAME_DEPTH</code>, the only way to dispute such claims is to <strong>step</strong>.</p>
<h3 id="l2-block-number-challenge"><a class="header" href="#l2-block-number-challenge">L2 Block Number Challenge</a></h3>
<p>This is a special type of action, made by the Challenger, to counter a root claim.</p>
<p>Given an output root preimage and its corresponding RLP-encoded L2 block header, the L2 block number can be verified.
This process ensures the integrity and authenticity of an L2 block number.
The procedure for this verification involves three steps: checking the output root preimage, validating the block hash preimage,
and extracting the block number from the RLP-encoded header.
By comparing the challenger-supplied preimages and the extracted block number against their claimed values,
the consistency of the L2 block number with the one in the provided header can be confirmed, detecting any discrepancies.</p>
<p>Root claims made with an invalid L2 block number can be disputed through a special challenge.
This challenge is validated in the FDG contract using the aforementioned procedure.
However, it is crucial to note that this challenge can only be issued against the root claim,
as it's the only entity making explicit claims on the L2 block number.
A successful challenge effectively disputes the root claim once its subgame is resolved.</p>
<h3 id="step"><a class="header" href="#step">Step</a></h3>
<p>At <code>MAX_GAME_DEPTH</code>, the position of claims correspond to indices of an execution trace.
It's at this point that the FDG is able to query the VM to determine the validity of claims,
by checking the states they're committing to.
This is done by applying the VM's STF to the state a claim commits to.
If the STF post-state does not match the claimed state, the challenge succeeds.</p>
<pre><code class="language-solidity">/// @notice Perform an instruction step via an on-chain fault proof processor.
/// @dev This function should point to a fault proof processor in order to execute
///      a step in the fault proof program on-chain. The interface of the fault proof
///      processor contract should adhere to the `IBigStepper` interface.
/// @param _claimIndex The index of the challenged claim within `claimData`.
/// @param _isAttack Whether or not the step is an attack or a defense.
/// @param _stateData The stateData of the step is the preimage of the claim at the given
///        prestate, which is at `_stateIndex` if the move is an attack and `_claimIndex` if
///        the move is a defense. If the step is an attack on the first instruction, it is
///        the absolute prestate of the fault proof VM.
/// @param _proof Proof to access memory nodes in the VM's merkle state tree.
function step(uint256 _claimIndex, bool _isAttack, bytes calldata _stateData, bytes calldata _proof) external;
</code></pre>
<h3 id="step-types"><a class="header" href="#step-types">Step Types</a></h3>
<p>Similar to moves, there are two ways to step on a claim; attack or defend.
These determine the pre-state input to the VM STF and the expected output.</p>
<ul>
<li><strong>Attack Step</strong> - Challenges a claim by providing a pre-state, proving an invalid state transition.
It uses the previous state in the execution trace as input and expects the disputed claim's state as output.
There must exist a claim in the DAG that commits to the input.</li>
<li><strong>Defense Step</strong> - Challenges a claim by proving it was an invalid attack,
thereby defending the disputed ancestor's claim. It uses the disputed claim's state as input and expects
the next state in the execution trace as output. There must exist a claim in the DAG that commits to the
expected output.</li>
</ul>
<p>The FDG step handles the inputs to the VM and asserts the expected output.
A step that successfully proves an invalid post-state (when attacking) or pre-state (when defending) is a
successful counter against the disputed claim.
Players interface with <code>step</code> by providing an indicator of attack and state data (including any proofs)
that corresponds to the expected pre/post state (depending on whether it's an attack or defend).
The FDG will assert that an existing claim commits to the state data provided by players.</p>
<h3 id="preimageoracle-interaction"><a class="header" href="#preimageoracle-interaction">PreimageOracle Interaction</a></h3>
<p>Certain steps (VM state transitions) require external data to be available by the <code>PreimageOracle</code>.
To ensure a successful state transition, players should provide this data in advance.
The FDG provides the following interface to manage data loaded to the <code>PreimageOracle</code>:</p>
<pre><code class="language-solidity">/// @notice Posts the requested local data to the VM's `PreimageOracle`.
/// @param _ident The local identifier of the data to post.
/// @param _execLeafIdx The index of the leaf claim in an execution subgame that requires the local data for a step.
/// @param _partOffset The offset of the data to post.
function addLocalData(uint256 _ident, uint256 _execLeafIdx, uint256 _partOffset) external;
</code></pre>
<p>The <code>addLocalData</code> function loads local data into the VM's <code>PreimageOracle</code>. This data consists of bootstrap data for
the program. There are multiple sets of local preimage keys that belong to the <code>FaultDisputeGame</code> contract due to the
ability for players to bisect to any block <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â†’</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> state transition since the configured anchor state, the
<code>_execLeafIdx</code> parameter enables a search for the starting / disputed outputs to be performed such that the contract
can write to and reference unique local keys in the <code>PreimageOracle</code> for each of these <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â†’</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>
transitions.</p>
<div class="table-wrapper"><table><thead><tr><th>Identifier</th><th>Description</th></tr></thead><tbody>
<tr><td><code>1</code></td><td>Parent L1 head hash at the time of the proposal</td></tr>
<tr><td><code>2</code></td><td>Starting output root hash (commits to block # <code>n</code>)</td></tr>
<tr><td><code>3</code></td><td>Disputed output root hash (commits to block # <code>n + 1</code>)</td></tr>
<tr><td><code>4</code></td><td>Disputed L2 block number (block # <code>n + 1</code>)</td></tr>
<tr><td><code>5</code></td><td>L2 Chain ID</td></tr>
</tbody></table>
</div>
<p>For global <code>keccak256</code> preimages, there are two routes for players to submit:</p>
<ol>
<li>Small preimages atomically.</li>
<li>Large preimages via streaming.</li>
</ol>
<p>Global <code>keccak256</code> preimages are non-context specific and can be submitted directly to the <code>PreimageOracle</code> via the
<code>loadKeccak256PreimagePart</code> function, which takes the part offset as well as the full preimage. In the event that the
preimage is too large to be submitted through calldata in a single block, challengers must resort to the streaming
option.</p>
<p><strong>Large Preimage Proposals</strong></p>
<p>Large preimage proposals allow for submitters to stream in a large preimage over multiple transactions, along-side
commitments to the intermediate state of the <code>keccak256</code> function after absorbing/permuting the <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1088</span></span></span></span> bit block.
This data is progressively merkleized on-chain as it is streamed in, with each leaf constructed as follows:</p>
<pre><code class="language-solidity">/// @notice Returns a leaf hash to add to a preimage proposal merkle tree.
/// @param input A single 136 byte chunk of the input.
/// @param blockIndex The index of the block that `input` corresponds to in the full preimage's absorption.
/// @param stateCommitment The hash of the full 5x5 state matrix *after* absorbing and permuting `input`.
function hashLeaf(
    bytes memory input,
    uint256 blockIndex,
    bytes32 stateCommitment
) internal view returns (bytes32 leaf) {
    require(input.length == 136, "input must be exactly the size of the keccak256 rate");

    leaf = keccak256(abi.encodePacked(input, blockIndex, stateCommitment));
}
</code></pre>
<p>Once the full preimage and all intermediate state commitments have been posted, the large preimage proposal enters a
challenge period. During this time, a challenger can reconstruct the merkle tree that was progressively built on-chain
locally by scanning the block bodies that contain the proposer's leaf preimages. If they detect that a commitment to
the intermediate state of the hash function is incorrect at any step, they may perform a single-step dispute for the
proposal in the <code>PreimageOracle</code>. This involves:</p>
<ol>
<li>Creating a merkle proof for the agreed upon prestate leaf (not necessary if the invalid leaf is the first one, the
setup state of the matrix is constant.) within the proposal's merkle root.</li>
<li>Creating a merkle proof for the disputed post state leaf within the proposal's merkle root.</li>
<li>Computing the state matrix at the agreed upon prestate (not necessary if the invalid leaf is the first one, the
setup state of the matrix is constant.)</li>
</ol>
<p>The challenger then submits this data to the <code>PreimageOracle</code>, where the post state leaf's claimed input is absorbed into
the pre state leaf's state matrix and the SHA3 permutation is executed on-chain. After that, the resulting state matrix
is hashed and compared with the proposer's claim in the post state leaf. If the hash does not match, the proposal
is marked as challenged, and it may not be finalized. If, after the challenge period is concluded, a proposal has no
challenges, it may be finalized and the preimage part may be placed into the authorized mappings for the FPVM to read.</p>
<h3 id="team-dynamics"><a class="header" href="#team-dynamics">Team Dynamics</a></h3>
<p>Challengers seek to dispute the root claim, while Defenders aim to support it.
Both types of actors will move accordingly to support their team. For Challengers, this means
attacking the root claim and disputing claims positioned at even depths in the Game Tree.
Defenders do the opposite by disputing claims positioned at odd depths.</p>
<p>Players on either team are motivated to support the actions of their teammates.
This involves countering disputes against claims made by their team (assuming these claims are honest).
Uncontested claims are likely to result in a loss, as explained later under <a href="fault-proof/stage-one/fault-dispute-game.html#resolution">Resolution</a>.</p>
<h3 id="game-clock"><a class="header" href="#game-clock">Game Clock</a></h3>
<p>Every claim in the game has a Clock. A claim inherits the clock of its grandparent claim in the
DAG (and so on). Akin to a chess clock, it keeps track of the total time each team takes to make
moves, preventing delays. Making a move resumes the clock for the disputed claim and pauses it for the newly added one.</p>
<p>If a move is performed, where the potential grandchild's clock has less time than <code>CLOCK_EXTENSION</code> seconds remaining,
the potential grandchild's clock is granted exactly <code>CLOCK_EXTENSION</code> seconds remaining. This is to combat the situation
where a challenger must inherit a malicious party's clock when countering a <a href="fault-proof/stage-one/fault-dispute-game.html#freeloader-claims">freeloader claim</a>, in
order to preserve incentive compatibility for the honest party. As the extension only applies to the potential
grandchild's clock, the max possible extension for the game is bounded, and scales with the <code>MAX_GAME_DEPTH</code>.</p>
<p>If the potential grandchild is an execution trace bisection root claim and their clock has less than <code>CLOCK_EXTENSION</code>
seconds remaining, exactly <code>CLOCK_EXTENSION * 2</code> seconds are allocated for the potential grandchild. This extra time
is allotted to allow for completion of the off-chain FPVM run to generate the initial instruction trace.</p>
<p>A move against a particular claim is no longer possible once the parent of the disputed claim's Clock
has accumulated <code>MAX_CLOCK_DURATION</code> seconds. By which point, the claim's clock has <em>expired</em>.</p>
<h3 id="resolution"><a class="header" href="#resolution">Resolution</a></h3>
<p>Resolving the FDG determines which team won the game. To do this, we use the internal sub game structure.
Each claim within the game is the root of its own sub game. These subgames are modeled as nested DAGs, each with a max
depth of 1. In order for a claim to be considered countered, only one of its children must be uncountered. Subgames
can also not be resolved until all of their children, which are subgames themselves, have been resolved and
the potential opponent's chess clock has run out. To determine if the potential opponent's chess clock has ran out, and
therefore no more moves against the subgame are possible, the duration elapsed on the subgame root's parent clock is
added to the difference between the current time and the timestamp of the subgame root's creation. Because each claim
is the root of its own sub-game, truth percolates upwards towards the root claim by resolving each individual sub-game
bottom-up.</p>
<p>In a game like the one below, we can resolve up from the deepest subgames. Here, we'd resolve <code>b0</code>
to uncountered and <code>a0</code> to countered by walking up from their deepest children, and once all children of the
root game are recursively resolved, we can resolve the root to countered due to <code>b0</code> remaining uncountered.</p>
<!-- https://gist.github.com/clabby/e98bdd80ef3c038424f3372b70e34e08 -->
<!-- markdownlint-disable no-inline-html -->
<p><a href="https://github.com/ethereum-optimism/optimism/assets/8406232/d2b708a0-539e-439d-96bd-c2f66f3a45f8">https://github.com/ethereum-optimism/optimism/assets/8406232/d2b708a0-539e-439d-96bd-c2f66f3a45f8</a></p>
<p>Another example is this game, which has a slightly different structure. Here, the root claim will also
be countered due to <code>b0</code> remaining uncountered.</p>
<!--
digraph G {
    rankdir=LR
    newrank=true
  node [shape=plaintext]
  subgraph cluster_01 {
    label = "Legend";
    key [label=<<table border="0" cellpadding="2" cellspacing="0" cellborder="0">
      <tr><td align="right" port="i1">bisection</td></tr>
      <tr><td align="right" port="i2">resolution</td></tr>
      </table>>]
    key2 [label=<<table border="0" cellpadding="" cellspacing="0" cellborder="0">
      <tr><td port="i1">&nbsp;</td></tr>
      <tr><td port="i2">&nbsp;</td></tr>
      </table>>]
    key:i1:e -> key2:i1:w [color=green]
    key:i2:e -> key2:i2:w [color=coral1, style=dotted]
  }
  subgraph cluster_0 {
    color=cornflowerblue;
    node [style=filled];
    a0 -> a1 [color=green];
    a1 -> a0 [color=coral1, style=dotted];
    subgraph cluster_0_0 {
        label = "subgame #5";
        color=purple;
        a1 -> a2 [color=green];
        a2 -> a1 [color=coral1, style=dotted];
        subgraph cluster_0_1 {
            label = "subgame #6";
            color=magenta;
            a2 -> a3 [color=green];
            a3 -> a2 [color=coral1, style=dotted];
            a2 -> a4 [color=green];
            a4 -> a2 [color=coral1, style=dotted];
            subgraph cluster_0_2 {
                label = "subgame #7";
                color=lightpink;
                a3
            }
            subgraph cluster_0_3 {
                label = "subgame #8";
                color=lightpink;
                a4 -> a5 [color=green];
                a5 -> a4 [color=coral1, style=dotted];
                subgraph cluster_0_4 {
                    label = "subgame #9";
                    color=palegreen;
                    a5
                }
            }
        }
    }
    label = "subgame #4";
  }
  subgraph cluster_1 {
    node [style=filled];
    label = "subgame #1";
    color=cornflowerblue
    b0 -> b1 [color=green];
    b1 -> b0 [color=coral1, style=dotted];
    subgraph cluster_1_0 {
        label = "subgame #2";
        color=purple;
        b1 -> b2 [color=green];
        b2 -> b1 [color=coral1, style=dotted];
        subgraph cluster_1_1 {
            label = "subgame #3";
            edge [style=invis]
            color=magenta;
            b2
        }
    }
  }
  Root -> a0 [color=green];
  Root -> b0 [color=green];
  a0 -> Root [color=coral1, style=dotted];
  b0 -> Root [color=coral1, style=dotted];
  Root [shape=Mdiamond];
}
-->
<!-- markdownlint-disable no-inline-html -->
<p align="center">
  <img
    src="https://github.com/ethereum-optimism/optimism/assets/8406232/9b20ba8d-0b64-47b3-9962-5533f7eb4ef7"
    width=60%
    alt="subgame resolution"
  >
</p>
<p>Given these rules, players are motivated to move quickly to challenge all dishonest claims.
Each move bisects the historical state of L2 and eventually, <code>MAX_GAME_DEPTH</code> is reached where disputes
can be settled conclusively. Dishonest players are disincentivized to participate, via backwards induction,
as an invalid claim won't remain uncontested. Further incentives can be added to the game by requiring
claims to be bonded, while rewarding game winners using the bonds of dishonest claims.</p>
<h4 id="resolving-the-l2-block-number-challenge"><a class="header" href="#resolving-the-l2-block-number-challenge">Resolving the L2 Block Number Challenge</a></h4>
<p>The resolution of an L2 block number challenge occurs in the same manner as subgame resolution, with one caveat;
the L2 block number challenger, if it exist, must be the winner of a root subgame.
Thus, no moves against the root, including uncontested ones, can win a root subgame that has an L2 block number challenge.</p>
<h3 id="finalization"><a class="header" href="#finalization">Finalization</a></h3>
<p>Once the game is resolved, it must wait for the <code>disputeGameFinalityDelaySeconds</code> on the <code>OptimismPortal</code> to pass before
it can be finalized, after which bonds can be distributed via the process outlined in <a href="fault-proof/stage-one/bond-incentives.html#game-finalization">Bond Incentives: Game
Finalization</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="honest-challenger-fault-dispute-game"><a class="header" href="#honest-challenger-fault-dispute-game">Honest Challenger (Fault Dispute Game)</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="fault-proof/stage-one/honest-challenger-fdg.html#overview">Overview</a></li>
<li><a href="fault-proof/stage-one/honest-challenger-fdg.html#invariants">Invariants</a></li>
<li><a href="fault-proof/stage-one/honest-challenger-fdg.html#fault-dispute-game-responses">Fault Dispute Game Responses</a>
<ul>
<li><a href="fault-proof/stage-one/honest-challenger-fdg.html#moves">Moves</a></li>
<li><a href="fault-proof/stage-one/honest-challenger-fdg.html#steps">Steps</a></li>
<li><a href="fault-proof/stage-one/honest-challenger-fdg.html#timeliness">Timeliness</a></li>
</ul>
</li>
<li><a href="fault-proof/stage-one/honest-challenger-fdg.html#resolution">Resolution</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-17"><a class="header" href="#overview-17">Overview</a></h2>
<p>The honest challenger is an agent interacting in the <a href="fault-proof/stage-one/fault-dispute-game.html">Fault Dispute Game</a>
that supports honest claims and disputes false claims.
An honest challenger strives to ensure a correct, truthful, game resolution.
The honest challenger is also <em>rational</em> as any deviation from its behavior will result in
negative outcomes.
This document specifies the expected behavior of an honest challenger.</p>
<p>The Honest Challenger has two primary duties:</p>
<ol>
<li>Support valid root claims in Fault Dispute Games.</li>
<li>Dispute invalid root claims in Fault Dispute Games.</li>
</ol>
<p>The honest challenger polls the <code>DisputeGameFactory</code> contract for new and on-going Fault
Dispute Games.
For verifying the legitimacy of claims, it relies on a synced, trusted rollup node
as well as a trace provider (ex: <a href="fault-proof/stage-one/../cannon-fault-proof-vm.html">Cannon</a>).
The trace provider must be configured with the <a href="fault-proof/stage-one/fault-dispute-game.html#execution-trace">ABSOLUTE_PRESTATE</a>
of the game being interacted with to generate the traces needed to make truthful claims.</p>
<h2 id="invariants-1"><a class="header" href="#invariants-1">Invariants</a></h2>
<p>To ensure an accurate and incentive compatible fault dispute system, the honest challenger behavior must preserve
three invariants for any game:</p>
<ol>
<li>The game resolves as <code>DefenderWins</code> if the root claim is correct and <code>ChallengerWins</code> if the root claim is incorrect</li>
<li>The honest challenger is refunded the bond for every claim it posts and paid the bond of the parent of that claim</li>
<li>The honest challenger never counters its own claim</li>
</ol>
<h2 id="fault-dispute-game-responses"><a class="header" href="#fault-dispute-game-responses">Fault Dispute Game Responses</a></h2>
<p>The honest challenger determines which claims to counter by iterating through the claims in the order they are stored
in the contract. This ordering ensures that a claim's ancestors are processed prior to the claim itself. For each claim,
the honest challenger determines and tracks the set of honest responses to all claims, regardless of whether that
response already exists in the full game state.</p>
<p>The root claim is considered to be an honest claim if and only if it has a
<a href="fault-proof/stage-one/fault-dispute-game.html#claims">state witness Hash</a> that agrees with the honest challenger's state witness hash for the
root claim.</p>
<p>The honest challenger should counter a claim if and only if:</p>
<ol>
<li>The claim is a child of a claim in the set of honest responses</li>
<li>The set of honest responses, contains a sibling to the claim with a trace index greater than or equal to the
claim's trace index</li>
</ol>
<p>Note that this implies the honest challenger never counters its own claim, since there is at most one honest counter to
each claim, so an honest claim never has an honest sibling.</p>
<h3 id="moves-1"><a class="header" href="#moves-1">Moves</a></h3>
<p>To respond to a claim with a depth in the range of <code>[1, MAX_DEPTH]</code>, the honest challenger determines if the claim
has a valid commitment. If the state witness hash matches the honest challenger's at the same trace
index, then we disagree with the claim's stance by move to <a href="fault-proof/stage-one/fault-dispute-game.html#defend">defend</a>.
Otherwise, the claim is <a href="fault-proof/stage-one/fault-dispute-game.html#attack">attacked</a>.</p>
<p>The claim that would be added as a result of the move is added to the set of honest moves being tracked.</p>
<p>If the resulting claim does not already exist in the full game state, the challenger issue the move by calling
the <code>FaultDisputeGame</code> contract.</p>
<h3 id="steps"><a class="header" href="#steps">Steps</a></h3>
<p>At the max depth of the game, claims represent commitments to the state of the fault proof VM
at a single instruction step interval.
Because the game can no longer bisect further, when the honest challenger counters these claims,
the only option for an honest challenger is to execute a VM step on-chain to disprove the claim at <code>MAX_GAME_DEPTH</code>.</p>
<p>If the <code>counteredBy</code> of the claim being countered is non-zero, the claim has already been countered and the honest
challenger does not perform any action.</p>
<p>Otherwise, similar to the above section, the honest challenger will issue an
<a href="fault-proof/stage-one/fault-dispute-game.html#step-types">attack step</a> when in response to such claims with
invalid state witness commitments. Otherwise, it issues a <em>defense step</em>.</p>
<h3 id="timeliness"><a class="header" href="#timeliness">Timeliness</a></h3>
<p>The honest challenger responds to claims as soon as possible to avoid the clock of its
counter-claim from expiring.</p>
<h2 id="resolution-1"><a class="header" href="#resolution-1">Resolution</a></h2>
<p>When the <a href="fault-proof/stage-one/fault-dispute-game.html#game-clock">chess clock</a> of a
<a href="fault-proof/stage-one/fault-dispute-game.html#resolution">subgame root</a> has run out, the subgame can be resolved.
The honest challenger should resolve all subgames in bottom-up order, until the subgame
rooted at the game root is resolved.</p>
<p>The honest challenger accomplishes this by calling the <code>resolveClaim</code> function on the
<code>FaultDisputeGame</code> contract. Once the root claim's subgame is resolved,
the challenger then finally calls the <code>resolve</code> function to resolve the entire game.</p>
<p>The <code>FaultDisputeGame</code> does not put a time cap on resolution - because of the liveness
assumption on honest challengers and the bonds attached to the claims theyâ€™ve countered,
challengers are economically incentivized to resolve the game promptly to capture the bonds.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="bond-incentives"><a class="header" href="#bond-incentives">Bond Incentives</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="fault-proof/stage-one/bond-incentives.html#overview">Overview</a></li>
<li><a href="fault-proof/stage-one/bond-incentives.html#moves">Moves</a></li>
<li><a href="fault-proof/stage-one/bond-incentives.html#subgame-resolution">Subgame Resolution</a>
<ul>
<li><a href="fault-proof/stage-one/bond-incentives.html#leftmost-claim-incentives">Leftmost Claim Incentives</a></li>
</ul>
</li>
<li><a href="fault-proof/stage-one/bond-incentives.html#fault-proof-mainnet-incentives">Fault Proof Mainnet Incentives</a>
<ul>
<li><a href="fault-proof/stage-one/bond-incentives.html#authenticated-roles">Authenticated Roles</a></li>
<li><a href="fault-proof/stage-one/bond-incentives.html#base-fee-assumption">Base Fee Assumption</a></li>
<li><a href="fault-proof/stage-one/bond-incentives.html#bond-scaling">Bond Scaling</a></li>
<li><a href="fault-proof/stage-one/bond-incentives.html#required-bond-formula">Required Bond Formula</a></li>
<li><a href="fault-proof/stage-one/bond-incentives.html#other-incentives">Other Incentives</a></li>
</ul>
</li>
<li><a href="fault-proof/stage-one/bond-incentives.html#game-finalization">Game Finalization</a>
<ul>
<li><a href="fault-proof/stage-one/bond-incentives.html#bond-distribution-mode">Bond Distribution Mode</a>
<ul>
<li><a href="fault-proof/stage-one/bond-incentives.html#normal-mode">Normal Mode</a></li>
<li><a href="fault-proof/stage-one/bond-incentives.html#refund-mode">Refund Mode</a></li>
</ul>
</li>
<li><a href="fault-proof/stage-one/bond-incentives.html#game-closure">Game Closure</a></li>
<li><a href="fault-proof/stage-one/bond-incentives.html#claiming-credit">Claiming Credit</a></li>
<li><a href="fault-proof/stage-one/bond-incentives.html#delayedweth">DelayedWETH</a>
<ul>
<li><a href="fault-proof/stage-one/bond-incentives.html#sub-account-model">Sub-Account Model</a></li>
<li><a href="fault-proof/stage-one/bond-incentives.html#delay-period">Delay Period</a></li>
<li><a href="fault-proof/stage-one/bond-incentives.html#integration">Integration</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-18"><a class="header" href="#overview-18">Overview</a></h2>
<p>Bonds is an add-on to the core <a href="fault-proof/stage-one/fault-dispute-game.html">Fault Dispute Game</a>. The core game mechanics are
designed to ensure honesty as the best response to winning subgames. By introducing financial incentives,
Bonds makes it worthwhile for honest challengers to participate.
Without the bond reward incentive, the FDG will be too costly for honest players to participate in given the
cost of verifying and making claims.</p>
<p>Implementations may allow the FDG to directly receive bonds, or delegate this responsibility to another entity.
Regardless, there must be a way for the FDG to query and distribute bonds linked to a claim.</p>
<p>Bonds are integrated into the FDG in two areas:</p>
<ul>
<li>Moves</li>
<li>Subgame Resolution</li>
</ul>
<h2 id="moves-2"><a class="header" href="#moves-2">Moves</a></h2>
<p>Moves must be adequately bonded to be added to the FDG. This document does not specify a
scheme for determining the minimum bond requirement. FDG implementations should define a function
computing the minimum bond requirement with the following signature:</p>
<pre><code class="language-solidity">function getRequiredBond(Position _movePosition) public pure returns (uint256 requiredBond_)
</code></pre>
<p>As such, attacking or defending requires a check for the <code>getRequiredBond()</code> amount against the bond
attached to the move. To incentivize participation, the minimum bond should cover the cost of a possible
counter to the move being added. Thus, the minimum bond depends only on the position of the move that's added.</p>
<h2 id="subgame-resolution"><a class="header" href="#subgame-resolution">Subgame Resolution</a></h2>
<p>If a subgame root resolves incorrectly, then its bond is distributed to the <strong>leftmost claimant</strong> that countered
it. This creates an incentive to identify the earliest point of disagreement in an execution trace.
The subgame root claimant gets back its bond iff it resolves correctly.</p>
<p>At maximum game depths, where a claimant counters a bonded claim via <code>step</code>, the bond is instead distributed
to the account that successfully called <code>step</code>.</p>
<h3 id="leftmost-claim-incentives"><a class="header" href="#leftmost-claim-incentives">Leftmost Claim Incentives</a></h3>
<p>There exists defensive positions that cannot be countered, even if they hold invalid claims. These positions
are located on the same level as honest claims, but situated to its right (i.e. its gindex &gt; honest claim's).</p>
<p>An honest challenger can always successfully dispute any sibling claims not positioned to the right of an honest claim.
The leftmost payoff rule encourages such disputes, ensuring only one claim is leftmost at correct depths.
This claim will be the honest one, and thus bond rewards will be directed exclusively to honest claims.</p>
<h2 id="fault-proof-mainnet-incentives"><a class="header" href="#fault-proof-mainnet-incentives">Fault Proof Mainnet Incentives</a></h2>
<p>This section describes the specific bond incentives to be used for the Fault Proof Mainnet launch of the OP Stack fault
proof system.</p>
<h3 id="authenticated-roles"><a class="header" href="#authenticated-roles">Authenticated Roles</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody>
<tr><td>Guardian</td><td>Role responsible for blacklisting dispute game contracts and changing the respected dispute game type</td></tr>
<tr><td>System Owner</td><td>Role that owns the <code>ProxyAdmin</code> contract that in turn owns most <code>Proxy</code> contracts within the OP Stack</td></tr>
</tbody></table>
</div>
<h3 id="base-fee-assumption"><a class="header" href="#base-fee-assumption">Base Fee Assumption</a></h3>
<p>FPM bonds are to assume a fixed 200 Gwei base fee.
Future iterations of the fault proof may include a dynamic base fee calculation.
For the moment, we suppose that the <code>Guardian</code> address may account for increased average base fees by updating the
<code>OptimismPortal</code> contract to a new respected game type with a higher assumed base fee.</p>
<h3 id="bond-scaling"><a class="header" href="#bond-scaling">Bond Scaling</a></h3>
<p>FPM bonds are priced in the amount of gas that they are intended to cover.
Bonds start at the very first depth of the game at a baseline of <code>400_000</code> gas.
The <code>400_000</code> value is chosen as a deterrence amount that is approximately double the cost to respond at the top level.
Bonds scale up to a value of <code>300_000_000</code> gas, a value chosen to cover approximately double the cost of a max-size
Large Preimage Proposal.</p>
<p>We use a multiplicative scaling mechanism to guarantee that the ratio between bonds remains constant.
We determine the multiplier based on the proposed <code>MAX_DEPTH</code> of 73.
We can use the formula <code>x = (300_000_000 / 400_000) ** (1 / 73)</code> to determine that <code>x = 1.09493</code>.
At each depth <code>N</code>, the amount of gas charged is therefore <code>400_000 * (1.09493 ** N)</code></p>
<p>Below is a diagram demonstrating this curve for a max depth of 73.</p>
<p><img src="https://github.com/ethereum-optimism/specs/assets/14298799/b381037b-193d-42c5-9a9c-9cc5f43b255f" alt="bond scaling curve" /></p>
<h3 id="required-bond-formula"><a class="header" href="#required-bond-formula">Required Bond Formula</a></h3>
<p>Applying the <a href="fault-proof/stage-one/bond-incentives.html#base-fee-assumption">Base Fee Assumption</a> and <a href="fault-proof/stage-one/bond-incentives.html#bond-scaling">Bond Scaling</a> specifications, we have a
<code>getRequiredBond</code> function:</p>
<pre><code class="language-python">def get_required_bond(position):
    assumed_gas_price = 200 gwei
    base_gas_charged = 400_000
    gas_charged = 400_000 * (1.09493 ** position.depth)
    return gas_charged * assumed_gas_price
</code></pre>
<h3 id="other-incentives"><a class="header" href="#other-incentives">Other Incentives</a></h3>
<p>There are other costs associated with participating in the game, including operating a challenger agent and the
opportunity cost of locking up capital in the dispute game. While we do not explicitly create incentives to cover
these costs, we assume that the current bond rewards, based on this specification, are enough as a whole to cover
all other costs of participation.</p>
<h2 id="game-finalization"><a class="header" href="#game-finalization">Game Finalization</a></h2>
<p>After the game is resolved, claimants must wait for the <a href="fault-proof/stage-one/anchor-state-registry.html#isgamefinalized">AnchorStateRegistry's
<code>isGameFinalized()</code></a> to return <code>true</code> before they can claim their bonds. This
implies a wait period of at least the <code>disputeGameFinalityDelaySeconds</code> variable from the <code>OptimismPortal</code> contract.
After the game is finalized, bonds can be distributed.</p>
<h3 id="bond-distribution-mode"><a class="header" href="#bond-distribution-mode">Bond Distribution Mode</a></h3>
<p>The FDG will in most cases distribute bonds to the winners of the game after it is resolved and finalized, but in
special cases will refund the bonds to the original depositor.</p>
<h4 id="normal-mode"><a class="header" href="#normal-mode">Normal Mode</a></h4>
<p>In normal mode, the FDG will distribute bonds to the winners of the game after it is resolved and finalized.</p>
<h4 id="refund-mode"><a class="header" href="#refund-mode">Refund Mode</a></h4>
<p>In refund mode, the FDG will refund the bonds to the original depositor.</p>
<h3 id="game-closure"><a class="header" href="#game-closure">Game Closure</a></h3>
<p>The <code>FaultDisputeGame</code> contract can be closed after finalization via the <code>closeGame()</code> function.</p>
<p><code>closeGame</code> must do the following:</p>
<ol>
<li>Verify the game is resolved and finalized according to the Anchor State Registry</li>
<li>Attempt to set this game as the new anchor game.</li>
<li>Determine the bond distribution mode based on whether the <a href="fault-proof/stage-one/anchor-state-registry.html#isgameproper">AnchorStateRegistry's
<code>isGameProper()</code></a> returns <code>true</code>.</li>
<li>Emit a <code>GameClosed</code> event with the chosen distribution mode.</li>
</ol>
<h3 id="claiming-credit"><a class="header" href="#claiming-credit">Claiming Credit</a></h3>
<p>There is a 2-step process to claim credit. First, <code>claimCredit(address claimant)</code> should be called to unlock the credit
from the <a href="fault-proof/stage-one/bond-incentives.html#delayedweth">DelayedWETH</a> contract. After DelayedWETH's <a href="fault-proof/stage-one/bond-incentives.html#delay-period">delay period</a> has passed,
<code>claimCredit</code> should be called again to withdraw the credit.</p>
<p>The <code>claimCredit(address claimant)</code> function must do the following:</p>
<ul>
<li>Call <code>closeGame()</code> to determine the distribution mode if not already closed.
<ul>
<li>In NORMAL mode: Distribute credit from the standard <code>normalModeCredit</code> mapping.</li>
<li>In REFUND mode: Distribute credit from the <code>refundModeCredit</code> mapping.</li>
</ul>
</li>
<li>If the claimant has not yet unlocked their credit, unlock it by calling <code>DelayedWETH.unlock(claimant, credit)</code>.
<ul>
<li>Claimant must not be able to unlock this credit again.</li>
</ul>
</li>
<li>If the claimant has already unlocked their credit, call <code>DelayedWETH.withdraw(claimant, credit)</code> (implying a
<a href="fault-proof/stage-one/bond-incentives.html#delay-period">delay period</a>) to withdraw the credit, and set claimant's <code>credit</code> balances to 0.</li>
</ul>
<h3 id="delayedweth"><a class="header" href="#delayedweth">DelayedWETH</a></h3>
<p><code>DelayedWETH</code> is designed to hold the bonded ETH for each
<a href="fault-proof/stage-one/fault-dispute-game.html">Fault Dispute Game</a>.
<code>DelayedWETH</code> is an extended version of the standard <code>WETH</code> contract that introduces a delayed unwrap mechanism that
allows an owner address to function as a backstop in the case that a Fault Dispute Game would
incorrectly distribute bonds.</p>
<p><code>DelayedWETH</code> is modified from <code>WETH</code> as follows:</p>
<ul>
<li><code>DelayedWETH</code> is an upgradeable proxy contract.</li>
<li><code>DelayedWETH</code> has an <code>owner()</code> address. We typically expect this to be set to the <code>System Owner</code> address.</li>
<li><code>DelayedWETH</code> has a <code>delay()</code> function that returns a period of time that withdrawals will be delayed.</li>
<li><code>DelayedWETH</code> has an <code>unlock(guy,wad)</code> function that modifies a mapping called <code>withdrawals</code> keyed as
<code>withdrawals[msg.sender][guy] =&gt; WithdrawalRequest</code> where <code>WithdrawalRequest</code> is
<code>struct Withdrawal Request { uint256 amount, uint256 timestamp }</code>. When <code>unlock</code> is called, the timestamp for
<code>withdrawals[msg.sender][guy]</code> is set to the current timestamp and the amount is increased by the given amount.</li>
<li><code>DelayedWETH</code> modifies the <code>WETH.withdraw</code> function such that an address <em>must</em> provide a "sub-account" to withdraw
from. The function signature becomes <code>withdraw(guy,wad)</code>. The function retrieves <code>withdrawals[msg.sender][guy]</code> and
checks that the current <code>block.timestamp</code> is greater than the timestamp on the withdrawal request plus the <code>delay()</code>
seconds and reverts if not. It also confirms that the amount being withdrawn is less than the amount in the withdrawal
request. Before completing the withdrawal, it reduces the amount contained within the withdrawal request. The original
<code>withdraw(wad)</code> function becomes an alias for <code>withdraw(msg.sender, wad)</code>.
<code>withdraw(guy,wad)</code> will not be callable when <code>SuperchainConfig.paused()</code> is <code>true</code>.</li>
<li><code>DelayedWETH</code> has a <code>hold(guy,wad)</code> function that allows the <code>owner()</code> address to, for any holder, give itself an
allowance and immediately <code>transferFrom</code> that allowance amount to itself.</li>
<li><code>DelayedWETH</code> has a <code>hold(guy)</code> function that allows the <code>owner()</code> address to, for any holder, give itself a full
allowance of the holder's balance and immediately <code>transferFrom</code> that amount to itself.</li>
<li><code>DelayedWETH</code> has a <code>recover()</code> function that allows the <code>owner()</code> address to recover any amount of ETH from the
contract.</li>
</ul>
<h4 id="sub-account-model"><a class="header" href="#sub-account-model">Sub-Account Model</a></h4>
<p>This specification requires that withdrawal requests specify "sub-accounts" that these requests correspond to. This
takes the form of requiring that <code>unlock</code> and <code>withdraw</code> both take an <code>address guy</code> parameter as input. By requiring
this extra input, withdrawals are separated between accounts and it is always possible to see how much WETH a specific
end-user of the <code>FaultDisputeGame</code> can withdraw at any given time. It is therefore possible for the <code>DelayedWETH</code>
contract to account for all bug cases within the <code>FaultDisputeGame</code> as long as the <code>FaultDisputeGame</code> always passes the
correct address into <code>withdraw</code>.</p>
<h4 id="delay-period"><a class="header" href="#delay-period">Delay Period</a></h4>
<p>We propose a delay period of 7 days for most OP Stack chains. 7 days provides sufficient time for the <code>owner()</code> of the
<code>DelayedWETH</code> contract to act even if that owner is a large multisig that requires action from many different members
over multiple timezones.</p>
<h4 id="integration"><a class="header" href="#integration">Integration</a></h4>
<p><code>DelayedWETH</code> is expected to be integrated into the Fault Dispute Game as follows:</p>
<ul>
<li>When <code>FaultDisputeGame.initialize</code> is triggered, <code>DelayedWETH.deposit{value: msg.value}()</code> is called.</li>
<li>When <code>FaultDisputeGame.move</code> is triggered, <code>DelayedWETH.deposit{value: msg.value}()</code> is called.</li>
<li>When <code>FaultDisputeGame.resolveClaim</code> is triggered, the game will add to the claimant's internal credit balance.</li>
<li>When <code>FaultDisputeGame.claimCredit</code> is triggered, <code>DelayedWETH.withdraw(recipient, credit)</code> is called.</li>
</ul>
<pre class="mermaid">sequenceDiagram
    participant U as User
    participant FDG as FaultDisputeGame
    participant DW as DelayedWETH

    U-&gt;&gt;FDG: initialize()
    FDG-&gt;&gt;DW: deposit{value: msg.value}()
    Note over DW: FDG gains balance in DW

    loop move by Users
        U-&gt;&gt;FDG: move()
        FDG-&gt;&gt;DW: deposit{value: msg.value}()
        Note over DW: Increases FDG balance in DW
    end

    loop resolveClaim by Users
        U-&gt;&gt;FDG: resolveClaim()
        FDG-&gt;&gt;FDG: Add to claimant credit
    end

  loop Initial claimCredit call by Users
        U-&gt;&gt;FDG: claimCredit()
        FDG-&gt;&gt;DW: unlock(recipient, bond)
    end

    loop Subsequent claimCredit call by Users
        U-&gt;&gt;FDG: claimCredit()
        FDG-&gt;&gt;DW: withdraw(recipient, credit)
        Note over DW: Checks timer/amount for recipient
        DW-&gt;&gt;FDG: Transfer claim to FDG
        FDG-&gt;&gt;U: Transfer claim to User
    end
</pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="bridge-integration"><a class="header" href="#bridge-integration">Bridge Integration</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="fault-proof/stage-one/bridge-integration.html#overview">Overview</a></li>
<li><a href="fault-proof/stage-one/bridge-integration.html#legacy-semantics">Legacy Semantics</a></li>
<li><a href="fault-proof/stage-one/bridge-integration.html#fpac-optimismportal-mods-specification">FPAC <code>OptimismPortal</code> Mods Specification</a>
<ul>
<li><a href="fault-proof/stage-one/bridge-integration.html#roles---optimismportal">Roles - <code>OptimismPortal</code></a></li>
<li><a href="fault-proof/stage-one/bridge-integration.html#new-deployconfig-variables">New <code>DeployConfig</code> Variables</a></li>
<li><a href="fault-proof/stage-one/bridge-integration.html#data-structures">Data Structures</a></li>
<li><a href="fault-proof/stage-one/bridge-integration.html#state-layout">State Layout</a>
<ul>
<li><a href="fault-proof/stage-one/bridge-integration.html#legacy-spacers">Legacy Spacers</a></li>
<li><a href="fault-proof/stage-one/bridge-integration.html#new-state-variables">New State Variables</a></li>
</ul>
</li>
<li><a href="fault-proof/stage-one/bridge-integration.html#provewithdrawaltransaction-modifications"><code>proveWithdrawalTransaction</code> modifications</a>
<ul>
<li><a href="fault-proof/stage-one/bridge-integration.html#interface">Interface</a></li>
<li><a href="fault-proof/stage-one/bridge-integration.html#new-invariants---provewithdrawaltransaction">New Invariants - <code>proveWithdrawalTransaction</code></a></li>
<li><a href="fault-proof/stage-one/bridge-integration.html#changed-invariants---provewithdrawaltransaction">Changed Invariants - <code>proveWithdrawalTransaction</code></a></li>
</ul>
</li>
<li><a href="fault-proof/stage-one/bridge-integration.html#finalizewithdrawaltransaction-modifications"><code>finalizeWithdrawalTransaction</code> modifications</a>
<ul>
<li><a href="fault-proof/stage-one/bridge-integration.html#new-invariants---finalizewithdrawaltransaction">New Invariants - <code>finalizeWithdrawalTransaction</code></a></li>
<li><a href="fault-proof/stage-one/bridge-integration.html#changed-invariants---finalizewithdrawaltransaction">Changed Invariants - <code>finalizeWithdrawalTransaction</code></a></li>
</ul>
</li>
<li><a href="fault-proof/stage-one/bridge-integration.html#air-gap">Air-gap</a>
<ul>
<li><a href="fault-proof/stage-one/bridge-integration.html#blacklisting-disputegames">Blacklisting <code>DisputeGame</code>s</a></li>
<li><a href="fault-proof/stage-one/bridge-integration.html#blacklisting-a-full-gametype">Blacklisting a full <code>GameType</code></a></li>
</ul>
</li>
<li><a href="fault-proof/stage-one/bridge-integration.html#proxy-upgrade">Proxy Upgrade</a></li>
</ul>
</li>
<li><a href="fault-proof/stage-one/bridge-integration.html#permissioned-faultdisputegame">Permissioned <code>FaultDisputeGame</code></a>
<ul>
<li><a href="fault-proof/stage-one/bridge-integration.html#roles---permissioneddisputegame">Roles - <code>PermissionedDisputeGame</code></a></li>
<li><a href="fault-proof/stage-one/bridge-integration.html#modifications">Modifications</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<!-- all glossary references -->
<!-- all links -->
<h2 id="overview-19"><a class="header" href="#overview-19">Overview</a></h2>
<p>With fault proofs, the withdrawal path changes such that withdrawals submitted to the <code>OptimismPortal</code> are proven
against <a href="fault-proof/stage-one/../../glossary.html#l2-output-root-proposals">output proposals</a> submitted as a <a href="fault-proof/stage-one/fault-dispute-game.html"><code>FaultDisputeGame</code></a> prior to being finalized. Output
proposals are now finalized whenever a dispute game resolves in their favor.</p>
<h2 id="legacy-semantics"><a class="header" href="#legacy-semantics">Legacy Semantics</a></h2>
<p>The <code>OptimismPortal</code> uses the <code>L2OutputOracle</code> in the withdrawal path of the rollup to allow users to prove the
presence of their withdrawal inside of the <code>L2ToL1MessagePasser</code> account storage root, which can be retrieved by
providing a preimage to an output root in the oracle. The oracle currently holds a list of all L2 outputs proposed to
L1 by a permissioned PROPOSER key. The list in the contract has the following properties:</p>
<ul>
<li>It must always be sorted by the L2 Block Number that the output proposal is claiming it corresponds to.</li>
<li>All outputs in the list that are &gt; <code>FINALIZATION_PERIOD_SECONDS</code> old are considered "finalized." The separator
between unfinalized/finalized outputs moves forwards implicitly as time passes.</li>
</ul>
<p><img src="fault-proof/stage-one/../../static/assets/legacy-l2oo-list.png" alt="legacy-l2oo-list" /></p>
<p>Currently, if there is a faulty output proposed by the permissioned <code>PROPOSER</code> key, a separate permissioned
<code>CHALLENGER</code> key may intervene. Note that the <code>CHALLENGER</code> role effectively has god-mode privileges, and can currently
act without proving that the outputs they're deleting are indeed incorrect. By deleting an output proposal, the
challenger also deletes all output proposals in front of it.</p>
<p>With the upgrade to the Fault Proof Alpha Chad system, output proposals are no longer sent to the <code>L2OutputOracle</code>, but
to the <code>DisputeGameFactory</code> in order to be fault proven. In contrast to the L2OO, an incorrect output proposal is not
deleted, but proven to be incorrect. The semantics of finalization timelines and the definition of a "finalized" output
proposal also change. Since the DisputeGameFactory fulfills the same role as the L2OutputOracle in a post fault proofs
world by tracking proposed outputs, and the L2OO's semantics are incompatible with the new system, the L2OO is no
longer required.</p>
<h2 id="fpac-optimismportal-mods-specification"><a class="header" href="#fpac-optimismportal-mods-specification">FPAC <code>OptimismPortal</code> Mods Specification</a></h2>
<h3 id="roles---optimismportal"><a class="header" href="#roles---optimismportal">Roles - <code>OptimismPortal</code></a></h3>
<ul>
<li><code>Guardian</code>: Permissioned actor able to pause the portal, blacklist dispute games, and change the
<code>RESPECTED_GAME_TYPE</code>.</li>
</ul>
<h3 id="new-deployconfig-variables"><a class="header" href="#new-deployconfig-variables">New <code>DeployConfig</code> Variables</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody>
<tr><td><code>DISPUTE_GAME_FINALITY_DELAY_SECONDS</code></td><td>The amount of time given to the <code>Guardian</code> role to blacklist a resolved dispute game before any withdrawals proven against it can be finalized, in case of system failure.</td></tr>
<tr><td><code>PROOF_MATURITY_DELAY_SECONDS</code></td><td>Formerly <code>FINALIZATION_PERIOD_SECONDS</code> in the <code>L2OutputOracle</code>, defines the duration that must pass between proving and finalizing a withdrawal.</td></tr>
<tr><td><code>RESPECTED_GAME_TYPE</code></td><td>The dispute game type that the portal uses for the withdrawal path.</td></tr>
</tbody></table>
</div>
<h3 id="data-structures-1"><a class="header" href="#data-structures-1">Data Structures</a></h3>
<p>Withdrawals are now proven against dispute games, which have immutable "root claims" representing the output root
being proposed. The <code>ProvenWithdrawal</code> struct is now defined as:</p>
<pre><code class="language-solidity">/// @notice Represents a proven withdrawal.
/// @custom:field disputeGameProxy The address of the dispute game proxy that the withdrawal was proven against.
/// @custom:field timestamp        Timestamp at which the withdrawal was proven.
struct ProvenWithdrawal {
    IDisputeGame disputeGameProxy;
    uint64 timestamp;
}
</code></pre>
<h3 id="state-layout"><a class="header" href="#state-layout">State Layout</a></h3>
<h4 id="legacy-spacers"><a class="header" href="#legacy-spacers">Legacy Spacers</a></h4>
<p>Spacers should be added at the following storage slots in the <code>OptimismPortal</code> so that they may not be reused:</p>
<div class="table-wrapper"><table><thead><tr><th>Slot</th><th>Description</th></tr></thead><tbody>
<tr><td><code>52</code></td><td>Legacy <code>provenWithdrawals</code> mapping. Withdrawals proven against the <code>L2OutputOracle</code>'s output proposals will be deleted upon the upgrade.</td></tr>
<tr><td><code>54</code></td><td>Legacy <code>L2OutputOracle</code> address.</td></tr>
</tbody></table>
</div>
<h4 id="new-state-variables"><a class="header" href="#new-state-variables">New State Variables</a></h4>
<p><strong><code>DisputeGameFactory</code> address</strong></p>
<pre><code class="language-solidity">/// @notice Address of the DisputeGameFactory.
/// @custom:network-specific
DisputeGameFactory public disputeGameFactory;
</code></pre>
<p><strong>Respected Game Type</strong></p>
<pre><code class="language-solidity">/// @notice The respected game type of the `OptimismPortal`.
///         Can be changed by Guardian.
GameType public respectedGameType;
</code></pre>
<p><strong>Respected Game Type Updated Timestamp</strong></p>
<pre><code class="language-solidity">/// @notice The timestamp at which the respected game type was last updated.
uint64 public respectedGameTypeUpdatedAt;
</code></pre>
<p><strong>New <code>ProvenWithdrawals</code> mapping</strong></p>
<pre><code class="language-solidity">/// @notice A mapping of withdrawal hashes to `ProvenWithdrawal` data.
mapping(bytes32 =&gt; ProvenWithdrawal) public provenWithdrawals;
</code></pre>
<p><strong>Blacklisted <code>DisputeGame</code> mapping</strong></p>
<pre><code class="language-solidity">/// @notice A mapping of dispute game addresses to whether or not they are blacklisted.
mapping(IDisputeGame =&gt; bool) public disputeGameBlacklist;
</code></pre>
<h3 id="provewithdrawaltransaction-modifications"><a class="header" href="#provewithdrawaltransaction-modifications"><code>proveWithdrawalTransaction</code> modifications</a></h3>
<p>Proving a withdrawal transaction now proves against an output root in a dispute game, rather than one in the
<code>L2OutputOracle</code>.</p>
<h4 id="interface"><a class="header" href="#interface">Interface</a></h4>
<p>The type signature of the function does not change, but the purpose of the second argument transitions from providing
an index within the <code>L2OutputOracle</code>'s <code>l2Outputs</code> array to an index within the <code>DisputeGameFactory</code>'s list of created
games.</p>
<pre><code class="language-solidity">/// @notice Proves a withdrawal transaction.
/// @param _tx               Withdrawal transaction to finalize.
/// @param _disputeGameIndex Index of the dispute game to prove the withdrawal against.
/// @param _outputRootProof  Inclusion proof of the L2ToL1MessagePasser contract's storage root.
/// @param _withdrawalProof  Inclusion proof of the withdrawal in L2ToL1MessagePasser contract.
function proveWithdrawalTransaction(
    Types.WithdrawalTransaction memory _tx,
    uint256 _disputeGameIndex,
    Types.OutputRootProof calldata _outputRootProof,
    bytes[] calldata _withdrawalProof
) external whenNotPaused;
</code></pre>
<h4 id="new-invariants---provewithdrawaltransaction"><a class="header" href="#new-invariants---provewithdrawaltransaction">New Invariants - <code>proveWithdrawalTransaction</code></a></h4>
<p><strong>Trusted <code>GameType</code></strong>
The <code>DisputeGameFactory</code> can create many different types of dispute games, delineated by their <code>GameType</code>. The game
type of the dispute game fetched from the factory's list at <code>_disputeGameIndex</code> must be of type <code>RESPECTED_GAME_TYPE</code>.
The call should revert on all other game types it encounters.</p>
<h4 id="changed-invariants---provewithdrawaltransaction"><a class="header" href="#changed-invariants---provewithdrawaltransaction">Changed Invariants - <code>proveWithdrawalTransaction</code></a></h4>
<p><strong>Re-proving withdrawals</strong>
Users being able to re-prove withdrawals, in special cases, is still necessary to prevent user withdrawals from being
bricked. It is kept to protect honest users when they prove their withdrawal inside of a malicious proposal. The
timestamp of re-proven withdrawals is still reset.</p>
<ol>
<li><strong>Old:</strong> Re-proving is allowed if the output root at the proven withdrawal's <code>l2OutputIndex</code> changed in the
<code>L2OutputOracle</code>.</li>
<li><strong>New:</strong> Re-proving is allowed at any time by the user. When a withdrawal is re-proven, its proof maturity delay is
reset.</li>
</ol>
<h3 id="finalizewithdrawaltransaction-modifications"><a class="header" href="#finalizewithdrawaltransaction-modifications"><code>finalizeWithdrawalTransaction</code> modifications</a></h3>
<p>Finalizing a withdrawal transaction now references a <code>DisputeGame</code> to determine the status of the output proposal that
the withdrawal was proven against.</p>
<h4 id="new-invariants---finalizewithdrawaltransaction"><a class="header" href="#new-invariants---finalizewithdrawaltransaction">New Invariants - <code>finalizeWithdrawalTransaction</code></a></h4>
<p><strong>Trusted <code>GameType</code></strong>
The <code>DisputeGameFactory</code> can create many different types of dispute games, delineated by their <code>GameType</code>. The game
type of the dispute game fetched from the factory's list at <code>_disputeGameIndex</code> must be of type <code>RESPECTED_GAME_TYPE</code>.
The call should revert on all other game types it encounters.</p>
<p><strong>Respected Game Type Updated</strong>
A withdrawal may never be finalized if the dispute game was created before the respected game type was last updated.</p>
<p><strong>Dispute Game Blacklist</strong>
The <code>Guardian</code> role can blacklist certain <code>DisputeGame</code> addresses in the event of a system failure. If the address of
the dispute game that the withdrawal was proven against is present in the <code>disputeGameBlacklist</code> mapping, the call
should always revert.</p>
<p><strong>Dispute Game Maturity</strong>
See <a href="fault-proof/stage-one/bridge-integration.html#air-gap">"Air-gap"</a></p>
<h4 id="changed-invariants---finalizewithdrawaltransaction"><a class="header" href="#changed-invariants---finalizewithdrawaltransaction">Changed Invariants - <code>finalizeWithdrawalTransaction</code></a></h4>
<p><strong>Output Proposal Validity</strong>
Instead of checking if the proven withdrawal's output proposal has existed for longer the legacy finalization period,
we check if the dispute game has resolved in the root claim's favor. A <code>FaultDisputeGame</code> must never be considered to
have resolved in the <code>rootClaim</code>'s favor unless its <code>status()</code> is equal to <code>DEFENDER_WINS</code>.</p>
<h3 id="air-gap"><a class="header" href="#air-gap">Air-gap</a></h3>
<p>Given it's own section due to it's importance, the air gap is an enforced period of time between a dispute game's
resolution and users being able to finalize withdrawals that were proven against its root claim. When the <code>DisputeGame</code>
resolves globally, it stores the timestamp. The portal's <code>finalizeWithdrawalTransaction</code> function asserts that
<code>DISPUTE_GAME_FINALITY_DELAY_SECONDS</code> have passed since the resolution timestamp before allowing any withdrawals proven
against the dispute game to be finalized. Because the <code>FaultDisputeGame</code> is a trusted implementation set by the owner
of the <code>DisputeGameFactory</code>, it is safe to trust that this value is honestly set.</p>
<h4 id="blacklisting-disputegames"><a class="header" href="#blacklisting-disputegames">Blacklisting <code>DisputeGame</code>s</a></h4>
<p>A new method is added to assign <code>DisputeGame</code>s in the <code>disputeGameBlacklist</code> mapping mentioned in
<a href="fault-proof/stage-one/bridge-integration.html#state-layout">"State Layout"</a>, in the event that a dispute game is detected to have resolved incorrectly. The only
actor who may call this function is the <code>Guardian</code> role.</p>
<p>Blacklisting a dispute game means that no withdrawals proven against it will be allowed to finalize
(per the "Dispute Game Blacklist" invariant), and they must re-prove against a new dispute game that resolves correctly.
The Portal's guardian role is obligated to blacklist any dispute games that it deems to have resolved incorrectly.
Withdrawals proven against a blacklisted dispute game are not prevented from re-proving or being finalized in the
future.</p>
<h4 id="blacklisting-a-full-gametype"><a class="header" href="#blacklisting-a-full-gametype">Blacklisting a full <code>GameType</code></a></h4>
<p>In the event of a catastrophic failure, we can upgrade the <code>OptimismPortal</code> proxy to an implementation with a
different <code>RESPECTED_GAME_TYPE</code>. All pending withdrawals that reference a different game type will not be allowed to
finalize and must re-prove, due to the "Trusted <code>GameType</code>" invariant. This should generally be avoided, but allows
for a blanket blacklist of pending withdrawals corresponding to the current <code>RESPECTED_GAME_TYPE</code>. Depending on if
we're okay with the tradeoffs, this also may be the most efficient way to upgrade the dispute game in the future.</p>
<h3 id="proxy-upgrade"><a class="header" href="#proxy-upgrade">Proxy Upgrade</a></h3>
<p>Upgrading the <code>OptimismPortal</code> proxy to an implementation that follows this specification will invalidate all pending
withdrawals. This means that all users with pending withdrawals will need to re-prove their withdrawals against an
output proposal submitted in the form of a <code>DisputeGame</code>.</p>
<h2 id="permissioned-faultdisputegame"><a class="header" href="#permissioned-faultdisputegame">Permissioned <code>FaultDisputeGame</code></a></h2>
<p>As a fallback to permissioned proposals, a child contract of the <code>FaultDisputeGame</code> will be created that has 2 new
roles: the <code>PROPOSER</code> and a <code>CHALLENGER</code> (or set of challengers). Each interaction
(<code>move</code> [<code>attack</code> / <code>defend</code>], <code>step</code>, <code>resolve</code> / <code>resolveClaim</code>, <code>addLocalData</code>, etc.) will be permissioned to the
<code>CHALLENGER</code> key, and the <code>initialize</code> function will be permissioned to the <code>PROPOSER</code> key.</p>
<p>In the event that we'd like to switch back to permissioned proposals, we can change the <code>RESPECTED_GAME_TYPE</code> in the
<code>OptimismPortal</code> to a deployment of the <code>PermissionedFaultDisputeGame</code>.</p>
<h3 id="roles---permissioneddisputegame"><a class="header" href="#roles---permissioneddisputegame">Roles - <code>PermissionedDisputeGame</code></a></h3>
<ul>
<li><code>PROPOSER</code> - Actor that can create a <code>PermissionedFaultDisputeGame</code> and participate in the games they've created.</li>
<li><code>CHALLENGER</code> - Actor(s) that can participate in a <code>PermissionedFaultDisputeGame</code>.</li>
</ul>
<h3 id="modifications"><a class="header" href="#modifications">Modifications</a></h3>
<p><strong>State Layout</strong></p>
<p>2 new immutables:</p>
<pre><code class="language-solidity">/// @notice The `PROPOSER` role.
address public immutable PROPOSER;

/// @notice The `CHALLENGER` role.
address public immutable CHALLENGER;
</code></pre>
<p><strong>Functions</strong></p>
<p>Every function that can mutate state should be overridden to add a check that either:</p>
<ol>
<li>The <code>msg.sender</code> has the <code>CHALLENGER</code> role.</li>
<li>The <code>msg.sender</code> has the <code>PROPOSER</code> role.</li>
</ol>
<p>If the <code>msg.sender</code> does not have either role, the function must revert.</p>
<p>The exception is the <code>initialize</code> function, which may only be called if the <code>tx.origin</code> is the <code>PROPOSER</code> role.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="optimismportal"><a class="header" href="#optimismportal">OptimismPortal</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="fault-proof/stage-one/optimism-portal.html#overview">Overview</a></li>
<li><a href="fault-proof/stage-one/optimism-portal.html#definitions">Definitions</a>
<ul>
<li><a href="fault-proof/stage-one/optimism-portal.html#proof-maturity-delay">Proof Maturity Delay</a></li>
<li><a href="fault-proof/stage-one/optimism-portal.html#proven-withdrawal">Proven Withdrawal</a></li>
<li><a href="fault-proof/stage-one/optimism-portal.html#finalized-withdrawal">Finalized Withdrawal</a></li>
<li><a href="fault-proof/stage-one/optimism-portal.html#valid-withdrawal">Valid Withdrawal</a></li>
<li><a href="fault-proof/stage-one/optimism-portal.html#invalid-withdrawal">Invalid Withdrawal</a></li>
<li><a href="fault-proof/stage-one/optimism-portal.html#l2-withdrawal-sender">L2 Withdrawal Sender</a></li>
<li><a href="fault-proof/stage-one/optimism-portal.html#receive-default-gas-limit">Receive Default Gas Limit</a></li>
<li><a href="fault-proof/stage-one/optimism-portal.html#minimum-gas-limit">Minimum Gas Limit</a></li>
<li><a href="fault-proof/stage-one/optimism-portal.html#unsafe-target">Unsafe Target</a></li>
<li><a href="fault-proof/stage-one/optimism-portal.html#block-output">Block Output</a></li>
<li><a href="fault-proof/stage-one/optimism-portal.html#output-root">Output Root</a></li>
<li><a href="fault-proof/stage-one/optimism-portal.html#super-output">Super Output</a></li>
<li><a href="fault-proof/stage-one/optimism-portal.html#super-root">Super Root</a></li>
</ul>
</li>
<li><a href="fault-proof/stage-one/optimism-portal.html#assumptions">Assumptions</a>
<ul>
<li><a href="fault-proof/stage-one/optimism-portal.html#aop-001-dispute-game-contracts-properly-report-important-properties">aOP-001: Dispute Game contracts properly report important properties</a>
<ul>
<li><a href="fault-proof/stage-one/optimism-portal.html#mitigations">Mitigations</a></li>
</ul>
</li>
<li><a href="fault-proof/stage-one/optimism-portal.html#aop-002-disputegamefactory-properly-reports-its-created-games">aOP-002: DisputeGameFactory properly reports its created games</a>
<ul>
<li><a href="fault-proof/stage-one/optimism-portal.html#mitigations-1">Mitigations</a></li>
</ul>
</li>
<li><a href="fault-proof/stage-one/optimism-portal.html#aop-003-incorrectly-resolving-games-will-be-invalidated-before-they-have-valid-claims">aOP-003: Incorrectly resolving games will be invalidated before they have Valid Claims</a>
<ul>
<li><a href="fault-proof/stage-one/optimism-portal.html#mitigations-2">Mitigations</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="fault-proof/stage-one/optimism-portal.html#dependencies">Dependencies</a></li>
<li><a href="fault-proof/stage-one/optimism-portal.html#invariants">Invariants</a>
<ul>
<li><a href="fault-proof/stage-one/optimism-portal.html#iop-001-invalid-withdrawals-can-never-be-finalized">iOP-001: Invalid Withdrawals can never be finalized</a>
<ul>
<li><a href="fault-proof/stage-one/optimism-portal.html#impact">Impact</a></li>
</ul>
</li>
<li><a href="fault-proof/stage-one/optimism-portal.html#iop-002-valid-withdrawals-can-always-be-finalized-in-bounded-time">iOP-002: Valid Withdrawals can always be finalized in bounded time</a>
<ul>
<li><a href="fault-proof/stage-one/optimism-portal.html#impact-1">Impact</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="fault-proof/stage-one/optimism-portal.html#function-specification">Function Specification</a>
<ul>
<li><a href="fault-proof/stage-one/optimism-portal.html#constructor">constructor</a></li>
<li><a href="fault-proof/stage-one/optimism-portal.html#initialize">initialize</a></li>
<li><a href="fault-proof/stage-one/optimism-portal.html#paused">paused</a></li>
<li><a href="fault-proof/stage-one/optimism-portal.html#guardian">guardian</a></li>
<li><a href="fault-proof/stage-one/optimism-portal.html#ethlockbox">ethLockbox</a></li>
<li><a href="fault-proof/stage-one/optimism-portal.html#proofmaturitydelayseconds">proofMaturityDelaySeconds</a></li>
<li><a href="fault-proof/stage-one/optimism-portal.html#disputegamefactory">disputeGameFactory</a></li>
<li><a href="fault-proof/stage-one/optimism-portal.html#disputegamefinalitydelayseconds">disputeGameFinalityDelaySeconds</a></li>
<li><a href="fault-proof/stage-one/optimism-portal.html#respectedgametype">respectedGameType</a></li>
<li><a href="fault-proof/stage-one/optimism-portal.html#respectedgametypeupdatedat">respectedGameTypeUpdatedAt</a></li>
<li><a href="fault-proof/stage-one/optimism-portal.html#l2sender">l2Sender</a></li>
<li><a href="fault-proof/stage-one/optimism-portal.html#provewithdrawaltransaction">proveWithdrawalTransaction</a></li>
<li><a href="fault-proof/stage-one/optimism-portal.html#checkwithdrawal">checkWithdrawal</a></li>
<li><a href="fault-proof/stage-one/optimism-portal.html#finalizewithdrawaltransaction">finalizeWithdrawalTransaction</a></li>
<li><a href="fault-proof/stage-one/optimism-portal.html#donateeth">donateETH</a></li>
<li><a href="fault-proof/stage-one/optimism-portal.html#finalizewithdrawaltransactionexternalproof">finalizeWithdrawalTransactionExternalProof</a></li>
<li><a href="fault-proof/stage-one/optimism-portal.html#numproofsubmitters">numProofSubmitters</a></li>
<li><a href="fault-proof/stage-one/optimism-portal.html#receive">receive</a></li>
<li><a href="fault-proof/stage-one/optimism-portal.html#minimumgaslimit">minimumGasLimit</a></li>
<li><a href="fault-proof/stage-one/optimism-portal.html#superchainconfig">superchainConfig</a></li>
<li><a href="fault-proof/stage-one/optimism-portal.html#disputegameblacklist">disputeGameBlacklist</a></li>
<li><a href="fault-proof/stage-one/optimism-portal.html#deposittransaction">depositTransaction</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-20"><a class="header" href="#overview-20">Overview</a></h2>
<p>The <code>OptimismPortal</code> contract is the primary interface for deposits and withdrawals between the L1
and L2 chains within an OP Stack system. The <code>OptimismPortal</code> contract allows users to create
"deposit transactions" on the L1 chain that are automatically executed on the L2 chain within a
bounded amount of time. Additionally, the <code>OptimismPortal</code> contract allows users to execute
withdrawal transactions by proving that such a withdrawal was initiated on the L2 chain. The
<code>OptimismPortal</code> verifies the correctness of these withdrawal transactions against Output Roots
that have been declared valid by the L1 Fault Proof system.</p>
<h2 id="definitions-3"><a class="header" href="#definitions-3">Definitions</a></h2>
<h3 id="proof-maturity-delay"><a class="header" href="#proof-maturity-delay">Proof Maturity Delay</a></h3>
<p>The <strong>Proof Maturity Delay</strong> is the minimum amount of time that a withdrawal must be a
<a href="fault-proof/stage-one/optimism-portal.html#proven-withdrawal">Proven Withdrawal</a> before it can be finalized.</p>
<h3 id="proven-withdrawal"><a class="header" href="#proven-withdrawal">Proven Withdrawal</a></h3>
<p>A <strong>Proven Withdrawal</strong> is a withdrawal transaction that has been proven against some Output Root
by a user. Users can prove withdrawals against any Dispute Game contract that meets the following
conditions:</p>
<ul>
<li>The game is a <a href="fault-proof/stage-one/./anchor-state-registry.html#registered-game">Registered Game</a></li>
<li>The game is not a <a href="fault-proof/stage-one/./anchor-state-registry.html#retired-game">Retired Game</a></li>
<li>The game has a game type that matches the current
<a href="fault-proof/stage-one/./anchor-state-registry.html#respected-game-type">Respected Game Type</a></li>
<li>The game has not resolved in favor of the Challenger</li>
</ul>
<p>Notably, the <code>OptimismPortal</code> allows users to prove withdrawals against games that are currently
in progress (games that are not <a href="fault-proof/stage-one/./anchor-state-registry.html#resolved-game">Resolved Games</a>).</p>
<p>Users may re-prove a withdrawal at any time. User withdrawals are stored on a per-user basis such
that re-proving a withdrawal cannot cause the timer for
<a href="fault-proof/stage-one/optimism-portal.html#finalized-withdrawal">finalizing a withdrawal</a> to be reset for another user.</p>
<h3 id="finalized-withdrawal"><a class="header" href="#finalized-withdrawal">Finalized Withdrawal</a></h3>
<p>A <strong>Finalized Withdrawal</strong> is a withdrawal transaction that was previously a Proven Withdrawal and
meets a number of additional conditions that allow the withdrawal to be executed.</p>
<p>Users can finalize a withdrawal if they have previously proven the withdrawal and their withdrawal
meets the following conditions:</p>
<ul>
<li>Withdrawal is a <a href="fault-proof/stage-one/optimism-portal.html#proven-withdrawal">Proven Withdrawal</a></li>
<li>Withdrawal was proven at least <a href="fault-proof/stage-one/optimism-portal.html#proof-maturity-delay">Proof Maturity Delay</a> seconds ago</li>
<li>Withdrawal was proven against a game with a <a href="fault-proof/stage-one/./anchor-state-registry.html#valid-claim">Valid Claim</a></li>
<li>Withdrawal was not previously finalized</li>
</ul>
<h3 id="valid-withdrawal"><a class="header" href="#valid-withdrawal">Valid Withdrawal</a></h3>
<p>A <strong>Valid Withdrawal</strong> is a withdrawal transaction that was correctly executed on the L2 system as
would be reported by a perfect oracle for the query.</p>
<h3 id="invalid-withdrawal"><a class="header" href="#invalid-withdrawal">Invalid Withdrawal</a></h3>
<p>An <strong>Invalid Withdrawal</strong> is any withdrawal that is not a <a href="fault-proof/stage-one/optimism-portal.html#valid-withdrawal">Valid Withdrawal</a>.</p>
<h3 id="l2-withdrawal-sender"><a class="header" href="#l2-withdrawal-sender">L2 Withdrawal Sender</a></h3>
<p>The <strong>L2 Withdrawal Sender</strong> is the address of the account that triggered a given withdrawal
transaction on L2. The <code>OptimismPortal</code> is expected to expose a variable that includes this value
when <a href="fault-proof/stage-one/optimism-portal.html#finalized-withdrawal">finalizing</a> a withdrawal.</p>
<h3 id="receive-default-gas-limit"><a class="header" href="#receive-default-gas-limit">Receive Default Gas Limit</a></h3>
<p>The receive default gas limit is the gas limit provided for simple ETH deposits that are triggered
when a user sends ETH to the <code>OptimismPortal</code> via the <code>receive</code> function. This gas limit is
currently set to a value of 100000 gas.</p>
<h3 id="minimum-gas-limit"><a class="header" href="#minimum-gas-limit">Minimum Gas Limit</a></h3>
<p>The minimum gas limit is the minimum amount of L2 gas that must be purchased when creating a
deposit transaction. This limit increases linearly based on the size of the calldata to prevent
users from creating L2 resource usage without paying for it. The minimum gas limit is calculated
as: calldata_byte_count * 40 + 21000.</p>
<h3 id="unsafe-target"><a class="header" href="#unsafe-target">Unsafe Target</a></h3>
<p>An <strong>Unsafe Target</strong> is a target address that is considered unsafe for withdrawal or deposit
transactions. Unsafe targets include the OptimismPortal contract itself and the ETHLockbox
contract. Targeting these addresses could potentially create attack vectors.</p>
<h3 id="block-output"><a class="header" href="#block-output">Block Output</a></h3>
<p>A <strong>Block Output</strong>, commonly called an <strong>Output</strong>, is a data structure that wraps the key hash
elements of a given L2 block.</p>
<p>The structure of the Block Output is versioned (32 bytes). The current Block Output version is
<code>0x0000000000000000000000000000000000000000000000000000000000000000</code> (V0). A V0 Block Output has
the following structure:</p>
<pre><code class="language-solidity">struct BlockOutput {
  bytes32 version;
  bytes32 stateRoot;
  bytes32 messagePasserStorageRoot;
  bytes32 blockHash;
}
</code></pre>
<p>Where:</p>
<ul>
<li><code>version</code> is a version identifier that describes the structure of the Output Root</li>
<li><code>stateRoot</code> is the state root of the L2 block this Output Root corresponds to</li>
<li><code>messagePasserStorageRoot</code> is the storage root of the <code>L2ToL1MessagePasser</code> contract at the L2
block this Output Root corresponds to</li>
<li><code>blockHash</code> is the block hash of the L2 block this Output Root corresponds to</li>
</ul>
<h3 id="output-root"><a class="header" href="#output-root">Output Root</a></h3>
<p>An <strong>Output Root</strong> is a commitment to a <a href="fault-proof/stage-one/optimism-portal.html#block-output">Block Output</a>. A detailed description of
this commitment can be found <a href="fault-proof/stage-one/../../protocol/proposals.html#l2-output-commitment-construction">on this page</a>.</p>
<h3 id="super-output"><a class="header" href="#super-output">Super Output</a></h3>
<p>A <strong>Super Output</strong> is a data structure that commits all of the <a href="fault-proof/stage-one/optimism-portal.html#block-output">Block Outputs</a> for
all chains within the Superchain Interop Set at a given timestamp. A Super Output can also commit
to a single Block Output to maintain compatibility with chains outside of the Interop Set.</p>
<p>The structure of the Super Output is versioned (1 byte). The current version is <code>0x01</code> (V1). A V1
Super Output has the following structure:</p>
<pre><code class="language-solidity">struct OutputRootWithChainId {
  uint256 chainId;
  bytes32 root;
}

struct SuperOutput {
  uint64 timestamp;
  OutputRootWithChainid[] outputRoots;
}
</code></pre>
<p>The output root for each chain in the super root MUST be for the block with a timestamp where
<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal">im</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7335em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">Bl</span><span class="mord mathnormal">oc</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal">im</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal">im</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal">im</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> where <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal">im</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is the super root timestamp, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">Bl</span><span class="mord mathnormal">oc</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal">im</span><span class="mord mathnormal">e</span></span></span></span> is the chain block time
and <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal">im</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is the block timestamp. That is the output root must be from the last possible block at or before the super
root timestamp.</p>
<p>The output roots in the super root MUST be sorted by chain ID ascending.</p>
<h3 id="super-root"><a class="header" href="#super-root">Super Root</a></h3>
<p>A <strong>Super Root</strong> is a commitment to a <a href="fault-proof/stage-one/optimism-portal.html#super-output">Super Output</a>, computed as:</p>
<pre><code class="language-solidity">keccak256(encodeSuperRoot(SuperRoot))
</code></pre>
<p>Where <code>encodeSuperRoot</code> for the V1 Super Output is:</p>
<pre><code class="language-solidity">function encodeSuperRoot(SuperRoot memory root) returns (bytes) {
  require(root.outputRoots.length &gt; 0); // Super Root must have at least one Output Root.
  return concat(
    0x01, // Super Root version byte
    root.timestamp,
    [
      concat(outputRoot.chainId, outputRoot.root)
      for outputRoot
      in root.outputRoots
    ]
  );
}
</code></pre>
<h2 id="assumptions-1"><a class="header" href="#assumptions-1">Assumptions</a></h2>
<h3 id="aop-001-dispute-game-contracts-properly-report-important-properties"><a class="header" href="#aop-001-dispute-game-contracts-properly-report-important-properties">aOP-001: Dispute Game contracts properly report important properties</a></h3>
<p>We assume that the <code>FaultDisputeGame</code> and <code>PermissionedDisputeGame</code> contracts properly and
faithfully report the following properties:</p>
<ul>
<li>Game type</li>
<li>L2 block number</li>
<li>Root claim value</li>
<li>Game extra data</li>
<li>Creation timestamp</li>
<li>Resolution timestamp</li>
<li>Resolution result</li>
<li>Whether the game was the respected game type at creation</li>
</ul>
<p>We also specifically assume that the game creation timestamp and the resolution timestamp are not
set to values in the future.</p>
<h4 id="mitigations-3"><a class="header" href="#mitigations-3">Mitigations</a></h4>
<ul>
<li>Existing audit on the <code>FaultDisputeGame</code> contract</li>
<li>Integration testing</li>
</ul>
<h3 id="aop-002-disputegamefactory-properly-reports-its-created-games"><a class="header" href="#aop-002-disputegamefactory-properly-reports-its-created-games">aOP-002: DisputeGameFactory properly reports its created games</a></h3>
<p>We assume that the <code>DisputeGameFactory</code> contract properly and faithfully reports the games it has
created.</p>
<h4 id="mitigations-4"><a class="header" href="#mitigations-4">Mitigations</a></h4>
<ul>
<li>Existing audit on the <code>DisputeGameFactory</code> contract</li>
<li>Integration testing</li>
</ul>
<h3 id="aop-003-incorrectly-resolving-games-will-be-invalidated-before-they-have-valid-claims"><a class="header" href="#aop-003-incorrectly-resolving-games-will-be-invalidated-before-they-have-valid-claims">aOP-003: Incorrectly resolving games will be invalidated before they have Valid Claims</a></h3>
<p>We assume that any games that are resolved incorrectly will be invalidated either by
<a href="fault-proof/stage-one/./anchor-state-registry.html#blacklisted-game">blacklisting</a> or by
<a href="fault-proof/stage-one/./anchor-state-registry.html#retired-game">retirement</a> BEFORE they are considered to have
<a href="fault-proof/stage-one/./anchor-state-registry.html#valid-claim">Valid Claims</a>.</p>
<p>Proper Games that resolve in favor the Defender will be considered to have Valid Claims after the
<a href="fault-proof/stage-one/./anchor-state-registry.html#dispute-game-finality-delay-airgap">Dispute Game Finality Delay</a> has
elapsed UNLESS the Pause Mechanism is active. Therefore, in the absence of the Pause Mechanism,
parties responsible for game invalidation have exactly the Dispute Game Finality Delay to
invalidate a withdrawal after it resolves incorrectly. If the Pause Mechanism is active, then any
incorrectly resolving games must be invalidated before the pause is deactivated.</p>
<h4 id="mitigations-5"><a class="header" href="#mitigations-5">Mitigations</a></h4>
<ul>
<li>Stakeholder incentives / processes</li>
<li>Incident response plan</li>
<li>Monitoring</li>
</ul>
<h2 id="dependencies-4"><a class="header" href="#dependencies-4">Dependencies</a></h2>
<ul>
<li><a href="fault-proof/stage-one/./anchor-state-registry.html#iasr-001-games-are-represented-as-proper-games-accurately">iASR-001</a></li>
<li><a href="fault-proof/stage-one/./anchor-state-registry.html#iasr-002-all-valid-claims-are-truly-valid-claims">iASR-002</a></li>
</ul>
<h2 id="invariants-2"><a class="header" href="#invariants-2">Invariants</a></h2>
<h3 id="iop-001-invalid-withdrawals-can-never-be-finalized"><a class="header" href="#iop-001-invalid-withdrawals-can-never-be-finalized">iOP-001: Invalid Withdrawals can never be finalized</a></h3>
<p>We require that <a href="fault-proof/stage-one/optimism-portal.html#invalid-withdrawal">Invalid Withdrawals</a> can never be
<a href="fault-proof/stage-one/optimism-portal.html#finalized-withdrawal">finalized</a> for any reason.</p>
<h4 id="impact-5"><a class="header" href="#impact-5">Impact</a></h4>
<p><strong>Severity: Critical</strong></p>
<p>If this invariant is broken, any number of arbitrarily bad outcomes could happen. Most obviously,
we would expect all bridge systems relying on the <code>OptimismPortal</code> to be immediately compromised.</p>
<h3 id="iop-002-valid-withdrawals-can-always-be-finalized-in-bounded-time"><a class="header" href="#iop-002-valid-withdrawals-can-always-be-finalized-in-bounded-time">iOP-002: Valid Withdrawals can always be finalized in bounded time</a></h3>
<p>We require that <a href="fault-proof/stage-one/optimism-portal.html#valid-withdrawal">Valid Withdrawals</a> can always be
<a href="fault-proof/stage-one/optimism-portal.html#finalized-withdrawal">finalized</a> within some reasonable, bounded amount of time.</p>
<h4 id="impact-6"><a class="header" href="#impact-6">Impact</a></h4>
<p><strong>Severity: Critical</strong></p>
<p>If this invariant is broken, we would expect that users are unable to withdraw bridged assets. We
see this as a critical system risk.</p>
<h2 id="function-specification-1"><a class="header" href="#function-specification-1">Function Specification</a></h2>
<h3 id="constructor-1"><a class="header" href="#constructor-1">constructor</a></h3>
<ul>
<li>MUST set the value of the <a href="fault-proof/stage-one/optimism-portal.html#proof-maturity-delay">Proof Maturity Delay</a>.</li>
</ul>
<h3 id="initialize-1"><a class="header" href="#initialize-1">initialize</a></h3>
<ul>
<li>MUST only be callable by the ProxyAdmin or its owner.</li>
<li>MUST set the value of the <code>SystemConfig</code> contract.</li>
<li>MUST set the value of the <code>AnchorStateRegistry</code> contract.</li>
<li>MUST assert that the ETHLockbox state is valid based on the feature flag.</li>
<li>MUST set the value of the <a href="fault-proof/stage-one/optimism-portal.html#l2-withdrawal-sender">L2 Withdrawal Sender</a> variable to the default
value if the value is not set already.</li>
<li>MUST initialize the resource metering configuration.</li>
</ul>
<h3 id="paused-1"><a class="header" href="#paused-1">paused</a></h3>
<p>Returns the current state of the <code>SystemConfig.paused()</code> function.</p>
<h3 id="guardian"><a class="header" href="#guardian">guardian</a></h3>
<p>Returns the address of the Guardian as per <code>SystemConfig.guardian()</code>.</p>
<h3 id="ethlockbox"><a class="header" href="#ethlockbox">ethLockbox</a></h3>
<p>Returns the address of the ETHLockbox configured for this contract. If the contract has not been
configured for this OptimismPortal, this function will return <code>address(0)</code>.</p>
<h3 id="proofmaturitydelayseconds"><a class="header" href="#proofmaturitydelayseconds">proofMaturityDelaySeconds</a></h3>
<p>Returns the value of the <a href="fault-proof/stage-one/optimism-portal.html#proof-maturity-delay">Proof Maturity Delay</a>.</p>
<h3 id="disputegamefactory"><a class="header" href="#disputegamefactory">disputeGameFactory</a></h3>
<p>Returns the DisputeGameFactory contract from the AnchorStateRegistry contract.</p>
<h3 id="disputegamefinalitydelayseconds-1"><a class="header" href="#disputegamefinalitydelayseconds-1">disputeGameFinalityDelaySeconds</a></h3>
<p><strong>Legacy Function</strong></p>
<p>Returns the value of the
<a href="fault-proof/stage-one/./anchor-state-registry.html#dispute-game-finality-delay-airgap">Dispute Game Finality Delay</a> as per
a call to <code>AnchorStateRegistry.disputeGameFinalityDelaySeconds()</code>.</p>
<h3 id="respectedgametype-1"><a class="header" href="#respectedgametype-1">respectedGameType</a></h3>
<p><strong>Legacy Function</strong></p>
<p>Returns the value of the current
<a href="fault-proof/stage-one/./anchor-state-registry.html#respected-game-type">Respected Game Type</a> as per a call to
<code>AnchorStateRegistry.respectedGameType</code>.</p>
<h3 id="respectedgametypeupdatedat"><a class="header" href="#respectedgametypeupdatedat">respectedGameTypeUpdatedAt</a></h3>
<p><strong>Legacy Function</strong></p>
<p>Returns the value of the current
<a href="fault-proof/stage-one/./anchor-state-registry.html#retirement-timestamp">Retirement Timestamp</a> as per a call to
`AnchorStateRegistry.retirementTimestamp.</p>
<h3 id="l2sender"><a class="header" href="#l2sender">l2Sender</a></h3>
<p>Returns the address of the <a href="fault-proof/stage-one/optimism-portal.html#l2-withdrawal-sender">L2 Withdrawal Sender</a>. If the <code>OptimismPortal</code>
has not been initialized then this value will be <code>address(0)</code> and should not be used. If the
<code>OptimismPortal</code> is not currently executing an withdrawal transaction then this value will be
<code>0x000000000000000000000000000000000000dEaD</code> and should not be used.</p>
<h3 id="provewithdrawaltransaction"><a class="header" href="#provewithdrawaltransaction">proveWithdrawalTransaction</a></h3>
<p>Allows a user to <a href="fault-proof/stage-one/optimism-portal.html#proven-withdrawal">prove</a> a withdrawal transaction.</p>
<ul>
<li>MUST revert if the system is paused.</li>
<li>MUST revert if the withdrawal target is an <a href="fault-proof/stage-one/optimism-portal.html#unsafe-target">Unsafe Target</a>.</li>
<li>MUST revert if the withdrawal is being proven against a game that is not a
<a href="fault-proof/stage-one/./anchor-state-registry.html#proper-game">Proper Game</a>.</li>
<li>MUST revert if the withdrawal is being proven against a game that is not a
<a href="fault-proof/stage-one/./anchor-state-registry.html#respected-game">Respected Game</a>.</li>
<li>MUST revert if the withdrawal is being proven against a game that has resolved in favor of the
Challenger.</li>
<li>MUST revert if the current timestamp is less than or equal to the dispute game's creation
timestamp.</li>
<li>MUST revert if the proof provided by the user of the preimage of the Output Root that the dispute
game argues about is invalid. This proof is verified by hashing the user-provided preimage and
comparing them to the root claim of the referenced dispute game.</li>
<li>MUST revert if the provided merkle trie proof that the withdrawal was included within the root
claim of the provided dispute game is invalid.</li>
<li>MUST otherwise store a record of the withdrawal proof that includes the hash of the proven
withdrawal, the address of the game against which it was proven, and the block timestamp at which
the proof transaction was submitted.</li>
<li>MUST add the proof submitter to the list of submitters for this withdrawal hash.</li>
<li>MUST emit a <code>WithdrawalProven</code> event with the withdrawal hash, sender, and target.</li>
<li>MUST emit a <code>WithdrawalProvenExtension1</code> event with the withdrawal hash and proof submitter address.</li>
</ul>
<h3 id="checkwithdrawal"><a class="header" href="#checkwithdrawal">checkWithdrawal</a></h3>
<p>Checks that a withdrawal transaction can be <a href="fault-proof/stage-one/optimism-portal.html#finalized-withdrawal">finalized</a>.</p>
<ul>
<li>MUST revert if the withdrawal being finalized has already been finalized.</li>
<li>MUST revert if the withdrawal being finalized has not been proven.</li>
<li>MUST revert if the withdrawal was proven at a timestamp less than or equal to the creation
timestamp of the dispute game it was proven against, which would signal an unexpected proving
bug. Note that prevents withdrawals from being proven in the same block that a dispute game is
created.</li>
<li>MUST revert if the withdrawal being finalized has been proven less than
<a href="fault-proof/stage-one/optimism-portal.html#proof-maturity-delay">Proof Maturity Delay</a> seconds ago.</li>
<li>MUST revert if the withdrawal being finalized was proven against a game that does not have a
<a href="fault-proof/stage-one/./anchor-state-registry.html#valid-claim">Valid Claim</a>.</li>
</ul>
<h3 id="finalizewithdrawaltransaction"><a class="header" href="#finalizewithdrawaltransaction">finalizeWithdrawalTransaction</a></h3>
<p>Allows a user to <a href="fault-proof/stage-one/optimism-portal.html#finalized-withdrawal">finalize</a> a withdrawal transaction.</p>
<ul>
<li>MUST delegate to <code>finalizeWithdrawalTransactionExternalProof</code> with <code>msg.sender</code> as the proof
submitter.</li>
</ul>
<h3 id="donateeth"><a class="header" href="#donateeth">donateETH</a></h3>
<p>Allows any address to donate ETH to the contract without triggering a deposit to L2.</p>
<ul>
<li>MUST accept ETH payments via the payable modifier.</li>
<li>MUST not perform any state-changing operations.</li>
<li>MUST not trigger a deposit transaction to L2.</li>
</ul>
<h3 id="finalizewithdrawaltransactionexternalproof"><a class="header" href="#finalizewithdrawaltransactionexternalproof">finalizeWithdrawalTransactionExternalProof</a></h3>
<p>Allows a user to <a href="fault-proof/stage-one/optimism-portal.html#finalized-withdrawal">finalize</a> a withdrawal transaction using a proof submitted
by another address.</p>
<ul>
<li>MUST revert if the system is paused.</li>
<li>MUST revert if the function is called while a previous withdrawal is being executed.</li>
<li>MUST revert if the withdrawal target is an <a href="fault-proof/stage-one/optimism-portal.html#unsafe-target">Unsafe Target</a>.</li>
<li>MUST revert if the withdrawal being finalized does not pass <code>checkWithdrawal</code>.</li>
<li>MUST mark the withdrawal as finalized.</li>
<li>MUST unlock ETH from the ETHLockbox if the withdrawal includes an ETH value AND the OptimismPortal
has an ETHLockbox configured AND the ETHLockbox system feature is active.</li>
<li>MUST set the L2 Withdrawal Sender variable correctly.</li>
<li>MUST execute the withdrawal transaction by executing a contract call to the target address with
the data and ETH value specified within the withdrawal using AT LEAST the minimum amount of gas
specified by the withdrawal.</li>
<li>MUST unset the L2 Withdrawal Sender after the withdrawal call.</li>
<li>MUST emit a <code>WithdrawalFinalized</code> event with the withdrawal hash and success status.</li>
<li>MUST lock any unused ETH back into the ETHLockbox if the call to the target address fails AND the
OptimismPortal has an ETHLockbox configured AND the ETHLockbox system feature is active.</li>
<li>MUST revert if the withdrawal call fails and the transaction origin is the estimation address, to
help determine exact gas costs.</li>
</ul>
<h3 id="numproofsubmitters"><a class="header" href="#numproofsubmitters">numProofSubmitters</a></h3>
<p>Returns the number of proof submitters for a given withdrawal hash.</p>
<ul>
<li>MUST return the length of the proofSubmitters array for the specified withdrawal hash.</li>
<li>MUST NOT change state.</li>
</ul>
<h3 id="receive"><a class="header" href="#receive">receive</a></h3>
<p>Accepts ETH value and creates a deposit transaction to the sender's address on L2.</p>
<ul>
<li>MUST be payable and accept ETH.</li>
<li>MUST create a deposit transaction where the sender and target are the same address, refer to
<a href="fault-proof/stage-one/optimism-portal.html#deposittransaction">depositTransaction</a> for full specification of expected behavior.</li>
<li>MUST use the <a href="fault-proof/stage-one/optimism-portal.html#receive-default-gas-limit">receive default gas limit</a> as the gas limit.</li>
<li>MUST set contract creation flag to false.</li>
<li>MUST use empty data for the deposit.</li>
<li>MUST transform the sender address to its alias if the caller is a contract.</li>
<li>MUST emit a TransactionDeposited event with the appropriate parameters.</li>
</ul>
<h3 id="minimumgaslimit"><a class="header" href="#minimumgaslimit">minimumGasLimit</a></h3>
<p>Computes the minimum gas limit for a deposit transaction based on calldata size.</p>
<ul>
<li>MUST calculate the minimum gas limit using the formula: calldata_byte_count * 40 + 21000.</li>
</ul>
<h3 id="superchainconfig"><a class="header" href="#superchainconfig">superchainConfig</a></h3>
<p>Returns the <code>SuperchainConfig</code> contract address.</p>
<ul>
<li>MUST return the address of the <code>SuperchainConfig</code> contract stored in the <code>SystemConfig</code> contract
that was set during initialization.</li>
</ul>
<h3 id="disputegameblacklist"><a class="header" href="#disputegameblacklist">disputeGameBlacklist</a></h3>
<p><strong>Legacy Function</strong></p>
<p>Checks if a dispute game is blacklisted.</p>
<ul>
<li>MUST delegate to the blacklist of the <code>AnchorStateRegistry</code> contract that was set during initialization.</li>
<li>MUST return whether the given dispute game is blacklisted.</li>
</ul>
<h3 id="deposittransaction"><a class="header" href="#deposittransaction">depositTransaction</a></h3>
<p>Accepts deposits of ETH and data, and emits a TransactionDeposited event for use in
deriving deposit transactions. Note that if a deposit is made by a contract, its
address will be aliased when retrieved using <code>tx.origin</code> or <code>msg.sender</code>. Consider
using the CrossDomainMessenger contracts for a simpler developer experience.</p>
<ul>
<li>MUST lock any ETH value (msg.value) in the ETHLockbox contract if the OptimismPortal has an
ETHLockbox configured AND the ETHLockbox system feature is active.</li>
<li>MUST revert if the target address is not address(0) for contract creations.</li>
<li>MUST revert if the gas limit provided is below the <a href="fault-proof/stage-one/optimism-portal.html#minimum-gas-limit">minimum gas limit</a>.</li>
<li>MUST revert if the calldata is too large (&gt; 120,000 bytes).</li>
<li>MUST transform the sender address to its alias if the caller is a contract.</li>
<li>MUST apply resource metering to the gas limit parameter.</li>
<li>MUST emit a TransactionDeposited event with the from address, to address, deposit version, and
opaque data.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="precompiles"><a class="header" href="#precompiles">Precompiles</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/precompiles.html#overview">Overview</a></li>
<li><a href="protocol/precompiles.html#p256verify">P256VERIFY</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-21"><a class="header" href="#overview-21">Overview</a></h2>
<p><a href="protocol/../glossary.html#precompiled-contract-precompile">Precompiled contracts</a> exist on OP-Stack chains at
predefined addresses. They are similar to predeploys but are implemented as native code in the EVM as opposed to
bytecode. Precompiles are used for computationally expensive operations, that would be cost prohibitive to implement
in Solidity. Where possible predeploys are preferred, as precompiles must be implemented in every execution client.</p>
<p>OP-Stack chains contain the <a href="https://www.evm.codes/precompiled">standard Ethereum precompiles</a> as well as a small
number of additional precompiles. The following table lists each of the additional precompiles. The system version
indicates when the precompile was introduced.</p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Address</th><th>Introduced</th></tr></thead><tbody>
<tr><td>P256VERIFY</td><td>0x0000000000000000000000000000000000000100</td><td>Fjord</td></tr>
</tbody></table>
</div>
<h2 id="p256verify"><a class="header" href="#p256verify">P256VERIFY</a></h2>
<p>The <code>P256VERIFY</code> precompile performs signature verification for the secp256r1 elliptic curve. This curve has widespread
adoption. It's used by Passkeys, Apple Secure Enclave and many other systems.</p>
<p>It is specified as part of <a href="https://github.com/ethereum/RIPs/blob/master/RIPS/rip-7212.md">RIP-7212</a> and was added to
the OP-Stack protocol in the Fjord release. The op-geth implementation is
<a href="https://github.com/ethereum-optimism/op-geth/blob/optimism/core/vm/contracts.go#L1161-L1193">here</a>.</p>
<p>Address: <code>0x0000000000000000000000000000000000000100</code></p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="predeploys"><a class="header" href="#predeploys">Predeploys</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/predeploys.html#overview">Overview</a></li>
<li><a href="protocol/predeploys.html#legacymessagepasser">LegacyMessagePasser</a></li>
<li><a href="protocol/predeploys.html#l2tol1messagepasser">L2ToL1MessagePasser</a></li>
<li><a href="protocol/predeploys.html#deployerwhitelist">DeployerWhitelist</a></li>
<li><a href="protocol/predeploys.html#legacyerc20eth">LegacyERC20ETH</a></li>
<li><a href="protocol/predeploys.html#weth9">WETH9</a></li>
<li><a href="protocol/predeploys.html#l2crossdomainmessenger">L2CrossDomainMessenger</a></li>
<li><a href="protocol/predeploys.html#l2standardbridge">L2StandardBridge</a></li>
<li><a href="protocol/predeploys.html#l1blocknumber">L1BlockNumber</a></li>
<li><a href="protocol/predeploys.html#gaspriceoracle">GasPriceOracle</a></li>
<li><a href="protocol/predeploys.html#l1block">L1Block</a></li>
<li><a href="protocol/predeploys.html#proxyadmin">ProxyAdmin</a></li>
<li><a href="protocol/predeploys.html#sequencerfeevault">SequencerFeeVault</a></li>
<li><a href="protocol/predeploys.html#optimismmintableerc20factory">OptimismMintableERC20Factory</a></li>
<li><a href="protocol/predeploys.html#optimismmintableerc721factory">OptimismMintableERC721Factory</a></li>
<li><a href="protocol/predeploys.html#basefeevault">BaseFeeVault</a></li>
<li><a href="protocol/predeploys.html#l1feevault">L1FeeVault</a></li>
<li><a href="protocol/predeploys.html#schemaregistry">SchemaRegistry</a></li>
<li><a href="protocol/predeploys.html#eas">EAS</a></li>
<li><a href="protocol/predeploys.html#beacon-block-root">Beacon Block Root</a></li>
<li><a href="protocol/predeploys.html#governance-token">Governance Token</a></li>
<li><a href="protocol/predeploys.html#operator-fee-vault">Operator Fee Vault</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-22"><a class="header" href="#overview-22">Overview</a></h2>
<p><a href="protocol/../glossary.html#predeployed-contract-predeploy">Predeployed smart contracts</a> exist on Optimism
at predetermined addresses in the genesis state. They are similar to precompiles but instead run
directly in the EVM instead of running native code outside of the EVM.</p>
<p>Predeploys are used instead of precompiles to make it easier for multiclient
implementations as well as allowing for more integration with hardhat/foundry
network forking.</p>
<p>Predeploy addresses exist in a prefixed namespace <code>0x4200000000000000000000000000000000000xxx</code>.
Proxies are set at the first 2048 addresses in the namespace, except for the addresses reserved for the
<code>GovernanceToken</code> and <code>WETH</code> predeploys.</p>
<p>The <code>LegacyERC20ETH</code> predeploy lives at a special address <code>0xDeadDeAddeAddEAddeadDEaDDEAdDeaDDeAD0000</code>
and there is no proxy deployed at that account.</p>
<p>The following table includes each of the predeploys. The system version
indicates when the predeploy was introduced. The possible values are <code>Legacy</code>
or <code>Bedrock</code> or <code>Canyon</code>. Deprecated contracts should not be used.</p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Address</th><th>Introduced</th><th>Deprecated</th><th>Proxied</th></tr></thead><tbody>
<tr><td>LegacyMessagePasser</td><td>0x4200000000000000000000000000000000000000</td><td>Legacy</td><td>Yes</td><td>Yes</td></tr>
<tr><td>DeployerWhitelist</td><td>0x4200000000000000000000000000000000000002</td><td>Legacy</td><td>Yes</td><td>Yes</td></tr>
<tr><td>LegacyERC20ETH</td><td>0xDeadDeAddeAddEAddeadDEaDDEAdDeaDDeAD0000</td><td>Legacy</td><td>Yes</td><td>No</td></tr>
<tr><td>WETH9</td><td>0x4200000000000000000000000000000000000006</td><td>Legacy</td><td>No</td><td>No</td></tr>
<tr><td>L2CrossDomainMessenger</td><td>0x4200000000000000000000000000000000000007</td><td>Legacy</td><td>No</td><td>Yes</td></tr>
<tr><td>L2StandardBridge</td><td>0x4200000000000000000000000000000000000010</td><td>Legacy</td><td>No</td><td>Yes</td></tr>
<tr><td>SequencerFeeVault</td><td>0x4200000000000000000000000000000000000011</td><td>Legacy</td><td>No</td><td>Yes</td></tr>
<tr><td>OptimismMintableERC20Factory</td><td>0x4200000000000000000000000000000000000012</td><td>Legacy</td><td>No</td><td>Yes</td></tr>
<tr><td>L1BlockNumber</td><td>0x4200000000000000000000000000000000000013</td><td>Legacy</td><td>Yes</td><td>Yes</td></tr>
<tr><td>GasPriceOracle</td><td>0x420000000000000000000000000000000000000F</td><td>Legacy</td><td>No</td><td>Yes</td></tr>
<tr><td>GovernanceToken</td><td>0x4200000000000000000000000000000000000042</td><td>Legacy</td><td>No</td><td>No</td></tr>
<tr><td>L1Block</td><td>0x4200000000000000000000000000000000000015</td><td>Bedrock</td><td>No</td><td>Yes</td></tr>
<tr><td>L2ToL1MessagePasser</td><td>0x4200000000000000000000000000000000000016</td><td>Bedrock</td><td>No</td><td>Yes</td></tr>
<tr><td>L2ERC721Bridge</td><td>0x4200000000000000000000000000000000000014</td><td>Legacy</td><td>No</td><td>Yes</td></tr>
<tr><td>OptimismMintableERC721Factory</td><td>0x4200000000000000000000000000000000000017</td><td>Bedrock</td><td>No</td><td>Yes</td></tr>
<tr><td>ProxyAdmin</td><td>0x4200000000000000000000000000000000000018</td><td>Bedrock</td><td>No</td><td>Yes</td></tr>
<tr><td>BaseFeeVault</td><td>0x4200000000000000000000000000000000000019</td><td>Bedrock</td><td>No</td><td>Yes</td></tr>
<tr><td>L1FeeVault</td><td>0x420000000000000000000000000000000000001a</td><td>Bedrock</td><td>No</td><td>Yes</td></tr>
<tr><td>SchemaRegistry</td><td>0x4200000000000000000000000000000000000020</td><td>Bedrock</td><td>No</td><td>Yes</td></tr>
<tr><td>EAS</td><td>0x4200000000000000000000000000000000000021</td><td>Bedrock</td><td>No</td><td>Yes</td></tr>
<tr><td>BeaconBlockRoot</td><td>0x000F3df6D732807Ef1319fB7B8bB8522d0Beac02</td><td>Ecotone</td><td>No</td><td>No</td></tr>
<tr><td>OperatorFeeVault</td><td>0x420000000000000000000000000000000000001B</td><td>Isthmus</td><td>No</td><td>Yes</td></tr>
</tbody></table>
</div>
<h2 id="legacymessagepasser"><a class="header" href="#legacymessagepasser">LegacyMessagePasser</a></h2>
<p><a href="https://github.com/ethereum-optimism/optimism/blob/develop/packages/contracts-bedrock/src/legacy/LegacyMessagePasser.sol">Implementation</a></p>
<p>Address: <code>0x4200000000000000000000000000000000000000</code></p>
<p>The <code>LegacyMessagePasser</code> contract stores commitments to withdrawal
transactions before the Bedrock upgrade. A merkle proof to a particular
storage slot that commits to the withdrawal transaction is used as part
of the withdrawing transaction on L1. The expected account that includes
the storage slot is hardcoded into the L1 logic. After the bedrock upgrade,
the <code>L2ToL1MessagePasser</code> is used instead. Finalizing withdrawals from this
contract will no longer be supported after the Bedrock and is only left
to allow for alternative bridges that may depend on it. This contract does
not forward calls to the <code>L2ToL1MessagePasser</code> and calling it is considered
a no-op in context of doing withdrawals through the <code>CrossDomainMessenger</code>
system.</p>
<p>Any pending withdrawals that have not been finalized are migrated to the
<code>L2ToL1MessagePasser</code> as part of the upgrade so that they can still be
finalized.</p>
<h2 id="l2tol1messagepasser"><a class="header" href="#l2tol1messagepasser">L2ToL1MessagePasser</a></h2>
<p><a href="https://github.com/ethereum-optimism/optimism/blob/develop/packages/contracts-bedrock/src/L2/L2ToL1MessagePasser.sol">Implementation</a></p>
<p>Address: <code>0x4200000000000000000000000000000000000016</code></p>
<p>The <code>L2ToL1MessagePasser</code> stores commitments to withdrawal transactions.
When a user is submitting the withdrawing transaction on L1, they provide a
proof that the transaction that they withdrew on L2 is in the <code>sentMessages</code>
mapping of this contract.</p>
<p>Any withdrawn ETH accumulates into this contract on L2 and can be
permissionlessly removed from the L2 supply by calling the <code>burn()</code> function.</p>
<h2 id="deployerwhitelist"><a class="header" href="#deployerwhitelist">DeployerWhitelist</a></h2>
<p><a href="https://github.com/ethereum-optimism/optimism/blob/develop/packages/contracts-bedrock/src/legacy/DeployerWhitelist.sol">Implementation</a></p>
<p>Address: <code>0x4200000000000000000000000000000000000002</code></p>
<p>The <code>DeployerWhitelist</code> is a predeploy that was used to provide additional safety
during the initial phases of Optimism.
It previously defined the accounts that are allowed to deploy contracts to the network.</p>
<p>Arbitrary contract deployment was subsequently enabled and it is not possible to turn
off. In the legacy system, this contract was hooked into <code>CREATE</code> and
<code>CREATE2</code> to ensure that the deployer was allowlisted.</p>
<p>In the Bedrock system, this contract will no longer be used as part of the
<code>CREATE</code> codepath.</p>
<p>This contract is deprecated and its usage should be avoided.</p>
<h2 id="legacyerc20eth"><a class="header" href="#legacyerc20eth">LegacyERC20ETH</a></h2>
<p><a href="https://github.com/ethereum-optimism/optimism/blob/a4524ac152b4c9e8eb80beadc9cd772b96243aa2/packages/contracts-bedrock/src/legacy/LegacyERC20ETH.sol">Implementation</a></p>
<p>Address: <code>0xDeadDeAddeAddEAddeadDEaDDEAdDeaDDeAD0000</code></p>
<p>The <code>LegacyERC20ETH</code> predeploy represents all ether in the system before the
Bedrock upgrade. All ETH was represented as an ERC20 token and users could opt
into the ERC20 interface or the native ETH interface.</p>
<p>The upgrade to Bedrock migrates all ether out of this contract and moves it to
its native representation. All of the stateful methods in this contract will
revert after the Bedrock upgrade.</p>
<p>This contract is deprecated and its usage should be avoided.</p>
<h2 id="weth9"><a class="header" href="#weth9">WETH9</a></h2>
<p><a href="https://github.com/ethereum-optimism/optimism/blob/2b1c99b39744579cc226077d356ae9e5f162db4a/packages/contracts-bedrock/src/vendor/WETH9.sol">Implementation</a></p>
<p>Address: <code>0x4200000000000000000000000000000000000006</code></p>
<p><code>WETH9</code> is the standard implementation of Wrapped Ether on Optimism. It is a
commonly used contract and is placed as a predeploy so that it is at a
deterministic address across Optimism based networks.</p>
<h2 id="l2crossdomainmessenger"><a class="header" href="#l2crossdomainmessenger">L2CrossDomainMessenger</a></h2>
<p><a href="https://github.com/ethereum-optimism/optimism/blob/develop/packages/contracts-bedrock/src/L2/L2CrossDomainMessenger.sol">Implementation</a></p>
<p>Address: <code>0x4200000000000000000000000000000000000007</code></p>
<p>The <code>L2CrossDomainMessenger</code> gives a higher level API for sending cross domain
messages compared to directly calling the <code>L2ToL1MessagePasser</code>.
It maintains a mapping of L1 messages that have been relayed to L2
to prevent replay attacks and also allows for replayability if the L1 to L2
transaction reverts on L2.</p>
<p>Any calls to the <code>L1CrossDomainMessenger</code> on L1 are serialized such that they
go through the <code>L2CrossDomainMessenger</code> on L2.</p>
<p>The <code>relayMessage</code> function executes a transaction from the remote domain while
the <code>sendMessage</code> function sends a transaction to be executed on the remote
domain through the remote domain's <code>relayMessage</code> function.</p>
<h2 id="l2standardbridge"><a class="header" href="#l2standardbridge">L2StandardBridge</a></h2>
<p><a href="https://github.com/ethereum-optimism/optimism/blob/develop/packages/contracts-bedrock/src/L2/L2StandardBridge.sol">Implementation</a></p>
<p>Address: <code>0x4200000000000000000000000000000000000010</code></p>
<p>The <code>L2StandardBridge</code> is a higher level API built on top of the
<code>L2CrossDomainMessenger</code> that gives a standard interface for sending ETH or
ERC20 tokens across domains.</p>
<p>To deposit a token from L1 to L2, the <code>L1StandardBridge</code> locks the token and
sends a cross domain message to the <code>L2StandardBridge</code> which then mints the
token to the specified account.</p>
<p>To withdraw a token from L2 to L1, the user will burn the token on L2 and the
<code>L2StandardBridge</code> will send a message to the <code>L1StandardBridge</code> which will
unlock the underlying token and transfer it to the specified account.</p>
<p>The <code>OptimismMintableERC20Factory</code> can be used to create an ERC20 token contract
on a remote domain that maps to an ERC20 token contract on the local domain
where tokens can be deposited to the remote domain. It deploys an
<code>OptimismMintableERC20</code> which has the interface that works with the
<code>StandardBridge</code>.</p>
<p>This contract can also be deployed on L1 to allow for L2 native tokens to be
withdrawn to L1.</p>
<h2 id="l1blocknumber"><a class="header" href="#l1blocknumber">L1BlockNumber</a></h2>
<p><a href="https://github.com/ethereum-optimism/optimism/blob/develop/packages/contracts-bedrock/src/legacy/L1BlockNumber.sol">Implementation</a></p>
<p>Address: <code>0x4200000000000000000000000000000000000013</code></p>
<p>The <code>L1BlockNumber</code> returns the last known L1 block number. This contract was
introduced in the legacy system and should be backwards compatible by calling
out to the <code>L1Block</code> contract under the hood.</p>
<p>It is recommended to use the <code>L1Block</code> contract for getting information about
L1 on L2.</p>
<h2 id="gaspriceoracle"><a class="header" href="#gaspriceoracle">GasPriceOracle</a></h2>
<p><a href="https://github.com/ethereum-optimism/optimism/blob/develop/packages/contracts-bedrock/src/L2/GasPriceOracle.sol">Implementation</a></p>
<p>Address: <code>0x420000000000000000000000000000000000000F</code></p>
<p>In the legacy system, the <code>GasPriceOracle</code> was a permissioned contract
that was pushed the L1 base fee and the L2 gas price by an offchain actor.
The offchain actor observes the L1 blockheaders to get the
L1 base fee as well as the gas usage on L2 to compute what the L2 gas price
should be based on a congestion control algorithm.</p>
<p>After Bedrock, the <code>GasPriceOracle</code> is no longer a permissioned contract
and only exists to preserve the API for offchain gas estimation. The
function <code>getL1Fee(bytes)</code> accepts an unsigned RLP transaction and will return
the L1 portion of the fee. This fee pays for using L1 as a data availability
layer and should be added to the L2 portion of the fee, which pays for
execution, to compute the total transaction fee.</p>
<p>The values used to compute the L1 portion of the fee prior to the Ecotone upgrade are:</p>
<ul>
<li>scalar</li>
<li>overhead</li>
<li>decimals</li>
</ul>
<p>After the Bedrock upgrade, these values are instead managed by the
<code>SystemConfig</code> contract on L1. The <code>scalar</code> and <code>overhead</code> values
are sent to the <code>L1Block</code> contract each block and the <code>decimals</code> value
has been hardcoded to 6.</p>
<p>Following the Ecotone upgrade, the values used for L1 fee computation are:</p>
<ul>
<li>baseFeeScalar</li>
<li>blobBaseFeeScalar</li>
<li>decimals</li>
</ul>
<p>These new scalar values are managed by the <code>SystemConfig</code> contract on the L1 by introducing a
backwards compatible <a href="protocol/system-config.html#post-ecotone-parameters">versioned encoding scheme</a> of its <code>scalars</code> storage
slot. The <code>decimals</code> remains hardcoded to 6, and the <code>overhead</code> value is ignored.</p>
<h2 id="l1block"><a class="header" href="#l1block">L1Block</a></h2>
<p><a href="https://github.com/ethereum-optimism/optimism/blob/develop/packages/contracts-bedrock/src/L2/L1Block.sol">Implementation</a></p>
<p>Address: <code>0x4200000000000000000000000000000000000015</code></p>
<p>The <a href="protocol/../glossary.html#l1-attributes-predeployed-contract">L1Block</a> was introduced in Bedrock and is responsible for
maintaining L1 context in L2. This allows for L1 state to be accessed in L2.</p>
<h2 id="proxyadmin"><a class="header" href="#proxyadmin">ProxyAdmin</a></h2>
<p><a href="https://github.com/ethereum-optimism/optimism/blob/develop/packages/contracts-bedrock/src/universal/ProxyAdmin.sol">ProxyAdmin</a>
Address: <code>0x4200000000000000000000000000000000000018</code></p>
<p>The <code>ProxyAdmin</code> is the owner of all of the proxy contracts set at the
predeploys. It is itself behind a proxy. The owner of the <code>ProxyAdmin</code> will
have the ability to upgrade any of the other predeploy contracts.</p>
<h2 id="sequencerfeevault"><a class="header" href="#sequencerfeevault">SequencerFeeVault</a></h2>
<p><a href="https://github.com/ethereum-optimism/optimism/blob/develop/packages/contracts-bedrock/src/L2/SequencerFeeVault.sol">Implementation</a></p>
<p>Address: <code>0x4200000000000000000000000000000000000011</code></p>
<p>The <code>SequencerFeeVault</code> accumulates any transaction priority fee and is the value of
<code>block.coinbase</code>.
When enough fees accumulate in this account, they can be withdrawn to an immutable L1 address.</p>
<p>To change the L1 address that fees are withdrawn to, the contract must be
upgraded by changing its proxy's implementation key.</p>
<h2 id="optimismmintableerc20factory"><a class="header" href="#optimismmintableerc20factory">OptimismMintableERC20Factory</a></h2>
<p><a href="https://github.com/ethereum-optimism/optimism/blob/develop/packages/contracts-bedrock/src/universal/OptimismMintableERC20Factory.sol">Implementation</a></p>
<p>Address: <code>0x4200000000000000000000000000000000000012</code></p>
<p>The <code>OptimismMintableERC20Factory</code> is responsible for creating ERC20 contracts on L2 that can be
used for depositing native L1 tokens into. These ERC20 contracts can be created permissionlessly
and implement the interface required by the <code>StandardBridge</code> to just work with deposits and withdrawals.</p>
<p>Each ERC20 contract that is created by the <code>OptimismMintableERC20Factory</code> allows for the <code>L2StandardBridge</code> to mint
and burn tokens, depending on if the user is depositing from L1 to L2 or withdrawing from L2 to L1.</p>
<h2 id="optimismmintableerc721factory"><a class="header" href="#optimismmintableerc721factory">OptimismMintableERC721Factory</a></h2>
<p><a href="https://github.com/ethereum-optimism/optimism/blob/develop/packages/contracts-bedrock/src/L2/OptimismMintableERC721Factory.sol">Implementation</a></p>
<p>Address: <code>0x4200000000000000000000000000000000000017</code></p>
<p>The <code>OptimismMintableERC721Factory</code> is responsible for creating ERC721 contracts on L2 that can be used for
depositing native L1 NFTs into.</p>
<h2 id="basefeevault"><a class="header" href="#basefeevault">BaseFeeVault</a></h2>
<p><a href="https://github.com/ethereum-optimism/optimism/blob/develop/packages/contracts-bedrock/src/L2/BaseFeeVault.sol">Implementation</a></p>
<p>Address: <code>0x4200000000000000000000000000000000000019</code></p>
<p>The <code>BaseFeeVault</code> predeploy receives the base fees on L2. The base fee is not
burnt on L2 like it is on L1. Once the contract has received a certain amount
of fees, the ETH can be withdrawn to an immutable address on
L1.</p>
<h2 id="l1feevault"><a class="header" href="#l1feevault">L1FeeVault</a></h2>
<p><a href="https://github.com/ethereum-optimism/optimism/blob/develop/packages/contracts-bedrock/src/L2/L1FeeVault.sol">Implementation</a></p>
<p>Address: <code>0x420000000000000000000000000000000000001a</code></p>
<p>The <code>L1FeeVault</code> predeploy receives the L1 portion of the transaction fees.
Once the contract has received a certain amount of fees, the ETH can be
withdrawn to an immutable address on L1.</p>
<h2 id="schemaregistry"><a class="header" href="#schemaregistry">SchemaRegistry</a></h2>
<p><a href="https://github.com/ethereum-optimism/optimism/blob/develop/packages/contracts-bedrock/src/EAS/SchemaRegistry.sol">Implementation</a></p>
<p>Address: <code>0x4200000000000000000000000000000000000020</code></p>
<p>The <code>SchemaRegistry</code> predeploy implements the global attestation schemas for the <code>Ethereum Attestation Service</code>
protocol.</p>
<h2 id="eas"><a class="header" href="#eas">EAS</a></h2>
<p><a href="https://github.com/ethereum-optimism/optimism/tree/develop/packages/contracts-bedrock/src/vendor/eas">Implementation</a></p>
<p>Address: <code>0x4200000000000000000000000000000000000021</code></p>
<p>The <code>EAS</code> predeploy implements the <code>Ethereum Attestation Service</code> protocol.</p>
<h2 id="beacon-block-root"><a class="header" href="#beacon-block-root">Beacon Block Root</a></h2>
<p>Address: <code>0x000F3df6D732807Ef1319fB7B8bB8522d0Beac02</code></p>
<p>The <code>BeaconBlockRoot</code> predeploy provides access to the L1 beacon block roots. This was added during the
Ecotone network upgrade and is specified in <a href="https://eips.ethereum.org/EIPS/eip-4788">EIP-4788</a>.</p>
<h2 id="governance-token"><a class="header" href="#governance-token">Governance Token</a></h2>
<p>Address: 0x4200000000000000000000000000000000000042</p>
<p>See <a href="https://specs.optimism.io/governance/gov-token.html">Governance Token specs</a>.</p>
<h2 id="operator-fee-vault"><a class="header" href="#operator-fee-vault">Operator Fee Vault</a></h2>
<p><a href="https://github.com/ethereum-optimism/optimism/blob/develop/packages/contracts-bedrock/src/L2/OperatorFeeVault.sol">Implementation</a></p>
<p>Address: <code>0x420000000000000000000000000000000000001B</code></p>
<p>See <a href="https://specs.optimism.io/protocol/isthmus/predeploys.html#operatorfeevault">Operator Fee Vault</a> spec.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="preinstalls"><a class="header" href="#preinstalls">Preinstalls</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/preinstalls.html#overview">Overview</a></li>
<li><a href="protocol/preinstalls.html#safe">Safe</a></li>
<li><a href="protocol/preinstalls.html#safel2">SafeL2</a></li>
<li><a href="protocol/preinstalls.html#multisend">MultiSend</a></li>
<li><a href="protocol/preinstalls.html#multisendcallonly">MultiSendCallOnly</a></li>
<li><a href="protocol/preinstalls.html#safesingletonfactory">SafeSingletonFactory</a></li>
<li><a href="protocol/preinstalls.html#multicall3">Multicall3</a></li>
<li><a href="protocol/preinstalls.html#create2deployer">Create2Deployer</a></li>
<li><a href="protocol/preinstalls.html#createx">CreateX</a></li>
<li><a href="protocol/preinstalls.html#arachnids-deterministic-deployment-proxy">Arachnid's Deterministic Deployment Proxy</a></li>
<li><a href="protocol/preinstalls.html#permit2">Permit2</a></li>
<li><a href="protocol/preinstalls.html#erc-4337-v060-entrypoint">ERC-4337 v0.6.0 EntryPoint</a></li>
<li><a href="protocol/preinstalls.html#erc-4337-v060-sendercreator">ERC-4337 v0.6.0 SenderCreator</a></li>
<li><a href="protocol/preinstalls.html#erc-4337-v070-entrypoint">ERC-4337 v0.7.0 EntryPoint</a></li>
<li><a href="protocol/preinstalls.html#erc-4337-v070-sendercreator">ERC-4337 v0.7.0 SenderCreator</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-23"><a class="header" href="#overview-23">Overview</a></h2>
<p><a href="protocol/../glossary.html#preinstalled-contract-preinstall">Preinstalled smart contracts</a> exist on Optimism
at predetermined addresses in the genesis state. They are similar to precompiles but instead run
directly in the EVM instead of running native code outside of the EVM and are developed by third
parties unaffiliated with the Optimism Collective.</p>
<p>These preinstalls are commonly deployed smart contracts that are being placed at genesis for convenience.
It's important to note that these contracts do not have the same security guarantees
as <a href="protocol/../glossary.html#predeployed-contract-predeploy">Predeployed smart contracts</a>.</p>
<p>The following table includes each of the preinstalls.</p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Address</th></tr></thead><tbody>
<tr><td>Safe</td><td>0x69f4D1788e39c87893C980c06EdF4b7f686e2938</td></tr>
<tr><td>SafeL2</td><td>0xfb1bffC9d739B8D520DaF37dF666da4C687191EA</td></tr>
<tr><td>MultiSend</td><td>0x998739BFdAAdde7C933B942a68053933098f9EDa</td></tr>
<tr><td>MultiSendCallOnly</td><td>0xA1dabEF33b3B82c7814B6D82A79e50F4AC44102B</td></tr>
<tr><td>SafeSingletonFactory</td><td>0x914d7Fec6aaC8cd542e72Bca78B30650d45643d7</td></tr>
<tr><td>Multicall3</td><td>0xcA11bde05977b3631167028862bE2a173976CA11</td></tr>
<tr><td>Create2Deployer</td><td>0x13b0D85CcB8bf860b6b79AF3029fCA081AE9beF2</td></tr>
<tr><td>CreateX</td><td>0xba5Ed099633D3B313e4D5F7bdc1305d3c28ba5Ed</td></tr>
<tr><td>Arachnid's Deterministic Deployment Proxy</td><td>0x4e59b44847b379578588920cA78FbF26c0B4956C</td></tr>
<tr><td>Permit2</td><td>0x000000000022D473030F116dDEE9F6B43aC78BA3</td></tr>
<tr><td>ERC-4337 v0.6.0 EntryPoint</td><td>0x5FF137D4b0FDCD49DcA30c7CF57E578a026d2789</td></tr>
<tr><td>ERC-4337 v0.6.0 SenderCreator</td><td>0x7fc98430eaedbb6070b35b39d798725049088348</td></tr>
<tr><td>ERC-4337 v0.7.0 EntryPoint</td><td>0x0000000071727De22E5E9d8BAf0edAc6f37da032</td></tr>
<tr><td>ERC-4337 v0.7.0 SenderCreator</td><td>0xEFC2c1444eBCC4Db75e7613d20C6a62fF67A167C</td></tr>
</tbody></table>
</div>
<h2 id="safe"><a class="header" href="#safe">Safe</a></h2>
<p><a href="https://github.com/safe-global/safe-contracts/blob/v1.3.0/contracts/GnosisSafe.sol">Implementation</a></p>
<p>Address: <code>0x69f4D1788e39c87893C980c06EdF4b7f686e2938</code></p>
<p>A multisignature wallet with support for confirmations using signed messages based on ERC191.
Differs from <a href="protocol/preinstalls.html#safel2">SafeL2</a> by not emitting events to save gas.</p>
<h2 id="safel2"><a class="header" href="#safel2">SafeL2</a></h2>
<p><a href="https://github.com/safe-global/safe-contracts/blob/v1.3.0/contracts/GnosisSafeL2.sol">Implementation</a></p>
<p>Address: <code>0xfb1bffC9d739B8D520DaF37dF666da4C687191EA</code></p>
<p>A multisignature wallet with support for confirmations using signed messages based on ERC191.
Differs from <a href="protocol/preinstalls.html#safe">Safe</a> by emitting events.</p>
<h2 id="multisend"><a class="header" href="#multisend">MultiSend</a></h2>
<p><a href="https://github.com/safe-global/safe-contracts/blob/v1.3.0/contracts/libraries/MultiSend.sol">Implementation</a></p>
<p>Address: <code>0x998739BFdAAdde7C933B942a68053933098f9EDa</code></p>
<p>Allows to batch multiple transactions into one.</p>
<h2 id="multisendcallonly"><a class="header" href="#multisendcallonly">MultiSendCallOnly</a></h2>
<p><a href="https://github.com/safe-global/safe-contracts/blob/v1.3.0/contracts/libraries/MultiSendCallOnly.sol">Implementation</a></p>
<p>Address: <code>0xA1dabEF33b3B82c7814B6D82A79e50F4AC44102B</code></p>
<p>Allows to batch multiple transactions into one, but only calls.</p>
<h2 id="safesingletonfactory"><a class="header" href="#safesingletonfactory">SafeSingletonFactory</a></h2>
<p><a href="https://github.com/safe-global/safe-singleton-factory/blob/v1.0.17/source/deterministic-deployment-proxy.yul">Implementation</a></p>
<p>Address: <code>0x914d7Fec6aaC8cd542e72Bca78B30650d45643d7</code></p>
<p>Singleton factory used by Safe-related contracts based on
<a href="protocol/preinstalls.html#arachnids-deterministic-deployment-proxy">Arachnid's Deterministic Deployment Proxy</a>.</p>
<p>The original library used a pre-signed transaction without a chain ID to allow deployment on different chains.
Some chains do not allow such transactions to be submitted; therefore, this contract will provide the same factory
that can be deployed via a pre-signed transaction that includes the chain ID. The key that is used to sign is
controlled by the Safe team.</p>
<h2 id="multicall3"><a class="header" href="#multicall3">Multicall3</a></h2>
<p><a href="https://github.com/mds1/multicall/blob/v3.1.0/src/Multicall3.sol">Implementation</a></p>
<p>Address: <code>0xcA11bde05977b3631167028862bE2a173976CA11</code></p>
<p><code>Multicall3</code> has two main use cases:</p>
<ul>
<li>Aggregate results from multiple contract reads into a single JSON-RPC request.</li>
<li>Execute multiple state-changing calls in a single transaction.</li>
</ul>
<h2 id="create2deployer"><a class="header" href="#create2deployer">Create2Deployer</a></h2>
<p><a href="https://github.com/mdehoog/create2deployer/blob/69b9a8e112b15f9257ce8c62b70a09914e7be29c/contracts/Create2Deployer.sol">Implementation</a></p>
<p>The <code>create2Deployer</code> is a nice Solidity wrapper around the CREATE2 opcode. It provides the following ABI.</p>
<pre><code class="language-solidity">    /**
     * @dev Deploys a contract using `CREATE2`. The address where the
     * contract will be deployed can be known in advance via {computeAddress}.
     *
     * The bytecode for a contract can be obtained from Solidity with
     * `type(contractName).creationCode`.
     *
     * Requirements:
     * - `bytecode` must not be empty.
     * - `salt` must have not been used for `bytecode` already.
     * - the factory must have a balance of at least `value`.
     * - if `value` is non-zero, `bytecode` must have a `payable` constructor.
     */
    function deploy(uint256 value, bytes32 salt, bytes memory code) public;
    /**
     * @dev Deployment of the {ERC1820Implementer}.
     * Further information: https://eips.ethereum.org/EIPS/eip-1820
     */
    function deployERC1820Implementer(uint256 value, bytes32 salt);
    /**
     * @dev Returns the address where a contract will be stored if deployed via {deploy}.
     * Any change in the `bytecodeHash` or `salt` will result in a new destination address.
     */
    function computeAddress(bytes32 salt, bytes32 codeHash) public view returns (address);
    /**
     * @dev Returns the address where a contract will be stored if deployed via {deploy} from a
     * contract located at `deployer`. If `deployer` is this contract's address, returns the
     * same value as {computeAddress}.
     */
    function computeAddressWithDeployer(
        bytes32 salt,
        bytes32 codeHash,
        address deployer
    ) public pure returns (address);
</code></pre>
<p>Address: <code>0x13b0D85CcB8bf860b6b79AF3029fCA081AE9beF2</code></p>
<p>When Canyon activates, the contract code at <code>0x13b0D85CcB8bf860b6b79AF3029fCA081AE9beF2</code> is set to
<code>0x6080604052600436106100435760003560e01c8063076c37b21461004f578063481286e61461007157806356299481146100ba57806366cfa057146100da57600080fd5b3661004a57005b600080fd5b34801561005b57600080fd5b5061006f61006a366004610327565b6100fa565b005b34801561007d57600080fd5b5061009161008c366004610327565b61014a565b60405173ffffffffffffffffffffffffffffffffffffffff909116815260200160405180910390f35b3480156100c657600080fd5b506100916100d5366004610349565b61015d565b3480156100e657600080fd5b5061006f6100f53660046103ca565b610172565b61014582826040518060200161010f9061031a565b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe082820381018352601f90910116604052610183565b505050565b600061015683836102e7565b9392505050565b600061016a8484846102f0565b949350505050565b61017d838383610183565b50505050565b6000834710156101f4576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601d60248201527f437265617465323a20696e73756666696369656e742062616c616e636500000060448201526064015b60405180910390fd5b815160000361025f576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820181905260248201527f437265617465323a2062797465636f6465206c656e677468206973207a65726f60448201526064016101eb565b8282516020840186f5905073ffffffffffffffffffffffffffffffffffffffff8116610156576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601960248201527f437265617465323a204661696c6564206f6e206465706c6f790000000000000060448201526064016101eb565b60006101568383305b6000604051836040820152846020820152828152600b8101905060ff815360559020949350505050565b61014e806104ad83390190565b6000806040838503121561033a57600080fd5b50508035926020909101359150565b60008060006060848603121561035e57600080fd5b8335925060208401359150604084013573ffffffffffffffffffffffffffffffffffffffff8116811461039057600080fd5b809150509250925092565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6000806000606084860312156103df57600080fd5b8335925060208401359150604084013567ffffffffffffffff8082111561040557600080fd5b818601915086601f83011261041957600080fd5b81358181111561042b5761042b61039b565b604051601f82017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0908116603f011681019083821181831017156104715761047161039b565b8160405282815289602084870101111561048a57600080fd5b826020860160208301376000602084830101528095505050505050925092509256fe608060405234801561001057600080fd5b5061012e806100206000396000f3fe6080604052348015600f57600080fd5b506004361060285760003560e01c8063249cb3fa14602d575b600080fd5b603c603836600460b1565b604e565b60405190815260200160405180910390f35b60008281526020818152604080832073ffffffffffffffffffffffffffffffffffffffff8516845290915281205460ff16608857600060aa565b7fa2ef4600d742022d532d4747cb3547474667d6f13804902513b2ec01c848f4b45b9392505050565b6000806040838503121560c357600080fd5b82359150602083013573ffffffffffffffffffffffffffffffffffffffff8116811460ed57600080fd5b80915050925092905056fea26469706673582212205ffd4e6cede7d06a5daf93d48d0541fc68189eeb16608c1999a82063b666eb1164736f6c63430008130033a2646970667358221220fdc4a0fe96e3b21c108ca155438d37c9143fb01278a3c1d274948bad89c564ba64736f6c63430008130033</code>.</p>
<h2 id="createx"><a class="header" href="#createx">CreateX</a></h2>
<p><a href="https://github.com/pcaversaccio/createx/blob/main/src/CreateX.sol">Implementation</a></p>
<p>Address: <code>0xba5Ed099633D3B313e4D5F7bdc1305d3c28ba5Ed</code></p>
<p>CreateX introduces additional logic for deploying contracts using <code>CREATE</code>, <code>CREATE2</code> and <code>CREATE3</code>.
It adds <a href="https://github.com/pcaversaccio/createx#special-features">salt protection</a> for sender and chainID
and includes a set of helper functions.</p>
<p>The <code>keccak256</code> of the CreateX bytecode is <code>0xbd8a7ea8cfca7b4e5f5041d7d4b17bc317c5ce42cfbc42066a00cf26b43eb53f</code>.</p>
<h2 id="arachnids-deterministic-deployment-proxy"><a class="header" href="#arachnids-deterministic-deployment-proxy">Arachnid's Deterministic Deployment Proxy</a></h2>
<p><a href="https://github.com/Arachnid/deterministic-deployment-proxy/blob/v1.0.0/source/deterministic-deployment-proxy.yul">Implementation</a></p>
<p>Address: <code>0x4e59b44847b379578588920cA78FbF26c0B4956C</code></p>
<p>This contract can deploy other contracts with a deterministic address on any chain using <code>CREATE2</code>. The <code>CREATE2</code>
call will deploy a contract (like <code>CREATE</code> opcode) but instead of the address being
<code>keccak256(rlp([deployer_address, nonce]))</code> it instead uses the hash of the contract's bytecode and a salt.
This means that a given deployer address will deploy the
same code to the same address no matter when or where they issue the deployment. The deployer is deployed
with a one-time-use account, so no matter what chain the deployer is on, its address will always be the same. This
means the only variables in determining the address of your contract are its bytecode hash and the provided salt.</p>
<p>Between the use of <code>CREATE2</code> opcode and the one-time-use account for the deployer, this contracts ensures
that a given contract will exist at the exact same address on every chain, but without having to use the
same gas pricing or limits every time.</p>
<h2 id="permit2"><a class="header" href="#permit2">Permit2</a></h2>
<p><a href="https://github.com/Uniswap/permit2/blob/0x000000000022D473030F116dDEE9F6B43aC78BA3/src/Permit2.sol">Implementation</a></p>
<p>Address: <code>0x000000000022D473030F116dDEE9F6B43aC78BA3</code></p>
<p>Permit2 introduces a low-overhead, next-generation token approval/meta-tx system to make token approvals easier,
more secure, and more consistent across applications.</p>
<h2 id="erc-4337-v060-entrypoint"><a class="header" href="#erc-4337-v060-entrypoint">ERC-4337 v0.6.0 EntryPoint</a></h2>
<p><a href="https://github.com/eth-infinitism/account-abstraction/blob/v0.6.0/contracts/core/EntryPoint.sol">Implementation</a></p>
<p>Address: <code>0x5FF137D4b0FDCD49DcA30c7CF57E578a026d2789</code></p>
<p>This contract verifies and executes the bundles of ERC-4337 v0.6.0
<a href="https://www.erc4337.io/docs/understanding-ERC-4337/user-operation">UserOperations</a> sent to it.</p>
<h2 id="erc-4337-v060-sendercreator"><a class="header" href="#erc-4337-v060-sendercreator">ERC-4337 v0.6.0 SenderCreator</a></h2>
<p><a href="https://github.com/eth-infinitism/account-abstraction/blob/v0.6.0/contracts/core/SenderCreator.sol">Implementation</a></p>
<p>Address: <code>0x7fc98430eaedbb6070b35b39d798725049088348</code></p>
<p>Helper contract for <a href="protocol/preinstalls.html#erc-4337-v060-entrypoint">EntryPoint</a> v0.6.0, to call <code>userOp.initCode</code> from a "neutral" address,
which is explicitly not <code>EntryPoint</code> itself.</p>
<h2 id="erc-4337-v070-entrypoint"><a class="header" href="#erc-4337-v070-entrypoint">ERC-4337 v0.7.0 EntryPoint</a></h2>
<p><a href="https://github.com/eth-infinitism/account-abstraction/blob/v0.7.0/contracts/core/EntryPoint.sol">Implementation</a></p>
<p>Address: <code>0x0000000071727De22E5E9d8BAf0edAc6f37da032</code></p>
<p>This contract verifies and executes the bundles of ERC-4337 v0.7.0
<a href="https://www.erc4337.io/docs/understanding-ERC-4337/user-operation">UserOperations</a> sent to it.</p>
<h2 id="erc-4337-v070-sendercreator"><a class="header" href="#erc-4337-v070-sendercreator">ERC-4337 v0.7.0 SenderCreator</a></h2>
<p><a href="https://github.com/eth-infinitism/account-abstraction/blob/v0.7.0/contracts/core/SenderCreator.sol">Implementation</a></p>
<p>Address: <code>0xEFC2c1444eBCC4Db75e7613d20C6a62fF67A167C</code></p>
<p>Helper contract for <a href="protocol/preinstalls.html#erc-4337-v070-entrypoint">EntryPoint</a> v0.7.0, to call <code>userOp.initCode</code> from a "neutral" address,
which is explicitly not <code>EntryPoint</code> itself.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="superchain-configuration"><a class="header" href="#superchain-configuration">Superchain Configuration</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/superchain-config.html#overview">Overview</a></li>
<li><a href="protocol/superchain-config.html#configuration-data-structure">Configuration Data Structure</a>
<ul>
<li><a href="protocol/superchain-config.html#superchaindefinition">SuperchainDefinition</a></li>
<li><a href="protocol/superchain-config.html#hardforks">Hardforks</a></li>
<li><a href="protocol/superchain-config.html#superchainl1">SuperchainL1</a></li>
</ul>
</li>
<li><a href="protocol/superchain-config.html#invariants">Invariants</a>
<ul>
<li><a href="protocol/superchain-config.html#isupc-001-the-guardian-and-pause-deputy-must-be-able-to-trigger-the-pause-mechanism">iSUPC-001: The Guardian and Pause Deputy must be able to trigger the Pause Mechanism</a>
<ul>
<li><a href="protocol/superchain-config.html#impact">Impact</a></li>
</ul>
</li>
<li><a href="protocol/superchain-config.html#isupc-002-the-guardian-must-be-able-to-reset-or-undo-the-pause-mechanism">iSUPC-002: The Guardian must be able to reset or undo the Pause Mechanism</a>
<ul>
<li><a href="protocol/superchain-config.html#impact-1">Impact</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="protocol/superchain-config.html#function-specification">Function Specification</a>
<ul>
<li><a href="protocol/superchain-config.html#initialize">initialize</a></li>
<li><a href="protocol/superchain-config.html#upgrade">upgrade</a></li>
<li><a href="protocol/superchain-config.html#guardian">guardian</a></li>
<li><a href="protocol/superchain-config.html#pauseexpiry">pauseExpiry</a></li>
<li><a href="protocol/superchain-config.html#pause">pause</a></li>
<li><a href="protocol/superchain-config.html#unpause">unpause</a></li>
<li><a href="protocol/superchain-config.html#extend">extend</a></li>
<li><a href="protocol/superchain-config.html#pausable">pausable</a></li>
<li><a href="protocol/superchain-config.html#paused">paused</a></li>
<li><a href="protocol/superchain-config.html#expiration">expiration</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-24"><a class="header" href="#overview-24">Overview</a></h2>
<p>The SuperchainConfig contract is used to manage global configuration values for multiple OP Chains
within a single Superchain network.</p>
<h2 id="configuration-data-structure"><a class="header" href="#configuration-data-structure">Configuration Data Structure</a></h2>
<p>The <code>SuperchainDefinition</code> type represents the configuration for a
Superchain target, containing information about L1 contract addresses
and network parameters.</p>
<h3 id="superchaindefinition"><a class="header" href="#superchaindefinition">SuperchainDefinition</a></h3>
<pre><code class="language-javascript">SuperchainDefinition {
    Name                   string
    ProtocolVersionsAddr   address
    SuperchainConfigAddr   address
    OPContractsManagerAddr address
    Hardforks              Hardforks
    L1                     SuperchainL1
}
</code></pre>
<p><strong>Fields:</strong></p>
<ul>
<li><code>Name</code>: The name of the superchain (e.g., "mainnet", "sepolia")</li>
<li><code>ProtocolVersionsAddr</code>: Address of the ProtocolVersions contract on L1</li>
<li><code>SuperchainConfigAddr</code>: Address of the SuperchainConfig contract on L1</li>
<li><code>OPContractsManagerAddr</code>: Address of the OP Contracts Manager on L1</li>
<li><code>Hardforks</code>: Hardfork activation configuration for the superchain</li>
<li><code>L1</code>: L1 chain information including chain ID, RPC endpoint, and explorer URL</li>
</ul>
<h3 id="hardforks"><a class="header" href="#hardforks">Hardforks</a></h3>
<p>The <code>Hardforks</code> type contains optional activation timestamps for each network upgrade.</p>
<pre><code class="language-javascript">Hardforks {
    CanyonTime             uint64
    DeltaTime              uint64
    EcotoneTime            uint64
    FjordTime              uint64
    GraniteTime            uint64
    HoloceneTime           uint64
    IsthmusTime            uint64
    InteropTime            uint64
}
</code></pre>
<p><strong>Fields:</strong></p>
<ul>
<li><code>CanyonTime</code>: Activation timestamp for the Canyon upgrade</li>
<li><code>DeltaTime</code>: Activation timestamp for the Delta upgrade</li>
<li><code>EcotoneTime</code>: Activation timestamp for the Ecotone upgrade</li>
<li><code>FjordTime</code>: Activation timestamp for the Fjord upgrade</li>
<li><code>GraniteTime</code>: Activation timestamp for the Granite upgrade</li>
<li><code>HoloceneTime</code>: Activation timestamp for the Holocene upgrade</li>
<li><code>IsthmusTime</code>: Activation timestamp for the Isthmus upgrade</li>
<li><code>InteropTime</code>: Activation timestamp for the Interop upgrade</li>
</ul>
<h3 id="superchainl1"><a class="header" href="#superchainl1">SuperchainL1</a></h3>
<p>The <code>SuperchainL1</code> type contains L1 chain information for the superchain.</p>
<pre><code class="language-javascript">SuperchainL1 {
    ChainID   uint64
    PublicRPC string
    Explorer  string
}
</code></pre>
<p><strong>Fields:</strong></p>
<ul>
<li><code>ChainID</code>: The chain ID of the L1 network (e.g. 1 for Ethereum mainnet, 11155111 for Sepolia)</li>
<li><code>PublicRPC</code>: Public RPC endpoint URL for the L1 network</li>
<li><code>Explorer</code>: Block explorer URL for the L1 network</li>
</ul>
<h2 id="invariants-3"><a class="header" href="#invariants-3">Invariants</a></h2>
<h3 id="isupc-001-the-guardian-and-pause-deputy-must-be-able-to-trigger-the-pause-mechanism"><a class="header" href="#isupc-001-the-guardian-and-pause-deputy-must-be-able-to-trigger-the-pause-mechanism">iSUPC-001: The Guardian and Pause Deputy must be able to trigger the Pause Mechanism</a></h3>
<p>We require that the <code>SuperchainConfig</code> is constructed such that both the
<a href="protocol/./stage-1.html#guardian">Guardian</a> and the <a href="protocol/./stage-1.html#pause-deputy">Pause Deputy</a> must be able to
trigger the <a href="protocol/./stage-1.html#pause-mechanism">Pause Mechanism</a> at any time.</p>
<h4 id="impact-7"><a class="header" href="#impact-7">Impact</a></h4>
<p><strong>Severity: High</strong></p>
<p>Existing recovery runbooks would not function as expected if the <code>SuperchainConfig</code> prevented one
of these actors from triggering the pause as needed.</p>
<h3 id="isupc-002-the-guardian-must-be-able-to-reset-or-undo-the-pause-mechanism"><a class="header" href="#isupc-002-the-guardian-must-be-able-to-reset-or-undo-the-pause-mechanism">iSUPC-002: The Guardian must be able to reset or undo the Pause Mechanism</a></h3>
<p>We require that the <code>SuperchainConfig</code> is constructed such that the
<a href="protocol/./stage-1.html#guardian">Guardian</a> must be able to unpause or extend the
<a href="protocol/./stage-1.html#pause-mechanism">Pause Mechanism</a> at any time.</p>
<h4 id="impact-8"><a class="header" href="#impact-8">Impact</a></h4>
<p><strong>Severity: Medium</strong></p>
<p>If the Pause Mechanism cannot be reset then it cannot be used again without intervention from the
<a href="protocol/./stage-1.html#proxy-admin-owner">Proxy Admin Owner</a>. We consider this to be a Medium severity
issue because the Proxy Admin Owner will have several months to coordinate such a fix assuming
that <a href="protocol/superchain-config.html#isupc-001-the-guardian-and-pause-deputy-must-be-able-to-trigger-the-pause-mechanism">iSUPC-001</a> holds.</p>
<h2 id="function-specification-2"><a class="header" href="#function-specification-2">Function Specification</a></h2>
<h3 id="initialize-2"><a class="header" href="#initialize-2">initialize</a></h3>
<ul>
<li>MUST only be triggerable by the ProxyAdmin or its owner.</li>
<li>MUST only be triggerable once.</li>
<li>MUST set the value of the Guardian role.</li>
<li>MUST emit a ConfigUpdate event with the Guardian address.</li>
</ul>
<h3 id="upgrade"><a class="header" href="#upgrade">upgrade</a></h3>
<ul>
<li>MUST only be triggerable by the ProxyAdmin or its owner.</li>
<li>MUST migrate the guardian from old storage to new storage.</li>
<li>MUST clear old storage slots.</li>
<li>MUST maintain contract version information.</li>
</ul>
<h3 id="guardian-1"><a class="header" href="#guardian-1">guardian</a></h3>
<p>Returns the address of the current <a href="protocol/./stage-1.html#guardian">Guardian</a>.</p>
<h3 id="pauseexpiry"><a class="header" href="#pauseexpiry">pauseExpiry</a></h3>
<p>Returns the duration after which a pause expires, which is a hardcoded constant of 7,884,000 seconds (approximately 3 months).</p>
<h3 id="pause"><a class="header" href="#pause">pause</a></h3>
<p>Allows the <a href="protocol/./stage-1.html#guardian">Guardian</a> to trigger the
<a href="protocol/./stage-1.html#pause-mechanism">Pause Mechanism</a>. <code>pause</code> takes an address
<a href="protocol/./stage-1.html#pause-identifier">Pause Identifier</a> as an input. This identifier determines which
systems or chains are affected by the pause.</p>
<ul>
<li>MUST revert if called by an address other than the Guardian.</li>
<li>MUST revert if the pause timestamp for the given identifier is non-zero (already paused).</li>
<li>MUST set the pause timestamp for the given identifier to the current block timestamp.</li>
<li>MUST emit a Paused event with the identifier.</li>
</ul>
<h3 id="unpause"><a class="header" href="#unpause">unpause</a></h3>
<p>Allows the <a href="protocol/./stage-1.html#guardian">Guardian</a> to explicitly unpause the system for a given
<a href="protocol/./stage-1.html#pause-identifier">Pause Identifier</a> rather than waiting for the pause to expire.
Unpausing a specific identifier does NOT unpause the global pause (zero address identifier). If the
global pause is active, all systems will remain paused even if their specific identifiers are
unpaused.</p>
<ul>
<li>MUST revert if called by an address other than the Guardian.</li>
<li>MUST set the pause timestamp for the given identifier to 0, representing "not paused".</li>
<li>MUST emit an Unpaused event with the identifier.</li>
<li>Will not revert if the system is not already paused for the given identifier.</li>
</ul>
<h3 id="extend"><a class="header" href="#extend">extend</a></h3>
<p>Allows the <a href="protocol/./stage-1.html#guardian">Guardian</a> to extend an active pause by resetting the pause
timestamp to the current block timestamp, effectively restarting the expiry timer.</p>
<ul>
<li>MUST revert if called by an address other than the Guardian.</li>
<li>MUST revert if the pause timestamp for the given identifier is zero (not currently paused).</li>
<li>MUST set the pause timestamp for the given identifier to the current block timestamp.</li>
<li>MUST emit a Paused event with the identifier.</li>
</ul>
<h3 id="pausable"><a class="header" href="#pausable">pausable</a></h3>
<p>Allows any user to check if the <a href="protocol/./stage-1.html#pause-mechanism">Pause Mechanism</a> can be triggered
for a specific <a href="protocol/./stage-1.html#pause-identifier">Pause Identifier</a>. The pausable status of a specific
identifier is independent of the pausable status of the global pause (zero address identifier).</p>
<ul>
<li>MUST return true if the pause timestamp for the given identifier is 0 (not currently paused).</li>
<li>MUST return false if the pause timestamp for the given identifier is non-zero (currently paused).</li>
</ul>
<h3 id="paused-2"><a class="header" href="#paused-2">paused</a></h3>
<p>Allows any user to check if the system is currently paused for a specific
<a href="protocol/./stage-1.html#pause-identifier">Pause Identifier</a>.</p>
<ul>
<li>MUST return true if the pause timestamp for the given identifier is non-zero AND not expired
(current time &lt; pause timestamp + expiry duration).</li>
<li>MUST return false otherwise.</li>
<li>When called without parameters, MUST check the pause status for the global identifier (address(0)).</li>
</ul>
<h3 id="expiration"><a class="header" href="#expiration">expiration</a></h3>
<p>Returns the timestamp at which the pause for a given
<a href="protocol/./stage-1.html#pause-identifier">Pause Identifier</a> will expire. This function only returns the
expiration for the specific identifier provided.</p>
<ul>
<li>MUST return the pause timestamp plus the configured expiry duration if the pause timestamp is non-zero.</li>
<li>MUST return 0 if the pause timestamp is 0 (system is not paused) for the given identifier.</li>
</ul>
<!-- references -->
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="superchain-upgrades"><a class="header" href="#superchain-upgrades">Superchain Upgrades</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/superchain-upgrades.html#overview">Overview</a></li>
<li><a href="protocol/superchain-upgrades.html#protocol-version">Protocol Version</a>
<ul>
<li><a href="protocol/superchain-upgrades.html#protocol-version-format">Protocol Version Format</a>
<ul>
<li><a href="protocol/superchain-upgrades.html#build-identifier">Build identifier</a></li>
<li><a href="protocol/superchain-upgrades.html#major-versions">Major versions</a></li>
<li><a href="protocol/superchain-upgrades.html#minor-versions">Minor versions</a></li>
<li><a href="protocol/superchain-upgrades.html#patch-versions">Patch versions</a></li>
<li><a href="protocol/superchain-upgrades.html#pre-releases">Pre-releases</a></li>
</ul>
</li>
<li><a href="protocol/superchain-upgrades.html#protocol-version-exposure">Protocol Version Exposure</a></li>
</ul>
</li>
<li><a href="protocol/superchain-upgrades.html#superchain-target">Superchain Target</a>
<ul>
<li><a href="protocol/superchain-upgrades.html#superchain-version-signaling">Superchain Version signaling</a></li>
<li><a href="protocol/superchain-upgrades.html#protocolversions-l1-contract"><code>ProtocolVersions</code> L1 contract</a></li>
</ul>
</li>
<li><a href="protocol/superchain-upgrades.html#activation-rules">Activation rules</a>
<ul>
<li><a href="protocol/superchain-upgrades.html#l2-block-number-based-activation-deprecated">L2 Block-number based activation (deprecated)</a></li>
<li><a href="protocol/superchain-upgrades.html#l2-block-timestamp-based-activation">L2 Block-timestamp based activation</a></li>
</ul>
</li>
<li><a href="protocol/superchain-upgrades.html#op-stack-protocol-versions">OP-Stack Protocol versions</a></li>
<li><a href="protocol/superchain-upgrades.html#post-bedrock-network-upgrades">Post-Bedrock Network upgrades</a>
<ul>
<li><a href="protocol/superchain-upgrades.html#activation-timestamps">Activation Timestamps</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-25"><a class="header" href="#overview-25">Overview</a></h2>
<p>Superchain upgrades, also known as forks or hardforks, implement consensus-breaking changes.</p>
<p>A Superchain upgrade requires the node software to support up to a given Protocol Version.
The version indicates support, the upgrade indicates the activation of new functionality.</p>
<p>This document lists the protocol versions of the OP-Stack, starting at the Bedrock upgrade,
as well as the default Superchain Targets.</p>
<p>Activation rule parameters of network upgrades are configured as part of the Superchain Target specification:
chains following the same Superchain Target upgrade synchronously.</p>
<h2 id="protocol-version"><a class="header" href="#protocol-version">Protocol Version</a></h2>
<p>The Protocol Version documents the progression of the total set of canonical OP-Stack specifications.
Components of the OP-Stack implement the subset of their respective protocol component domain,
up to a given Protocol Version of the OP-Stack.</p>
<p>OP-Stack mods, i.e. non-canonical extensions to the OP-Stack, are not included in the versioning of the Protocol.
Instead, mods must specify which upstream Protocol Version they are based on and where breaking changes are made.
This ensures tooling of the OP-Stack can be shared and collaborated on with OP-Stack mods.</p>
<p>The Protocol Version is NOT a hardfork identifier, but rather indicates software-support for a well-defined set
of features introduced in past and future hardforks, not the activation of said hardforks.</p>
<p>Changes that can be included in prospective Protocol Versions may be included in the specifications as proposals,
with explicit notice of the Protocol Version they are based on.
This enables an iterative integration process into the canonical set of specifications,
but does not guarantee the proposed specifications become canonical.</p>
<p>Note that the Protocol Version only applies to the Protocol specifications with the Superchain Targets specified within.
This versioning is independent of the <a href="https://semver.org/">Semver</a> versioning used in OP Stack smart-contracts,
and the <a href="https://semver.org/">Semver</a>-versioned reference software of the OP-Stack.</p>
<h3 id="protocol-version-format"><a class="header" href="#protocol-version-format">Protocol Version Format</a></h3>
<p>The Protocol Version is <a href="https://semver.org/">Semver</a>-compatible.
It is encoded as a single 32 bytes long <code>&lt;protocol version&gt;</code>.
The version must be encoded as 32 bytes of <code>DATA</code> in JSON RPC usage.</p>
<p>The encoding is typed, to ensure future-compatibility.</p>
<pre><code class="language-text">&lt;protocol version&gt; ::= &lt;version-type&gt;&lt;typed-payload&gt;
&lt;version-type&gt; ::= &lt;uint8&gt;
&lt;typed-payload&gt; ::= &lt;31 bytes&gt;
</code></pre>
<p>version-type <code>0</code>:</p>
<pre><code class="language-text">&lt;reserved&gt;&lt;build&gt;&lt;major&gt;&lt;minor&gt;&lt;patch&gt;&lt;pre-release&gt;
&lt;reserved&gt; ::= &lt;7 zeroed bytes&gt;
&lt;build&gt; ::= &lt;8 bytes&gt;
&lt;major&gt; ::= &lt;big-endian uint32&gt;
&lt;minor&gt; ::= &lt;big-endian uint32&gt;
&lt;patch&gt; ::= &lt;big-endian uint32&gt;
&lt;pre-release&gt; ::= &lt;big-endian uint32&gt;
</code></pre>
<p>The <code>&lt;reserved&gt;</code> bytes of the Protocol Version are reserved for future extensions.</p>
<p>Protocol versions with a different <code>&lt;version-type&gt;</code> should not be compared directly.</p>
<h4 id="build-identifier"><a class="header" href="#build-identifier">Build identifier</a></h4>
<p>The <code>&lt;build&gt;</code> identifier, as defined by <a href="https://semver.org/">Semver</a>, is ignored when determining version precedence.
The <code>&lt;build&gt;</code> must be non-zero to apply to the protocol version.</p>
<p>Modifications of the OP-Stack should define a <code>&lt;build&gt;</code> to distinguish from the canonical protocol feature-set.
Changes to the <code>&lt;build&gt;</code> may be encoded in the <code>&lt;build&gt;</code> itself to stay aligned with the upstream protocol.
The major/minor/patch versions should align with that of the upstream protocol that the modifications are based on.
Users of the protocol can choose to implement custom support for the alternative <code>&lt;build&gt;</code>,
but may work out of the box if the major features are consistent with that of the upstream protocol version.</p>
<p>The 8 byte <code>&lt;build&gt;</code> identifier may be presented as a string for human readability if the contents are alpha-numeric,
including <code>-</code> and <code>.</code>, as outlined in the <a href="https://semver.org/">Semver</a> format specs. Trailing <code>0</code> bytes can be used for padding.
It may be presented as <code>0x</code>-prefixed hex string otherwise.</p>
<h4 id="major-versions"><a class="header" href="#major-versions">Major versions</a></h4>
<p>Major version changes indicate support for new consensus-breaking functionality.
Major versions should retain support for functionality of previous major versions for
syncing/indexing of historical chain data.
Implementations may drop support for previous Major versions, when there are viable alternatives,
e.g. <code>l2geth</code> for pre-Bedrock data.</p>
<h4 id="minor-versions"><a class="header" href="#minor-versions">Minor versions</a></h4>
<p>Minor version changes indicate support for backward compatible extensions,
including backward-compatible additions to the set of chains in a Superchain Target.
Backward-compatibility is defined by the requirement for existing end-users to upgrade nodes and tools or not.
Minor version changes may also include optional offchain functionality, such as additional syncing protocols.</p>
<h4 id="patch-versions"><a class="header" href="#patch-versions">Patch versions</a></h4>
<p>Patch version changes indicate backward compatible bug fixes and improvements.</p>
<h4 id="pre-releases"><a class="header" href="#pre-releases">Pre-releases</a></h4>
<p>Pre-releases of the protocol are proposals: these are not stable targets for production usage.
A pre-release might not satisfy the intended compatibility requirements as denoted by its associated normal version.
The <code>&lt;pre-release&gt;</code> must be non-zero to apply to the protocol version.
The <code>&lt;pre-release&gt;</code> <code>0</code>-value is reserved for non-prereleases, i.e. <code>v3.1.0</code> is higher than <code>v3.1.0-1</code>.</p>
<p>Node-software may support a pre-release, but must not activate any protocol changes without the user explicitly
opting in through the means of a feature-flag or configuration change.</p>
<p>A pre-release is not an official version and is meant for protocol developers to communicate an experimental changeset
before the changeset is reviewed by governance. Pre-releases are subject to change.</p>
<h3 id="protocol-version-exposure"><a class="header" href="#protocol-version-exposure">Protocol Version Exposure</a></h3>
<p>The Protocol Version is not exposed to the application-layer environment:
hardforks already expose the change of functionality upon activation as required,
and the Protocol Version is meant for offchain usage only.
The protocol version indicates support rather than activation of functionality.
There is one exception however: signaling by onchain components to offchain components.
More about this in <a href="protocol/superchain-upgrades.html#superchain-version-signaling">Superchain Version signaling</a>.</p>
<h2 id="superchain-target"><a class="header" href="#superchain-target">Superchain Target</a></h2>
<p>Changes to the L2 state-transition function are transitioned into deterministically across all nodes
through an <strong>activation rule</strong>.</p>
<p>Changes to L1 smart-contracts must be compatible with the latest activated L2 functionality,
and are executed through <strong>L1 contract-upgrades</strong>.</p>
<p>A Superchain Target defines a set of activation rules and L1 contract upgrades shared between OP-Stack chains,
to upgrade the chains collectively.</p>
<h3 id="superchain-version-signaling"><a class="header" href="#superchain-version-signaling">Superchain Version signaling</a></h3>
<p>Each Superchain Target tracks the protocol changes, and signals the <code>recommended</code> and <code>required</code>
Protocol Version ahead of activation of new breaking functionality.</p>
<ul>
<li><code>recommended</code>: a signal in advance of a network upgrade, to alert users of the protocol change to be prepared for.
Node software is recommended to signal the recommendation to users through logging and metrics.</li>
<li><code>required</code>: a signal shortly in advance of a breaking network upgrade, to alert users of breaking changes.
Users may opt in to elevated alerts or preventive measures, to ensure consistency with the upgrade.</li>
</ul>
<p>Signaling is done through a L1 smart-contract that is monitored by the OP-Stack software.
Not all components of the OP-Stack are required to directly monitor L1 however:
cross-component APIs like the Engine API may be used to forward the Protocol Version signals,
to keep components encapsulated from L1.
See <a href="protocol/exec-engine.html#enginesignalopstackversionv1"><code>engine_signalOPStackVersionV1</code></a>.</p>
<h3 id="protocolversions-l1-contract"><a class="header" href="#protocolversions-l1-contract"><code>ProtocolVersions</code> L1 contract</a></h3>
<p>The <code>ProtocolVersions</code> contract on L1 enables L2 nodes to pick up on superchain protocol version signals.</p>
<p>The interface is:</p>
<ul>
<li>Required storage slot: <code>bytes32(uint256(keccak256("protocolversion.required")) - 1)</code></li>
<li>Recommended storage slot: <code>bytes32(uint256(keccak256("protocolversion.recommended")) - 1)</code></li>
<li>Required getter: <code>required()</code> returns <code>ProtocolVersion</code></li>
<li>Recommended getter <code>recommended()</code> returns <code>ProtocolVersion</code></li>
<li>Version updates also emit a typed event:
<code>event ConfigUpdate(uint256 indexed version, UpdateType indexed updateType, bytes data)</code></li>
</ul>
<h2 id="activation-rules"><a class="header" href="#activation-rules">Activation rules</a></h2>
<p>The below L2-block based activation rules may be applied in two contexts:</p>
<ul>
<li>The rollup node, specified through the rollup configuration (known as <code>rollup.json</code>),
referencing L2 blocks (or block input-attributes) that pass through the derivation pipeline.</li>
<li>The execution engine, specified through the chain configuration (known as the <code>config</code> part of <code>genesis.json</code>),
referencing blocks or input-attributes that are part of, or applied to, the L2 chain.</li>
</ul>
<p>For both types of configurations, some activation parameters may apply to all chains within the superchain,
and are then retrieved from the superchain target configuration.</p>
<h3 id="l2-block-number-based-activation-deprecated"><a class="header" href="#l2-block-number-based-activation-deprecated">L2 Block-number based activation (deprecated)</a></h3>
<p>Activation rule: <code>upgradeNumber != null &amp;&amp; block.number &gt;= upgradeNumber</code></p>
<p>Starting at, and including, the L2 <code>block</code> with <code>block.number &gt;= upgradeNumber</code>, the upgrade rules apply.
If the upgrade block-number <code>upgradeNumber</code> is not specified in the configuration, the upgrade is ignored.</p>
<p>This block number based method has commonly been used in L1 up until the Bellatrix/Paris upgrade, a.k.a. The Merge,
which was upgraded through special rules.</p>
<p>This method is not superchain-compatible, as the activation-parameter is chain-specific
(different chains may have different block-heights at the same moment in time).</p>
<p>This applies to the L2 block number, not to the L1-origin block number.
This means that an L2 upgrade may be inactive, and then active, without changing the L1-origin.</p>
<h3 id="l2-block-timestamp-based-activation"><a class="header" href="#l2-block-timestamp-based-activation">L2 Block-timestamp based activation</a></h3>
<p>Activation rule: <code>upgradeTime != null &amp;&amp; block.timestamp &gt;= upgradeTime</code></p>
<p>Starting at, and including, the L2 <code>block</code> with <code>block.timestamp &gt;= upgradeTime</code>, the upgrade rules apply.
If the upgrade block-timestamp <code>upgradeTime</code> is not specified in the configuration, the upgrade is ignored.</p>
<p>This is the preferred superchain upgrade activation-parameter type:
it is synchronous between all L2 chains and compatible with post-Merge timestamp-based chain upgrades in L1.</p>
<p>This applies to the L2 block timestamp, not to the L1-origin block timestamp.
This means that an L2 upgrade may be inactive, and then active, without changing the L1-origin.</p>
<p>This timestamp based method has become the default on L1 after the Bellatrix/Paris upgrade, a.k.a. The Merge,
because it can be planned in accordance with beacon-chain epochs and slots.</p>
<p>Note that the L2 version is not limited to timestamps that match L1 beacon-chain slots or epochs.
A timestamp may be chosen to be synchronous with a specific slot or epoch on L1,
but the matching L1-origin information may not be present at the time of activation on L2.</p>
<h2 id="op-stack-protocol-versions"><a class="header" href="#op-stack-protocol-versions">OP-Stack Protocol versions</a></h2>
<ul>
<li><code>v1.0.0</code>: 2021 Jan 16th - Mainnet Soft Launch, based on OVM.
(<a href="https://medium.com/ethereum-optimism/mainnet-soft-launch-7cacc0143cd5">announcement</a>)</li>
<li><code>v1.1.0</code>: 2021 Aug 19th - Community launch.
(<a href="https://medium.com/ethereum-optimism/community-launch-7c9a2a9d3e84">announcement</a>)</li>
<li><code>v2.0.0</code>: 2021 Nov 12th - the EVM-Equivalence update, also known as OVM 2.0 and chain regenesis.
(<a href="https://twitter.com/optimismfnd/status/1458953238867165192">announcement</a>)</li>
<li><code>v2.1.0</code>: 2022 May 31st - Optimism Collective.
(<a href="https://optimism.mirror.xyz/gQWKlrDqHzdKPsB1iUnI-cVN3v0NvsWnazK7ajlt1fI">announcement</a>).</li>
<li><code>v3.0.0-1</code>: 2023 Jan 13th - Bedrock pre-release, deployed on OP-Goerli, and later Base-Goerli.</li>
<li><code>v3.0.0</code>: 2023 Jun 6th - Bedrock, including the Regolith hardfork improvements, first deployed on OP-Mainnet.</li>
<li><code>v4.0.0</code>: 2024 Jan 11th - Canyon network upgrade (Shapella).
<a href="https://gov.optimism.io/t/final-upgrade-proposal-2-canyon-network-upgrade/7088">Governance Proposal</a>.</li>
<li><code>v5.0.0</code>: 2024 Feb 22nd - Delta network upgrade (Span Batches).
<a href="https://gov.optimism.io/t/final-upgrade-proposal-3-delta-network-upgrade/7310">Governance Proposal</a>.</li>
<li><code>v6.0.0</code>: 2024 Mar 14th - Ecotone network upgrade (4844 Blob Batches + Cancun).
<a href="https://gov.optimism.io/t/upgrade-proposal-5-ecotone-network-upgrade/7669">Governance Proposal</a>.</li>
<li><code>v7.0.0</code>: 2024 Jul 10th - Fjord network upgrade (RIP-7212 precompile + FastLZ cost fn + Brotli compression).
<a href="https://gov.optimism.io/t/upgrade-proposal-9-fjord-network-upgrade/8236">Governance Proposal</a>.</li>
<li><code>v8.0.0</code>: 2024 Sep 11th - Granite network upgrade (Limit ecpairing input size + Reduce Channel Timeout).
<a href="https://gov.optimism.io/t/upgrade-proposal-10-granite-network-upgrade/8733">Governance Proposal</a>.</li>
<li><code>v9.0.0</code>: 2025 Jan 9th - Holocene network upgrade (Stricter Holocene derivation + EIP-1559 configurability).
<a href="https://gov.optimism.io/t/upgrade-proposal-11-holocene-network-upgrade/9313">Governance Proposal</a>.</li>
</ul>
<h2 id="post-bedrock-network-upgrades"><a class="header" href="#post-bedrock-network-upgrades">Post-Bedrock Network upgrades</a></h2>
<h3 id="activation-timestamps"><a class="header" href="#activation-timestamps">Activation Timestamps</a></h3>
<p>Governance approves all network upgrades &amp; the time at which the upgrade activates. The approved governance
proposal is the canonical document for the timestamp; however, the timestamps are replicated here for ease of use.</p>
<div class="table-wrapper"><table><thead><tr><th>Network Upgrade</th><th>Mainnet Upgrade Timestamp</th><th>Sepolia Upgrade Timestamp</th><th>Goerli Upgrade Timestamp</th></tr></thead><tbody>
<tr><td>Canyon</td><td>1704992401</td><td>1699981200</td><td>1699981200</td></tr>
<tr><td>Delta</td><td>1708560000</td><td>1703203200</td><td>1703116800</td></tr>
<tr><td>Ecotone</td><td>1710374401</td><td>1708534800</td><td>1707238800</td></tr>
<tr><td>Fjord</td><td>1720627201</td><td>1716998400</td><td>n/a</td></tr>
<tr><td>Granite</td><td>1726070401</td><td>1723478400</td><td>n/a</td></tr>
<tr><td>Holocene</td><td>1736445601</td><td>1732633200</td><td>n/a</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="system-config"><a class="header" href="#system-config">System Config</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/system-config.html#overview">Overview</a></li>
<li><a href="protocol/system-config.html#definitions">Definitions</a>
<ul>
<li><a href="protocol/system-config.html#batch-inbox">Batch Inbox</a></li>
<li><a href="protocol/system-config.html#batcher-hash">Batcher Hash</a></li>
<li><a href="protocol/system-config.html#fee-scalars">Fee Scalars</a>
<ul>
<li><a href="protocol/system-config.html#pre-ecotone-parameters">Pre-Ecotone Parameters</a></li>
<li><a href="protocol/system-config.html#post-ecotone-parameters">Post-Ecotone Parameters</a></li>
<li><a href="protocol/system-config.html#post-ecotone-scalar-encoding">Post-Ecotone Scalar Encoding</a></li>
</ul>
</li>
<li><a href="protocol/system-config.html#unsafe-block-signer">Unsafe Block Signer</a></li>
<li><a href="protocol/system-config.html#l2-gas-limit">L2 Gas Limit</a></li>
<li><a href="protocol/system-config.html#customizable-feature">Customizable Feature</a></li>
</ul>
</li>
<li><a href="protocol/system-config.html#functionality">Functionality</a>
<ul>
<li><a href="protocol/system-config.html#system-config-updates">System Config Updates</a></li>
</ul>
</li>
<li><a href="protocol/system-config.html#function-specification">Function Specification</a>
<ul>
<li><a href="protocol/system-config.html#initialize">initialize</a></li>
<li><a href="protocol/system-config.html#upgrade">upgrade</a></li>
<li><a href="protocol/system-config.html#setfeatureenabled">setFeatureEnabled</a></li>
<li><a href="protocol/system-config.html#isfeatureenabled">isFeatureEnabled</a></li>
<li><a href="protocol/system-config.html#minimumgaslimit">minimumGasLimit</a></li>
<li><a href="protocol/system-config.html#maximumgaslimit">maximumGasLimit</a></li>
<li><a href="protocol/system-config.html#unsafeblocksigner">unsafeBlockSigner</a></li>
<li><a href="protocol/system-config.html#l1crossdomainmessenger">l1CrossDomainMessenger</a></li>
<li><a href="protocol/system-config.html#l1erc721bridge">l1ERC721Bridge</a></li>
<li><a href="protocol/system-config.html#l1standardbridge">l1StandardBridge</a></li>
<li><a href="protocol/system-config.html#disputegamefactory">disputeGameFactory</a></li>
<li><a href="protocol/system-config.html#optimismportal">optimismPortal</a></li>
<li><a href="protocol/system-config.html#optimismmintableerc20factory">optimismMintableERC20Factory</a></li>
<li><a href="protocol/system-config.html#getaddresses">getAddresses</a></li>
<li><a href="protocol/system-config.html#batchinbox">batchInbox</a></li>
<li><a href="protocol/system-config.html#startblock">startBlock</a></li>
<li><a href="protocol/system-config.html#paused">paused</a></li>
<li><a href="protocol/system-config.html#superchainconfig">superchainConfig</a></li>
<li><a href="protocol/system-config.html#setunsafeblocksigner">setUnsafeBlockSigner</a></li>
<li><a href="protocol/system-config.html#setbatcherhash">setBatcherHash</a></li>
<li><a href="protocol/system-config.html#setgasconfig">setGasConfig</a></li>
<li><a href="protocol/system-config.html#setgasconfigecotone">setGasConfigEcotone</a></li>
<li><a href="protocol/system-config.html#setgaslimit">setGasLimit</a></li>
<li><a href="protocol/system-config.html#seteip1559params">setEIP1559Params</a></li>
<li><a href="protocol/system-config.html#setoperatorfeescalars">setOperatorFeeScalars</a></li>
<li><a href="protocol/system-config.html#setminbasefee">setMinBaseFee</a></li>
<li><a href="protocol/system-config.html#setdafootprintgasscalar">setDAFootprintGasScalar</a></li>
<li><a href="protocol/system-config.html#resourceconfig">resourceConfig</a></li>
<li><a href="protocol/system-config.html#guardian">guardian</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-26"><a class="header" href="#overview-26">Overview</a></h2>
<p>The <code>SystemConfig</code> is a contract on L1 that can emit rollup configuration changes as log events.
The rollup <a href="protocol/derivation.html">block derivation process</a> picks up on these log events and applies the
changes. <code>SystemConfig</code> generally acts as the source of truth for configuration values within an
OP Stack chain.</p>
<h2 id="definitions-4"><a class="header" href="#definitions-4">Definitions</a></h2>
<h3 id="batch-inbox"><a class="header" href="#batch-inbox">Batch Inbox</a></h3>
<p>The <strong>Batch Inbox</strong> is the address that Sequencer transaction batches are published to. Sequencers
publish transactions to the Batch Inbox by setting it as the <code>to</code> address on a transaction
containing batched L2 transactions either in calldata or as blobdata.</p>
<h3 id="batcher-hash"><a class="header" href="#batcher-hash">Batcher Hash</a></h3>
<p>The <strong>Batcher Hash</strong> identifies the sender(s) whose transactions to the <a href="protocol/system-config.html#batch-inbox">Batch Inbox</a>
will be recognized by the L2 clients for a given OP Chain.</p>
<p>The Batcher Hash is versioned by the first byte of the hash. The structure of the V0 Batcher Hash
is a 32 byte hash defined as follows:</p>
<div class="table-wrapper"><table><thead><tr><th>1 byte</th><th>11 bytes</th><th>20 bytes</th></tr></thead><tbody>
<tr><td>version (0x00)</td><td>empty</td><td>address</td></tr>
</tbody></table>
</div>
<p>This can also be understood as:</p>
<pre><code class="language-solidity">bytes32(address(batcher))
</code></pre>
<p>Where <code>batcher</code> is the address of the account that sends transactions to the Batch Inbox. Put
simply, the V0 hash identifies a <em>single</em> address whose transaction batches will be recognized by
L2 clients. This hash is versioned so that it could, for instance, be repurposed to be a commitment
to a list of permitted accounts or some other form of batcher identification.</p>
<h3 id="fee-scalars"><a class="header" href="#fee-scalars">Fee Scalars</a></h3>
<p>The <strong>Fee Scalars</strong> are parameters used to calculate the L1 data fee for L2 transactions. These
parameters are also known as Gas Price Oracle (GPO) parameters.</p>
<h4 id="pre-ecotone-parameters"><a class="header" href="#pre-ecotone-parameters">Pre-Ecotone Parameters</a></h4>
<p>Before the Ecotone upgrade, these include:</p>
<ul>
<li><strong>Scalar</strong>: A multiplier applied to the L1 base fee, interpreted as a big-endian <code>uint256</code></li>
<li><strong>Overhead</strong>: A constant gas overhead, interpreted as a big-endian <code>uint256</code></li>
</ul>
<h4 id="post-ecotone-parameters"><a class="header" href="#post-ecotone-parameters">Post-Ecotone Parameters</a></h4>
<p>After the Ecotone upgrade:</p>
<ul>
<li>The <strong>Scalar</strong> attribute encodes additional scalar information in a versioned encoding scheme</li>
<li>The <strong>Overhead</strong> value is ignored and does not affect the L2 state-transition output</li>
</ul>
<h4 id="post-ecotone-scalar-encoding"><a class="header" href="#post-ecotone-scalar-encoding">Post-Ecotone Scalar Encoding</a></h4>
<p>The Scalar is encoded as big-endian <code>uint256</code>, interpreted as <code>bytes32</code>, and composed as follows:</p>
<ul>
<li>Byte <code>0</code>: scalar-version byte</li>
<li>Bytes <code>[1, 32)</code>: depending on scalar-version:
<ul>
<li>Scalar-version <code>0</code>:
<ul>
<li>Bytes <code>[1, 28)</code>: padding, should be zero</li>
<li>Bytes <code>[28, 32)</code>: big-endian <code>uint32</code>, encoding the L1-fee <code>baseFeeScalar</code></li>
<li>This version implies the L1-fee <code>blobBaseFeeScalar</code> is set to 0</li>
<li>If there are non-zero bytes in the padding area, <code>baseFeeScalar</code> must be set to MaxUint32</li>
</ul>
</li>
<li>Scalar-version <code>1</code>:
<ul>
<li>Bytes <code>[1, 24)</code>: padding, must be zero</li>
<li>Bytes <code>[24, 28)</code>: big-endian <code>uint32</code>, encoding the <code>blobBaseFeeScalar</code></li>
<li>Bytes <code>[28, 32)</code>: big-endian <code>uint32</code>, encoding the <code>baseFeeScalar</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>The <code>baseFeeScalar</code> corresponds to the share of the user-transaction (per byte) in the total
regular L1 EVM gas usage consumed by the data-transaction of the batch-submitter. For blob
transactions, this is the fixed intrinsic gas cost of the L1 transaction.</p>
<p>The <code>blobBaseFeeScalar</code> corresponds to the share of a user-transaction (per byte) in the total
blobdata that is introduced by the data-transaction of the batch-submitter.</p>
<h3 id="unsafe-block-signer"><a class="header" href="#unsafe-block-signer">Unsafe Block Signer</a></h3>
<p>The <strong>Unsafe Block Signer</strong> is an Ethereum address whose corresponding private key is used to sign
"unsafe" blocks before they are published to L1. This signature allows nodes in the P2P network to
recognize these blocks as the canonical unsafe blocks, preventing denial of service attacks on the
P2P layer.</p>
<p>To ensure that its value can be fetched with a storage proof in a storage layout independent
manner, it is stored at a special storage slot corresponding to
<code>keccak256("systemconfig.unsafeblocksigner")</code>.</p>
<p>Unlike other system config parameters, the Unsafe Block Signer only operates on blockchain policy
and is not a consensus level parameter.</p>
<h3 id="l2-gas-limit"><a class="header" href="#l2-gas-limit">L2 Gas Limit</a></h3>
<p>The <strong>L2 Gas Limit</strong> defines the maximum amount of gas that can be used in a single L2 block.
This parameter ensures that L2 blocks remain of reasonable size to be processed and proven.</p>
<p>Changes to the L2 gas limit are fully applied in the first L2 block with the L1 origin that
introduced the change, as opposed to the 1/1024 adjustments towards a target as seen in limit
updates of L1 blocks.</p>
<p>The gas limit may not be set to a value larger than the
<a href="protocol/./configurability.html#gas-limit">maximum gas limit</a>. This is to ensure that L2 blocks are fault
provable and of reasonable size to be processed by the client software.</p>
<h3 id="customizable-feature"><a class="header" href="#customizable-feature">Customizable Feature</a></h3>
<p>A <strong>Customizable Feature</strong> is a component of the OP Stack that is maintained as a production-grade
element of the stack behind some sort of toggle. A Customizable Feature is distinct from other
types of feature-flagged code because it is part of the mainline OP Stack and is intended to remain
as a supported configuration option indefinitely. Unlike short-lived feature flags, which exist
only to keep develop releasable while work is in progress, customizable features are permanent,
user-facing options. They must be fully documented, tested in all supported modes, and designed for
long-term maintainability.</p>
<h2 id="functionality"><a class="header" href="#functionality">Functionality</a></h2>
<h3 id="system-config-updates"><a class="header" href="#system-config-updates">System Config Updates</a></h3>
<p>System config updates are signaled through the <code>ConfigUpdate(uint256,uint8,bytes)</code> event. The event
structure includes:</p>
<ul>
<li>The first topic determines the version</li>
<li>The second topic determines the type of update</li>
<li>The remaining event data encodes the configuration update</li>
</ul>
<p>In version <code>0</code>, the following update types are supported:</p>
<ul>
<li>Type <code>0</code>: <code>batcherHash</code> overwrite, as <code>bytes32</code> payload</li>
<li>Type <code>1</code>: Pre-Ecotone, <code>overhead</code> and <code>scalar</code> overwrite, as two packed <code>uint256</code> entries. After
Ecotone upgrade, <code>overhead</code> is ignored and <code>scalar</code> is interpreted as a versioned encoding that
updates <code>baseFeeScalar</code> and <code>blobBaseFeeScalar</code></li>
<li>Type <code>2</code>: <code>gasLimit</code> overwrite, as <code>uint64</code> payload</li>
<li>Type <code>3</code>: <code>unsafeBlockSigner</code> overwrite, as <code>address</code> payload</li>
<li>Type <code>4</code>: <code>eip1559Params</code> overwrite, as <code>uint256</code> payload encoding denomination and elasticity</li>
<li>Type <code>5</code>: <code>operatorFeeParams</code> overwrite, as <code>uint256</code> payload encoding scalar and constant</li>
<li>Type <code>6</code>: <code>minBaseFee</code> overwrite, as <code>uint64</code> payload</li>
<li>Type <code>7</code>: <code>daFootprintGasScalar</code> overwrite, as <code>uint16</code> payload</li>
</ul>
<p>If a System Config Update cannot be parsed for any reason, it is not applied and is instead skipped.</p>
<h2 id="function-specification-3"><a class="header" href="#function-specification-3">Function Specification</a></h2>
<h3 id="initialize-3"><a class="header" href="#initialize-3">initialize</a></h3>
<ul>
<li>MUST only be triggerable by the ProxyAdmin or its owner.</li>
<li>MUST only be triggerable once.</li>
<li>MUST set the owner of the contract to the provided <code>_owner</code> address.</li>
<li>MUST set the SuperchainConfig contract address.</li>
<li>MUST set the batcher hash, gas config, gas limit, unsafe block signer, resource config, batch
inbox, L1 contract addresses, and L2 chain ID.</li>
<li>MUST set the start block to the current block number if it hasn't been set already.</li>
<li>MUST validate the resource configuration parameters against system constraints.</li>
</ul>
<h3 id="upgrade-1"><a class="header" href="#upgrade-1">upgrade</a></h3>
<ul>
<li>MUST only be triggerable by the ProxyAdmin or its owner.</li>
<li>MUST set the L2 chain ID to the provided value.</li>
<li>MUST set the SuperchainConfig contract address to the provided value.</li>
<li>MUST clear the old dispute game factory address from storage (now derived from OptimismPortal).</li>
</ul>
<h3 id="setfeatureenabled"><a class="header" href="#setfeatureenabled">setFeatureEnabled</a></h3>
<p>(+v4.1.0)</p>
<ul>
<li>Used to enable or disable a <a href="protocol/system-config.html#customizable-feature">Customizable Feature</a>.</li>
<li>Takes a bytes32 feature string and a boolean as an input.</li>
<li>MUST only be triggerable by the ProxyAdmin or its owner.</li>
<li>MUST toggle the feature flag on or off, based on the value of the boolean.</li>
</ul>
<h3 id="isfeatureenabled"><a class="header" href="#isfeatureenabled">isFeatureEnabled</a></h3>
<p>(+v4.1.0)</p>
<ul>
<li>Takes a bytes32 feature string as an input.</li>
<li>Returns true if the feature is enabled and false otherwise.</li>
</ul>
<h3 id="minimumgaslimit-1"><a class="header" href="#minimumgaslimit-1">minimumGasLimit</a></h3>
<p>Returns the minimum L2 gas limit that can be safely set for the system to operate, calculated as
the sum of the maximum resource limit and the system transaction maximum gas.</p>
<h3 id="maximumgaslimit"><a class="header" href="#maximumgaslimit">maximumGasLimit</a></h3>
<p>Returns the maximum L2 gas limit that can be safely set for the system to operate.</p>
<h3 id="unsafeblocksigner"><a class="header" href="#unsafeblocksigner">unsafeBlockSigner</a></h3>
<p>Returns the address of the <a href="protocol/system-config.html#unsafe-block-signer">Unsafe Block Signer</a>.</p>
<h3 id="l1crossdomainmessenger"><a class="header" href="#l1crossdomainmessenger">l1CrossDomainMessenger</a></h3>
<p>Returns the address of the L1CrossDomainMessenger contract.</p>
<h3 id="l1erc721bridge"><a class="header" href="#l1erc721bridge">l1ERC721Bridge</a></h3>
<p>Returns the address of the L1ERC721Bridge contract.</p>
<h3 id="l1standardbridge"><a class="header" href="#l1standardbridge">l1StandardBridge</a></h3>
<p>Returns the address of the L1StandardBridge contract.</p>
<h3 id="disputegamefactory-1"><a class="header" href="#disputegamefactory-1">disputeGameFactory</a></h3>
<p>Returns the address of the DisputeGameFactory contract, derived from the OptimismPortal.</p>
<h3 id="optimismportal-1"><a class="header" href="#optimismportal-1">optimismPortal</a></h3>
<p>Returns the address of the OptimismPortal contract.</p>
<h3 id="optimismmintableerc20factory-1"><a class="header" href="#optimismmintableerc20factory-1">optimismMintableERC20Factory</a></h3>
<p>Returns the address of the OptimismMintableERC20Factory contract.</p>
<h3 id="getaddresses"><a class="header" href="#getaddresses">getAddresses</a></h3>
<p>Returns a consolidated struct containing all the L1 contract addresses.</p>
<h3 id="batchinbox"><a class="header" href="#batchinbox">batchInbox</a></h3>
<p>Returns the address of the <a href="protocol/system-config.html#batch-inbox">Batch Inbox</a>.</p>
<h3 id="startblock"><a class="header" href="#startblock">startBlock</a></h3>
<p>Returns the block number at which the op-node can start searching for logs.</p>
<h3 id="paused-3"><a class="header" href="#paused-3">paused</a></h3>
<p>(-v4.1.0) This function integrates with the <a href="protocol/./stage-1.html#pause-mechanism">Pause Mechanism</a> by
using the chain's <code>ETHLockbox</code> address as the <a href="protocol/./stage-1.html#pause-identifier">Pause Identifier</a>.
Returns the current pause state of the system by checking if the <code>SuperchainConfig</code> is paused for
this chain's <code>ETHLockbox</code>.</p>
<p>(+v4.1.0) This function integrates with the <a href="protocol/./stage-1.html#pause-mechanism">Pause Mechanism</a> by
using either the chain's <code>ETHLockbox</code> address or the chain's <code>OptimismPortal</code> address as the
<a href="protocol/./stage-1.html#pause-identifier">Pause Identifier</a>.</p>
<ul>
<li>(-v4.1.0) MUST return true if <code>SuperchainConfig.paused(optimismPortal().ethLockbox())</code> returns
true OR if <code>SuperchainConfig.paused(address(0))</code> returns true.</li>
<li>(+v4.1.0) MUST return true if <code>SuperchainConfig.paused(optimismPortal().ethLockbox())</code> returns
true AND the system is configured to use the <code>ETHLockbox</code> contract.</li>
<li>(+v4.1.0) MUST return true if <code>SuperchainConfig.paused(optimismPortal())</code> returns true AND the
system is NOT configured to use the <code>ETHLockbox</code> contract.</li>
<li>(+v4.1.0) MUST return true if <code>SuperchainConfig.paused(address(0))</code> returns true.</li>
<li>MUST return false otherwise.</li>
</ul>
<h3 id="superchainconfig-1"><a class="header" href="#superchainconfig-1">superchainConfig</a></h3>
<p>Returns the address of the SuperchainConfig contract that manages the pause state.</p>
<h3 id="setunsafeblocksigner"><a class="header" href="#setunsafeblocksigner">setUnsafeBlockSigner</a></h3>
<p>Allows the owner to update the <a href="protocol/system-config.html#unsafe-block-signer">Unsafe Block Signer</a> address.</p>
<ul>
<li>MUST revert if called by an address other than the owner.</li>
<li>MUST update the unsafe block signer address.</li>
<li>MUST emit a ConfigUpdate event with the UpdateType.UNSAFE_BLOCK_SIGNER type.</li>
</ul>
<h3 id="setbatcherhash"><a class="header" href="#setbatcherhash">setBatcherHash</a></h3>
<p>Allows the owner to update the <a href="protocol/system-config.html#batcher-hash">Batcher Hash</a>.</p>
<ul>
<li>MUST revert if called by an address other than the owner.</li>
<li>MUST update the batcher hash.</li>
<li>MUST emit a ConfigUpdate event with the UpdateType.BATCHER type.</li>
</ul>
<h3 id="setgasconfig"><a class="header" href="#setgasconfig">setGasConfig</a></h3>
<p>Allows the owner to update the gas configuration parameters (pre-Ecotone).</p>
<ul>
<li>MUST revert if called by an address other than the owner.</li>
<li>MUST revert if the scalar exceeds the maximum allowed value (no upper 8 bits should be set).</li>
<li>MUST update the overhead and scalar values.</li>
<li>MUST emit a ConfigUpdate event with the UpdateType.FEE_SCALARS type.</li>
</ul>
<h3 id="setgasconfigecotone"><a class="header" href="#setgasconfigecotone">setGasConfigEcotone</a></h3>
<p>Allows the owner to update the gas configuration parameters (post-Ecotone).</p>
<ul>
<li>MUST revert if called by an address other than the owner.</li>
<li>MUST update the basefeeScalar and blobbasefeeScalar values.</li>
<li>MUST update the scalar value with the versioned encoding.</li>
<li>MUST emit a ConfigUpdate event with the UpdateType.FEE_SCALARS type.</li>
</ul>
<h3 id="setgaslimit"><a class="header" href="#setgaslimit">setGasLimit</a></h3>
<p>Allows the owner to update the <a href="protocol/system-config.html#l2-gas-limit">L2 Gas Limit</a>.</p>
<ul>
<li>MUST revert if called by an address other than the owner.</li>
<li>MUST revert if the gas limit is less than the minimum gas limit.</li>
<li>MUST revert if the gas limit is greater than the maximum gas limit.</li>
<li>MUST update the gas limit.</li>
<li>MUST emit a ConfigUpdate event with the UpdateType.GAS_LIMIT type.</li>
</ul>
<h3 id="seteip1559params"><a class="header" href="#seteip1559params">setEIP1559Params</a></h3>
<p>Allows the owner to update the EIP-1559 parameters of the chain.</p>
<ul>
<li>MUST revert if called by an address other than the owner.</li>
<li>MUST revert if the denominator is less than 1.</li>
<li>MUST revert if the elasticity is less than 1.</li>
<li>MUST update the eip1559Denominator and eip1559Elasticity values.</li>
<li>MUST emit a ConfigUpdate event with the UpdateType.EIP_1559_PARAMS type.</li>
</ul>
<h3 id="setoperatorfeescalars"><a class="header" href="#setoperatorfeescalars">setOperatorFeeScalars</a></h3>
<p>Allows the owner to update the operator fee parameters.</p>
<ul>
<li>MUST revert if called by an address other than the owner.</li>
<li>MUST update the operatorFeeScalar and operatorFeeConstant values.</li>
<li>MUST emit a ConfigUpdate event with the UpdateType.OPERATOR_FEE_PARAMS type.</li>
</ul>
<h3 id="setminbasefee"><a class="header" href="#setminbasefee">setMinBaseFee</a></h3>
<p>Starting at Jovian, this function allows the owner to update the minimum base fee parameter.</p>
<ul>
<li>MUST revert if called by an address other than the owner.</li>
<li>MUST update the minBaseFee value.</li>
<li>MUST emit a ConfigUpdate event with the UpdateType.MIN_BASE_FEE type.</li>
</ul>
<h3 id="setdafootprintgasscalar"><a class="header" href="#setdafootprintgasscalar">setDAFootprintGasScalar</a></h3>
<p>Starting at Jovian, this function allows the owner to update the DA footprint gas scalar.</p>
<ul>
<li>MUST revert if called by an address other than the owner.</li>
<li>MUST update the daFootprintGasScalar value.</li>
<li>MUST emit a ConfigUpdate event with the UpdateType.DA_FOOTPRINT_GAS_SCALAR type.</li>
</ul>
<h3 id="resourceconfig"><a class="header" href="#resourceconfig">resourceConfig</a></h3>
<p>Returns the current resource metering configuration.</p>
<ul>
<li>MUST perform validation checks when setting the resource config:
<ul>
<li>Minimum base fee must be less than or equal to maximum base fee</li>
<li>Base fee change denominator must be greater than 1</li>
<li>Max resource limit plus system transaction gas must be less than or equal to the L2 gas limit</li>
<li>Elasticity multiplier must be greater than 0</li>
<li>No precision loss when computing target resource limit</li>
</ul>
</li>
</ul>
<h3 id="guardian-2"><a class="header" href="#guardian-2">guardian</a></h3>
<p>Returns the address of the guardian from the SuperchainConfig contract.</p>
<ul>
<li>MUST return the result of a call to <code>superchainConfig.guardian()</code>.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="op-stack-configurability"><a class="header" href="#op-stack-configurability">OP Stack Configurability</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/configurability.html#consensus-parameters">Consensus Parameters</a>
<ul>
<li><a href="protocol/configurability.html#batch-inbox-address">Batch Inbox address</a></li>
<li><a href="protocol/configurability.html#batcher-hash">Batcher Hash</a></li>
<li><a href="protocol/configurability.html#chain-id">Chain ID</a></li>
<li><a href="protocol/configurability.html#proof-maturity-delay">Proof Maturity Delay</a></li>
<li><a href="protocol/configurability.html#dispute-game-finality">Dispute Game Finality</a></li>
<li><a href="protocol/configurability.html#respected-game-type">Respected Game Type</a></li>
<li><a href="protocol/configurability.html#fault-game-max-depth">Fault Game Max Depth</a></li>
<li><a href="protocol/configurability.html#fault-game-split-depth">Fault Game Split Depth</a></li>
<li><a href="protocol/configurability.html#max-game-clock-duration">Max Game Clock Duration</a></li>
<li><a href="protocol/configurability.html#game-clock-extension">Game Clock Extension</a></li>
<li><a href="protocol/configurability.html#bond-withdrawal-delay">Bond Withdrawal Delay</a></li>
<li><a href="protocol/configurability.html#minimum-large-preimage-proposal-size">Minimum Large Preimage Proposal Size</a></li>
<li><a href="protocol/configurability.html#large-preimage-proposal-challenge-period">Large Preimage Proposal Challenge Period</a></li>
<li><a href="protocol/configurability.html#fault-game-absolute-prestate">Fault Game Absolute Prestate</a></li>
<li><a href="protocol/configurability.html#fault-game-genesis-block">Fault Game Genesis Block</a></li>
<li><a href="protocol/configurability.html#fault-game-genesis-output-root">Fault Game Genesis Output Root</a></li>
<li><a href="protocol/configurability.html#fee-scalar">Fee Scalar</a></li>
<li><a href="protocol/configurability.html#gas-limit">Gas Limit</a></li>
<li><a href="protocol/configurability.html#genesis-state">Genesis state</a></li>
<li><a href="protocol/configurability.html#l2-block-time">L2 block time</a></li>
<li><a href="protocol/configurability.html#resource-config">Resource config</a></li>
<li><a href="protocol/configurability.html#sequencing-window-size">Sequencing window Size</a></li>
<li><a href="protocol/configurability.html#start-block">Start block</a></li>
<li><a href="protocol/configurability.html#superchain-target">Superchain target</a></li>
<li><a href="protocol/configurability.html#governance-token">Governance Token</a></li>
<li><a href="protocol/configurability.html#operator-fee-scalar">Operator Fee Scalar</a></li>
<li><a href="protocol/configurability.html#operator-fee-constant">Operator Fee Constant</a></li>
<li><a href="protocol/configurability.html#da-footprint-gas-scalar">DA Footprint Gas Scalar</a></li>
<li><a href="protocol/configurability.html#minimum-base-fee">Minimum Base Fee</a></li>
<li><a href="protocol/configurability.html#resource-config">Resource Config</a></li>
</ul>
</li>
<li><a href="protocol/configurability.html#policy-parameters">Policy Parameters</a>
<ul>
<li><a href="protocol/configurability.html#data-availability-type">Data Availability Type</a></li>
<li><a href="protocol/configurability.html#batch-submission-frequency">Batch submission frequency</a></li>
<li><a href="protocol/configurability.html#output-frequency">Output frequency</a></li>
</ul>
</li>
<li><a href="protocol/configurability.html#admin-roles">Admin Roles</a>
<ul>
<li><a href="protocol/configurability.html#l1-proxy-admin">L1 Proxy Admin</a></li>
<li><a href="protocol/configurability.html#l1-proxyadmin-owner">L1 ProxyAdmin owner</a></li>
<li><a href="protocol/configurability.html#l2-proxy-admin">L2 Proxy Admin</a></li>
<li><a href="protocol/configurability.html#l2-proxyadmin-owner">L2 ProxyAdmin owner</a></li>
<li><a href="protocol/configurability.html#system-config-owner">System Config Owner</a></li>
</ul>
</li>
<li><a href="protocol/configurability.html#service-roles">Service Roles</a>
<ul>
<li><a href="protocol/configurability.html#batch-submitter-address">Batch submitter address</a></li>
<li><a href="protocol/configurability.html#challenger-address">Challenger address</a></li>
<li><a href="protocol/configurability.html#guardian-address">Guardian address</a></li>
<li><a href="protocol/configurability.html#proposer-address">Proposer address</a></li>
<li><a href="protocol/configurability.html#sequencer-p2p--unsafe-head-signer">Sequencer P2P / Unsafe head signer</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<p>When deploying the OP Stack software to a production environment,
certain parameters about the protocol can be configured. These
configurations can include a variety of parameters which affect the
resulting properties of the blockspace in question.</p>
<p>There are four categories of OP Stack configuration options:</p>
<ul>
<li><strong>Consensus Parameters</strong>: Parameters and properties of the chain that may
be set at genesis and fixed for the lifetime of the chain, or may be
changeable through a privileged account or protocol upgrade.</li>
<li><strong>Policy Parameters</strong>: Parameters of the chain that might be changed without
breaking consensus. Consensus is enforced by the protocol, while policy parameters
may be changeable within constraints imposed by consensus.</li>
<li><strong>Admin Roles</strong>: These roles can upgrade contracts, change role owners,
or update protocol parameters. These are typically cold/multisig wallets not
used directly in day to day operations.</li>
<li><strong>Service Roles</strong>: These roles are used to manage the day-to-day
operations of the chain, and therefore are often hot wallets.</li>
</ul>
<p>Each category also defines the standard configuration values for it's given parameters.
Standard configuration is the set of requirements for an OP Stack chain to be considered a
Standard Chain within the superchain.
These requirements are currently a draft, pending governance approval.</p>
<p>The recommended way to deploy L1 contracts for an OP chain that meet the standard configuration will be with the
<a href="protocol/../experimental/op-contracts-manager.html">OP Contracts Manager</a>.</p>
<h2 id="consensus-parameters"><a class="header" href="#consensus-parameters">Consensus Parameters</a></h2>
<h3 id="batch-inbox-address"><a class="header" href="#batch-inbox-address"><a href="https://github.com/ethereum-optimism/optimism/blob/c927ed9e8af501fd330349607a2b09a876a9a1fb/packages/contracts-bedrock/src/L1/SystemConfig.sol#L176">Batch Inbox address</a></a></h3>
<p><strong>Description:</strong> L1 address where calldata/blobs are posted (
see <a href="protocol/../glossary.html#batcher-transaction">Batcher Transaction</a>).<br/>
<strong>Administrator:</strong> Static<br/>
<strong>Requirement:</strong> Current convention is
<code>versionByte || keccak256(bytes32(chainId))[:19]</code>, where <code>||</code> denotes
concatenation, <code>versionByte</code> is <code>0x00</code>, and <code>chainId</code> is a <code>uint256</code>.<br/>
<strong>Notes:</strong> It is recommended, but not required, to follow this convention.</p>
<h3 id="batcher-hash-1"><a class="header" href="#batcher-hash-1"><a href="protocol/./system-config.html#batcher-hash">Batcher Hash</a></a></h3>
<p><strong>Description:</strong> A versioned hash of the current authorized batcher sender(s).<br/>
<strong>Administrator:</strong> <a href="protocol/configurability.html#admin-roles">System Config Owner</a><br/>
<strong>Requirement:</strong> <code>bytes32(uint256(uint160(batchSubmitterAddress)))</code><br/>
<strong>Notes</strong>: <a href="protocol/../protocol/batcher.html">Batch Submitter</a> address padded with zeros to fit 32 bytes.<br/></p>
<h3 id="chain-id"><a class="header" href="#chain-id"><a href="https://github.com/ethereum-optimism/superchain-registry/blob/2a011e700e8be22bc18502f3d41c440e7a05015d/chainList.json">Chain ID</a></a></h3>
<p><strong>Description:</strong> Unique ID of Chain used for TX signature validation.<br/>
<strong>Administrator:</strong> Static<br/>
<strong>Requirement:</strong> Foundation-approved, globally unique value <sup class="footnote-reference"><a href="#chain-id-uniqueness">1</a></sup>.<br/>
<strong>Notes:</strong> Foundation will ensure chains are responsible with their chain IDs until there's a governance process in
place.<br/></p>
<h3 id="proof-maturity-delay-1"><a class="header" href="#proof-maturity-delay-1"><a href="protocol/../fault-proof/stage-one/bridge-integration.html#fpac-optimismportal-mods-specification">Proof Maturity Delay</a></a></h3>
<p><strong>Description:</strong> The length of time that must pass between proving and finalizing a withdrawal.<br/>
<strong>Administrator:</strong> <a href="protocol/configurability.html#admin-roles">L1 Proxy Admin</a><br/>
<strong>Requirement:</strong> 7 days<br/>
<strong>Notes:</strong> High security. Excessively safe upper bound that leaves enough time to consider social layer solutions to a
hack if necessary. Allows enough time for other network participants to challenge the integrity of the corresponding
output root.<br/></p>
<h3 id="dispute-game-finality"><a class="header" href="#dispute-game-finality"><a href="protocol/../fault-proof/stage-one/bridge-integration.html#fpac-optimismportal-mods-specification">Dispute Game Finality</a></a></h3>
<p><strong>Description:</strong> The amount of time given to the <code>Guardian</code> role
to <a href="protocol/../fault-proof/stage-one/bridge-integration.html#blacklisting-disputegames">blacklist a resolved dispute game</a> before
any withdrawals proven against it can be finalized, in the case of a system failure.<br/>
<strong>Administrator:</strong> <a href="protocol/configurability.html#admin-roles">L1 Proxy Admin</a><br/>
<strong>Requirement:</strong> 3.5 days<br/>
<strong>Notes:</strong> High security. Allows enough time for the <code>Guardian</code> to blacklist games.<br/></p>
<h3 id="respected-game-type-2"><a class="header" href="#respected-game-type-2"><a href="protocol/../fault-proof/stage-one/bridge-integration.html#new-state-variables">Respected Game Type</a></a></h3>
<p><strong>Description:</strong> The respected game type of the <code>OptimismPortal</code>. Determines the type of dispute games that can be used
to finalize withdrawals.<br/>
<strong>Administrator:</strong> <a href="protocol/configurability.html#service-roles">Guardian</a><br/>
<strong>Requirement:</strong> <a href="https://github.com/ethereum-optimism/optimism/blob/op-contracts/v1.5.0/packages/contracts-bedrock/src/dispute/lib/Types.sol#L28"><code>CANNON</code> (
<code>0</code>)</a><br/>
<strong>Notes:</strong> The game type may be changed to <a href="https://github.com/ethereum-optimism/optimism/blob/op-contracts/v1.5.0/packages/contracts-bedrock/src/dispute/lib/Types.sol#L31"><code>PERMISSIONED_CANNON</code> (
<code>1</code>)</a>
as a fallback to permissioned proposals, in the event of a failure in the Fault Proof system.<br/></p>
<h3 id="fault-game-max-depth"><a class="header" href="#fault-game-max-depth">Fault Game Max Depth</a></h3>
<p><strong>Description:</strong> The maximum depth of fault
dispute <a href="https://specs.optimism.io/fault-proof/stage-one/fault-dispute-game.html#game-tree">game trees</a>.<br/>
<strong>Administrator:</strong> Static<br/>
<strong>Requirement:</strong> 73<br/>
<strong>Notes:</strong> Sufficiently large to ensure the fault proof VM execution trace fits within the number of leaf nodes.<br/></p>
<h3 id="fault-game-split-depth"><a class="header" href="#fault-game-split-depth">Fault Game Split Depth</a></h3>
<p><strong>Description:</strong> The depth in fault
dispute <a href="https://specs.optimism.io/fault-proof/stage-one/fault-dispute-game.html#game-tree">game trees</a> after which
claims correspond to VM state commitments instead of output root commitments.<br/>
<strong>Administrator:</strong> Static<br/>
<strong>Requirement:</strong> 30<br/>
<strong>Notes:</strong> Sufficiently large to ensure enough nodes at the split depth to represent all L2 blocks since the anchor
state.<br/></p>
<h3 id="max-game-clock-duration"><a class="header" href="#max-game-clock-duration"><a href="https://specs.optimism.io/fault-proof/stage-one/fault-dispute-game.html#max_clock_duration">Max Game Clock Duration</a></a></h3>
<p><strong>Description:</strong> The maximum amount of time that may accumulate on a dispute game team's chess clock.<br/>
<strong>Administrator:</strong> Static<br/>
<strong>Requirement:</strong> 3.5 days<br/>
<strong>Notes:</strong> High security. Allows enough time for honest actors to counter invalid claims.<br/></p>
<h3 id="game-clock-extension"><a class="header" href="#game-clock-extension"><a href="https://specs.optimism.io/fault-proof/stage-one/fault-dispute-game.html#clock_extension">Game Clock Extension</a></a></h3>
<p><strong>Description:</strong> The flat credit that is given to a dispute game team's clock if their clock has less than
CLOCK_EXTENSION seconds remaining.<br/>
<strong>Administrator:</strong> Static<br/>
<strong>Requirement:</strong> 3 hours<br/>
<strong>Notes:</strong> Allows enough time for honest actors to counter freeloader claims.<br/></p>
<h3 id="bond-withdrawal-delay"><a class="header" href="#bond-withdrawal-delay"><a href="https://specs.optimism.io/fault-proof/stage-one/bond-incentives.html#delay-period">Bond Withdrawal Delay</a></a></h3>
<p><strong>Description:</strong> The length of time that must pass before dispute game bonds can be withdrawn.<br/>
<strong>Administrator:</strong> Static<br/>
<strong>Requirement:</strong> 7 days<br/>
<strong>Notes:</strong> High security. Allows enough time for the <code>Guardian</code> to recover funds from <code>DelayedWETH</code> if bonds were
allocated incorrectly.<br/></p>
<h3 id="minimum-large-preimage-proposal-size"><a class="header" href="#minimum-large-preimage-proposal-size"><a href="https://specs.optimism.io/fault-proof/stage-one/fault-dispute-game.html#preimageoracle-interaction">Minimum Large Preimage Proposal Size</a></a></h3>
<p><strong>Description:</strong> The minimum size of preimage allowed to be submitted via the PreimageOracle large preimage proposal
process.<br/>
<strong>Administrator:</strong> Static<br/>
<strong>Requirement:</strong> 126000 bytes<br/>
<strong>Notes:</strong> Large enough to ensure posting the large preimage is expensive enough to act as a deterrent but small enough
to be used for any preimage that is too large to be submitted in a single transaction.<br/></p>
<h3 id="large-preimage-proposal-challenge-period"><a class="header" href="#large-preimage-proposal-challenge-period"><a href="https://specs.optimism.io/fault-proof/stage-one/fault-dispute-game.html#preimageoracle-interaction">Large Preimage Proposal Challenge Period</a></a></h3>
<p><strong>Description:</strong> The amount of time that large preimage proposals can be challenged before they can be published to the
<code>PreimageOracle</code><br/>
<strong>Administrator:</strong> Static<br/>
<strong>Requirement:</strong> 24 hours<br/>
<strong>Notes:</strong> High security. Allows enough time for honest actors to challenge invalid large preimage proposals.<br/></p>
<h3 id="fault-game-absolute-prestate"><a class="header" href="#fault-game-absolute-prestate"><a href="https://specs.optimism.io/fault-proof/stage-one/fault-dispute-game.html#execution-trace">Fault Game Absolute Prestate</a></a></h3>
<p><strong>Description:</strong> The VM state commitment to use as the starting point when executing the fault proof VM<br/>
<strong>Administrator:</strong> Static<br/>
<strong>Requirement:</strong> The state commitment of a governance approved op-program release.<br/>
<strong>Notes:</strong> The op-program version must have the rollup config and L2 genesis of the chain built in via the superchain
registry.<br/></p>
<h3 id="fault-game-genesis-block"><a class="header" href="#fault-game-genesis-block"><a href="https://specs.optimism.io/fault-proof/stage-one/fault-dispute-game.html#anchor-state">Fault Game Genesis Block</a></a></h3>
<p><strong>Description:</strong> The L2 block number used as the initial anchor state for fault dispute games<br/>
<strong>Administrator:</strong> Static<br/>
<strong>Requirement:</strong> Block number of any finalized block between bedrock activation and enabling fault proofs. 0 for chains
using fault proofs from genesis.<br/></p>
<h3 id="fault-game-genesis-output-root"><a class="header" href="#fault-game-genesis-output-root"><a href="https://specs.optimism.io/fault-proof/stage-one/fault-dispute-game.html#anchor-state">Fault Game Genesis Output Root</a></a></h3>
<p><strong>Description:</strong> The output root at the Fault Game Genesis Block<br/>
<strong>Administrator:</strong> Static<br/>
<strong>Requirement:</strong> The output root from the canonical chain at Fault game Genesis Block.<br/></p>
<h3 id="fee-scalar"><a class="header" href="#fee-scalar"><a href="https://github.com/ethereum-optimism/optimism/blob/c927ed9e8af501fd330349607a2b09a876a9a1fb/packages/contracts-bedrock/src/L1/SystemConfig.sol#L288-L294">Fee Scalar</a></a></h3>
<p><strong>Description:</strong> Markup on transactions compared to the raw L1 data cost.<br/>
<strong>Administrator:</strong> <a href="protocol/configurability.html#admin-roles">System Config Owner</a><br/>
<strong>Requirement:</strong> Set such that Fee Margin is between 0 and 50%.<br/></p>
<h3 id="gas-limit"><a class="header" href="#gas-limit"><a href="protocol/./system-config.html#l2-gas-limit">Gas Limit</a></a></h3>
<p><strong>Description:</strong> Gas limit of the L2 blocks is configured through the system config.<br/>
<strong>Administrator:</strong> <a href="protocol/configurability.html#admin-roles">System Config Owner</a><br/>
<strong>Requirement:</strong> No higher than 200_000_000 gas<br/>
<strong>Notes:</strong> Chain operators are driven to maintain a stable and reliable chain. When considering to change this value,
careful deliberation is necessary.<br/></p>
<h3 id="genesis-state"><a class="header" href="#genesis-state">Genesis state</a></h3>
<p><strong>Description:</strong> Initial state at chain genesis, including code and storage of predeploys (all L2 smart contracts).
See <a href="protocol/../glossary.html#l2-genesis-block">Predeploy</a>.<br/>
<strong>Administrator:</strong> Static<br/>
<strong>Requirement:</strong> Only standard predeploys and preinstalls, no additional state.<br/>
<strong>Notes:</strong> Homogeneity &amp; standardization, ensures initial state is secure.<br/></p>
<h3 id="l2-block-time"><a class="header" href="#l2-block-time"><a href="https://github.com/ethereum-optimism/optimism/blob/c927ed9e8af501fd330349607a2b09a876a9a1fb/packages/contracts-bedrock/src/L1/L2OutputOracle.sol#L105">L2 block time</a></a></h3>
<p><strong>Description:</strong> Frequency with which blocks are produced as a result of derivation.<br/>
<strong>Administrator:</strong> <a href="protocol/configurability.html#admin-roles">L1 Proxy Admin</a><br/>
<strong>Requirement:</strong> 1 or 2 seconds<br/>
<strong>Notes:</strong> High security &amp; <a href="protocol/../interop/overview.html">interoperability</a> compatibility requirement, until de-risked/solved
at app layer.<br/></p>
<h3 id="resource-config"><a class="header" href="#resource-config"><a href="https://github.com/ethereum-optimism/optimism/blob/c927ed9e8af501fd330349607a2b09a876a9a1fb/packages/contracts-bedrock/src/L1/SystemConfig.sol#L338-L340">Resource config</a></a></h3>
<p><strong>Description:</strong> Config for the EIP-1559 based curve used for the deposit gas market.<br/>
<strong>Administrator:</strong> <a href="protocol/configurability.html#admin-roles">L1 Proxy Admin</a><br/>
<strong>Requirement:</strong> See <a href="protocol/configurability.html#resource-config">resource config table</a>.<br/>
<strong>Notes:</strong> Constraints are imposed
in <a href="https://github.com/ethereum-optimism/optimism/blob/c927ed9e8af501fd330349607a2b09a876a9a1fb/packages/contracts-bedrock/src/L1/SystemConfig.sol#L345-L365">code</a>
when setting the resource config.<br/></p>
<h3 id="sequencing-window-size"><a class="header" href="#sequencing-window-size"><a href="protocol/../glossary.html#sequencing-window">Sequencing window Size</a></a></h3>
<p><strong>Description:</strong> Maximum allowed batch submission gap, after which L1 fallback is triggered in derivation.<br/>
<strong>Administrator:</strong> Static<br/>
<strong>Requirement:</strong> 3_600 base layer blocks (12 hours for an L2 on Ethereum, assuming 12 second L1 blocktime). e.g. 12
second blocks, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3600</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord">12</span><span class="mspace">Â </span><span class="mord mathnormal">seco</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã·</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.2251em;vertical-align:-0.345em;"></span><span class="mord">60</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">min</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">e</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">seco</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã·</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.2007em;vertical-align:-0.345em;"></span><span class="mord">60</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8557em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">min</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord">12</span><span class="mspace">Â </span><span class="mord mathnormal">h</span><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">rs</span></span></span></span>.<br/>
<strong>Notes:</strong> This is an important value for constraining the sequencer's ability to re-order transactions; higher values
would pose a risk to user protections.<br/></p>
<h3 id="start-block"><a class="header" href="#start-block"><a href="https://github.com/ethereum-optimism/optimism/blob/c927ed9e8af501fd330349607a2b09a876a9a1fb/packages/contracts-bedrock/src/L1/SystemConfig.sol#L184">Start block</a></a></h3>
<p><strong>Description:</strong> Block at which the system config was initialized the first time.<br/>
<strong>Administrator:</strong> <a href="protocol/configurability.html#admin-roles">L1 Proxy Admin</a><br/>
<strong>Requirement:</strong> The block where the SystemConfig was initialized.<br/>
<strong>Notes:</strong> Simple clear restriction.<br/></p>
<h3 id="superchain-target-1"><a class="header" href="#superchain-target-1"><a href="protocol/../protocol/superchain-upgrades.html#superchain-target">Superchain target</a></a></h3>
<p><strong>Description:</strong> Choice of cross-L2 configuration. May be omitted in isolated OP Stack deployments. Includes
SuperchainConfig and ProtocolVersions contract addresses.<br/>
<strong>Administrator:</strong> Static<br/>
<strong>Requirement:</strong> Mainnet or Sepolia<br/>
<strong>Notes:</strong> A superchain target defines a set of layer 2 chains which share <code>SuperchainConfig</code> and <code>ProtocolVersions</code>
contracts deployed on layer 1.<br/></p>
<h3 id="governance-token-1"><a class="header" href="#governance-token-1">Governance Token</a></h3>
<p><strong>Description:</strong> OP token used for the Optimism Collective's Token House governance.<br/>
<strong>Administrator:</strong> n/a<br/>
<strong>Requirement:</strong> Disabled<br/>
<strong>Notes:</strong> Simple clear restriction.<br/></p>
<h3 id="operator-fee-scalar"><a class="header" href="#operator-fee-scalar"><a href="protocol/isthmus/exec-engine.html#operator-fee">Operator Fee Scalar</a></a></h3>
<p><strong>Description:</strong> Operator fee scalar -- used to calculate the operator fee<br/>
<strong>Administrator:</strong> <a href="protocol/configurability.html#admin-roles">System Config Owner</a><br/>
<strong>Requirement:</strong> 0 <br/></p>
<h3 id="operator-fee-constant"><a class="header" href="#operator-fee-constant"><a href="protocol/isthmus/exec-engine.html#operator-fee">Operator Fee Constant</a></a></h3>
<p><strong>Description:</strong> Operator fee constant -- used to calculate the operator fee<br/>
<strong>Administrator:</strong> <a href="protocol/configurability.html#admin-roles">System Config Owner</a><br/>
<strong>Requirement:</strong> 0 <br/></p>
<p>Note that the operator fee scalar and constant are primarily used for non-standard configurations,
like op-succinct, so their standard values are 0.</p>
<h3 id="da-footprint-gas-scalar"><a class="header" href="#da-footprint-gas-scalar"><a href="protocol/jovian/exec-engine.html#DA-footprint-block-limit">DA Footprint Gas Scalar</a></a></h3>
<p><strong>Description:</strong> DA footprint gas scalar -- used to calculate the DA footprint<br/>
<strong>Administrator:</strong> <a href="protocol/configurability.html#admin-roles">System Config Owner</a><br/>
<strong>Requirement:</strong> Requirements (if any) are declared in <a href="https://github.com/ethereum-optimism/superchain-registry/blob/main/validation/standard/standard-config-params-mainnet.toml">https://github.com/ethereum-optimism/superchain-registry/blob/main/validation/standard/standard-config-params-mainnet.toml</a></p>
<h3 id="minimum-base-fee"><a class="header" href="#minimum-base-fee"><a href="protocol/jovian/exec-engine.html#minimum-base-fee">Minimum Base Fee</a></a></h3>
<p><strong>Description:</strong> Minimum base fee -- sets the minimum base fee on L2<br/>
<strong>Administrator:</strong> <a href="protocol/configurability.html#admin-roles">System Config Owner</a><br/>
<strong>Requirement:</strong> Requirements (if any) are declared in <a href="https://github.com/ethereum-optimism/superchain-registry/blob/main/validation/standard/standard-config-params-mainnet.toml">https://github.com/ethereum-optimism/superchain-registry/blob/main/validation/standard/standard-config-params-mainnet.toml</a></p>
<div class="footnote-definition" id="chain-id-uniqueness"><sup class="footnote-definition-label">1</sup>
<p>The chain ID must be globally unique among all EVM chains.</p>
</div>
<h3 id="resource-config-1"><a class="header" href="#resource-config-1">Resource Config</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Config Property</th><th>Standard Config Requirement</th></tr></thead><tbody>
<tr><td>maxResourceLimit</td><td><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">7</span></span></span></span></span></span></span></span></span></span></span></td></tr>
<tr><td>elasticityMultiplier</td><td><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">10</span></span></span></span></td></tr>
<tr><td>baseFeeMaxChangeDenominator</td><td><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">8</span></span></span></span></td></tr>
<tr><td>minimumBaseFee</td><td><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">9</span></span></span></span></span></span></span></span></span></span></span></td></tr>
<tr><td>systemTxMaxGas</td><td><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">6</span></span></span></span></span></span></span></span></span></span></span></td></tr>
<tr><td>maximumBaseFee</td><td><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">128</span></span></span></span></span></span></span></span></span></span></span></span>-1</td></tr>
</tbody></table>
</div>
<h2 id="policy-parameters"><a class="header" href="#policy-parameters">Policy Parameters</a></h2>
<h3 id="data-availability-type"><a class="header" href="#data-availability-type">Data Availability Type</a></h3>
<p><strong>Description:</strong> Batcher can currently be configured to use blobs or calldata (
See <a href="protocol/../glossary.html#data-availability-provider">Data Availability Provider</a>).<br/>
<strong>Administrator:</strong> <a href="protocol/configurability.html#service-roles">Batch submitter address</a><br/>
<strong>Requirement:</strong> Ethereum (Blobs, Calldata)<br/>
<strong>Notes:</strong> Alt-DA is not yet supported for the standard configuration, but the sequencer can switch at-will between blob
and calldata with no restriction, since both are L1 security.<br/></p>
<h3 id="batch-submission-frequency"><a class="header" href="#batch-submission-frequency">Batch submission frequency</a></h3>
<p><strong>Description:</strong> Frequency with which batches are submitted to L1 (
see <a href="protocol/../glossary.html#batcher-transaction">Batcher Transaction</a>).<br/>
<strong>Administrator:</strong> <a href="protocol/configurability.html#service-roles">Batch submitter address</a><br/>
<strong>Requirement:</strong> 1_800 base layer blocks (6 hours for an L2 on Ethereum, assuming 12 second L1 blocktime) or lower<br/>
<strong>Notes:</strong> Batcher needs to fully submit each batch within the sequencing window, so this leaves buffer to account for
L1 network congestion and the amount of data the batcher would need to post.<br/></p>
<h3 id="output-frequency"><a class="header" href="#output-frequency"><a href="https://github.com/ethereum-optimism/optimism/blob/c927ed9e8af501fd330349607a2b09a876a9a1fb/packages/contracts-bedrock/src/L1/L2OutputOracle.sol#L104">Output frequency</a></a></h3>
<p><strong>Description:</strong> Frequency with which output roots are submitted to L1.<br/>
<strong>Administrator:</strong> <a href="protocol/configurability.html#admin-roles">L1 Proxy Admin</a><br/>
<strong>Requirement:</strong> 43_200 L2 Blocks (24 hours for an L2 on Ethereum, assuming 2 second L2 blocktime) or lower e.g. 2
second blocks, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">43200</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord">2</span><span class="mspace">Â </span><span class="mord mathnormal">seco</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã·</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.2251em;vertical-align:-0.345em;"></span><span class="mord">60</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">min</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">e</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">seco</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã·</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.2007em;vertical-align:-0.345em;"></span><span class="mord">60</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8557em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">min</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord">24</span><span class="mspace">Â </span><span class="mord mathnormal">h</span><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">rs</span></span></span></span>.<br/>
<strong>Notes:</strong> Deprecated once fault proofs are implemented. This value cannot be 0.<br/></p>
<h2 id="admin-roles"><a class="header" href="#admin-roles">Admin Roles</a></h2>
<h3 id="l1-proxy-admin"><a class="header" href="#l1-proxy-admin">L1 Proxy Admin</a></h3>
<p><strong>Description:</strong> Account authorized to upgrade L1 contracts.<br/>
<strong>Administrator:</strong> <a href="protocol/configurability.html#admin-roles">L1 Proxy Admin Owner</a><br/>
<strong>Administers:</strong> <a href="protocol/configurability.html#consensus-parameters">Batch Inbox Address</a>, <a href="protocol/configurability.html#consensus-parameters">Start block</a>,
<a href="protocol/configurability.html#service-roles">Proposer address</a>, <a href="protocol/configurability.html#service-roles">Challenger address</a>, <a href="protocol/configurability.html#service-roles">Guardian address</a>,
<a href="protocol/configurability.html#consensus-parameters">Proof Maturity Delay</a>, <a href="protocol/configurability.html#consensus-parameters">Dispute Game Finality</a>,
<a href="protocol/configurability.html#policy-parameters">Output frequency</a>, <a href="protocol/configurability.html#consensus-parameters">L2 block time</a>,
<a href="protocol/configurability.html#consensus-parameters">L1 smart contracts</a><br/>
<strong>Requirement:</strong>
<a href="https://github.com/ethereum-optimism/optimism/blob/op-contracts/v1.3.0/packages/contracts-bedrock/src/universal/ProxyAdmin.sol">ProxyAdmin.sol</a>
from the latest <code>op-contracts/vX.Y.X</code> release of source code in
<a href="https://github.com/ethereum-optimism/optimism">Optimism repository</a>.<br/>
<strong>Notes:</strong> Governance-controlled, high security.<br/></p>
<h3 id="l1-proxyadmin-owner"><a class="header" href="#l1-proxyadmin-owner">L1 ProxyAdmin owner</a></h3>
<p><strong>Description:</strong> Account authorized to update the L1 Proxy Admin.<br/>
<strong>Administrator:</strong> <br/>
<strong>Administers:</strong> <a href="protocol/configurability.html#admin-roles">L1 Proxy Admin</a><br/>
<strong>Requirement:</strong>
<a href="https://etherscan.io/address/0x5a0Aae59D09fccBdDb6C6CcEB07B7279367C3d2A">0x5a0Aae59D09fccBdDb6C6CcEB07B7279367C3d2A</a>
<sup class="footnote-reference"><a href="#of-sc-gnosis-safe-l1">2</a></sup><br/>
<strong>Notes:</strong> Governance-controlled, high security.<br/></p>
<h3 id="l2-proxy-admin"><a class="header" href="#l2-proxy-admin">L2 Proxy Admin</a></h3>
<p><strong>Description:</strong> Account authorized to upgrade L2 contracts.<br/>
<strong>Administrator:</strong> <a href="protocol/configurability.html#admin-roles">L2 Proxy Admin Owner</a><br/>
<strong>Administers:</strong> <a href="protocol/./predeploys.html#overview">Predeploys</a><br/>
<strong>Requirement:</strong>
<a href="https://github.com/ethereum-optimism/optimism/blob/op-contracts/v1.3.0/packages/contracts-bedrock/src/universal/ProxyAdmin.sol">ProxyAdmin.sol</a>
from the latest <code>op-contracts/vX.Y.X</code> release of source code
in <a href="https://github.com/ethereum-optimism/optimism">Optimism repository</a>. Predeploy
address: <a href="https://docs.optimism.io/chain/addresses#op-mainnet-l2">0x4200000000000000000000000000000000000018</a>.<br/>
<strong>Notes:</strong> Governance-controlled, high security.<br/></p>
<h3 id="l2-proxyadmin-owner"><a class="header" href="#l2-proxyadmin-owner">L2 ProxyAdmin owner</a></h3>
<p><strong>Description:</strong> Account authorized to upgrade protocol contracts via calls to the <code>ProxyAdmin</code>. This is the aliased L1
ProxyAdmin owner address.<br/>
<strong>Administrator:</strong> <br/>
<strong>Administers:</strong> <a href="protocol/configurability.html#admin-roles">L2 Proxy Admin</a><br/>
<strong>Requirement:</strong> Gnosis Safe between Optimism Foundation (OF) and the Security Council (SC). Aliased
Address:
<a href="https://optimistic.etherscan.io/address/0x6B1BAE59D09fCcbdDB6C6cceb07B7279367C4E3b">0x6B1BAE59D09fCcbdDB6C6cceb07B7279367C4E3b</a>
<sup class="footnote-reference"><a href="#aliased-of-sc-gnosis-safe-l1">3</a></sup><br/>
<strong>Notes:</strong> Governance-controlled, high security.<br/></p>
<h3 id="system-config-owner"><a class="header" href="#system-config-owner"><a href="https://github.com/ethereum-optimism/optimism/blob/c927ed9e8af501fd330349607a2b09a876a9a1fb/packages/contracts-bedrock/src/L1/SystemConfig.sol#L14C26-L14C44">System Config Owner</a></a></h3>
<p><strong>Description:</strong> Account authorized to change values in the SystemConfig contract. All configuration is stored on L1 and
picked up by L2 as part of the <a href="protocol/./derivation.html">derivation</a> of the L2 chain.<br/>
<strong>Administrator:</strong> <a href="protocol/configurability.html#admin-roles">L1 Proxy Admin</a><br/>
<strong>Administers:</strong> <a href="protocol/configurability.html#service-roles">Batch submitter address</a>, <a href="protocol/configurability.html#service-roles">Sequencer P2P / Unsafe head signer</a>,
<a href="protocol/configurability.html#consensus-parameters">Fee Margin</a>, <a href="protocol/configurability.html#consensus-parameters">Gas limit</a>, <a href="protocol/configurability.html#admin-roles">System Config Owner</a><br/>
<strong>Requirement:</strong> Chain Governor or Servicer<br/>
<strong>Notes:</strong> As defined in
the <a href="https://github.com/ethereum-optimism/OPerating-manual/blob/main/Law%20of%20Chains.md">Law of Chains</a><br/></p>
<div class="footnote-definition" id="of-sc-gnosis-safe-l1"><sup class="footnote-definition-label">2</sup>
<p>2 of 2 GnosisSafe between Optimism Foundation (OF) and the Security Council (SC) on L1. Mainnet and Sepolia addresses can be found at <a href="https://docs.optimism.io/chain/security/privileged-roles#l1-proxy-admin">privileged roles</a>.</p>
</div>
<div class="footnote-definition" id="aliased-of-sc-gnosis-safe-l1"><sup class="footnote-definition-label">3</sup>
<p>Aliased address of the 2 of 2 Gnosis Safe between Optimism Foundation (OF) and the Security Council (SC) on L1. The reason for aliasing can be found in the <a href="protocol/../glossary.html#address-aliasing">glossary</a>. This address was calculated using the following arithmetic: <code>0x5a0Aae59D09fccBdDb6C6CcEB07B7279367C3d2A</code> + <code>0x1111000000000000000000000000000000001111</code> = <code>0x6B1BAE59D09fCcbdDB6C6cceb07B7279367C4E3b</code>.</p>
</div>
<h2 id="service-roles"><a class="header" href="#service-roles">Service Roles</a></h2>
<h3 id="batch-submitter-address"><a class="header" href="#batch-submitter-address"><a href="https://github.com/ethereum-optimism/optimism/blob/c927ed9e8af501fd330349607a2b09a876a9a1fb/packages/contracts-bedrock/src/L1/SystemConfig.sol#L265">Batch submitter address</a></a></h3>
<p><strong>Description:</strong> Account which authenticates new batches submitted to L1 Ethereum.<br/>
<strong>Administrator:</strong> <a href="protocol/configurability.html#admin-roles">System Config Owner</a><br/>
<strong>Requirement:</strong> No requirement<br/>
<strong>Notes:</strong> <br/></p>
<h3 id="challenger-address"><a class="header" href="#challenger-address"><a href="https://github.com/ethereum-optimism/optimism/blob/op-contracts/v1.5.0/packages/contracts-bedrock/src/dispute/PermissionedDisputeGame.sol#L23">Challenger address</a></a></h3>
<p><strong>Description:</strong> Account which can interact with
existing <a href="protocol/../fault-proof/stage-one/bridge-integration.html#permissioned-faultdisputegame">permissioned dispute games</a>.<br/>
<strong>Administrator:</strong> <a href="protocol/configurability.html#admin-roles">L1 Proxy Admin</a><br/>
<strong>Requirement:</strong>
<a href="https://etherscan.io/address/0x9BA6e03D8B90dE867373Db8cF1A58d2F7F006b3A">0x9BA6e03D8B90dE867373Db8cF1A58d2F7F006b3A</a>
<sup class="footnote-reference"><a href="#of-gnosis-safe-l1">4</a></sup><br/>
<strong>Notes:</strong> Optimism Foundation (OF) multisig
leveraging <a href="https://github.com/safe-global/safe-smart-account">battle-tested software</a>. This role is only active when
the <code>OptimismPortal</code> respected game type is [<code>PERMISSIONED_CANNON</code>]
(<a href="https://github.com/ethereum-optimism/optimism/blob/op-contracts/v1.5.0/packages/contracts-bedrock/src/dispute/lib/Types.sol#L31">https://github.com/ethereum-optimism/optimism/blob/op-contracts/v1.5.0/packages/contracts-bedrock/src/dispute/lib/Types.sol#L31</a>).<br/></p>
<h3 id="guardian-address"><a class="header" href="#guardian-address"><a href="https://github.com/ethereum-optimism/optimism/blob/c927ed9e8af501fd330349607a2b09a876a9a1fb/packages/contracts-bedrock/src/L1/SuperchainConfig.sol#L50">Guardian address</a></a></h3>
<p><strong>Description:</strong> Account authorized to pause L1 withdrawals from contracts, blacklist dispute games, and set the
respected game type in the <code>OptimismPortal</code>.<br/>
<strong>Administrator:</strong> <a href="protocol/configurability.html#admin-roles">L1 Proxy Admin</a><br/>
<strong>Requirement:</strong>
<a href="https://etherscan.io/address/0x09f7150D8c019BeF34450d6920f6B3608ceFdAf2">0x09f7150D8c019BeF34450d6920f6B3608ceFdAf2</a><br/>
<strong>Notes:</strong> A 1/1 Safe owned by the Security Council Safe, with
the <a href="protocol/./deputy-pause-module.html">Deputy Pause Module</a> enabled to allow the Optimism
Foundation to act as <a href="protocol/./stage-1.html#pause-deputy">Pause Deputy</a>.<br/></p>
<h3 id="proposer-address"><a class="header" href="#proposer-address"><a href="https://github.com/ethereum-optimism/optimism/blob/op-contracts/v1.5.0/packages/contracts-bedrock/src/dispute/PermissionedDisputeGame.sol#L20">Proposer address</a></a></h3>
<p><strong>Description:</strong> Account which can create and interact
with <a href="protocol/../fault-proof/stage-one/bridge-integration.html#permissioned-faultdisputegame">permissioned dispute games</a> on
L1.<br/>
<strong>Administrator:</strong> <a href="protocol/configurability.html#admin-roles">L1 Proxy Admin</a><br/>
<strong>Requirement:</strong> No requirement<br/>
<strong>Notes:</strong> This role is only active when the <code>OptimismPortal</code> respected game type is [<code>PERMISSIONED_CANNON</code>]
(<a href="https://github.com/ethereum-optimism/optimism/blob/op-contracts/v1.5.0/packages/contracts-bedrock/src/dispute/lib/Types.sol#L31">https://github.com/ethereum-optimism/optimism/blob/op-contracts/v1.5.0/packages/contracts-bedrock/src/dispute/lib/Types.sol#L31</a>).
The <code>L1ProxyAdmin</code> sets the implementation of the <code>PERMISSIONED_CANNON</code> game type. Thus, it determines the proposer
configuration of the permissioned dispute game.<br/></p>
<h3 id="sequencer-p2p--unsafe-head-signer"><a class="header" href="#sequencer-p2p--unsafe-head-signer"><a href="https://github.com/ethereum-optimism/optimism/blob/c927ed9e8af501fd330349607a2b09a876a9a1fb/packages/contracts-bedrock/src/L1/SystemConfig.sol#L250">Sequencer P2P / Unsafe head signer</a></a></h3>
<p><strong>Description:</strong> Account which authenticates the unsafe/pre-submitted blocks for a chain at the P2P layer.<br/>
<strong>Administrator:</strong> <a href="protocol/configurability.html#admin-roles">System Config Owner</a><br/>
<strong>Requirement:</strong> No requirement<br/>
<strong>Notes:</strong> <br/></p>
<div class="footnote-definition" id="of-gnosis-safe-l1"><sup class="footnote-definition-label">4</sup>
<p>5 of 7 GnosisSafe controlled by Optimism Foundation (OF). Mainnet and Sepolia addresses can be found at <a href="https://docs.optimism.io/chain/security/privileged-roles">privileged roles</a>.</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="safe-contract-extensions"><a class="header" href="#safe-contract-extensions">Safe Contract Extensions</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/safe-extensions.html#security-council-liveness-checking-extensions">Security Council Liveness Checking Extensions</a>
<ul>
<li><a href="protocol/safe-extensions.html#the-liveness-guard">The Liveness Guard</a></li>
<li><a href="protocol/safe-extensions.html#the-liveness-module">The Liveness Module</a></li>
<li><a href="protocol/safe-extensions.html#owner-removal-call-flow">Owner Removal Call Flow</a></li>
<li><a href="protocol/safe-extensions.html#shutdown">Shutdown</a></li>
<li><a href="protocol/safe-extensions.html#liveness-security-properties">Liveness Security Properties</a>
<ul>
<li><a href="protocol/safe-extensions.html#liveness-guard-security-properties">Liveness Guard Security Properties</a></li>
<li><a href="protocol/safe-extensions.html#liveness-module-security-properties">Liveness Module Security Properties</a></li>
</ul>
</li>
<li><a href="protocol/safe-extensions.html#interdependency-between-the-liveness-guard-and-liveness-module">Interdependency between the Liveness Guard and Liveness Module</a></li>
</ul>
</li>
<li><a href="protocol/safe-extensions.html#operational-considerations">Operational Considerations</a>
<ul>
<li><a href="protocol/safe-extensions.html#manual-validation-of-new-owner-liveness">Manual validation of new owner liveness</a></li>
<li><a href="protocol/safe-extensions.html#deploying-the-liveness-checking-system">Deploying the Liveness Checking System</a></li>
<li><a href="protocol/safe-extensions.html#modifying-the-liveness-checking-system">Modifying the Liveness Checking System</a>
<ul>
<li><a href="protocol/safe-extensions.html#replacing-the-liveness-module">Replacing the Liveness Module</a></li>
<li><a href="protocol/safe-extensions.html#replacing-the-liveness-guard">Replacing the Liveness Guard</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<p>This document describes extensions to the Security Council and Guardian Safe contracts, which
provide additional functionality and security guarantees on top of those provided by the Safe
contract.</p>
<p>These extensions are developed using two types of contracts
(<a href="https://docs.safe.global/advanced/smart-account-modules">modules</a> and
<a href="https://docs.safe.global/advanced/smart-account-guards">guards</a>) which the Safe contract has
built-in support for:</p>
<ol>
<li><strong>Guard contracts:</strong> can execute pre- and post- transaction checks.</li>
<li><strong>Module contracts:</strong> a contract which is
authorized to execute transactions via the Safe. This means the module must properly implement
auth conditions internally.</li>
</ol>
<p>For more information about the Security Council and Guardian roles, refer to the
<a href="protocol/./stage-1.html">Stage One Roles and Requirements</a> document.</p>
<h2 id="security-council-liveness-checking-extensions"><a class="header" href="#security-council-liveness-checking-extensions">Security Council Liveness Checking Extensions</a></h2>
<p>The Security Council Safe is extended by the Liveness Checking Module and Guard. These extensions
are intended to ensure that any loss of access to a signer's keys is identified and addressed
within a predictable period of time.</p>
<p>This mechanism is intended only to be used to remove signers who have lost access to their keys, or
are otherwise inactive. It is not intended to be used to remove signers who are acting in bad faith,
or any other subjective criteria, such cases should be addressed by governance, and the removal
handled via the standard Safe ownership management functionality.</p>
<h3 id="the-liveness-guard"><a class="header" href="#the-liveness-guard">The Liveness Guard</a></h3>
<p>For implementing liveness checks a <code>LivenessGuard</code> is created which receives the signatures from
each executed transaction, and tracks the latest time at which a transaction was signed by each
signer. This time is made publicly available by calling a <code>lastLive(address)(Timestamp)</code> method.</p>
<p>Owners are recorded in this mapping in one of 4 ways:</p>
<ol>
<li>Upon deployment, the guard reads the current set of owners from the Safe contract.</li>
<li>When a new owner is added to the safe. Similarly, when an owner is removed from the Safe, its
entry is deleted from the mapping.</li>
<li>When a transaction is executed, the signatures on that transaction are passed to the guard and
used to identify the signers. If more than the required number of signatures is provided, they
are ignored.</li>
<li>An owner may call the contract's <code>showLiveness()()</code> method directly in order to prove liveness.</li>
</ol>
<p>Note that the first two methods do not require the owner to actually sign anything. However these
mechanisms are necessary to prevent new owners from being removed before they have had a chance to
show liveness.</p>
<h3 id="the-liveness-module"><a class="header" href="#the-liveness-module">The Liveness Module</a></h3>
<p>A <code>LivenessModule</code> is also created which does the following:</p>
<ol>
<li>Has a function <code>removeOwners()</code> that anyone may call to specify one or more owners to be removed
from the Safe.</li>
<li>The Module would then check the <code>LivenessGuard.lastLive()</code> to determine if the signer is eligible
for removal.</li>
<li>If so, it will call the Safe's <code>removeSigner()</code> to remove the non-live signer, and if necessary
reduce the threshold.</li>
<li>When a member is removed, the signing parameters are modified such that <code>M/N</code> is the lowest ratio
which remains greater than or equal to 75%. Using integer math, this can be expressed as
<code>M = (N * 75 + 99) / 100</code>.</li>
</ol>
<h3 id="owner-removal-call-flow"><a class="header" href="#owner-removal-call-flow">Owner Removal Call Flow</a></h3>
<p>The following diagram illustrates the flow for removing a single owner. The <code>verifyFinalState</code> box
indicates calls to the Safe which ensure the final state is valid.</p>
<pre class="mermaid">sequenceDiagram
    participant User
    participant LivenessModule
    participant LivenessGuard
    participant Safe
    User-&gt;&gt;LivenessModule: removeOwners([previousOwner], [owner])
    LivenessModule-&gt;&gt;LivenessGuard: lastLive(owner)
    LivenessModule-&gt;&gt;Safe: getOwners()
    LivenessModule-&gt;&gt;Safe: removeOwner(previousOwner, owner)

    alt verifyFinalState
    LivenessModule-&gt;&gt;Safe: getOwners()
    LivenessModule-&gt;&gt;Safe: getThreshold()
    LivenessModule-&gt;&gt;Safe: getGuard()
    end
</pre>
<h3 id="shutdown"><a class="header" href="#shutdown">Shutdown</a></h3>
<p>In the unlikely event that the signer set (<code>N</code>) is reduced below the allowed minimum number of
owners, then (and only then) is a shutdown mechanism activated which removes the existing signers,
and hands control of the multisig over to a predetermined entity.</p>
<h3 id="liveness-security-properties"><a class="header" href="#liveness-security-properties">Liveness Security Properties</a></h3>
<p>The following security properties must be upheld:</p>
<h4 id="liveness-guard-security-properties"><a class="header" href="#liveness-guard-security-properties">Liveness Guard Security Properties</a></h4>
<ol>
<li>Signatures are assigned to the correct signer.</li>
<li>Non-signers are unable to create a record of having signed.</li>
<li>An owner cannot be censored or griefed such that their signing is not recorded.</li>
<li>Owners may demonstrate liveness either by signing a transaction or by calling directly to the
guard.</li>
<li>It must be impossible for the guard's <code>checkTransaction</code> or <code>checkAfterExecution</code> method to
permanently revert given any calldata and the current state.</li>
<li>The guard correctly handles updates to the owners list, such that new owners are recorded, and
removed owners are deleted.
<ol>
<li>An <code>ownersBefore</code> enumerable set variable is used to accomplish this, it must be emptied at
the end of the <code>checkAfterExecution</code> call.</li>
</ol>
</li>
</ol>
<h4 id="liveness-module-security-properties"><a class="header" href="#liveness-module-security-properties">Liveness Module Security Properties</a></h4>
<ol>
<li>During a shutdown the module correctly removes all signers, and converts the safe to a 1 of 1.</li>
<li>The module only removes an owner if they have not demonstrated liveness during the interval, or
if enough other owners have been removed to activate the shutdown mechanism.</li>
<li>The module correctly sets the Safe's threshold upon removing a signer.</li>
</ol>
<p>Note: neither the module nor guard attempt to prevent a quorum of owners from removing either the
liveness module or guard. There are legitimate reasons they might wish to do so. Moreover, if such a
quorum of owners exists, there is no benefit to removing them, as they are defacto 'sufficiently
live'.</p>
<h3 id="interdependency-between-the-liveness-guard-and-liveness-module"><a class="header" href="#interdependency-between-the-liveness-guard-and-liveness-module">Interdependency between the Liveness Guard and Liveness Module</a></h3>
<p>The guard has no dependency on the module, and can be used independently to track liveness of Safe
owners.</p>
<p>This means that the module can be removed or replaced without any affect on the guard.</p>
<p>The module however does have a dependency on the guard; if the guard is removed from the Safe, then
the module will no longer be functional and calls to its <code>removeOwners</code> function will revert.</p>
<h2 id="operational-considerations"><a class="header" href="#operational-considerations">Operational Considerations</a></h2>
<h3 id="manual-validation-of-new-owner-liveness"><a class="header" href="#manual-validation-of-new-owner-liveness">Manual validation of new owner liveness</a></h3>
<p>As <a href="protocol/safe-extensions.html#the-liveness-guard">noted above</a> newly added owners are recorded in the guard without
necessarily having signed a transaction. Off-chain validation of the liveness of an address must
therefore be done prior to adding a new owner.</p>
<h3 id="deploying-the-liveness-checking-system"><a class="header" href="#deploying-the-liveness-checking-system">Deploying the Liveness Checking System</a></h3>
<p>The module and guard are intended to be deployed and installed on the safe in the following
sequence:</p>
<ol>
<li>Deploy the guard contract. The guard's constructor will read the Safe's owners and set a
timestamp.</li>
<li>Deploy the module.</li>
<li>Set the guard on the safe.</li>
<li>Enable the module on the safe.</li>
</ol>
<p>This order of operations is necessary to satisfy the constructor checks in the module, and is
intended to prevent owners from being immediately removable.</p>
<p>Note that changes to the owners set should not be made between the time the module is deployed, and
when it is enabled on the Safe, otherwise the checks made in the module's constructor may be
invalidated. If such changes are made, a new module should be deployed.</p>
<h3 id="modifying-the-liveness-checking-system"><a class="header" href="#modifying-the-liveness-checking-system">Modifying the Liveness Checking System</a></h3>
<p>Changes to the liveness checking system should be done in the following manner:</p>
<h4 id="replacing-the-liveness-module"><a class="header" href="#replacing-the-liveness-module">Replacing the Liveness Module</a></h4>
<p>The module can safely be removed without affecting the operation of the guard. A new module can then
be added.</p>
<p>Note: none of the module's parameters are modifiable. In order to update the security properties
enforced by the module, it must be replaced.</p>
<h4 id="replacing-the-liveness-guard"><a class="header" href="#replacing-the-liveness-guard">Replacing the Liveness Guard</a></h4>
<p>The safe can only have one guard contract at a time, and if the guard is removed the module will
cease to function. This does not affect the ability of the Safe to operate normally, however the
module should be removed as a best practice.</p>
<p>If a new guard is added, eg. as a means of upgrading it, then a new module will also need to be
deployed and enabled. Once both the guard and module have been removed, they can be replaced
according to the steps in the <a href="protocol/safe-extensions.html#deploying-the-liveness-checking-system">Deployment</a> section above.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="stage-1-roles-and-requirements"><a class="header" href="#stage-1-roles-and-requirements">Stage 1 Roles and Requirements</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/stage-1.html#overview">Overview</a></li>
<li><a href="protocol/stage-1.html#definitions">Definitions</a>
<ul>
<li><a href="protocol/stage-1.html#withdrawal-liveness">Withdrawal Liveness</a></li>
<li><a href="protocol/stage-1.html#withdrawal-safety">Withdrawal Safety</a></li>
<li><a href="protocol/stage-1.html#proxy-admin-owner">Proxy Admin Owner</a></li>
<li><a href="protocol/stage-1.html#guardian">Guardian</a></li>
<li><a href="protocol/stage-1.html#pause-deputy">Pause Deputy</a></li>
<li><a href="protocol/stage-1.html#pause-mechanism">Pause Mechanism</a></li>
<li><a href="protocol/stage-1.html#pause-identifier">Pause Identifier</a></li>
<li><a href="protocol/stage-1.html#stage-1-rollup">Stage 1 Rollup</a></li>
</ul>
</li>
<li><a href="protocol/stage-1.html#op-stack-stage-1-design">OP Stack Stage 1 Design</a>
<ul>
<li><a href="protocol/stage-1.html#permissionless-fault-proofs">Permissionless Fault Proofs</a></li>
<li><a href="protocol/stage-1.html#security-council">Security Council</a></li>
<li><a href="protocol/stage-1.html#proxy-admin-owner-1">Proxy Admin Owner</a></li>
<li><a href="protocol/stage-1.html#guardian-1">Guardian</a></li>
<li><a href="protocol/stage-1.html#pause-deputy-1">Pause Deputy</a></li>
<li><a href="protocol/stage-1.html#architecture-diagram">Architecture Diagram</a></li>
</ul>
</li>
<li><a href="protocol/stage-1.html#invariants">Invariants</a>
<ul>
<li><a href="protocol/stage-1.html#is1-001">iS1-001</a></li>
<li><a href="protocol/stage-1.html#impact">Impact</a></li>
<li><a href="protocol/stage-1.html#is1-002-the-pause-deputy-can-only-cause-a-temporary-withdrawal-liveness-failure">iS1-002: The Pause Deputy can only cause a temporary Withdrawal Liveness failure</a>
<ul>
<li><a href="protocol/stage-1.html#impact-1">Impact</a></li>
</ul>
</li>
<li><a href="protocol/stage-1.html#is1-003-the-guardian-can-revoke-the-pause-deputy-role-at-any-time">iS1-003: The Guardian can revoke the Pause Deputy role at any time</a>
<ul>
<li><a href="protocol/stage-1.html#impact-2">Impact</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-27"><a class="header" href="#overview-27">Overview</a></h2>
<p>This document describes the requirements necessary for an OP Stack implementation to satisfy the
Stage 1 decentralization requirements <a href="https://forum.l2beat.com/t/stages-update-a-high-level-guiding-principle-for-stage-1/338">as defined by L2BEAT</a>. It also defines the specific
roles and capabilities for an OP Stack chain in the standard configuration that will satisfy these
requirements.</p>
<h2 id="definitions-5"><a class="header" href="#definitions-5">Definitions</a></h2>
<h3 id="withdrawal-liveness"><a class="header" href="#withdrawal-liveness">Withdrawal Liveness</a></h3>
<p><strong>Withdrawal Liveness</strong> is the ability for users to execute valid withdrawals out of any contract
that stores ETH or tokens within an OP Chain's set of smart contracts. We tend to refer to
Withdrawal Liveness in the context of the <code>OptimismPortal</code> and the rest of the Standard Bridge
system (i.e., the <code>StandardBridge</code> and <code>CrossDomainMessenger</code> contracts) because this is where a
majority of the ETH/tokens in the system live. However, this also applies to bonds deposited into
dispute game contracts (and ultimately into the <code>DelayedWETH</code> contract).</p>
<h3 id="withdrawal-safety"><a class="header" href="#withdrawal-safety">Withdrawal Safety</a></h3>
<p><strong>Withdrawal Safety</strong> is the condition that users are <em>not</em> able to execute <em>invalid</em> withdrawals
out of any contract that stores ETH or tokens within an OP Chain's set of smart contracts.
Generally speaking "liveness" means nothing gets bricked and "safety" means nothing gets stolen.</p>
<h3 id="proxy-admin-owner"><a class="header" href="#proxy-admin-owner">Proxy Admin Owner</a></h3>
<p>The <strong>Proxy Admin Owner</strong> is a dedicated role in the OP Stack that is permitted to upgrade the
contracts that make up an OP Stack chain's onchain footprint. In the Superchain, the Upgrade
Controller role is held jointly in a 2/2 of the Optimism Security Council and the Optimism
Foundation.</p>
<h3 id="guardian-3"><a class="header" href="#guardian-3">Guardian</a></h3>
<p>The <strong>Guardian</strong> is a dedicated role in the OP Stack that is permitted to trigger certain actions
to maintain the security of an OP Chain or set of OP Chains in case of a bug in the protocol. In
the Superchain, the Guardian role is held by the Optimism Security Council.</p>
<h3 id="pause-deputy"><a class="header" href="#pause-deputy">Pause Deputy</a></h3>
<p>The <strong>Pause Deputy</strong> is a dedicated role managed by the <a href="protocol/stage-1.html#guardian">Guardian</a> that can execute the
<a href="protocol/stage-1.html#pause-mechanism">Pause Mechanism</a>. An OP Chain does not necessarily need to assign a Pause
Deputy. The Pause Deputy is capable of triggering the Pause Mechanism but does not have the ability
to reset the mechanism or unpause the system.</p>
<p>The Pause Deputy is an optional role within an OP Chain and can be configured if the Guardian is
a <a href="https://docs.safe.global/home/what-is-safe">Safe</a> that installs the <a href="protocol/./deputy-pause-module.html">Deputy Pause Module</a>.</p>
<h3 id="pause-mechanism"><a class="header" href="#pause-mechanism">Pause Mechanism</a></h3>
<p>The <strong>Pause Mechanism</strong> is a tool that permits the <a href="protocol/stage-1.html#guardian">Guardian</a> or the
<a href="protocol/stage-1.html#pause-deputy">Pause Deputy</a> to pause the execution of certain actions on one or more OP Chains.
Broadly speaking, the Pause Mechanism is designed to impact the liveness of the system such that
an attack on the system is unable to actually remove ETH or ERC-20 tokens from the bridge or any
other contract that stores ETH and/or tokens.</p>
<p>The Pause Mechanism is temporary and is active up to a fixed maximum amount of time before
expiring. A pause cannot be triggered again unless the mechanism is explicitly reset by the
<a href="protocol/stage-1.html#guardian">Guardian</a>. That is, if the Pause Mechanism is triggered and not reset by the Guardian,
it will expire, the system will automatically become unpaused, and the system cannot be paused
again.</p>
<p>The Pause Mechanism can be applied globally or to individual systems. Which level the pause applies
to is determined by the <a href="protocol/stage-1.html#pause-identifier">Pause Identifier</a> provided when executing or checking
pause status.</p>
<p>Chains using the Standard Configuration of the OP Stack use a pause expiry of <strong>3 months</strong>. Because
the Pause Mechanism can be applied to both local and global scopes, the pause could be chained to,
for instance, pause the local system first and then the global system shortly before the local
pause expires. The total potential pause time is therefore double the expiry period (6 months).</p>
<p>The Guardian may explicitly unpause the system rather than waiting for the pause to expire. If this
happens, the pause is automatically reset such that it can be used again. The Guardian can reset
the pause at any time so that it can be used again, even if the pause is currently active. If the
pause is reset when it is currently active, the pause can be triggered again, thereby resetting
the 6 month expiry timer (on a per address identifier basis).</p>
<h3 id="pause-identifier"><a class="header" href="#pause-identifier">Pause Identifier</a></h3>
<p>The <strong>Pause Identifier</strong> is an address parameter used to specify the scope of a pause action. This
identifier determines which systems or chains are affected by the pause:</p>
<ul>
<li>When the identifier is the zero address (<code>0x0000000000000000000000000000000000000000</code>), the pause
applies globally to all chains sharing the <code>SuperchainConfig</code> contract.</li>
<li>When the identifier is a non-zero address, the pause applies specifically to the chain or set of
chains associated with that identifier.</li>
</ul>
<p>(-v4.1.0) The identifier must be an <code>ETHLockbox</code> address or <code>address(0)</code>. This allows for targeted
pausing of either specific chains, the interop set (which shares an <code>ETHLockbox</code> contract), or all
chains that share the same <code>SuperchainConfig</code> when <code>address(0)</code> is used as the identifier.</p>
<p>(-v4.1.0) OP Chains are expected to integrate with the <code>SuperchainConfig</code> via their <code>SystemConfig</code>
contract, which will check for the status of the pause by passing along the address of the
<code>ETHLockbox</code> being used within that system as the Pause Identifier.</p>
<p>(+v4.1.0) The identifier must be an <code>ETHLockbox</code> address, an <code>OptimismPortal</code> address, or
<code>address(0)</code>. This allows for targeted pausing of specific chains, the interop set (which shares an
<code>ETHLockbox</code> contract), or all chains that share the same <code>SuperchainConfig</code> when <code>address(0)</code> is
used as the identifier. When the <code>ETHLockbox</code>
<a href="protocol/./system-config.html#customizable-feature">Customizable Feature</a> is enabled, the <code>ETHLockbox</code>
address is to be used as the pause identifier. When the <code>ETHLockbox</code> feature is disabled or the
<code>ETHLockbox</code> address has not yet been configured, the <code>OptimismPortal</code> address is to be used.</p>
<h3 id="stage-1-rollup"><a class="header" href="#stage-1-rollup">Stage 1 Rollup</a></h3>
<p>L2BEAT defines that a system can be considered a "Stage 1 Rollup" system if it has the following
property:</p>
<ul>
<li>If the System has a Security Council (<a href="https://medium.com/l2beat/stages-update-security-council-requirements-4c79cea8ef52">as defined by L2BEAT</a>) the only way
(excluding bugs) for the System to experience an indefinite
<a href="protocol/stage-1.html#withdrawal-liveness">Withdrawal Liveness</a> failure or any
<a href="protocol/stage-1.html#withdrawal-safety">Withdrawal Safety</a> failure is through a malicious majority of at least 75%
of the Security Council.</li>
</ul>
<h2 id="op-stack-stage-1-design"><a class="header" href="#op-stack-stage-1-design">OP Stack Stage 1 Design</a></h2>
<p>The above definitions and requirements have a number of concrete implications for the Standard
Configuration of the OP Stack. We therefore specify the following architecture for a Stage 1 OP
Stack chain.</p>
<h3 id="permissionless-fault-proofs"><a class="header" href="#permissionless-fault-proofs">Permissionless Fault Proofs</a></h3>
<p>A Stage 1 OP Stack chain must operate a <em>permissionless</em> Fault Proof system.</p>
<h3 id="security-council"><a class="header" href="#security-council">Security Council</a></h3>
<p>A Stage 1 OP Stack chain must have a Security Council.</p>
<h3 id="proxy-admin-owner-1"><a class="header" href="#proxy-admin-owner-1">Proxy Admin Owner</a></h3>
<p>The <a href="protocol/stage-1.html#proxy-admin-owner">Proxy Admin Owner</a> role in the OP Stack is a privileged role that is
allowed to upgrade the smart contracts that make up an OP Stack chain's onchain footprint. This
role must require sign-off from the Security Council. This specifically means that the role can
either be entirely held by the Security Council or by some other configuration as long as the
Security Council is a required signatory (e.g., a 2/2 multisig).</p>
<p>In addition to the ability to upgrade all smart contracts, the Proxy Admin Owner is the only
address authorized to perform the following actions:</p>
<ul>
<li><code>DisputeGameFactory.setImplementation</code></li>
<li><code>DisputeGameFactory.setInitBond</code></li>
<li><code>DelayedWETH.hold</code></li>
<li><code>DelayedWETH.recover</code></li>
</ul>
<p>The Proxy Admin Owner can theoretically cause an indefinite
<a href="protocol/stage-1.html#withdrawal-liveness">Withdrawal Liveness</a> failure as well as
<a href="protocol/stage-1.html#withdrawal-safety">Withdrawal Safety</a> failures. This is aligned with the Stage 1 definition
because the Security Council is a required signatory on this role.</p>
<h3 id="guardian-4"><a class="header" href="#guardian-4">Guardian</a></h3>
<p>The <a href="protocol/stage-1.html#guardian">Guardian</a> role in the OP Stack is a privileged role that is allowed to execute
certain safety-net actions in the case that a bug exists in the OP Stack smart contracts. This role
must be held by the Security Council in the form of a 1/1 Safe owned by the Security Council.</p>
<p>The Guardian is the only address that is permitted to execute the following actions:</p>
<ul>
<li><code>SuperchainConfig.pause()</code></li>
<li><code>SuperchainConfig.unpause()</code></li>
<li><code>SuperchainConfig.reset()</code></li>
<li><code>AnchorStateRegistry.setRespectedGameType()</code></li>
<li><code>AnchorStateRegistry.updateRetirementTimestamp()</code></li>
<li><code>AnchorStateRegistry.blacklistDisputeGame()</code></li>
</ul>
<p>The Guardian can theoretically cause an indefinite <a href="protocol/stage-1.html#withdrawal-liveness">Withdrawal Liveness</a>
failure as well as <a href="protocol/stage-1.html#withdrawal-safety">Withdrawal Safety</a> failures. This is aligned with the Stage
1 definition because the Security Council holds this role.</p>
<h3 id="pause-deputy-1"><a class="header" href="#pause-deputy-1">Pause Deputy</a></h3>
<p>The <a href="protocol/stage-1.html#pause-deputy">Pause Deputy</a> is a role that can be assigned by the Guardian. The Pause Deputy
is explicitly permitted to cause a <em>temporary</em> <a href="protocol/stage-1.html#withdrawal-liveness">Withdrawal Liveness</a> failure.
Because the Pause Deputy can only cause a temporary Withdrawal Liveness failure, the Guardian can
assign this role to any actor it deems fit to utilize the role without violating any
<a href="protocol/stage-1.html#invariants">invariants</a>.</p>
<h3 id="architecture-diagram"><a class="header" href="#architecture-diagram">Architecture Diagram</a></h3>
<p>The following diagram outlines the control relationships between the contracts in the system:</p>
<pre class="mermaid">flowchart LR
   subgraph SuperchainSystem[Superchain System]
      subgraph Exit[User Exit Controls]
         Pausability
         OtherExit[Other Exit Controls]
      end
      subgraph Safety
         ContractUpgrades
         DisputeGame
         OtherSafety[Other Safety]
      end
      subgraph NonProtocol[Out of Protocol]
         PV[ProtocolVersions]
      end
   end

   subgraph UpgradeSystem[Upgrade System]
      FndUp[Foundation Upgrade Safe]
      PAO[Proxy Admin Owner Safe]
      subgraph Security Council Safe
         Council[Security Council Safe + LivenessGuard]
         LM[Liveness Module]
      end
   end

   subgraph GuardianSystem[Guardian System]
      subgraph GuardianSafe[Guardian Safe]
         GS[Guardian Safe]
         DPM[Deputy Pause Module]
      end
   end

    PAO --&gt;|controls| Safety
    FndUp --&gt; PAO
    Council --&gt; PAO
    Council --&gt; GS
    FndOps[Foundation Operations Safe] --&gt;|pause| DPM
    FndUp --&gt;|set versions|PV
    LM --&gt;|execTransactionFromModule| Council
    DPM --&gt;|execTransactionFromModule| GS
    GS --&gt;|controls| Exit

   %% Declare a class to make the outer boxes somewhat transparent to provide some contrast
   classDef outer fill:#ffffff44
   class SuperchainSystem,GuardianSystem,UpgradeSystem outer
</pre>
<p>Note: in the diagram above, the
<a href="protocol/../protocol/superchain-upgrades.html#protocolversions-l1-contract"><code>ProtocolVersions</code>contract</a> is
listed as "Out of Protocol", because the decision to follow the version signals in the contract is
optional. It is included here for completeness, but it does not impact
<a href="protocol/stage-1.html#withdrawal-safety">Withdrawal Safety</a> or <a href="protocol/stage-1.html#withdrawal-liveness">Withdrawal Liveness</a>.</p>
<h2 id="invariants-4"><a class="header" href="#invariants-4">Invariants</a></h2>
<h3 id="is1-001"><a class="header" href="#is1-001">iS1-001</a></h3>
<p>A permanent Withdrawal Liveness or Withdrawal Safety failure requires 75% of the Security Council (w/o bugs).</p>
<p>This is the core invariant for Stage 1 and aligns with <a href="https://forum.l2beat.com/t/stages-update-a-high-level-guiding-principle-for-stage-1/338">the definition by L2BEAT</a> from
January 2025. We can define additional properties about roles specific to the OP Stack as long as
they align with this invariant. Note that this invariant does NOT consider the impact of bugs in
smart contracts on the rest of the protocol. That is, this invariant only holds strongly under the
assumption that no such bugs exist.</p>
<h3 id="impact-9"><a class="header" href="#impact-9">Impact</a></h3>
<p><strong>Severity: High/Critical</strong></p>
<p>If broken, it must be assumed that <em>some</em> other actor has the ability to cause a permanent
<a href="protocol/stage-1.html#withdrawal-liveness">Withdrawal Liveness</a> or <a href="protocol/stage-1.html#withdrawal-safety">Withdrawal Safety</a> failure. We
consider any violation of this invariant to be a High severity issue, but this issue potentially
becomes Critical if the actor that has this ability is not another reasonably trusted entity.</p>
<h3 id="is1-002-the-pause-deputy-can-only-cause-a-temporary-withdrawal-liveness-failure"><a class="header" href="#is1-002-the-pause-deputy-can-only-cause-a-temporary-withdrawal-liveness-failure">iS1-002: The Pause Deputy can only cause a temporary Withdrawal Liveness failure</a></h3>
<p>We require that any action that the <a href="protocol/stage-1.html#pause-deputy">Pause Deputy</a> can take in the system can
only cause a <em>temporary</em> <a href="protocol/stage-1.html#withdrawal-liveness">Withdrawal Liveness</a> failure. This is required
because the Security Council must explicitly trigger any action that results either an indefinite
Withdrawal Liveness failure or a <a href="protocol/stage-1.html#withdrawal-safety">Withdrawal Safety</a> failure.</p>
<h4 id="impact-10"><a class="header" href="#impact-10">Impact</a></h4>
<p><strong>Severity: High</strong></p>
<p>If this invariant were broken, the Pause Deputy could be able to cause either a
<a href="protocol/stage-1.html#withdrawal-safety">Withdrawal Safety</a> failure or a permanent Withdrawal Liveness failure. Either
failure mode would be a violation of the definition of Stage 1 as of <a href="https://forum.l2beat.com/t/stages-update-a-high-level-guiding-principle-for-stage-1/338">January 2025</a>.</p>
<h3 id="is1-003-the-guardian-can-revoke-the-pause-deputy-role-at-any-time"><a class="header" href="#is1-003-the-guardian-can-revoke-the-pause-deputy-role-at-any-time">iS1-003: The Guardian can revoke the Pause Deputy role at any time</a></h3>
<p>We require that the <a href="protocol/stage-1.html#guardian">Guardian</a> be able to revoke the <a href="protocol/stage-1.html#pause-deputy">Pause Deputy</a> role
at any time. This condition is necessary to prevent a misbehaving Pause Deputy from continuing to
trigger the <a href="protocol/stage-1.html#pause-mechanism">Pause Mechanism</a> when this would not be desired by the Guardian
itself.</p>
<h4 id="impact-11"><a class="header" href="#impact-11">Impact</a></h4>
<p><strong>Severity: High</strong></p>
<p>If this invariant were broken, assuming that <a href="protocol/stage-1.html#is1-002-the-pause-deputy-can-only-cause-a-temporary-withdrawal-liveness-failure">iS1-002</a> the Pause Deputy would potentially
be able to repeatedly trigger the Pause Mechanism even if the Guardian does not want this to
happen. We consider this to be a High severity condition because the Guardian can choose not to
renew the pause to allow the system to operate if truly necessary.</p>
<!-- references -->
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="deputypausemodule"><a class="header" href="#deputypausemodule">DeputyPauseModule</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/deputy-pause-module.html#status">Status</a></li>
<li><a href="protocol/deputy-pause-module.html#overview">Overview</a></li>
<li><a href="protocol/deputy-pause-module.html#context">Context</a></li>
<li><a href="protocol/deputy-pause-module.html#upgradeability">Upgradeability</a></li>
<li><a href="protocol/deputy-pause-module.html#assumptions">Assumptions</a>
<ul>
<li><a href="protocol/deputy-pause-module.html#ascp-001-pause-authorization-process-is-well-defined">aSCP-001: Pause authorization process is well-defined</a></li>
<li><a href="protocol/deputy-pause-module.html#ascp-002-pause-authorization-process-is-robust">aSCP-002: Pause authorization process is robust</a></li>
<li><a href="protocol/deputy-pause-module.html#ascp-003-pause-authorization-process-is-fast">aSCP-003: Pause authorization process is fast</a></li>
<li><a href="protocol/deputy-pause-module.html#adpm-001-contract-is-configured-correctly">aDPM-001: Contract is configured correctly</a>
<ul>
<li><a href="protocol/deputy-pause-module.html#mitigations">Mitigations</a></li>
</ul>
</li>
<li><a href="protocol/deputy-pause-module.html#adpm-002-deputy-key-is-not-compromised">aDPM-002: Deputy key is not compromised</a>
<ul>
<li><a href="protocol/deputy-pause-module.html#mitigations-1">Mitigations</a></li>
</ul>
</li>
<li><a href="protocol/deputy-pause-module.html#adpm-003-deputy-key-is-not-deleted">aDPM-003: Deputy key is not deleted</a>
<ul>
<li><a href="protocol/deputy-pause-module.html#mitigations-2">Mitigations</a></li>
</ul>
</li>
<li><a href="protocol/deputy-pause-module.html#adpm-004-ethereum-will-not-censor-transactions-for-extended-periods-of-time">aDPM-004: Ethereum will not censor transactions for extended periods of time</a>
<ul>
<li><a href="protocol/deputy-pause-module.html#mitigations-3">Mitigations</a></li>
</ul>
</li>
<li><a href="protocol/deputy-pause-module.html#adpm-005-openzeppelin-ecdsa-and-eip712-contracts-are-free-of-critical-bugs">aDPM-005: OpenZeppelin ECDSA and EIP712 contracts are free of critical bugs</a>
<ul>
<li><a href="protocol/deputy-pause-module.html#mitigations-4">Mitigations</a></li>
</ul>
</li>
<li><a href="protocol/deputy-pause-module.html#adpm-006-safe-contracts-are-free-of-critical-bugs">aDPM-006: Safe contracts are free of critical bugs</a>
<ul>
<li><a href="protocol/deputy-pause-module.html#mitigations-5">Mitigations</a></li>
</ul>
</li>
<li><a href="protocol/deputy-pause-module.html#adpm-008-deputy-key-is-capable-of-creating-signatures">aDPM-008: Deputy key is capable of creating signatures</a>
<ul>
<li><a href="protocol/deputy-pause-module.html#mitigations-6">Mitigations</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="protocol/deputy-pause-module.html#system-invariants">System Invariants</a>
<ul>
<li><a href="protocol/deputy-pause-module.html#iscp-001-pause-can-be-activated-within-30-minutes-of-authorization">iSCP-001: Pause can be activated within 30 minutes of authorization</a>
<ul>
<li><a href="protocol/deputy-pause-module.html#impact">Impact</a></li>
<li><a href="protocol/deputy-pause-module.html#dependencies">Dependencies</a></li>
</ul>
</li>
<li><a href="protocol/deputy-pause-module.html#iscp-002-pause-is-not-activated-outside-of-the-standard-process">iSCP-002: Pause is not activated outside of the standard process</a>
<ul>
<li><a href="protocol/deputy-pause-module.html#impact-1">Impact</a></li>
<li><a href="protocol/deputy-pause-module.html#dependencies-1">Dependencies</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="protocol/deputy-pause-module.html#component-invariants">Component Invariants</a>
<ul>
<li><a href="protocol/deputy-pause-module.html#idpm-001-only-the-deputy-may-act-through-the-module">iDPM-001: Only the Deputy may act through the module</a>
<ul>
<li><a href="protocol/deputy-pause-module.html#impact-2">Impact</a></li>
<li><a href="protocol/deputy-pause-module.html#mitigations-7">Mitigations</a></li>
<li><a href="protocol/deputy-pause-module.html#dependencies-2">Dependencies</a></li>
</ul>
</li>
<li><a href="protocol/deputy-pause-module.html#idpm-002-deputy-must-only-be-able-to-trigger-the-pause">iDPM-002: Deputy must only be able to trigger the pause</a>
<ul>
<li><a href="protocol/deputy-pause-module.html#impact-3">Impact</a></li>
<li><a href="protocol/deputy-pause-module.html#mitigations-8">Mitigations</a></li>
<li><a href="protocol/deputy-pause-module.html#dependencies-3">Dependencies</a></li>
</ul>
</li>
<li><a href="protocol/deputy-pause-module.html#idpm-003-deputy-must-always-be-able-to-act-through-the-module">iDPM-003: Deputy must always be able to act through the module</a>
<ul>
<li><a href="protocol/deputy-pause-module.html#impact-4">Impact</a></li>
<li><a href="protocol/deputy-pause-module.html#mitigations-9">Mitigations</a></li>
<li><a href="protocol/deputy-pause-module.html#dependencies-4">Dependencies</a></li>
</ul>
</li>
<li><a href="protocol/deputy-pause-module.html#idpm-004-deputy-authorizations-must-not-be-replayable">iDPM-004: Deputy authorizations must not be replayable</a>
<ul>
<li><a href="protocol/deputy-pause-module.html#impact-5">Impact</a></li>
<li><a href="protocol/deputy-pause-module.html#mitigations-10">Mitigations</a></li>
<li><a href="protocol/deputy-pause-module.html#dependencies-5">Dependencies</a></li>
</ul>
</li>
<li><a href="protocol/deputy-pause-module.html#idpm-005-foundation-safe-must-be-able-to-change-the-deputy-account-easily">iDPM-005: Foundation Safe must be able to change the Deputy account easily</a></li>
<li><a href="protocol/deputy-pause-module.html#impact-6">Impact</a></li>
<li><a href="protocol/deputy-pause-module.html#mitigations-11">Mitigations</a></li>
</ul>
</li>
<li><a href="protocol/deputy-pause-module.html#implementation-spec">Implementation Spec</a>
<ul>
<li><a href="protocol/deputy-pause-module.html#constructor">constructor</a></li>
<li><a href="protocol/deputy-pause-module.html#pause">pause</a></li>
<li><a href="protocol/deputy-pause-module.html#setdeputy">setDeputy</a></li>
<li><a href="protocol/deputy-pause-module.html#foundationsafe">foundationSafe</a></li>
<li><a href="protocol/deputy-pause-module.html#superchainconfig">superchainConfig</a></li>
<li><a href="protocol/deputy-pause-module.html#deputy">deputy</a></li>
<li><a href="protocol/deputy-pause-module.html#pausemessagetypehash">pauseMessageTypehash</a></li>
<li><a href="protocol/deputy-pause-module.html#deputyauthmessagetypehash">deputyAuthMessageTypehash</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="status"><a class="header" href="#status">Status</a></h2>
<p>Proposed</p>
<h2 id="overview-28"><a class="header" href="#overview-28">Overview</a></h2>
<p>The <code>DeputyPauseModule</code> is a <a href="https://docs.safe.global/advanced/smart-account-modules">Safe Module</a> designed to be installed into the Security
Council Guardian Safe that allows a dedicated Deputy address to create an ECDSA signature that
authorizes the execution of the <a href="protocol/./stage-1.html#pause-mechanism">Pause Mechanism</a>. The
<code>DeputyPauseModule</code> assumes that the Security Council Guardian Safe is the Guardian
that is permitted to act within the <a href="protocol/./superchain-config.html">SuperchainConfig</a>.</p>
<h2 id="context"><a class="header" href="#context">Context</a></h2>
<p>Additional context and motivation for this component can be found in the corresponding
<a href="https://github.com/ethereum-optimism/design-docs/blob/85c0f822/protocol/deputy-pause-module.md">design document</a>.</p>
<h2 id="upgradeability"><a class="header" href="#upgradeability">Upgradeability</a></h2>
<p>The <code>DeputyPauseModule</code> is not expected to change frequently and is therefore not a proxied
contract. The <code>DeputyPauseModule</code> allows basic parameters to be modified by the Operations Safe
directly without needing to deploy a new instance of the contract. Additionally, the address of the
module itself is only utilized within the Optimism Foundation Operations Safe and can be safely
replaced.</p>
<h2 id="assumptions-2"><a class="header" href="#assumptions-2">Assumptions</a></h2>
<blockquote>
<p><strong>NOTE</strong>: Assumptions are utilized by specific invariants and do not apply globally. Invariants
typically only rely on a subset of the following assumptions. Different invariants may rely on
different assumptions. Refer to individual invariants for their dependencies.</p>
</blockquote>
<h3 id="ascp-001-pause-authorization-process-is-well-defined"><a class="header" href="#ascp-001-pause-authorization-process-is-well-defined">aSCP-001: Pause authorization process is well-defined</a></h3>
<p>We assume that the process by which a pause can be authorized is well-defined such that the cases
in which the pause should and should not be triggered are apparent. This assumption dictates that
the cases in which the pause should be used are clearly enumerated and well known to all
participants.</p>
<h3 id="ascp-002-pause-authorization-process-is-robust"><a class="header" href="#ascp-002-pause-authorization-process-is-robust">aSCP-002: Pause authorization process is robust</a></h3>
<p>We assume that the process by which a pause can be authorized correctly accounts for all cases in
which such a pause would be necessary. In other words, we assume that there are no situations where
the pause <em>should</em> be used to protect the system but the defined protocol for triggering the pause
would not require the pause to be triggered.</p>
<h3 id="ascp-003-pause-authorization-process-is-fast"><a class="header" href="#ascp-003-pause-authorization-process-is-fast">aSCP-003: Pause authorization process is fast</a></h3>
<p>We assume that the process by which a pause can be authorized is fast acting such that it can make
the decision to trigger the pause within a short period of time of any situation that would require
such a pause.</p>
<h3 id="adpm-001-contract-is-configured-correctly"><a class="header" href="#adpm-001-contract-is-configured-correctly">aDPM-001: Contract is configured correctly</a></h3>
<p>We assume that all inputs to the contract are configured correctly including:</p>
<ul>
<li>Address of the Operations Safe.</li>
<li>Address of the <code>SuperchainConfig</code> contract.</li>
<li>Address of the Deputy account.</li>
</ul>
<h4 id="mitigations-6"><a class="header" href="#mitigations-6">Mitigations</a></h4>
<ul>
<li>Verify a signature from the Deputy in the contract constructor.</li>
<li>Verify the configured values in the deployment script.</li>
<li>Generate and test a signature on testnet.</li>
</ul>
<h3 id="adpm-002-deputy-key-is-not-compromised"><a class="header" href="#adpm-002-deputy-key-is-not-compromised">aDPM-002: Deputy key is not compromised</a></h3>
<p>We assume that the Deputy key is maintained securely and is not compromised by a malicious actor.</p>
<h4 id="mitigations-7"><a class="header" href="#mitigations-7">Mitigations</a></h4>
<ul>
<li>Enforce strong access control around the Deputy key.</li>
<li>Monitoring for any usage of the Deputy key.</li>
<li>Regular rotation of the Deputy key.</li>
</ul>
<h3 id="adpm-003-deputy-key-is-not-deleted"><a class="header" href="#adpm-003-deputy-key-is-not-deleted">aDPM-003: Deputy key is not deleted</a></h3>
<p>We assume that the Deputy key has not been deleted by a malicious actor.</p>
<h4 id="mitigations-8"><a class="header" href="#mitigations-8">Mitigations</a></h4>
<ul>
<li>Maintain duplicate copies of the key in multiple secure locations.</li>
</ul>
<h3 id="adpm-004-ethereum-will-not-censor-transactions-for-extended-periods-of-time"><a class="header" href="#adpm-004-ethereum-will-not-censor-transactions-for-extended-periods-of-time">aDPM-004: Ethereum will not censor transactions for extended periods of time</a></h3>
<p>We assume that Ethereum will not censor transactions for an extended period of time and that any
transaction submitted to the network can be processed within a reasonable time bound (e.g., 1h).</p>
<h4 id="mitigations-9"><a class="header" href="#mitigations-9">Mitigations</a></h4>
<ul>
<li>Extremely high priority fee if necessary.</li>
</ul>
<h3 id="adpm-005-openzeppelin-ecdsa-and-eip712-contracts-are-free-of-critical-bugs"><a class="header" href="#adpm-005-openzeppelin-ecdsa-and-eip712-contracts-are-free-of-critical-bugs">aDPM-005: OpenZeppelin ECDSA and EIP712 contracts are free of critical bugs</a></h3>
<p>We assume that both the <code>ECDSA</code> library and the <code>EIP712</code> contract provided by OpenZeppelin V4 at
commit <a href="https://github.com/OpenZeppelin/openzeppelin-contracts/tree/ecd2ca2c">ecd2ca2c</a> (v4.7.3) are free of any critical bugs that would cause their
behaviors to diverge from their specified behaviors.</p>
<h4 id="mitigations-10"><a class="header" href="#mitigations-10">Mitigations</a></h4>
<ul>
<li>Existing audits/safety processes for OpenZeppelin V4.</li>
</ul>
<h3 id="adpm-006-safe-contracts-are-free-of-critical-bugs"><a class="header" href="#adpm-006-safe-contracts-are-free-of-critical-bugs">aDPM-006: Safe contracts are free of critical bugs</a></h3>
<p>We assume that the Safe contract implementations used by the Security Council Safe and Optimism
Foundation Operations Safe are free of any critical bugs that would cause their behaviors to
diverge from their specified behaviors.</p>
<h4 id="mitigations-11"><a class="header" href="#mitigations-11">Mitigations</a></h4>
<ul>
<li>Existing audits/safety processes for Safe.</li>
</ul>
<h3 id="adpm-008-deputy-key-is-capable-of-creating-signatures"><a class="header" href="#adpm-008-deputy-key-is-capable-of-creating-signatures">aDPM-008: Deputy key is capable of creating signatures</a></h3>
<p>We assume that the Deputy key configured is actually capable of creating signatures.</p>
<h4 id="mitigations-12"><a class="header" href="#mitigations-12">Mitigations</a></h4>
<ul>
<li>Signature verification when changing Deputy key.</li>
</ul>
<h2 id="system-invariants"><a class="header" href="#system-invariants">System Invariants</a></h2>
<h3 id="iscp-001-pause-can-be-activated-within-30-minutes-of-authorization"><a class="header" href="#iscp-001-pause-can-be-activated-within-30-minutes-of-authorization">iSCP-001: Pause can be activated within 30 minutes of authorization</a></h3>
<p>It is an important system-level invariant that the pause functionality can be activated within a
short, bounded amount of time (30 minutes) of its authorization by the standard process that
approves the usage of this pause. That is, after the pause is authorized, it should be possible to
execute the pause in under 30 minutes under all circumstances.</p>
<h4 id="impact-12"><a class="header" href="#impact-12">Impact</a></h4>
<p><strong>Severity: High (estimated)</strong></p>
<p>If this invariant is broken, various recovery options that rely on fast activation of the pause may
fail. We estimate the severity of this invariant being broken to be high but final severity will
depend on the formalization of other invariants that rely on this one.</p>
<h4 id="dependencies-5"><a class="header" href="#dependencies-5">Dependencies</a></h4>
<ul>
<li><a href="protocol/deputy-pause-module.html#ascp-002-pause-authorization-process-is-robust">aSCP-002</a></li>
<li><a href="protocol/deputy-pause-module.html#ascp-003-pause-authorization-process-is-fast">aSCP-003</a></li>
<li><a href="protocol/deputy-pause-module.html#idpm-003-deputy-must-always-be-able-to-act-through-the-module">iDPM-003</a></li>
<li><a href="protocol/deputy-pause-module.html#adpm-001-contract-is-configured-correctly">aDPM-001</a></li>
</ul>
<h3 id="iscp-002-pause-is-not-activated-outside-of-the-standard-process"><a class="header" href="#iscp-002-pause-is-not-activated-outside-of-the-standard-process">iSCP-002: Pause is not activated outside of the standard process</a></h3>
<p>We must maintain that the pause is not activated outside of the standard process that approves the
usage of the pause.</p>
<h4 id="impact-13"><a class="header" href="#impact-13">Impact</a></h4>
<p><strong>Severity: High</strong></p>
<p>If this invariant is broken, all components that rely on the pause would be placed into a paused
state unexpectedly. This would cause a temporary liveness failure for withdrawals through the
Standard Bridge system and would negatively impact users until liveness could be restored by the
Guardian.</p>
<h4 id="dependencies-6"><a class="header" href="#dependencies-6">Dependencies</a></h4>
<ul>
<li><a href="protocol/deputy-pause-module.html#ascp-001-pause-authorization-process-is-well-defined">aSCP-001</a></li>
<li><a href="protocol/deputy-pause-module.html#idpm-001-only-the-deputy-may-act-through-the-module">iDPM-001</a></li>
<li><a href="protocol/deputy-pause-module.html#idpm-004-deputy-authorizations-must-not-be-replayable">iDPM-004</a></li>
<li><a href="protocol/deputy-pause-module.html#adpm-002-deputy-key-is-not-compromised">aDPM-002</a></li>
</ul>
<h2 id="component-invariants"><a class="header" href="#component-invariants">Component Invariants</a></h2>
<h3 id="idpm-001-only-the-deputy-may-act-through-the-module"><a class="header" href="#idpm-001-only-the-deputy-may-act-through-the-module">iDPM-001: Only the Deputy may act through the module</a></h3>
<p>The Deputy account must be the only address that can act through the module. Other accounts can
execute an action on behalf of the Deputy if the account has a valid authorization signature from
the Deputy for that action. No account may act through the module other than with the explicit
authorization of the Deputy.</p>
<h4 id="impact-14"><a class="header" href="#impact-14">Impact</a></h4>
<p><strong>Severity: High</strong></p>
<p>If this invariant is broken, accounts other than the Deputy would be able to carry out the actions
allowed by this module. Assuming that
<a href="protocol/deputy-pause-module.html#idpm-002-deputy-must-only-be-able-to-trigger-the-pause">iDPM-002</a> holds, this
means that an account other than the Deputy would be able to trigger the pause, presumably without
the authorization of the social consensus process that typically triggers this pause.</p>
<h4 id="mitigations-13"><a class="header" href="#mitigations-13">Mitigations</a></h4>
<ul>
<li>Signature verification on the pause action.</li>
<li>Monitoring for pause triggering actions.</li>
</ul>
<h4 id="dependencies-7"><a class="header" href="#dependencies-7">Dependencies</a></h4>
<ul>
<li><a href="protocol/deputy-pause-module.html#adpm-005-openzeppelin-ecdsa-and-eip712-contracts-are-free-of-critical-bugs">aDPM-005</a></li>
</ul>
<h3 id="idpm-002-deputy-must-only-be-able-to-trigger-the-pause"><a class="header" href="#idpm-002-deputy-must-only-be-able-to-trigger-the-pause">iDPM-002: Deputy must only be able to trigger the pause</a></h3>
<p>The Deputy must only be able to trigger the pause action by causing the module to call the <code>pause</code>
function on the <code>SuperchainConfig</code>. The Deputy must not be able to trigger any other privileged
action on behalf of the Guardian.</p>
<h4 id="impact-15"><a class="header" href="#impact-15">Impact</a></h4>
<p><strong>Severity: Critical</strong></p>
<p>If this invariant is broken, the Deputy would be able to cause the Optimism Foundation Operations
Safe to execute some unknown set of possible actions. We would treat this as a critical risk.</p>
<h4 id="mitigations-14"><a class="header" href="#mitigations-14">Mitigations</a></h4>
<ul>
<li>Strict auditing and verification of the <code>DeputyPauseModule</code>.</li>
</ul>
<h4 id="dependencies-8"><a class="header" href="#dependencies-8">Dependencies</a></h4>
<ul>
<li><a href="protocol/deputy-pause-module.html#adpm-006-safe-contracts-are-free-of-critical-bugs">aDPM-006</a></li>
</ul>
<h3 id="idpm-003-deputy-must-always-be-able-to-act-through-the-module"><a class="header" href="#idpm-003-deputy-must-always-be-able-to-act-through-the-module">iDPM-003: Deputy must always be able to act through the module</a></h3>
<p>The Deputy account must always be able to act through the module, even if the Deputy account
private key is compromised. Other than the total deletion of the Deputy key, there should not be
any condition in the contract itself that would prevent the key from being able to quickly and
efficiently execute the pause action.</p>
<h4 id="impact-16"><a class="header" href="#impact-16">Impact</a></h4>
<p><strong>Severity: High</strong></p>
<p>If this invariant is broken, we would not be able to provide the system-level invariant that the
Deputy account can always be used to trigger the pause within a bounded amount of time of the
decision being made to carry out this action.</p>
<h4 id="mitigations-15"><a class="header" href="#mitigations-15">Mitigations</a></h4>
<ul>
<li>Signature-based verification to bypass draining attacks.</li>
<li>Strict auditing and verification of the <code>DeputyPauseModule</code>.</li>
</ul>
<h4 id="dependencies-9"><a class="header" href="#dependencies-9">Dependencies</a></h4>
<ul>
<li><a href="protocol/deputy-pause-module.html#adpm-001-contract-is-configured-correctly">aDPM-001</a></li>
<li><a href="protocol/deputy-pause-module.html#adpm-003-deputy-key-is-not-deleted">aDPM-003</a></li>
<li><a href="protocol/deputy-pause-module.html#adpm-004-ethereum-will-not-censor-transactions-for-extended-periods-of-time">aDPM-004</a></li>
<li><a href="protocol/deputy-pause-module.html#adpm-005-openzeppelin-ecdsa-and-eip712-contracts-are-free-of-critical-bugs">aDPM-005</a></li>
<li><a href="protocol/deputy-pause-module.html#adpm-008-deputy-key-is-capable-of-creating-signatures">aDPM-008</a></li>
</ul>
<h3 id="idpm-004-deputy-authorizations-must-not-be-replayable"><a class="header" href="#idpm-004-deputy-authorizations-must-not-be-replayable">iDPM-004: Deputy authorizations must not be replayable</a></h3>
<p>A Deputy authorization must apply to a specific <code>DeputyPauseModule</code> on a specific blockchain as
identified by its chain ID. An authorization created for one <code>DeputyPauseModule</code> must not be
reusable on any other <code>DeputyPauseModule</code>. An authorization must be usable once and the same
authorization must not be usable again in any <code>DeputyPauseModule</code>.</p>
<h4 id="impact-17"><a class="header" href="#impact-17">Impact</a></h4>
<p><strong>Severity: High</strong></p>
<p>If this invariant is broken, a Deputy authorization created by the same Deputy address for
another <code>DeputyPauseModule</code> or a previous authorization for the same module could be reused and
would result in the pause being triggered outside of the standard process by which such a pause is
approved.</p>
<h4 id="mitigations-16"><a class="header" href="#mitigations-16">Mitigations</a></h4>
<ul>
<li>EIP-712 signature verification including a specific contract address and chain ID.</li>
<li>Enforce unique nonces on signatures to prevent signature reuse within the same contract.</li>
<li>Utilize unique Deputy accounts for each module instance or network.</li>
</ul>
<h4 id="dependencies-10"><a class="header" href="#dependencies-10">Dependencies</a></h4>
<ul>
<li><a href="protocol/deputy-pause-module.html#adpm-005-openzeppelin-ecdsa-and-eip712-contracts-are-free-of-critical-bugs">aDPM-005</a></li>
</ul>
<h3 id="idpm-005-foundation-safe-must-be-able-to-change-the-deputy-account-easily"><a class="header" href="#idpm-005-foundation-safe-must-be-able-to-change-the-deputy-account-easily">iDPM-005: Foundation Safe must be able to change the Deputy account easily</a></h3>
<p>The Foundation Safe must be able to change the address of the Deputy account without significant
operational overhead.</p>
<h3 id="impact-18"><a class="header" href="#impact-18">Impact</a></h3>
<p><strong>Severity: Medium</strong></p>
<p>If this invariant is broken, it would not be possible for the Safe account to easily rotate the
Deputy account if the account is compromised. This creates operational overhead but is not a
security risk as we assume that the Safe code does not have bugs and therefore the Safe can always
remove the module if necessary.</p>
<h3 id="mitigations-17"><a class="header" href="#mitigations-17">Mitigations</a></h3>
<ul>
<li>Authorized function to change the Deputy address.</li>
</ul>
<h2 id="implementation-spec"><a class="header" href="#implementation-spec">Implementation Spec</a></h2>
<h3 id="constructor-2"><a class="header" href="#constructor-2">constructor</a></h3>
<ul>
<li>Sets the EIP-712 domain name to "DeputyPauseModule".</li>
<li>Sets the EIP-712 domain version to "1".</li>
<li>Takes the address of the Operations Safe as an authorized input.</li>
<li>Takes the address of the <code>SuperchainConfig</code> as an authorized input.</li>
<li>Takes the address of the Deputy as an authorized input.</li>
<li>Takes a signature from the Deputy over a known EIP-712 message.</li>
<li>Must verify that the signature was produced by the provided Deputy address.</li>
</ul>
<h3 id="pause-1"><a class="header" href="#pause-1">pause</a></h3>
<ul>
<li>Takes a nonce as an untrusted input.</li>
<li>Takes a <a href="protocol/./stage-1.html#pause-identifier">Pause Identifier</a> as an untrusted input.</li>
<li>Takes a signature as an untrusted input.</li>
<li>Callable by any address.</li>
<li>Must verify that the nonce has not been used.</li>
<li>Must verify that the signature is over an EIP-712 message that commits to the nonce and the pause
identifier and was produced by the private key corresponding to the Deputy address.</li>
<li>Must mark the nonce as used.</li>
<li>Must trigger the pause on the <code>SuperchainConfig</code> function with the provided pause identifier.</li>
<li>Must revert if the call to the pause function failed.</li>
<li>Must revert if the call succeeded but the <code>SuperchainConfig</code> contract was not paused.</li>
</ul>
<h3 id="setdeputy"><a class="header" href="#setdeputy">setDeputy</a></h3>
<ul>
<li>Takes a deputy address as an authorized input.</li>
<li>Takes a deputy auth signature as an authorized input.</li>
<li>Can only be called by the Foundation Safe as configured in the constructor.</li>
<li>Must verify that the signature was produced by the provided Deputy address.</li>
</ul>
<h3 id="foundationsafe"><a class="header" href="#foundationsafe">foundationSafe</a></h3>
<ul>
<li>Returns the address of the Operations Safe as set in the constructor.</li>
</ul>
<h3 id="superchainconfig-2"><a class="header" href="#superchainconfig-2">superchainConfig</a></h3>
<ul>
<li>Returns the address of the <code>SuperchainConfig</code> contract as set in the constructor.</li>
</ul>
<h3 id="deputy"><a class="header" href="#deputy">deputy</a></h3>
<ul>
<li>Returns the address of the Deputy account as set in the constructor.</li>
</ul>
<h3 id="pausemessagetypehash"><a class="header" href="#pausemessagetypehash">pauseMessageTypehash</a></h3>
<ul>
<li>Returns the typehash that corresponds to <code>struct PauseMessage { bytes32 nonce }</code>.</li>
</ul>
<h3 id="deputyauthmessagetypehash"><a class="header" href="#deputyauthmessagetypehash">deputyAuthMessageTypehash</a></h3>
<ul>
<li>Returns the typehash that corresponds to <code>struct DeputyAuthMessage { address deputy }</code>.</li>
</ul>
<!-- References -->
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="regolith"><a class="header" href="#regolith">Regolith</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/regolith/overview.html#overview">Overview</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-29"><a class="header" href="#overview-29">Overview</a></h2>
<p>The Regolith upgrade, named after a material best described as "deposited dust on top of a layer of bedrock",
implements minor changes to deposit processing, based on reports of the Sherlock Audit-contest and findings in
the Bedrock Optimism Goerli testnet.</p>
<p>Summary of changes:</p>
<ul>
<li>The <code>isSystemTx</code> boolean is disabled, system transactions now use the same gas accounting rules as regular deposits.</li>
<li>The actual deposit gas-usage is recorded in the receipt of the deposit transaction,
and subtracted from the L2 block gas-pool.
Unused gas of deposits is not refunded with ETH however, as it is burned on L1.</li>
<li>The <code>nonce</code> value of the deposit sender account, before the transaction state-transition, is recorded in a new
optional field (<code>depositNonce</code>), extending the transaction receipt (i.e. not present in pre-Regolith receipts).</li>
<li>The recorded deposit <code>nonce</code> is used to correct the transaction and receipt metadata in RPC responses,
including the <code>contractAddress</code> field of deposits that deploy contracts.</li>
<li>The <code>gas</code> and <code>depositNonce</code> data is committed to as part of the consensus-representation of the receipt,
enabling the data to be safely synced between independent L2 nodes.</li>
<li>The L1-cost function was corrected to more closely match pre-Bedrock behavior.</li>
</ul>
<p>The <a href="protocol/regolith/../deposits.html">deposit specification</a> specifies the deposit changes of the Regolith upgrade in more detail.
The <a href="protocol/regolith/../exec-engine.html">execution engine specification</a> specifies the L1 cost function difference.</p>
<p>The Regolith upgrade uses a <em>L2 block-timestamp</em> activation-rule, and is specified in both the
rollup-node (<code>regolith_time</code>) and execution engine (<code>config.regolithTime</code>).</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="canyon"><a class="header" href="#canyon">Canyon</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/canyon/overview.html#execution-layer">Execution Layer</a></li>
<li><a href="protocol/canyon/overview.html#consensus-layer">Consensus Layer</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<p>The Canyon upgrade contains the Shapella upgrade from L1 and some minor protocol fixes.
The Canyon upgrade uses a <em>L2 block-timestamp</em> activation-rule, and is specified in both the
rollup-node (<code>canyon_time</code>) and execution engine (<code>config.canyonTime</code>). Shanghai time in the
execution engine should be set to the same time as the Canyon time.</p>
<h2 id="execution-layer"><a class="header" href="#execution-layer">Execution Layer</a></h2>
<ul>
<li>Shapella Upgrade
<ul>
<li><a href="https://eips.ethereum.org/EIPS/eip-3651">EIP-3651: Warm COINBASE</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-3855">EIP-3855: PUSH0 instruction</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-3860">EIP-3860: Limit and meter initcode</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-4895">EIP-4895: Beacon chain push withdrawals as operations</a>
<ul>
<li><a href="protocol/canyon/../rollup-node-p2p.html#block-validation">Withdrawals are prohibited in P2P Blocks</a></li>
<li><a href="protocol/canyon/../derivation.html#building-individual-payload-attributes">Withdrawals should be set to the empty array with Canyon</a></li>
</ul>
</li>
<li><a href="https://eips.ethereum.org/EIPS/eip-6049">EIP-6049: Deprecate SELFDESTRUCT</a></li>
</ul>
</li>
<li><a href="protocol/canyon/../exec-engine.html#1559-parameters">Modifies the EIP-1559 Denominator</a></li>
<li><a href="protocol/canyon/../deposits.html#deposit-receipt">Adds the deposit nonce &amp; deposit nonce version to the deposit receipt hash</a></li>
<li><a href="protocol/canyon/../predeploys.html#create2deployer">Deploys the create2Deployer to <code>0x13b0D85CcB8bf860b6b79AF3029fCA081AE9beF2</code></a></li>
</ul>
<h2 id="consensus-layer"><a class="header" href="#consensus-layer">Consensus Layer</a></h2>
<ul>
<li><a href="protocol/canyon/../derivation.html#reading">Channel Ordering Fix</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="delta"><a class="header" href="#delta">Delta</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/delta/overview.html#consensus-layer">Consensus Layer</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<p>The Delta upgrade uses a <em>L2 block-timestamp</em> activation-rule, and is specified only in the rollup-node (<code>delta_time</code>).</p>
<h2 id="consensus-layer-1"><a class="header" href="#consensus-layer-1">Consensus Layer</a></h2>
<p>The Delta upgrade consists of a single consensus-layer feature: <a href="protocol/delta/./span-batches.html">Span Batches</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="span-batches"><a class="header" href="#span-batches">Span-batches</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/delta/span-batches.html#introduction">Introduction</a></li>
<li><a href="protocol/delta/span-batches.html#span-batch-format">Span batch format</a>
<ul>
<li><a href="protocol/delta/span-batches.html#span-batch-size-limits">Span Batch Size Limits</a></li>
<li><a href="protocol/delta/span-batches.html#future-batch-format-extension">Future batch-format extension</a></li>
</ul>
</li>
<li><a href="protocol/delta/span-batches.html#span-batch-activation-rule">Span Batch Activation Rule</a></li>
<li><a href="protocol/delta/span-batches.html#optimization-strategies">Optimization Strategies</a>
<ul>
<li><a href="protocol/delta/span-batches.html#truncating-information-and-storing-only-necessary-data">Truncating information and storing only necessary data</a></li>
<li><a href="protocol/delta/span-batches.html#tx_data_headers-removal-from-initial-specs"><code>tx_data_headers</code> removal from initial specs</a></li>
<li><a href="protocol/delta/span-batches.html#chain-id-removal-from-initial-specs"><code>Chain ID</code> removal from initial specs</a></li>
<li><a href="protocol/delta/span-batches.html#reorganization-of-constant-length-transaction-fields">Reorganization of constant length transaction fields</a></li>
<li><a href="protocol/delta/span-batches.html#rlp-encoding-for-only-variable-length-fields">RLP encoding for only variable length fields</a></li>
<li><a href="protocol/delta/span-batches.html#store-y_parity-and-protected_bit-instead-of-v">Store <code>y_parity</code> and <code>protected_bit</code> instead of <code>v</code></a></li>
<li><a href="protocol/delta/span-batches.html#adjust-txs-data-layout-for-better-compression">Adjust <code>txs</code> Data Layout for Better Compression</a></li>
<li><a href="protocol/delta/span-batches.html#fee_recipients-encoding-scheme"><code>fee_recipients</code> Encoding Scheme</a></li>
</ul>
</li>
<li><a href="protocol/delta/span-batches.html#how-derivation-works-with-span-batches">How Derivation works with Span Batches</a></li>
<li><a href="protocol/delta/span-batches.html#integration">Integration</a>
<ul>
<li><a href="protocol/delta/span-batches.html#channel-reader-batch-decoding">Channel Reader (Batch Decoding)</a></li>
<li><a href="protocol/delta/span-batches.html#batch-queue">Batch Queue</a></li>
<li><a href="protocol/delta/span-batches.html#batcher">Batcher</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<!-- All glossary references in this file. -->
<h2 id="introduction"><a class="header" href="#introduction">Introduction</a></h2>
<p>Span-batch is a new batching spec that reduces overhead of OP-stack chains,
introduced in <a href="protocol/delta/../superchain-upgrades.html#delta">Delta</a> network upgrade.
This enables sparse and low-throughput OP-stack chains.</p>
<p>The overhead is reduced by representing a span of
consecutive L2 blocks in a more efficient manner,
while preserving the same consistency checks as regular batch data.</p>
<p>Note that the <a href="protocol/delta/../derivation.html#channel-format">channel</a> and
<a href="protocol/delta/../derivation.html#frame-format">frame</a> formats stay the same:
data slicing, packing and multi-transaction transport is already optimized.</p>
<p>The overhead in the <a href="protocol/delta/../derivation.html">V0 batch format</a> comes from:</p>
<ul>
<li>The meta-data attributes are repeated for every L2 block, while these are mostly implied already:
<ul>
<li>parent hash (32 bytes)</li>
<li>L1 epoch: blockhash (32 bytes) and block number (~4 bytes)</li>
<li>timestamp (~4 bytes)</li>
</ul>
</li>
<li>The organization of block data is inefficient:
<ul>
<li>Similar attributes are far apart, diminishing any chances of effective compression.</li>
<li>Random data like hashes are positioned in-between the more compressible application data.</li>
</ul>
</li>
<li>The RLP encoding of the data adds unnecessary overhead
<ul>
<li>The outer list does not have to be length encoded, the attributes are known</li>
<li>Fixed-length attributes do not need any encoding</li>
<li>The batch-format is static and can be optimized further</li>
</ul>
</li>
<li>Remaining meta-data for consistency checks can be optimized further:
<ul>
<li>The metadata only needs to be secure for consistency checks. E.g. 20 bytes of a hash may be enough.</li>
</ul>
</li>
</ul>
<p>Span-batches address these inefficiencies, with a new batch format version.</p>
<h2 id="span-batch-format"><a class="header" href="#span-batch-format">Span batch format</a></h2>
<p>Note that span-batches, unlike previous singular batches,
encode <em>a range of consecutive</em> L2 blocks at the same time.</p>
<p>Introduce version <code>1</code> to the <a href="protocol/delta/../derivation.html#batch-format">batch-format</a> table:</p>
<div class="table-wrapper"><table><thead><tr><th><code>batch_version</code></th><th><code>content</code></th></tr></thead><tbody>
<tr><td>1</td><td><code>prefix ++ payload</code></td></tr>
</tbody></table>
</div>
<p>Notation:</p>
<ul>
<li><code>++</code>: concatenation of byte-strings</li>
<li><code>span_start</code>: first L2 block in the span</li>
<li><code>span_end</code>: last L2 block in the span</li>
<li><code>uvarint</code>: unsigned Base128 varint, as defined in <a href="https://protobuf.dev/programming-guides/encoding/#varints">protobuf spec</a></li>
<li><code>rlp_encode</code>: a function that encodes a batch according to the RLP format,
and <code>[x, y, z]</code> denotes a list containing items <code>x</code>, <code>y</code> and <code>z</code></li>
</ul>
<p>Standard bitlists, in the context of span-batches, are encoded as big-endian integers,
left-padded with zeroes to the next multiple of 8 bits.</p>
<p>Where:</p>
<ul>
<li><code>prefix = rel_timestamp ++ l1_origin_num ++ parent_check ++ l1_origin_check</code>
<ul>
<li><code>rel_timestamp</code>: <code>uvarint</code> relative timestamp since L2 genesis,
i.e. <code>span_start.timestamp - config.genesis.timestamp</code>.</li>
<li><code>l1_origin_num</code>: <code>uvarint</code> number of last l1 origin number. i.e. <code>span_end.l1_origin.number</code></li>
<li><code>parent_check</code>: first 20 bytes of parent hash, the hash is truncated to 20 bytes for efficiency,
i.e. <code>span_start.parent_hash[:20]</code>.</li>
<li><code>l1_origin_check</code>: the block hash of the last L1 origin is referenced.
The hash is truncated to 20 bytes for efficiency, i.e. <code>span_end.l1_origin.hash[:20]</code>.</li>
</ul>
</li>
<li><code>payload = block_count ++ origin_bits ++ block_tx_counts ++ txs</code>:
<ul>
<li><code>block_count</code>: <code>uvarint</code> number of L2 blocks. This is at least 1, empty span batches are invalid.</li>
<li><code>origin_bits</code>: standard bitlist of <code>block_count</code> bits:
1 bit per L2 block, indicating if the L1 origin changed this L2 block.</li>
<li><code>block_tx_counts</code>: for each block, a <code>uvarint</code> of <code>len(block.transactions)</code>.</li>
<li><code>txs</code>: L2 transactions which is reorganized and encoded as below.</li>
</ul>
</li>
<li><code>txs = contract_creation_bits ++ y_parity_bits ++ tx_sigs ++ tx_tos ++ tx_datas ++ tx_nonces ++ tx_gases ++ protected_bits</code>
<ul>
<li><code>contract_creation_bits</code>: standard bitlist of <code>sum(block_tx_counts)</code> bits:
1 bit per L2 transactions, indicating if transaction is a contract creation transaction.</li>
<li><code>y_parity_bits</code>: standard bitlist of <code>sum(block_tx_counts)</code> bits:
1 bit per L2 transactions, indicating the y parity value when recovering transaction sender address.</li>
<li><code>tx_sigs</code>: concatenated list of transaction signatures
<ul>
<li><code>r</code> is encoded as big-endian <code>uint256</code></li>
<li><code>s</code> is encoded as big-endian <code>uint256</code></li>
</ul>
</li>
<li><code>tx_tos</code>: concatenated list of <code>to</code> field. <code>to</code> field in contract creation transaction will be <code>nil</code> and ignored.</li>
<li><code>tx_datas</code>: concatenated list of variable length rlp encoded data,
matching the encoding of the fields as in the <a href="https://eips.ethereum.org/EIPS/eip-2718">EIP-2718</a> format of the <code>TransactionType</code>.
<ul>
<li><code>legacy</code>: <code>rlp_encode(value, gasPrice, data)</code></li>
<li><code>1</code>: (<a href="https://eips.ethereum.org/EIPS/eip-2930">EIP-2930</a>): <code>0x01 ++ rlp_encode(value, gasPrice, data, accessList)</code></li>
<li><code>2</code>: (<a href="https://eips.ethereum.org/EIPS/eip-1559">EIP-1559</a>): <code>0x02 ++ rlp_encode(value, max_priority_fee_per_gas, max_fee_per_gas, data, access_list)</code></li>
</ul>
</li>
<li><code>tx_nonces</code>: concatenated list of <code>uvarint</code> of <code>nonce</code> field.</li>
<li><code>tx_gases</code>: concatenated list of <code>uvarint</code> of gas limits.
<ul>
<li><code>legacy</code>: <code>gasLimit</code></li>
<li><code>1</code>: (<a href="https://eips.ethereum.org/EIPS/eip-2930">EIP-2930</a>): <code>gasLimit</code></li>
<li><code>2</code>: (<a href="https://eips.ethereum.org/EIPS/eip-1559">EIP-1559</a>): <code>gas_limit</code></li>
</ul>
</li>
<li><code>protected_bits</code>: standard bitlist of length of number of legacy transactions:
1 bit per L2 legacy transactions, indicating if transaction is protected(<a href="https://eips.ethereum.org/EIPS/eip-155">EIP-155</a>) or not.</li>
</ul>
</li>
</ul>
<h3 id="span-batch-size-limits"><a class="header" href="#span-batch-size-limits">Span Batch Size Limits</a></h3>
<p>The total size of an encoded span batch is limited to <code>MAX_RLP_BYTES_PER_CHANNEL</code>, which is defined in the
<a href="protocol/delta/../derivation.html#protocol-parameters">Protocol Parameters table</a>.
This is done at the channel level rather than at the span batch level.</p>
<p>In addition to the byte limit, the number of blocks, and total transactions is limited to <code>MAX_SPAN_BATCH_ELEMENT_COUNT</code>.
This does imply that the max number of transactions per block is also <code>MAX_SPAN_BATCH_ELEMENT_COUNT</code>.
<code>MAX_SPAN_BATCH_ELEMENT_COUNT</code> is defined in <a href="protocol/delta/../derivation.html#protocol-parameters">Protocol Parameters table</a>.</p>
<h3 id="future-batch-format-extension"><a class="header" href="#future-batch-format-extension">Future batch-format extension</a></h3>
<p>This is an experimental extension of the span-batch format, and not activated with the Delta upgrade yet.</p>
<p>Introduce version <code>2</code> to the <a href="protocol/delta/../derivation.html#batch-format">batch-format</a> table:</p>
<div class="table-wrapper"><table><thead><tr><th><code>batch_version</code></th><th><code>content</code></th></tr></thead><tbody>
<tr><td>2</td><td><code>prefix ++ payload</code></td></tr>
</tbody></table>
</div>
<p>Where:</p>
<ul>
<li><code>prefix = rel_timestamp ++ l1_origin_num ++ parent_check ++ l1_origin_check</code>:
<ul>
<li>Identical to <code>batch_version</code> 1</li>
</ul>
</li>
<li><code>payload = block_count ++ origin_bits ++ block_tx_counts ++ txs ++ fee_recipients</code>:
<ul>
<li>An empty span-batch, i.e. with <code>block_count == 0</code>, is invalid and must not be processed.</li>
<li>Every field definition identical to <code>batch_version</code> 1 except that <code>fee_recipients</code> is
added to support more decentralized sequencing.</li>
<li><code>fee_recipients = fee_recipients_idxs + fee_recipients_set</code>
<ul>
<li><code>fee_recipients_set</code>: concatenated list of unique L2 fee recipient address.</li>
<li><code>fee_recipients_idxs</code>: for each block,
<code>uvarint</code> number of index to decode fee recipients from <code>fee_recipients_set</code>.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="span-batch-activation-rule"><a class="header" href="#span-batch-activation-rule">Span Batch Activation Rule</a></h2>
<p>The span batch upgrade is activated based on timestamp.</p>
<p>Activation Rule: <code>upgradeTime != null &amp;&amp; span_start.l1_origin.timestamp &gt;= upgradeTime</code></p>
<p><code>span_start.l1_origin.timestamp</code> is the L1 origin block timestamp of the first block in the span batch.
This rule ensures that every chain activity regarding this span batch is done after the hard fork.
i.e. Every block in the span is created, submitted to the L1, and derived from the L1 after the hard fork.</p>
<h2 id="optimization-strategies"><a class="header" href="#optimization-strategies">Optimization Strategies</a></h2>
<h3 id="truncating-information-and-storing-only-necessary-data"><a class="header" href="#truncating-information-and-storing-only-necessary-data">Truncating information and storing only necessary data</a></h3>
<p>The following fields stores truncated data:</p>
<ul>
<li><code>rel_timestamp</code>: We can save two bytes by storing <code>rel_timestamp</code> instead of the full <code>span_start.timestamp</code>.</li>
<li><code>parent_check</code> and <code>l1_origin_check</code>: We can save twelve bytes by truncating twelve bytes from the full hash,
while having enough safety.</li>
</ul>
<h3 id="tx_data_headers-removal-from-initial-specs"><a class="header" href="#tx_data_headers-removal-from-initial-specs"><code>tx_data_headers</code> removal from initial specs</a></h3>
<p>We do not need to store length per each <code>tx_datas</code> elements even if those are variable length,
because the elements itself is RLP encoded, containing their length in RLP prefix.</p>
<h3 id="chain-id-removal-from-initial-specs"><a class="header" href="#chain-id-removal-from-initial-specs"><code>Chain ID</code> removal from initial specs</a></h3>
<p>Every transaction has chain id. We do not need to include chain id in span batch because L2 already knows its chain id,
and use its own value for processing span batches while derivation.</p>
<h3 id="reorganization-of-constant-length-transaction-fields"><a class="header" href="#reorganization-of-constant-length-transaction-fields">Reorganization of constant length transaction fields</a></h3>
<p><code>signature</code>, <code>nonce</code>, <code>gaslimit</code>, <code>to</code> field are constant size, so these were split up completely and
are grouped into individual arrays.
This adds more complexity, but organizes data for improved compression by grouping data with similar data pattern.</p>
<h3 id="rlp-encoding-for-only-variable-length-fields"><a class="header" href="#rlp-encoding-for-only-variable-length-fields">RLP encoding for only variable length fields</a></h3>
<p>Further size optimization can be done by packing variable length fields, such as <code>access_list</code>.
However, doing this will introduce much more code complexity, compared to benefiting from size reduction.</p>
<p>Our goal is to find the sweet spot on code complexity - span batch size tradeoff.
I decided that using RLP for all variable length fields will be the best option,
not risking codebase with gnarly custom encoding/decoding implementations.</p>
<h3 id="store-y_parity-and-protected_bit-instead-of-v"><a class="header" href="#store-y_parity-and-protected_bit-instead-of-v">Store <code>y_parity</code> and <code>protected_bit</code> instead of <code>v</code></a></h3>
<p>Only legacy type transactions can be optionally protected. If protected(<a href="https://eips.ethereum.org/EIPS/eip-155">EIP-155</a>), <code>v = 2 * ChainID + 35 + y_parity</code>.
Else, <code>v = 27 + y_parity</code>. For other types of transactions, <code>v = y_parity</code>.
We store <code>y_parity</code>, which is single bit per L2 transaction.
We store <code>protected_bit</code>, which is single bit per L2 legacy type transactions to indicate that tx is protected.</p>
<p>This optimization will benefit more when ratio between number of legacy type transactions over number of transactions
excluding deposit tx is higher.
Deposit transactions are excluded in batches and are never written at L1 so excluded while analyzing.</p>
<h3 id="adjust-txs-data-layout-for-better-compression"><a class="header" href="#adjust-txs-data-layout-for-better-compression">Adjust <code>txs</code> Data Layout for Better Compression</a></h3>
<p>There are (8 choose 2) * 6! = 20160 permutations of ordering fields of <code>txs</code>.  It is not 8!
because <code>contract_creation_bits</code> must be first decoded in order to decode <code>tx_tos</code>.  We
experimented with different data layouts and found that segregating random data (<code>tx_sigs</code>,
<code>tx_tos</code>, <code>tx_datas</code>) from the rest most improved the zlib compression ratio.</p>
<h3 id="fee_recipients-encoding-scheme"><a class="header" href="#fee_recipients-encoding-scheme"><code>fee_recipients</code> Encoding Scheme</a></h3>
<p>Let <code>K</code> := number of unique fee recipients(cardinality) per span batch. Let <code>N</code> := number of L2 blocks.
If we naively encode each fee recipients by concatenating every fee recipients, it will need <code>20 * N</code> bytes.
If we manage <code>fee_recipients_idxs</code> and <code>fee_recipients_set</code>, It will need at most <code>max uvarint size * N = 8 * N</code>,
<code>20 * K</code> bytes each. If <code>20 * N &gt; 8 * N + 20 * K</code> then maintaining an index of fee recipients is reduces the size.</p>
<p>we thought sequencer rotation happens not much often, so assumed that <code>K</code> will be much lesser than <code>N</code>.
The assumption makes upper inequality to hold. Therefore, we decided to manage <code>fee_recipients_idxs</code> and
<code>fee_recipients_set</code> separately. This adds complexity but reduces data.</p>
<h2 id="how-derivation-works-with-span-batches"><a class="header" href="#how-derivation-works-with-span-batches">How Derivation works with Span Batches</a></h2>
<ul>
<li>Block Timestamp
<ul>
<li>The first L2 block's block timestamp is <code>rel_timestamp + L2Genesis.Timestamp</code>.</li>
<li>Then we can derive other blocks timestamp by adding L2 block time for each.</li>
</ul>
</li>
<li>L1 Origin Number
<ul>
<li>The parent of the first L2 block's L1 origin number is <code>l1_origin_num - sum(origin_bits)</code></li>
<li>Then we can derive other blocks' L1 origin number with <code>origin_bits</code>
<ul>
<li><code>i-th block's L1 origin number = (i-1)th block's L1 origin number + (origin_bits[i] ? 1 : 0)</code></li>
</ul>
</li>
</ul>
</li>
<li>L1 Origin Hash
<ul>
<li>We only need the <code>l1_origin_check</code>, the truncated L1 origin hash of the last L2 block of Span Batch.</li>
<li>If the last block references canonical L1 chain as its origin,
we can ensure the all other blocks' origins are consistent with the canonical L1 chain.</li>
</ul>
</li>
<li>Parent hash
<ul>
<li>In V0 Batch spec, we need batch's parent hash to validate if batch's parent is consistent with current L2 safe head.</li>
<li>But in the case of Span Batch, because it contains consecutive L2 blocks in the span,
we do not need to validate all blocks' parent hash except the first block.</li>
</ul>
</li>
<li>Transactions
<ul>
<li>Deposit transactions can be derived from its L1 origin, identical with V0 batch.</li>
<li>User transactions can be derived by following way:
<ul>
<li>Recover <code>V</code> value of TX signature from <code>y_parity_bits</code> and L2 chain id, as described in optimization strategies.</li>
<li>When parsing <code>tx_tos</code>, <code>contract_creation_bits</code> is used to determine if the TX has <code>to</code> value or not.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="integration-1"><a class="header" href="#integration-1">Integration</a></h2>
<h3 id="channel-reader-batch-decoding-1"><a class="header" href="#channel-reader-batch-decoding-1">Channel Reader (Batch Decoding)</a></h3>
<p>The Channel Reader decodes the span-batch, as described in the <a href="protocol/delta/span-batches.html#span-batch-format">span-batch format</a>.</p>
<p>A set of derived attributes is computed as described above. Then cached with the decoded result:</p>
<h3 id="batch-queue-1"><a class="header" href="#batch-queue-1">Batch Queue</a></h3>
<p>A span-batch is buffered as a singular large batch,
by its starting timestamp (transformed <code>rel_timestamp</code>).</p>
<p>Span-batches share the same queue with v0 batches: batches are processed in L1 inclusion order.</p>
<p>A set of modified validation rules apply to the span-batches.</p>
<p>Rules are enforced with the <a href="protocol/delta/../derivation.html#batch-queue">contextual definitions</a> as v0-batch validation:
<code>epoch</code>, <code>inclusion_block_number</code>, <code>next_timestamp</code></p>
<p>Definitions:</p>
<ul>
<li><code>batch</code> as defined in the <a href="protocol/delta/span-batches.html#span-batch-format">Span batch format section</a>.</li>
<li><code>prev_l2_block</code> is the L2 block from the current safe chain,
whose timestamp is at <code>span_start.timestamp - l2_block_time</code></li>
</ul>
<p>Span-batch rules, in validation order:</p>
<ul>
<li><code>batch_origin</code> is determined like with singular batches:
<ul>
<li><code>batch.epoch_num == epoch.number+1</code>:
<ul>
<li>If <code>next_epoch</code> is not known -&gt; <code>undecided</code>:
i.e. a batch that changes the L1 origin cannot be processed until we have the L1 origin data.</li>
<li>If known, then define <code>batch_origin</code> as <code>next_epoch</code></li>
</ul>
</li>
</ul>
</li>
<li><code>batch_origin.timestamp &lt; span_batch_upgrade_timestamp</code> -&gt; <code>drop</code>:
i.e. enforce the <a href="protocol/delta/span-batches.html#span-batch-activation-rule">span batch upgrade activation rule</a>.</li>
<li><code>span_start.timestamp &gt; next_timestamp</code> -&gt; <code>future</code>: i.e. the batch must be ready to process,
but does not have to start exactly at the <code>next_timestamp</code>, since it can overlap with previously processed blocks,</li>
<li><code>span_end.timestamp &lt; next_timestamp</code> -&gt; <code>drop</code>: i.e. the batch must have at least one new block to process.</li>
<li>If there's no <code>prev_l2_block</code> in the current safe chain -&gt; <code>drop</code>: i.e. the timestamp must be aligned.</li>
<li><code>batch.parent_check != prev_l2_block.hash[:20]</code> -&gt; <code>drop</code>:
i.e. the checked part of the parent hash must be equal to the same part of the corresponding L2 block hash.</li>
<li>Sequencing-window checks:
<ul>
<li>Note: The sequencing window is enforced for the <em>batch as a whole</em>:
if the batch was partially invalid instead, it would drop the oldest L2 blocks,
which makes the later L2 blocks invalid.</li>
<li>Variables:
<ul>
<li><code>origin_changed_bit = origin_bits[0]</code>: <code>true</code> if the first L2 block changed its L1 origin, <code>false</code> otherwise.</li>
<li><code>start_epoch_num = batch.l1_origin_num - sum(origin_bits) + (origin_changed_bit ? 1 : 0)</code></li>
<li><code>end_epoch_num = batch.l1_origin_num</code></li>
</ul>
</li>
<li>Rules:
<ul>
<li><code>start_epoch_num + sequence_window_size &lt; inclusion_block_number</code> -&gt; <code>drop</code>:
i.e. the batch must be included timely.</li>
<li><code>start_epoch_num &gt; prev_l2_block.l1_origin.number + 1</code> -&gt; <code>drop</code>:
i.e. the L1 origin cannot change by more than one L1 block per L2 block.</li>
<li>If <code>batch.l1_origin_check</code> does not match the canonical L1 chain at <code>end_epoch_num</code> -&gt; <code>drop</code>:
verify the batch is intended for this L1 chain.
<ul>
<li>After upper <code>l1_origin_check</code> check is passed, we don't need to check if the origin
is past <code>inclusion_block_number</code> because of the following invariant.</li>
<li>Invariant: the epoch-num in the batch is always less than the inclusion block number,
if and only if the L1 epoch hash is correct.</li>
</ul>
</li>
<li><code>start_epoch_num &lt; prev_l2_block.l1_origin.number</code> -&gt; <code>drop</code>:
epoch number cannot be older than the origin of parent block</li>
</ul>
</li>
</ul>
</li>
<li>Max Sequencer time-drift &amp; other L1 origin checks:
<ul>
<li>Note: The max time-drift is enforced for the <em>batch as a whole</em>, to keep the possible output variants small.</li>
<li>Variables:
<ul>
<li><code>block_input</code>: an L2 block from the span-batch,
with L1 origin as derived from the <code>origin_bits</code> and now established canonical L1 chain.</li>
<li><code>next_epoch</code>: <code>block_input.origin</code>'s next L1 block.
It may reach to the next origin outside the L1 origins of the span.</li>
</ul>
</li>
<li>Rules:
<ul>
<li>For each <code>block_input</code> whose timestamp is greater than <code>safe_head.timestamp</code>:
<ul>
<li><code>block_input.l1_origin.number &lt; safe_head.l1_origin.number</code> -&gt; <code>drop</code>: enforce increasing L1 origins.</li>
<li><code>block_input.timestamp &lt; block_input.origin.time</code> -&gt; <code>drop</code>: enforce the min L2 timestamp rule.</li>
<li><code>block_input.timestamp &gt; block_input.origin.time + max_sequencer_drift</code>: enforce the L2 timestamp drift rule,
but with exceptions to preserve above min L2 timestamp invariant:
<ul>
<li><code>len(block_input.transactions) == 0</code>:
<ul>
<li><code>origin_bits[i] == 0</code>: <code>i</code> is the index of <code>block_input</code> in the span batch.
So this implies the block_input did not advance the L1 origin,
and must thus be checked against <code>next_epoch</code>.
<ul>
<li>If <code>next_epoch</code> is not known -&gt; <code>undecided</code>:
without the next L1 origin we cannot yet determine if time invariant could have been kept.</li>
<li>If <code>block_input.timestamp &gt;= next_epoch.time</code> -&gt; <code>drop</code>:
the batch could have adopted the next L1 origin without breaking the <code>L2 time &gt;= L1 time</code> invariant.</li>
</ul>
</li>
</ul>
</li>
<li><code>len(block_input.transactions) &gt; 0</code>: -&gt; <code>drop</code>:
when exceeding the sequencer time drift, never allow the sequencer to include transactions.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>And for all transactions:
<ul>
<li><code>drop</code> if the <code>batch.tx_datas</code> list contains a transaction
that is invalid or derived by other means exclusively:
<ul>
<li>any transaction that is empty (zero length <code>tx_data</code>)</li>
<li>any <a href="protocol/delta/../../glossary.html#deposited-transaction-type">deposited transactions</a> (identified by the transaction type prefix byte in <code>tx_data</code>)</li>
<li>any transaction of a future type &gt; 2 (note that
<a href="protocol/delta/../isthmus/derivation.html#activation">Isthmus adds support</a>
for <code>SetCode</code> transactions of type 4)</li>
</ul>
</li>
</ul>
</li>
<li>Overlapped blocks checks:
<ul>
<li>Note: If the span batch overlaps the current L2 safe chain, we must validate all overlapped blocks.</li>
<li>Variables:
<ul>
<li><code>block_input</code>: an L2 block derived from the span-batch.</li>
<li><code>safe_block</code>: an L2 block from the current L2 safe chain, at same timestamp as <code>block_input</code></li>
</ul>
</li>
<li>Rules:
<ul>
<li>For each <code>block_input</code>, whose timestamp is less than <code>next_timestamp</code>:
<ul>
<li><code>block_input.l1_origin.number != safe_block.l1_origin.number</code> -&gt; <code>drop</code></li>
<li><code>block_input.transactions != safe_block.transactions</code> -&gt; <code>drop</code>
<ul>
<li>compare excluding deposit transactions</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Once validated, the batch-queue then emits a block-input for each of the blocks included in the span-batch.
The next derivation stage is thus only aware of individual block inputs, similar to the previous V0 batch,
although not strictly a "v0 batch" anymore.</p>
<h3 id="batcher"><a class="header" href="#batcher">Batcher</a></h3>
<p>Instead of transforming L2 blocks into batches,
the blocks should be buffered to form a span-batch.</p>
<p>Ideally the L2 blocks are buffered as block-inputs, to maximize the span of blocks covered by the span-batch:
span-batches of single L2 blocks do not increase efficiency as much as with larger spans.</p>
<p>This means that the <code>(c *channelBuilder) AddBlock</code> function is changed to
not directly call <code>(co *ChannelOut) AddBatch</code> but defer that until a minimum number of blocks have been buffered.</p>
<p>Output-size estimation of the queued up blocks is not possible until the span-batch is written to the channel.
Past a given number of blocks, the channel may be written for estimation, and then re-written if more blocks arrive.</p>
<p>The <a href="protocol/delta/../batcher.html">batcher functionality</a> stays the same otherwise: unsafe blocks are transformed into batches,
encoded in compressed channels, and then split into frames for submission to L1.
Batcher implementations can implement different heuristics and re-attempts to build the most gas-efficient data-txs.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="ecotone-network-upgrade"><a class="header" href="#ecotone-network-upgrade">Ecotone Network Upgrade</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/ecotone/overview.html#execution-layer">Execution Layer</a></li>
<li><a href="protocol/ecotone/overview.html#consensus-layer">Consensus Layer</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<p>The Ecotone upgrade contains the Dencun upgrade from L1, and adopts EIP-4844 blobs for data-availability.</p>
<h2 id="execution-layer-1"><a class="header" href="#execution-layer-1">Execution Layer</a></h2>
<ul>
<li>Cancun (Execution Layer):
<ul>
<li><a href="https://eips.ethereum.org/EIPS/eip-1153">EIP-1153: Transient storage opcodes</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-4844">EIP-4844: Shard Blob Transactions</a>
<ul>
<li><a href="protocol/ecotone/../exec-engine.html#ecotone-disable-blob-transactions">Blob transactions are disabled</a></li>
</ul>
</li>
<li><a href="https://eips.ethereum.org/EIPS/eip-4788">EIP-4788: Beacon block root in the EVM</a>
<ul>
<li><a href="protocol/ecotone/../exec-engine.html#ecotone-beacon-block-root">The L1 beacon block root is embedded into L2</a></li>
<li><a href="protocol/ecotone/../derivation.html#ecotone-beacon-block-roots-contract-deployment-eip-4788">The Beacon roots contract deployment is automated</a></li>
</ul>
</li>
<li><a href="https://eips.ethereum.org/EIPS/eip-5656">EIP-5656: MCOPY - Memory copying instruction</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-6780">EIP-6780: SELFDESTRUCT only in same transaction</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-7516">EIP-7516: BLOBBASEFEE opcode</a>
<ul>
<li><a href="protocol/ecotone/../exec-engine.html#ecotone-disable-blob-transactions">BLOBBASEFEE always pushes 1 onto the stack</a></li>
</ul>
</li>
</ul>
</li>
<li>Deneb (Consensus Layer): <em>not applicable to L2</em>
<ul>
<li><a href="https://eips.ethereum.org/EIPS/eip-7044">EIP-7044: Perpetually Valid Signed Voluntary Exits</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-7045">EIP-7045: Increase Max Attestation Inclusion Slot</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-7514">EIP-7514: Add Max Epoch Churn Limit</a></li>
</ul>
</li>
</ul>
<h2 id="consensus-layer-2"><a class="header" href="#consensus-layer-2">Consensus Layer</a></h2>
<ul>
<li>Blobs Data Availability: support blobs DA the <a href="protocol/ecotone/../derivation.html#ecotone-blob-retrieval">L1 Data-retrieval stage</a>.</li>
<li>Rollup fee update: support blobs DA in
<a href="protocol/ecotone/../exec-engine.html#ecotone-l1-cost-fee-changes-eip-4844-da">L1 Data Fee computation</a></li>
<li>Auto-upgrading and extension of the <a href="protocol/ecotone/./l1-attributes.html#ecotone-l1block-upgrade">L1 Attributes Predeployed Contract</a>
(also known as <code>L1Block</code> predeploy)</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="derivation-1"><a class="header" href="#derivation-1">Derivation</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/ecotone/derivation.html#ecotone-blob-retrieval">Ecotone: Blob Retrieval</a></li>
<li><a href="protocol/ecotone/derivation.html#blob-encoding">Blob Encoding</a></li>
<li><a href="protocol/ecotone/derivation.html#network-upgrade-automation-transactions">Network upgrade automation transactions</a>
<ul>
<li><a href="protocol/ecotone/derivation.html#l1block-deployment">L1Block Deployment</a></li>
<li><a href="protocol/ecotone/derivation.html#gaspriceoracle-deployment">GasPriceOracle Deployment</a></li>
<li><a href="protocol/ecotone/derivation.html#l1block-proxy-update">L1Block Proxy Update</a></li>
<li><a href="protocol/ecotone/derivation.html#gaspriceoracle-proxy-update">GasPriceOracle Proxy Update</a></li>
<li><a href="protocol/ecotone/derivation.html#gaspriceoracle-enable-ecotone">GasPriceOracle Enable Ecotone</a></li>
<li><a href="protocol/ecotone/derivation.html#beacon-block-roots-contract-deployment-eip-4788">Beacon block roots contract deployment (EIP-4788)</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="ecotone-blob-retrieval"><a class="header" href="#ecotone-blob-retrieval">Ecotone: Blob Retrieval</a></h2>
<p>With the Ecotone upgrade the retrieval stage is extended to support an additional DA source:
<a href="https://eips.ethereum.org/EIPS/eip-4844">EIP-4844</a> blobs. After the Ecotone upgrade we modify the iteration over batcher transactions to
treat transactions of transaction-type == <code>0x03</code> (<code>BLOB_TX_TYPE</code>) differently. If the batcher
transaction is a blob transaction, then its calldata MUST be ignored should it be present. Instead:</p>
<ul>
<li>For each blob hash in <code>blob_versioned_hashes</code>, retrieve the blob that matches it. A blob may be
retrieved from any of a number different sources. Retrieval from a local beacon-node, through
the <code>/eth/v1/beacon/blob_sidecars/</code> endpoint, with <code>indices</code> filter to skip unrelated blobs, is
recommended. For each retrieved blob:
<ul>
<li>The blob SHOULD (MUST, if the source is untrusted) be cryptographically verified against its
versioned hash.</li>
<li>If the blob has a <a href="protocol/ecotone/derivation.html#blob-encoding">valid encoding</a>, decode it into its continuous byte-string
and pass that on to the next phase. Otherwise the blob is ignored.</li>
</ul>
</li>
</ul>
<p>Note that batcher transactions of type blob must be processed in the same loop as other batcher
transactions to preserve the invariant that batches are always processed in the order they appear
in the block. We ignore calldata in blob transactions so that it may be used in the future for
batch metadata or other purposes.</p>
<h2 id="blob-encoding"><a class="header" href="#blob-encoding">Blob Encoding</a></h2>
<p>Each blob in a <a href="https://eips.ethereum.org/EIPS/eip-4844">EIP-4844</a> transaction really consists of <code>FIELD_ELEMENTS_PER_BLOB = 4096</code> field elements.</p>
<p>Each field element is a number in a prime field of
<code>BLS_MODULUS = 52435875175126190479447740508185965837690552500527637822603658699938581184513</code>.
This number does not represent a full <code>uint256</code>: <code>math.log2(BLS_MODULUS) = 254.8570894...</code></p>
<p>The <a href="https://github.com/ethereum/consensus-specs/blob/dev/specs/deneb/polynomial-commitments.md">L1 consensus-specs</a>
describe the encoding of this polynomial.
The field elements are encoded as big-endian integers (<code>KZG_ENDIANNESS = big</code>).</p>
<p>To save computational overhead, only <code>254</code> bits per field element are used for rollup data.</p>
<p>For efficient data encoding, <code>254</code> bits (equivalent to <code>31.75</code> bytes) are utilized.
<code>4</code> elements combine to effectively use <code>127</code> bytes.</p>
<p><code>127</code> bytes of application-layer rollup data is encoded at a time, into 4 adjacent field elements of the blob:</p>
<pre><code class="language-python"># read(N): read the next N bytes from the application-layer rollup-data. The next read starts where the last stopped.
# write(V): append V (one or more bytes) to the raw blob.
bytes tailA = read(31)
byte x = read(1)
byte A = x &amp; 0b0011_1111
write(A)
write(tailA)

bytes tailB = read(31)
byte y = read(1)
byte B = (y &amp; 0b0000_1111) | (x &amp; 0b1100_0000) &gt;&gt; 2)
write(B)
write(tailB)

bytes tailC = read(31)
byte z = read(1)
byte C = z &amp; 0b0011_1111
write(C)
write(tailC)

bytes tailD = read(31)
byte D = ((z &amp; 0b1100_0000) &gt;&gt; 2) | ((y &amp; 0b1111_0000) &gt;&gt; 4)
write(D)
write(tailD)
</code></pre>
<p>Each written field element looks like this:</p>
<ul>
<li>Starts with one of the prepared 6-bit left-padded byte values, to keep the field element within valid range.</li>
<li>Followed by 31 bytes of application-layer data, to fill the low 31 bytes of the field element.</li>
</ul>
<p>The written output should look like this:</p>
<pre><code class="language-text">&lt;----- element 0 -----&gt;&lt;----- element 1 -----&gt;&lt;----- element 2 -----&gt;&lt;----- element 3 -----&gt;
| byte A |  tailA...  || byte B |  tailB...  || byte C |  tailC...  || byte D |  tailD...  |
</code></pre>
<p>The above is repeated 1024 times, to fill all <code>4096</code> elements,
with a total of <code>(4 * 31 + 3) * 1024 = 130048</code> bytes of data.</p>
<p>When decoding a blob, the top-most two bits of each field-element must be 0,
to make the encoding/decoding bijective.</p>
<p>The first byte of rollup-data (second byte in first field element) is used as a version-byte.</p>
<p>In version <code>0</code>, the next 3 bytes of data are used to encode the length of the rollup-data, as big-endian <code>uint24</code>.
Any trailing data, past the length delimiter, must be 0, to keep the encoding/decoding bijective.
If the length is larger than <code>130048 - 4</code>, the blob is invalid.</p>
<p>If any of the encoding is invalid, the blob as a whole must be ignored.</p>
<h2 id="network-upgrade-automation-transactions-1"><a class="header" href="#network-upgrade-automation-transactions-1">Network upgrade automation transactions</a></h2>
<p>The Ecotone hardfork activation block contains the following transactions, in this order:</p>
<ul>
<li>L1 Attributes Transaction, using the pre-Ecotone <code>setL1BlockValues</code></li>
<li>User deposits from L1</li>
<li>Network Upgrade Transactions
<ul>
<li>L1Block deployment</li>
<li>GasPriceOracle deployment</li>
<li>Update L1Block Proxy ERC-1967 Implementation Slot</li>
<li>Update GasPriceOracle Proxy ERC-1967 Implementation Slot</li>
<li>GasPriceOracle Enable Ecotone</li>
<li>Beacon block roots contract deployment (EIP-4788)</li>
</ul>
</li>
</ul>
<p>To not modify or interrupt the system behavior around gas computation, this block will not include any sequenced
transactions by setting <code>noTxPool: true</code>.</p>
<h3 id="l1block-deployment"><a class="header" href="#l1block-deployment">L1Block Deployment</a></h3>
<p>The <code>L1Block</code> contract is upgraded to process the new Ecotone L1-data-fee parameters and L1 blob base-fee.</p>
<p>A deposit transaction is derived with the following attributes:</p>
<ul>
<li><code>from</code>: <code>0x4210000000000000000000000000000000000000</code></li>
<li><code>to</code>: <code>null</code></li>
<li><code>mint</code>: <code>0</code></li>
<li><code>value</code>: <code>0</code></li>
<li><code>gasLimit</code>: <code>375,000</code></li>
<li><code>data</code>: <code>0x60806040523480156100105...</code> (<a href="protocol/ecotone/../../static/bytecode/ecotone-l1-block-deployment.txt">full bytecode</a>)</li>
<li><code>sourceHash</code>: <code>0x877a6077205782ea15a6dc8699fa5ebcec5e0f4389f09cb8eda09488231346f8</code>,
computed with the "Upgrade-deposited" type, with `intent = "Ecotone: L1 Block Deployment"</li>
</ul>
<p>This results in the Ecotone L1Block contract being deployed to <code>0x07dbe8500fc591d1852B76feE44d5a05e13097Ff</code>, to verify:</p>
<pre><code class="language-bash">cast compute-address --nonce=0 0x4210000000000000000000000000000000000000
Computed Address: 0x07dbe8500fc591d1852B76feE44d5a05e13097Ff
</code></pre>
<p>Verify <code>sourceHash</code>:</p>
<pre><code class="language-bash">cast keccak $(cast concat-hex 0x0000000000000000000000000000000000000000000000000000000000000002 $(cast keccak "Ecotone: L1 Block Deployment"))
# 0x877a6077205782ea15a6dc8699fa5ebcec5e0f4389f09cb8eda09488231346f8
</code></pre>
<p>Verify <code>data</code>:</p>
<pre><code class="language-bash">git checkout 5996d0bc1a4721f2169ba4366a014532f31ea932
pnpm clean &amp;&amp; pnpm install &amp;&amp; pnpm build
jq -r ".bytecode.object" packages/contracts-bedrock/forge-artifacts/L1Block.sol/L1Block.json
</code></pre>
<p>This transaction MUST deploy a contract with the following code hash
<code>0xc88a313aa75dc4fbf0b6850d9f9ae41e04243b7008cf3eadb29256d4a71c1dfd</code>.</p>
<h3 id="gaspriceoracle-deployment"><a class="header" href="#gaspriceoracle-deployment">GasPriceOracle Deployment</a></h3>
<p>The <code>GasPriceOracle</code> contract is upgraded to support the new Ecotone L1-data-fee parameters. Post fork this contract
will use the blob base fee to compute the gas price for L1-data-fee transactions.</p>
<p>A deposit transaction is derived with the following attributes:</p>
<ul>
<li><code>from</code>: <code>0x4210000000000000000000000000000000000001</code></li>
<li><code>to</code>: <code>null</code>,</li>
<li><code>mint</code>: <code>0</code></li>
<li><code>value</code>: <code>0</code></li>
<li><code>gasLimit</code>: <code>1,000,000</code></li>
<li><code>data</code>: <code>0x60806040523480156100...</code> (<a href="protocol/ecotone/../../static/bytecode/ecotone-gas-price-oracle-deployment.txt">full bytecode</a>)</li>
<li><code>sourceHash</code>: <code>0xa312b4510adf943510f05fcc8f15f86995a5066bd83ce11384688ae20e6ecf42</code>
computed with the "Upgrade-deposited" type, with `intent = "Ecotone: Gas Price Oracle Deployment"</li>
</ul>
<p>This results in the Ecotone GasPriceOracle contract being deployed to <code>0xb528D11cC114E026F138fE568744c6D45ce6Da7A</code>,
to verify:</p>
<pre><code class="language-bash">cast compute-address --nonce=0 0x4210000000000000000000000000000000000001
Computed Address: 0xb528D11cC114E026F138fE568744c6D45ce6Da7A
</code></pre>
<p>Verify <code>sourceHash</code>:</p>
<pre><code class="language-bash">â¯ cast keccak $(cast concat-hex 0x0000000000000000000000000000000000000000000000000000000000000002 $(cast keccak "Ecotone: Gas Price Oracle Deployment"))
# 0xa312b4510adf943510f05fcc8f15f86995a5066bd83ce11384688ae20e6ecf42
</code></pre>
<p>Verify <code>data</code>:</p>
<pre><code class="language-bash">git checkout 5996d0bc1a4721f2169ba4366a014532f31ea932
pnpm clean &amp;&amp; pnpm install &amp;&amp; pnpm build
jq -r ".bytecode.object" packages/contracts-bedrock/forge-artifacts/GasPriceOracle.sol/GasPriceOracle.json
</code></pre>
<p>This transaction MUST deploy a contract with the following code hash
<code>0x8b71360ea773b4cfaf1ae6d2bd15464a4e1e2e360f786e475f63aeaed8da0ae5</code>.</p>
<h3 id="l1block-proxy-update"><a class="header" href="#l1block-proxy-update">L1Block Proxy Update</a></h3>
<p>This transaction updates the L1Block Proxy ERC-1967 implementation slot to point to the new L1Block deployment.</p>
<p>A deposit transaction is derived with the following attributes:</p>
<ul>
<li><code>from</code>: <code>0x0000000000000000000000000000000000000000</code></li>
<li><code>to</code>: <code>0x4200000000000000000000000000000000000015</code> (L1Block Proxy)</li>
<li><code>mint</code>: <code>0</code></li>
<li><code>value</code>: <code>0</code></li>
<li><code>gasLimit</code>: <code>50,000</code></li>
<li><code>data</code>: <code>0x3659cfe600000000000000000000000007dbe8500fc591d1852b76fee44d5a05e13097ff</code></li>
<li><code>sourceHash</code>: <code>0x18acb38c5ff1c238a7460ebc1b421fa49ec4874bdf1e0a530d234104e5e67dbc</code>
computed with the "Upgrade-deposited" type, with `intent = "Ecotone: L1 Block Proxy Update"</li>
</ul>
<p>Verify data:</p>
<pre><code class="language-bash">cast concat-hex $(cast sig "upgradeTo(address)") $(cast abi-encode "upgradeTo(address)" 0x07dbe8500fc591d1852B76feE44d5a05e13097Ff)
0x3659cfe600000000000000000000000007dbe8500fc591d1852b76fee44d5a05e13097ff
</code></pre>
<p>Verify <code>sourceHash</code>:</p>
<pre><code class="language-bash">cast keccak $(cast concat-hex 0x0000000000000000000000000000000000000000000000000000000000000002 $(cast keccak "Ecotone: L1 Block Proxy Update"))
# 0x18acb38c5ff1c238a7460ebc1b421fa49ec4874bdf1e0a530d234104e5e67dbc
</code></pre>
<h3 id="gaspriceoracle-proxy-update"><a class="header" href="#gaspriceoracle-proxy-update">GasPriceOracle Proxy Update</a></h3>
<p>This transaction updates the GasPriceOracle Proxy ERC-1967 implementation slot to point to the new GasPriceOracle
deployment.</p>
<p>A deposit transaction is derived with the following attributes:</p>
<ul>
<li><code>from</code>: <code>0x0000000000000000000000000000000000000000</code></li>
<li><code>to</code>: <code>0x420000000000000000000000000000000000000F</code> (Gas Price Oracle Proxy)</li>
<li><code>mint</code>: <code>0</code></li>
<li><code>value</code>: <code>0</code></li>
<li><code>gasLimit</code>: <code>50,000</code></li>
<li><code>data</code>: <code>0x3659cfe6000000000000000000000000b528d11cc114e026f138fe568744c6d45ce6da7a</code></li>
<li><code>sourceHash</code>: <code>0xee4f9385eceef498af0be7ec5862229f426dec41c8d42397c7257a5117d9230a</code>
computed with the "Upgrade-deposited" type, with <code>intent = "Ecotone: Gas Price Oracle Proxy Update"</code></li>
</ul>
<p>Verify data:</p>
<pre><code class="language-bash">cast concat-hex $(cast sig "upgradeTo(address)") $(cast abi-encode "upgradeTo(address)" 0xb528D11cC114E026F138fE568744c6D45ce6Da7A)
0x3659cfe6000000000000000000000000b528d11cc114e026f138fe568744c6d45ce6da7a
</code></pre>
<p>Verify <code>sourceHash</code>:</p>
<pre><code class="language-bash">cast keccak $(cast concat-hex 0x0000000000000000000000000000000000000000000000000000000000000002 $(cast keccak "Ecotone: Gas Price Oracle Proxy Update"))
# 0xee4f9385eceef498af0be7ec5862229f426dec41c8d42397c7257a5117d9230a
</code></pre>
<h3 id="gaspriceoracle-enable-ecotone"><a class="header" href="#gaspriceoracle-enable-ecotone">GasPriceOracle Enable Ecotone</a></h3>
<p>This transaction informs the GasPriceOracle to start using the Ecotone gas calculation formula.</p>
<p>A deposit transaction is derived with the following attributes:</p>
<ul>
<li><code>from</code>: <code>0xDeaDDEaDDeAdDeAdDEAdDEaddeAddEAdDEAd0001</code> (Depositer Account)</li>
<li><code>to</code>: <code>0x420000000000000000000000000000000000000F</code> (Gas Price Oracle Proxy)</li>
<li><code>mint</code>: <code>0</code></li>
<li><code>value</code>: <code>0</code></li>
<li><code>gasLimit</code>: <code>80,000</code></li>
<li><code>data</code>: <code>0x22b90ab3</code></li>
<li><code>sourceHash</code>: <code>0x0c1cb38e99dbc9cbfab3bb80863380b0905290b37eb3d6ab18dc01c1f3e75f93</code>,
computed with the "Upgrade-deposited" type, with `intent = "Ecotone: Gas Price Oracle Set Ecotone"</li>
</ul>
<p>Verify data:</p>
<pre><code class="language-bash">cast sig "setEcotone()"
0x22b90ab3
</code></pre>
<p>Verify <code>sourceHash</code>:</p>
<pre><code class="language-bash">cast keccak $(cast concat-hex 0x0000000000000000000000000000000000000000000000000000000000000002 $(cast keccak "Ecotone: Gas Price Oracle Set Ecotone"))
# 0x0c1cb38e99dbc9cbfab3bb80863380b0905290b37eb3d6ab18dc01c1f3e75f93
</code></pre>
<h3 id="beacon-block-roots-contract-deployment-eip-4788"><a class="header" href="#beacon-block-roots-contract-deployment-eip-4788">Beacon block roots contract deployment (EIP-4788)</a></h3>
<p><a href="https://eips.ethereum.org/EIPS/eip-4788">EIP-4788</a> introduces a "Beacon block roots" contract, that processes and exposes the beacon-block-root values.
at address <code>BEACON_ROOTS_ADDRESS = 0x000F3df6D732807Ef1319fB7B8bB8522d0Beac02</code>.</p>
<p>For deployment, <a href="https://eips.ethereum.org/EIPS/eip-4788">EIP-4788</a> defines a pre-<a href="https://eips.ethereum.org/EIPS/eip-155">EIP-155</a> legacy transaction, sent from a key that is derived such that the
transaction signature validity is bound to message-hash, which is bound to the input-data, containing the init-code.</p>
<p>However, this type of transaction requires manual deployment and gas-payments.
And since the processing is an integral part of the chain processing, and has to be repeated for every OP-Stack chain,
the deployment is approached differently here.</p>
<p>Some chains may already have a user-submitted instance of the <a href="https://eips.ethereum.org/EIPS/eip-4788">EIP-4788</a> transaction.
This is cryptographically guaranteed to be correct, but may result in the upgrade transaction
deploying a second contract, with the next nonce. The result of this deployment can be ignored.</p>
<p>A Deposit transaction is derived with the following attributes:</p>
<ul>
<li><code>from</code>: <code>0x0B799C86a49DEeb90402691F1041aa3AF2d3C875</code>, as specified in the EIP.</li>
<li><code>to</code>: null</li>
<li><code>mint</code>: <code>0</code></li>
<li><code>value</code>: <code>0</code></li>
<li><code>gasLimit</code>: <code>0x3d090</code>, as specified in the EIP.</li>
<li><code>isCreation</code>: <code>true</code></li>
<li><code>data</code>:
<code>0x60618060095f395ff33373fffffffffffffffffffffffffffffffffffffffe14604d57602036146024575f5ffd5b5f35801560495762001fff810690815414603c575f5ffd5b62001fff01545f5260205ff35b5f5ffd5b62001fff42064281555f359062001fff015500</code></li>
<li><code>isSystemTx</code>: <code>false</code>, as per the Regolith upgrade, even the system-generated transactions spend gas.</li>
<li><code>sourceHash</code>: <code>0x69b763c48478b9dc2f65ada09b3d92133ec592ea715ec65ad6e7f3dc519dc00c</code>,
computed with the "Upgrade-deposited" type, with <code>intent = "Ecotone: beacon block roots contract deployment"</code></li>
</ul>
<p>The contract address upon deployment is computed as <code>rlp([sender, nonce])</code>, which will equal:</p>
<ul>
<li><code>BEACON_ROOTS_ADDRESS</code> if deployed</li>
<li>a different address (<code>0xE3aE1Ae551eeEda337c0BfF6C4c7cbA98dce353B</code>) if <code>nonce = 1</code>:
when a user already submitted the EIP transaction before the upgrade.</li>
</ul>
<p>Verify <code>BEACON_ROOTS_ADDRESS</code>:</p>
<pre><code class="language-bash">cast compute-address --nonce=0 0x0B799C86a49DEeb90402691F1041aa3AF2d3C875
# Computed Address: 0x000F3df6D732807Ef1319fB7B8bB8522d0Beac02
</code></pre>
<p>Verify <code>sourceHash</code>:</p>
<pre><code class="language-bash">cast keccak $(cast concat-hex 0x0000000000000000000000000000000000000000000000000000000000000002 $(cast keccak "Ecotone: beacon block roots contract deployment"))
# 0x69b763c48478b9dc2f65ada09b3d92133ec592ea715ec65ad6e7f3dc519dc00c
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="ecotone-l1-attributes"><a class="header" href="#ecotone-l1-attributes">Ecotone L1 Attributes</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/ecotone/l1-attributes.html#overview">Overview</a></li>
<li><a href="protocol/ecotone/l1-attributes.html#l1-attributes-predeployed-contract">L1 Attributes Predeployed Contract</a>
<ul>
<li><a href="protocol/ecotone/l1-attributes.html#ecotone-l1block-upgrade">Ecotone L1Block upgrade</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-30"><a class="header" href="#overview-30">Overview</a></h2>
<p>On the Ecotone activation block, and if Ecotone is not activated at Genesis,
the L1 Attributes Transaction includes a call to <code>setL1BlockValues()</code>
because the L1 Attributes transaction precedes the <a href="protocol/ecotone/derivation.html#network-upgrade-automation-transactions">Ecotone Upgrade Transactions</a>,
meaning that <code>setL1BlockValuesEcotone</code> is not guaranteed to exist yet.</p>
<p>Every subsequent L1 Attributes transaction should include a call to the <code>setL1BlockValuesEcotone()</code> function.
The input args are no longer ABI encoded function parameters,
but are instead packed into 5 32-byte aligned segments (starting after the function selector).
Each unsigned integer argument is encoded as big-endian using a number of bytes corresponding to the underlying type.
The overall calldata layout is as follows:</p>
<div class="table-wrapper"><table><thead><tr><th>Input arg</th><th>Type</th><th>Calldata bytes</th><th>Segment</th></tr></thead><tbody>
<tr><td>{0x440a5e20}</td><td></td><td>0-3</td><td>n/a</td></tr>
<tr><td>baseFeeScalar</td><td>uint32</td><td>4-7</td><td>1</td></tr>
<tr><td>blobBaseFeeScalar</td><td>uint32</td><td>8-11</td><td></td></tr>
<tr><td>sequenceNumber</td><td>uint64</td><td>12-19</td><td></td></tr>
<tr><td>l1BlockTimestamp</td><td>uint64</td><td>20-27</td><td></td></tr>
<tr><td>l1BlockNumber</td><td>uint64</td><td>28-35</td><td></td></tr>
<tr><td>basefee</td><td>uint256</td><td>36-67</td><td>2</td></tr>
<tr><td>blobBaseFee</td><td>uint256</td><td>68-99</td><td>3</td></tr>
<tr><td>l1BlockHash</td><td>bytes32</td><td>100-131</td><td>4</td></tr>
<tr><td>batcherHash</td><td>bytes32</td><td>132-163</td><td>5</td></tr>
</tbody></table>
</div>
<p>Total calldata length MUST be exactly 164 bytes, implying the sixth and final segment is only
partially filled. This helps to slow database growth as every L2 block includes a L1 Attributes
deposit transaction.</p>
<p>In the first L2 block after the Ecotone activation block, the Ecotone L1 attributes are first used.</p>
<p>The pre-Ecotone values are migrated over 1:1.
Blocks after the Ecotone activation block contain all pre-Ecotone values 1:1,
and also set the following new attributes:</p>
<ul>
<li>The <code>baseFeeScalar</code> is set to the pre-Ecotone <code>scalar</code> value.</li>
<li>The <code>blobBaseFeeScalar</code> is set to <code>0</code>.</li>
<li>The pre-Ecotone <code>overhead</code> attribute is dropped.</li>
<li>The <code>blobBaseFee</code> is set to the L1 blob base fee of the L1 origin block.
Or <code>1</code> if the L1 block does not support blobs.
The <code>1</code> value is derived from the EIP-4844 <code>MIN_BLOB_GASPRICE</code>.</li>
</ul>
<p>Note that the L1 blob bas fee is <em>not</em> exposed as a part of the L1 origin block.
It must be computed using an parameterized off-chain formula which takes the
excess blob gas field from the header of the L1 origin block as described in
<a href="https://eips.ethereum.org/EIPS/eip-4844#base-fee-per-blob-gas-update-rule">EIP-4844</a>.
The <code>BLOB_BASE_FEE_UPDATE_FRACTION</code> parameter in the formula varies
according to which L1 fork is active
at the origin block (see e.g. <a href="https://eips.ethereum.org/EIPS/eip-7691">EIP-7691</a>). It is therefore
necessary for L2 consensus layer clients to know the blob parameters and activation
time for each L1 fork to compute the <code>blobBaseFee</code> correctly. Blob Parameter Only
(BPO) forks, introduced in <a href="https://eips.ethereum.org/EIPS/eip-7892">EIP-7892</a>
can mean that <code>BLOB_BASE_FEE_UPDATE_FRACTION</code> is updated frequently:
that clients and fault proof programs therefore need to stay up to date with
such forks.</p>
<h2 id="l1-attributes-predeployed-contract-1"><a class="header" href="#l1-attributes-predeployed-contract-1">L1 Attributes Predeployed Contract</a></h2>
<p>The L1 Attributes predeploy stores the following values:</p>
<ul>
<li>L1 block attributes:
<ul>
<li><code>number</code> (<code>uint64</code>)</li>
<li><code>timestamp</code> (<code>uint64</code>)</li>
<li><code>basefee</code> (<code>uint256</code>)</li>
<li><code>hash</code> (<code>bytes32</code>)</li>
<li><code>blobBaseFee</code> (<code>uint256</code>)</li>
</ul>
</li>
<li><code>sequenceNumber</code> (<code>uint64</code>): This equals the L2 block number relative to the start of the epoch,
i.e. the L2 block distance to the L2 block height that the L1 attributes last changed,
and reset to 0 at the start of a new epoch.</li>
<li>System configurables tied to the L1 block, see <a href="protocol/ecotone/../system-config.html">System configuration specification</a>:
<ul>
<li><code>batcherHash</code> (<code>bytes32</code>): A versioned commitment to the batch-submitter(s) currently operating.</li>
<li><code>baseFeeScalar</code> (<code>uint32</code>): system configurable to scale the <code>basefee</code> in the Ecotone l1 cost computation</li>
<li><code>blobBasefeeScalar</code> (<code>uint32</code>): system configurable to scale the <code>blobBaseFee</code> in the Ecotone l1 cost computation</li>
</ul>
</li>
</ul>
<p>The <code>overhead</code> and <code>scalar</code> values can continue to be accessed after the Ecotone activation block,
but no longer have any effect on system operation. These fields were also known as the <code>l1FeeOverhead</code>
and the <code>l1FeeScalar</code>.</p>
<p>After running <code>pnpm build</code> in the <code>packages/contracts-bedrock</code> directory, the bytecode to add to
the genesis file will be located in the <code>deployedBytecode</code> field of the build artifacts file at
<code>/packages/contracts-bedrock/forge-artifacts/L1Block.sol/L1Block.json</code>.</p>
<h3 id="ecotone-l1block-upgrade"><a class="header" href="#ecotone-l1block-upgrade">Ecotone L1Block upgrade</a></h3>
<p>The L1 Attributes Predeployed contract, <code>L1Block.sol</code>, is upgraded as part of the Ecotone upgrade.
The version is incremented to <code>1.2.0</code>, one new storage slot is introduced, and one existing slot
begins to store additional data:</p>
<ul>
<li><code>blobBaseFee</code> (<code>uint256</code>): The L1 blob base fee.</li>
<li><code>blobBaseFeeScalar</code> (<code>uint32</code>): The scalar value applied to the L1 blob base fee portion of the L1 cost.</li>
<li><code>baseFeeScalar</code> (<code>uint32</code>): The scalar value applied to the L1 base fee portion of the L1 cost.</li>
</ul>
<p>The function called by the L1 attributes transaction depends on the network upgrade:</p>
<ul>
<li>Before the Ecotone activation:
<ul>
<li><code>setL1BlockValues</code> is called, following the pre-Ecotone L1 attributes rules.</li>
</ul>
</li>
<li>At the Ecotone activation block:
<ul>
<li><code>setL1BlockValues</code> function MUST be called, except if activated at genesis.
The contract is upgraded later in this block, to support <code>setL1BlockValuesEcotone</code>.</li>
</ul>
</li>
<li>After the Ecotone activation:
<ul>
<li><code>setL1BlockValues</code> function is deprecated and MUST never be called.</li>
<li><code>setL1BlockValuesEcotone</code> MUST be called with the new Ecotone attributes.</li>
</ul>
</li>
</ul>
<p><code>setL1BlockValuesEcotone</code> uses a tightly packed encoding for its parameters, which is described in
<a href="protocol/ecotone/../deposits.html#l1-attributes-deposited-transaction-calldata">L1 Attributes Deposited Transaction Calldata</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="fjord-network-upgrade"><a class="header" href="#fjord-network-upgrade">Fjord Network Upgrade</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/fjord/overview.html#execution-layer">Execution Layer</a></li>
<li><a href="protocol/fjord/overview.html#consensus-layer">Consensus Layer</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="execution-layer-2"><a class="header" href="#execution-layer-2">Execution Layer</a></h2>
<ul>
<li><a href="protocol/fjord/../precompiles.html#P256VERIFY">RIP-7212: Precompile for secp256r1 Curve Support</a></li>
<li><a href="protocol/fjord/./exec-engine.html#fees">FastLZ compression for L1 data fee calculation</a></li>
<li><a href="protocol/fjord/./predeploys.html#l1-gas-usage-estimation">Deprecate the <code>getL1GasUsed</code> method on the <code>GasPriceOracle</code> contract</a></li>
<li><a href="protocol/fjord/./exec-engine.html#l1-gas-usage-estimation">Deprecate the <code>L1GasUsed</code> field on the transaction receipt</a></li>
</ul>
<h2 id="consensus-layer-3"><a class="header" href="#consensus-layer-3">Consensus Layer</a></h2>
<ul>
<li><a href="protocol/fjord/./derivation.html#constant-maximum-sequencer-drift">Constant maximum sequencer drift</a></li>
<li><a href="protocol/fjord/./derivation.html#brotli-channel-compression">Brotli channel compression</a></li>
<li><a href="protocol/fjord/./derivation.html#increasing-max_rlp_bytes_per_channel-and-max_channel_bank_size">Increase Max Bytes Per Channel and Max Channel Bank Size</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="l2-execution-engine-1"><a class="header" href="#l2-execution-engine-1">L2 Execution Engine</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/fjord/exec-engine.html#fees">Fees</a>
<ul>
<li><a href="protocol/fjord/exec-engine.html#l1-cost-fees-l1-fee-vault">L1-Cost fees (L1 Fee Vault)</a>
<ul>
<li><a href="protocol/fjord/exec-engine.html#fjord-l1-cost-fee-changes-fastlz-estimator">Fjord L1-Cost fee changes (FastLZ estimator)</a>
<ul>
<li><a href="protocol/fjord/exec-engine.html#fastlz-implementation">FastLZ Implementation</a></li>
<li><a href="protocol/fjord/exec-engine.html#l1-cost-linear-regression-details">L1-Cost linear regression details</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="protocol/fjord/exec-engine.html#l1-gas-usage-estimation">L1 Gas Usage Estimation</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="fees-1"><a class="header" href="#fees-1">Fees</a></h2>
<h3 id="l1-cost-fees-l1-fee-vault-1"><a class="header" href="#l1-cost-fees-l1-fee-vault-1">L1-Cost fees (L1 Fee Vault)</a></h3>
<h4 id="fjord-l1-cost-fee-changes-fastlz-estimator"><a class="header" href="#fjord-l1-cost-fee-changes-fastlz-estimator">Fjord L1-Cost fee changes (FastLZ estimator)</a></h4>
<p>Fjord updates the L1 cost calculation function to use a FastLZ-based compression estimator.
The L1 cost is computed as:</p>
<pre><code class="language-pseudocode">l1FeeScaled = l1BaseFeeScalar*l1BaseFee*16 + l1BlobFeeScalar*l1BlobBaseFee
estimatedSizeScaled = max(minTransactionSize * 1e6, intercept + fastlzCoef*fastlzSize)
l1Fee = estimatedSizeScaled * l1FeeScaled / 1e12
</code></pre>
<p>The final <code>l1Fee</code> computation is an unlimited precision unsigned integer computation, with the result in Wei and
having <code>uint256</code> range. The values in this computation, are as follows:</p>
<div class="table-wrapper"><table><thead><tr><th>Input arg</th><th>Type</th><th>Description</th><th>Value</th></tr></thead><tbody>
<tr><td><code>l1BaseFee</code></td><td><code>uint256</code></td><td>L1 base fee of the latest L1 origin registered in the L2 chain</td><td>varies, L1 fee</td></tr>
<tr><td><code>l1BlobBaseFee</code></td><td><code>uint256</code></td><td>Blob gas price of the latest L1 origin registered in the L2 chain</td><td>varies, L1 fee</td></tr>
<tr><td><code>fastlzSize</code></td><td><code>uint256</code></td><td>Size of the FastLZ-compressed RLP-encoded signed tx</td><td>varies, per transaction</td></tr>
<tr><td><code>l1BaseFeeScalar</code></td><td><code>uint32</code></td><td>L1 base fee scalar, scaled by <code>1e6</code></td><td>varies, L2 configuration</td></tr>
<tr><td><code>l1BlobFeeScalar</code></td><td><code>uint32</code></td><td>L1 blob fee scalar, scaled by <code>1e6</code></td><td>varies, L2 configuration</td></tr>
<tr><td><code>intercept</code></td><td><code>int32</code></td><td>Intercept constant, scaled by <code>1e6</code> (can be negative)</td><td>-42_585_600</td></tr>
<tr><td><code>fastlzCoef</code></td><td><code>uint32</code></td><td>FastLZ coefficient, scaled by <code>1e6</code></td><td>836_500</td></tr>
<tr><td><code>minTransactionSize</code></td><td><code>uint32</code></td><td>A lower bound on transaction size, in bytes</td><td>100</td></tr>
</tbody></table>
</div>
<p>Previously, <code>l1BaseFeeScalar</code> and <code>l1BlobFeeScalar</code> were used to encode the compression ratio, due to the inaccuracy of
the L1 cost function. However, the new cost function takes into account the compression ratio, so these scalars should
be adjusted to account for any previous compression ratio they encoded.</p>
<h5 id="fastlz-implementation"><a class="header" href="#fastlz-implementation">FastLZ Implementation</a></h5>
<p>All compression algorithms must be implemented equivalently to the <code>fastlz_compress</code> function in <code>fastlz.c</code> at the
following <a href="https://github.com/ariya/FastLZ/blob/344eb4025f9ae866ebf7a2ec48850f7113a97a42/fastlz.c#L482-L506">commit</a>.</p>
<h5 id="l1-cost-linear-regression-details"><a class="header" href="#l1-cost-linear-regression-details">L1-Cost linear regression details</a></h5>
<p>The <code>intercept</code> and <code>fastlzCoef</code> constants are calculated by linear regression using a dataset
of previous L2 transactions. The dataset is generated by iterating over all transactions in a given time range, and
performing the following actions. For each transaction:</p>
<ol>
<li>Compress the payload using FastLZ. Record the size of the compressed payload as <code>fastlzSize</code>.</li>
<li>Emulate the change in batch size adding the transaction to a batch, compressed with Brotli 10. Record the change in
batch size as <code>bestEstimateSize</code>.</li>
</ol>
<p>Once this dataset is generated, a linear regression can be calculated using the <code>bestEstimateSize</code> as
the dependent variable and <code>fastlzSize</code> as the independent variable.</p>
<p>We generated a dataset from two weeks of post-Ecotone transactions on Optimism Mainnet, as we found that was
the most representative of performance across multiple chains and time periods. More details on the linear regression
and datasets used can be found in this <a href="https://github.com/roberto-bayardo/compression-analysis/tree/main">repository</a>.</p>
<h3 id="l1-gas-usage-estimation"><a class="header" href="#l1-gas-usage-estimation">L1 Gas Usage Estimation</a></h3>
<p>The <code>L1GasUsed</code> property is deprecated due to it not capturing the L1 blob gas used by a transaction, and will be
removed in a future network upgrade. Users can continue to use the <code>L1Fee</code> field to retrieve the L1 fee for a given
transaction.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="fjord-l2-chain-derivation-changes"><a class="header" href="#fjord-l2-chain-derivation-changes">Fjord L2 Chain Derivation Changes</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/fjord/derivation.html#protocol-parameter-changes">Protocol Parameter Changes</a>
<ul>
<li><a href="protocol/fjord/derivation.html#timestamp-activation">Timestamp Activation</a></li>
<li><a href="protocol/fjord/derivation.html#constant-maximum-sequencer-drift">Constant Maximum Sequencer Drift</a>
<ul>
<li><a href="protocol/fjord/derivation.html#rationale">Rationale</a></li>
<li><a href="protocol/fjord/derivation.html#security-considerations">Security Considerations</a></li>
</ul>
</li>
<li><a href="protocol/fjord/derivation.html#increasing-max_rlp_bytes_per_channel-and-max_channel_bank_size">Increasing <code>MAX_RLP_BYTES_PER_CHANNEL</code> and <code>MAX_CHANNEL_BANK_SIZE</code></a>
<ul>
<li><a href="protocol/fjord/derivation.html#rationale-1">Rationale</a></li>
<li><a href="protocol/fjord/derivation.html#security-considerations-1">Security Considerations</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="protocol/fjord/derivation.html#brotli-channel-compression">Brotli Channel Compression</a></li>
<li><a href="protocol/fjord/derivation.html#network-upgrade-automation-transactions">Network upgrade automation transactions</a>
<ul>
<li><a href="protocol/fjord/derivation.html#gaspriceoracle-deployment">GasPriceOracle Deployment</a></li>
<li><a href="protocol/fjord/derivation.html#gaspriceoracle-proxy-update">GasPriceOracle Proxy Update</a></li>
<li><a href="protocol/fjord/derivation.html#gaspriceoracle-enable-fjord">GasPriceOracle Enable Fjord</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h1 id="protocol-parameter-changes"><a class="header" href="#protocol-parameter-changes">Protocol Parameter Changes</a></h1>
<p>The following table gives an overview of the changes in parameters.</p>
<div class="table-wrapper"><table><thead><tr><th>Parameter</th><th>Pre-Fjord (default) value</th><th>Fjord value</th><th>Notes</th></tr></thead><tbody>
<tr><td><code>max_sequencer_drift</code></td><td>600</td><td>1800</td><td>Was a protocol parameter since Bedrock. Now becomes a constant.</td></tr>
<tr><td><code>MAX_RLP_BYTES_PER_CHANNEL</code></td><td>10,000,000</td><td>100,000,000</td><td>Protocol Constant is increasing.</td></tr>
<tr><td><code>MAX_CHANNEL_BANK_SIZE</code></td><td>100,000,000</td><td>1,000,000,000</td><td>Protocol Constant is increasing.</td></tr>
</tbody></table>
</div>
<h2 id="timestamp-activation"><a class="header" href="#timestamp-activation">Timestamp Activation</a></h2>
<p>Fjord, like other network upgrades, is activated at a timestamp.
Changes to the L2 Block execution rules are applied when the <code>L2 Timestamp &gt;= activation time</code>.
Changes to derivation are applied when it is considering data from a L1 Block whose timestamp
is greater than or equal to the activation timestamp.
The change of the <code>max_sequencer_drift</code> parameter activates with the L1 origin block timestamp.</p>
<p>If Fjord is not activated at genesis, it must be activated at least one block after the Ecotone
activation block. This ensures that the network upgrade transactions don't conflict.</p>
<h2 id="constant-maximum-sequencer-drift"><a class="header" href="#constant-maximum-sequencer-drift">Constant Maximum Sequencer Drift</a></h2>
<p>With Fjord, the <code>max_sequencer_drift</code> parameter becomes a constant of value <code>1800</code> <em>seconds</em>,
translating to a fixed maximum sequencer drift of 30 minutes.</p>
<p>Before Fjord, this was a chain parameter that was set once at chain creation, with a default
value of <code>600</code> seconds, i.e., 10 minutes. Most chains use this value currently.</p>
<h3 id="rationale-1"><a class="header" href="#rationale-1">Rationale</a></h3>
<p>Discussions amongst chain operators came to the unilateral conclusion that a larger value than the
current default would be easier to work with. If a sequencer's L1 connection breaks, this drift
value determines how long it can still produce blocks without violating the timestamp drift
derivation rules.</p>
<p>It was furthermore agreed that configurability after this increase is not important. So it is being
made a constant. An alternative idea that is being considered for a future hardfork is to make this
an L1-configurable protocol parameter via the <code>SystemConfig</code> update mechanism.</p>
<h3 id="security-considerations-2"><a class="header" href="#security-considerations-2">Security Considerations</a></h3>
<p>The rules around the activation time are deliberately being kept simple, so no other logic needs to
be applied other than to change the parameter to a constant. The first Fjord block would in theory
accept older L1-origin timestamps than its predecessor. However, since the L1 origin timestamp must
also increase, the only noteworthy scenario that can happen is that the first few Fjord blocks will
be in the same epoch as the last pre-Fjord blocks, even if these blocks would not be allowed to
have these L1-origin timestamps according to pre-Fjord rules. So the same L1 timestamp would be
shared within a pre- and post-Fjord mixed epoch. This is considered a feature and is not considered
a security issue.</p>
<h2 id="increasing-max_rlp_bytes_per_channel-and-max_channel_bank_size"><a class="header" href="#increasing-max_rlp_bytes_per_channel-and-max_channel_bank_size">Increasing <code>MAX_RLP_BYTES_PER_CHANNEL</code> and <code>MAX_CHANNEL_BANK_SIZE</code></a></h2>
<p>With Fjord, <code>MAX_RLP_BYTES_PER_CHANNEL</code> will be increased from 10,000,000 bytes to 100,000,000 bytes,
and <code>MAX_CHANNEL_BANK_SIZE</code> will be increased from 100,000,000 bytes to 1,000,000,000 bytes.</p>
<p>The usage of <code>MAX_RLP_BYTES_PER_CHANNEL</code> is defined in <a href="protocol/fjord/../derivation.html#channel-format">Channel Format</a>.
The usage of <code>MAX_CHANNEL_BANK_SIZE</code> is defined in <a href="protocol/fjord/../derivation.html#pruning">Channel Bank Pruning</a>.</p>
<p>Span Batches previously had a limit <code>MAX_SPAN_BATCH_SIZE</code> which was equal to <code>MAX_RLP_BYTES_PER_CHANNEL</code>.
Fjord creates a new constant <code>MAX_SPAN_BATCH_ELEMENT_COUNT</code> for the element count limit &amp; removes
<code>MAX_SPAN_BATCH_SIZE</code>. The size of the channel is still checked with <code>MAX_RLP_BYTES_PER_CHANNEL</code>.</p>
<p>The new value will be used when the timestamp of the L1 origin of the derivation pipeline &gt;= the Fjord activation
timestamp.</p>
<h3 id="rationale-2"><a class="header" href="#rationale-2">Rationale</a></h3>
<p>A block with a gas limit of 30 Million gas has a maximum theoretical size of 7.5 Megabytes by being filled up
with transactions have only zeroes. Currently, a byte with the value <code>0</code> consumes 4 gas.
If the block gas limit is raised above 40 Million gas, it is possible to create a block that is large than
<code>MAX_RLP_BYTES_PER_CHANNEL</code>.
L2 blocks cannot be split across channels which means that a block that is larger than <code>MAX_RLP_BYTES_PER_CHANNEL</code>
cannot be batch submitted.
By raising this limit to 100,000,000 bytes, we can batch submit blocks with a gas limit of up to 400 Million Gas.
In addition, we are able to improve compression ratios by increasing the amount of data that can be inserted into a
single channel.
With 33% compression ratio over 6 blobs, we are currently submitting 2.2 MB of compressed data &amp; 0.77 MB of uncompressed
data per channel.
This will allow use to use up to approximately 275 blobs per channel.</p>
<p>Raising <code>MAX_CHANNEL_BANK_SIZE</code> is helpful to ensure that we are able to process these larger channels. We retain the
same ratio of 10 between <code>MAX_RLP_BYTES_PER_CHANNEL</code> and <code>MAX_CHANNEL_BANK_SIZE</code>.</p>
<h3 id="security-considerations-3"><a class="header" href="#security-considerations-3">Security Considerations</a></h3>
<p>Raising the these limits increases the amount of resources a rollup node would require.
Specifically nodes may have to allocate large chunks of memory for a channel and will have to potentially allocate more
memory to the channel bank.
<code>MAX_RLP_BYTES_PER_CHANNEL</code> was originally added to avoid zip bomb attacks.
The system is still exposed to these attacks, but these limits are straightforward to handle in a node.</p>
<p>The Fault Proof environment is more constrained than a typical node and increasing these limits will require more
resources than are currently required.
The change in <code>MAX_CHANNEL_BANK_SIZE</code> is not relevant to the first implementation of Fault Proofs because this limit
only tells the node when to start pruning &amp; once memory is allocated in the FPVM, it is not garbage collected.
This means that increasing <code>MAX_CHANNEL_BANK_SIZE</code> does not increase the maximum resource usage of the FPP.</p>
<p>Increasing <code>MAX_RLP_BYTES_PER_CHANNEL</code> could cause more resource usage in FPVM; however, we consider this
increase reasonable because this increase is in the amount of data handled at once rather than the total
amount of data handled in the program. Instead of using a single channel, the batcher could submit 10 channels
prior to this change which would cause the Fault Proof Program to consume a very similar amount of resources.</p>
<h1 id="brotli-channel-compression"><a class="header" href="#brotli-channel-compression">Brotli Channel Compression</a></h1>
<p>Fjord introduces a new versioned channel encoding format to support alternate compression
algorithms, with the <a href="protocol/fjord/../derivation.html#channel-format">legacy channel format</a> remaining supported. The
versioned format is as follows:</p>
<pre><code class="language-text">channel_encoding = channel_version_byte ++ compress(rlp_batches)
</code></pre>
<p>The <code>channel_version_byte</code> must never have its 4 lower order bits set to <code>0b1000 = 8</code> or <code>0b1111 = 15</code>, which are reserved for usage by the header byte of zlib encoded data (see page 5 of
<a href="https://www.rfc-editor.org/rfc/rfc1950.html">RFC-1950</a>). This allows a channel decoder to determine if a channel encoding is legacy or
versioned format by testing for these bit values. If the channel encoding is determined to be
versioned format, the only valid <code>channel_version_byte</code> is <code>1</code>, which indicates <code>compress()</code> is the
Brotli compression algorithm (as specified in <a href="https://datatracker.ietf.org/doc/html/rfc7932">RFC-7932</a>) with no custom dictionary.</p>
<h1 id="network-upgrade-automation-transactions-2"><a class="header" href="#network-upgrade-automation-transactions-2">Network upgrade automation transactions</a></h1>
<p>The Fjord hardfork activation block contains the following transactions, in this order:</p>
<ul>
<li>L1 Attributes Transaction</li>
<li>User deposits from L1</li>
<li>Network Upgrade Transactions
<ul>
<li>GasPriceOracle deployment</li>
<li>Update GasPriceOracle Proxy ERC-1967 Implementation Slot</li>
<li>GasPriceOracle Enable Fjord</li>
</ul>
</li>
</ul>
<p>To not modify or interrupt the system behavior around gas computation, this block will not include any sequenced
transactions by setting <code>noTxPool: true</code>.</p>
<h2 id="gaspriceoracle-deployment-1"><a class="header" href="#gaspriceoracle-deployment-1">GasPriceOracle Deployment</a></h2>
<p>The <code>GasPriceOracle</code> contract is upgraded to support the new Fjord L1 data fee computation. Post fork this contract
will use FastLZ to compute the L1 data fee.</p>
<p>To perform this upgrade, a deposit transaction is derived with the following attributes:</p>
<ul>
<li><code>from</code>: <code>0x4210000000000000000000000000000000000002</code></li>
<li><code>to</code>: <code>null</code>,</li>
<li><code>mint</code>: <code>0</code></li>
<li><code>value</code>: <code>0</code></li>
<li><code>gasLimit</code>: <code>1,450,000</code></li>
<li><code>data</code>: <code>0x60806040523...</code> (<a href="protocol/fjord/../../static/bytecode/fjord-gas-price-oracle-deployment.txt">full bytecode</a>)</li>
<li><code>sourceHash</code>: <code>0x86122c533fdcb89b16d8713174625e44578a89751d96c098ec19ab40a51a8ea3</code>
computed with the "Upgrade-deposited" type, with `intent = "Fjord: Gas Price Oracle Deployment"</li>
</ul>
<p>This results in the Fjord GasPriceOracle contract being deployed to <code>0xa919894851548179A0750865e7974DA599C0Fac7</code>,
to verify:</p>
<pre><code class="language-bash">cast compute-address --nonce=0 0x4210000000000000000000000000000000000002
Computed Address: 0xa919894851548179A0750865e7974DA599C0Fac7
</code></pre>
<p>Verify <code>sourceHash</code>:</p>
<pre><code class="language-bash">cast keccak $(cast concat-hex 0x0000000000000000000000000000000000000000000000000000000000000002 $(cast keccak "Fjord: Gas Price Oracle Deployment"))
# 0x86122c533fdcb89b16d8713174625e44578a89751d96c098ec19ab40a51a8ea3
</code></pre>
<p>Verify <code>data</code>:</p>
<pre><code class="language-bash">git checkout 52abfb507342191ae1f960b443ae8aec7598755c
pnpm clean &amp;&amp; pnpm install &amp;&amp; pnpm build
jq -r ".bytecode.object" packages/contracts-bedrock/forge-artifacts/GasPriceOracle.sol/GasPriceOracle.json
</code></pre>
<p>This transaction MUST deploy a contract with the following code hash
<code>0xa88fa50a2745b15e6794247614b5298483070661adacb8d32d716434ed24c6b2</code>.</p>
<h2 id="gaspriceoracle-proxy-update-1"><a class="header" href="#gaspriceoracle-proxy-update-1">GasPriceOracle Proxy Update</a></h2>
<p>This transaction updates the GasPriceOracle Proxy ERC-1967 implementation slot to point to the new GasPriceOracle
deployment.</p>
<p>A deposit transaction is derived with the following attributes:</p>
<ul>
<li><code>from</code>: <code>0x0000000000000000000000000000000000000000</code></li>
<li><code>to</code>: <code>0x420000000000000000000000000000000000000F</code> (Gas Price Oracle Proxy)</li>
<li><code>mint</code>: <code>0</code></li>
<li><code>value</code>: <code>0</code></li>
<li><code>gasLimit</code>: <code>50,000</code></li>
<li><code>data</code>: <code>0x3659cfe6000000000000000000000000a919894851548179a0750865e7974da599c0fac7</code></li>
<li><code>sourceHash</code>: <code>0x1e6bb0c28bfab3dc9b36ffb0f721f00d6937f33577606325692db0965a7d58c6</code>
computed with the "Upgrade-deposited" type, with <code>intent = "Fjord: Gas Price Oracle Proxy Update"</code></li>
</ul>
<p>Verify data:</p>
<pre><code class="language-bash">cast concat-hex $(cast sig "upgradeTo(address)") $(cast abi-encode "upgradeTo(address)" 0xa919894851548179A0750865e7974DA599C0Fac7)
# 0x3659cfe6000000000000000000000000a919894851548179a0750865e7974da599c0fac7
</code></pre>
<p>Verify <code>sourceHash</code>:</p>
<pre><code class="language-bash">cast keccak $(cast concat-hex 0x0000000000000000000000000000000000000000000000000000000000000002 $(cast keccak "Fjord: Gas Price Oracle Proxy Update"))
# 0x1e6bb0c28bfab3dc9b36ffb0f721f00d6937f33577606325692db0965a7d58c6
</code></pre>
<h2 id="gaspriceoracle-enable-fjord"><a class="header" href="#gaspriceoracle-enable-fjord">GasPriceOracle Enable Fjord</a></h2>
<p>This transaction informs the GasPriceOracle to start using the Fjord gas calculation formula.</p>
<p>A deposit transaction is derived with the following attributes:</p>
<ul>
<li><code>from</code>: <code>0xDeaDDEaDDeAdDeAdDEAdDEaddeAddEAdDEAd0001</code> (Depositer Account)</li>
<li><code>to</code>: <code>0x420000000000000000000000000000000000000F</code> (Gas Price Oracle Proxy)</li>
<li><code>mint</code>: <code>0</code></li>
<li><code>value</code>: <code>0</code></li>
<li><code>gasLimit</code>: <code>90,000</code></li>
<li><code>data</code>: <code>0x8e98b106</code></li>
<li><code>sourceHash</code>: <code>0xbac7bb0d5961cad209a345408b0280a0d4686b1b20665e1b0f9cdafd73b19b6b</code>,
computed with the "Upgrade-deposited" type, with `intent = "Fjord: Gas Price Oracle Set Fjord"</li>
</ul>
<p>Verify data:</p>
<pre><code class="language-bash">cast sig "setFjord()"
0x8e98b106
</code></pre>
<p>Verify <code>sourceHash</code>:</p>
<pre><code class="language-bash">cast keccak $(cast concat-hex 0x0000000000000000000000000000000000000000000000000000000000000002 $(cast keccak "Fjord: Gas Price Oracle Set Fjord"))
# 0xbac7bb0d5961cad209a345408b0280a0d4686b1b20665e1b0f9cdafd73b19b6b
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="predeploys-1"><a class="header" href="#predeploys-1">Predeploys</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/fjord/predeploys.html#gaspriceoracle">GasPriceOracle</a>
<ul>
<li><a href="protocol/fjord/predeploys.html#l1-gas-usage-estimation">L1 Gas Usage Estimation</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="gaspriceoracle-1"><a class="header" href="#gaspriceoracle-1">GasPriceOracle</a></h2>
<p>Following the Fjord upgrade, three additional values used for L1 fee computation are:</p>
<ul>
<li>costIntercept</li>
<li>costFastlzCoef</li>
<li>minTransactionSize</li>
</ul>
<p>These values are hard-coded constants in the <code>GasPriceOracle</code> contract. The
calculation follows the same formula outlined in the
<a href="protocol/fjord/./exec-engine.html#fjord-l1-cost-fee-changes-fastlz-estimator">Fjord L1-Cost fee changes (FastLZ estimator)</a>
section.</p>
<p>A new method is introduced: <code>getL1FeeUpperBound(uint256)</code>. This method returns an upper bound for the L1 fee
for a given transaction size. It is provided for callers who wish to estimate L1 transaction costs in the
write path, and is much more gas efficient than <code>getL1Fee</code>.</p>
<p>The upper limit overhead is assumed to be <code>original/255+16</code>, borrowed from LZ4. According to historical data, this
approach can encompass more than 99.99% of transactions.</p>
<p>This is implemented as follows:</p>
<pre><code class="language-solidity">function getL1FeeUpperBound(uint256 unsignedTxSize) external view returns (uint256) {
    // Add 68 to account for unsigned tx
    uint256 txSize = unsignedTxSize + 68;
    // txSize / 255 + 16 is the practical fastlz upper-bound covers 99.99% txs.
    uint256 flzUpperBound = txSize + txSize / 255 + 16;

    int256 estimatedSize = costIntercept + costFastlzCoef * flzUpperBound;
    if (estimatedSize &lt; minTransactionSize) {
        estimatedSize = minTransactionSize;
    }
  
    uint256 l1FeeScaled = baseFeeScalar() * l1BaseFee() * 16 + blobBaseFeeScalar() * blobBaseFee();
    return uint256(estimatedSize) * l1FeeScaled / (10 ** (DECIMALS * 2));
}
</code></pre>
<h3 id="l1-gas-usage-estimation-1"><a class="header" href="#l1-gas-usage-estimation-1">L1 Gas Usage Estimation</a></h3>
<p>The <code>getL1GasUsed</code> method is updated to take into account the improved <a href="protocol/fjord/./exec-engine.html#fees">compression estimation</a>
accuracy as part of the Fjord upgrade.</p>
<pre><code class="language-solidity">function getL1GasUsed(bytes memory _data) public view returns (uint256) {
    if (isFjord) {
      // Add 68 to the size to account for the unsigned tx
      int256 flzSize = LibZip.flzCompress(_data).length + 68;

      int256 estimatedSize = costIntercept + costFastlzCoef * flzSize;
      if (estimatedSize &lt; minTransactionSize) {
        estimatedSize = minTransactionSize;
      }

      // Assume the compressed data is mostly non-zero, and would pay 16 gas per calldata byte
      return estimatedSize * 16;
    }
    // ...
}
</code></pre>
<p>The <code>getL1GasUsed</code> method is deprecated as of Fjord because it does not capture that there are
two kinds of gas being consumed due to the introduction of blobs. This function will revert when
called in a future upgrade.</p>
<p>Users can continue to use the <code>getL1Fee</code> method to estimate the L1 fee for a given transaction, or the
new <code>getL1FeeUpperBound</code> method introduced by Fjord as a lower gas alternative.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="granite-network-upgrade"><a class="header" href="#granite-network-upgrade">Granite Network Upgrade</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/granite/overview.html#execution-layer">Execution Layer</a></li>
<li><a href="protocol/granite/overview.html#consensus-layer">Consensus Layer</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="execution-layer-3"><a class="header" href="#execution-layer-3">Execution Layer</a></h2>
<ul>
<li><a href="protocol/granite/./exec-engine.html#bn256pairing-precompile-input-restriction">Limit <code>bn256Pairing</code> precompile input size</a></li>
</ul>
<h2 id="consensus-layer-4"><a class="header" href="#consensus-layer-4">Consensus Layer</a></h2>
<ul>
<li><a href="protocol/granite/./derivation.html#reduce-channel-timeout">Reduce Channel Timeout to 50</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="l2-execution-engine-2"><a class="header" href="#l2-execution-engine-2">L2 Execution Engine</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/granite/exec-engine.html#evm-changes">EVM Changes</a>
<ul>
<li><a href="protocol/granite/exec-engine.html#bn256pairing-precompile-input-restriction"><code>bn256Pairing</code> precompile input restriction</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="evm-changes"><a class="header" href="#evm-changes">EVM Changes</a></h2>
<h3 id="bn256pairing-precompile-input-restriction"><a class="header" href="#bn256pairing-precompile-input-restriction"><code>bn256Pairing</code> precompile input restriction</a></h3>
<p>The <code>bn256Pairing</code> precompile execution has additional validation on its input.
The precompile reverts if its input is larger than <code>112687</code> bytes.
This is the input size that consumes approximately 20 M gas given the latest <code>bn256Pairing</code> gas schedule on L2.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="granite-l2-chain-derivation-changes"><a class="header" href="#granite-l2-chain-derivation-changes">Granite L2 Chain Derivation Changes</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/granite/derivation.html#protocol-parameter-changes">Protocol Parameter Changes</a></li>
<li><a href="protocol/granite/derivation.html#reduce-channel-timeout">Reduce Channel Timeout</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="protocol-parameter-changes-1"><a class="header" href="#protocol-parameter-changes-1">Protocol Parameter Changes</a></h2>
<p>The following table gives an overview of the changes in parameters.</p>
<div class="table-wrapper"><table><thead><tr><th>Parameter</th><th>Pre-Granite (default) value</th><th>Granite value</th><th>Notes</th></tr></thead><tbody>
<tr><td><code>CHANNEL_TIMEOUT</code></td><td>300</td><td>50</td><td>Protocol Constant is reduced.</td></tr>
</tbody></table>
</div>
<h2 id="reduce-channel-timeout"><a class="header" href="#reduce-channel-timeout">Reduce Channel Timeout</a></h2>
<p>With Granite, the <code>CHANNEL_TIMEOUT</code> is reduced from 300 to 50 L1 Blocks.
The new rule activation timestamp is based on the blocktime of the L1 block that the channel frame is included.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="holocene-network-upgrade"><a class="header" href="#holocene-network-upgrade">Holocene Network Upgrade</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/holocene/overview.html#execution-layer">Execution Layer</a></li>
<li><a href="protocol/holocene/overview.html#consensus-layer">Consensus Layer</a></li>
<li><a href="protocol/holocene/overview.html#smart-contracts">Smart Contracts</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="execution-layer-4"><a class="header" href="#execution-layer-4">Execution Layer</a></h2>
<ul>
<li><a href="protocol/holocene/./exec-engine.html#dynamic-eip-1559-parameters">Dynamic EIP-1559 Parameters</a></li>
</ul>
<h2 id="consensus-layer-5"><a class="header" href="#consensus-layer-5">Consensus Layer</a></h2>
<ul>
<li><a href="protocol/holocene/./derivation.html#holocene-derivation">Holocene Derivation</a></li>
</ul>
<h2 id="smart-contracts"><a class="header" href="#smart-contracts">Smart Contracts</a></h2>
<ul>
<li><a href="protocol/holocene/./system-config.html">System Config</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="holocene-l2-chain-derivation-changes"><a class="header" href="#holocene-l2-chain-derivation-changes">Holocene L2 Chain Derivation Changes</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/holocene/derivation.html#holocene-derivation">Holocene Derivation</a>
<ul>
<li><a href="protocol/holocene/derivation.html#summary">Summary</a></li>
<li><a href="protocol/holocene/derivation.html#frame-queue">Frame Queue</a></li>
<li><a href="protocol/holocene/derivation.html#channel-bank">Channel Bank</a>
<ul>
<li><a href="protocol/holocene/derivation.html#pruning">Pruning</a></li>
<li><a href="protocol/holocene/derivation.html#timeout">Timeout</a></li>
<li><a href="protocol/holocene/derivation.html#reading--frame-loading">Reading &amp; Frame Loading</a></li>
</ul>
</li>
<li><a href="protocol/holocene/derivation.html#span-batches">Span Batches</a></li>
<li><a href="protocol/holocene/derivation.html#batch-queue">Batch Queue</a>
<ul>
<li><a href="protocol/holocene/derivation.html#fast-channel-invalidation">Fast Channel Invalidation</a></li>
</ul>
</li>
<li><a href="protocol/holocene/derivation.html#engine-queue">Engine Queue</a></li>
<li><a href="protocol/holocene/derivation.html#attributes-builder">Attributes Builder</a></li>
<li><a href="protocol/holocene/derivation.html#activation">Activation</a></li>
</ul>
</li>
<li><a href="protocol/holocene/derivation.html#rationale">Rationale</a>
<ul>
<li><a href="protocol/holocene/derivation.html#strict-frame-and-batch-ordering">Strict Frame and Batch Ordering</a></li>
<li><a href="protocol/holocene/derivation.html#partial-span-batch-validity">Partial Span Batch Validity</a></li>
<li><a href="protocol/holocene/derivation.html#fast-channel-invalidation-1">Fast Channel Invalidation</a></li>
<li><a href="protocol/holocene/derivation.html#steady-block-derivation">Steady Block Derivation</a></li>
<li><a href="protocol/holocene/derivation.html#less-defensive-protocol">Less Defensive Protocol</a></li>
</ul>
</li>
<li><a href="protocol/holocene/derivation.html#security-and-implementation-considerations">Security and Implementation Considerations</a>
<ul>
<li><a href="protocol/holocene/derivation.html#reorgs">Reorgs</a></li>
<li><a href="protocol/holocene/derivation.html#batcher-hardening">Batcher Hardening</a></li>
<li><a href="protocol/holocene/derivation.html#sync-start">Sync Start</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h1 id="holocene-derivation"><a class="header" href="#holocene-derivation">Holocene Derivation</a></h1>
<h2 id="summary"><a class="header" href="#summary">Summary</a></h2>
<p>The Holocene hardfork introduces several changes to block derivation rules that render the
derivation pipeline mostly stricter and simpler, improve worst-case scenarios for Fault Proofs and
Interop. The changes are:</p>
<ul>
<li><em>Strict Batch Ordering</em> required batches within and across channels to be strictly ordered.</li>
<li><em>Partial Span Batch Validity</em> determines the validity of singular batches from a span batch
individually, only invalidating the remaining span batch upon the first invalid singular batch.</li>
<li><em>Fast Channel Invalidation</em>, similarly to Partial Span Batch Validity applied to the channel
layer, forward-invalidates a channel upon finding an invalid batch.</li>
<li><em>Steady Block Derivation</em> derives invalid payload attributes immediately as deposit-only
blocks.</li>
</ul>
<p>The combined effect of these changes is that the impact of an invalid batch is contained to the
block number at hand, instead of propagating forwards or backwards in the safe chain, while also
containing invalid payloads at the engine stage to the engine, not propagating backwards in the
derivation pipeline.</p>
<p>Holocene derivation comprises the following changes to the derivation pipeline to achieve the above.</p>
<h2 id="frame-queue-1"><a class="header" href="#frame-queue-1">Frame Queue</a></h2>
<p>The frame queue retains its function and queues all frames of the last batcher transaction(s) that
weren't assembled into a channel yet. Holocene still allows multiple frames per batcher transaction,
possibly from different channels. As before, this allows for optionally filling up the remaining
space of a batcher transaction with a starting frame of the next channel.</p>
<p>However, Strict Batch Ordering leads to the following additional checks and rules to the frame
queue:</p>
<ul>
<li>If a <em>non-first frame</em> (i.e., a frame with index &gt;0) decoded from a batcher transaction is <em>out of
order</em>, it is <strong>immediately dropped</strong>, where the frame is called <em>out of order</em> if
<ul>
<li>its frame number is not the previous frame's plus one, if it has the same channel ID, or</li>
<li>the previous frame already closed the channel with the same ID, or</li>
<li>the non-first frame has a different channel ID than the previous frame in the frame queue.</li>
</ul>
</li>
<li>If a <em>first frame</em> is decoded while the previous frame isn't a <em>last frame</em> (i.e., <code>is_last</code> is
<code>false</code>), all previous frames for the same channel are dropped and this new first frame remains in
the queue.</li>
</ul>
<p>These rules guarantee that the frame queue always holds frames whose indices are ordered,
contiguous and include the first frame, per channel. Plus, a first frame of a channel is either the
first frame in the queue, or is preceded by a closing frame of a previous channel.</p>
<p>Note that these rules are in contrast to pre-Holocene rules, where out of order frames were
buffered. Pre-Holocene, frame validity checks were only done at the Channel Bank stage. Performing
these checks already at the Frame Queue stage leads to faster discarding of invalid frames, keeping
the memory consumption of any implementation leaner.</p>
<h2 id="channel-bank-1"><a class="header" href="#channel-bank-1">Channel Bank</a></h2>
<p>Because channel frames have to arrive in order, the Channel Bank becomes much simpler and only
holds at most a single channel at a time.</p>
<h3 id="pruning-1"><a class="header" href="#pruning-1">Pruning</a></h3>
<p>Pruning is vastly simplified as there is at most only one open channel in the channel bank. So the
channel bank's queue becomes effectively a staging slot for a single channel, the <em>staging channel</em>.
The <code>MAX_CHANNEL_BANK_SIZE</code> parameter is no longer used, and the compressed size of the staging
channel is required to be at most <code>MAX_RLP_BYTES_PER_CHANNEL</code> (else the channel is dropped). Note this
latter rule is both a distinct condition and distinct effect, compared to the existing rule
that the <em>uncompressed</em> size of any given channel is <em>clipped</em> to <code>MAX_RLP_BYTES_PER_CHANNEL</code> <a href="protocol/holocene/../derivation.html#channel-format">during decompression</a>.</p>
<h3 id="timeout"><a class="header" href="#timeout">Timeout</a></h3>
<p>The timeout is applied as before, just only to the single staging channel.</p>
<h3 id="reading--frame-loading"><a class="header" href="#reading--frame-loading">Reading &amp; Frame Loading</a></h3>
<p>The frame queue is guaranteed to hold ordered and contiguous frames, per channel. So reading and
frame loading becomes simpler in the channel bank:</p>
<ul>
<li>A first frame for a new channel starts a new channel as the staging channel.
<ul>
<li>If there already is an open, non-completed staging channel, it is dropped and replaced by this
new channel. This is consistent with how the frame queue drops all frames of a non-closed channel
upon the arrival of a first frame for a new channel.</li>
</ul>
</li>
<li>If the current channel is timed-out, but not yet pruned, and the incoming frame would be the next
correct frame for this channel, the frame and channel are dropped, including all future frames for
the channel that might still be in the frame queue. Note that the equivalent rule was already
present pre-Holocene.</li>
<li>After adding a frame to the staging channel, the channel is dropped if its raw compressed size as
defined in the Bedrock specification is larger than <code>MAX_RLP_BYTES_PER_CHANNEL</code>. This rule replaces
the total limit of all channels' combined sizes by <code>MAX_CHANNEL_BANK_SIZE</code> before Holocene.</li>
</ul>
<h2 id="span-batches-1"><a class="header" href="#span-batches-1">Span Batches</a></h2>
<p>Partial Span Batch Validity changes the atomic validity model of <a href="protocol/holocene/../delta/span-batches.html">Span Batches</a>.
In Holocene, a span batch is treated as an optional stage in the derivation pipeline that sits
before the batch queue, so that the batch queue pulls singular batches from this previous Span Batch
stage. When encountering an invalid singular batch, it is dropped, as is the remaining span batch
for consistency reasons. We call this <em>forwards-invalidation</em>. However, we don't
<em>backwards-invalidate</em> previous valid batches that came from the same span batch, as pre-Holocene.</p>
<p>When a batch derived from the current staging channel is a singular batch, it is directly forwarded
to the batch queue. Otherwise, it is set as the current span batch in the span batch stage. The
following span batch validity checks are done, before singular batches are derived from it.
Definitions are borrowed from the <a href="protocol/holocene/../delta/span-batches.html">original Span Batch specs</a>.</p>
<ul>
<li>If the span batch <em>L1 origin check</em> is not part of the canonical L1 chain, the span batch is
invalid.</li>
<li>A failed parent check invalidates the span batch.</li>
<li>If <code>span_start.timestamp &gt; next_timestamp</code>, the span batch is invalid, because we disallow gaps
due to the new strict batch ordering rules.</li>
<li>If <code>span_end.timestamp &lt; next_timestamp</code>, the span batch is set to have <code>past</code> validity, as it
doesn't contain any new batches (this would also happen if applying timestamp checks to each derived
singular batch individually). See below in the <a href="protocol/holocene/derivation.html#batch-queue">Batch Queue</a> section about the new
<code>past</code> validity.</li>
<li>Note that we still allow span batches to overlap with the safe chain (<code>span_start.timestamp &lt; next_timestamp</code>).</li>
</ul>
<p>If any of the above checks invalidate the span batch, it is <code>drop</code>ped and the remaining channel from
which the span batch was derived, is also immediately dropped (see also <a href="protocol/holocene/derivation.html#fast-channel-invalidation">Fast Channel
Invalidation</a>). However, a <code>past</code> span batch is only dropped, without
dropping the remaining channel.</p>
<blockquote>
<p>[!Note]
A word regarding overlapping span batches: the existing batch queue rules already contain the rule
to drop batches whose L1 origin is older than that of the L2 safe head. The Delta span batch
checks also have an equivalent rule that applies to all singular batches past the safe head.
Now full span batch checks aren't done any more in Holocene, but the batch queue rules are still
applied to singular batches that are streamed out of span batches, so in particular this rule also
still applies to the first singular batch past the current safe head coming from an overlapping
span batch.</p>
<p>It is a known footgun for implementations that the earliest point at which violations of this rule
are detected is when the full array of singular batches is extracted from the span batch and their
L1 origin hashes are populated. It is therefore important to treat singular batches with outdated
or otherwise invalid L1 origin numbers as invalid, and consequently the span batch as invalid, and
not generate a critical derivation error that stalls derivation.</p>
</blockquote>
<h2 id="batch-queue-2"><a class="header" href="#batch-queue-2">Batch Queue</a></h2>
<p>The batch queue is also simplified in that batches are required to arrive strictly ordered, and any
batches that violate the ordering requirements are immediately dropped, instead of buffered.</p>
<p>So the following changes are made to the <a href="protocol/holocene/../derivation.html#batch-queue">Bedrock Batch Queue</a>:</p>
<ul>
<li>The reordering step is removed, so that later checks will drop batches that are not sequential.</li>
<li>The <code>future</code> batch validity status is removed, and batches that were determined to be in the
future are now directly <code>drop</code>-ped. This effectively disallows gaps, instead of buffering future
batches.</li>
<li>A new batch validity <code>past</code> is introduced. A batch has <code>past</code> validity if its timestamp is before
or equal to the safe head's timestamp. This also applies to span batches.</li>
<li>The other rules stay the same, including empty batch generation when the sequencing window
elapses.</li>
</ul>
<p>Note that these changes to batch validity rules also activate by the L1 inclusion block timestamp of
a batch, not with the batch timestamp. This is important to guarantee consistent validation rules
for the first channel after Holocene activation.</p>
<p>The <code>drop</code> and <code>past</code> batch validities cause the following new behavior:</p>
<ul>
<li>If a batch is found to be invalid and is dropped, the remaining span batch it originated from, if
applicable, is also discarded.</li>
<li>If a batch is found to be from the <code>past</code>, it is silently dropped and the remaining span batch
continues to be processed. This applies to both, span and singular batches.</li>
</ul>
<p>Note that when the L1 origin of the batch queue moves forward, it is guaranteed that it is empty,
because future batches aren't buffered any more. Furthermore, because future batches are directly
dropped, the batch queue effectively becomes a simpler <em>batch stage</em> that holds at most one span
batch from which singular batches are read from, and doesn't buffer singular batches itself in a
queue any more. A valid batch is directly forwarded to the next stage.</p>
<h3 id="fast-channel-invalidation"><a class="header" href="#fast-channel-invalidation">Fast Channel Invalidation</a></h3>
<p>Furthermore, upon finding an invalid batch, the remaining channel it got derived from is also discarded.</p>
<h2 id="engine-queue-1"><a class="header" href="#engine-queue-1">Engine Queue</a></h2>
<p>If the engine returns an <code>INVALID</code> status for a regularly derived payload, the payload is replaced
by a payload with the same fields, except for the <code>transaction_list</code>, which is trimmed to include
only its deposit transactions.</p>
<p>As before, a failure to then process the deposit-only attributes is a critical error.</p>
<p>If an invalid payload is replaced by a deposit-only payload, for consistency reasons, the remaining
span batch, if applicable, and channel it originated from are dropped as well.</p>
<h2 id="attributes-builder"><a class="header" href="#attributes-builder">Attributes Builder</a></h2>
<p>Starting after the fork activation block, the <code>PayloadAttributes</code> produced by the attributes builder will include
the <code>eip1559Params</code> field described in the <a href="protocol/holocene/./exec-engine.html#eip1559params-encoding">execution engine specs</a>. This
value exists within the <code>SystemConfig</code>.</p>
<p>On the fork activation block, the attributes builder will include a 0'd out <code>eip1559Params</code>, as to instruct
the engine to use the <a href="protocol/holocene/../exec-engine.html#1559-parameters">canyon base fee parameter constants</a>. This
is to prime the pipeline's view of the <code>SystemConfig</code> with the default EIP-1559 parameter values. After the first
Holocene payload has been processed, future payloads should use the <code>SystemConfig</code>'s EIP-1559 denominator and elasticity
parameter as the <code>eip1559Params</code> field's value. When the pipeline encounters a <code>UpdateType.EIP_1559_PARAMS</code>,
<code>ConfigUpdate</code> event, the pipeline's system config will be synchronized with the <code>SystemConfig</code> contract's.</p>
<h2 id="activation"><a class="header" href="#activation">Activation</a></h2>
<p>The new batch rules activate when the <em>L1 inclusion block timestamp</em> is greater or equal to the
Holocene activation timestamp. Note that this is in contrast to how span batches activated in
<a href="protocol/holocene/../delta/overview.html">Delta</a>, namely via the span batch L1 origin timestamp.</p>
<p>When the L1 traversal stage of the derivation pipeline moves its origin to the L1 block whose
timestamp is the first to be greater or equal to the Holocene activation timestamp, the derivation
pipeline's state is mostly reset by <strong>discarding</strong></p>
<ul>
<li>all frames in the frame queue,</li>
<li>channels in the channel bank, and</li>
<li>all batches in the batch queue.</li>
</ul>
<p>The three stages are then replaced by the new Holocene frame queue, channel bank and batch queue
(and, depending on the implementation, the optional span batch stage is added).</p>
<p>Note that batcher implementations must be aware of this activation behavior, so any frames of a
partially submitted channel that were included pre-Holocene must be sent again. This is a very
unlikely scenario since production batchers are usually configured to submit a channel in a single
transaction.</p>
<h1 id="rationale-3"><a class="header" href="#rationale-3">Rationale</a></h1>
<h2 id="strict-frame-and-batch-ordering"><a class="header" href="#strict-frame-and-batch-ordering">Strict Frame and Batch Ordering</a></h2>
<p>Strict Frame and Batch Ordering simplifies implementations of the derivation pipeline, and leads to
better worst-case cached data usage.</p>
<ul>
<li>The frame queue only ever holds frames from a single batcher transaction.</li>
<li>The channel bank only ever holds a single staging channel, that is either being built up by
incoming frames, or is is being processed by later stages.</li>
<li>The batch queue only ever holds at most a single span batch (that is being processed) and a single singular
batch (from the span batch, or the staging channel directly)</li>
<li>The sync start greatly simplifies in the average production case.</li>
</ul>
<p>This has advantages for Fault Proof program implementations.</p>
<h2 id="partial-span-batch-validity"><a class="header" href="#partial-span-batch-validity">Partial Span Batch Validity</a></h2>
<p>Partial Span Batch Validity guarantees that a valid singular batch derived from a span batch can
immediately be processed as valid and advance the safe chain, instead of being in an undecided state
until the full span batch is converted into singular batches. This leads to swifter derivation and
gives strong worst-case guarantees for Fault Proofs because the validity of a block doesn't depend
on the validity of any future blocks any more. Note that before Holocene, to verify the first block
of a span batch required validating the full span batch.</p>
<h2 id="fast-channel-invalidation-1"><a class="header" href="#fast-channel-invalidation-1">Fast Channel Invalidation</a></h2>
<p>The new Fast Channel Invalidation rule is a consistency implication of the Strict Ordering Rules.
Because batches inside channels must be ordered and contiguous, assuming that all batches inside a
channel are self-consistent (i.e., parent L2 hashes point to the block resulting from the previous
batch), an invalid batch also forward-invalidates all remaining batches of the same channel.</p>
<h2 id="steady-block-derivation"><a class="header" href="#steady-block-derivation">Steady Block Derivation</a></h2>
<p>Steady Block Derivation changes the derivation rules for invalid payload attributes, replacing an
invalid payload by a deposit-only/empty payload. Crucially, this means that the effect of an invalid
payload doesn't propagate backwards in the derivation pipeline. This has benefits for Fault Proofs
and Interop, because it guarantees that batch validity is not influenced by future stages and the
block derived from a valid batch will be determined by the engine stage before it pulls new payload
attributes from the previous stage. This avoids larger derivation pipeline resets.</p>
<h2 id="less-defensive-protocol"><a class="header" href="#less-defensive-protocol">Less Defensive Protocol</a></h2>
<p>The stricter derivation rules lead to a less defensive protocol. The old protocol rules allowed for
second chances for invalid payloads and submitting frames and batches within channels out of order.
Experiences from running OP Stack chains for over one and a half years have shown that these relaxed
derivation rules are (almost) never needed, so stricter rules that improve worst-case scenarios for
Fault Proofs and Interop are favorable.</p>
<p>Furthermore, the more relaxed rules created a lot more corner cases and complex interactions, which
made it harder to reason about and test the protocol, increasing the risk of chain splits between
different implementations.</p>
<h1 id="security-and-implementation-considerations"><a class="header" href="#security-and-implementation-considerations">Security and Implementation Considerations</a></h1>
<h2 id="reorgs"><a class="header" href="#reorgs">Reorgs</a></h2>
<p>Before Steady Block Derivation, invalid payloads got second chances to be replaced by valid future
payloads. Because they will now be immediately replaced by as deposit-only payloads, there is a
theoretical heightened risk for unsafe chain reorgs. To the best of our knowledge, we haven't
experienced this on OP Mainnet or other mainnet OP Stack chains yet.</p>
<p>The only conceivable scenarios in which a <em>valid</em> batch leads to an <em>invalid</em> payload are</p>
<ul>
<li>a buggy or malicious sequencer+batcher</li>
<li>in the future, that an previously valid Interop dependency referenced in that payload is later
invalidated, while the block that contained the Interop dependency got already batched.</li>
</ul>
<p>It is this latter case that inspired the Steady Block Derivation rule. It guarantees that the
secondary effects of an invalid Interop dependency are contained to a single block only, which
avoids a cascade of cross-L2 Interop reorgs that revisit L2 chains more than once.</p>
<h2 id="batcher-hardening"><a class="header" href="#batcher-hardening">Batcher Hardening</a></h2>
<p>In a sense, Holocene shifts some complexity from derivation to the batching phase. Simpler and
stricter derivation rules need to be met by a more complex batcher implementation.</p>
<p>The batcher must be hardened to guarantee the strict ordering requirements. They are already mostly
met in practice by the current Go implementation, but more by accident than by design. There are
edge cases in which the batcher might violate the strict ordering rules. For example, if a channel
fails to submit within a set period, the blocks are requeued and some out of order batching might
occur. A batcher implementation also needs to take extra care that dynamic blobs/calldata switching
doesn't lead to out of order or gaps of batches in scenarios where blocks are requeued, while future
channels are already waiting in the mempool for inclusion.</p>
<p>Batcher implementations are suggested to follow a fixed nonce to block-range assignment, once the
first batcher transaction (which is almost always the only batcher transaction for a channel for
current production batcher configurations) starts being submitted. This should avoid out-of-order or
gaps of batches. It might require to implement some form of persistence in the transaction
management, since it isn't possible to reliably recover all globally pending batcher transactions in
the L1 network.</p>
<p>Furthermore, batcher implementations need to be made aware of the Steady Block Derivation rules,
namely that invalid payloads will be derived as deposit-only blocks. So in case of an unsafe reorg,
the batcher should wait on the sequencer until it has derived all blocks from L1 in order to only
start batching new blocks on top of the possibly deposit-only derived reorg'd chain segment. The
sync-status should repeatedly be queried and matched against the expected safe chain. In case of any
discrepancy, the batcher should then stop batching and wait for the sequencer to fully derive up
until the latest L1 batcher transactions, and only then continue batching.</p>
<h2 id="sync-start"><a class="header" href="#sync-start">Sync Start</a></h2>
<p>Thanks to the new strict frame and batch ordering rules, the sync start algorithm can be simplified
in the average case. The rules guarantee that</p>
<ul>
<li>an incoming first frame for a new channel leads to discarding previous incomplete frames for a
non-closed previous channel in the frame queue and channel bank, and</li>
<li>when the derivation pipeline L1 origin progresses, the batch queue is empty.</li>
</ul>
<p>So the sync start algorithm can optimistically select the last L2 unsafe, safe and finalized heads
from the engine and if the L2 safe head's L1 origin is <em>plausible</em> (see the
<a href="protocol/holocene/../derivation.html#finding-the-sync-starting-point">original sync start description</a> for details),
start deriving from this L1 origin.</p>
<ul>
<li>If the first frame we find is a <em>first frame</em> for a channel that includes the safe head (TBD: or
even just the following L2 block with the current safe head as parent), we can
safely continue derivation from this channel because no previous derivation pipeline state could
have influenced the L2 safe head.</li>
<li>If the first frame we find is a non-first frame, then we need to walk back a full channel
timeout window to see if we find the start of that channel.
<ul>
<li>If we find the starting frame, we can continue derivation from it.</li>
<li>If we don't find the starting frame, we need to go back a full channel timeout window before the
finalized L2 head's L1 origin.</li>
</ul>
</li>
</ul>
<p>Note regarding the last case that if we don't find a starting frame within a channel timeout window,
the channel we did find a frame from must be timed out and would be discarded. The safe block we're
looking for can't be in any channel that timed out before its L1 origin so we wouldn't need to
search any further back, so we go back a channel timeout before the finalized L2 head.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="l2-execution-engine-3"><a class="header" href="#l2-execution-engine-3">L2 Execution Engine</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/holocene/exec-engine.html#overview">Overview</a></li>
<li><a href="protocol/holocene/exec-engine.html#timestamp-activation">Timestamp Activation</a></li>
<li><a href="protocol/holocene/exec-engine.html#dynamic-eip-1559-parameters">Dynamic EIP-1559 Parameters</a>
<ul>
<li><a href="protocol/holocene/exec-engine.html#eip-1559-parameters-in-block-header">EIP-1559 Parameters in Block Header</a></li>
<li><a href="protocol/holocene/exec-engine.html#eip-1559-parameters-in-payloadattributesv3">EIP-1559 Parameters in <code>PayloadAttributesV3</code></a>
<ul>
<li><a href="protocol/holocene/exec-engine.html#encoding">Encoding</a></li>
<li><a href="protocol/holocene/exec-engine.html#payloadid-computation">PayloadID computation</a></li>
</ul>
</li>
<li><a href="protocol/holocene/exec-engine.html#execution">Execution</a>
<ul>
<li><a href="protocol/holocene/exec-engine.html#payload-attributes-processing">Payload Attributes Processing</a></li>
<li><a href="protocol/holocene/exec-engine.html#base-fee-computation">Base Fee Computation</a></li>
</ul>
</li>
<li><a href="protocol/holocene/exec-engine.html#rationale">Rationale</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-31"><a class="header" href="#overview-31">Overview</a></h2>
<p>The EIP-1559 parameters are encoded in the block header's <code>extraData</code> field and can be configured dynamically through
the <code>SystemConfig</code>.</p>
<h2 id="timestamp-activation-1"><a class="header" href="#timestamp-activation-1">Timestamp Activation</a></h2>
<p>Holocene, like other network upgrades, is activated at a timestamp.  Changes to the L2 Block execution rules are applied
when the <code>L2 Timestamp &gt;= activation time</code>.</p>
<h2 id="dynamic-eip-1559-parameters"><a class="header" href="#dynamic-eip-1559-parameters">Dynamic EIP-1559 Parameters</a></h2>
<h3 id="eip-1559-parameters-in-block-header"><a class="header" href="#eip-1559-parameters-in-block-header">EIP-1559 Parameters in Block Header</a></h3>
<p>With the Holocene upgrade, the <code>extraData</code> header field of each block must have the following format:</p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Byte Offset</th></tr></thead><tbody>
<tr><td><code>version</code></td><td><code>u8</code></td><td><code>[0, 1)</code></td></tr>
<tr><td><code>denominator</code></td><td><code>u32 (big-endian)</code></td><td><code>[1, 5)</code></td></tr>
<tr><td><code>elasticity</code></td><td><code>u32 (big-endian)</code></td><td><code>[5, 9)</code></td></tr>
</tbody></table>
</div>
<p>Additionally,</p>
<ul>
<li><code>version</code> must be <code>0</code>,</li>
<li><code>denominator</code> and <code>elasticity</code> must be non-zero,</li>
<li>there is no additional data beyond these 9 bytes.</li>
</ul>
<p>Note that <code>extraData</code> has a maximum capacity of 32 bytes (to fit in the L1 beacon-chain <code>extraData</code> data-type) and its
format may be modified/extended by future upgrades.</p>
<p>Note also that if the chain had Holocene genesis, the genesis block must have an above-formatted <code>extraData</code> representing
the initial parameters to be used by the chain.</p>
<h3 id="eip-1559-parameters-in-payloadattributesv3"><a class="header" href="#eip-1559-parameters-in-payloadattributesv3">EIP-1559 Parameters in <code>PayloadAttributesV3</code></a></h3>
<p>The <a href="https://github.com/ethereum/execution-apis/blob/cea7eeb642052f4c2e03449dc48296def4aafc24/src/engine/cancun.md#payloadattributesv3"><code>PayloadAttributesV3</code></a>
type is extended with an additional value, <code>eip1559Params</code>:</p>
<pre><code class="language-rs">PayloadAttributesV3: {
    timestamp: QUANTITY
    prevRandao: DATA (32 bytes)
    suggestedFeeRecipient: DATA (20 bytes)
    withdrawals: array of WithdrawalV1
    parentBeaconBlockRoot: DATA (32 bytes)
    transactions: array of DATA
    noTxPool: bool
    gasLimit: QUANTITY or null
    eip1559Params: DATA (8 bytes) or null
}
</code></pre>
<h4 id="encoding"><a class="header" href="#encoding">Encoding</a></h4>
<p>At and after Holocene activation, <code>eip1559Parameters</code> in <code>PayloadAttributeV3</code> must be exactly 8 bytes with the following
format:</p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Byte Offset</th></tr></thead><tbody>
<tr><td><code>denominator</code></td><td><code>u32 (big-endian)</code></td><td><code>[0, 4)</code></td></tr>
<tr><td><code>elasticity</code></td><td><code>u32 (big-endian)</code></td><td><code>[4, 8)</code></td></tr>
</tbody></table>
</div>
<h4 id="payloadid-computation"><a class="header" href="#payloadid-computation">PayloadID computation</a></h4>
<p>If <code>eip1559Params != null</code>, the <code>eip1559Params</code> is included in the <code>PayloadID</code> hasher directly after the <code>gasLimit</code>
field.</p>
<h3 id="execution-1"><a class="header" href="#execution-1">Execution</a></h3>
<h4 id="payload-attributes-processing"><a class="header" href="#payload-attributes-processing">Payload Attributes Processing</a></h4>
<p>Prior to Holocene activation, <code>eip1559Parameters</code> in <code>PayloadAttributesV3</code> must be null and is otherwise considered
invalid.</p>
<p>At and after Holocene activation, any <code>ExecutionPayload</code> corresponding to some <code>PayloadAttributesV3</code> must contain
<code>extraData</code> formatted as the <a href="protocol/holocene/exec-engine.html#eip-1559-parameters-in-block-header">header value</a>. The <code>denominator</code> and <code>elasticity</code>
values within this <code>extraData</code> must correspond to those in <code>eip1559Parameters</code>, unless both are 0.  When both are 0, the
<a href="protocol/holocene/../exec-engine.html#1559-parameters">prior EIP-1559 constants</a> must be used to populate <code>extraData</code> instead.</p>
<h4 id="base-fee-computation"><a class="header" href="#base-fee-computation">Base Fee Computation</a></h4>
<p>Prior to the Holocene upgrade, the EIP-1559 denominator and elasticity parameters used to compute the block base fee
were <a href="protocol/holocene/../exec-engine.html#1559-parameters">constants</a>.</p>
<p>With the Holocene upgrade, these parameters are instead determined as follows:</p>
<ul>
<li>if Holocene is not active in <code>parent_header.timestamp</code>, the <a href="protocol/holocene/../exec-engine.html#1559-parameters">prior EIP-1559
constants</a> are used. Note that <code>parent_header.extraData</code> is empty
prior to Holocene, except possibly for the genesis block.</li>
<li>if Holocene is active at <code>parent_header.timestamp</code>, then the parameters from <code>parent_header.extraData</code> are used.</li>
</ul>
<h3 id="rationale-4"><a class="header" href="#rationale-4">Rationale</a></h3>
<p>Placing the EIP-1559 parameters within the L2 block header allows us to retain the purity of the function that computes
the next block's base fee from its parent block header, while still allowing them to be dynamically configured.  Dynamic
configuration is handled similarly to <code>gasLimit</code>, with the derivation pipeline providing the appropriate <code>SystemConfig</code>
contract values to the block builder via <code>PayloadAttributesV3</code> parameters.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="system-config-1"><a class="header" href="#system-config-1">System Config</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/holocene/system-config.html#overview">Overview</a>
<ul>
<li><a href="protocol/holocene/system-config.html#configupdate"><code>ConfigUpdate</code></a></li>
<li><a href="protocol/holocene/system-config.html#initialization">Initialization</a></li>
<li><a href="protocol/holocene/system-config.html#modifying-eip-1559-parameters">Modifying EIP-1559 Parameters</a></li>
<li><a href="protocol/holocene/system-config.html#interface">Interface</a>
<ul>
<li><a href="protocol/holocene/system-config.html#eip-1559-params">EIP-1559 Params</a>
<ul>
<li><a href="protocol/holocene/system-config.html#seteip1559params"><code>setEIP1559Params</code></a></li>
<li><a href="protocol/holocene/system-config.html#eip1559elasticity"><code>eip1559Elasticity</code></a></li>
<li><a href="protocol/holocene/system-config.html#eip1559denominator"><code>eip1559Denominator</code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-32"><a class="header" href="#overview-32">Overview</a></h2>
<p>The <code>SystemConfig</code> is updated to allow for dynamic EIP-1559 parameters.</p>
<h3 id="configupdate"><a class="header" href="#configupdate"><code>ConfigUpdate</code></a></h3>
<p>When the configuration is updated, a <a href="protocol/holocene/../system-config.html#system-config-updates"><code>ConfigUpdate</code></a> event
MUST be emitted with the following parameters:</p>
<div class="table-wrapper"><table><thead><tr><th><code>version</code></th><th><code>updateType</code></th><th><code>data</code></th><th>Usage</th></tr></thead><tbody>
<tr><td><code>uint256(0)</code></td><td><code>uint8(4)</code></td><td><code>abi.encode((uint256(_denominator) &lt;&lt; 32) | _elasticity)</code></td><td>Modifies the EIP-1559 denominator and elasticity</td></tr>
</tbody></table>
</div>
<p>Note that the above encoding is the format emitted by the SystemConfig event, which differs from the format in extraData
from the block header.</p>
<h3 id="initialization"><a class="header" href="#initialization">Initialization</a></h3>
<p>The following actions should happen during the initialization of the <code>SystemConfig</code>:</p>
<ul>
<li><code>emit ConfigUpdate.BATCHER</code></li>
<li><code>emit ConfigUpdate.FEE_SCALARS</code></li>
<li><code>emit ConfigUpdate.GAS_LIMIT</code></li>
<li><code>emit ConfigUpdate.UNSAFE_BLOCK_SIGNER</code></li>
</ul>
<p>Intentionally absent from this is <code>emit ConfigUpdate.EIP_1559_PARAMS</code>.
As long as these values are unset, the default values will be used.
Requiring 1559 parameters to be set during initialization would add a strict requirement
that the L2 hardforks before the L1 contracts are upgraded, and this is complicated to manage in a
world of many chains.</p>
<h3 id="modifying-eip-1559-parameters"><a class="header" href="#modifying-eip-1559-parameters">Modifying EIP-1559 Parameters</a></h3>
<p>A new <code>SystemConfig</code> <code>UpdateType</code> is introduced that enables the modification of
<a href="https://eips.ethereum.org/EIPS/eip-1559">EIP-1559</a> parameters. This allows for the chain
operator to modify the <code>BASE_FEE_MAX_CHANGE_DENOMINATOR</code> and the <code>ELASTICITY_MULTIPLIER</code>.</p>
<h3 id="interface-1"><a class="header" href="#interface-1">Interface</a></h3>
<h4 id="eip-1559-params"><a class="header" href="#eip-1559-params">EIP-1559 Params</a></h4>
<h5 id="seteip1559params-1"><a class="header" href="#seteip1559params-1"><code>setEIP1559Params</code></a></h5>
<p>This function MUST only be callable by the chain governor.</p>
<pre><code class="language-solidity">function setEIP1559Params(uint32 _denominator, uint32 _elasticity)
</code></pre>
<p>The <code>_denominator</code> and <code>_elasticity</code> MUST be set to values greater to than 0.
It is possible for the chain operator to set EIP-1559 parameters that result in poor user experience.</p>
<h5 id="eip1559elasticity"><a class="header" href="#eip1559elasticity"><code>eip1559Elasticity</code></a></h5>
<p>This function returns the currently configured EIP-1559 elasticity.</p>
<pre><code class="language-solidity">function eip1559Elasticity()(uint32)
</code></pre>
<h5 id="eip1559denominator"><a class="header" href="#eip1559denominator"><code>eip1559Denominator</code></a></h5>
<p>This function returns the currently configured EIP-1559 denominator.</p>
<pre><code class="language-solidity">function eip1559Denominator()(uint32)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="pectra-blob-schedule-optional-network-upgrade"><a class="header" href="#pectra-blob-schedule-optional-network-upgrade">Pectra Blob Schedule (Optional) Network Upgrade</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/pectra-blob-schedule/overview.html#consensus-layer">Consensus Layer</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<p>The Pectra Blob Schedule hardfork is an optional hardfork which delays the adoption of the
Prague blob base fee update fraction until the specified time. Until that time, the Cancun
update fraction from the previous fork is retained.</p>
<p>Note that the activation logic for this upgrade is different to most other upgrades.
Usually, specific behavior is activated at the <em>hard fork timestamp</em>, if it is not nil,
and continues until overridden by another hardfork.
Here, specific behavior is activated for all times up to the hard fork timestamp,
if it is not nil, and then <em>deactivated</em> at the hard fork timestamp.</p>
<h2 id="consensus-layer-6"><a class="header" href="#consensus-layer-6">Consensus Layer</a></h2>
<ul>
<li><a href="protocol/pectra-blob-schedule/./derivation.html">Derivation</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="pectra-blob-schedule-derivation"><a class="header" href="#pectra-blob-schedule-derivation">Pectra Blob Schedule Derivation</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/pectra-blob-schedule/derivation.html#if-enabled">If enabled</a></li>
<li><a href="protocol/pectra-blob-schedule/derivation.html#if-disabled-default">If disabled (default)</a></li>
<li><a href="protocol/pectra-blob-schedule/derivation.html#motivation-and-rationale">Motivation and Rationale</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="if-enabled"><a class="header" href="#if-enabled">If enabled</a></h2>
<p>If this hardfork is enabled (i.e. if there is a non nil hardfork activation timestamp set), the following rules apply:</p>
<p>When setting the <a href="protocol/pectra-blob-schedule/../../glossary.html#l1-attributes-deposited-transaction">L1 Attributes Deposited Transaction</a>,
the adoption of the Pectra blob base fee update fraction
(see <a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-7691.md">EIP-7691</a>)
occurs for L2 blocks with an L1 origin equal to or greater than the hard fork timestamp.
For L2 blocks with an L1 origin less than the hard fork timestamp, the Cancun blob base fee update fraction is used
(see <a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-4844.md">EIP-4844</a>).</p>
<h2 id="if-disabled-default"><a class="header" href="#if-disabled-default">If disabled (default)</a></h2>
<p>If the hardfork activation timestamp is nil, the blob base fee update rules which are active
at any given L1 block will apply to the L1 Attributes Deposited Transaction.</p>
<h2 id="motivation-and-rationale"><a class="header" href="#motivation-and-rationale">Motivation and Rationale</a></h2>
<p>Due to a consensus layer bug, OPStack chains on Holesky and Sepolia running officially released op-node software
did not update their blob base fee update fraction (for L1 Attributes Deposited Transaction)
in tandem with the Prague upgrade on L1.</p>
<p>These chains, or any OPStack chain with a sequencer running
the buggy consensus code<sup class="footnote-reference"><a href="#1">1</a></sup> when Holesky/Sepolia activated Pectra,
will have an inaccurate blob base fee in the <a href="protocol/pectra-blob-schedule/../../protocol/predeploys.html#l1block">L1Block</a> contract.
This optional fork is a mechanism to bring those chains back in line.
It is unnecessary for chains using Ethereum mainnet for L1 and running op-node
<a href="https://github.com/ethereum-optimism/optimism/releases/tag/op-node%2Fv1.12.0">v1.12.0</a>
or later before Pectra activates on L1.</p>
<p>Activating by L1 origin preserves the invariant that the L1BlockInfo is constant for blocks with the same epoch.</p>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>This is any commit <em>before</em> the code was fixed in <a href="https://github.com/ethereum-optimism/optimism/commit/aabf3fe054c5979d6a0008f26fe1a73fdf3aad9f">aabf3fe054c5979d6a0008f26fe1a73fdf3aad9f</a></p>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="isthmus-network-upgrade"><a class="header" href="#isthmus-network-upgrade">Isthmus Network Upgrade</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/isthmus/overview.html#execution-layer">Execution Layer</a></li>
<li><a href="protocol/isthmus/overview.html#consensus-layer">Consensus Layer</a></li>
<li><a href="protocol/isthmus/overview.html#smart-contracts">Smart Contracts</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="execution-layer-5"><a class="header" href="#execution-layer-5">Execution Layer</a></h2>
<ul>
<li><a href="https://eips.ethereum.org/EIPS/eip-7600">Pectra</a> (Execution Layer):
<ul>
<li><a href="https://eips.ethereum.org/EIPS/eip-7702">EIP-7702</a>
<ul>
<li><a href="protocol/isthmus/./derivation.html#span-batch-updates">Span Batch Updates</a></li>
</ul>
</li>
<li><a href="https://eips.ethereum.org/EIPS/eip-2537">EIP-2537</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-2935">EIP-2935</a>
<ul>
<li><a href="protocol/isthmus/./derivation.html#eip-2935-contract-deployment">EIP-2935 Contract Deployment</a></li>
</ul>
</li>
<li><a href="https://eips.ethereum.org/EIPS/eip-7002">EIP-7002</a>
<ul>
<li>The EIP-7002 predeploy contract and syscall are not adopted as part of the OP Stack.</li>
</ul>
</li>
<li><a href="https://eips.ethereum.org/EIPS/eip-7251">EIP-7251</a>
<ul>
<li>The EIP-7251 predeploy contract and syscall are not adopted as part of the OP Stack.</li>
</ul>
</li>
<li><a href="https://eips.ethereum.org/EIPS/eip-7623">EIP-7623</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-6110">EIP-6110</a></li>
<li><a href="https://eips.ethereum.org/EIPS/eip-7685">EIP-7685</a></li>
</ul>
</li>
<li><a href="protocol/isthmus/./exec-engine.html##l2tol1messagepasser-storage-root-in-header">L2ToL1MessagePasser Storage Root in Header</a></li>
<li><a href="protocol/isthmus/./exec-engine.html#operator-fee">Operator Fee</a></li>
</ul>
<h2 id="consensus-layer-7"><a class="header" href="#consensus-layer-7">Consensus Layer</a></h2>
<ul>
<li><a href="protocol/isthmus/./derivation.html">Isthmus Derivation</a></li>
</ul>
<h2 id="smart-contracts-1"><a class="header" href="#smart-contracts-1">Smart Contracts</a></h2>
<ul>
<li><a href="protocol/isthmus/./predeploys.html">Predeploys</a></li>
<li><a href="protocol/isthmus/./l1-attributes.html">L1 Block Attributes</a></li>
<li><a href="protocol/isthmus/./system-config.html">System Config</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="l2-execution-engine-4"><a class="header" href="#l2-execution-engine-4">L2 Execution Engine</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/isthmus/exec-engine.html#overview">Overview</a></li>
<li><a href="protocol/isthmus/exec-engine.html#timestamp-activation">Timestamp Activation</a></li>
<li><a href="protocol/isthmus/exec-engine.html#l2tol1messagepasser-storage-root-in-header"><code>L2ToL1MessagePasser</code> Storage Root in Header</a>
<ul>
<li><a href="protocol/isthmus/exec-engine.html#header-validity-rules">Header Validity Rules</a></li>
<li><a href="protocol/isthmus/exec-engine.html#header-withdrawals-root">Header Withdrawals Root</a>
<ul>
<li><a href="protocol/isthmus/exec-engine.html#rationale">Rationale</a></li>
<li><a href="protocol/isthmus/exec-engine.html#genesis-block">Genesis Block</a></li>
<li><a href="protocol/isthmus/exec-engine.html#state-processing">State Processing</a></li>
<li><a href="protocol/isthmus/exec-engine.html#p2p">P2P</a></li>
<li><a href="protocol/isthmus/exec-engine.html#backwards-compatibility-considerations">Backwards Compatibility Considerations</a></li>
<li><a href="protocol/isthmus/exec-engine.html#forwards-compatibility-considerations">Forwards Compatibility Considerations</a></li>
<li><a href="protocol/isthmus/exec-engine.html#client-implementation-considerations">Client Implementation Considerations</a>
<ul>
<li><a href="protocol/isthmus/exec-engine.html#transaction-simulation">Transaction Simulation</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="protocol/isthmus/exec-engine.html#deposit-requests">Deposit Requests</a></li>
<li><a href="protocol/isthmus/exec-engine.html#block-body-withdrawals-list">Block Body Withdrawals List</a></li>
<li><a href="protocol/isthmus/exec-engine.html#evm-changes">EVM Changes</a>
<ul>
<li><a href="protocol/isthmus/exec-engine.html#bls-precompiles">BLS Precompiles</a></li>
</ul>
</li>
<li><a href="protocol/isthmus/exec-engine.html#block-sealing">Block Sealing</a></li>
<li><a href="protocol/isthmus/exec-engine.html#engine-api-updates">Engine API Updates</a>
<ul>
<li><a href="protocol/isthmus/exec-engine.html#update-to-executionpayload">Update to <code>ExecutionPayload</code></a></li>
<li><a href="protocol/isthmus/exec-engine.html#engine_newpayloadv4-api"><code>engine_newPayloadV4</code> API</a></li>
</ul>
</li>
<li><a href="protocol/isthmus/exec-engine.html#fees">Fees</a>
<ul>
<li><a href="protocol/isthmus/exec-engine.html#operator-fee">Operator Fee</a>
<ul>
<li><a href="protocol/isthmus/exec-engine.html#fee-formula">Fee Formula</a></li>
<li><a href="protocol/isthmus/exec-engine.html#deposit-operator-fees">Deposit Operator Fees</a></li>
<li><a href="protocol/isthmus/exec-engine.html#evm-fee-semantics">EVM Fee Semantics</a></li>
<li><a href="protocol/isthmus/exec-engine.html#transaction-pool-changes">Transaction Pool Changes</a></li>
<li><a href="protocol/isthmus/exec-engine.html#configuring-operator-fee-parameters">Configuring Operator Fee Parameters</a></li>
</ul>
</li>
<li><a href="protocol/isthmus/exec-engine.html#fee-vaults">Fee Vaults</a></li>
<li><a href="protocol/isthmus/exec-engine.html#receipts">Receipts</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<!-- All glossary references in this file. -->
<h2 id="overview-33"><a class="header" href="#overview-33">Overview</a></h2>
<p>The storage root of the <code>L2ToL1MessagePasser</code> is included in the block header's
<code>withdrawalRoot</code> field.</p>
<h2 id="timestamp-activation-2"><a class="header" href="#timestamp-activation-2">Timestamp Activation</a></h2>
<p>Isthmus, like other network upgrades, is activated at a timestamp.
Changes to the L2 Block execution rules are applied when the <code>L2 Timestamp &gt;= activation time</code>.</p>
<h2 id="l2tol1messagepasser-storage-root-in-header"><a class="header" href="#l2tol1messagepasser-storage-root-in-header"><code>L2ToL1MessagePasser</code> Storage Root in Header</a></h2>
<p>After Isthmus hardfork's activation, the L2 block header's <code>withdrawalsRoot</code> field will consist of the 32-byte
<a href="protocol/isthmus/../../protocol/predeploys.html#L2ToL1MessagePasser"><code>L2ToL1MessagePasser</code></a> account storage root from the world state identified by the stateRoot
field in the block header. The storage root should be the same root that is returned by <code>eth_getProof</code>
at the given block number.</p>
<h3 id="header-validity-rules"><a class="header" href="#header-validity-rules">Header Validity Rules</a></h3>
<p>Prior to isthmus activation:</p>
<ul>
<li>the L2 block header's <code>withdrawalsRoot</code> field must be:
<ul>
<li><code>nil</code> if Canyon has not been activated.</li>
<li><code>keccak256(rlp(empty_string_code))</code> if Canyon has been activated.</li>
</ul>
</li>
<li>the L2 block header's <code>requestsHash</code> field must be omitted.</li>
</ul>
<p>After Isthmus activation, an L2 block header is valid iff:</p>
<ol>
<li>The <code>withdrawalsRoot</code> field
<ol>
<li>Is 32 bytes in length.</li>
<li>Matches the <a href="protocol/isthmus/../../protocol/predeploys.html#L2ToL1MessagePasser"><code>L2ToL1MessagePasser</code></a> account storage root,
as committed to in the <code>storageRoot</code> within the block header</li>
</ol>
</li>
<li>The <code>requestsHash</code> field is equal to <code>sha256('') = 0xe3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855</code>
indicating no requests in the block.</li>
</ol>
<h3 id="header-withdrawals-root"><a class="header" href="#header-withdrawals-root">Header Withdrawals Root</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Byte offset</th><th>Description</th></tr></thead><tbody>
<tr><td><code>[0, 32)</code></td><td><a href="protocol/isthmus/../../protocol/predeploys.html#L2ToL1MessagePasser"><code>L2ToL1MessagePasser</code></a> account storage root</td></tr>
</tbody></table>
</div>
<h4 id="rationale-5"><a class="header" href="#rationale-5">Rationale</a></h4>
<p>Currently, to generate <a href="protocol/isthmus/../../glossary.html#l2-output-root">L2 output roots</a> for historical blocks, an archival node is required. This directly
places a burden on users of the system in a post-fault-proofs world, where:</p>
<ol>
<li>A proposer must have an archive node to propose an output root at the safe head.</li>
<li>A user that is proving their withdrawal must have an archive node to verify that the output root they are proving
their withdrawal against is indeed valid and included within the safe chain.</li>
</ol>
<p>Placing the <a href="protocol/isthmus/../../protocol/predeploys.html#L2ToL1MessagePasser"><code>L2ToL1MessagePasser</code></a> account storage root in the <code>withdrawalsRoot</code> field alleviates this burden
for users and protocol participants alike, allowing them to propose and verify other proposals with lower operating costs.</p>
<h4 id="genesis-block"><a class="header" href="#genesis-block">Genesis Block</a></h4>
<p>If Isthmus is active at genesis block, the <code>withdrawalsRoot</code> in the genesis block header is set to the
<a href="protocol/isthmus/../../protocol/predeploys.html#L2ToL1MessagePasser"><code>L2ToL1MessagePasser</code></a> account storage root.</p>
<h4 id="state-processing"><a class="header" href="#state-processing">State Processing</a></h4>
<p>At the time of state processing, the header for which transactions are being validated should not make it's <code>withdrawalsRoot</code>
available to the EVM/application layer.</p>
<h4 id="p2p"><a class="header" href="#p2p">P2P</a></h4>
<p>During sync, we expect the withdrawals list in the block body to be empty (OP stack does not make
use of the withdrawals list) and hence the hash of the withdrawals list to be the MPT root of an empty list.
When verifying the header chain using the final header that is synced, the header timestamp is used to
determine whether Isthmus is active at the said block. If it is, we expect that the header <code>withdrawalsRoot</code>
MPT hash can be any non-null value (since it is expected to contain the <code>L2ToL1MessagePasser</code>'s storage root).</p>
<h4 id="backwards-compatibility-considerations"><a class="header" href="#backwards-compatibility-considerations">Backwards Compatibility Considerations</a></h4>
<p>Beginning at Canyon (which includes Shanghai hardfork support) and prior to Isthmus activation,
the <code>withdrawalsRoot</code> field is set to the MPT root of an empty withdrawals list. This is the
same root as an empty storage root. The withdrawals are captured in the L2 state, however
they are not reflected in the <code>withdrawalsRoot</code>. Hence, prior to Isthmus activation,
even if a <code>withdrawalsRoot</code> is present and a MPT root is present in the header, it should not be used.
Any implementation that calculates output root should be careful not to use the header <code>withdrawalsRoot</code>.</p>
<p>Note that there is always nonzero storage in the <a href="protocol/isthmus/../../protocol/predeploys.html#L2ToL1MessagePasser"><code>L2ToL1MessagePasser</code></a>,
because it is a <a href="protocol/isthmus/../../protocol/predeploys.html">proxied predeploy</a> -- from genesis it
stores an implementation address and owner address. So from Isthmus,
the <code>withdrawalsRoot</code> will always be non-nil and never be the MPT root of an empty list.</p>
<h4 id="forwards-compatibility-considerations"><a class="header" href="#forwards-compatibility-considerations">Forwards Compatibility Considerations</a></h4>
<p>As it stands, the <code>withdrawalsRoot</code> field is unused within the OP Stack's header consensus format, and will never be
used for other reasons that are currently planned. Setting this value to the account storage root of the withdrawal
directly fits with the OP Stack, and makes use of the existing field in the L1 header consensus format.</p>
<h4 id="client-implementation-considerations"><a class="header" href="#client-implementation-considerations">Client Implementation Considerations</a></h4>
<p>Various EL clients store historical state of accounts differently. If, as a contrived case, an OP Stack chain did not have
an outbound withdrawal for a long period of time, the node may not have access to the account storage root of the
<a href="protocol/isthmus/../../protocol/predeploys.html#L2ToL1MessagePasser"><code>L2ToL1MessagePasser</code></a>. In this case, the client would be unable to keep consensus. However, most modern
clients are able to at the very least reconstruct the account storage root at a given block on the fly if it does not
directly store this information.</p>
<h5 id="transaction-simulation"><a class="header" href="#transaction-simulation">Transaction Simulation</a></h5>
<p>In response to RPC methods like <code>eth_simulateV1</code> that allow simulation of arbitrary transactions within one or more blocks,
an empty withdrawals root should be included in the header of a block that consists of such simulated transactions. The same
is applicable for scenarios where the actual withdrawals root value is not readily available.</p>
<h2 id="deposit-requests"><a class="header" href="#deposit-requests">Deposit Requests</a></h2>
<p><a href="https://eips.ethereum.org/EIPS/eip-6110">EIP-6110</a> shifts deposit to the execution layer, introducing a new <a href="https://eips.ethereum.org/EIPS/eip-7685">EIP-7685</a> deposit request of type
<code>DEPOSIT_REQUEST_TYPE</code>. Deposit requests then appear in the <a href="https://eips.ethereum.org/EIPS/eip-7685">EIP-7685</a> requests list. The OP Stack needs to ignore these
requests. Requests generation must be modified to exclude <a href="https://eips.ethereum.org/EIPS/eip-6110">EIP-6110</a> deposit requests. Note that since the <a href="https://eips.ethereum.org/EIPS/eip-6110">EIP-6110</a>
request type did <em>not</em> exist prior to Pectra on L1 and the Isthmus hardfork on L2, no activation time is needed since these
deposit type requests may always be excluded.</p>
<h2 id="block-body-withdrawals-list"><a class="header" href="#block-body-withdrawals-list">Block Body Withdrawals List</a></h2>
<p>Withdrawals list in the block body is encoded as an empty RLP list.</p>
<h2 id="evm-changes-1"><a class="header" href="#evm-changes-1">EVM Changes</a></h2>
<h3 id="bls-precompiles"><a class="header" href="#bls-precompiles">BLS Precompiles</a></h3>
<p>Similar to the <code>bn256Pairing</code> precompile in the <a href="protocol/isthmus/../granite/exec-engine.html">granite hardfork</a>,
<a href="https://eips.ethereum.org/EIPS/eip-2537">EIP-2537</a> introduces a BLS
precompile that short-circuits depending on input size in the EVM.</p>
<p>The input size limits of the BLS precompile contracts are listed below:</p>
<ul>
<li>G1 multiple-scalar-multiply: <code>input_size &lt;= 513760 bytes</code></li>
<li>G2 multiple-scalar-multiply: <code>input_size &lt;= 488448 bytes</code></li>
<li>Pairing check: <code>input_size &lt;= 235008 bytes</code></li>
</ul>
<p>The rest of the BLS precompiles are fixed-size operations which have a fixed gas cost.</p>
<p>All of the BLS precompiles should be <a href="protocol/isthmus/../../fault-proof/index.html#precompile-accelerators">accelerated</a> in fault proof
programs so they call out to the L1 instead of calculating the result inside the program.</p>
<h2 id="block-sealing"><a class="header" href="#block-sealing">Block Sealing</a></h2>
<p>In the OP Stack, <code>EIP-7685</code> is no-op'd, and the <code>requestsHash</code> is always set to <code>sha256('')</code> (as noted in
<a href="protocol/isthmus/exec-engine.html#header-validity-rules">header validity rules</a>). As such, <a href="https://eips.ethereum.org/EIPS/eip-6110">EIP-6110</a>,
<a href="https://eips.ethereum.org/EIPS/eip-7002">EIP-7002</a>, and <a href="https://eips.ethereum.org/EIPS/eip-7251">EIP-7251</a> are not
enabled either. The OP Stack execution layer must ensure that the post-block filtering of events in the deposit contract
(EIP-6110) as well as the <code>EIP-7002</code> + <code>EIP-7251</code> system calls are <em>not invoked</em> during the block sealing process after
Isthmus activation.</p>
<p>Users of the OP Stack may still permissionlessly deploy these smart contracts, but they will not be treated as special
by the OP Stack execution layer, and the system calls introduced in L1's Pectra hardfork are not considered.</p>
<h2 id="engine-api-updates"><a class="header" href="#engine-api-updates">Engine API Updates</a></h2>
<h3 id="update-to-executionpayload"><a class="header" href="#update-to-executionpayload">Update to <code>ExecutionPayload</code></a></h3>
<p><code>ExecutionPayload</code> will contain an extra field for <code>withdrawalsRoot</code> after Isthmus hard fork.</p>
<h3 id="engine_newpayloadv4-api"><a class="header" href="#engine_newpayloadv4-api"><code>engine_newPayloadV4</code> API</a></h3>
<p>Post Isthmus, <code>engine_newPayloadV4</code> will be used.</p>
<p>The <code>executionRequests</code> parameter MUST be an empty array.</p>
<h2 id="fees-2"><a class="header" href="#fees-2">Fees</a></h2>
<p>New OP stack variants have different resource consumption patterns, and thus require a more flexible
pricing model. To enable more customizable fee structures, Isthmus adds a new component to the fee
calculation: the <code>operatorFee</code>, which is parameterized by two scalars: the <code>operatorFeeScalar</code>
and the <code>operatorFeeConstant</code>.</p>
<h3 id="operator-fee"><a class="header" href="#operator-fee">Operator Fee</a></h3>
<p>The operator fee is integrated directly into the EVM, alongside the standard gas fee and the OP Stack specific L1 data
fee. This fee follows the same semantics of existing fees charged in the EVM<sup class="footnote-reference"><a href="#1">1</a></sup>, just with a new fee beneficiary account.</p>
<h4 id="fee-formula"><a class="header" href="#fee-formula">Fee Formula</a></h4>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">operatorFee</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">gas</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">operatorFeeScalar</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã·</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.1141em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">6</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">operatorFeeConstant</span></span></span></span></span></span></p>
<p>Where:</p>
<ul>
<li><code>gas</code> is the amount of gas that the transaction used. When calculating the amount of gas that is bought at the
beginning of the transaction, this should be the <code>gas_limit</code>. When determining how much gas should be refunded,
based off of how much of the <code>gas_limit</code> the transaction used, this should be the <code>gas_used</code>.</li>
<li><code>operatorFeeScalar</code> is a <code>uint32</code> scalar set by the chain operator, scaled by <code>1e6</code>.</li>
<li><code>operatorFeeConstant</code> is a <code>uint64</code> scalar set by the chain operator.</li>
</ul>
<p>Note that the operator fee's maximum value has 77 bits, which can be calculated from the maximum input parameters:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9275em;vertical-align:-0.2441em;"></span><span class="mord"><span class="mord text"><span class="mord">operatorFee</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.0573em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">max</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord text"><span class="mord">uint64</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">max</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8179em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord text"><span class="mord">uint32</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">max</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã·</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.1141em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">6</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8179em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord text"><span class="mord">uint64</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">max</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â‰ˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">7.924660923989131</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8641em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">22</span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>So implementations don't need to check for overflows if they perform the calculations with <code>uint256</code> types.</p>
<h4 id="deposit-operator-fees"><a class="header" href="#deposit-operator-fees">Deposit Operator Fees</a></h4>
<p>Deposit transactions do not get charged operator fees. For all deposit transactions, regardless of the operator fee
parameter configuration, the operator fee should be <strong>zero</strong>. Deposit transactions also do not receive operator fee gas
refunds, since they never buy the operator fee gas to begin with.</p>
<h4 id="evm-fee-semantics"><a class="header" href="#evm-fee-semantics">EVM Fee Semantics</a></h4>
<p>Like other fees in the EVM, the operator fee should be charged following the pattern below:</p>
<ol>
<li>During pre-execution validation, the account must have enough ETH to cover the existing worst-case gas + L1 data fees
<em>as well as</em> the worst-case operator fee (for deposits, the worst-case fee is <code>0</code>). To compute this value, use the
<a href="protocol/isthmus/exec-engine.html#fee-formula">fee formula</a> with <code>gas</code> set to the <code>gas_limit</code> of the transaction, and add it to the existing
worst-case transaction fee.</li>
<li>When buying gas prior to execution, charge the account the worst-case operator fee. To compute this value, use the
<a href="protocol/isthmus/exec-engine.html#fee-formula">fee formula</a> with <code>gas</code> set to the <code>gas_limit</code> of the transaction.</li>
<li>After execution, when issuing refunds, transactions that bought operator fee gas should be refunded the operator fee
gas that was unused (i.e., the caller should only be charged the <em>effective</em> operator fee.) The refund should be
calculated as <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">opFeeRefund</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">opFeeWorstCase</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">opFeeActual</span></span></span></span></span>, where:
<ul>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">opFeeWorstCase</span></span></span></span></span> is as described in #1 + #2.</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">opFeeActual</span></span></span></span></span> is the amount of the operator fee that was actually used. This value is computed using the
<a href="protocol/isthmus/exec-engine.html#fee-formula">fee formula</a> with <code>gas</code> set to the <code>gas_limit - gas_used + refunded_gas</code>. <code>refunded_gas</code> is as
described in <a href="https://eips.ethereum.org/EIPS/eip-3529">EIP-3529</a>.</li>
</ul>
</li>
<li>After execution, when rewarding the fee beneficiaries, send the <em>spent operator fee</em> to the
<a href="protocol/isthmus/exec-engine.html#fee-vaults">operator fee vault</a>. This value is exactly <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">opFeeActual</span></span></span></span></span> as described above.</li>
</ol>
<p>Implementations must ensure ETH is neither minted nor destroyed as a result of the operator fee.</p>
<h4 id="transaction-pool-changes"><a class="header" href="#transaction-pool-changes">Transaction Pool Changes</a></h4>
<p>To account for the additional fee factored into transaction validity mentioned above, the transaction pool must reject
transactions that do not have enough balance to cover the worst-case cost of the transaction fee. This worst-case cost
of a transaction now includes the worst-case operator fee.</p>
<h4 id="configuring-operator-fee-parameters"><a class="header" href="#configuring-operator-fee-parameters">Configuring Operator Fee Parameters</a></h4>
<p><code>operatorFeeScalar</code> and <code>operatorFeeConstant</code> are loaded in a similar way to the <code>baseFeeScalar</code> and
<code>blobBaseFeeScalar</code> used in the <a href="protocol/isthmus/../../protocol/exec-engine.html#ecotone-l1-cost-fee-changes-eip-4844-da"><code>L1Fee</code></a>.
calculation. In more detail, these parameters can be accessed in two interchangable ways.</p>
<ul>
<li>read from the deposited L1 attributes (<code>operatorFeeScalar</code> and <code>operatorFeeConstant</code>) of the current L2 block</li>
<li>read from the L1 Block Info contract (<code>0x4200000000000000000000000000000000000015</code>)
<ul>
<li>using the respective solidity getter functions (<code>operatorFeeScalar</code>, <code>operatorFeeConstant</code>)</li>
<li>using direct storage-reads:
<ul>
<li>Operator fee scalar as big-endian <code>uint32</code> in slot <code>8</code> at offset <code>0</code>.</li>
<li>Operator fee constant as big-endian <code>uint64</code> in slot <code>8</code> at offset <code>4</code>.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="fee-vaults-1"><a class="header" href="#fee-vaults-1">Fee Vaults</a></h3>
<p>These collected fees are sent to a new vault for the <code>operatorFee</code>: the <a href="protocol/isthmus/predeploys.html#operatorfeevault"><code>OperatorFeeVault</code></a>.</p>
<p>Like the existing vaults, this is a hardcoded address, pointing at a pre-deployed proxy contract.
The proxy is backed by a vault contract deployment, based on <code>FeeVault</code>, to route vault funds to L1 securely.</p>
<h3 id="receipts"><a class="header" href="#receipts">Receipts</a></h3>
<p>After Isthmus activation, 2 new fields <code>operatorFeeScalar</code> and <code>operatorFeeConstant</code> are added to transaction receipts
if and only if at least one of them is non zero.</p>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>Wood, G., &amp; Ethereum Contributors. (n.d.-a). Ethereum Yellow Paper. <a href="https://ethereum.github.io/yellowpaper/paper.pdf">https://ethereum.github.io/yellowpaper/paper.pdf</a> Page 8, section 5: "Gas and Payment"</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="isthmus-l2-chain-derivation-changes"><a class="header" href="#isthmus-l2-chain-derivation-changes">Isthmus L2 Chain Derivation Changes</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/isthmus/derivation.html#network-upgrade-automation-transactions">Network upgrade automation transactions</a>
<ul>
<li><a href="protocol/isthmus/derivation.html#l1block-deployment">L1Block deployment</a></li>
<li><a href="protocol/isthmus/derivation.html#gaspriceoracle-deployment">GasPriceOracle deployment</a></li>
<li><a href="protocol/isthmus/derivation.html#operator-fee-vault-deployment">Operator fee vault deployment</a></li>
<li><a href="protocol/isthmus/derivation.html#l1block-proxy-update">L1Block Proxy Update</a></li>
<li><a href="protocol/isthmus/derivation.html#gaspriceoracle-proxy-update">GasPriceOracle Proxy Update</a></li>
<li><a href="protocol/isthmus/derivation.html#operatorfeevault-proxy-update">OperatorFeeVault Proxy Update</a></li>
<li><a href="protocol/isthmus/derivation.html#gaspriceoracle-enable-isthmus">GasPriceOracle Enable Isthmus</a></li>
<li><a href="protocol/isthmus/derivation.html#eip-2935-contract-deployment">EIP-2935 Contract Deployment</a></li>
</ul>
</li>
<li><a href="protocol/isthmus/derivation.html#span-batch-updates">Span Batch Updates</a>
<ul>
<li><a href="protocol/isthmus/derivation.html#activation">Activation</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h1 id="network-upgrade-automation-transactions-3"><a class="header" href="#network-upgrade-automation-transactions-3">Network upgrade automation transactions</a></h1>
<p>The Isthmus hardfork activation block contains the following transactions, in this order:</p>
<ul>
<li>L1 Attributes Transaction</li>
<li>User deposits from L1</li>
<li>Network Upgrade Transactions
<ul>
<li>L1Block deployment</li>
<li>GasPriceOracle deployment</li>
<li>Operator Fee vault deployment</li>
<li>Update L1Block Proxy ERC-1967 Implementation</li>
<li>Update GasPriceOracle Proxy ERC-1967 Implementation</li>
<li>Update Operator Fee vault Proxy ERC-1967 Implementation</li>
<li>GasPriceOracle Enable Isthmus</li>
<li>EIP-2935 Contract Deployment</li>
</ul>
</li>
</ul>
<p>To not modify or interrupt the system behavior around gas computation, this block will not include any sequenced
transactions by setting <code>noTxPool: true</code>.</p>
<h2 id="l1block-deployment-1"><a class="header" href="#l1block-deployment-1">L1Block deployment</a></h2>
<p>The <code>L1Block</code> contract is upgraded to support the Isthmus operator fee feature.</p>
<p>A deposit transaction is derived with the following attributes:</p>
<ul>
<li><code>from</code>: <code>0x4210000000000000000000000000000000000003</code></li>
<li><code>to</code>: <code>null</code></li>
<li><code>mint</code>: <code>0</code></li>
<li><code>value</code>: <code>0</code></li>
<li><code>gasLimit</code>: <code>425,000</code></li>
<li><code>data</code>: <code>0x60806040523480156100105...</code> (<a href="protocol/isthmus/../../static/bytecode/isthmus-l1-block-deployment.txt">full bytecode</a>)</li>
<li><code>sourceHash</code>: <code>0x3b2d0821ca2411ad5cd3595804d1213d15737188ae4cbd58aa19c821a6c211bf</code>,
computed with the "Upgrade-deposited" type, with `intent = "Isthmus: L1 Block Deployment"</li>
</ul>
<p>This results in the Isthmus L1Block contract being deployed to <code>0xFf256497D61dcd71a9e9Ff43967C13fdE1F72D12</code>, to verify:</p>
<pre><code class="language-bash">cast compute-address --nonce=0 0x4210000000000000000000000000000000000003
Computed Address: 0xFf256497D61dcd71a9e9Ff43967C13fdE1F72D12
</code></pre>
<p>Verify <code>sourceHash</code>:</p>
<pre><code class="language-bash">cast keccak $(cast concat-hex 0x0000000000000000000000000000000000000000000000000000000000000002 $(cast keccak "Isthmus: L1 Block Deployment"))
# 0x3b2d0821ca2411ad5cd3595804d1213d15737188ae4cbd58aa19c821a6c211bf
</code></pre>
<p>Verify <code>data</code>:</p>
<pre><code class="language-bash">git checkout 9436dba8c4c906e36675f5922e57d1b55582889e
make build-contracts
jq -r ".bytecode.object" packages/contracts-bedrock/forge-artifacts/L1Block.sol/L1Block.json
</code></pre>
<p>This transaction MUST deploy a contract with the following code hash
<code>0x8e3fe7a416d3e5f3b7be74ddd4e7e58e516fa3f80b67c6d930e3cd7297da4a4b</code>.</p>
<p>To verify the code hash:</p>
<pre><code class="language-bash">git checkout 9436dba8c4c906e36675f5922e57d1b55582889e
make build-contracts
cast k $(jq -r ".deployedBytecode.object" packages/contracts-bedrock/forge-artifacts/L1Block.sol/L1Block.json)
</code></pre>
<h2 id="gaspriceoracle-deployment-2"><a class="header" href="#gaspriceoracle-deployment-2">GasPriceOracle deployment</a></h2>
<p>The <code>GasPriceOracle</code> contract is also upgraded to support the Isthmus operator fee feature.</p>
<p>A deposit transaction is derived with the following attributes:</p>
<ul>
<li><code>from</code>: <code>0x4210000000000000000000000000000000000004</code></li>
<li><code>to</code>: <code>null</code></li>
<li><code>mint</code>: <code>0</code></li>
<li><code>value</code>: <code>0</code></li>
<li><code>gasLimit</code>: <code>1,625,000</code></li>
<li><code>data</code>: <code>0x60806040523480156100105...</code> (<a href="protocol/isthmus/../../static/bytecode/isthmus-gas-price-oracle-deployment.txt">full bytecode</a>)</li>
<li><code>sourceHash</code>: <code>0xfc70b48424763fa3fab9844253b4f8d508f91eb1f7cb11a247c9baec0afb8035</code>,
computed with the "Upgrade-deposited" type, with `intent = "Isthmus: Gas Price Oracle Deployment"</li>
</ul>
<p>This results in the Isthmus GasPriceOracle contract being deployed to <code>0x93e57A196454CB919193fa9946f14943cf733845</code>, to verify:</p>
<pre><code class="language-bash">cast compute-address --nonce=0 0x4210000000000000000000000000000000000003
Computed Address: 0xFf256497D61dcd71a9e9Ff43967C13fdE1F72D12
</code></pre>
<p>Verify <code>sourceHash</code>:</p>
<pre><code class="language-bash">cast keccak $(cast concat-hex 0x0000000000000000000000000000000000000000000000000000000000000002 $(cast keccak "Isthmus: Gas Price Oracle Deployment"))
# 0xfc70b48424763fa3fab9844253b4f8d508f91eb1f7cb11a247c9baec0afb8035
</code></pre>
<p>Verify <code>data</code>:</p>
<pre><code class="language-bash">git checkout 9436dba8c4c906e36675f5922e57d1b55582889e
make build-contracts
jq -r ".bytecode.object" packages/contracts-bedrock/forge-artifacts/GasPriceOracle.sol/GasPriceOracle.json
</code></pre>
<p>This transaction MUST deploy a contract with the following code hash
<code>0x4d195a9d7caf9fb6d4beaf80de252c626c853afd5868c4f4f8d19c9d301c2679</code>.</p>
<p>To verify the code hash:</p>
<pre><code class="language-bash">git checkout 9436dba8c4c906e36675f5922e57d1b55582889e
make build-contracts
cast k $(jq -r ".deployedBytecode.object" packages/contracts-bedrock/forge-artifacts/GasPriceOracle.sol/GasPriceOracle.json)
</code></pre>
<h2 id="operator-fee-vault-deployment"><a class="header" href="#operator-fee-vault-deployment">Operator fee vault deployment</a></h2>
<p>A new <code>OperatorFeeVault</code> contract has been created to receive the operator fees. The contract is created
with the following arguments:</p>
<ul>
<li>Recipient address: The base fee vault</li>
<li>Min withdrawal amount: 0</li>
<li>Withdrawal network: L2</li>
</ul>
<p>A deposit transaction is derived with the following attributes:</p>
<ul>
<li><code>from</code>: <code>0x4210000000000000000000000000000000000005</code></li>
<li><code>to</code>: <code>null</code></li>
<li><code>mint</code>: <code>0</code></li>
<li><code>value</code>: <code>0</code></li>
<li><code>gasLimit</code>: <code>500,000</code></li>
<li><code>data</code>: <code>0x60806040523480156100105...</code> (<a href="protocol/isthmus/../../static/bytecode/isthmus-operator-fee-deployment.txt">full bytecode</a>)</li>
<li><code>sourceHash</code>: <code>0x107a570d3db75e6110817eb024f09f3172657e920634111ce9875d08a16daa96</code>,
computed with the "Upgrade-deposited" type, with `intent = "Isthmus: Operator Fee Vault Deployment"</li>
</ul>
<p>This results in the Isthmus OperatorFeeVault contract being deployed to
<code>0x4fa2Be8cd41504037F1838BcE3bCC93bC68Ff537</code>, to verify:</p>
<pre><code class="language-bash">cast compute-address --nonce=0 0x4210000000000000000000000000000000000003
Computed Address: 0x4fa2Be8cd41504037F1838BcE3bCC93bC68Ff537
</code></pre>
<p>Verify <code>sourceHash</code>:</p>
<pre><code class="language-bash">cast keccak $(cast concat-hex 0x0000000000000000000000000000000000000000000000000000000000000002 $(cast keccak "Isthmus: Operator Fee Vault Deployment"))
# 0x107a570d3db75e6110817eb024f09f3172657e920634111ce9875d08a16daa96
</code></pre>
<p>Verify <code>data</code>:</p>
<pre><code class="language-bash">git checkout 9436dba8c4c906e36675f5922e57d1b55582889e
make build-contracts
jq -r ".bytecode.object" packages/contracts-bedrock/forge-artifacts/OperatorFeeVault.sol/OperatorFeeVault.json
</code></pre>
<p>This transaction MUST deploy a contract with the following code hash
<code>0x57dc55c9c09ca456fa728f253fe7b895d3e6aae0706104935fe87c7721001971</code>.</p>
<p>To verify the code hash:</p>
<pre><code class="language-bash">git checkout 9436dba8c4c906e36675f5922e57d1b55582889e
make build-contracts
export ETH_RPC_URL=https://mainnet.optimism.io # Any RPC running Cancun or Prague
cast k $(cast call --create $(jq -r ".bytecode.object" packages/contracts-bedrock/forge-artifacts/OperatorFeeVault.sol/OperatorFeeVault.json))
</code></pre>
<p>Note that this verification differs from the other deployments because the <code>OperatorFeeVault</code>
inherits the <code>FeeVault</code> contract which contains immutables. So the deployment bytecode has to be
executed on an EVM to get the actual deployed contract bytecode. But it sets all immutables to fixed
constants, so the resulting code hash is constant.</p>
<h2 id="l1block-proxy-update-1"><a class="header" href="#l1block-proxy-update-1">L1Block Proxy Update</a></h2>
<p>This transaction updates the L1Block Proxy ERC-1967 implementation slot to point to the new L1Block deployment.</p>
<p>A deposit transaction is derived with the following attributes:</p>
<ul>
<li><code>from</code>: <code>0x0000000000000000000000000000000000000000</code></li>
<li><code>to</code>: <code>0x4200000000000000000000000000000000000015</code> (L1Block Proxy)</li>
<li><code>mint</code>: <code>0</code></li>
<li><code>value</code>: <code>0</code></li>
<li><code>gasLimit</code>: <code>50,000</code></li>
<li><code>data</code>: <code>0x3659cfe6000000000000000000000000ff256497d61dcd71a9e9ff43967c13fde1f72d12</code></li>
<li><code>sourceHash</code>: <code>0xebe8b5cb10ca47e0d8bda8f5355f2d66711a54ddeb0ef1d30e29418c9bf17a0e</code>
computed with the "Upgrade-deposited" type, with `intent = "Isthmus: L1 Block Proxy Update"</li>
</ul>
<p>Verify data:</p>
<pre><code class="language-bash">cast concat-hex $(cast sig "upgradeTo(address)") $(cast abi-encode "upgradeTo(address)" 0xff256497d61dcd71a9e9ff43967c13fde1f72d12)
0x3659cfe6000000000000000000000000ff256497d61dcd71a9e9ff43967c13fde1f72d12
</code></pre>
<p>Verify <code>sourceHash</code>:</p>
<pre><code class="language-bash">cast keccak $(cast concat-hex 0x0000000000000000000000000000000000000000000000000000000000000002 $(cast keccak "Isthmus: L1 Block Proxy Update"))
# 0xebe8b5cb10ca47e0d8bda8f5355f2d66711a54ddeb0ef1d30e29418c9bf17a0e
</code></pre>
<h2 id="gaspriceoracle-proxy-update-2"><a class="header" href="#gaspriceoracle-proxy-update-2">GasPriceOracle Proxy Update</a></h2>
<p>This transaction updates the GasPriceOracle Proxy ERC-1967 implementation slot to point to the new GasPriceOracle
deployment.</p>
<p>A deposit transaction is derived with the following attributes:</p>
<ul>
<li><code>from</code>: <code>0x0000000000000000000000000000000000000000</code></li>
<li><code>to</code>: <code>0x420000000000000000000000000000000000000F</code> (Gas Price Oracle Proxy)</li>
<li><code>mint</code>: <code>0</code></li>
<li><code>value</code>: <code>0</code></li>
<li><code>gasLimit</code>: <code>50,000</code></li>
<li><code>data</code>: <code>0x3659cfe600000000000000000000000093e57a196454cb919193fa9946f14943cf733845</code></li>
<li><code>sourceHash</code>: <code>0xecf2d9161d26c54eda6b7bfdd9142719b1e1199a6e5641468d1bf705bc531ab0</code>
computed with the "Upgrade-deposited" type, with <code>intent = "Isthmus: Gas Price Oracle Proxy Update"</code></li>
</ul>
<p>Verify data:</p>
<pre><code class="language-bash">cast concat-hex $(cast sig "upgradeTo(address)") $(cast abi-encode "upgradeTo(address)" 0x93e57a196454cb919193fa9946f14943cf733845)
0x3659cfe600000000000000000000000093e57a196454cb919193fa9946f14943cf733845
</code></pre>
<p>Verify <code>sourceHash</code>:</p>
<pre><code class="language-bash">cast keccak $(cast concat-hex 0x0000000000000000000000000000000000000000000000000000000000000002 $(cast keccak "Isthmus: Gas Price Oracle Proxy Update"))
# 0xecf2d9161d26c54eda6b7bfdd9142719b1e1199a6e5641468d1bf705bc531ab0
</code></pre>
<h2 id="operatorfeevault-proxy-update"><a class="header" href="#operatorfeevault-proxy-update">OperatorFeeVault Proxy Update</a></h2>
<p>This transaction updates the GasPriceOracle Proxy ERC-1967 implementation slot to point to the new GasPriceOracle
deployment.</p>
<p>A deposit transaction is derived with the following attributes:</p>
<ul>
<li><code>from</code>: <code>0x0000000000000000000000000000000000000000</code></li>
<li><code>to</code>: <code>0x420000000000000000000000000000000000001B</code> (Operator Fee Vault Proxy)</li>
<li><code>mint</code>: <code>0</code></li>
<li><code>value</code>: <code>0</code></li>
<li><code>gasLimit</code>: <code>50,000</code></li>
<li><code>data</code>: <code>0x3659cfe60000000000000000000000004fa2be8cd41504037f1838bce3bcc93bc68ff537</code></li>
<li><code>sourceHash</code>: <code>0xad74e1adb877ccbe176b8fa1cc559388a16e090ddbe8b512f5b37d07d887a927</code>
computed with the "Upgrade-deposited" type, with <code>intent = "Isthmus: Operator Fee Vault Proxy Update"</code></li>
</ul>
<p>Verify data:</p>
<pre><code class="language-bash">cast concat-hex $(cast sig "upgradeTo(address)") $(cast abi-encode "upgradeTo(address)" 0x4fa2be8cd41504037f1838bce3bcc93bc68ff537)
0x3659cfe60000000000000000000000004fa2be8cd41504037f1838bce3bcc93bc68ff537
</code></pre>
<p>Verify <code>sourceHash</code>:</p>
<pre><code class="language-bash">cast keccak $(cast concat-hex 0x0000000000000000000000000000000000000000000000000000000000000002 $(cast keccak "Isthmus: Operator Fee Vault Proxy Update"))
# 0xad74e1adb877ccbe176b8fa1cc559388a16e090ddbe8b512f5b37d07d887a927
</code></pre>
<h2 id="gaspriceoracle-enable-isthmus"><a class="header" href="#gaspriceoracle-enable-isthmus">GasPriceOracle Enable Isthmus</a></h2>
<p>This transaction informs the GasPriceOracle to start using the Isthmus gas calculation formula.</p>
<p>A deposit transaction is derived with the following attributes:</p>
<ul>
<li><code>from</code>: <code>0xDeaDDEaDDeAdDeAdDEAdDEaddeAddEAdDEAd0001</code> (Depositer Account)</li>
<li><code>to</code>: <code>0x420000000000000000000000000000000000000F</code> (Gas Price Oracle Proxy)</li>
<li><code>mint</code>: <code>0</code></li>
<li><code>value</code>: <code>0</code></li>
<li><code>gasLimit</code>: <code>90,000</code></li>
<li><code>data</code>: <code>0x291b0383</code></li>
<li><code>sourceHash</code>: <code>0x3ddf4b1302548dd92939826e970f260ba36167f4c25f18390a5e8b194b295319</code>,
computed with the "Upgrade-deposited" type, with `intent = "Isthmus: Gas Price Oracle Set Isthmus"</li>
</ul>
<p>Verify data:</p>
<pre><code class="language-bash">cast sig "setIsthmus()"
0x8e98b106
</code></pre>
<p>Verify <code>sourceHash</code>:</p>
<pre><code class="language-bash">cast keccak $(cast concat-hex 0x0000000000000000000000000000000000000000000000000000000000000002 $(cast keccak "Isthmus: Gas Price Oracle Set Isthmus"))
# 0x3ddf4b1302548dd92939826e970f260ba36167f4c25f18390a5e8b194b295319
</code></pre>
<h2 id="eip-2935-contract-deployment"><a class="header" href="#eip-2935-contract-deployment">EIP-2935 Contract Deployment</a></h2>
<p><a href="https://eips.ethereum.org/EIPS/eip-2935">EIP-2935</a> requires a contract to be deployed. To deploy this contract,
a deposit transaction is created with attributes matching the EIP:</p>
<ul>
<li><code>from</code>: <code>0x3462413Af4609098e1E27A490f554f260213D685</code></li>
<li><code>to</code>: <code>null</code></li>
<li><code>mint</code>: <code>0</code></li>
<li><code>value</code>: <code>0</code></li>
<li><code>gasLimit</code>: <code>250,000</code></li>
<li><code>data</code>: <code>0x60538060095f395ff33373fffffffffffffffffffffffffffffffffffffffe14604657602036036042575f35600143038111604257611fff81430311604257611fff9006545f5260205ff35b5f5ffd5b5f35611fff60014303065500</code></li>
<li><code>sourceHash</code>: <code>0xbfb734dae514c5974ddf803e54c1bc43d5cdb4a48ae27e1d9b875a5a150b553a</code>
computed with the "Upgrade-deposited" type, with `intent = "Isthmus: EIP-2935 Contract Deployment"</li>
</ul>
<p>This results in the EIP-2935 contract being deployed to <code>0x0000F90827F1C53a10cb7A02335B175320002935</code>, to verify:</p>
<pre><code class="language-bash">cast compute-address --nonce=0 0x3462413Af4609098e1E27A490f554f260213D685
Computed Address: 0x0000F90827F1C53a10cb7A02335B175320002935
</code></pre>
<p>Verify <code>sourceHash</code>:</p>
<pre><code class="language-bash">cast keccak $(cast concat-hex 0x0000000000000000000000000000000000000000000000000000000000000002 $(cast keccak "Isthmus: EIP-2935 Contract Deployment"))
# 0xbfb734dae514c5974ddf803e54c1bc43d5cdb4a48ae27e1d9b875a5a150b553a
</code></pre>
<p>This transaction MUST deploy a contract with the following code hash
<code>0x6e49e66782037c0555897870e29fa5e552daf4719552131a0abce779daec0a5d</code>.</p>
<h1 id="span-batch-updates"><a class="header" href="#span-batch-updates">Span Batch Updates</a></h1>
<p><a href="protocol/isthmus/../delta/span-batches.html">Span batches</a> are a span of consecutive L2 blocks than are batched submitted.</p>
<p>Span batches contain the L1 transactions and transaction types that are posted containing the span of L2 blocks.
Since <a href="https://eips.ethereum.org/EIPS/eip-7702">EIP-7702</a> introduces a new transaction type, the Span Batch must be updated to support the <a href="https://eips.ethereum.org/EIPS/eip-7702">EIP-7702</a>
transaction.</p>
<p>This corresponds with a new RLP-encoding of the <code>tx_datas</code> list as specified in
<a href="protocol/isthmus/../delta/span-batches.html">the Delta span batch spec</a>, adding a new transaction type:</p>
<p>Transaction type <code>4</code> (<a href="https://eips.ethereum.org/EIPS/eip-7702">EIP-7702</a> <code>SetCode</code>):
<code>0x04 ++ rlp_encode(value, max_priority_fee_per_gas, max_fee_per_gas, data, access_list, authorization_list)</code></p>
<p>The <a href="https://eips.ethereum.org/EIPS/eip-7702">EIP-7702</a> transaction extends <a href="https://eips.ethereum.org/EIPS/eip-1559">EIP-1559</a> to include a new <code>authorization_list</code> field.
<code>authorization_list</code> is an RLP-encoded list of authorization tuples.
The <a href="https://eips.ethereum.org/EIPS/eip-7702">EIP-7702</a> transaction format is as follows.</p>
<ul>
<li><code>value</code>: The transaction value as a <code>u256</code>.</li>
<li><code>max_priority_fee_per_gas</code>: The maximum priority fee per gas allowed as a <code>u256</code>.</li>
<li><code>max_fee_per_gas</code>: The maximum fee per gas as a <code>u256</code>.</li>
<li><code>data</code>: The transaction data bytes.</li>
<li><code>access_list</code>: The <a href="https://eips.ethereum.org/EIPS/eip-2930">EIP-2930</a> access list.</li>
<li><code>authorization_list</code>: The <a href="https://eips.ethereum.org/EIPS/eip-7702">EIP-7702</a> signed authorization list.</li>
</ul>
<h2 id="activation-1"><a class="header" href="#activation-1">Activation</a></h2>
<p>Singular batches with transactions of type <code>4</code> must only be accepted if Isthmus is active at the
timestamp of the batch. If a singular batch contains a transaction of type <code>4</code> before Isthmus is
active, this batch must be <em>dropped</em>. Note that if Holocene is active, this will also
lead to the remaining span batch, and channel that contained it, to get dropped.</p>
<p>Also note that this check must happen at the level of individual batches that are derived from span
batches, not to span batches as a whole. In particular, it is allowed for a span batch to span the
Isthmus activation timestamp and contain SetCode transactions in singular batches that have a
timestamp at or after the Isthmus activation time, even if the timestamp of the span batch is before
the Isthmus activation time.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="l1-block-attributes"><a class="header" href="#l1-block-attributes">L1 Block Attributes</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/isthmus/l1-attributes.html#overview">Overview</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-34"><a class="header" href="#overview-34">Overview</a></h2>
<p>The L1 block attributes transaction is updated to include the operator fee parameters.</p>
<div class="table-wrapper"><table><thead><tr><th>Input arg</th><th>Type</th><th>Calldata bytes</th><th>Segment</th></tr></thead><tbody>
<tr><td>{0x098999be}</td><td></td><td>0-3</td><td>n/a</td></tr>
<tr><td>baseFeeScalar</td><td>uint32</td><td>4-7</td><td>1</td></tr>
<tr><td>blobBaseFeeScalar</td><td>uint32</td><td>8-11</td><td></td></tr>
<tr><td>sequenceNumber</td><td>uint64</td><td>12-19</td><td></td></tr>
<tr><td>l1BlockTimestamp</td><td>uint64</td><td>20-27</td><td></td></tr>
<tr><td>l1BlockNumber</td><td>uint64</td><td>28-35</td><td></td></tr>
<tr><td>basefee</td><td>uint256</td><td>36-67</td><td>2</td></tr>
<tr><td>blobBaseFee</td><td>uint256</td><td>68-99</td><td>3</td></tr>
<tr><td>l1BlockHash</td><td>bytes32</td><td>100-131</td><td>4</td></tr>
<tr><td>batcherHash</td><td>bytes32</td><td>132-163</td><td>5</td></tr>
<tr><td>operatorFeeScalar</td><td>uint32</td><td>164-167</td><td>6</td></tr>
<tr><td>operatorFeeConstant</td><td>uint64</td><td>168-175</td><td></td></tr>
</tbody></table>
</div>
<p>Note that the first input argument, in the same pattern as previous versions of the L1 attributes transaction,
is the function selector: the first four bytes of <code>keccak256("setL1BlockValuesIsthmus()")</code>.</p>
<p>In the activation block, there are two possibilities:</p>
<ul>
<li>If Isthmus is active at genesis, there are no transactions in the activation block
and therefore no L1 Block Attributes transaction to consider.</li>
<li>If Isthmus activates after genesis <a href="protocol/isthmus/../ecotone/l1-attributes.html"><code>setL1BlockValuesEcotone()</code></a>
method must be used. This is because the L1 Block contract will not yet have been upgraded.</li>
</ul>
<p>In each subsequent L2 block, the <code>setL1BlockValuesIsthmus()</code> method must be used.</p>
<p>When using this method, the pre-Isthmus values are migrated over 1:1
and the transaction also sets the following new attributes to the values
from the <a href="protocol/isthmus/./system-config.html"><code>SystemConfig</code></a>:</p>
<ul>
<li><code>operatorFeeScalar</code></li>
<li><code>operatorFeeConstant</code></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="predeploys-2"><a class="header" href="#predeploys-2">Predeploys</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/isthmus/predeploys.html#overview">Overview</a>
<ul>
<li><a href="protocol/isthmus/predeploys.html#l1block">L1Block</a>
<ul>
<li><a href="protocol/isthmus/predeploys.html#interface">Interface</a>
<ul>
<li><a href="protocol/isthmus/predeploys.html#setisthmus"><code>setIsthmus</code></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="protocol/isthmus/predeploys.html#gaspriceoracle">GasPriceOracle</a></li>
<li><a href="protocol/isthmus/predeploys.html#operatorfeevault">OperatorFeeVault</a></li>
</ul>
</li>
<li><a href="protocol/isthmus/predeploys.html#security-considerations">Security Considerations</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-35"><a class="header" href="#overview-35">Overview</a></h2>
<h3 id="l1block-1"><a class="header" href="#l1block-1">L1Block</a></h3>
<h4 id="interface-2"><a class="header" href="#interface-2">Interface</a></h4>
<h5 id="setisthmus"><a class="header" href="#setisthmus"><code>setIsthmus</code></a></h5>
<p>This function is meant to be called once on the activation block of the Isthmus network upgrade.
It MUST only be callable by the <code>DEPOSITOR_ACCOUNT</code> once. When it is called, it MUST call
call each getter for the network specific config and set the returndata into storage.</p>
<h3 id="gaspriceoracle-2"><a class="header" href="#gaspriceoracle-2">GasPriceOracle</a></h3>
<p>Following the Isthmus upgrade, a new method is introduced: <code>getOperatorFee(uint256)</code>. This method
returns the operator fee for the given <code>gasUsed</code>. The operator fee calculation follows the formula
outlined in the <a href="protocol/isthmus/./exec-engine.html#">Operator Fee</a> section of the execution engine spec.</p>
<p>The value returned by <code>getOperatorFee(uint256)</code> is capped at <code>U256</code> max value.</p>
<h3 id="operatorfeevault"><a class="header" href="#operatorfeevault">OperatorFeeVault</a></h3>
<p>This vault implements <code>FeeVault</code>, like <code>BaseFeeVault</code>, <code>SequencerFeeVault</code>, and <code>L1FeeVault</code>.
No special logic is needed in order to insert or withdraw funds.</p>
<p>Its address will be <code>0x420000000000000000000000000000000000001b</code>.</p>
<p>See also <a href="protocol/isthmus/./exec-engine.html#fee-vaults">Fee Vaults</a>.</p>
<h2 id="security-considerations-4"><a class="header" href="#security-considerations-4">Security Considerations</a></h2>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="isthmus-system-config"><a class="header" href="#isthmus-system-config">Isthmus: System Config</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/isthmus/system-config.html#operator-fee-parameter-configuration">Operator Fee Parameter Configuration</a>
<ul>
<li><a href="protocol/isthmus/system-config.html#configupdate"><code>ConfigUpdate</code></a></li>
<li><a href="protocol/isthmus/system-config.html#initialization">Initialization</a></li>
<li><a href="protocol/isthmus/system-config.html#modifying-operator-fee-parameters">Modifying Operator Fee Parameters</a></li>
<li><a href="protocol/isthmus/system-config.html#interface">Interface</a>
<ul>
<li><a href="protocol/isthmus/system-config.html#operator-fee-parameters">Operator fee parameters</a>
<ul>
<li><a href="protocol/isthmus/system-config.html#operatorfeescalar"><code>operatorFeeScalar</code></a></li>
<li><a href="protocol/isthmus/system-config.html#operatorfeeconstant"><code>operatorFeeConstant</code></a></li>
<li><a href="protocol/isthmus/system-config.html#setoperatorfeescalars"><code>setOperatorFeeScalars</code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="operator-fee-parameter-configuration"><a class="header" href="#operator-fee-parameter-configuration">Operator Fee Parameter Configuration</a></h2>
<p>Isthmus adds configuration variables <code>operatorFeeScalar</code> (<code>uint32</code>)
and <code>operatorFeeConstant</code> (<code>uint64</code>) to <code>SystemConfig</code> to control the operator fee parameters.</p>
<h3 id="configupdate-1"><a class="header" href="#configupdate-1"><code>ConfigUpdate</code></a></h3>
<p>The following <code>ConfigUpdate</code> event is defined where the <code>CONFIG_VERSION</code> is <code>uint256(0)</code>:</p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Value</th><th>Definition</th><th>Usage</th></tr></thead><tbody>
<tr><td><code>BATCHER</code></td><td><code>uint8(0)</code></td><td><code>abi.encode(address)</code></td><td>Modifies the account that is authorized to progress the safe chain</td></tr>
<tr><td><code>FEE_SCALARS</code></td><td><code>uint8(1)</code></td><td><code>(uint256(0x01) &lt;&lt; 248) | (uint256(_blobbasefeeScalar) &lt;&lt; 32) | _basefeeScalar</code></td><td>Modifies the fee scalars</td></tr>
<tr><td><code>GAS_LIMIT</code></td><td><code>uint8(2)</code></td><td><code>abi.encode(uint64 _gasLimit)</code></td><td>Modifies the L2 gas limit</td></tr>
<tr><td><code>UNSAFE_BLOCK_SIGNER</code></td><td><code>uint8(3)</code></td><td><code>abi.encode(address)</code></td><td>Modifies the account that is authorized to progress the unsafe chain</td></tr>
<tr><td><code>EIP_1559_PARAMS</code></td><td><code>uint8(4)</code></td><td><code>uint256(uint64(uint32(_denominator))) &lt;&lt; 32 | uint64(uint32(_elasticity))</code></td><td>Modifies the EIP-1559 denominator and elasticity</td></tr>
<tr><td><code>OPERATOR_FEE_PARAMS</code></td><td><code>uint8(5)</code></td><td><code>uint256(_operatorFeeScalar) &lt;&lt; 64 | _operatorFeeConstant</code></td><td>Modifies the operator fee scalar and constant</td></tr>
</tbody></table>
</div>
<h3 id="initialization-1"><a class="header" href="#initialization-1">Initialization</a></h3>
<p>The following actions should happen during the initialization of the <code>SystemConfig</code>:</p>
<ul>
<li><code>emit ConfigUpdate.BATCHER</code></li>
<li><code>emit ConfigUpdate.FEE_SCALARS</code></li>
<li><code>emit ConfigUpdate.GAS_LIMIT</code></li>
<li><code>emit ConfigUpdate.UNSAFE_BLOCK_SIGNER</code></li>
<li><code>emit ConfigUpdate.EIP_1559_PARAMS</code></li>
</ul>
<p>These actions MAY only be triggered if there is a diff to the value.</p>
<p>The <code>operatorFeeScalar</code> and <code>operatorFeeConstant</code> are initialized to 0.</p>
<h3 id="modifying-operator-fee-parameters"><a class="header" href="#modifying-operator-fee-parameters">Modifying Operator Fee Parameters</a></h3>
<p>A new <code>SystemConfig</code> <code>UpdateType</code> is introduced that enables the modification of
the <code>operatorFeeScalar</code> and <code>operatorFeeConstant</code> by the <code>SystemConfig</code> owner.</p>
<h3 id="interface-3"><a class="header" href="#interface-3">Interface</a></h3>
<h4 id="operator-fee-parameters"><a class="header" href="#operator-fee-parameters">Operator fee parameters</a></h4>
<h5 id="operatorfeescalar"><a class="header" href="#operatorfeescalar"><code>operatorFeeScalar</code></a></h5>
<p>This function returns the currently configured operator fee scalar.</p>
<pre><code class="language-solidity">function operatorFeeScalar()(uint32)
</code></pre>
<h5 id="operatorfeeconstant"><a class="header" href="#operatorfeeconstant"><code>operatorFeeConstant</code></a></h5>
<p>This function returns the currently configured operator fee constant.</p>
<pre><code class="language-solidity">function operatorFeeConstant()(uint64)
</code></pre>
<h5 id="setoperatorfeescalars-1"><a class="header" href="#setoperatorfeescalars-1"><code>setOperatorFeeScalars</code></a></h5>
<p>This function sets the <code>operatorFeeScalar</code> and <code>operatorFeeConstant</code>.</p>
<p>This function MUST only be callable by the <code>SystemConfig</code> owner.</p>
<pre><code class="language-solidity">function setOperatorFeeScalar(uint32 _operatorFeeScalar, uint64 _operatorFeeConstant)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="jovian-network-upgrade"><a class="header" href="#jovian-network-upgrade">Jovian Network Upgrade</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/jovian/overview.html#execution-layer">Execution Layer</a></li>
<li><a href="protocol/jovian/overview.html#consensus-layer">Consensus Layer</a></li>
<li><a href="protocol/jovian/overview.html#smart-contracts">Smart Contracts</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<p>This document is not finalized and should be considered experimental.</p>
<h2 id="execution-layer-6"><a class="header" href="#execution-layer-6">Execution Layer</a></h2>
<ul>
<li><a href="protocol/jovian/./exec-engine.html#minimum-base-fee">Minimum Base Fee</a></li>
<li><a href="protocol/jovian/./exec-engine.html#da-footprint-limit">DA Footprint Limit</a></li>
<li><a href="protocol/jovian/./exec-engine.html#operator-fee">Operator Fee</a></li>
</ul>
<h2 id="consensus-layer-8"><a class="header" href="#consensus-layer-8">Consensus Layer</a></h2>
<ul>
<li><a href="protocol/jovian/./derivation.html#network-upgrade-transactions">Network upgrade transactions</a> applied during derivation</li>
<li>Auto-upgrading and extension of the <a href="protocol/jovian/./l1-attributes.html">L1 Attributes Predeployed Contract</a>
(also known as <code>L1Block</code> predeploy)</li>
</ul>
<h2 id="smart-contracts-2"><a class="header" href="#smart-contracts-2">Smart Contracts</a></h2>
<ul>
<li><a href="protocol/jovian/./system-config.html">System Config</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="jovian-execution-engine"><a class="header" href="#jovian-execution-engine">Jovian: Execution Engine</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/jovian/exec-engine.html#minimum-base-fee">Minimum Base Fee</a>
<ul>
<li><a href="protocol/jovian/exec-engine.html#minimum-base-fee-in-block-header">Minimum Base Fee in Block Header</a></li>
<li><a href="protocol/jovian/exec-engine.html#minimum-base-fee-in-payloadattributesv3">Minimum Base Fee in <code>PayloadAttributesV3</code></a></li>
<li><a href="protocol/jovian/exec-engine.html#rationale">Rationale</a></li>
</ul>
</li>
<li><a href="protocol/jovian/exec-engine.html#da-footprint-block-limit">DA Footprint Block Limit</a>
<ul>
<li><a href="protocol/jovian/exec-engine.html#scalar-loading">Scalar loading</a></li>
<li><a href="protocol/jovian/exec-engine.html#receipts">Receipts</a></li>
<li><a href="protocol/jovian/exec-engine.html#rationale-1">Rationale</a></li>
</ul>
</li>
<li><a href="protocol/jovian/exec-engine.html#operator-fee">Operator Fee</a>
<ul>
<li><a href="protocol/jovian/exec-engine.html#fee-formula-update">Fee Formula Update</a></li>
<li><a href="protocol/jovian/exec-engine.html#maximum-value">Maximum value</a></li>
</ul>
</li>
<li><a href="protocol/jovian/exec-engine.html#evm-changes">EVM Changes</a>
<ul>
<li><a href="protocol/jovian/exec-engine.html#precompile-input-size-restrictions">Precompile Input Size Restrictions</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="minimum-base-fee-1"><a class="header" href="#minimum-base-fee-1">Minimum Base Fee</a></h2>
<p>Jovian introduces a
<a href="https://github.com/ethereum-optimism/design-docs/blob/main/protocol/minimum-base-fee.md">configurable minimum base fee</a>
to reduce the duration of priority-fee auctions on OP Stack chains.</p>
<p>The minimum base fee is configured via <code>SystemConfig</code> (see <code>./system-config.md</code>) and enforced by the execution engine
via the block header <code>extraData</code> encoding and the Engine API <code>PayloadAttributesV3</code> parameters.</p>
<h3 id="minimum-base-fee-in-block-header"><a class="header" href="#minimum-base-fee-in-block-header">Minimum Base Fee in Block Header</a></h3>
<p>Like <a href="protocol/jovian/../holocene/exec-engine.html#dynamic-eip-1559-parameters">Holocene's dynamic EIP-1559 parameters</a>, Jovian encodes
fee parameters in the <code>extraData</code> field of each L2 block header. The format is extended to include an additional
<code>u64</code> field for the minimum base fee in wei.</p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Byte Offset</th></tr></thead><tbody>
<tr><td><code>minBaseFee</code></td><td><code>u64 (big-endian)</code></td><td><code>[9, 17)</code></td></tr>
</tbody></table>
</div>
<p>Constraints:</p>
<ul>
<li><code>version</code> MUST be <code>1</code> (incremented from Holocene's <code>0</code>).</li>
<li>There MUST NOT be any data beyond these 17 bytes.</li>
</ul>
<p>The <code>minBaseFee</code> field is an absolute minimum expressed in wei. During base fee computation, if the
computed <code>baseFee</code> is less than <code>minBaseFee</code>, it MUST be clamped to <code>minBaseFee</code>.</p>
<pre><code class="language-javascript">if (baseFee &lt; minBaseFee) {
  baseFee = minBaseFee
}
</code></pre>
<p>Note: <code>extraData</code> has a maximum capacity of 32 bytes (to fit the L1 beacon-chain <code>extraData</code> type) and may be
extended by future upgrades.</p>
<h3 id="minimum-base-fee-in-payloadattributesv3"><a class="header" href="#minimum-base-fee-in-payloadattributesv3">Minimum Base Fee in <code>PayloadAttributesV3</code></a></h3>
<p>The Engine API <a href="protocol/jovian/../exec-engine.html#extended-payloadattributesv3"><code>PayloadAttributesV3</code></a> is extended with a new
field <code>minBaseFee</code>. The existing <code>eip1559Params</code> remains 8 bytes (Holocene format).</p>
<pre><code class="language-text">PayloadAttributesV3: {
    timestamp: QUANTITY
    prevRandao: DATA (32 bytes)
    suggestedFeeRecipient: DATA (20 bytes)
    withdrawals: array of WithdrawalV1
    parentBeaconBlockRoot: DATA (32 bytes)
    transactions: array of DATA
    noTxPool: bool
    gasLimit: QUANTITY or null
    eip1559Params: DATA (8 bytes) or null
    minBaseFee: QUANTITY or null
}
</code></pre>
<p>The <code>minBaseFee</code> MUST be <code>null</code> prior to the Jovian fork, and MUST be non-<code>null</code> after the Jovian fork.</p>
<h3 id="rationale-6"><a class="header" href="#rationale-6">Rationale</a></h3>
<p>As with <a href="protocol/jovian/../holocene/exec-engine.html#rationale">Holocene's dynamic EIP-1559 parameters</a>, placing the
minimum base fee in the block header allows us to avoid reaching into the state during block sealing.
This retains the purity of the function that computes the next block's base fee from its parent block
header, while still allowing them to be dynamically configured. Dynamic configuration is handled
similarly to <code>gasLimit</code>, with the derivation pipeline providing the appropriate <code>SystemConfig</code>
contract values to the block builder via <code>PayloadAttributesV3</code> parameters.</p>
<h2 id="da-footprint-block-limit"><a class="header" href="#da-footprint-block-limit">DA Footprint Block Limit</a></h2>
<p>A <em>DA footprint block limit</em> is introduced to limit the total amount of estimated compressed
transaction data that can fit into a block.
For each transaction, a new resource called DA footprint is tracked, next to its gas usage.
It is scaled to the gas dimension so that its block total can also be limited by
the block gas limit, like a block's total gas usage.</p>
<p>Let a block's <code>daFootprint</code> be defined as follows:</p>
<pre><code class="language-python">def daFootprint(block: Block) -&gt; int:
  daFootprint = 0

  for tx in block.transactions:
      if tx.type == DEPOSIT_TX_TYPE:
          continue

      daUsageEstimate = max(
          minTransactionSize,
          (intercept + fastlzCoef * tx.fastlzSize) // 1e6
      )
      daFootprint += daUsageEstimate * daFootprintGasScalar

  return daFootprint 
</code></pre>
<p>where <code>intercept</code>, <code>minTransactionSize</code>, <code>fastlzCoef</code> and <code>fastlzSize</code>
are defined in the <a href="protocol/jovian/../fjord/exec-engine.html">Fjord specs</a>, <code>DEPOSIT_TX_TYPE</code> is <code>0x7E</code>,
and <code>//</code> represents integer floor division.</p>
<p>From Jovian, the <code>blobGasUsed</code> property of each block header is set to that block's <code>daFootprint</code>. Note that pre-Jovian,
since Ecotone, it was set to 0, as OP Stack chains don't support blobs. It is now repurposed to store the DA footprint.</p>
<p>During block building and header validation, it must be guaranteed and checked, respectively, that the block's
<code>daFootprint</code> stays below the <code>gasLimit</code>, just like the <code>gasUsed</code> property.
Note that this implies that blocks may have no more than <code>gasLimit/daFootprintGasScalar</code> total estimated DA usage bytes.</p>
<p>Furthermore, from Jovian, the base fee update calculation now uses <code>gasMetered := max(gasUsed, blobGasUsed)</code>
in place of the <code>gasUsed</code> value used before.
As a result, blocks with high DA usage may cause the base fee to increase in subsequent blocks.</p>
<h3 id="scalar-loading"><a class="header" href="#scalar-loading">Scalar loading</a></h3>
<p>The <code>daFootprintGasScalar</code> is loaded in a similar way to the <code>operatorFeeScalar</code> and <code>operatorFeeConstant</code>
<a href="protocol/jovian/../isthmus/exec-engine.html#operator-fee">included</a> in the Isthmus fork. It can be read in two interchangable ways:</p>
<ul>
<li>read from the deposited L1 attributes (<code>daFootprintGasScalar</code>) of the current L2 block
(decoded according to the <a href="protocol/jovian/./l1-attributes.html">jovian schema</a>)</li>
<li>read from the L1 Block Info contract (<code>0x4200000000000000000000000000000000000015</code>)
<ul>
<li>using the solidity getter function <code>daFootprintGasScalar</code></li>
<li>using a direct storage-read: big-endian <code>uint16</code> in slot <code>8</code> at offset <code>12</code>.</li>
</ul>
</li>
</ul>
<p>It takes on a default value as described in the section on <a href="protocol/jovian/./l1-attributes.html">L1 Attributes</a>.</p>
<h3 id="receipts-1"><a class="header" href="#receipts-1">Receipts</a></h3>
<p>After Jovian activation, a new field <code>daFootprintGasScalar</code> is added to transaction receipts that is populated
with the DA footprint gas scalar of the transaction's block.
Furthermore, the <code>blobGasUsed</code> receipt field is set to the DA footprint of the transaction.</p>
<h3 id="rationale-7"><a class="header" href="#rationale-7">Rationale</a></h3>
<p>While the current L1 fee mechanism charges for DA usage based on an estimate of the DA footprint of a transaction, no
protocol mechanism currently reflects the limited available <em>DA throughput on L1</em>. E.g. on Ethereum L1 with Pectra
enabled, the available blob throughput is <code>~96 kB/s</code> (with a target of <code>~64 kB/s</code>), but the calldata floor gas price of
<code>40</code> for calldata-heavy L2 transactions allows for more incompressible transaction data to be included on most OP Stack
chains than the Ethereum blob space could handle. This is currently mitigated at the policy level by batcher-sequencer
throttling: a mechanism which artificially constricts block building. This can cause base fees to fall, which implies
unnecessary losses for chain operators and a negative user experience (transaction inclusion delays, priority fee
auctions). So hard-limiting a block's DA footprint in a way that also influences the base fee mitigates the
aforementioned problems of policy-based solutions.</p>
<h2 id="operator-fee-1"><a class="header" href="#operator-fee-1">Operator Fee</a></h2>
<h3 id="fee-formula-update"><a class="header" href="#fee-formula-update">Fee Formula Update</a></h3>
<p>Jovian updates the operator fee calculation so that higher fees may be charged.
Starting at the Jovian activation, the operator fee MUST be computed as:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">operatorFee</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">gas</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">operatorFeeScalar</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">100</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">operatorFeeConstant</span></span></span></span></span></span></p>
<p>The effective per-gas scalar applied is therefore <code>100 * operatorFeeScalar</code>. Otherwise, the data types and operator fee
semantics described in the <a href="protocol/jovian/../isthmus/exec-engine.html#operator-fee">Isthmus spec</a> continue to apply.</p>
<h3 id="maximum-value"><a class="header" href="#maximum-value">Maximum value</a></h3>
<p>With the new formula, the operator fee's maximum value has 103 bits:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9275em;vertical-align:-0.2441em;"></span><span class="mord"><span class="mord text"><span class="mord">operatorFee</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.0573em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">max</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord text"><span class="mord">uint64</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">max</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8179em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord text"><span class="mord">uint32</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">max</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">100</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8179em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord text"><span class="mord">uint64</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">max</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â‰ˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">7.924660923989131</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8641em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">30</span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>Implementations that use <code>uint256</code> for intermediate arithmetic do not need additional overflow checks.</p>
<h2 id="evm-changes-2"><a class="header" href="#evm-changes-2">EVM Changes</a></h2>
<h3 id="precompile-input-size-restrictions"><a class="header" href="#precompile-input-size-restrictions">Precompile Input Size Restrictions</a></h3>
<p>Some precompiles have changes to the input size restrictions. The new input size restrictions are:</p>
<ul>
<li><code>bn256Pairing</code>: 81,984 bytes (427 pairs)</li>
<li><code>BLS12-381 G1 MSM</code>: 288,960 bytes (1,806 pairs)</li>
<li><code>BLS12-381 G2 MSM</code>: 278,784 bytes (968 pairs)</li>
<li><code>BLS12-381 Pairing</code>: 156,672 bytes (408 pairs)</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="derivation-2"><a class="header" href="#derivation-2">Derivation</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/jovian/derivation.html#activation-block-rules">Activation Block Rules</a></li>
<li><a href="protocol/jovian/derivation.html#network-upgrade-transactions">Network Upgrade Transactions</a>
<ul>
<li><a href="protocol/jovian/derivation.html#l1block-deployment">L1Block Deployment</a></li>
<li><a href="protocol/jovian/derivation.html#l1block-proxy-update">L1Block Proxy Update</a></li>
<li><a href="protocol/jovian/derivation.html#gaspriceoracle-deployment">GasPriceOracle Deployment</a></li>
<li><a href="protocol/jovian/derivation.html#gaspriceoracle-proxy-update">GasPriceOracle Proxy Update</a></li>
<li><a href="protocol/jovian/derivation.html#gaspriceoracle-enable-jovian">GasPriceOracle Enable Jovian</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="activation-block-rules"><a class="header" href="#activation-block-rules">Activation Block Rules</a></h2>
<p>The first block with a timestamp at or after the Jovian activation time is considered the <em>Jovian activation block</em>.</p>
<p>To not modify or interrupt the system behavior regarding gas computations, the activation block must not include any
non-deposit transactions. Sequencer must enforce this by setting <code>noTxPool</code> to <code>true</code> in the payload attributes. This
rule must be checked during derivation at the batch verification stage, and if the batch for the activation block
contains any transactions, it must be <code>DROP</code>ped.</p>
<p>On the Jovian activation block, in addition to the L1 attributes deposit and potentially any user deposits from L1, a
set of deposit transaction-based upgrade transactions are deterministically generated by the derivation pipeline in the
following order:</p>
<ul>
<li>L1 Attributes Transaction (still calling the old <code>L1Block.setL1BlockValuesIsthmus()</code>)</li>
<li>User deposits from L1 (if any)</li>
<li>Network Upgrade Transactions
<ul>
<li>L1Block deployment</li>
<li>Update L1Block Proxy ERC-1967 Implementation</li>
<li>GasPriceOracle deployment</li>
<li>Update GasPriceOracle Proxy ERC-1967 Implementation</li>
<li>GasPriceOracle Enable Jovian call</li>
</ul>
</li>
</ul>
<p>The network upgrade transactions are specified in the next section.</p>
<h2 id="network-upgrade-transactions"><a class="header" href="#network-upgrade-transactions">Network Upgrade Transactions</a></h2>
<p>The upgrade transaction details below are based on the monorepo at commit hash
<code>b3299e0ddb55442e6496512084d16c439ea2da77</code>, and will be updated once a contracts release is made.</p>
<h3 id="l1block-deployment-2"><a class="header" href="#l1block-deployment-2">L1Block Deployment</a></h3>
<!-- Generated with: ./scripts/run_gen_predeploy_docs.sh --optimism-repo-path ../../optimism \
--fork-name Jovian \
--contract-name L1Block \
--from-address 0x4210000000000000000000000000000000000006 \
--from-address-nonce 0 \
--git-commit-hash 773798a67678ab28c3ef7ee3405f25c04616af19 \
--eth-rpc-url https://optimism.rpc.subquery.network/public \
--proxy-address 0x4200000000000000000000000000000000000015 \
--copy-contract-bytecode true -->
<p>The <code>L1Block</code> contract is deployed.</p>
<p>A deposit transaction is derived with the following attributes:</p>
<ul>
<li><code>from</code>: <code>0x4210000000000000000000000000000000000006</code></li>
<li><code>to</code>: <code>null</code></li>
<li><code>mint</code>: <code>0</code></li>
<li><code>value</code>: <code>0</code></li>
<li><code>nonce</code>: <code>0</code></li>
<li><code>gasLimit</code>: <code>447315</code></li>
<li><code>data</code>: <code>0x0x608060405234801561001057600080...</code> (<a href="protocol/jovian/../../../specs/static/bytecode/jovian-l1-block-deployment.txt">full bytecode</a>)</li>
<li><code>sourceHash</code>: <code>0x98faf23b9795967bc0b1c543144739d50dba3ea40420e77ad6ca9848dbfb62e8</code>,
computed with the "Upgrade-deposited" type, with <code>intent = "Jovian: L1Block Deployment"</code></li>
</ul>
<p>This results in the Jovian L1Block contract being deployed to
<code>0x3Ba4007f5C922FBb33C454B41ea7a1f11E83df2C</code>, to verify:</p>
<pre><code class="language-bash">cast compute-address --nonce=0 0x4210000000000000000000000000000000000006
Computed Address: 0x3Ba4007f5C922FBb33C454B41ea7a1f11E83df2C
</code></pre>
<p>Verify <code>sourceHash</code>:</p>
<pre><code class="language-bash">cast keccak $(cast concat-hex 0x0000000000000000000000000000000000000000000000000000000000000002 $(cast keccak "Jovian: L1Block Deployment"))
# 0x98faf23b9795967bc0b1c543144739d50dba3ea40420e77ad6ca9848dbfb62e8
</code></pre>
<p>Verify <code>data</code>:</p>
<pre><code class="language-bash">git checkout 773798a67678ab28c3ef7ee3405f25c04616af19
make build-contracts
jq -r ".bytecode.object" packages/contracts-bedrock/forge-artifacts/L1Block.sol/L1Block.json
</code></pre>
<p>This transaction MUST deploy a contract with the following code hash
<code>0x5f885ca815d2cf27a203123e50b8ae204fdca910b6995d90b2d7700cbb9240d1</code>.</p>
<p>To verify the code hash:</p>
<pre><code class="language-bash">git checkout 773798a67678ab28c3ef7ee3405f25c04616af19
make build-contracts
cast k $(jq -r ".deployedBytecode.object" packages/contracts-bedrock/forge-artifacts/L1Block.sol/L1Block.json)
</code></pre>
<h3 id="l1block-proxy-update-2"><a class="header" href="#l1block-proxy-update-2">L1Block Proxy Update</a></h3>
<p>This transaction updates the L1Block Proxy ERC-1967
implementation slot to point to the new L1Block deployment.</p>
<p>A deposit transaction is derived with the following attributes:</p>
<ul>
<li><code>from</code>: <code>0x0000000000000000000000000000000000000000</code></li>
<li><code>to</code>: <code>0x4200000000000000000000000000000000000015</code> (L1Block Proxy)</li>
<li><code>mint</code>: <code>0</code></li>
<li><code>value</code>: <code>0</code></li>
<li><code>gasLimit</code>: <code>50,000</code></li>
<li><code>data</code>: <code>0x3659cfe60000000000000000000000003ba4007f5c922fbb33c454b41ea7a1f11e83df2c</code></li>
<li><code>sourceHash</code>: <code>0x08447273a4fbce97bc8c515f97ac74efc461f6a4001553712f31ebc11288bad2</code>
computed with the "Upgrade-deposited" type, with <code>intent = "Jovian: L1Block Proxy Update"</code></li>
</ul>
<p>Verify data:</p>
<pre><code class="language-bash">cast concat-hex $(cast sig "upgradeTo(address)") $(cast abi-encode "upgradeTo(address)" 0x3Ba4007f5C922FBb33C454B41ea7a1f11E83df2C)
# 0x3659cfe60000000000000000000000003ba4007f5c922fbb33c454b41ea7a1f11e83df2c
</code></pre>
<p>Verify <code>sourceHash</code>:</p>
<pre><code class="language-bash">cast keccak $(cast concat-hex 0x0000000000000000000000000000000000000000000000000000000000000002 $(cast keccak "Jovian: L1Block Proxy Update"))
# 0x08447273a4fbce97bc8c515f97ac74efc461f6a4001553712f31ebc11288bad2
</code></pre>
<h3 id="gaspriceoracle-deployment-3"><a class="header" href="#gaspriceoracle-deployment-3">GasPriceOracle Deployment</a></h3>
<!-- Generated with: ./scripts/run_gen_predeploy_docs.sh --optimism-repo-path ../../optimism \
--fork-name Jovian \
--contract-name GasPriceOracle \
--from-address 0x4210000000000000000000000000000000000007 \
--from-address-nonce 0 \
--git-commit-hash 773798a67678ab28c3ef7ee3405f25c04616af19 \
--eth-rpc-url https://optimism.rpc.subquery.network/public \
--proxy-address 0x420000000000000000000000000000000000000F \
--copy-contract-bytecode true -->
<p>The <code>GasPriceOracle</code> contract is deployed.</p>
<p>A deposit transaction is derived with the following attributes:</p>
<ul>
<li><code>from</code>: <code>0x4210000000000000000000000000000000000007</code></li>
<li><code>to</code>: <code>null</code></li>
<li><code>mint</code>: <code>0</code></li>
<li><code>value</code>: <code>0</code></li>
<li><code>nonce</code>: <code>0</code></li>
<li><code>gasLimit</code>: <code>1750714</code></li>
<li><code>data</code>: <code>0x0x608060405234801561001057600080...</code> (<a href="protocol/jovian/../../../specs/static/bytecode/jovian-gas-price-oracle-deployment.txt">full bytecode</a>)</li>
<li><code>sourceHash</code>: <code>0xd939cca6eca7bd0ee0c7e89f7e5b5cf7bf6f7afe7b6966bb45dfb95344b31545</code>,
computed with the "Upgrade-deposited" type, with <code>intent = "Jovian: GasPriceOracle Deployment"</code></li>
</ul>
<p>This results in the Jovian GasPriceOracle contract being deployed to
<code>0x4f1db3c6AbD250ba86E0928471A8F7DB3AFd88F1</code>, to verify:</p>
<pre><code class="language-bash">cast compute-address --nonce=0 0x4210000000000000000000000000000000000007
Computed Address: 0x4f1db3c6AbD250ba86E0928471A8F7DB3AFd88F1
</code></pre>
<p>Verify <code>sourceHash</code>:</p>
<pre><code class="language-bash">cast keccak $(cast concat-hex 0x0000000000000000000000000000000000000000000000000000000000000002 $(cast keccak "Jovian: GasPriceOracle Deployment"))
# 0xd939cca6eca7bd0ee0c7e89f7e5b5cf7bf6f7afe7b6966bb45dfb95344b31545
</code></pre>
<p>Verify <code>data</code>:</p>
<pre><code class="language-bash">git checkout 773798a67678ab28c3ef7ee3405f25c04616af19
make build-contracts
jq -r ".bytecode.object" packages/contracts-bedrock/forge-artifacts/GasPriceOracle.sol/GasPriceOracle.json
</code></pre>
<p>This transaction MUST deploy a contract with the following code hash
<code>0xe9fc7c96c4db0d6078e3d359d7e8c982c350a513cb2c31121adf5e1e8a446614</code>.</p>
<p>To verify the code hash:</p>
<pre><code class="language-bash">git checkout 773798a67678ab28c3ef7ee3405f25c04616af19
make build-contracts
cast k $(jq -r ".deployedBytecode.object" packages/contracts-bedrock/forge-artifacts/GasPriceOracle.sol/GasPriceOracle.json)
</code></pre>
<h3 id="gaspriceoracle-proxy-update-3"><a class="header" href="#gaspriceoracle-proxy-update-3">GasPriceOracle Proxy Update</a></h3>
<p>This transaction updates the GasPriceOracle Proxy ERC-1967
implementation slot to point to the new GasPriceOracle deployment.</p>
<p>A deposit transaction is derived with the following attributes:</p>
<ul>
<li><code>from</code>: <code>0x0000000000000000000000000000000000000000</code></li>
<li><code>to</code>: <code>0x420000000000000000000000000000000000000F</code> (GasPriceOracle Proxy)</li>
<li><code>mint</code>: <code>0</code></li>
<li><code>value</code>: <code>0</code></li>
<li><code>gasLimit</code>: <code>50,000</code></li>
<li><code>data</code>: <code>0x3659cfe60000000000000000000000004f1db3c6abd250ba86e0928471a8f7db3afd88f1</code></li>
<li><code>sourceHash</code>: <code>0x46b597e2d8346ed7749b46734074361e0b41a0ab9af7afda5bb4e367e072bcb8</code>
computed with the "Upgrade-deposited" type, with <code>intent = "Jovian: GasPriceOracle Proxy Update"</code></li>
</ul>
<p>Verify data:</p>
<pre><code class="language-bash">cast concat-hex $(cast sig "upgradeTo(address)") $(cast abi-encode "upgradeTo(address)" 0x4f1db3c6AbD250ba86E0928471A8F7DB3AFd88F1)
# 0x3659cfe60000000000000000000000004f1db3c6abd250ba86e0928471a8f7db3afd88f1
</code></pre>
<p>Verify <code>sourceHash</code>:</p>
<pre><code class="language-bash">cast keccak $(cast concat-hex 0x0000000000000000000000000000000000000000000000000000000000000002 $(cast keccak "Jovian: GasPriceOracle Proxy Update"))
# 0x46b597e2d8346ed7749b46734074361e0b41a0ab9af7afda5bb4e367e072bcb8
</code></pre>
<h3 id="gaspriceoracle-enable-jovian"><a class="header" href="#gaspriceoracle-enable-jovian">GasPriceOracle Enable Jovian</a></h3>
<p>This transaction informs the GasPriceOracle to start using the Jovian operator fee formula.</p>
<p>A deposit transaction is derived with the following attributes:</p>
<ul>
<li><code>from</code>: <code>0xDeaDDEaDDeAdDeAdDEAdDEaddeAddEAdDEAd0001</code> (Depositer Account)</li>
<li><code>to</code>: <code>0x420000000000000000000000000000000000000F</code> (Gas Price Oracle Proxy)</li>
<li><code>mint</code>: <code>0</code></li>
<li><code>value</code>: <code>0</code></li>
<li><code>gasLimit</code>: <code>90,000</code></li>
<li><code>data</code>: <code>0xb3d72079</code></li>
<li><code>sourceHash</code>: <code>0xe836db6a959371756f8941be3e962d000f7e12a32e49e2c9ca42ba177a92716c</code>,<br />
computed with the "Upgrade-deposited" type, with <code>intent = "Jovian: Gas Price Oracle Set Jovian"</code></li>
</ul>
<p>Verify data:</p>
<pre><code class="language-bash">cast sig "setJovian()"
# 0xb3d72079
</code></pre>
<p>Verify <code>sourceHash</code>:</p>
<pre><code class="language-bash">cast keccak $(cast concat-hex 0x0000000000000000000000000000000000000000000000000000000000000002 $(cast keccak "Jovian: Gas Price Oracle Set Jovian"))
# 0xe836db6a959371756f8941be3e962d000f7e12a32e49e2c9ca42ba177a92716c
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="l1-block-attributes-1"><a class="header" href="#l1-block-attributes-1">L1 Block Attributes</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/jovian/l1-attributes.html#overview">Overview</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-36"><a class="header" href="#overview-36">Overview</a></h2>
<p>The L1 block attributes transaction is updated to include the DA footprint gas scalar.</p>
<div class="table-wrapper"><table><thead><tr><th>Input arg</th><th>Type</th><th>Calldata bytes</th><th>Segment</th></tr></thead><tbody>
<tr><td>{0x3db6be2b}</td><td></td><td>0-3</td><td>n/a</td></tr>
<tr><td>baseFeeScalar</td><td>uint32</td><td>4-7</td><td>1</td></tr>
<tr><td>blobBaseFeeScalar</td><td>uint32</td><td>8-11</td><td></td></tr>
<tr><td>sequenceNumber</td><td>uint64</td><td>12-19</td><td></td></tr>
<tr><td>l1BlockTimestamp</td><td>uint64</td><td>20-27</td><td></td></tr>
<tr><td>l1BlockNumber</td><td>uint64</td><td>28-35</td><td></td></tr>
<tr><td>basefee</td><td>uint256</td><td>36-67</td><td>2</td></tr>
<tr><td>blobBaseFee</td><td>uint256</td><td>68-99</td><td>3</td></tr>
<tr><td>l1BlockHash</td><td>bytes32</td><td>100-131</td><td>4</td></tr>
<tr><td>batcherHash</td><td>bytes32</td><td>132-163</td><td>5</td></tr>
<tr><td>operatorFeeScalar</td><td>uint32</td><td>164-167</td><td>6</td></tr>
<tr><td>operatorFeeConstant</td><td>uint64</td><td>168-175</td><td></td></tr>
<tr><td>daFootprintGasScalar</td><td>uint16</td><td>176-177</td><td></td></tr>
</tbody></table>
</div>
<p>Note that the first input argument, in the same pattern as previous versions of the L1 attributes transaction,
is the function selector: the first four bytes of <code>keccak256("setL1BlockValuesJovian()")</code>.</p>
<p>In the activation block, there are two possibilities:</p>
<ul>
<li>If Jovian is active at genesis, there are no transactions in the activation block
and therefore no L1 Block Attributes transaction to consider.</li>
<li>If Jovian activates after genesis <a href="protocol/jovian/../isthmus/l1-attributes.html"><code>setL1BlockValuesIsthmus()</code></a> method must be used.
This is because the L1 Block contract will not yet have been upgraded.</li>
</ul>
<p>In each subsequent L2 block, the <code>setL1BlockValuesJovian()</code> method must be used.</p>
<p>When using this method, the pre-Jovian values are migrated over 1:1
and the transaction also sets <code>daFootprintGasScalar</code> to the
value from the <a href="protocol/jovian/./system-config.html"><code>SystemConfig</code></a>. If that value is <code>0</code>, then a default of <code>400</code> is set.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="jovian-system-config"><a class="header" href="#jovian-system-config">Jovian: System Config</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="protocol/jovian/system-config.html#minimum-base-fee-configuration">Minimum Base Fee Configuration</a>
<ul>
<li><a href="protocol/jovian/system-config.html#configupdate"><code>ConfigUpdate</code></a></li>
<li><a href="protocol/jovian/system-config.html#initialization">Initialization</a></li>
<li><a href="protocol/jovian/system-config.html#modifying-minimum-base-fee">Modifying Minimum Base Fee</a></li>
<li><a href="protocol/jovian/system-config.html#interface">Interface</a>
<ul>
<li><a href="protocol/jovian/system-config.html#minimum-base-fee-parameters">Minimum Base Fee Parameters</a>
<ul>
<li><a href="protocol/jovian/system-config.html#minbasefee"><code>minBaseFee</code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="protocol/jovian/system-config.html#da-footprint-configuration">DA Footprint Configuration</a>
<ul>
<li><a href="protocol/jovian/system-config.html#configupdate-1"><code>ConfigUpdate</code></a></li>
<li><a href="protocol/jovian/system-config.html#modifying-da-footprint-gas-scalar">Modifying DA Footprint Gas Scalar</a></li>
<li><a href="protocol/jovian/system-config.html#interface-1">Interface</a>
<ul>
<li><a href="protocol/jovian/system-config.html#da-footprint-gas-scalar-parameters">DA Footprint Gas Scalar Parameters</a>
<ul>
<li><a href="protocol/jovian/system-config.html#dafootprintgasscalar"><code>daFootprintGasScalar</code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="minimum-base-fee-configuration"><a class="header" href="#minimum-base-fee-configuration">Minimum Base Fee Configuration</a></h2>
<p>Jovian adds a configuration value to <code>SystemConfig</code> to control the minimum base fee used by the EIP-1559 fee market
on OP Stack chains. The value is a minimum base fee in wei.</p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Default</th><th>Meaning</th></tr></thead><tbody>
<tr><td><code>minBaseFee</code></td><td><code>uint64</code></td><td><code>0</code></td><td>Minimum base fee in wei</td></tr>
</tbody></table>
</div>
<p>The configuration is updated via a new method on <code>SystemConfig</code>:</p>
<pre><code class="language-solidity">function setMinBaseFee(uint64 minBaseFee) external onlyOwner;
</code></pre>
<h3 id="configupdate-2"><a class="header" href="#configupdate-2"><code>ConfigUpdate</code></a></h3>
<p>When the configuration is updated, a <a href="protocol/jovian/../system-config.html#system-config-updates"><code>ConfigUpdate</code></a> event
MUST be emitted with the following parameters:</p>
<div class="table-wrapper"><table><thead><tr><th><code>version</code></th><th><code>updateType</code></th><th><code>data</code></th><th>Usage</th></tr></thead><tbody>
<tr><td><code>uint256(0)</code></td><td><code>uint8(6)</code></td><td><code>abi.encode(uint64(_minBaseFee))</code></td><td>Modifies the minimum base fee (wei)</td></tr>
</tbody></table>
</div>
<h3 id="initialization-2"><a class="header" href="#initialization-2">Initialization</a></h3>
<p>The following actions should happen during the initialization of the <code>SystemConfig</code>:</p>
<ul>
<li><code>emit ConfigUpdate.BATCHER</code></li>
<li><code>emit ConfigUpdate.FEE_SCALARS</code></li>
<li><code>emit ConfigUpdate.GAS_LIMIT</code></li>
<li><code>emit ConfigUpdate.UNSAFE_BLOCK_SIGNER</code></li>
</ul>
<p>Intentionally absent from this is <code>emit ConfigUpdate.EIP_1559_PARAMS</code> and <code>emit ConfigUpdate.MIN_BASE_FEE</code>.
As long as these values are unset, the default values will be used.
Requiring these parameters to be set during initialization would add a strict requirement
that the L2 hardforks before the L1 contracts are upgraded, and this is complicated to manage in a
world of many chains.</p>
<h3 id="modifying-minimum-base-fee"><a class="header" href="#modifying-minimum-base-fee">Modifying Minimum Base Fee</a></h3>
<p>Upon update, the contract emits the <code>ConfigUpdate</code> event above, enabling nodes
to derive the configuration from L1 logs.</p>
<p>Implementations MUST incorporate the configured value into the block header <code>extraData</code> as specified in
<code>./exec-engine.md</code>. Until the first such event is emitted, a default value of <code>0</code> should be used.</p>
<h3 id="interface-4"><a class="header" href="#interface-4">Interface</a></h3>
<h4 id="minimum-base-fee-parameters"><a class="header" href="#minimum-base-fee-parameters">Minimum Base Fee Parameters</a></h4>
<h5 id="minbasefee"><a class="header" href="#minbasefee"><code>minBaseFee</code></a></h5>
<p>This function returns the currently configured minimum base fee in wei.</p>
<pre><code class="language-solidity">function minBaseFee() external view returns (uint64);
</code></pre>
<h2 id="da-footprint-configuration"><a class="header" href="#da-footprint-configuration">DA Footprint Configuration</a></h2>
<p>Jovian adds a <code>uint16</code> configuration value to <code>SystemConfig</code> to control the <a href="protocol/jovian/./derivation.html"><code>daFootprintGasScalar</code></a>.</p>
<p>The configuration is updated via a new method on <code>SystemConfig</code>:</p>
<pre><code class="language-solidity">function setDAFootprintGasScalar(uint16 daFootprintGasScalar) external onlyOwner;
</code></pre>
<h3 id="configupdate-3"><a class="header" href="#configupdate-3"><code>ConfigUpdate</code></a></h3>
<p>When the configuration is updated, a <a href="protocol/jovian/../system-config.html#system-config-updates"><code>ConfigUpdate</code></a> event
MUST be emitted with the following parameters:</p>
<div class="table-wrapper"><table><thead><tr><th><code>version</code></th><th><code>updateType</code></th><th><code>data</code></th><th>Usage</th></tr></thead><tbody>
<tr><td><code>uint256(0)</code></td><td><code>uint8(7)</code></td><td><code>abi.encode(uint16(_daFootprintGasScalar))</code></td><td>Modifies the DA footprint gas scalar</td></tr>
</tbody></table>
</div>
<h3 id="modifying-da-footprint-gas-scalar"><a class="header" href="#modifying-da-footprint-gas-scalar">Modifying DA Footprint Gas Scalar</a></h3>
<p>Upon update, the contract emits the <code>ConfigUpdate</code> event above, enabling nodes
to derive the configuration from L1 logs.</p>
<h3 id="interface-5"><a class="header" href="#interface-5">Interface</a></h3>
<h4 id="da-footprint-gas-scalar-parameters"><a class="header" href="#da-footprint-gas-scalar-parameters">DA Footprint Gas Scalar Parameters</a></h4>
<h5 id="dafootprintgasscalar"><a class="header" href="#dafootprintgasscalar"><code>daFootprintGasScalar</code></a></h5>
<p>This function returns the currently configured DA footprint gas scalar.</p>
<pre><code class="language-solidity">function daFootprintGasScalar() external view returns (uint16);
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="governance-token-2"><a class="header" href="#governance-token-2">Governance Token</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="governance/gov-token.html#overview">Overview</a>
<ul>
<li><a href="governance/gov-token.html#token-minting">Token Minting</a></li>
<li><a href="governance/gov-token.html#token-burning">Token Burning</a></li>
<li><a href="governance/gov-token.html#voting-power">Voting Power</a>
<ul>
<li><a href="governance/gov-token.html#public-query-functions">Public Query Functions</a></li>
</ul>
</li>
<li><a href="governance/gov-token.html#delegation">Delegation</a>
<ul>
<li><a href="governance/gov-token.html#basic-delegation">Basic Delegation</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-37"><a class="header" href="#overview-37">Overview</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Constants</th><th>Value</th></tr></thead><tbody>
<tr><td>Address</td><td><code>0x4200000000000000000000000000000000000042</code></td></tr>
<tr><td>Token name</td><td><code>Optimism</code></td></tr>
<tr><td>Token symbol</td><td><code>OP</code></td></tr>
<tr><td>Token decimals</td><td><code>18</code></td></tr>
</tbody></table>
</div>
<p><code>GovernanceToken</code> is an <a href="https://eips.ethereum.org/EIPS/eip-20">ERC20</a> token contract that inherits from <code>ERC20Burnable</code>,
<code>ERC20Votes</code>, and <code>Ownable</code>. It allows token holders to delegate their voting power to other addresses, enabling a representative
voting system. The <code>GovernanceToken</code> currently only supports basic delegation whereby a user can delegate its entire token
balance to a specific address for voting and votes cannot be re-delegated.</p>
<h3 id="token-minting"><a class="header" href="#token-minting">Token Minting</a></h3>
<p><code>GovernanceToken</code> MUST have a <code>mint(address,uint256)</code> function with external visibility that allows the <code>owner()</code> address
to mint an arbitrary number of new tokens to a specific address. This function MUST only be called by the contract
owner, the <code>MintManager</code>, as enforced by the <code>onlyOwner</code> modifier inherited from the <code>Ownable</code> contract.</p>
<h3 id="token-burning"><a class="header" href="#token-burning">Token Burning</a></h3>
<p>The contract MUST allow token holders to burn their own tokens using the inherited <code>burn(uint256)</code> or
<code>burnFrom(address,uint256)</code> functions inherited from <code>ERC20Burnable</code>. Burn functions MUST NOT allow a user's balance to
underflow and attempts to reduce balance below zero MUST revert.</p>
<h3 id="voting-power"><a class="header" href="#voting-power">Voting Power</a></h3>
<p>Each token corresponds to one unit of voting power. Token holders who wish to utilize their tokens for voting MUST delegate
their voting power to an address (can be their own address). An active delegation MUST NOT prevent a user from transferring
tokens. The <code>GovernanceToken</code> contract MUST offer public accessor functions for querying voting power, as outlined below.</p>
<h4 id="public-query-functions"><a class="header" href="#public-query-functions">Public Query Functions</a></h4>
<ul>
<li><code>checkpoints(address,uint32) returns (Checkpoint)</code>
<ul>
<li>MUST retrieve the n-th Checkpoint for a given address.</li>
</ul>
</li>
<li><code>numCheckpoints(address) returns (uint32)</code>
<ul>
<li>MUST retrieve the total number of Checkpoint objects for a given address.</li>
</ul>
</li>
<li><code>delegates(address) returns (address)</code>
<ul>
<li>MUST retrieve the address that an account is delegating to.</li>
</ul>
</li>
<li><code>getVotes() returns (uint256)</code>
<ul>
<li>MUST retrieve the current voting power of an address.</li>
</ul>
</li>
<li><code>getPastVotes(address,uint256) returns (uint256)</code>
<ul>
<li>MUST retrieve the voting power of an address at specific block number in the past.</li>
</ul>
</li>
<li><code>getPastTotalSupply(uint256) returns (uint256)</code>
<ul>
<li>MUST return the total token supply at a specific block number in the past.</li>
</ul>
</li>
</ul>
<h3 id="delegation"><a class="header" href="#delegation">Delegation</a></h3>
<h4 id="basic-delegation"><a class="header" href="#basic-delegation">Basic Delegation</a></h4>
<p>Vote power can be delegated either by calling the <code>delegate(address)</code> function directly (to delegate as the <code>msg.sender</code>)
or by providing a signature to be used with function <code>delegateBySig(address,uint256,uint256,uint8,bytes32,bytes32)</code>,
as inherited from <code>ERC20Votes</code>. Delegation through these functions is considered "basic delegation" as these functions will
delegate the entirety of the user's available balance to the target address. Delegations cannot be re-delegated to another
address.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="mintmanager"><a class="header" href="#mintmanager">MintManager</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="governance/mint-manager.html#overview">Overview</a></li>
<li><a href="governance/mint-manager.html#definitions">Definitions</a>
<ul>
<li><a href="governance/mint-manager.html#mint-cap">Mint Cap</a></li>
<li><a href="governance/mint-manager.html#mint-period">Mint Period</a></li>
</ul>
</li>
<li><a href="governance/mint-manager.html#assumptions">Assumptions</a>
<ul>
<li><a href="governance/mint-manager.html#amm-001-governancetoken-implements-required-functions-correctly">aMM-001: GovernanceToken implements required functions correctly</a>
<ul>
<li><a href="governance/mint-manager.html#mitigations">Mitigations</a></li>
</ul>
</li>
<li><a href="governance/mint-manager.html#amm-002-block-timestamp-reliability">aMM-002: Block timestamp reliability</a>
<ul>
<li><a href="governance/mint-manager.html#mitigations-1">Mitigations</a></li>
</ul>
</li>
<li><a href="governance/mint-manager.html#amm-003-owner-acts-within-governance-constraints">aMM-003: Owner acts within governance constraints</a>
<ul>
<li><a href="governance/mint-manager.html#mitigations-2">Mitigations</a></li>
</ul>
</li>
<li><a href="governance/mint-manager.html#amm-004-valid-successor-mintmanager">aMM-004: Valid successor MintManager</a>
<ul>
<li><a href="governance/mint-manager.html#mitigations-3">Mitigations</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="governance/mint-manager.html#dependencies">Dependencies</a></li>
<li><a href="governance/mint-manager.html#invariants">Invariants</a>
<ul>
<li><a href="governance/mint-manager.html#imm-001-mint-cap-enforcement">iMM-001: Mint cap enforcement</a>
<ul>
<li><a href="governance/mint-manager.html#impact">Impact</a></li>
</ul>
</li>
<li><a href="governance/mint-manager.html#imm-002-time-based-minting-restriction">iMM-002: Time-based minting restriction</a>
<ul>
<li><a href="governance/mint-manager.html#impact-1">Impact</a></li>
</ul>
</li>
<li><a href="governance/mint-manager.html#imm-003-exclusive-minting-authority">iMM-003: Exclusive minting authority</a>
<ul>
<li><a href="governance/mint-manager.html#impact-2">Impact</a></li>
</ul>
</li>
<li><a href="governance/mint-manager.html#imm-004-ownership-transfer-control">iMM-004: Ownership transfer control</a>
<ul>
<li><a href="governance/mint-manager.html#impact-3">Impact</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="governance/mint-manager.html#function-specifications">Function Specifications</a>
<ul>
<li><a href="governance/mint-manager.html#constructor">constructor</a></li>
<li><a href="governance/mint-manager.html#mint">mint</a></li>
<li><a href="governance/mint-manager.html#upgrade">upgrade</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-38"><a class="header" href="#overview-38">Overview</a></h2>
<p>The <code>MintManager</code> contract serves as the owner of the <a href="governance/./gov-token.html">GovernanceToken</a> and controls the token
inflation schedule. It enforces rate-limited minting with a maximum cap per minting operation and a minimum time
period between mints. The contract is upgradeable, allowing the owner to transfer control to a new <code>MintManager</code>
implementation if changes to the inflation schedule are required.</p>
<h2 id="definitions-6"><a class="header" href="#definitions-6">Definitions</a></h2>
<h3 id="mint-cap"><a class="header" href="#mint-cap">Mint Cap</a></h3>
<p>The maximum percentage of the total token supply that can be minted in a single minting operation. Set to 2%
(represented as 20/1000 with 4 decimal precision).</p>
<h3 id="mint-period"><a class="header" href="#mint-period">Mint Period</a></h3>
<p>The minimum time interval that must elapse between consecutive minting operations. Set to 365 days.</p>
<h2 id="assumptions-3"><a class="header" href="#assumptions-3">Assumptions</a></h2>
<h3 id="amm-001-governancetoken-implements-required-functions-correctly"><a class="header" href="#amm-001-governancetoken-implements-required-functions-correctly">aMM-001: GovernanceToken implements required functions correctly</a></h3>
<p>The <code>GovernanceToken</code> contract correctly implements the <code>mint(address,uint256)</code> function, <code>transferOwnership(address)</code>
function, and <code>totalSupply()</code> view function according to their expected behavior. Specifically:</p>
<ul>
<li><code>mint()</code> increases the token balance of the specified account by the specified amount</li>
<li><code>totalSupply()</code> accurately returns the current total supply of tokens</li>
<li><code>transferOwnership()</code> transfers ownership to the specified address</li>
</ul>
<h4 id="mitigations-18"><a class="header" href="#mitigations-18">Mitigations</a></h4>
<ul>
<li>The <code>GovernanceToken</code> contract is part of the same protocol and is subject to the same security audits</li>
<li>The interface is well-defined in <code>IGovernanceToken.sol</code></li>
<li>The implementation follows OpenZeppelin's standard patterns</li>
</ul>
<h3 id="amm-002-block-timestamp-reliability"><a class="header" href="#amm-002-block-timestamp-reliability">aMM-002: Block timestamp reliability</a></h3>
<p>The EVM <code>block.timestamp</code> value is sufficiently reliable for enforcing the 365-day minting period. While miners can
manipulate timestamps within a small range (~15 seconds), this manipulation is negligible compared to the 365-day
period.</p>
<h4 id="mitigations-19"><a class="header" href="#mitigations-19">Mitigations</a></h4>
<ul>
<li>The 365-day period is long enough that minor timestamp manipulation has no practical impact</li>
<li>Ethereum consensus rules limit timestamp manipulation</li>
<li>The time-based restriction is a rate limit, not a precise scheduling mechanism</li>
</ul>
<h3 id="amm-003-owner-acts-within-governance-constraints"><a class="header" href="#amm-003-owner-acts-within-governance-constraints">aMM-003: Owner acts within governance constraints</a></h3>
<p>The contract owner (typically a governance multisig or DAO) will only call <code>mint()</code> and <code>upgrade()</code> functions in
accordance with governance decisions and the protocol's established rules. The owner will not abuse their authority
to mint excessive tokens or transfer ownership to malicious addresses.</p>
<h4 id="mitigations-20"><a class="header" href="#mitigations-20">Mitigations</a></h4>
<ul>
<li>Owner is expected to be a governance-controlled address (e.g., multisig or Governor contract)</li>
<li>All minting operations are subject to the on-chain mint cap and time restrictions</li>
<li>Ownership transfers are transparent on-chain and subject to community oversight</li>
<li>The upgrade mechanism allows for replacing a compromised or malicious owner</li>
</ul>
<h3 id="amm-004-valid-successor-mintmanager"><a class="header" href="#amm-004-valid-successor-mintmanager">aMM-004: Valid successor MintManager</a></h3>
<p>When upgrading, the owner will provide a valid, non-zero address for the new <code>MintManager</code> contract. The successor
contract will be properly implemented and tested before the upgrade is executed.</p>
<h4 id="mitigations-21"><a class="header" href="#mitigations-21">Mitigations</a></h4>
<ul>
<li>Governance processes include review and testing of new MintManager implementations</li>
<li>The upgrade transaction is subject to governance approval and timelock mechanisms</li>
<li>The contract enforces a basic check that the successor address is not the zero address</li>
</ul>
<h2 id="dependencies-11"><a class="header" href="#dependencies-11">Dependencies</a></h2>
<p>This specification depends on:</p>
<ul>
<li><a href="governance/./gov-token.html">GovernanceToken</a> - The ERC20Votes token that this contract has permission to mint</li>
</ul>
<h2 id="invariants-5"><a class="header" href="#invariants-5">Invariants</a></h2>
<h3 id="imm-001-mint-cap-enforcement"><a class="header" href="#imm-001-mint-cap-enforcement">iMM-001: Mint cap enforcement</a></h3>
<p>No single minting operation can mint more than the <a href="governance/mint-manager.html#mint-cap">Mint Cap</a> of the current total token supply.</p>
<p><strong>Full Description:</strong>
Any call to <code>mint()</code> MUST enforce that the requested mint amount does not exceed the <a href="governance/mint-manager.html#mint-cap">Mint Cap</a>. This
ensures that token inflation is bounded and predictable.</p>
<h4 id="impact-19"><a class="header" href="#impact-19">Impact</a></h4>
<p><strong>Severity: Medium</strong></p>
<p>If this invariant is violated, the owner could mint an unlimited number of tokens, leading to:</p>
<ul>
<li>Severe token dilution for existing holders</li>
<li>Loss of governance voting power for existing token holders</li>
<li>Destruction of the token's economic value</li>
<li>Complete loss of trust in the protocol's governance system</li>
</ul>
<p>Note: This is rated Medium because it requires assumption aMM-003 (owner acts within governance constraints) to fail.
If aMM-003 does not hold (i.e., the owner is malicious or compromised), this would be elevated to Critical severity.
The contract enforces this invariant on-chain, providing defense-in-depth against governance failures.</p>
<h3 id="imm-002-time-based-minting-restriction"><a class="header" href="#imm-002-time-based-minting-restriction">iMM-002: Time-based minting restriction</a></h3>
<p>Minting operations can only occur after the <a href="governance/mint-manager.html#mint-period">Mint Period</a> has elapsed since the previous mint.</p>
<p><strong>Full Description:</strong>
Any call to <code>mint()</code> MUST revert if the <a href="governance/mint-manager.html#mint-period">Mint Period</a> has not elapsed since the last mint. This ensures
that minting operations are rate-limited, preventing rapid inflation even if the owner attempts multiple mints.</p>
<h4 id="impact-20"><a class="header" href="#impact-20">Impact</a></h4>
<p><strong>Severity: Medium</strong></p>
<p>If this invariant is violated, the owner could:</p>
<ul>
<li>Mint the <a href="governance/mint-manager.html#mint-cap">Mint Cap</a> multiple times in rapid succession</li>
<li>Cause uncontrolled inflation far exceeding the intended rate</li>
<li>Undermine the predictability and transparency of the token supply schedule</li>
<li>Violate the expectations of token holders regarding inflation rates</li>
</ul>
<p>Note: This is rated Medium because it requires assumption aMM-003 (owner acts within governance constraints) to fail.
If aMM-003 does not hold (i.e., the owner is malicious or compromised), this would be elevated to Critical severity.
The contract enforces this invariant on-chain, providing defense-in-depth against governance failures.</p>
<h3 id="imm-003-exclusive-minting-authority"><a class="header" href="#imm-003-exclusive-minting-authority">iMM-003: Exclusive minting authority</a></h3>
<p>Only the contract owner can successfully call the <code>mint()</code> function to create new governance tokens.</p>
<p><strong>Full Description:</strong>
The <code>mint()</code> function MUST be protected by the <code>onlyOwner</code> modifier, ensuring that only the address returned by
<code>owner()</code> can execute minting operations. Any call from a non-owner address MUST revert.</p>
<h4 id="impact-21"><a class="header" href="#impact-21">Impact</a></h4>
<p><strong>Severity: Critical</strong></p>
<p>If this invariant is violated:</p>
<ul>
<li>Unauthorized parties could mint tokens without governance approval</li>
<li>The entire governance system would be compromised</li>
<li>Token supply would become unpredictable and uncontrolled</li>
<li>The economic security of the protocol would be destroyed</li>
</ul>
<h3 id="imm-004-ownership-transfer-control"><a class="header" href="#imm-004-ownership-transfer-control">iMM-004: Ownership transfer control</a></h3>
<p>Only the current contract owner can transfer ownership of the GovernanceToken to a new MintManager.</p>
<p><strong>Full Description:</strong>
The <code>upgrade()</code> function MUST be protected by the <code>onlyOwner</code> modifier, ensuring that only the current owner can
initiate an upgrade to a new <code>MintManager</code> implementation. This prevents unauthorized parties from taking control of
the token minting authority.</p>
<h4 id="impact-22"><a class="header" href="#impact-22">Impact</a></h4>
<p><strong>Severity: Critical</strong></p>
<p>If this invariant is violated:</p>
<ul>
<li>Attackers could transfer ownership to a malicious contract</li>
<li>The governance system would lose control over token minting</li>
<li>A malicious MintManager could mint unlimited tokens or implement harmful policies</li>
<li>The protocol's governance would be permanently compromised</li>
</ul>
<h2 id="function-specifications"><a class="header" href="#function-specifications">Function Specifications</a></h2>
<h3 id="constructor-3"><a class="header" href="#constructor-3">constructor</a></h3>
<pre><code class="language-solidity">constructor(address _upgrader, address _governanceToken)
</code></pre>
<p>Initializes the <code>MintManager</code> contract with the specified owner and governance token.</p>
<p><strong>Parameters:</strong></p>
<ul>
<li><code>_upgrader</code>: The address that will become the owner of this contract</li>
<li><code>_governanceToken</code>: The address of the <code>GovernanceToken</code> contract that this manager will control</li>
</ul>
<p><strong>Behavior:</strong></p>
<ul>
<li>MUST call <code>transferOwnership(_upgrader)</code> to set the contract owner</li>
<li>MUST set <code>governanceToken</code> to the provided <code>_governanceToken</code> address</li>
<li>MUST initialize <code>mintPermittedAfter</code> to enable immediate first mint while enforcing restrictions on subsequent mints</li>
<li>MUST NOT validate that <code>_upgrader</code> or <code>_governanceToken</code> are non-zero addresses (caller responsibility)</li>
</ul>
<h3 id="mint"><a class="header" href="#mint">mint</a></h3>
<pre><code class="language-solidity">function mint(address _account, uint256 _amount) public onlyOwner
</code></pre>
<p>Mints new governance tokens to the specified account, subject to time and cap restrictions.</p>
<p><strong>Parameters:</strong></p>
<ul>
<li><code>_account</code>: The address that will receive the newly minted tokens</li>
<li><code>_amount</code>: The number of tokens to mint (in wei, with 18 decimals)</li>
</ul>
<p><strong>Behavior:</strong></p>
<ul>
<li>MUST revert if caller is not the contract owner (enforced by <code>onlyOwner</code> modifier)</li>
<li>MUST revert if the <a href="governance/mint-manager.html#mint-period">Mint Period</a> has not elapsed since the last mint</li>
<li>MUST revert if <code>_amount</code> exceeds the <a href="governance/mint-manager.html#mint-cap">Mint Cap</a></li>
<li>MUST set <code>mintPermittedAfter</code> to <code>block.timestamp + MINT_PERIOD</code> to enforce the next <a href="governance/mint-manager.html#mint-period">Mint Period</a></li>
<li>MUST call <code>governanceToken.mint(_account, _amount)</code> to perform the actual minting</li>
</ul>
<h3 id="upgrade-2"><a class="header" href="#upgrade-2">upgrade</a></h3>
<pre><code class="language-solidity">function upgrade(address _newMintManager) public onlyOwner
</code></pre>
<p>Transfers ownership of the <code>GovernanceToken</code> to a new <code>MintManager</code> contract, effectively upgrading the minting system.</p>
<p><strong>Parameters:</strong></p>
<ul>
<li><code>_newMintManager</code>: The address of the new <code>MintManager</code> contract that will become the owner of the <code>GovernanceToken</code></li>
</ul>
<p><strong>Behavior:</strong></p>
<ul>
<li>MUST revert if caller is not the contract owner (enforced by <code>onlyOwner</code> modifier)</li>
<li>MUST revert if <code>_newMintManager == address(0)</code></li>
<li>MUST call <code>governanceToken.transferOwnership(_newMintManager)</code> to transfer ownership</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="standard-l2-genesis"><a class="header" href="#standard-l2-genesis">Standard L2 Genesis</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="experimental/standard-l2-genesis.html#overview">Overview</a></li>
<li><a href="experimental/standard-l2-genesis.html#chain-constants-on-l1">Chain Constants on L1</a>
<ul>
<li><a href="experimental/standard-l2-genesis.html#configtype"><code>ConfigType</code></a></li>
</ul>
</li>
<li><a href="experimental/standard-l2-genesis.html#systemconfig"><code>SystemConfig</code></a>
<ul>
<li><a href="experimental/standard-l2-genesis.html#configupdate"><code>ConfigUpdate</code></a></li>
<li><a href="experimental/standard-l2-genesis.html#initialization">Initialization</a></li>
<li><a href="experimental/standard-l2-genesis.html#interface">Interface</a>
<ul>
<li><a href="experimental/standard-l2-genesis.html#fee-vault-config">Fee Vault Config</a>
<ul>
<li><a href="experimental/standard-l2-genesis.html#setbasefeevaultconfig"><code>setBaseFeeVaultConfig</code></a></li>
<li><a href="experimental/standard-l2-genesis.html#setl1feevaultconfig"><code>setL1FeeVaultConfig</code></a></li>
<li><a href="experimental/standard-l2-genesis.html#setsequencerfeevaultconfig"><code>setSequencerFeeVaultConfig</code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="experimental/standard-l2-genesis.html#optimismportal"><code>OptimismPortal</code></a>
<ul>
<li><a href="experimental/standard-l2-genesis.html#interface-1">Interface</a>
<ul>
<li><a href="experimental/standard-l2-genesis.html#setconfig"><code>setConfig</code></a></li>
<li><a href="experimental/standard-l2-genesis.html#upgrade"><code>upgrade</code></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="experimental/standard-l2-genesis.html#superchainconfig">SuperchainConfig</a>
<ul>
<li><a href="experimental/standard-l2-genesis.html#superchainconfig-constants">SuperchainConfig Constants</a></li>
<li><a href="experimental/standard-l2-genesis.html#interface-2">Interface</a></li>
<li><a href="experimental/standard-l2-genesis.html#initialization-1">Initialization</a></li>
</ul>
</li>
<li><a href="experimental/standard-l2-genesis.html#deterministic-genesis-state">Deterministic genesis state</a></li>
<li><a href="experimental/standard-l2-genesis.html#chain-constants-on-l2">Chain Constants on L2</a></li>
<li><a href="experimental/standard-l2-genesis.html#predeploys">Predeploys</a>
<ul>
<li><a href="experimental/standard-l2-genesis.html#proxyadmin">ProxyAdmin</a>
<ul>
<li><a href="experimental/standard-l2-genesis.html#rationale">Rationale</a></li>
</ul>
</li>
<li><a href="experimental/standard-l2-genesis.html#l1block">L1Block</a>
<ul>
<li><a href="experimental/standard-l2-genesis.html#storage">Storage</a></li>
<li><a href="experimental/standard-l2-genesis.html#interface-3">Interface</a>
<ul>
<li><a href="experimental/standard-l2-genesis.html#setisthmus"><code>setIsthmus</code></a></li>
<li><a href="experimental/standard-l2-genesis.html#setconfig-1"><code>setConfig</code></a></li>
<li><a href="experimental/standard-l2-genesis.html#getconfig"><code>getConfig</code></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="experimental/standard-l2-genesis.html#feevault">FeeVault</a>
<ul>
<li><a href="experimental/standard-l2-genesis.html#interface-4">Interface</a>
<ul>
<li><a href="experimental/standard-l2-genesis.html#config"><code>config</code></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="experimental/standard-l2-genesis.html#l2crossdomainmessenger">L2CrossDomainMessenger</a>
<ul>
<li><a href="experimental/standard-l2-genesis.html#interface-5">Interface</a></li>
</ul>
</li>
<li><a href="experimental/standard-l2-genesis.html#l2erc721bridge">L2ERC721Bridge</a>
<ul>
<li><a href="experimental/standard-l2-genesis.html#interface-6">Interface</a></li>
</ul>
</li>
<li><a href="experimental/standard-l2-genesis.html#l2standardbridge">L2StandardBridge</a>
<ul>
<li><a href="experimental/standard-l2-genesis.html#interface-7">Interface</a></li>
</ul>
</li>
<li><a href="experimental/standard-l2-genesis.html#optimismmintableerc721factory">OptimismMintableERC721Factory</a></li>
</ul>
</li>
<li><a href="experimental/standard-l2-genesis.html#security-considerations">Security Considerations</a>
<ul>
<li><a href="experimental/standard-l2-genesis.html#governancetoken">GovernanceToken</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-39"><a class="header" href="#overview-39">Overview</a></h2>
<p>The <code>SystemConfig</code> and <code>OptimismPortal</code> are updated with a new flow for chain
configurability.</p>
<h2 id="chain-constants-on-l1"><a class="header" href="#chain-constants-on-l1">Chain Constants on L1</a></h2>
<h3 id="configtype"><a class="header" href="#configtype"><code>ConfigType</code></a></h3>
<p>The <code>ConfigType</code> enum represents configuration that can be modified.</p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Value</th><th>Description</th></tr></thead><tbody>
<tr><td><code>GAS_PAYING_TOKEN</code></td><td><code>uint8(0)</code></td><td>Modifies the gas paying token for the chain</td></tr>
<tr><td><code>BASE_FEE_VAULT_CONFIG</code></td><td><code>uint8(1)</code></td><td>Sets the Fee Vault Config for the <code>BaseFeeVault</code></td></tr>
<tr><td><code>L1_FEE_VAULT_CONFIG</code></td><td><code>uint8(2)</code></td><td>Sets the Fee Vault Config for the <code>L1FeeVault</code></td></tr>
<tr><td><code>SEQUENCER_FEE_VAULT_CONFIG</code></td><td><code>uint8(3)</code></td><td>Sets the Fee Vault Config for the <code>SequencerFeeVault</code></td></tr>
<tr><td><code>L1_CROSS_DOMAIN_MESSENGER_ADDRESS</code></td><td><code>uint8(4)</code></td><td>Sets the <code>L1CrossDomainMessenger</code> address</td></tr>
<tr><td><code>L1_ERC_721_BRIDGE_ADDRESS</code></td><td><code>uint8(5)</code></td><td>Sets the <code>L1ERC721Bridge</code> address</td></tr>
<tr><td><code>L1_STANDARD_BRIDGE_ADDRESS</code></td><td><code>uint8(6)</code></td><td>Sets the <code>L1StandardBridge</code> address</td></tr>
<tr><td><code>REMOTE_CHAIN_ID</code></td><td><code>uint8(7)</code></td><td>Sets the chain id of the base chain</td></tr>
</tbody></table>
</div>
<h2 id="systemconfig"><a class="header" href="#systemconfig"><code>SystemConfig</code></a></h2>
<h3 id="configupdate-4"><a class="header" href="#configupdate-4"><code>ConfigUpdate</code></a></h3>
<p>The following <code>ConfigUpdate</code> event is defined where the <code>CONFIG_VERSION</code> is <code>uint256(0)</code>:</p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Value</th><th>Definition</th><th>Usage</th></tr></thead><tbody>
<tr><td><code>BATCHER</code></td><td><code>uint8(0)</code></td><td><code>abi.encode(address)</code></td><td>Modifies the account that is authorized to progress the safe chain</td></tr>
<tr><td><code>FEE_SCALARS</code></td><td><code>uint8(1)</code></td><td><code>(uint256(0x01) &lt;&lt; 248) | (uint256(_blobbasefeeScalar) &lt;&lt; 32) | _basefeeScalar</code></td><td>Modifies the fee scalars</td></tr>
<tr><td><code>GAS_LIMIT</code></td><td><code>uint8(2)</code></td><td><code>abi.encode(uint64 _gasLimit)</code></td><td>Modifies the L2 gas limit</td></tr>
<tr><td><code>UNSAFE_BLOCK_SIGNER</code></td><td><code>uint8(3)</code></td><td><code>abi.encode(address)</code></td><td>Modifies the account that is authorized to progress the unsafe chain</td></tr>
<tr><td><code>EIP_1559_PARAMS</code></td><td><code>uint8(4)</code></td><td><code>uint256(uint64(uint32(_denominator))) &lt;&lt; 32 | uint64(uint32(_elasticity))</code></td><td>Modifies the EIP-1559 denominator and elasticity</td></tr>
</tbody></table>
</div>
<h3 id="initialization-3"><a class="header" href="#initialization-3">Initialization</a></h3>
<p>The following actions should happen during the initialization of the <code>SystemConfig</code>:</p>
<ul>
<li><code>emit ConfigUpdate.BATCHER</code></li>
<li><code>emit ConfigUpdate.FEE_SCALARS</code></li>
<li><code>emit ConfigUpdate.GAS_LIMIT</code></li>
<li><code>emit ConfigUpdate.UNSAFE_BLOCK_SIGNER</code></li>
<li><code>emit ConfigUpdate.EIP_1559_PARAMS</code></li>
<li><code>setConfig(SET_GAS_PAYING_TOKEN)</code></li>
<li><code>setConfig(SET_BASE_FEE_VAULT_CONFIG)</code></li>
<li><code>setConfig(SET_L1_FEE_VAULT_CONFIG)</code></li>
<li><code>setConfig(SET_SEQUENCER_FEE_VAULT_CONFIG)</code></li>
<li><code>setConfig(SET_L1_CROSS_DOMAIN_MESSENGER_ADDRESS)</code></li>
<li><code>setConfig(SET_L1_ERC_721_BRIDGE_ADDRESS)</code></li>
<li><code>setConfig(SET_L1_STANDARD_BRIDGE_ADDRESS)</code></li>
<li><code>setConfig(SET_REMOTE_CHAIN_ID)</code></li>
</ul>
<p>These actions MAY only be triggered if there is a diff to the value.</p>
<h3 id="interface-6"><a class="header" href="#interface-6">Interface</a></h3>
<h4 id="fee-vault-config"><a class="header" href="#fee-vault-config">Fee Vault Config</a></h4>
<p>For each <code>FeeVault</code>, there is a setter for its config. The arguments to the setter include
the <code>RECIPIENT</code>, the <code>MIN_WITHDRAWAL_AMOUNT</code> and the <code>WithdrawalNetwork</code>.
Each of these functions should be <code>public</code> and only callable by the chain governor.</p>
<p>Each function calls <code>OptimismPortal.setConfig(ConfigType,bytes)</code> with its corresponding <code>ConfigType</code>.</p>
<h5 id="setbasefeevaultconfig"><a class="header" href="#setbasefeevaultconfig"><code>setBaseFeeVaultConfig</code></a></h5>
<pre><code class="language-solidity">function setBaseFeeVaultConfig(address,uint256,WithdrawalNetwork)
</code></pre>
<h5 id="setl1feevaultconfig"><a class="header" href="#setl1feevaultconfig"><code>setL1FeeVaultConfig</code></a></h5>
<pre><code class="language-solidity">function setL1FeeVaultConfig(address,uint256,WithdrawalNetwork)
</code></pre>
<h5 id="setsequencerfeevaultconfig"><a class="header" href="#setsequencerfeevaultconfig"><code>setSequencerFeeVaultConfig</code></a></h5>
<pre><code class="language-solidity">function setSequencerFeeVaultConfig(address,uint256,WithdrawalNetwork)
</code></pre>
<h2 id="optimismportal-2"><a class="header" href="#optimismportal-2"><code>OptimismPortal</code></a></h2>
<p>The <code>OptimismPortal</code> is updated to emit a special system <code>TransactionDeposited</code> event.</p>
<h3 id="interface-7"><a class="header" href="#interface-7">Interface</a></h3>
<h4 id="setconfig"><a class="header" href="#setconfig"><code>setConfig</code></a></h4>
<p>The <code>setConfig</code> function MUST only be callable by the <code>SystemConfig</code>. This ensures that the <code>SystemConfig</code>
is the single source of truth for chain operator ownership.</p>
<pre><code class="language-solidity">function setConfig(ConfigType,bytes)
</code></pre>
<p>This function emits a <code>TransactionDeposited</code> event.</p>
<pre><code class="language-solidity">event TransactionDeposited(address indexed from, address indexed to, uint256 indexed version, bytes opaqueData);
</code></pre>
<p>The following fields are included:</p>
<ul>
<li><code>from</code> is the <code>DEPOSITOR_ACCOUNT</code></li>
<li><code>to</code> is <code>Predeploys.L1Block</code></li>
<li><code>version</code> is <code>uint256(0)</code></li>
<li><code>opaqueData</code> is the tightly packed transaction data where <code>mint</code> is <code>0</code>, <code>value</code> is <code>0</code>, the <code>gasLimit</code>
is <code>200_000</code>, <code>isCreation</code> is <code>false</code> and the <code>data</code> is <code>abi.encodeCall(L1Block.setConfig, (_type, _value))</code></li>
</ul>
<h4 id="upgrade-3"><a class="header" href="#upgrade-3"><code>upgrade</code></a></h4>
<p>The <code>upgrade</code> function MUST only be callable by the <code>UPGRADER</code> role as defined
in the <a href="experimental/standard-l2-genesis.html#superchainconfig"><code>SuperchainConfig</code></a>.</p>
<pre><code class="language-solidity">function upgrade(bytes memory _data) external
</code></pre>
<p>This function emits a <code>TransactionDeposited</code> event.</p>
<pre><code class="language-solidity">event TransactionDeposited(address indexed from, address indexed to, uint256 indexed version, bytes opaqueData);
</code></pre>
<p>The following fields are included:</p>
<ul>
<li><code>from</code> is the <code>DEPOSITOR_ACCOUNT</code></li>
<li><code>to</code> is <code>Predeploys.ProxyAdmin</code></li>
<li><code>version</code> is <code>uint256(0)</code></li>
<li><code>opaqueData</code> is the tightly packed transaction data where <code>mint</code> is <code>0</code>, <code>value</code> is <code>0</code>, the <code>gasLimit</code>
is <code>200_000</code>, <code>isCreation</code> is <code>false</code> and the <code>data</code> is the data passed into <code>upgrade</code>.</li>
</ul>
<h2 id="superchainconfig-3"><a class="header" href="#superchainconfig-3">SuperchainConfig</a></h2>
<p>The <code>SuperchainConfig</code> contract is updated with a new role that has the ability
to issue deposit transactions from the identity of the <code>DEPOSITOR_ACCOUNT</code>
that call the L2 <code>ProxyAdmin</code>.</p>
<h3 id="superchainconfig-constants"><a class="header" href="#superchainconfig-constants">SuperchainConfig Constants</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Value</th><th>Definition</th></tr></thead><tbody>
<tr><td><code>UPGRADER_SLOT</code></td><td><code>bytes32(uint256(keccak256("superchainConfig.upgrader")) - 1)</code></td><td>Account that can call the L2 <code>ProxyAdmin</code></td></tr>
</tbody></table>
</div>
<h3 id="interface-8"><a class="header" href="#interface-8">Interface</a></h3>
<pre><code class="language-solidity">function upgrader() public view returns (address)
</code></pre>
<h3 id="initialization-4"><a class="header" href="#initialization-4">Initialization</a></h3>
<p>The <code>upgrader</code> can only be set during initialization.</p>
<h2 id="deterministic-genesis-state"><a class="header" href="#deterministic-genesis-state">Deterministic genesis state</a></h2>
<p>This upgrade enables a deterministic L2 genesis state by moving all network
specific configuration out of the initial L2 genesis state. All network specific
configuration is sourced from deposit transactions during the initialization
of the <code>SystemConfig</code>.</p>
<h2 id="chain-constants-on-l2"><a class="header" href="#chain-constants-on-l2">Chain Constants on L2</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Value</th><th>Definition</th></tr></thead><tbody>
<tr><td><code>ConfigType</code></td><td><code>uint8</code></td><td>An enum representing the type of config being set</td></tr>
<tr><td><code>WithdrawalNetwork</code></td><td><code>uint8(0)</code> or <code>uint8(1)</code></td><td><code>0</code> means withdraw to L1, <code>1</code> means withdraw to L2</td></tr>
<tr><td><code>RECIPIENT</code></td><td><code>address</code></td><td>The account that will receive funds sent out of the <code>FeeVault</code></td></tr>
<tr><td><code>MIN_WITHDRAWAL_AMOUNT</code></td><td><code>uint256</code></td><td>The minimum amount of native asset held in the <code>FeeVault</code> before withdrawal is authorized</td></tr>
<tr><td>Fee Vault Config</td><td><code>bytes32</code></td><td><code>bytes32((WithdrawalNetwork &lt;&lt; 248) || uint256(uint88(MIN_WITHDRAWAL_AMOUNT)) || uint256(uint160(RECIPIENT)))</code></td></tr>
<tr><td><code>BASE_FEE_VAULT_CONFIG</code></td><td><code>bytes32(uint256(keccak256("opstack.basefeevaultconfig")) - 1)</code></td><td>The Fee Vault Config for the <code>BaseFeeVault</code></td></tr>
<tr><td><code>L1_FEE_VAULT_CONFIG</code></td><td><code>bytes32(uint256(keccak256("opstack.l1feevaultconfig")) - 1)</code></td><td>The Fee Vault Config for the <code>L1FeeVault</code></td></tr>
<tr><td><code>SEQUENCER_FEE_VAULT_CONFIG</code></td><td><code>bytes32(uint256(keccak256("opstack.sequencerfeevaultconfig")) - 1)</code></td><td>The Fee Vault Config for the <code>SequencerFeeVault</code></td></tr>
<tr><td><code>L1_CROSS_DOMAIN_MESSENGER_ADDRESS</code></td><td><code>bytes32(uint256(keccak256("opstack.l1crossdomainmessengeraddress")) - 1)</code></td><td><code>abi.encode(address(L1CrossDomainMessengerProxy))</code></td></tr>
<tr><td><code>L1_ERC_721_BRIDGE_ADDRESS</code></td><td><code>bytes32(uint256(keccak256("opstack.l1erc721bridgeaddress")) - 1)</code></td><td><code>abi.encode(address(L1ERC721BridgeProxy))</code></td></tr>
<tr><td><code>L1_STANDARD_BRIDGE_ADDRESS</code></td><td><code>bytes32(uint256(keccak256("opstack.l1standardbridgeaddress")) - 1)</code></td><td><code>abi.encode(address(L1StandardBridgeProxy))</code></td></tr>
<tr><td><code>REMOTE_CHAIN_ID</code></td><td><code>bytes32(uint256(keccak256("opstack.remotechainid")) - 1)</code></td><td>Chain ID of the remote chain</td></tr>
</tbody></table>
</div>
<h2 id="predeploys-3"><a class="header" href="#predeploys-3">Predeploys</a></h2>
<p>All network specific configuration is moved to a single contract, the <code>L1Block</code> predeploy.
All predeploys make calls to the <code>L1Block</code> contract to fetch network specific configuration
rather than reading it from local state.</p>
<pre class="mermaid">graph LR
  subgraph L1
  SystemConfig -- &quot;setConfig(uint8,bytes)&quot; --&gt; OptimismPortal
  end
  subgraph L2
  L1Block
  BaseFeeVault -- &quot;getConfig(ConfigType.GAS_PAYING_TOKEN)(address,uint256,uint8)&quot; --&gt; L1Block
  SequencerFeeVault -- &quot;getConfig(ConfigType.SEQUENCER_FEE_VAULT_CONFIG)(address,uint256,uint8)&quot; --&gt; L1Block
  L1FeeVault -- &quot;getConfig(ConfigType.L1_FEE_VAULT_CONFIG)(address,uint256,uint8)&quot; --&gt; L1Block
  L2CrossDomainMessenger -- &quot;getConfig(ConfigType.L1_CROSS_DOMAIN_MESSENGER_ADDRESS)(address)&quot; --&gt; L1Block
  L2StandardBridge -- &quot;getConfig(ConfigType.L1_STANDARD_BRIDGE_ADDRESS)(address)&quot; --&gt; L1Block
  L2ERC721Bridge -- &quot;getConfig(ConfigType.L1_ERC721_BRIDGE_ADDRESS)(address)&quot; --&gt; L1Block
  OptimismMintableERC721Factory -- &quot;getConfig(ConfigType.REMOTE_CHAIN_ID)(uint256)&quot; --&gt; L1Block
  end
  OptimismPortal -- &quot;setConfig(uint8,bytes)&quot; --&gt; L1Block
</pre>
<h3 id="proxyadmin-1"><a class="header" href="#proxyadmin-1">ProxyAdmin</a></h3>
<p>The <code>ProxyAdmin</code> is updated to have its <code>owner</code> be the <code>DEPOSITOR_ACCOUNT</code>.
This means that it can be deterministically called by network upgrade transactions
or by special deposit transactions emitted by the <code>OptimismPortal</code> that assume
the identity of the <code>DEPOSITOR_ACCOUNT</code>.</p>
<h4 id="rationale-8"><a class="header" href="#rationale-8">Rationale</a></h4>
<p>It is much easier to manage the overall roles of the full system under this model.
The owner of the <code>ProxyAdmin</code> can upgrade any of the predeploys, meaning it can
write storage slots that correspond to withdrawals. This ensures that only the
system or a chain governor can issue upgrades to the predeploys.</p>
<h3 id="l1block-2"><a class="header" href="#l1block-2">L1Block</a></h3>
<h4 id="storage"><a class="header" href="#storage">Storage</a></h4>
<p>The following storage slots are defined:</p>
<ul>
<li><code>BASE_FEE_VAULT_CONFIG</code></li>
<li><code>L1_FEE_VAULT_CONFIG</code></li>
<li><code>SEQUENCER_FEE_VAULT_CONFIG</code></li>
<li><code>L1_CROSS_DOMAIN_MESSENGER_ADDRESS</code></li>
<li><code>L1_ERC_721_BRIDGE_ADDRESS</code></li>
<li><code>L1_STANDARD_BRIDGE_ADDRESS</code></li>
<li><code>REMOTE_CHAIN_ID</code></li>
</ul>
<p>Each slot MUST have a defined <code>ConfigType</code> that authorizes the setting of the storage slot
via a deposit transaction from the <code>DEPOSITOR_ACCOUNT</code>.</p>
<h4 id="interface-9"><a class="header" href="#interface-9">Interface</a></h4>
<h5 id="setisthmus-1"><a class="header" href="#setisthmus-1"><code>setIsthmus</code></a></h5>
<p>This function is meant to be called once on the activation block of the holocene network upgrade.
It MUST only be callable by the <code>DEPOSITOR_ACCOUNT</code> once. When it is called, it MUST call
call each getter for the network specific config and set the returndata into storage.</p>
<h5 id="setconfig-1"><a class="header" href="#setconfig-1"><code>setConfig</code></a></h5>
<p>This function MUST only be callable by the <code>DEPOSITOR_ACCOUNT</code>. It modifies the storage directly
of the <code>L1Block</code> contract. It MUST handle all defined <code>ConfigType</code>s. To ensure a simple ABI, the
<code>bytes</code> value MUST be abi decoded based on the <code>ConfigType</code>.</p>
<pre><code class="language-solidity">function setConfig(ConfigType,bytes)
</code></pre>
<p>Note that <code>ConfigType</code> is an enum which is an alias for a <code>uint8</code>.</p>
<h5 id="getconfig"><a class="header" href="#getconfig"><code>getConfig</code></a></h5>
<p>This function is called by each contract with the appropriate <code>ConfigType</code> to fetch
the network specific configuration. Using this pattern reduces the ABI of the <code>L1Block</code>
contract by removing the need for special getters for each piece of config.</p>
<pre><code class="language-solidity">function getConfig(ConfigType)(bytes)
</code></pre>
<p>The caller needs to ABI decode the data into the desired type.</p>
<h3 id="feevault"><a class="header" href="#feevault">FeeVault</a></h3>
<p>The following changes apply to each of the <code>BaseFeeVault</code>, the <code>L1FeeVault</code> and the <code>SequencerFeeVault</code>.</p>
<h4 id="interface-10"><a class="header" href="#interface-10">Interface</a></h4>
<p>The following functions are updated to read from the <code>L1Block</code> contract:</p>
<ul>
<li><code>recipient()(address)</code></li>
<li><code>withdrawalNetwork()(WithdrawalNetwork)</code></li>
<li><code>minWithdrawalAmount()(uint256)</code></li>
<li><code>withdraw()</code></li>
</ul>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Call</th></tr></thead><tbody>
<tr><td><code>BaseFeeVault</code></td><td><code>L1Block.getConfig(ConfigType.BASE_FEE_VAULT_CONFIG)</code></td></tr>
<tr><td><code>SequencerFeeVault</code></td><td><code>L1Block.getConfig(ConfigType.SEQUENCER_FEE_VAULT_CONFIG)</code></td></tr>
<tr><td><code>L1FeeVault</code></td><td><code>L1Block.getConfig(ConfigType.L1_FEE_VAULT_CONFIG)</code></td></tr>
</tbody></table>
</div>
<h5 id="config"><a class="header" href="#config"><code>config</code></a></h5>
<p>A new function is added to fetch the full Fee Vault Config.</p>
<pre><code class="language-solidity">function config()(address,uint256,WithdrawalNetwork)
</code></pre>
<h3 id="l2crossdomainmessenger-1"><a class="header" href="#l2crossdomainmessenger-1">L2CrossDomainMessenger</a></h3>
<h4 id="interface-11"><a class="header" href="#interface-11">Interface</a></h4>
<p>The following functions are updated to read from the <code>L1Block</code> contract by calling <code>L1Block.getConfig(ConfigType.L1_CROSS_DOMAIN_MESSENGER_ADDRESS)</code>:</p>
<ul>
<li><code>otherMessenger()(address)</code></li>
<li><code>OTHER_MESSENGER()(address)</code></li>
</ul>
<h3 id="l2erc721bridge"><a class="header" href="#l2erc721bridge">L2ERC721Bridge</a></h3>
<h4 id="interface-12"><a class="header" href="#interface-12">Interface</a></h4>
<p>The following functions are updated to read from the <code>L1Block</code> contract by calling <code>L1Block.getConfig(ConfigType.L1_ERC721_BRIDGE_ADDRESS)</code>:</p>
<ul>
<li><code>otherBridge()(address)</code></li>
<li><code>OTHER_BRIDGE()(address)</code></li>
</ul>
<h3 id="l2standardbridge-1"><a class="header" href="#l2standardbridge-1">L2StandardBridge</a></h3>
<h4 id="interface-13"><a class="header" href="#interface-13">Interface</a></h4>
<p>The following functions are updated to read from the <code>L1Block</code> contract by calling <code>L1Block.getConfig(ConfigType.L1_STANDARD_BRIDGE_ADDRESS)</code>:</p>
<ul>
<li><code>otherBridge()(address)</code></li>
<li><code>OTHER_BRIDGE()(address)</code></li>
</ul>
<h3 id="optimismmintableerc721factory-1"><a class="header" href="#optimismmintableerc721factory-1">OptimismMintableERC721Factory</a></h3>
<p>The chain id is no longer read from storage but instead is read from the <code>L1Block</code> contract by calling
<code>L1Block.getConfig(ConfigType.REMOTE_CHAIN_ID)</code></p>
<h2 id="security-considerations-5"><a class="header" href="#security-considerations-5">Security Considerations</a></h2>
<h3 id="governancetoken"><a class="header" href="#governancetoken">GovernanceToken</a></h3>
<p>The predeploy defined by <code>GovernanceToken</code> should be an empty account until it is defined by
a future hardfork.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="alt-da-mode"><a class="header" href="#alt-da-mode">Alt-DA Mode</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="experimental/alt-da.html#overview">Overview</a></li>
<li><a href="experimental/alt-da.html#input-commitment-submission">Input Commitment Submission</a>
<ul>
<li><a href="experimental/alt-da.html#example-commitments">Example Commitments</a></li>
</ul>
</li>
<li><a href="experimental/alt-da.html#da-server">DA Server</a></li>
<li><a href="experimental/alt-da.html#data-availability-challenge-contract">Data Availability Challenge Contract</a>
<ul>
<li><a href="experimental/alt-da.html#parameters">Parameters</a></li>
</ul>
</li>
<li><a href="experimental/alt-da.html#derivation">Derivation</a></li>
<li><a href="experimental/alt-da.html#fault-proof">Fault Proof</a>
<ul>
<li><a href="experimental/alt-da.html#l2-input-commitment"><code>l2-input &lt;commitment&gt;</code></a></li>
<li><a href="experimental/alt-da.html#l1-challenge-status-commitment-blocknumber"><code>l1-challenge-status &lt;commitment&gt; &lt;blocknumber&gt;</code></a></li>
</ul>
</li>
<li><a href="experimental/alt-da.html#safety-and-finality">Safety and Finality</a></li>
<li><a href="experimental/alt-da.html#security-considerations">Security Considerations</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<p>Note: Alt-DA Mode is a Beta feature of the MIT licensed OP Stack.
While it has received initial review from core contributors, it is still undergoing testing,
and may have bugs or other issues.</p>
<h2 id="overview-40"><a class="header" href="#overview-40">Overview</a></h2>
<p>Using <a href="https://vitalik.eth.limo/general/2023/11/14/neoplasma.html">Alt-DA</a> mode means switching to an offchain data availability provider.
The protocol guarantees availability with a challenge contract on L1 where users
can challenge the availability of input data used to derive the chain.
Challenging an input commitment means forcing providers to submit the input data on chain
to prove the data is available during a time period. We call the period during which any party
can challenge a commitment <code>challenge_window</code> and the period during which any party
can submit the input data to resolve the challenge <code>resolve_window</code>.
If a challenge is not resolved by the time <code>resolve_window</code> of L1 blocks have passed,
chain derivation must be reset, omitting the input data when rederiving therefore causing a reorg.</p>
<h2 id="input-commitment-submission"><a class="header" href="#input-commitment-submission">Input Commitment Submission</a></h2>
<p>The <a href="experimental/../protocol/derivation.html#batch-submission">batching</a> and compression of input data remain unchanged. When a batch is ready
to be submitted to the inbox address, the data is uploaded to the DA storage layer instead, and a
commitment (specified below) is submitted as the batcher inbox transaction call data.</p>
<p>Commitment txdata introduces version <code>1</code> to the <a href="experimental/../protocol/derivation.html#batcher-transaction-format">transaction format</a>, in order to interpret
the txdata as a commitment during the l1 retrieval step of the derivation pipeline:</p>
<div class="table-wrapper"><table><thead><tr><th><code>version_byte</code></th><th><code>tx_data</code></th></tr></thead><tbody>
<tr><td>1</td><td><code>encoded_commitment</code></td></tr>
</tbody></table>
</div>
<p>The <code>derivationVersion0</code> byte is still prefixed to the input data stored in the DA provider so the frames
can be decoded downstream.</p>
<p>Commitments are encoded as <code>commitment_type_byte ++ commitment_bytes</code>, where <code>commitment_bytes</code> depends
on the <code>commitment_type_byte</code> where [0, 128) are reserved for official implementations:</p>
<div class="table-wrapper"><table><thead><tr><th><code>commitment_type</code></th><th><code>commitment</code></th></tr></thead><tbody>
<tr><td>0</td><td><code>keccak256(tx_payload)</code></td></tr>
<tr><td>1</td><td><code>da-service</code></td></tr>
</tbody></table>
</div>
<p>The <code>da-service</code> commitment is as follows: <code>da_layer_byte ++ payload</code>.
The DA layer byte must be initially restricted to the range <code>[0, 127)</code>.
This specification will not apportion DA layer bytes, but different DA layers should coordinate to ensure that the
DA layer bytes do not conflict. DA Layers can do so in
<a href="https://github.com/ethereum-optimism/specs/discussions/135">this discussion</a>.
The payload is a bytestring which is up to the DA layer to specify.
The DA server should be able to parse the payload, find the data on the DA layer, and verify that the data returned
from the DA layer matches what was committed to in the payload.</p>
<p>The batcher SHOULD cap input payloads to the maximum L1 tx size or the input will be skipped
during derivation. See <a href="experimental/alt-da.html#derivation">derivation section</a> for more details.</p>
<p>The batcher SHOULD NOT submit a commitment onchain unless input data was successfully stored on the service.
In addition, a DA provider storage service SHOULD return an error response if it is unable to properly
store the request payload so as to signal to the batcher to retry.
Input commitments submitted onchain without proper storage on the DA provider service are subject to
challenges if the input cannot be retrieved during the challenge window, as detailed in the following section.</p>
<h3 id="example-commitments"><a class="header" href="#example-commitments">Example Commitments</a></h3>
<div class="table-wrapper"><table><thead><tr><th><code>version_byte</code></th><th><code>commitment_type</code></th><th><code>da_layer_byte</code></th><th><code>payload</code></th></tr></thead><tbody>
<tr><td>0</td><td></td><td></td><td>frames</td></tr>
<tr><td>1</td><td>0</td><td></td><td>keccak_commitment</td></tr>
<tr><td>1</td><td>1</td><td>0</td><td>eigenda_commitment</td></tr>
<tr><td>1</td><td>1</td><td>0x0a</td><td>avail_commitment</td></tr>
<tr><td>1</td><td>1</td><td>0x0c</td><td>celestia_commitment</td></tr>
<tr><td>1</td><td>1</td><td>...</td><td>altda_commitment</td></tr>
</tbody></table>
</div>
<h2 id="da-server"><a class="header" href="#da-server">DA Server</a></h2>
<p>Input data is uploaded to the storage layer via plain HTTP calls to the DA server.</p>
<p>This service is responsible to interacting with the Data Availability Layer (DA layer).
The layer could be a content addressable storage layer like IPFS or any S3 compatible storage
or it could a specific DA focused blockchain.
Content addressed systems like S3 should use the first <code>put/&lt;hex_encoded_commitment&gt;</code>
because they can pre-compute the commitment.
Blockchain based DA layers should use <code>put</code> and then submit the returned commitment to L1.
Because commitments can include the block height or hash, the commitment cannot be computed prior to submitting
it to the DA Layer.</p>
<p>Any DA provider can implement the following endpoints to receive and serve input data:</p>
<ul>
<li>
<pre><code class="language-text">Request:
  POST /put/&lt;hex_encoded_commitment&gt;
  Content-Type: application/octet-stream
  Body: &lt;preimage_bytes&gt;

Response:
  200 OK
</code></pre>
</li>
<li>
<pre><code class="language-text">Request:
  POST /put
  Content-Type: application/octet-stream
  Body: &lt;preimage_bytes&gt;

Response:
  200 OK
  Content-Type: application/octet-stream
  Body: &lt;hex_encoded_commitment&gt;
</code></pre>
</li>
<li>
<pre><code class="language-text">Request:
  GET /get/&lt;hex_encoded_commitment&gt;

Response:
  200 OK
  Content-Type: application/octet-stream
  Body: &lt;preimage_bytes&gt;
</code></pre>
</li>
</ul>
<h2 id="data-availability-challenge-contract"><a class="header" href="#data-availability-challenge-contract">Data Availability Challenge Contract</a></h2>
<h3 id="parameters-1"><a class="header" href="#parameters-1">Parameters</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Constant</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>fixedResolutionCost</td><td><code>uint256</code></td><td>Fixed gas cost of resolving a challenge, set to 72925</td></tr>
<tr><td>variableResolutionCost</td><td><code>uint256</code></td><td>Upper limit gas cost per byte scaled by precision constant, set to 16640</td></tr>
<tr><td>variableResolutionCostPrecision</td><td><code>uint256</code></td><td>Precision of the variable resolution cost, set to 1000</td></tr>
</tbody></table>
</div><div class="table-wrapper"><table><thead><tr><th>Variable</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>challengeWindow</td><td><code>uint256</code></td><td>Number of L1 blocks whereby a commitment MAY be challenged after it's included onchain</td></tr>
<tr><td>resolveWindow</td><td><code>uint256</code></td><td>Number of L1 blocks whereby input data SHOULD be submitted onchain after a challenge</td></tr>
<tr><td>bondSize</td><td><code>uint256</code></td><td>Bond amount in Wei posted by the challenger so that bondSize &gt;= resolveCost</td></tr>
<tr><td>resolverRefundFactor</td><td><code>uint256</code></td><td>Factor defining the portion of the resolving cost refunded to the resolver</td></tr>
</tbody></table>
</div>
<p>Data availability is guaranteed via a permissionless challenge contract on the L1 chain.
Users have a set number of L1 blocks (<code>challengeWindow</code>) during which they are able to call
the <code>challenge</code> method of the contract with the following inputs:</p>
<p><strong>Note:</strong> Resolving Input Data through the Data Availability Challenge Contract is implemented
only for <code>type=0 (keccak)</code> commitments. This is because <code>type=1 (da-service)</code> commitments are designed to be
handled by a DA Server which is responsible for the mapping between commitment and input data.
Due to this "generic" handling nature, there is currently no on-chain mechanism to verify commitments.</p>
<pre><code class="language-solidity">function challenge(uint256 challengedBlockNumber, bytes calldata challengedCommitment) external payable
</code></pre>
<ul>
<li>The L1 block number in which it was included.</li>
<li>Versioned commitment bytes (i.e. <code>0 ++ keccak256(frame.. )</code>)</li>
</ul>
<p>Users with access to the input data then have another window of L1 blocks (<code>resolveWindow</code>)
during which they can submit it as calldata to the chain by calling the <code>resolve</code> method of the contract.
If the data is not included onchain by the time the resolve window is elapsed, derivation of the L2 canonical chain
will reorg starting from this first block derived from the challenged input data to the last block derived from the
L1 block at which it expired. See more details about <a href="experimental/alt-da.html#derivation">Derivation</a> in the following section.</p>
<pre><code class="language-solidity">function resolve(uint256 challengedBlockNumber, bytes calldata challengedCommitment, bytes calldata resolveData) external
</code></pre>
<p>In order to challenge a commitment, users deposit a bond amount where <code>bond &gt;= resolve_tx_gas_cost</code>.
If the gas cost of resolving the challenge was lower than the bond, the difference is reimbursed to the challenger where
<code>cost = (fixedResolutionCost + preImageLength * variableResolutionCost / variableResolutionCostPrecision) * gasPrice</code>
and the rest of the bond is burnt. If the challenge is not resolved in time and expired,
the bond is returned and can be withdrawn by the challenger or used to challenge another commitment.
<code>bondSize</code> can be updated by the contract owner similar to <a href="experimental/../protocol/system-config.html">SystemConfig</a> variables.
See <a href="experimental/alt-da.html#security-considerations">Security Considerations</a> for more details on bond management.</p>
<p>The state of all challenges can be read from the contract state or by syncing contract events.
<code>challengeWindow</code> and <code>resolveWindow</code> are constant values that currently cannot be changed
unless the contract is upgraded. A dynamic window mechanism may be explored in the future.</p>
<p>Any challenge with a properly encoded commitment, a bond amount associated with the challenger
address and a block number within the challenge window is accepted by the contract.
However, a challenge is only valid if the commitment and block number pairing map to a valid commitment
and its L1 origin block number during derivation. Challenges associated with an illegal commitment
or block number will be ignored during derivation and have no impact on the state of the chain.</p>
<p>The contract is deployed behind an upgradable proxy so the address can be hardcoded in the rollup config
file and does not need to change. A future upgrade can add custom resolver functions to be chosen
dynamically when a user calls the resolve function to support other alt DA solutions.</p>
<h2 id="derivation-3"><a class="header" href="#derivation-3">Derivation</a></h2>
<p>Input data is retrieved during derivation of L2 blocks. The changes to the derivation pipeline
when using the alt DA source are limited to wrapping the L1 based <code>DataAvailabilitySource</code> step
in the pipeline with a module that enables pulling the data from the offchain DA source once
we've extracted the commitment from L1 DA.</p>
<p>Similarly to L1 based DA, for each L1 block we open a calldata source to retrieve the input commitments
from the transactions and use each commitment with its l1 origin block number to resolve
the input data from the storage service. To enable smooth transition between alt-da and rollup mode, any L1 data
retrieved from the batcher inbox that is not prefixed with <code>txDataVersion1</code> is forwarded downstream
to be parsed as input frames or skipped as invalid data.</p>
<p>In addition, we filter events from the DA Challenge contract included in the block
and sync a local state of challenged input commitments. As the derivation pipeline steps through
<code>challenge_window + resolve_window</code> amount of L1 blocks, any challenge marked as active
becomes expired causing a reset of the derivation pipeline.</p>
<pre><code class="language-solidity">// The status enum of a DA Challenge event
enum ChallengeStatus {
    Uninitialized,
    Active,
    Resolved,
    Expired
}

// DA Challenge event filtered
event ChallengeStatusChanged(
  bytes indexed challengedCommitment, uint256 indexed challengedBlockNumber, ChallengeStatus status
);

</code></pre>
<p>Derivation can either be driven by new L1 blocks or restarted (reset) from the L1 origin of the last
L2 safe head known by the execution engine. The model here is of weak subjectivity whereby a new node
coming onto the network can connect to at least 1 honest peer and sync blocks in the <code>challenge_window</code>
to reconstruct the same state as the rest of the network. As with <a href="https://eips.ethereum.org/EIPS/eip-4844">EIP-4844</a>,
applications SHOULD take on the burden of storing historical data relevant to themselves beyond
the challenge window.</p>
<p>When stepping through new L1 origin blocks, input data is loaded from the DA storage service.
If the service responds with a 404 (not found) error, derivation stalls and the DA Manager
starts a detached traversal of new L1 blocks until:</p>
<ul>
<li>An <code>Active</code> challenge event is found, detached L1 traversal continues:
<ul>
<li>A <code>Resolved</code> challenge event is found: derivation continues with the input data submitted onchain.</li>
<li>A high enough L1 block is reached such as <code>latest_l1 - pipeline_l1_origin = resolve_window_size</code>:
input data is skipped from the derivation output.</li>
</ul>
</li>
<li>Data is never challenged, derivation returns critical error.</li>
</ul>
<p>When <a href="experimental/../protocol/derivation.html#resetting-the-pipeline">derivation is reset</a>, the pipeline steps through previously seen L1 origins so that:
<code>sync_starting_point = latest_l1_block - (challenge_window_size + resolve_window_size + sequencer_window_size)</code>.
In that case, the DA manager has already synced the state of challenges during the range of L1 blocks traversed
so the pipeline can either skip commitments with expired challenges and reorg the L2 chain
or load input data from the resolving transaction calldata.
In addition, an expired challenge will reorg out <code>[r_start, r_end]</code> L2 blocks so that <code>r_start</code> is the first
block derived from the expired challenge's input and <code>r_end</code> the last L2 block derived before the pipeline
was reset.</p>
<p>Derivation MUST skip input data such as <code>input_data_size &gt; MAX_L1_TX_SIZE</code> where <code>MAX_L1_TX_SIZE</code> is a consensus
constant of 130672 bytes when <code>commitment_type == 0</code>. Different DA layers can potentially resolve the challenge
without immediately loading all of the data onto L1 in a single transaction &amp; therefore are exempt from this limit.
In theory <code>MAX_L1_TX_SIZE</code> could be increased up to <code>(tx_gas_limit - fixed_resolution_cost) / dynamic_resolution_cost</code>
based on the cost of resolving challenges in the contract implementation however to make challenging accessible
it is capped based on geth's txMaxSize.
130672 is chosen as 131072 - 400. Geth rejects transactions from the mempool with a total serialized size over 131072.
400 bytes are allocated as overhead (signature, to address, metadata).</p>
<h2 id="fault-proof-1"><a class="header" href="#fault-proof-1">Fault Proof</a></h2>
<p>The derivation pipeline is integrated with <a href="experimental/../fault-proof/index.html">fault proofs</a> by adding additional hint types to the
preimage oracle in order to query the input data from the DA provider as well as onchain challenge status.</p>
<h3 id="l2-input-commitment"><a class="header" href="#l2-input-commitment"><code>l2-input &lt;commitment&gt;</code></a></h3>
<p>The input data stored on the DA storage for the given <code>&lt;commitment&gt;</code>.</p>
<h3 id="l1-challenge-status-commitment-blocknumber"><a class="header" href="#l1-challenge-status-commitment-blocknumber"><code>l1-challenge-status &lt;commitment&gt; &lt;blocknumber&gt;</code></a></h3>
<p>The status of the challenge for the given <code>&lt;commitment&gt;</code> at the given <code>&lt;blocknumber&gt;</code> on the L1
DataAvailabilityChallenge contract.</p>
<h2 id="safety-and-finality"><a class="header" href="#safety-and-finality">Safety and Finality</a></h2>
<p>Similarly to rollup mode, the engine queue labels any new blocks derived from input data with a commitment
on the L1 chain as â€œsafeâ€. Although labeled as â€œsafeâ€, the chain might still reorg in case of a faulty DA provider
and users must use the â€œfinalizedâ€ label for a guarantee that their state cannot revert.</p>
<p>With Alt-DA mode on, the engine queue does receive finality signals from the L1 RPC AND
from the DA manager that keeps track of challenges.
The DA manager maintains an internal state of all the input commitments in the current <code>challengeWindow</code>
as they are validated by the derivation pipeline.</p>
<p>The L2 chain can be marked as finalized when the L1 block in which commitments can no longer be invalidated
becomes finalized. Without Alt-DA Mode, L2 blocks are safe when the batch is on L1. Plasma commitments are
only "optimistically safe" when the commitment is found in a L1 block. Commitments then become safe
when that commitment can no longer be invalidated. Then finalization can proceed as normal: when the L1 block
that an L2 block is derived from becomes finalized, the L2 block can be marked as finalized.</p>
<p>The engine queue will maintain a longer buffer of L2 blocks waiting for the DA window to expire
and the L1 block with the commitment to be finalized in order to signal finality.</p>
<h2 id="security-considerations-6"><a class="header" href="#security-considerations-6">Security Considerations</a></h2>
<p>The Data Availability Challenge contract mitigates DoS vulnerability with a payable bond requirement making
challenging the availability of a commitment at least as expensive as submitting the data onchain to resolve
the challenge.
In addition, the reward is not net positive for the <a href="https://arxiv.org/abs/1809.09044">fisherman</a>
who forced the release of data by challenging thus preventing money pump vulnerability
while still making challenging affordable to altruistic fishermen and users who desire to pay
to guarantee data availability on L1.
Lastly, if needed a <code>resolver_refund_factor</code> can be dialed up such as <code>resolver_refund_factor * resolving_cost</code>
is refunded to the resolver (where <code>0 &lt;= refund_factor &lt;= 1</code>) while the rest of the bond is burnt.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<!-- DOCTOC SKIP -->
<h1 id="interop"><a class="header" href="#interop">Interop</a></h1>
<p>The ability for a blockchain to easily read the state of another blockchain is called interoperability.
Relatively trustless interop is possible between rollups by using L1 Ethereum as a hub. A message is
withdrawn from one chain to L1 and then deposited to another chain. The goal of OP Stack native interop
is to enable cross chain messaging at a much lower latency than going through L1. Low latency interoperability
allows for a horizontally scalable blockchain network.</p>
<p>Note: this document references an "interop network upgrade" as a temporary name.</p>
<div class="table-wrapper"><table><thead><tr><th>Term</th><th>Definition</th></tr></thead><tbody>
<tr><td>Source Chain</td><td>A blockchain that includes an initiating message</td></tr>
<tr><td>Destination Chain</td><td>A blockchain that includes an executing message</td></tr>
<tr><td>Initiating Message</td><td>An event emitted from a source chain</td></tr>
<tr><td>Identifier</td><td>A unique pointer to an initiating message</td></tr>
<tr><td>Executing Message</td><td>An event emitted from a destination chain's <code>CrossL2Inbox</code> that includes an initiating message and identifier</td></tr>
<tr><td>Cross Chain Message</td><td>The cumulative execution and side effects of the initiating message and executing message</td></tr>
<tr><td>Dependency Set</td><td>The set of chains that originate initiating transactions where the executing transactions are valid</td></tr>
<tr><td>Log</td><td>The Ethereum consensus object created by the <code>LOG*</code> opcodes</td></tr>
<tr><td>Event</td><td>The solidity representation of a log</td></tr>
</tbody></table>
</div>
<p>A total of two transactions are required to complete a cross chain message.
The first transaction is submitted to the source chain and any log that is emitted can be
used as an initiating message that can be consumed on a destination chain. The second
transaction is submitted to the destination chain and includes the
initiating message as well as the identifier that uniquely points to the initiating message.</p>
<p>The chain's fork choice rule will reorg out any blocks that contain an executing message that is not valid.
A valid executing message means that the identifier correctly references its initiating message.
This means that the sequencer SHOULD only include an executing message if they have checked its validity.
The integrity of a message is guaranteed at the application layer without the need for any sort of confirmation
depth.</p>
<p>The proof system is able to check the validity of all executing messages.</p>
<h2 id="specifications"><a class="header" href="#specifications">Specifications</a></h2>
<ul>
<li><a href="interop/./dependency-set.html">Dependency Set</a>: definition of chains and chain-dependencies in the Superchain.</li>
<li><a href="interop/./messaging.html">Messaging</a>: messaging functionality, core of protocol-level interoperability.</li>
<li><a href="interop/./predeploys.html">Predeploys</a>: system contracts to interface with other chains.</li>
<li><a href="interop/./sequencer.html">Sequencer</a>: Sequencer Policy and block-building information.</li>
<li><a href="interop/./verifier.html">Verifier</a>: Verification of cross-L2 messaging.</li>
<li><a href="interop/./supervisor.html">Supervisor</a>: API for validating messages.</li>
<li><a href="interop/./fault-proof.html">Fault Proof</a>: modifications to prove interop functionality in the fault-proof.</li>
<li><a href="interop/./token-bridging.html">Token Bridging</a>: sending ERC20 tokens between chains</li>
<li><a href="interop/./eth-liquidity.html">ETH Liquidity</a>: ETH liquidity management.</li>
<li><a href="interop/./superchain-eth-bridge.html">Superchain ETH Bridge</a>: sending ETH between chains.</li>
<li><a href="interop/./eth-bridging.html">ETH Bridging</a>: sending ETH between chains.</li>
<li><a href="interop/./derivation.html">Derivation</a>: Changes to derivation of block-attributes.</li>
<li><a href="interop/./tx-pool.html">Transaction Pool</a>: Transaction-pool validation of transactions.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="the-dependency-set"><a class="header" href="#the-dependency-set">The Dependency Set</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="interop/dependency-set.html#chain-id">Chain ID</a></li>
<li><a href="interop/dependency-set.html#updating-the-dependency-set">Updating the Dependency Set</a></li>
<li><a href="interop/dependency-set.html#future-considerations">Future Considerations</a>
<ul>
<li><a href="interop/dependency-set.html#layer-1-as-part-of-the-dependency-set">Layer 1 as Part of the Dependency Set</a></li>
</ul>
</li>
<li><a href="interop/dependency-set.html#security-considerations">Security Considerations</a>
<ul>
<li><a href="interop/dependency-set.html#dependency-set-size">Dependency Set Size</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<p>The dependency set defines the set of chains that destination chains allow as source chains. Another way of
saying it is that the dependency set defines the set of initiating messages that are valid to be used
as part of an executing message. An executing message MUST have an initiating message that is created by a chain
in the dependency set.</p>
<p>The dependency set is defined by a set of chain ids. Since it is impossible to enforce uniqueness of chain ids,
social consensus MUST be used to determine the chain that represents the canonical chain id. This
particularly impacts the block builder as they SHOULD use the chain id to assist in validation
of executing messages.</p>
<p>The dependency set is configured on a per cluster basis. All chains that are in the dependency set
can accept initiating messages from any other chain in the dependency set, resulting in a mesh.</p>
<p>The chain id of the local chain MUST be considered as part of its own dependency set. This allows a chain
to consume logs that it has produced much more cheaply than providing a block hash proof.</p>
<h2 id="chain-id-1"><a class="header" href="#chain-id-1">Chain ID</a></h2>
<p>The concept of a chain id was introduced in <a href="https://eips.ethereum.org/EIPS/eip-155">EIP-155</a> to prevent
replay attacks between chains. This EIP does not specify the max size of a chain id, although
<a href="https://eips.ethereum.org/EIPS/eip-2294">EIP-2294</a> attempts to add a maximum size. Since this EIP is
stagnant, all representations of chain ids MUST be the <code>uint256</code> type.</p>
<p>In the future, OP Stack chains reserve the right to use up to 32 bytes to represent a chain id. The
configuration of the chain should deterministically map to a chain id and with careful architecture
changes, all possible OP Stack chains in the superchain will be able to exist counterfactually.</p>
<p>It is a known issue that not all software in the Ethereum ecosystem can handle 32 byte chain ids.</p>
<h2 id="updating-the-dependency-set"><a class="header" href="#updating-the-dependency-set">Updating the Dependency Set</a></h2>
<p>The dependency set is managed in the client software. Adding a chain to the dependency set is
considered an upgrade to the network. It is not possible to remove chains from the dependency set.</p>
<h2 id="future-considerations"><a class="header" href="#future-considerations">Future Considerations</a></h2>
<h3 id="layer-1-as-part-of-the-dependency-set"><a class="header" href="#layer-1-as-part-of-the-dependency-set">Layer 1 as Part of the Dependency Set</a></h3>
<p>The layer one MAY be part of the dependency set in the future. This means that any event
created on layer one is consumable on layer two.</p>
<h2 id="security-considerations-7"><a class="header" href="#security-considerations-7">Security Considerations</a></h2>
<h3 id="dependency-set-size"><a class="header" href="#dependency-set-size">Dependency Set Size</a></h3>
<p>It becomes increasingly expensive to fully validate the full cluster as the size of the dependency
set grows. The proof system requires validating all of the chains so the size of the dependency
set is limited by the performance of the proof.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="messaging"><a class="header" href="#messaging">Messaging</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="interop/messaging.html#message">Message</a>
<ul>
<li><a href="interop/messaging.html#message-payload">Message payload</a></li>
<li><a href="interop/messaging.html#message-identifier">Message Identifier</a></li>
</ul>
</li>
<li><a href="interop/messaging.html#messaging-ends">Messaging ends</a>
<ul>
<li><a href="interop/messaging.html#initiating-messages">Initiating Messages</a></li>
<li><a href="interop/messaging.html#executing-messages">Executing Messages</a></li>
</ul>
</li>
<li><a href="interop/messaging.html#messaging-invariants">Messaging Invariants</a>
<ul>
<li><a href="interop/messaging.html#timestamp-invariant">Timestamp Invariant</a></li>
<li><a href="interop/messaging.html#chainid-invariant">ChainID Invariant</a></li>
<li><a href="interop/messaging.html#message-expiry-invariant">Message Expiry Invariant</a></li>
</ul>
</li>
<li><a href="interop/messaging.html#message-graph">Message Graph</a>
<ul>
<li><a href="interop/messaging.html#invalid-messages">Invalid messages</a>
<ul>
<li><a href="interop/messaging.html#block-reorgs">Block reorgs</a></li>
<li><a href="interop/messaging.html#block-recommits">Block Recommits</a></li>
</ul>
</li>
<li><a href="interop/messaging.html#intra-block-messaging-cycles">Intra-block messaging: cycles</a></li>
<li><a href="interop/messaging.html#resolving-cross-chain-safety">Resolving cross-chain safety</a></li>
<li><a href="interop/messaging.html#horizon-timestamp">Horizon timestamp</a></li>
<li><a href="interop/messaging.html#pruning-the-graph">Pruning the graph</a></li>
<li><a href="interop/messaging.html#bounding-the-graph">Bounding the graph</a></li>
</ul>
</li>
<li><a href="interop/messaging.html#security-considerations">Security Considerations</a>
<ul>
<li><a href="interop/messaging.html#cyclic-dependencies">Cyclic dependencies</a></li>
<li><a href="interop/messaging.html#transitive-dependencies">Transitive dependencies</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="message"><a class="header" href="#message">Message</a></h2>
<p>A message is a <a href="interop/messaging.html#message-payload">broadcast payload</a> emitted from an <a href="interop/messaging.html#message-identifier">identified source</a>.</p>
<h3 id="message-payload"><a class="header" href="#message-payload">Message payload</a></h3>
<p>Opaque <code>bytes</code> that represent a <a href="https://github.com/ethereum/go-ethereum/blob/5c67066a050e3924e1c663317fd8051bc8d34f43/core/types/log.go#L29">Log</a>.</p>
<p>It is serialized by first concatenating the topics and then with the data.</p>
<pre><code class="language-go">msg := make([]byte, 0)
for _, topic := range log.Topics {
    msg = append(msg, topic.Bytes()...)
}
msg = append(msg, log.Data...)
</code></pre>
<p>The <code>_msg</code> can easily be decoded into a Solidity <code>struct</code> with <code>abi.decode</code> since each topic is always 32 bytes and
the data generally ABI encoded.</p>
<h3 id="message-identifier"><a class="header" href="#message-identifier">Message Identifier</a></h3>
<p>The <a href="interop/messaging.html#message-identifier"><code>Identifier</code></a> that uniquely represents a log that is emitted from a chain. It can be considered to be a
unique pointer to a particular log. The derivation pipeline and fault proof program MUST ensure that the
<code>_msg</code> corresponds exactly to the log that the <a href="interop/messaging.html#message-identifier"><code>Identifier</code></a> points to.</p>
<pre><code class="language-solidity">struct Identifier {
    address origin;
    uint256 blocknumber;
    uint256 logIndex;
    uint256 timestamp;
    uint256 chainid;
}
</code></pre>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>origin</code></td><td><code>address</code></td><td>Account that emits the log</td></tr>
<tr><td><code>blocknumber</code></td><td><code>uint256</code></td><td>Block number in which the log was emitted</td></tr>
<tr><td><code>logIndex</code></td><td><code>uint256</code></td><td>The index of the log in the array of all logs emitted in the block</td></tr>
<tr><td><code>timestamp</code></td><td><code>uint256</code></td><td>The timestamp that the log was emitted. Used to enforce the timestamp invariant</td></tr>
<tr><td><code>chainid</code></td><td><code>uint256</code></td><td>The chain id of the chain that emitted the log</td></tr>
</tbody></table>
</div>
<p>The <a href="interop/messaging.html#message-identifier"><code>Identifier</code></a> includes the set of information to uniquely identify a log. When using an absolute
log index within a particular block, it makes ahead of time coordination more complex. Ideally there
is a better way to uniquely identify a log that does not add ordering constraints when building
a block. This would make building atomic cross chain messages more simple by not coupling the
exact state of the block templates between multiple chains together.</p>
<h2 id="messaging-ends"><a class="header" href="#messaging-ends">Messaging ends</a></h2>
<h3 id="initiating-messages"><a class="header" href="#initiating-messages">Initiating Messages</a></h3>
<p>Each <a href="https://github.com/ethereum/go-ethereum/blob/5c67066a050e3924e1c663317fd8051bc8d34f43/core/types/log.go#L29">Log</a> (also known as <code>event</code> in solidity) forms an initiating message,
with the raw log data coming from the <a href="interop/messaging.html#message-payload">Message Payload</a>.</p>
<p>Messages are <em>broadcast</em>: the protocol does not enshrine address-targeting within messages.</p>
<p>The initiating message is uniquely identifiable with an <a href="interop/messaging.html#message-identifier"><code>Identifier</code></a>,
such that it can be distinguished from other duplicate messages within the same transaction or block.</p>
<p>An initiating message may be executed many times: no replay-protection is enshrined in the protocol.</p>
<h3 id="executing-messages"><a class="header" href="#executing-messages">Executing Messages</a></h3>
<p>An executing message is represented by the <a href="interop/./predeploys.html#executingmessage-event">ExecutingMessage event</a> that is emitted by
the <code>CrossL2Inbox</code> predeploy. Contracts can introduce their own public
entrypoints and solely trigger validation of the cross chain message with <a href="interop/./predeploys.html#validatemessage">validateMessage</a>.</p>
<p>We highly encourage the use of the <a href="interop/./predeploys.html#l2tol2crossdomainmessenger"><code>L2toL2CrossDomainMessenger</code></a>
over a custom messsage-executor contract.</p>
<p>All of the information required to satisfy the invariants MUST be included in this event.</p>
<p>Both the block builder and the verifier use this information to ensure that all system invariants are held.</p>
<p>The executing message is verified by checking if there is an existing initiating-message
that originates at <a href="interop/messaging.html#message-identifier"><code>Identifier</code></a> with matching <a href="interop/messaging.html#message-payload">Message Payload</a>.</p>
<p>Since an executing message is defined by a log, it means that reverting calls to the <code>CrossL2Inbox</code>
do not count as executing messages.</p>
<h2 id="messaging-invariants"><a class="header" href="#messaging-invariants">Messaging Invariants</a></h2>
<ul>
<li><a href="interop/messaging.html#timestamp-invariant">Timestamp Invariant</a>: The timestamp at the time of inclusion of the initiating message MUST
be less than or equal to the timestamp of the executing message as well as greater than the Interop Start Timestamp.</li>
<li><a href="interop/messaging.html#chainid-invariant">ChainID Invariant</a>: The chain id of the initiating message MUST be in the dependency set</li>
<li><a href="interop/messaging.html#message-expiry-invariant">Message Expiry Invariant</a>: The timestamp at the time of inclusion of the executing
message MUST be lower than the initiating message timestamp (as defined in the <a href="interop/messaging.html#message-identifier"><code>Identifier</code></a>) + <code>EXPIRY_TIME</code>.</li>
</ul>
<h3 id="timestamp-invariant"><a class="header" href="#timestamp-invariant">Timestamp Invariant</a></h3>
<p>The timestamp invariant ensures that initiating messages have a timestamp greater than the Interop upgrade timestamp
and cannot come from a future block than the block of its executing message.</p>
<p>This means that messages can only be initiated in blocks that come after the <a href="interop/./derivation.html#activation-block">activation block</a>.
Contract log events in the activation block are not valid initiating messages.</p>
<p>This same activation block only includes deposit-type transactions
(from the system, and possibly from L1): this block can thus not include executing messages,
even if only executing the initiating messages of previously Interop-activated chains.</p>
<p>Note that since all transactions in a block have the same timestamp, it is possible for an executing transaction
to be ordered before the initiating message in the same block.
However, cyclic message dependencies are not allowed and
this is verified with rules complementary to the timestamp invariant.</p>
<h3 id="chainid-invariant"><a class="header" href="#chainid-invariant">ChainID Invariant</a></h3>
<p>Without a guarantee on the set of dependencies of a chain, it may be impossible for the derivation
pipeline to know which chain to source the initiating message from. This also allows for chain operators
to explicitly define the set of chains that they depend on.</p>
<h3 id="message-expiry-invariant"><a class="header" href="#message-expiry-invariant">Message Expiry Invariant</a></h3>
<p>Note: Message Expiry as property of the protocol is in active discussion.
It helps set a strict bound on total messaging activity to support, but also limits use-cases.
This trade-off is in review. This invariant may be ignored in initial interop testnets.</p>
<p>The expiry invariant invalidates inclusion of any executing message with
<code>id.timestamp + EXPIRY_TIME &lt; executing_block.timestamp</code> where:</p>
<ul>
<li><code>id</code> is the <a href="interop/messaging.html#message-identifier"><code>Identifier</code></a> encoded in the executing message, matching the block attributes of the initiating message.</li>
<li><code>executing_block</code> is the block where the executing message was included in.</li>
<li><code>EXPIRY_TIME = 7 * 24 * 60 * 60 = 604800</code> seconds, i.e. 7 days.</li>
</ul>
<h2 id="message-graph"><a class="header" href="#message-graph">Message Graph</a></h2>
<p>The dependencies of messages can be modeled as a directed graph:</p>
<ul>
<li><strong>vertex</strong>: a block</li>
<li><strong>edge</strong>: a dependency:
<ul>
<li>parent-block (source) to block (target)</li>
<li>message relay, from initiation (source) to execution (target)</li>
</ul>
</li>
</ul>
<p>If the source of an edge is invalidated, the target is invalidated.</p>
<h3 id="invalid-messages"><a class="header" href="#invalid-messages">Invalid messages</a></h3>
<p>A message is said to be "invalid" when the executing message does not have a valid dependency.</p>
<p>Dependencies are invalid when:</p>
<ul>
<li>The dependency is unknown.</li>
<li>The dependency is known but not part of the canonical chain.</li>
<li>The dependency is known but does not match all message attributes (<a href="interop/messaging.html#message-identifier"><code>Identifier</code></a> and payload).</li>
</ul>
<h4 id="block-reorgs"><a class="header" href="#block-reorgs">Block reorgs</a></h4>
<p>The <a href="interop/messaging.html#message-identifier"><code>Identifier</code></a> used by an executing message does not cryptographically
commit to the block it may reference.</p>
<p>Messages may be executed before the block that initiates them is sealed.</p>
<p>When tracking message dependencies, edges are maintained for <em>all</em> identified source blocks.</p>
<p>Reorgs are resolved by filtering the view of the solver to only canonical blocks.
If the source block is not canonical, the dependency is invalid.</p>
<p>The canonical L2 block at the identified block-height is the source of truth.</p>
<h4 id="block-recommits"><a class="header" href="#block-recommits">Block Recommits</a></h4>
<p>Blocks may be partially built, or sealed but not published, and then rebuilt.</p>
<p>Any optimistically assumed messages have to be revalidated,
and the original partial block can be removed from the dependency graph.</p>
<h3 id="intra-block-messaging-cycles"><a class="header" href="#intra-block-messaging-cycles">Intra-block messaging: cycles</a></h3>
<p>While messages cannot be initiated by future blocks,
they can be initiated by any transactions within the same timestamp,
as per the <a href="interop/messaging.html#timestamp-invariant">Timestamp Invariant</a>.</p>
<p>This property allows messages to form cycles in the graph:
blocks with equal timestamp, of chains in the same dependency set,
may have dependencies on one another.</p>
<h3 id="resolving-cross-chain-safety"><a class="header" href="#resolving-cross-chain-safety">Resolving cross-chain safety</a></h3>
<p>To determine cross-chain safety, the graph is inspected for valid graph components that have no invalid dependencies,
while applying the respective safety-view on the blocks in the graph.
I.e., the graph must not have any inward edges towards invalid blocks within the safety-view.</p>
<p>A safety-view is the subset of canonical blocks of all chains with the specified safety label or a higher safety label.
Dependencies on blocks outside of the safety-view are invalid,
but may turn valid once the safety-view changes (e.g. a reorg of unsafe blocks).</p>
<p>By resolving in terms of graph-components, cyclic dependencies and transitive dependencies are addressed.</p>
<h3 id="horizon-timestamp"><a class="header" href="#horizon-timestamp">Horizon timestamp</a></h3>
<p>The maximum seen timestamp in the graph is the <code>horizon_timestamp</code>.</p>
<p>The verifier can defer growth of the graph past this <code>horizon_timestamp</code>,
until the graph has been resolved and pruned.</p>
<h3 id="pruning-the-graph"><a class="header" href="#pruning-the-graph">Pruning the graph</a></h3>
<p>Edges between blocks can be de-duplicated, when the blocks are complete and sealed.</p>
<p>The same initiating or executing messages, but attached to different blocks,
may have to be added back to the graph if the set of blocks changes.</p>
<p>Blocks with cross-chain safety in the finalized-blocks safety-view can be optimized:
outward edges for initiating messages may be attached
when relevant to resolution of newer lower-safety blocks.
No inward edges are required anymore however, as the maximum safety has been ensured.</p>
<p>Blocks older than <code>horizon_timestamp - (2 * EXPIRY_TIME)</code> cannot be depended
on from any valid block within the graph, and can thus be safely pruned entirely.</p>
<h3 id="bounding-the-graph"><a class="header" href="#bounding-the-graph">Bounding the graph</a></h3>
<p>With many events, and transitive dependencies, resolving the cross-chain safety may be an intensive task for a verifier.
It is thus important for the graph to be reasonably bounded, such that it can be resolved.</p>
<p>The graph is bounded in 4 ways:</p>
<ul>
<li>Every block can only depend on blocks of chains in the dependency set,
as per the <a href="interop/messaging.html#chainid-invariant">ChainID invariant</a>.</li>
<li>Every block cannot depend on future blocks, as per the <a href="interop/messaging.html#timestamp-invariant">Timestamp invariant</a>.</li>
<li>Every block has a maximum gas limit, an intrinsic cost per transaction,
and thus a maximum inward degree of dependencies.</li>
<li>Every block cannot depend on expired messages, as per the <a href="interop/messaging.html#message-expiry-invariant">Message expiry invariant</a>.</li>
</ul>
<p>The verifier is responsible for filtering out non-canonical parts of the graph.</p>
<h2 id="security-considerations-8"><a class="header" href="#security-considerations-8">Security Considerations</a></h2>
<h3 id="cyclic-dependencies"><a class="header" href="#cyclic-dependencies">Cyclic dependencies</a></h3>
<p>If there is a cycle in the dependency set, chains MUST still be able to promote unsafe blocks
to safe blocks. A cycle in the dependency set happens anytime that two chains are in each other's
dependency set. This means that they are able to send cross chain messages to each other.</p>
<h3 id="transitive-dependencies"><a class="header" href="#transitive-dependencies">Transitive dependencies</a></h3>
<p>The safety of a chain is only ensured when the inputs are safe:
dependencies are thus said to be transitive.
Without validating the transitive dependencies,
the verifier relies on the verification work of the nodes that it sources its direct dependencies from.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="predeploys-4"><a class="header" href="#predeploys-4">Predeploys</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="interop/predeploys.html#overview">Overview</a></li>
<li><a href="interop/predeploys.html#crossl2inbox">CrossL2Inbox</a>
<ul>
<li><a href="interop/predeploys.html#access-list">Access-list</a>
<ul>
<li><a href="interop/predeploys.html#type-1-lookup-identity">type 1: Lookup identity</a></li>
<li><a href="interop/predeploys.html#type-2-chain-id-extension">type 2: Chain-ID extension</a></li>
<li><a href="interop/predeploys.html#type-3-checksum">type 3: Checksum</a></li>
</ul>
</li>
<li><a href="interop/predeploys.html#assumptions">Assumptions</a>
<ul>
<li><a href="interop/predeploys.html#gas-schedule-dependencies">Gas Schedule Dependencies</a></li>
<li><a href="interop/predeploys.html#storage-slot-calculation">Storage Slot Calculation</a></li>
<li><a href="interop/predeploys.html#evm-warming-behavior">EVM Warming Behavior</a></li>
</ul>
</li>
<li><a href="interop/predeploys.html#functions">Functions</a>
<ul>
<li><a href="interop/predeploys.html#validatemessage">validateMessage</a></li>
</ul>
</li>
<li><a href="interop/predeploys.html#executingmessage-event"><code>ExecutingMessage</code> Event</a></li>
<li><a href="interop/predeploys.html#reference-implementation">Reference implementation</a></li>
<li><a href="interop/predeploys.html#deposit-handling">Deposit Handling</a></li>
<li><a href="interop/predeploys.html#identifier-getters"><code>Identifier</code> Getters</a></li>
</ul>
</li>
<li><a href="interop/predeploys.html#l2tol2crossdomainmessenger">L2ToL2CrossDomainMessenger</a>
<ul>
<li><a href="interop/predeploys.html#relaymessage-invariants"><code>relayMessage</code> Invariants</a></li>
<li><a href="interop/predeploys.html#sendmessage-invariants"><code>sendMessage</code> Invariants</a></li>
<li><a href="interop/predeploys.html#resendmessage-invariants"><code>resendMessage</code> Invariants</a></li>
<li><a href="interop/predeploys.html#message-versioning">Message Versioning</a></li>
<li><a href="interop/predeploys.html#interfaces">Interfaces</a>
<ul>
<li><a href="interop/predeploys.html#sending-messages">Sending Messages</a></li>
</ul>
</li>
<li><a href="interop/predeploys.html#re-sending-messages">Re-sending Messages</a>
<ul>
<li><a href="interop/predeploys.html#relaying-messages">Relaying Messages</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="interop/predeploys.html#optimismsuperchainerc20factory">OptimismSuperchainERC20Factory</a>
<ul>
<li><a href="interop/predeploys.html#optimismsuperchainerc20">OptimismSuperchainERC20</a></li>
<li><a href="interop/predeploys.html#overview-1">Overview</a>
<ul>
<li><a href="interop/predeploys.html#proxy">Proxy</a></li>
<li><a href="interop/predeploys.html#beacon-pattern">Beacon Pattern</a></li>
<li><a href="interop/predeploys.html#deployment-history">Deployment history</a></li>
</ul>
</li>
<li><a href="interop/predeploys.html#functions-1">Functions</a>
<ul>
<li><a href="interop/predeploys.html#deploy"><code>deploy</code></a></li>
</ul>
</li>
<li><a href="interop/predeploys.html#events">Events</a>
<ul>
<li><a href="interop/predeploys.html#optimismsuperchainerc20created"><code>OptimismSuperchainERC20Created</code></a></li>
</ul>
</li>
<li><a href="interop/predeploys.html#deployment-flow">Deployment Flow</a></li>
</ul>
</li>
<li><a href="interop/predeploys.html#optimismsuperchainerc20beacon">OptimismSuperchainERC20Beacon</a>
<ul>
<li><a href="interop/predeploys.html#overview-2">Overview</a></li>
</ul>
</li>
<li><a href="interop/predeploys.html#optimismmintableerc20factory">OptimismMintableERC20Factory</a>
<ul>
<li><a href="interop/predeploys.html#optimismmintableerc20">OptimismMintableERC20</a></li>
<li><a href="interop/predeploys.html#updates">Updates</a></li>
<li><a href="interop/predeploys.html#functions-2">Functions</a>
<ul>
<li><a href="interop/predeploys.html#createoptimismmintableerc20withdecimals"><code>createOptimismMintableERC20WithDecimals</code></a></li>
<li><a href="interop/predeploys.html#createoptimismmintableerc20"><code>createOptimismMintableERC20</code></a></li>
<li><a href="interop/predeploys.html#createstandardl2token"><code>createStandardL2Token</code></a></li>
</ul>
</li>
<li><a href="interop/predeploys.html#events-1">Events</a>
<ul>
<li><a href="interop/predeploys.html#optimismmintableerc20created"><code>OptimismMintableERC20Created</code></a></li>
<li><a href="interop/predeploys.html#standardl2tokencreated"><code>StandardL2TokenCreated</code></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="interop/predeploys.html#l2standardbridge">L2StandardBridge</a>
<ul>
<li><a href="interop/predeploys.html#updates-1">Updates</a>
<ul>
<li><a href="interop/predeploys.html#convert">convert</a></li>
<li><a href="interop/predeploys.html#converted"><code>Converted</code></a></li>
</ul>
</li>
<li><a href="interop/predeploys.html#invariants">Invariants</a></li>
<li><a href="interop/predeploys.html#conversion-flow">Conversion Flow</a></li>
</ul>
</li>
<li><a href="interop/predeploys.html#superchainethbridge">SuperchainETHBridge</a></li>
<li><a href="interop/predeploys.html#ethliquidity">ETHLiquidity</a></li>
<li><a href="interop/predeploys.html#superchaintokenbridge">SuperchainTokenBridge</a>
<ul>
<li><a href="interop/predeploys.html#overview-3">Overview</a></li>
<li><a href="interop/predeploys.html#functions-3">Functions</a>
<ul>
<li><a href="interop/predeploys.html#senderc20"><code>sendERC20</code></a></li>
<li><a href="interop/predeploys.html#relayerc20"><code>relayERC20</code></a></li>
</ul>
</li>
<li><a href="interop/predeploys.html#events-2">Events</a>
<ul>
<li><a href="interop/predeploys.html#senterc20"><code>SentERC20</code></a></li>
<li><a href="interop/predeploys.html#relayederc20"><code>RelayedERC20</code></a></li>
</ul>
</li>
<li><a href="interop/predeploys.html#diagram">Diagram</a></li>
<li><a href="interop/predeploys.html#invariants-1">Invariants</a></li>
</ul>
</li>
<li><a href="interop/predeploys.html#security-considerations">Security Considerations</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-41"><a class="header" href="#overview-41">Overview</a></h2>
<p>Four new system level predeploys are introduced for managing cross chain messaging and tokens, along with
an update to the <code>OptimismMintableERC20Factory</code> and <code>L2StandardBridge</code> contracts with additional functionalities.</p>
<h2 id="crossl2inbox"><a class="header" href="#crossl2inbox">CrossL2Inbox</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Constant</th><th>Value</th></tr></thead><tbody>
<tr><td>Address</td><td><code>0x4200000000000000000000000000000000000022</code></td></tr>
</tbody></table>
</div>
<p>The <code>CrossL2Inbox</code> is the system predeploy for cross chain messaging. Anyone can trigger the execution or validation
of cross chain messages, on behalf of any user.</p>
<p>To ensure safety of the protocol, the <a href="interop/./messaging.html#messaging-invariants">Message Invariants</a> must be enforced.</p>
<h3 id="access-list"><a class="header" href="#access-list">Access-list</a></h3>
<p>Execution of messages is statically pre-declared in transactions,
to ensure the cross-chain validity can be verified outside the single-chain EVM environment constraints.</p>
<p>After pre-verification of the access-list, the <code>CrossL2Inbox</code> can allow messages
to execute when there is a matching pre-verified access-list entry.</p>
<p>Each executing message is declared with 3 typed access-list entries:</p>
<ul>
<li>1: Lookup identity</li>
<li>2: Chain-ID extension</li>
<li>3: Checksum</li>
</ul>
<p>The type of entry is encoded in the first byte.
Type 0 is reserved, so valid access-list entries are always non-zero.</p>
<p>Note that the access-list entries may be de-duplicated:
the same message may be executed multiple times.</p>
<p>The access-list content might not always be a multiple of 3.</p>
<p>The access-list content is ordered:</p>
<ul>
<li>after type 1, a type 2 or 3 entry is expected.</li>
<li>after type 2, a type 3 entry is expected.</li>
</ul>
<p>Note that type 1 and 2 are only enforced out-of-protocol:
these provide a hint, for viable block-building,
to lookup data to determine the validity of the checksum without prior transaction execution.</p>
<p>Not every access-list entry may be executed:
access-list content must not be used by applications to interpret results of transactions,
the <code>ExecutingMessage</code> event describes in detail what is executed.</p>
<p>To prevent cross-contamination of access-list contents,
the checksum entry commits to the contents of the other entries.
The checksum will be invalid if the wrong entries are interpreted with it.</p>
<p>The <code>CrossL2Inbox</code> only checks the checksum is present in the access-list:
the presence of other needed entries is enforced during pre-validation.</p>
<h4 id="type-1-lookup-identity"><a class="header" href="#type-1-lookup-identity">type 1: Lookup identity</a></h4>
<p>Packed attributes for message lookup.
This type of entry serves as hint of the message identity,
for verification of the <code>checksum</code> and is not verified in the protocol state-transition or fork-choice.</p>
<pre><code class="language-text">0..1: type byte, always 0x01
1..4: reserved, zeroed by default
4..12: big-endian uint64 chain ID
12..20: big-endian uint64, block number
20..28: big-endian uint64, timestamp
28..32: big-endian uint32, log index
</code></pre>
<p>Chain IDs larger than <code>uint64</code> are supported, with an additional chain-ID-extension entry.
The lower 64 bits of the chain-ID are always encoded in the lookup entry.</p>
<h4 id="type-2-chain-id-extension"><a class="header" href="#type-2-chain-id-extension">type 2: Chain-ID extension</a></h4>
<p>Large <code>uint256</code> Chain IDs are represented with an extension entry,
included right after the lookup identity entry.
Like the lookup identity entry, this entry-type is not verified in the protocol state-transition or fork-choice.</p>
<p>This extension entry does not have to be included for chain-IDs that fit in <code>uint64</code>.</p>
<pre><code class="language-text">0..1: type byte, always 0x02
1..8: zero bytes
8..32: upper 24 bytes of big-endian uint256 chain-ID
</code></pre>
<h4 id="type-3-checksum"><a class="header" href="#type-3-checksum">type 3: Checksum</a></h4>
<p>The checksum is a versioned hash, committing to implied attributes.
These implied attributes are compared against the full version
of the executing message by recomputing the checksum from the full version.
The full version is retrieved based on the preceding lookup entry and optional chain-ID extension.</p>
<p>The checksum is iteratively constructed:
this allows services to work with intermediate implied data.
E.g. the supervisor does not persist the <code>origin</code> or <code>msgHash</code>,
but does store a <code>logHash</code>.</p>
<pre><code class="language-text"># Syntax:
#   H(bytes): keccak256 hash function
#   ++: bytes concatenation
logHash = H(bytes20(idOrigin) ++ msgHash)
# This matches the trailing part of the lookupID
idPacked = bytes12(0) ++ idBlockNumber ++ idTimestamp ++ idLogIndex
idLogHash = H(logHash ++ idPacked)
bareChecksum = H(idLogHash ++ idChainID)
typeByte = 0x03
checksum = typeByte ++ bareChecksum[1:]
</code></pre>
<h3 id="assumptions-4"><a class="header" href="#assumptions-4">Assumptions</a></h3>
<h4 id="gas-schedule-dependencies"><a class="header" href="#gas-schedule-dependencies">Gas Schedule Dependencies</a></h4>
<p>The <code>CrossL2Inbox</code> contract's validation mechanism relies on precise gas cost calculations for storage operations.</p>
<p><code>SLOAD</code> operations cost 2100 gas for cold access and 100 gas for warm access.</p>
<p>The contract uses these gas costs to implement its validation mechanism through gas introspection.
The <code>WARM_READ_THRESHOLD</code> is set to 1000 gas, providing a safe buffer between warm (100 gas) and cold (2100 gas) access costs.</p>
<h4 id="storage-slot-calculation"><a class="header" href="#storage-slot-calculation">Storage Slot Calculation</a></h4>
<p>Storage slots are calculated using a 248-bit hash space (31 bytes), providing cryptographically secure collision resistance.
The slot calculation follows this process:</p>
<ol>
<li>The checksum is derived from the message identifier and content</li>
<li>The first byte is reserved for the type (0x03)</li>
<li>The remaining 31 bytes form the storage slot key</li>
</ol>
<p>This design ensures there are no collisions between different message types, provides deterministic slot assignment,
enables efficient slot lookup, and guarantees secure message validation.</p>
<h4 id="evm-warming-behavior"><a class="header" href="#evm-warming-behavior">EVM Warming Behavior</a></h4>
<p>The <code>CrossL2Inbox</code> contract relies on specific EVM behavior regarding storage slot warming.</p>
<ul>
<li>
<p>Per-transaction warming ensures storage warming is scoped to individual transactions.
Warm slots from previous transactions do not affect the current transaction,
and each transaction's access list operates independently.</p>
</li>
<li>
<p>When a transaction reverts, all warm slots are rolled back.
Failed transactions do not persist any warm slots,
and all access list entries are cleared on revert.</p>
</li>
<li>
<p>The access list is the exclusive mechanism for warming slots.
No other contract function may warm up storage without message validation,
and warm slots cannot be created through alternative means.</p>
</li>
</ul>
<h3 id="functions"><a class="header" href="#functions">Functions</a></h3>
<h4 id="validatemessage"><a class="header" href="#validatemessage">validateMessage</a></h4>
<p>A helper to enable contracts to provide their own public entrypoints for cross chain interactions.
Emits the <code>ExecutingMessage</code> event to signal the transaction has a cross chain message to validate.</p>
<p>The following fields are required for validating a cross chain message:</p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>_id</code></td><td><code>Identifier</code></td><td>A <a href="interop/./messaging.html#message-identifier"><code>Identifier</code></a> pointing to the initiating message.</td></tr>
<tr><td><code>_msgHash</code></td><td><code>bytes32</code></td><td>The keccak256 hash of the message payload matching the initiating message.</td></tr>
</tbody></table>
</div>
<pre><code class="language-solidity">function validateMessage(Identifier calldata _id, bytes32 _msgHash)
</code></pre>
<h3 id="executingmessage-event"><a class="header" href="#executingmessage-event"><code>ExecutingMessage</code> Event</a></h3>
<p>The <code>ExecutingMessage</code> event represents an executing message. It MUST be emitted on every call
to <code>validateMessage</code>.</p>
<pre><code class="language-solidity">event ExecutingMessage(bytes32 indexed msgHash, Identifier identifier);
</code></pre>
<p>The data encoded in the event contains the keccak hash of the <code>msg</code> and the <code>Identifier</code>.
The following pseudocode shows the deserialization:</p>
<pre><code class="language-solidity">bytes32 msgHash = log.topics[1];
Identifier identifier = abi.decode(log.data, (Identifier));
</code></pre>
<p>Emitting the hash of the message is more efficient than emitting the
message in its entirety. Equality with the initiating message can be handled off-chain through
hash comparison.</p>
<h3 id="reference-implementation"><a class="header" href="#reference-implementation">Reference implementation</a></h3>
<p>A simple implementation of the <code>validateMessage</code> function is included below.</p>
<pre><code class="language-solidity">function validateMessage(Identifier calldata _id, bytes32 _msgHash) external {
  bytes32 checksum = calculateChecksum(_id, _msgHash);

  (bool _isSlotWarm,) = _isWarm(checksum);

  if (!_isSlotWarm) revert NonDeclaredExecutingMessage();

  emit ExecutingMessage(_msgHash, _id);
}
</code></pre>
<p><code>calculateChecksum</code> implements the checksum computation (including type-byte) as defined
in the <a href="interop/predeploys.html#type-3-checksum">access-list checksum computation</a> spec.</p>
<p><code>_isWarm</code> checks that the access-list prepared the <code>checksum</code> storage key to be warm.
<strong>No other contract function may warm up this storage without message validation.</strong></p>
<p>An example of a custom entrypoint utilizing <code>validateMessage</code> to consume a known
event. Note that in this example, the contract is consuming its own event
from another chain, however <strong>any</strong> event emitted from <strong>any</strong> contract is consumable!</p>
<pre><code class="language-solidity">contract MyCrossChainApp {
    event MyCrossChainEvent();

    function sendMessage() external {
        emit MyCrossChainEvent();
    }

    function relayMessage(Identifier calldata _id, bytes calldata _msg) external {
        // Example app-level validation
        //  - Expected event via the selector (first topic)
        //  - Assertion on the expected emitter of the event
        require(MyCrossChainEvent.selector == _msg[:32]);
        require(_id.origin == address(this));

        // Authenticate this cross chain message
        CrossL2Inbox.validateMessage(_id, keccak256(_msg));

        // ABI decode the event message &amp; perform actions.
        // ...
    }
}
</code></pre>
<h3 id="deposit-handling"><a class="header" href="#deposit-handling">Deposit Handling</a></h3>
<p>Any call to the <code>CrossL2Inbox</code> that would emit an <code>ExecutingMessage</code> event will revert if the
transaction did not declare an access list including the message checksum, as
<a href="interop/predeploys.html#type-3-checksum">described above</a>. Because deposit transactions do not have access lists,
all calls to the <code>CrossL2Inbox</code> originating within a deposit transaction will revert.</p>
<h3 id="identifier-getters"><a class="header" href="#identifier-getters"><code>Identifier</code> Getters</a></h3>
<p>The <code>Identifier</code> MUST be exposed via <code>public</code> getters so that contracts can call back to authenticate
properties about the <code>_msg</code>.</p>
<h2 id="l2tol2crossdomainmessenger"><a class="header" href="#l2tol2crossdomainmessenger">L2ToL2CrossDomainMessenger</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Constant</th><th>Value</th></tr></thead><tbody>
<tr><td>Address</td><td><code>0x4200000000000000000000000000000000000023</code></td></tr>
<tr><td><code>MESSAGE_VERSION</code></td><td><code>uint256(0)</code></td></tr>
</tbody></table>
</div>
<p>The <code>L2ToL2CrossDomainMessenger</code> is a higher level abstraction on top of the <code>CrossL2Inbox</code> that
provides general message passing, utilized for secure transfers ERC20 tokens between L2 chains.
Messages sent through the <code>L2ToL2CrossDomainMessenger</code> on the source chain receive both replay protection
as well as domain binding, i.e. the executing transaction can only be valid on a single chain.</p>
<h3 id="relaymessage-invariants"><a class="header" href="#relaymessage-invariants"><code>relayMessage</code> Invariants</a></h3>
<ul>
<li>The <code>Identifier.origin</code> MUST be <code>address(L2ToL2CrossDomainMessenger)</code></li>
<li>The <code>_destination</code> chain id MUST be equal to the local chain id</li>
<li>Messages MUST NOT be relayed more than once</li>
</ul>
<h3 id="sendmessage-invariants"><a class="header" href="#sendmessage-invariants"><code>sendMessage</code> Invariants</a></h3>
<ul>
<li>Sent Messages MUST be uniquely identifiable</li>
<li>It MUST store the message hash in the <code>sentMessages</code> mapping</li>
<li>It MUST emit the <code>SentMessage</code> event</li>
</ul>
<h3 id="resendmessage-invariants"><a class="header" href="#resendmessage-invariants"><code>resendMessage</code> Invariants</a></h3>
<ul>
<li>It MUST NOT be possible to re-emit a <code>SentMessage</code> event that has not been sent</li>
<li>It MUST emit the <code>SentMessage</code> event</li>
</ul>
<h3 id="message-versioning-1"><a class="header" href="#message-versioning-1">Message Versioning</a></h3>
<p>Versioning is handled in the most significant bits of the nonce, similarly to how it is handled by
the <code>CrossDomainMessenger</code>.</p>
<pre><code class="language-solidity">function messageNonce() public view returns (uint256) {
    return Encoding.encodeVersionedNonce(nonce, MESSAGE_VERSION);
}
</code></pre>
<h3 id="interfaces"><a class="header" href="#interfaces">Interfaces</a></h3>
<p>The <code>L2ToL2CrossDomainMessenger</code> uses a similar interface to the <code>L2CrossDomainMessenger</code>, but
the <code>_minGasLimit</code> is removed to prevent complexity around EVM gas introspection and the <code>_destination</code>
chain is included instead.</p>
<h4 id="sending-messages"><a class="header" href="#sending-messages">Sending Messages</a></h4>
<p>The following function is used for sending messages between domains:</p>
<pre><code class="language-solidity">function sendMessage(uint256 _destination, address _target, bytes calldata _message) external returns (bytes32);
</code></pre>
<p>It returns the hash of the message being sent,
which is used to track whether the message has successfully been relayed.
It also emits a <code>SentMessage</code> event with the necessary metadata to execute when relayed on the destination chain.</p>
<pre><code class="language-solidity">event SentMessage(uint256 indexed destination, address indexed target, uint256 indexed messageNonce, address sender, bytes message);
</code></pre>
<p>An explicit <code>_destination</code> chain and <code>nonce</code> are used to ensure that the message can only be played on a single remote
chain a single time. The <code>_destination</code> is enforced to not be the local chain to avoid edge cases.</p>
<p>There is no need for address aliasing as the aliased address would need to commit to the source chain's chain id
to create a unique alias that commits to a particular sender on a particular domain and it is far more simple
to assert on both the address and the source chain's chain id rather than assert on an unaliased address.
In both cases, the source chain's chain id is required for security. Executing messages will never be able to
assume the identity of an account because <code>msg.sender</code> will never be the identity that initiated the message,
it will be the <code>L2ToL2CrossDomainMessenger</code> and users will need to callback to get the initiator of the message.</p>
<p>The <code>_destination</code> MUST NOT be the chain-ID of the local chain and a locally defined <code>nonce</code> MUST increment on
every call to <code>sendMessage</code>.</p>
<p>Note that <code>sendMessage</code> is not <code>payable</code>.</p>
<h3 id="re-sending-messages"><a class="header" href="#re-sending-messages">Re-sending Messages</a></h3>
<p>The <code>resendMessage</code> function is used to re-emit a <code>SentMessage</code> event for a message that has already been sent.
It will calculate the message hash using the inputs, and check that the message hash is stored in the <code>sentMessages</code>
mapping prior to emitting the <code>SentMessage</code> event.</p>
<pre><code class="language-solidity">    function resendMessage(
        uint256 _destination,
        uint256 _nonce,
        address _sender,
        address _target,
        bytes calldata _message
    )
        external;
</code></pre>
<h4 id="relaying-messages"><a class="header" href="#relaying-messages">Relaying Messages</a></h4>
<p>The following diagram shows the flow for sending a cross chain message using the <code>L2ToL2CrossDomainMessenger</code>.
Each subsequent call is labeled with a number.</p>
<pre class="mermaid">flowchart LR
    user --&gt;|&quot;1#46; sendMessage&quot;| al2tol2
    user --&gt; |&quot;2#46; relayMessage&quot;|bl2tol2
    im{{SentMessage Event}}
    em{{ExecutingMessage Event}}

    direction TB
    al2tol2 --&gt; im

    bcl2[CrossL2Inbox]
    al2tol2[L2ToL2CrossDomainMessenger]
    bl2tol2[L2ToL2CrossDomainMessenger]

    subgraph &quot;Chain A&quot;
      al2tol2
    end

    subgraph &quot;Chain B&quot;
      bl2tol2  --&gt; |&quot;3#46; validateMessage&quot;|bcl2
      bcl2 --&gt; em
      bl2tol2 --&gt; |&quot;4#46;&quot;| Contract
    end
</pre>
<p>When relaying a message through the <code>L2ToL2CrossDomainMessenger</code>, it is important to require that
the <code>_destination</code> be equal to <code>block.chainid</code> to ensure that the message is only valid on a single
chain. The hash of the message is used for replay protection.</p>
<p>It is important to ensure that the source chain is in the dependency set of the destination chain, otherwise
it is possible to send a message that is not playable.</p>
<p>A message is relayed by providing the <a href="interop/./messaging.html#message-identifier">identifier</a> of a <code>SentMessage</code>
event along with its corresponding <a href="interop/./messaging.html#message-payload">message payload</a>.</p>
<pre><code class="language-solidity">function relayMessage(ICrossL2Inbox.Identifier calldata _id, bytes calldata _sentMessage) external payable returns (bytes memory returnData_) {
    require(_id.origin == Predeploys.L2_TO_L2_CROSS_DOMAIN_MESSENGER);
    CrossL2Inbox(Predeploys.CROSS_L2_INBOX).validateMessage(_id, keccak256(_sentMessage));

    // log topics
    (bytes32 selector, uint256 _destination, address _target, uint256 _nonce) =
        abi.decode(_sentMessage[:128], (bytes32,uint256,address,uint256));

    require(selector == SentMessage.selector);
    require(_destination == block.chainid);

    // log data
    (address _sender, bytes memory _message) = abi.decode(_sentMessage[128:], (address,bytes));

    bool success;
    (success, returnData_) = _target.call(_target, msg.value, _message);
    require(success);
    successfulMessages[messageHash] = true;
    emit RelayedMessage(_source, _nonce, messageHash, keccack256(returnData_));
}
</code></pre>
<p>Upon successful delivery, an event is emitted with useful information. Notably the hash of the <code>returnData</code> that
can be used to continue execution for anyone that depends on it without needing an explicit callback message to
be sent back.</p>
<pre><code class="language-solidity">event RelayedMessage(uint256 indexed source, uint256 indexed messageNonce, bytes32 indexed messageHash, bytes32 returnDataHash);
</code></pre>
<p>Note that the <code>relayMessage</code> function is <code>payable</code> to enable relayers to earn in the gas paying asset.</p>
<p>To enable cross chain authorization patterns, both the <code>_sender</code> and the <code>_source</code> MUST be exposed via <code>public</code>
getters.</p>
<h2 id="optimismsuperchainerc20factory"><a class="header" href="#optimismsuperchainerc20factory">OptimismSuperchainERC20Factory</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Constant</th><th>Value</th></tr></thead><tbody>
<tr><td>Address</td><td><code>0x4200000000000000000000000000000000000026</code></td></tr>
</tbody></table>
</div>
<h3 id="optimismsuperchainerc20"><a class="header" href="#optimismsuperchainerc20">OptimismSuperchainERC20</a></h3>
<p>The <code>OptimismSuperchainERC20Factory</code> creates ERC20 contracts that implements the <code>SuperchainERC20</code> <a href="interop/token-bridging.html">standard</a>,
grants mint-burn rights to the <code>L2StandardBridge</code> (<code>OptimismSuperchainERC20</code>)
and includes a <code>remoteToken</code> variable.
These ERC20s are called <code>OptimismSuperchainERC20</code> and can be converted back and forth with <code>OptimismMintableERC20</code> tokens.
The goal of the <code>OptimismSuperchainERC20</code> is to extend functionalities
of the <code>OptimismMintableERC20</code> so that they are interop compatible.</p>
<h3 id="overview-42"><a class="header" href="#overview-42">Overview</a></h3>
<p>Anyone can deploy <code>OptimismSuperchainERC20</code> contracts by using the <code>OptimismSuperchainERC20Factory</code>.</p>
<h4 id="proxy"><a class="header" href="#proxy">Proxy</a></h4>
<p>The <code>OptimismSuperchainERC20Factory</code> MUST be a proxied predeploy.
It follows the
<a href="https://github.com/ethereum-optimism/optimism/blob/v1.1.4/packages/contracts-bedrock/src/universal/Proxy.sol"><code>Proxy.sol</code> implementation</a>
and <code>delegatecall()</code> to the factory implementation address.</p>
<h4 id="beacon-pattern"><a class="header" href="#beacon-pattern">Beacon Pattern</a></h4>
<p>It MUST deploy <code>OptimismSuperchainERC20</code> as
<a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/proxy/beacon/BeaconProxy.sol">BeaconProxies</a>,
as this is the easiest way to upgrade multiple contracts simultaneously.
Each BeaconProxy delegatecalls to the implementation address provided by the Beacon Contract.</p>
<p>The implementation MUST include an <code>initialize</code> function that
receives <code>(address _remoteToken, string _name, string _symbol, uint8 _decimals)</code> and stores these in the BeaconProxy storage.</p>
<h4 id="deployment-history"><a class="header" href="#deployment-history">Deployment history</a></h4>
<p>The <code>L2StandardBridge</code> includes a <code>convert()</code> function that allows anyone to convert
between any <code>OptimismMintableERC20</code> and its corresponding <code>OptimismSuperchainERC20</code>.
For this method to work, the <code>OptimismSuperchainERC20Factory</code> MUST include a deployment history.</p>
<h3 id="functions-1"><a class="header" href="#functions-1">Functions</a></h3>
<h4 id="deploy"><a class="header" href="#deploy"><code>deploy</code></a></h4>
<p>Creates an instance of the <code>OptimismSuperchainERC20</code> contract with a set of metadata defined by:</p>
<ul>
<li><code>_remoteToken</code>: address of the underlying token in its native chain.</li>
<li><code>_name</code>: <code>OptimismSuperchainERC20</code> name</li>
<li><code>_symbol</code>: <code>OptimismSuperchainERC20</code> symbol</li>
<li><code>_decimals</code>: <code>OptimismSuperchainERC20</code> decimals</li>
</ul>
<pre><code class="language-solidity">function deploy(address _remoteToken, string memory _name, string memory _symbol, uint8 _decimals) returns (address)
</code></pre>
<p>It returns the address of the deployed <code>OptimismSuperchainERC20</code>.</p>
<p>The function MUST use <code>CREATE3</code> to deploy its children.
This ensures the same address deployment across different chains,
which is necessary for the <a href="interop/token-bridging.html">standard</a> implementation.</p>
<p>The salt used for deployment MUST be computed by applying <code>keccak256</code> to the <code>abi.encode</code>
of the input parameters (<code>_remoteToken</code>, <code>_name</code>, <code>_symbol</code>, and <code>_decimals</code>).
This implies that the same L1 token can have multiple <code>OptimismSuperchainERC20</code> representations as long as the metadata changes.</p>
<p>The function MUST store the <code>_remoteToken</code> address for each deployed <code>OptimismSuperchainERC20</code> in a <code>deployments</code> mapping.</p>
<h3 id="events"><a class="header" href="#events">Events</a></h3>
<h4 id="optimismsuperchainerc20created"><a class="header" href="#optimismsuperchainerc20created"><code>OptimismSuperchainERC20Created</code></a></h4>
<p>It MUST trigger when <code>deploy</code> is called.</p>
<pre><code class="language-solidity">event OptimismSuperchainERC20Created(address indexed superchainToken, address indexed remoteToken, address deployer);
</code></pre>
<p>where <code>superchainToken</code> is the address of the newly deployed <code>OptimismSuperchainERC20</code>,
<code>remoteToken</code> is the address of the corresponding token in L1,
and deployer<code>is the</code>msg.sender`.</p>
<h3 id="deployment-flow"><a class="header" href="#deployment-flow">Deployment Flow</a></h3>
<pre class="mermaid">sequenceDiagram
  participant Alice
  participant FactoryProxy
  participant FactoryImpl
  participant BeaconProxy as OptimismSuperchainERC20 BeaconProxy
  participant Beacon Contract
  participant Implementation
  Alice-&gt;&gt;FactoryProxy: deploy(remoteToken, name, symbol, decimals)
  FactoryProxy-&gt;&gt;FactoryImpl: delegatecall()
  FactoryProxy-&gt;&gt;BeaconProxy: deploy with CREATE3
  FactoryProxy--&gt;FactoryProxy: deployments[superchainToken]=remoteToken
  FactoryProxy--&gt;FactoryProxy: emit OptimismSuperchainERC20Created(superchainToken, remoteToken, Alice)
  BeaconProxy--&gt;Beacon Contract: reads implementation()
  BeaconProxy-&gt;&gt;Implementation: delegatecall()
  BeaconProxy-&gt;&gt;Implementation: initialize()
</pre>
<h2 id="optimismsuperchainerc20beacon"><a class="header" href="#optimismsuperchainerc20beacon">OptimismSuperchainERC20Beacon</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Constant</th><th>Value</th></tr></thead><tbody>
<tr><td>Address</td><td><code>0x4200000000000000000000000000000000000027</code></td></tr>
</tbody></table>
</div>
<h3 id="overview-43"><a class="header" href="#overview-43">Overview</a></h3>
<p>The <code>OptimismSuperchainERC20Beacon</code> predeploy gets called by the <code>OptimismSuperchainERC20</code>
BeaconProxies deployed by the
<a href="interop/predeploys.html#optimismsuperchainerc20factory"><code>SuperchainERC20Factory</code></a></p>
<p>The Beacon Contract implements the interface defined
in <a href="https://eips.ethereum.org/EIPS/eip-1967">EIP-1967</a>.</p>
<p>The implementation address gets deduced similarly to the <code>GasPriceOracle</code> address in Ecotone and Fjord updates.</p>
<h2 id="optimismmintableerc20factory-2"><a class="header" href="#optimismmintableerc20factory-2">OptimismMintableERC20Factory</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Constant</th><th>Value</th></tr></thead><tbody>
<tr><td>Address</td><td><code>0x4200000000000000000000000000000000000012</code></td></tr>
</tbody></table>
</div>
<h3 id="optimismmintableerc20"><a class="header" href="#optimismmintableerc20">OptimismMintableERC20</a></h3>
<p>The <code>OptimismMintableERC20Factory</code> creates ERC20 contracts on L2 that can be used to deposit
native L1 tokens into (<code>OptimismMintableERC20</code>). Anyone can deploy <code>OptimismMintableERC20</code> contracts.</p>
<p>Each <code>OptimismMintableERC20</code> contract created by the <code>OptimismMintableERC20Factory</code>
allows for the <code>L2StandardBridge</code> to mint
and burn tokens, depending on whether the user is
depositing from L1 to L2 or withdrawing from L2 to L1.</p>
<h3 id="updates"><a class="header" href="#updates">Updates</a></h3>
<p>The <code>OptimismMintableERC20Factory</code> is updated to include a <code>deployments</code> mapping
that stores the <code>remoteToken</code> address for each deployed <code>OptimismMintableERC20</code>.
This is essential for the liquidity migration process defined in the liquidity migration spec.</p>
<h3 id="functions-2"><a class="header" href="#functions-2">Functions</a></h3>
<h4 id="createoptimismmintableerc20withdecimals"><a class="header" href="#createoptimismmintableerc20withdecimals"><code>createOptimismMintableERC20WithDecimals</code></a></h4>
<p>Creates an instance of the <code>OptimismMintableERC20</code> contract with a set of metadata defined by:</p>
<ul>
<li><code>_remoteToken</code>: address of the underlying token in its native chain.</li>
<li><code>_name</code>: <code>OptimismMintableERC20</code> name</li>
<li><code>_symbol</code>: <code>OptimismMintableERC20</code> symbol</li>
<li><code>_decimals</code>: <code>OptimismMintableERC20</code> decimals</li>
</ul>
<pre><code class="language-solidity">createOptimismMintableERC20WithDecimals(address _remoteToken, string memory _name, string memory _symbol, uint8 _decimals) returns (address)
</code></pre>
<p><strong>Invariants</strong></p>
<ul>
<li>The function MUST use <code>CREATE2</code> to deploy new contracts.</li>
<li>The salt MUST be computed by applying <code>keccak256</code> to the <code>abi.encode</code>
of the four input parameters (<code>_remoteToken</code>, <code>_name</code>, <code>_symbol</code>, and <code>_decimals</code>).
This ensures a unique <code>OptimismMintableERC20</code> for each set of ERC20 metadata.</li>
<li>The function MUST store the <code>_remoteToken</code> address for each deployed <code>OptimismMintableERC20</code> in a <code>deployments</code> mapping.</li>
</ul>
<h4 id="createoptimismmintableerc20"><a class="header" href="#createoptimismmintableerc20"><code>createOptimismMintableERC20</code></a></h4>
<p>Creates an instance of the <code>OptimismMintableERC20</code> contract with a set of metadata defined
by <code>_remoteToken</code>, <code>_name</code> and <code>_symbol</code> and fixed <code>decimals</code> to the standard value 18.</p>
<pre><code class="language-solidity">createOptimismMintableERC20(address _remoteToken, string memory _name, string memory _symbol) returns (address)
</code></pre>
<h4 id="createstandardl2token"><a class="header" href="#createstandardl2token"><code>createStandardL2Token</code></a></h4>
<p>Creates an instance of the <code>OptimismMintableERC20</code> contract with a set of metadata defined
by <code>_remoteToken</code>, <code>_name</code> and <code>_symbol</code> and fixed <code>decimals</code> to the standard value 18.</p>
<pre><code class="language-solidity">createStandardL2Token(address _remoteToken, string memory _name, string memory _symbol) returns (address)
</code></pre>
<p>This function exists for backwards compatibility with the legacy version.</p>
<h3 id="events-1"><a class="header" href="#events-1">Events</a></h3>
<h4 id="optimismmintableerc20created"><a class="header" href="#optimismmintableerc20created"><code>OptimismMintableERC20Created</code></a></h4>
<p>It MUST trigger when <code>createOptimismMintableERC20WithDecimals</code>,
<code>createOptimismMintableERC20</code> or <code>createStandardL2Token</code> is called.</p>
<pre><code class="language-solidity">event OptimismMintableERC20Created(address indexed localToken, address indexed remoteToken, address deployer);
</code></pre>
<h4 id="standardl2tokencreated"><a class="header" href="#standardl2tokencreated"><code>StandardL2TokenCreated</code></a></h4>
<p>It MUST trigger when <code>createOptimismMintableERC20WithDecimals</code>,
<code>createOptimismMintableERC20</code> or <code>createStandardL2Token</code> is called.
This event exists for backward compatibility with legacy version.</p>
<pre><code class="language-solidity">event StandardL2TokenCreated(address indexed remoteToken, address indexed localToken);
</code></pre>
<h2 id="l2standardbridge-2"><a class="header" href="#l2standardbridge-2">L2StandardBridge</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Constant</th><th>Value</th></tr></thead><tbody>
<tr><td>Address</td><td><code>0x4200000000000000000000000000000000000010</code></td></tr>
</tbody></table>
</div>
<h3 id="updates-1"><a class="header" href="#updates-1">Updates</a></h3>
<p>The <code>OptimismMintableERC20</code> and <code>L2StandardToken</code> tokens (<em>legacy tokens</em>),
which correspond to locked liquidity in L1, are incompatible with interop.
Legacy token owners must convert into a <code>OptimismSuperchainERC20</code> representation that implements the <a href="interop/token-bridging.html">standard</a>,
to move across the Superchain.</p>
<p>The conversion method uses the <code>L2StandardBridge</code> mint/burn rights
over the legacy tokens to allow easy migration to and from the
corresponding <code>OptimismSuperchainERC20</code>.</p>
<h4 id="convert"><a class="header" href="#convert">convert</a></h4>
<p>The <code>L2StandardBridge</code> SHOULD add a <code>convert</code> public function that
converts <code>_amount</code> of <code>_from</code> token to <code>_amount</code> of <code>_to</code> token,
if and only if the token addresses are valid (as defined below).</p>
<pre><code class="language-solidity">function convert(address _from, address _to, uint256 _amount)
</code></pre>
<p>The function</p>
<ol>
<li>Checks that <code>_from</code> and <code>_to</code> addresses are valid, paired and have the same amount of decimals.</li>
<li>Burns <code>_amount</code> of <code>_from</code> from <code>msg.sender</code>.</li>
<li>Mints <code>_amount</code> of <code>_to</code> to <code>msg.sender</code>.</li>
</ol>
<h4 id="converted"><a class="header" href="#converted"><code>Converted</code></a></h4>
<p>The <code>L2StandardBridge</code> SHOULD include a <code>Converted</code> event
that MUST trigger when anyone converts tokens
with <code>convert</code>.</p>
<pre><code class="language-solidity">event Converted(address indexed from, address indexed to, address indexed caller, uint256 amount);
</code></pre>
<p>where <code>from</code> is the address of the input token, <code>to</code> is the address of the output token,
<code>caller</code> is the <code>msg.sender</code> of the function call and <code>amount</code> is the converted amount.</p>
<h3 id="invariants-6"><a class="header" href="#invariants-6">Invariants</a></h3>
<p>The <code>convert</code> function conserves the following invariants:</p>
<ul>
<li>Conservation of amount:
The burnt amount should match the minted amount.</li>
<li>Revert for non valid or non paired: <code>convert</code> SHOULD revert when called with:
<ul>
<li>Tokens with different decimals.</li>
<li>Legacy tokens that are not in the <code>deployments</code> mapping from the <code>OptimismMintableERC20Factory</code>.</li>
<li><code>OptimismSuperchainERC20</code> that are not in the <code>deployments</code> mapping from the <code>OptimismSuperchainERC20Factory</code>.</li>
<li>Legacy tokens and <code>OptimismSuperchainERC20s</code>s
corresponding to different
remote token addresses.</li>
</ul>
</li>
<li>Freedom of conversion for valid and paired tokens:
anyone can convert between allowed legacy representations and
valid <code>OptimismSuperchainERC20</code> corresponding to the same remote token.</li>
</ul>
<h3 id="conversion-flow"><a class="header" href="#conversion-flow">Conversion Flow</a></h3>
<pre class="mermaid">---
config:
  theme: dark
  fontSize: 28
---
sequenceDiagram
  participant Alice
  participant L2StandardBridge
  participant factory as OptimismMintableERC20Factory
  participant superfactory as OptimismSuperchainERC20Factory
  participant legacy as from Token
  participant SuperERC20 as to Token

  Alice-&gt;&gt;L2StandardBridge: convert(from, to, amount)
  L2StandardBridge--&gt;factory: check legacy token is allowed
  L2StandardBridge--&gt;superfactory: check super token is allowed
  L2StandardBridge--&gt;L2StandardBridge: checks matching remote and decimals
  L2StandardBridge-&gt;&gt;legacy: IERC20(from).burn(Alice, amount)
  L2StandardBridge-&gt;&gt;SuperERC20: IERC20(to).mint(Alice, amount)
  L2StandardBridge--&gt;L2StandardBridge: emit Converted(from, to, Alice, amount)
</pre>
<h2 id="superchainethbridge"><a class="header" href="#superchainethbridge">SuperchainETHBridge</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Constant</th><th>Value</th></tr></thead><tbody>
<tr><td>Address</td><td><code>0x4200000000000000000000000000000000000024</code></td></tr>
</tbody></table>
</div>
<p>See the <a href="interop/./superchain-eth-bridge.html">SuperchainETHBridge</a> spec for the design of the <code>SuperchainETHBridge</code> predeploy.</p>
<h2 id="ethliquidity"><a class="header" href="#ethliquidity">ETHLiquidity</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Constant</th><th>Value</th></tr></thead><tbody>
<tr><td>Address</td><td><code>0x4200000000000000000000000000000000000025</code></td></tr>
</tbody></table>
</div>
<p>See the <a href="interop/./eth-liquidity.html">ETHLiquidity</a> spec for the design of the <code>ETHLiquidity</code> contract.</p>
<h2 id="superchaintokenbridge"><a class="header" href="#superchaintokenbridge">SuperchainTokenBridge</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Constant</th><th>Value</th></tr></thead><tbody>
<tr><td>Address</td><td><code>0x4200000000000000000000000000000000000028</code></td></tr>
</tbody></table>
</div>
<h3 id="overview-44"><a class="header" href="#overview-44">Overview</a></h3>
<p>The <code>SuperchainTokenBridge</code> is an abstraction on top of the <code>L2toL2CrossDomainMessenger</code>
that facilitates token bridging using interop.
It has mint and burn rights over <code>SuperchainERC20</code> tokens
as described in the <a href="interop/./token-bridging.html">token bridging spec</a>.</p>
<h3 id="functions-3"><a class="header" href="#functions-3">Functions</a></h3>
<h4 id="senderc20"><a class="header" href="#senderc20"><code>sendERC20</code></a></h4>
<p>Initializes a transfer of <code>_amount</code> amount of tokens with address <code>_tokenAddress</code> to target address <code>_to</code> in chain <code>_chainId</code>.</p>
<p>It SHOULD burn <code>_amount</code> tokens with address <code>_tokenAddress</code> and initialize a message to the
<code>L2ToL2CrossChainMessenger</code> to mint the <code>_amount</code> of the same token
in the target address <code>_to</code> at <code>_chainId</code> and emit the <code>SentERC20</code> event including the <code>msg.sender</code> as parameter.</p>
<p>To burn the token, the <code>sendERC20</code> function
calls <code>crosschainBurn</code> in the token contract,
which is included as part of the
<a href="https://github.com/ethereum/ERCs/pull/692"><code>IERC7802</code> interface</a>
implemented by the <code>SuperchainERC20</code> standard.</p>
<p>Returns the <code>msgHash_</code> crafted by the <code>L2ToL2CrossChainMessenger</code>.</p>
<pre><code class="language-solidity">function sendERC20(address _tokenAddress, address _to, uint256 _amount, uint256 _chainId) returns (bytes32 msgHash_)
</code></pre>
<h4 id="relayerc20"><a class="header" href="#relayerc20"><code>relayERC20</code></a></h4>
<p>Process incoming messages IF AND ONLY IF initiated
by the same contract (bridge) address on a different chain
and relayed from the <code>L2ToL2CrossChainMessenger</code> in the local chain.
It SHOULD mint <code>_amount</code> of tokens with address <code>_tokenAddress</code> to address <code>_to</code>, as defined in <code>sendERC20</code>
and emit an event including the <code>_tokenAddress</code>, the <code>_from</code> and chain id from the
<code>source</code> chain, where <code>_from</code> is the <code>msg.sender</code> of <code>sendERC20</code>.</p>
<p>To mint the token, the <code>relayERC20</code> function
calls <code>crosschainMint</code> in the token contract,
which is included as part of the
<a href="https://github.com/ethereum/ERCs/pull/692"><code>IERC7802</code> interface</a>
implemented by the <code>SuperchainERC20</code> standard.</p>
<pre><code class="language-solidity">function relayERC20(address _tokenAddress, address _from, address _to, uint256 _amount)
</code></pre>
<h3 id="events-2"><a class="header" href="#events-2">Events</a></h3>
<h4 id="senterc20"><a class="header" href="#senterc20"><code>SentERC20</code></a></h4>
<p>MUST trigger when a cross-chain transfer is initiated using <code>sendERC20</code>.</p>
<pre><code class="language-solidity">event SentERC20(address indexed tokenAddress, address indexed from, address indexed to, uint256 amount, uint256 destination)
</code></pre>
<h4 id="relayederc20"><a class="header" href="#relayederc20"><code>RelayedERC20</code></a></h4>
<p>MUST trigger when a cross-chain transfer is finalized using <code>relayERC20</code>.</p>
<pre><code class="language-solidity">event RelayedERC20(address indexed tokenAddress, address indexed from, address indexed to, uint256 amount, uint256 source);
</code></pre>
<h3 id="diagram"><a class="header" href="#diagram">Diagram</a></h3>
<p>The following diagram depicts a cross-chain transfer.</p>
<pre class="mermaid">---
config:
  theme: dark
  fontSize: 48
---
sequenceDiagram
  participant from
  participant L2SBA as SuperchainTokenBridge (Chain A)
  participant SuperERC20_A as SuperchainERC20 (Chain A)
  participant Messenger_A as L2ToL2CrossDomainMessenger (Chain A)
  participant Inbox as CrossL2Inbox
  participant Messenger_B as L2ToL2CrossDomainMessenger (Chain B)
  participant L2SBB as SuperchainTokenBridge (Chain B)
  participant SuperERC20_B as SuperchainERC20 (Chain B)

  from-&gt;&gt;L2SBA: sendERC20(tokenAddr, to, amount, chainID)
  L2SBA-&gt;&gt;SuperERC20_A: crosschainBurn(from, amount)
  SuperERC20_A--&gt;SuperERC20_A: emit CrosschainBurn(from, amount)
  L2SBA-&gt;&gt;Messenger_A: sendMessage(chainId, message)
  Messenger_A-&gt;&gt;L2SBA: return msgHash_
  L2SBA--&gt;L2SBA: emit SentERC20(tokenAddr, from, to, amount, destination)
  L2SBA-&gt;&gt;from: return msgHash_
  Inbox-&gt;&gt;Messenger_B: relayMessage()
  Messenger_B-&gt;&gt;L2SBB: relayERC20(tokenAddr, from, to, amount)
  L2SBB-&gt;&gt;SuperERC20_B: crosschainMint(to, amount)
  SuperERC20_B--&gt;SuperERC20_B: emit CrosschainMint(to, amount)
  L2SBB--&gt;L2SBB: emit RelayedERC20(tokenAddr, from, to, amount, source)
</pre>
<h3 id="invariants-7"><a class="header" href="#invariants-7">Invariants</a></h3>
<p>The bridging of <code>SuperchainERC20</code> using the <code>SuperchainTokenBridge</code> will require the following invariants:</p>
<ul>
<li>Conservation of bridged <code>amount</code>: The minted <code>amount</code> in <code>relayERC20()</code> should match the <code>amount</code>
that was burnt in <code>sendERC20()</code>, as long as target chain has the initiating chain in the dependency set.
<ul>
<li>Corollary 1: Finalized cross-chain transactions will conserve the sum of <code>totalSupply</code>
and each user's balance for each chain in the Superchain.</li>
<li>Corollary 2: Each initiated but not finalized message (included in initiating chain but not yet in target chain)
will decrease the <code>totalSupply</code> and the initiating user balance precisely by the burnt <code>amount</code>.</li>
<li>Corollary 3: <code>SuperchainERC20s</code> should not charge a token fee or increase the balance when moving cross-chain.</li>
<li>Note: if the target chain is not in the initiating chain dependency set,
funds will be locked, similar to sending funds to the wrong address.
If the target chain includes it later, these could be unlocked.</li>
</ul>
</li>
<li>Freedom of movement: Users should be able to send and receive tokens in any target
chain with the initiating chain in its dependency set
using <code>sendERC20()</code> and <code>relayERC20()</code>, respectively.</li>
<li>Unique Messenger: The <code>sendERC20()</code> function must exclusively use the <code>L2toL2CrossDomainMessenger</code> for messaging.
Similarly, the <code>relayERC20()</code> function should only process messages originating from the <code>L2toL2CrossDomainMessenger</code>.</li>
<li>Unique Address: The <code>sendERC20()</code> function must exclusively send a message
to the same address on the target chain.
Similarly, the <code>relayERC20()</code> function should only process messages originating from the same address.
<ul>
<li>Note: The <a href="interop/../protocol/preinstalls.html#create2deployer"><code>Create2Deployer</code> preinstall</a>
and the custom Factory will ensure same address deployment.</li>
</ul>
</li>
<li>Locally initiated: The bridging action should be initialized
from the chain where funds are located only.
<ul>
<li>This is because the same address might correspond to different users cross-chain.
For example, two SAFEs with the same address in two chains might have different owners.
With the prospects of a smart wallet future, it is impossible to assume
there will be a way to distinguish EOAs from smart wallets.</li>
<li>A way to allow for remotely initiated bridging is to include remote approval,
i.e. approve a certain address in a certain chainId to spend local funds.</li>
</ul>
</li>
<li>Bridge Events:
<ul>
<li><code>sendERC20()</code> should emit a <code>SentERC20</code> event.</li>
<li><code>relayERC20()</code> should emit a <code>RelayedERC20</code> event.</li>
</ul>
</li>
</ul>
<h2 id="security-considerations-9"><a class="header" href="#security-considerations-9">Security Considerations</a></h2>
<p>TODO</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="sequencer"><a class="header" href="#sequencer">Sequencer</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="interop/sequencer.html#overview">Overview</a></li>
<li><a href="interop/sequencer.html#block-building">Block Building</a></li>
<li><a href="interop/sequencer.html#sequencer-policy">Sequencer Policy</a>
<ul>
<li><a href="interop/sequencer.html#safety-levels">Safety Levels</a>
<ul>
<li><a href="interop/sequencer.html#executing-message-validation">Executing Message Validation</a></li>
<li><a href="interop/sequencer.html#transitive-dependencies">Transitive Dependencies</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="interop/sequencer.html#shared-sequencing">Shared Sequencing</a></li>
<li><a href="interop/sequencer.html#security-considerations">Security Considerations</a>
<ul>
<li><a href="interop/sequencer.html#depending-on-preconfirmations">Depending on Preconfirmations</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-45"><a class="header" href="#overview-45">Overview</a></h2>
<p>New validity rules are added to blocks that the sequencer must follow. If the
new rules are not followed, then the sequencer risks producing empty blocks
and reorg'ing the chain.</p>
<p>The term "block builder" is used interchangeably with the term "sequencer" for the purposes of this document but
they need not be the same entity in practice.</p>
<h2 id="block-building"><a class="header" href="#block-building">Block Building</a></h2>
<p>It is now required that a block builder fully executes a transaction and validates any executing messages
that it may produce before knowing that the transaction is valid. This adds a denial of service possibility
for the block builder. It is generally accepted that block builders can be sophisticated actors that can
build solutions for this sort of problem.</p>
<h2 id="sequencer-policy"><a class="header" href="#sequencer-policy">Sequencer Policy</a></h2>
<p>Sequencer policy represents the set of ways that a sequencer may act that are not constrained by consensus.
The ordering of transactions in a block is considered policy, consensus dictates that all of the transactions
in a block are valid.</p>
<p>OP Stack interop leverages sequencer policy to reduce synchrony assumptions between chains.
If the sequencer's view of a remote chain lags from the tip, it will not impact the overall liveness of
the network, it will only impact the liveness of inbound cross chain messages from that remote chain.
If there was a strict synchrony assumption, it could result in liveness or safety failures when any sequencer
in the cluster falls behind the tip of any remote chain.</p>
<h3 id="safety-levels"><a class="header" href="#safety-levels">Safety Levels</a></h3>
<p>The sequencer MAY include an executing message with any level of confirmation safety.
Including cross chain messages based on preconfirmation levels of security results
in lower latency messaging at a higher risk of an invalid block being produced.</p>
<p>The sequencer MAY require different levels of security depending on the source chain.
If the block containing the initiating message is considered safe, no additional trust
assumptions are assumed. The only time that additional trust assumptions are added is
when an initiating message from an unsafe block is consumed.</p>
<p>It is recommended to leverage the <a href="interop/./supervisor.html">supervisor</a> API to validate messages.</p>
<h4 id="executing-message-validation"><a class="header" href="#executing-message-validation">Executing Message Validation</a></h4>
<p>The block builder SHOULD validate executing messages directly before including the transaction
that produced the executing message in a block. Given the async nature of many independent chains
operating in parallel, it is possible that the block builder does not have the most up to date
view of all remote chains at any given moment.</p>
<p>The block builder MAY require cryptographic proof of the existence of the log
that the identifier points to, if it trusts the remote canonical chain but not its RPC server.</p>
<p>The block builder MAY also trust a remote RPC and use the following algorithm to verify the
existence of the log. This algorithm does not check for a particular finality level of the
block that includes the initiating message.</p>
<pre><code class="language-python">success, receipt = evm.apply_transaction(tx)

# no logs are produced for reverting transactions
if not success:
  return True

# iterate over all of the logs
for log in receipt.logs:
  if is_executing_message(log):
      id = abi.decode(log.data)
      message_hash = log.topics[1]

      # maintain a RPC client for each remote node by chainid
      eth = clients[id.chainid]

      # cannot verify messages without a client, do not include it
      if eth is None:
        return False

      # use the identifier to fetch logs
      logs = eth.get_logs(id.origin, from=id.block_number, to=id.block_number)
      filtered = filter(lambda x: x.index == id.log_index &amp;&amp; x.address == id.origin)
      # log does not exist, do not include it
      if len(filtered) != 1:
        return False

      # ensure the contents of the log are correct
      log = encode(filtered[0])
      if message_hash != keccack256(log):
        return False

      block = eth.get_block_by_number(id.blocknumber)

      # ensure that the timestamp is correct
      if id.timestamp != block.timestamp:
        return False

return True
</code></pre>
<h4 id="transitive-dependencies-1"><a class="header" href="#transitive-dependencies-1">Transitive Dependencies</a></h4>
<p>The safety of a block is inherently tied to the safety of the blocks that include initiating messages
consumed. This applies recursively, so a block builder that wants to only include safe cross chain
messages will need to recursively check that all dependencies are safe.</p>
<h2 id="shared-sequencing"><a class="header" href="#shared-sequencing">Shared Sequencing</a></h2>
<p>A shared sequencer can be built if the block builder is able to build the next canonical block
for multiple chains. This can enable synchronous composability where transactions are able
to execute across multiple chains at the same timestamp.</p>
<h2 id="security-considerations-10"><a class="header" href="#security-considerations-10">Security Considerations</a></h2>
<h3 id="depending-on-preconfirmations"><a class="header" href="#depending-on-preconfirmations">Depending on Preconfirmations</a></h3>
<p>If a local sequencer is accepting inbound cross chain transactions where the initiating message only has preconfirmation
levels of security, this means that the remote sequencer can trigger a reorg on the local chain.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="verifier"><a class="header" href="#verifier">Verifier</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="interop/verifier.html#driver">Driver</a>
<ul>
<li><a href="interop/verifier.html#safety">Safety</a>
<ul>
<li><a href="interop/verifier.html#unsafe-inputs"><code>unsafe</code> Inputs</a></li>
<li><a href="interop/verifier.html#cross-unsafe-inputs"><code>cross-unsafe</code> Inputs</a></li>
<li><a href="interop/verifier.html#safe-inputs"><code>safe</code> Inputs</a></li>
<li><a href="interop/verifier.html#finalized-inputs"><code>finalized</code> Inputs</a></li>
</ul>
</li>
<li><a href="interop/verifier.html#honest-verifier">Honest Verifier</a></li>
</ul>
</li>
<li><a href="interop/verifier.html#security-considerations">Security Considerations</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="driver-1"><a class="header" href="#driver-1">Driver</a></h2>
<p>The driver is responsible for validating L2 blocks and promoting them from unsafe
to safe. A series of invariants are enforced before promotion.</p>
<h3 id="safety"><a class="header" href="#safety">Safety</a></h3>
<p>Safety is an abstraction that is useful for reasoning about the security of L2 blocks.
It is a spectrum from <code>unsafe</code> to <code>finalized</code>. Users can choose to operate on L2 data
based on its level of safety, taking into account their risk profile and personal preferences.</p>
<p>The following labels are used to describe both inputs and outputs:</p>
<ul>
<li><code>unsafe</code></li>
<li><code>cross-unsafe</code></li>
<li><code>safe</code></li>
<li><code>finalized</code></li>
</ul>
<p>Inputs correspond to the inputs to the state transition function while, outputs correspond to the side
effects of the state transition function.</p>
<p>Anything before <code>safe</code> technically uses a "preconfirmation" based security model which is not part
of consensus. While useful to have definitions of the default meanings of these terms, they are
technically policy and may be changed in the future.</p>
<p>The <code>unsafe</code> label has the lowest latency while the <code>finalized</code> label has the highest latency.
A set of invariants must be held true before an input or an output can be promoted to the next
label, starting at <code>unsafe</code>.</p>
<p>The initiating messages for all dependent executing messages MUST be resolved as safe before an L2 block can transition
from being unsafe to safe. Users MAY optimistically accept unsafe blocks without any verification of the
executing messages. They SHOULD optimistically verify the initiating messages exist in destination unsafe blocks
to more quickly reorganize out invalid blocks.</p>
<h4 id="unsafe-inputs"><a class="header" href="#unsafe-inputs"><code>unsafe</code> Inputs</a></h4>
<ul>
<li>MUST be signed by the p2p sequencer key</li>
<li>MAY be reorganized</li>
<li>MUST be promoted to a higher level of safety or reorganized out to ensure liveness</li>
</ul>
<p><code>unsafe</code> inputs are currently gossiped around the p2p network. To prevent denial of service, they MUST
be signed by the sequencer. This signature represents the sequencer's claim that it
built a block that conforms to the protocol. <code>unsafe</code> blocks exist to give low latency access to the
latest information. To keep the latency as low as possible, cross chain messages are assumed valid
at this stage. This means that the remote unsafe inputs are trusted solely because they were
included in a block by the sequencer.</p>
<p>An alternative approach to <code>unsafe</code> inputs would be to include an SGX proof that the sequencer ran
particular software when building the block.</p>
<h4 id="cross-unsafe-inputs"><a class="header" href="#cross-unsafe-inputs"><code>cross-unsafe</code> Inputs</a></h4>
<ul>
<li>MUST have valid cross chain messages</li>
</ul>
<p><code>cross-unsafe</code> represents the <code>unsafe</code> blocks that have had their cross chain messages fully verified.
The network can be represented as a graph, where each block across all chains is represented as a node.
A directed edge between two blocks indicates the source block of the initiating message
and the block that includes the executing message."</p>
<p>An input can be promoted from <code>unsafe</code> to <code>cross-unsafe</code> when the full dependency graph is resolved,
such that all cross chain messages are verified to be valid and at least one message in the dependency
graph is still <code>unsafe</code>.</p>
<p>Note that the <code>cross-unsafe</code> is not meant to be exposed to the end user via the RPC label. It is
meant for internal usage. All <code>cross-unsafe</code> inputs are still considered <code>unsafe</code> by the execution
layer RPC.</p>
<h4 id="safe-inputs"><a class="header" href="#safe-inputs"><code>safe</code> Inputs</a></h4>
<ul>
<li>MUST be available</li>
<li>MAY be reorganized</li>
<li>Safe block MUST be invalidated if a reorg occurs</li>
</ul>
<p><code>safe</code> represents the state in which the <code>cross-unsafe</code> dependency graph has been fully resolved
in a way where all of the data has been published to the data availability layer.</p>
<h4 id="finalized-inputs"><a class="header" href="#finalized-inputs"><code>finalized</code> Inputs</a></h4>
<ul>
<li>MUST NOT be reorganized based on Ethereum economic security</li>
</ul>
<p><code>finalized</code> represents full Proof of Stake economic security on top of the data. This means that
if the data is reorganized, then validators will be slashed.</p>
<h3 id="honest-verifier"><a class="header" href="#honest-verifier">Honest Verifier</a></h3>
<p>The honest verifier follows a naive verification algorithm that is similar
to the block building code that the <a href="interop/./sequencer.html#direct-dependency-confirmation">sequencer</a>
follows. The main difference is that the validity of included executing
messages is verified, instead of verifying possible executing messages before
inclusion.</p>
<h2 id="security-considerations-11"><a class="header" href="#security-considerations-11">Security Considerations</a></h2>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="supervisor"><a class="header" href="#supervisor">Supervisor</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="interop/supervisor.html#overview">Overview</a></li>
<li><a href="interop/supervisor.html#rpc-api">RPC API</a>
<ul>
<li><a href="interop/supervisor.html#common-types">Common types</a>
<ul>
<li><a href="interop/supervisor.html#identifier"><code>Identifier</code></a></li>
<li><a href="interop/supervisor.html#message"><code>Message</code></a></li>
<li><a href="interop/supervisor.html#executingdescriptor"><code>ExecutingDescriptor</code></a></li>
<li><a href="interop/supervisor.html#hexuint64"><code>HexUint64</code></a></li>
<li><a href="interop/supervisor.html#int"><code>Int</code></a></li>
<li><a href="interop/supervisor.html#chainid"><code>ChainID</code></a></li>
<li><a href="interop/supervisor.html#hash"><code>Hash</code></a></li>
<li><a href="interop/supervisor.html#bytes"><code>Bytes</code></a></li>
<li><a href="interop/supervisor.html#blockid"><code>BlockID</code></a></li>
<li><a href="interop/supervisor.html#blockref"><code>BlockRef</code></a></li>
<li><a href="interop/supervisor.html#derivedidpair"><code>DerivedIDPair</code></a></li>
<li><a href="interop/supervisor.html#chainrootinfo"><code>ChainRootInfo</code></a></li>
<li><a href="interop/supervisor.html#supervisorsyncstatus"><code>SupervisorSyncStatus</code></a></li>
<li><a href="interop/supervisor.html#supervisorchainsyncstatus"><code>SupervisorChainSyncStatus</code></a></li>
<li><a href="interop/supervisor.html#superrootresponse"><code>SuperRootResponse</code></a></li>
<li><a href="interop/supervisor.html#safetylevel"><code>SafetyLevel</code></a></li>
</ul>
</li>
<li><a href="interop/supervisor.html#methods">Methods</a>
<ul>
<li><a href="interop/supervisor.html#supervisor_crossderivedtosource"><code>supervisor_crossDerivedToSource</code></a></li>
<li><a href="interop/supervisor.html#supervisor_localunsafe"><code>supervisor_localUnsafe</code></a></li>
<li><a href="interop/supervisor.html#supervisor_localsafe"><code>supervisor_localSafe</code></a></li>
<li><a href="interop/supervisor.html#supervisor_crosssafe"><code>supervisor_crossSafe</code></a></li>
<li><a href="interop/supervisor.html#supervisor_finalized"><code>supervisor_finalized</code></a></li>
<li><a href="interop/supervisor.html#supervisor_finalizedl1"><code>supervisor_finalizedL1</code></a></li>
<li><a href="interop/supervisor.html#supervisor_superrootattimestamp"><code>supervisor_superRootAtTimestamp</code></a></li>
<li><a href="interop/supervisor.html#supervisor_syncstatus"><code>supervisor_syncStatus</code></a></li>
<li><a href="interop/supervisor.html#supervisor_allsafederivedat"><code>supervisor_allSafeDerivedAt</code></a></li>
<li><a href="interop/supervisor.html#supervisor_checkaccesslist"><code>supervisor_checkAccessList</code></a>
<ul>
<li><a href="interop/supervisor.html#access-list-contents">Access-list contents</a></li>
<li><a href="interop/supervisor.html#access-list-execution-context">Access-list execution context</a></li>
<li><a href="interop/supervisor.html#access-list-checks">Access-list checks</a></li>
<li><a href="interop/supervisor.html#supervisor_checkaccesslist-contents"><code>supervisor_checkAccessList</code> contents</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="interop/supervisor.html#data-availability-errors">Data Availability Errors</a>
<ul>
<li><a href="interop/supervisor.html#json-rpc-error-codes">JSON-RPC Error Codes</a></li>
<li><a href="interop/supervisor.html#error-code-structure">Error Code Structure</a></li>
<li><a href="interop/supervisor.html#error-codes">Error Codes</a>
<ul>
<li><a href="interop/supervisor.html#-3204xx-deadline_exceeded-errors">-3204<code>XX</code> <code>DEADLINE_EXCEEDED</code> errors</a>
<ul>
<li><a href="interop/supervisor.html#-320400-uninitialized_chain_database">-320400 <code>UNINITIALIZED_CHAIN_DATABASE</code></a></li>
</ul>
</li>
<li><a href="interop/supervisor.html#-3205xx-not_found-errors">-3205<code>XX</code> <code>NOT_FOUND</code> errors</a>
<ul>
<li><a href="interop/supervisor.html#-320500-skipped_data">-320500 <code>SKIPPED_DATA</code></a></li>
<li><a href="interop/supervisor.html#-320501-unknown_chain">-320501 <code>UNKNOWN_CHAIN</code></a></li>
</ul>
</li>
<li><a href="interop/supervisor.html#-3206xx-already_exists-errors">-3206<code>XX</code> <code>ALREADY_EXISTS</code> errors</a>
<ul>
<li><a href="interop/supervisor.html#-320600-conflicting_data">-320600 <code>CONFLICTING_DATA</code></a></li>
<li><a href="interop/supervisor.html#-320601-ineffective_data">-320601 <code>INEFFECTIVE_DATA</code></a></li>
</ul>
</li>
<li><a href="interop/supervisor.html#-3209xx-failed_precondition-errors">-3209<code>XX</code> <code>FAILED_PRECONDITION</code> errors</a>
<ul>
<li><a href="interop/supervisor.html#-320900-out_of_order">-320900 <code>OUT_OF_ORDER</code></a></li>
<li><a href="interop/supervisor.html#-320901-awaiting_replacement_block">-320901 <code>AWAITING_REPLACEMENT_BLOCK</code></a></li>
</ul>
</li>
<li><a href="interop/supervisor.html#-3210xx-aborted-errors">-3210<code>XX</code> <code>ABORTED</code> errors</a>
<ul>
<li><a href="interop/supervisor.html#-321000-iter_stop">-321000 <code>ITER_STOP</code></a></li>
</ul>
</li>
<li><a href="interop/supervisor.html#-3211xx-out_of_range-errors">-3211<code>XX</code> <code>OUT_OF_RANGE</code> errors</a>
<ul>
<li><a href="interop/supervisor.html#-321100-out_of_scope">-321100 <code>OUT_OF_SCOPE</code></a></li>
</ul>
</li>
<li><a href="interop/supervisor.html#-3212xx-unimplemented-errors">-3212<code>XX</code> <code>UNIMPLEMENTED</code> errors</a>
<ul>
<li><a href="interop/supervisor.html#-321200-cannot_get_parent_of_first_block_in_db">-321200 <code>CANNOT_GET_PARENT_OF_FIRST_BLOCK_IN_DB</code></a></li>
</ul>
</li>
<li><a href="interop/supervisor.html#-3214xx-unavailable-errors">-3214<code>XX</code> <code>UNAVAILABLE</code> errors</a>
<ul>
<li><a href="interop/supervisor.html#-321401-future_data">-321401 <code>FUTURE_DATA</code></a></li>
</ul>
</li>
<li><a href="interop/supervisor.html#-3215xx-data_loss-errors">-3215<code>XX</code> <code>DATA_LOSS</code> errors</a>
<ul>
<li><a href="interop/supervisor.html#-321500-missed_data">-321500 <code>MISSED_DATA</code></a></li>
<li><a href="interop/supervisor.html#-321501-data_corruption">-321501 <code>DATA_CORRUPTION</code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-46"><a class="header" href="#overview-46">Overview</a></h2>
<p>The supervisor is an implementation detail of OP Stack native interop and is not the only
architecture that can be used to implement it. The supervisor is responsible for indexing
data from all of the chains in a cluster so that the <a href="interop/./verifier.html#safety">safety level</a>
of executing messages can quickly be determined.</p>
<h2 id="rpc-api"><a class="header" href="#rpc-api">RPC API</a></h2>
<h3 id="common-types"><a class="header" href="#common-types">Common types</a></h3>
<h4 id="identifier"><a class="header" href="#identifier"><code>Identifier</code></a></h4>
<p>The identifier of a message.
Corresponds to an <a href="interop/./messaging.html#message-identifier">Identifier</a>.</p>
<p>Object:</p>
<ul>
<li><code>origin</code>: <code>Address</code></li>
<li><code>blockNumber</code>: <code>HexUint64</code></li>
<li><code>logIndex</code>: <code>HexUint64</code></li>
<li><code>timestamp</code>: <code>HexUint64</code></li>
<li><code>chainID</code>: <code>ChainID</code></li>
</ul>
<h4 id="message-1"><a class="header" href="#message-1"><code>Message</code></a></h4>
<p>Describes an initiating message.</p>
<p>Object:</p>
<ul>
<li><code>identifier</code>: <code>Identifier</code> - identifier of the message</li>
<li><code>payloadHash</code>: <code>Hash</code> - <code>keccak256</code> hash of the message-payload bytes</li>
</ul>
<h4 id="executingdescriptor"><a class="header" href="#executingdescriptor"><code>ExecutingDescriptor</code></a></h4>
<p>Describes the context for message verification.
Specifically, this helps apply message-expiry rules on message checks.</p>
<p>Object:</p>
<ul>
<li><code>timestamp</code>: <code>HexUint64</code> - expected timestamp during message execution.</li>
<li><code>timeout</code>: <code>HexUint64</code> - optional, requests verification to still hold at <code>timestamp+timeout</code> (inclusive).
The message expiry-window may invalidate messages.
Default interpretation is a <code>0</code> timeout: what is valid at <code>timestamp</code> may not be valid at <code>timestamp+1</code>.</li>
</ul>
<h4 id="hexuint64"><a class="header" href="#hexuint64"><code>HexUint64</code></a></h4>
<p><code>STRING</code>:
Hex-encoded big-endian number, variable length up to 64 bits, prefixed with <code>0x</code>.</p>
<h4 id="int"><a class="header" href="#int"><code>Int</code></a></h4>
<p><code>NUMBER</code>:
Regular JSON number, always integer. Assumed to always fit in 51 bits.</p>
<h4 id="chainid"><a class="header" href="#chainid"><code>ChainID</code></a></h4>
<p><code>STRING</code>:
Hex-encoded big-endian number, variable length up to 256 bits, prefixed with <code>0x</code>.</p>
<h4 id="hash"><a class="header" href="#hash"><code>Hash</code></a></h4>
<p><code>STRING</code>:
Hex-encoded, fixed-length, representing 32 bytes, prefixed with <code>0x</code>.</p>
<h4 id="bytes"><a class="header" href="#bytes"><code>Bytes</code></a></h4>
<p><code>STRING</code>:
Hex-encoded, variable length (always full bytes, no odd number of nibbles),
representing a bytes list, prefixed with <code>0x</code>.</p>
<h4 id="blockid-1"><a class="header" href="#blockid-1"><code>BlockID</code></a></h4>
<p>Describes a block.</p>
<p><code>OBJECT</code>:</p>
<ul>
<li><code>hash</code>: <code>Hash</code> - block hash</li>
<li><code>number</code>: <code>Int</code> - block number</li>
</ul>
<h4 id="blockref"><a class="header" href="#blockref"><code>BlockRef</code></a></h4>
<p>Describes a block.</p>
<p><code>OBJECT</code>:</p>
<ul>
<li><code>hash</code>: <code>Hash</code> - block hash</li>
<li><code>number</code>: <code>Int</code> - block number</li>
<li><code>parentHash</code>: <code>Hash</code> - block parent-hash</li>
<li><code>timestamp</code>: <code>Int</code> - block timestamp</li>
</ul>
<h4 id="derivedidpair"><a class="header" href="#derivedidpair"><code>DerivedIDPair</code></a></h4>
<p>A pair of block identifiers, linking a <code>derived</code> block to the <code>source</code> block from which it was derived.</p>
<p><code>OBJECT</code>:</p>
<ul>
<li><code>source</code>: <code>BlockID</code> - The block ID of the <code>source</code> block.</li>
<li><code>derived</code>: <code>BlockID</code> - The block ID of the <code>derived</code> block.</li>
</ul>
<h4 id="chainrootinfo"><a class="header" href="#chainrootinfo"><code>ChainRootInfo</code></a></h4>
<p><code>OBJECT</code>:</p>
<ul>
<li><code>chainId</code>: <code>HexUint64</code> - The chain ID (Note: this is changing to <code>ChainID</code> soon)</li>
<li><code>canonical</code>: <code>Hash</code> - output root at the latest canonical block</li>
<li><code>pending</code>: <code>Bytes</code> - output root preimage</li>
</ul>
<h4 id="supervisorsyncstatus"><a class="header" href="#supervisorsyncstatus"><code>SupervisorSyncStatus</code></a></h4>
<p>Describes the sync status of the Supervisor component. Fields <code>minSyncedL1</code>,
<code>safeTimestamp</code> and <code>finalizedTimestamp</code> are set as the minimum value among
chains in <code>chains</code>.</p>
<p><code>OBJECT</code>:</p>
<ul>
<li><code>minSyncedL1</code>: <code>BlockRef</code> - block ref to the synced L1 block</li>
<li><code>safeTimestamp</code>: <code>Int</code> - safe timestamp</li>
<li><code>finalizedTimestamp</code>: <code>Int</code> - finalized timestamp</li>
<li><code>chains</code>: <code>OBJECT</code> with <code>ChainID</code> keys and <code>SupervisorChainSyncStatus</code> values</li>
</ul>
<blockquote>
<p><strong>Note:</strong><br />
If <code>minSyncedL1</code> does not exist, it MUST be represented as a <code>BlockRef</code> with a <code>hash</code> and <code>parentHash</code> of<br />
<code>0x0000000000000000000000000000000000000000000000000000000000000000</code>, a <code>number</code> of <code>0</code>,<br />
and a <code>timestamp</code> of <code>0</code>.</p>
</blockquote>
<h4 id="supervisorchainsyncstatus"><a class="header" href="#supervisorchainsyncstatus"><code>SupervisorChainSyncStatus</code></a></h4>
<p>Describes the sync status for a specific chain</p>
<p><code>OBJECT</code>:</p>
<ul>
<li><code>localUnsafe</code>: <code>BlockRef</code> - local-unsafe ref for the given chain</li>
<li><code>localSafe</code>: <code>BlockID</code> - local-safe ref for the given chain</li>
<li><code>crossUnsafe</code>: <code>BlockID</code> - cross-unsafe ref for the given chain</li>
<li><code>safe</code>: <code>BlockID</code> - cross-safe ref for the given chain</li>
<li><code>finalized</code>: <code>BlockID</code> - finalized ref for the given chain</li>
</ul>
<blockquote>
<p><strong>Note:</strong><br />
For the fields <code>localSafe</code>, <code>crossUnsafe</code>, <code>safe</code>, and <code>finalized</code>, if the referenced block does not exist yet,<br />
the <code>BlockID</code> MUST be represented with a <code>hash</code> of<br />
<code>0x0000000000000000000000000000000000000000000000000000000000000000</code> and a <code>number</code> of <code>0</code>.</p>
</blockquote>
<h4 id="superrootresponse"><a class="header" href="#superrootresponse"><code>SuperRootResponse</code></a></h4>
<p><code>OBJECT</code>:</p>
<ul>
<li><code>crossSafeDerivedFrom</code>: <code>BlockID</code> - common derived-from where all chains are cross-safe</li>
<li><code>timestamp</code>: <code>Int</code> - The timestamp of the super root</li>
<li><code>superRoot</code>: <code>Hash</code> - The root of the super root</li>
<li><code>version</code>: <code>Int</code> - The version of the response</li>
<li><code>chains</code>: <code>ARRAY</code> of <code>ChainRootInfo</code> - List of chains included in the super root</li>
</ul>
<h4 id="safetylevel"><a class="header" href="#safetylevel"><code>SafetyLevel</code></a></h4>
<p>The safety level of the message.
Corresponds to a verifier <a href="interop/./verifier.html#safety">SafetyLevel</a>.</p>
<p><code>STRING</code>, one of:</p>
<ul>
<li><code>invalid</code></li>
<li><code>unsafe</code>: matching local-unsafe, equivalent to safety of the <code>latest</code> RPC label.</li>
<li><code>cross-unsafe</code></li>
<li><code>local-safe</code></li>
<li><code>safe</code>: matching cross-safe, named <code>safe</code> to match the RPC label.</li>
<li><code>finalized</code></li>
</ul>
<h3 id="methods"><a class="header" href="#methods">Methods</a></h3>
<h4 id="supervisor_crossderivedtosource"><a class="header" href="#supervisor_crossderivedtosource"><code>supervisor_crossDerivedToSource</code></a></h4>
<p>Parameters:</p>
<ul>
<li><code>chainID</code>: <code>ChainID</code></li>
<li><code>derived</code>: <code>BlockID</code></li>
</ul>
<p>Returns: derivedFrom <code>BlockRef</code></p>
<h4 id="supervisor_localunsafe"><a class="header" href="#supervisor_localunsafe"><code>supervisor_localUnsafe</code></a></h4>
<p>Parameters:</p>
<ul>
<li><code>chainID</code>: <code>ChainID</code></li>
</ul>
<p>Returns: <code>BlockID</code></p>
<h4 id="supervisor_localsafe"><a class="header" href="#supervisor_localsafe"><code>supervisor_localSafe</code></a></h4>
<p>Parameters:</p>
<ul>
<li><code>chainID</code>: <code>ChainID</code></li>
</ul>
<p>Returns: <code>DerivedIDPair</code></p>
<h4 id="supervisor_crosssafe"><a class="header" href="#supervisor_crosssafe"><code>supervisor_crossSafe</code></a></h4>
<p>Parameters:</p>
<ul>
<li><code>chainID</code>: <code>ChainID</code></li>
</ul>
<p>Returns: <code>DerivedIDPair</code></p>
<h4 id="supervisor_finalized"><a class="header" href="#supervisor_finalized"><code>supervisor_finalized</code></a></h4>
<p>Parameters:</p>
<ul>
<li><code>chainID</code>: <code>ChainID</code></li>
</ul>
<p>Returns: <code>BlockID</code></p>
<h4 id="supervisor_finalizedl1"><a class="header" href="#supervisor_finalizedl1"><code>supervisor_finalizedL1</code></a></h4>
<p>Parameters: (none)</p>
<p>Returns: <code>BlockRef</code></p>
<h4 id="supervisor_superrootattimestamp"><a class="header" href="#supervisor_superrootattimestamp"><code>supervisor_superRootAtTimestamp</code></a></h4>
<p>Retrieves the super root state at the specified timestamp,
which represents the global state across all monitored chains.</p>
<p>Parameters:</p>
<ul>
<li><code>timestamp</code>: <code>HexUint64</code></li>
</ul>
<p>Returns: <code>SuperRootResponse</code></p>
<h4 id="supervisor_syncstatus"><a class="header" href="#supervisor_syncstatus"><code>supervisor_syncStatus</code></a></h4>
<p>Parameters: (none)</p>
<p>Returns: <code>SupervisorSyncStatus</code>.
Throws: Some error if set of supervised chains is empty.</p>
<h4 id="supervisor_allsafederivedat"><a class="header" href="#supervisor_allsafederivedat"><code>supervisor_allSafeDerivedAt</code></a></h4>
<p>Returns the last derived block for each chain, from the given L1 block.</p>
<p>Parameters:</p>
<ul>
<li><code>derivedFrom</code>: <code>BlockID</code></li>
</ul>
<p>Returns: derived blocks, mapped in a <code>OBJECT</code>:</p>
<ul>
<li>key: <code>ChainID</code></li>
<li>value: <code>BlockID</code></li>
</ul>
<h4 id="supervisor_checkaccesslist"><a class="header" href="#supervisor_checkaccesslist"><code>supervisor_checkAccessList</code></a></h4>
<p>Verifies if an access-list, as defined in <a href="https://eips.ethereum.org/EIPS/eip-2930">EIP-2930</a>, references only valid messages.
Message execution in the <a href="interop/./predeploys.html#crossl2inbox"><code>CrossL2Inbox</code></a> that is statically declared in the access-list will not revert.</p>
<h5 id="access-list-contents"><a class="header" href="#access-list-contents">Access-list contents</a></h5>
<p>Only the <a href="interop/./predeploys.html#crossl2inbox"><code>CrossL2Inbox</code></a> subset of the access-list in the transaction is required,
storage-access by other addresses is not included.</p>
<p>Note that an access-list can contain multiple different storage key lists for the <code>CrossL2Inbox</code> address.
All storage keys applicable to the <code>CrossL2Inbox</code> MUST be joined together (preserving ordering),
missing storage-keys breaks inbox safety.</p>
<p><strong>ALL storage-keys in the access-list for the <code>CrossL2Inbox</code> MUST be checked.</strong>
If there is any unrecognized or invalid key, the access-list check MUST fail.</p>
<h5 id="access-list-execution-context"><a class="header" href="#access-list-execution-context">Access-list execution context</a></h5>
<p>The provided execution-context is used to determine validity relative to the provided time constraints,
see <a href="interop/./derivation.html#invariants">timestamp invariants</a>.</p>
<p>Since messages expire, validity is not definitive.
To reserve validity for a longer time range, a non-zero <code>timeout</code> value can be used.
See <a href="interop/supervisor.html#executingdescriptor"><code>ExecutingDescriptor</code></a> documentation.</p>
<p>As block-builder a <code>timeout</code> of <code>0</code> should be used.</p>
<p>As transaction pre-verifier, a <code>timeout</code> of <code>86400</code> (1 day) should be used.
The transaction should be re-verified or dropped after this time duration,
as it can no longer be safely included in the block due to message-expiry.</p>
<h5 id="access-list-checks"><a class="header" href="#access-list-checks">Access-list checks</a></h5>
<p>The access-list check errors are not definite state-transition blockers, the RPC based checks can be extra conservative.
I.e. a message that is uncertain to meet the requested safety level may be denied.
Specifically, no attempt may be made to verify messages that are initiated and executed within the same timestamp,
these are <code>invalid</code> by default.
Advanced block-builders may still choose to include these messages by verifying the intra-block constraints.</p>
<h5 id="supervisor_checkaccesslist-contents"><a class="header" href="#supervisor_checkaccesslist-contents"><code>supervisor_checkAccessList</code> contents</a></h5>
<p>Parameters:</p>
<ul>
<li><code>inboxEntries</code>: <code>ARRAY</code> of <code>Hash</code> - statically declared <code>CrossL2Inbox</code> access entries.</li>
<li><code>minSafety</code>: <code>SafetyLevel</code> - minimum required safety, one of:
<ul>
<li><code>unsafe</code>: the message exists.</li>
<li><code>cross-unsafe</code>: the message exists in a cross-unsafe block.</li>
<li><code>local-safe</code>: the message exists in a local-safe block, not yet cross-verified.</li>
<li><code>safe</code>: the message exists in a derived block that is cross-verified.</li>
<li><code>finalized</code>: the message exists in a finalized block.</li>
<li>Other safety levels are invalid and result in an error.</li>
</ul>
</li>
<li><code>executingDescriptor</code>: <code>ExecutingDescriptor</code> - applies as execution-context to all messages.</li>
</ul>
<p>Returns: void if all <code>inboxEntries</code> meet <code>minSafety</code>, otherwise RPC error. (Protocol specific errors of this method
are exhaustively coded)(#json-rpc-error-codes). Examples of protocol errors are, errors due to <code>minSafety</code> not being
met by one or more of the access entries, or, the <code>inboxEntries</code> list may be incomplete or malformed w.r.t. the list
of messages it should map to.</p>
<h3 id="data-availability-errors"><a class="header" href="#data-availability-errors">Data Availability Errors</a></h3>
<p>The Supervisor RPC API data availability errors use a 6-digit error code system that
extends standard JSON-RPC error codes while providing additional categorization
based on gRPC status codes.</p>
<h4 id="json-rpc-error-codes"><a class="header" href="#json-rpc-error-codes">JSON-RPC Error Codes</a></h4>
<p>An extra digit, ensures error codes don't interfere with standard 5-digit
<a href="https://ethereum-json-rpc.com/errors">Ethereum JSON-RPC Errors</a>.</p>
<h4 id="error-code-structure"><a class="header" href="#error-code-structure">Error Code Structure</a></h4>
<p>Superchain data availability RPC error codes follow this structure:</p>
<ul>
<li>First 2 digits: <code>32</code> (indicating server error, matching JSON-RPC conventions)</li>
<li>Middle 2 digits: gRPC status code category (01-16, zero-padded)</li>
<li>Last 2 digits: Specific error index within that category (00-99)</li>
</ul>
<p>For gRPC status codes reference, see <a href="https://grpc.io/docs/guides/status-codes/">gRPC Status Codes</a>.</p>
<h4 id="error-codes"><a class="header" href="#error-codes">Error Codes</a></h4>
<h5 id="-3204xx-deadline_exceeded-errors"><a class="header" href="#-3204xx-deadline_exceeded-errors">-3204<code>XX</code> <code>DEADLINE_EXCEEDED</code> errors</a></h5>
<h6 id="-320400-uninitialized_chain_database"><a class="header" href="#-320400-uninitialized_chain_database">-320400 <code>UNINITIALIZED_CHAIN_DATABASE</code></a></h6>
<p>Happens when a chain database is not initialized yet.</p>
<h5 id="-3205xx-not_found-errors"><a class="header" href="#-3205xx-not_found-errors">-3205<code>XX</code> <code>NOT_FOUND</code> errors</a></h5>
<h6 id="-320500-skipped_data"><a class="header" href="#-320500-skipped_data">-320500 <code>SKIPPED_DATA</code></a></h6>
<p>Happens when we try to retrieve data that is not available (pruned).
It may also happen if we erroneously skip data, that was not considered a conflict, if the DB is corrupted.</p>
<h6 id="-320501-unknown_chain"><a class="header" href="#-320501-unknown_chain">-320501 <code>UNKNOWN_CHAIN</code></a></h6>
<p>Happens when a chain is unknown, not in the dependency set.</p>
<h5 id="-3206xx-already_exists-errors"><a class="header" href="#-3206xx-already_exists-errors">-3206<code>XX</code> <code>ALREADY_EXISTS</code> errors</a></h5>
<h6 id="-320600-conflicting_data"><a class="header" href="#-320600-conflicting_data">-320600 <code>CONFLICTING_DATA</code></a></h6>
<p>Happens when we know for sure that there is different canonical data.</p>
<h6 id="-320601-ineffective_data"><a class="header" href="#-320601-ineffective_data">-320601 <code>INEFFECTIVE_DATA</code></a></h6>
<p>Happens when data is accepted as compatible, but did not change anything.
This happens when a node is deriving an L2 block we already know of being derived from the given source,
but without path to skip forward to newer source blocks without doing the known derivation work first.</p>
<h5 id="-3209xx-failed_precondition-errors"><a class="header" href="#-3209xx-failed_precondition-errors">-3209<code>XX</code> <code>FAILED_PRECONDITION</code> errors</a></h5>
<h6 id="-320900-out_of_order"><a class="header" href="#-320900-out_of_order">-320900 <code>OUT_OF_ORDER</code></a></h6>
<p>Happens when you try to add data to the DB, but it does not actually fit onto the latest data
(by being too old or new).</p>
<h6 id="-320901-awaiting_replacement_block"><a class="header" href="#-320901-awaiting_replacement_block">-320901 <code>AWAITING_REPLACEMENT_BLOCK</code></a></h6>
<p>Happens when we know for sure that a replacement block is needed before progress can be made.</p>
<h5 id="-3210xx-aborted-errors"><a class="header" href="#-3210xx-aborted-errors">-3210<code>XX</code> <code>ABORTED</code> errors</a></h5>
<h6 id="-321000-iter_stop"><a class="header" href="#-321000-iter_stop">-321000 <code>ITER_STOP</code></a></h6>
<p>Happens in iterator to indicate iteration has to stop.
This error might only be used internally and not sent over the network.</p>
<h5 id="-3211xx-out_of_range-errors"><a class="header" href="#-3211xx-out_of_range-errors">-3211<code>XX</code> <code>OUT_OF_RANGE</code> errors</a></h5>
<h6 id="-321100-out_of_scope"><a class="header" href="#-321100-out_of_scope">-321100 <code>OUT_OF_SCOPE</code></a></h6>
<p>Happens when data is accessed, but access is not allowed, because of a limited scope.
E.g. when limiting scope to L2 blocks derived from a specific subset of the L1 chain.</p>
<h5 id="-3212xx-unimplemented-errors"><a class="header" href="#-3212xx-unimplemented-errors">-3212<code>XX</code> <code>UNIMPLEMENTED</code> errors</a></h5>
<h6 id="-321200-cannot_get_parent_of_first_block_in_db"><a class="header" href="#-321200-cannot_get_parent_of_first_block_in_db">-321200 <code>CANNOT_GET_PARENT_OF_FIRST_BLOCK_IN_DB</code></a></h6>
<p>Happens when you try to get the previous block of the first block.
E.g. when trying to determine the previous source block for the first L1 block in the database.</p>
<h5 id="-3214xx-unavailable-errors"><a class="header" href="#-3214xx-unavailable-errors">-3214<code>XX</code> <code>UNAVAILABLE</code> errors</a></h5>
<h6 id="-321401-future_data"><a class="header" href="#-321401-future_data">-321401 <code>FUTURE_DATA</code></a></h6>
<p>Happens when data is just not yet available.</p>
<h5 id="-3215xx-data_loss-errors"><a class="header" href="#-3215xx-data_loss-errors">-3215<code>XX</code> <code>DATA_LOSS</code> errors</a></h5>
<h6 id="-321500-missed_data"><a class="header" href="#-321500-missed_data">-321500 <code>MISSED_DATA</code></a></h6>
<p>Happens when we search the DB, know the data may be there, but is not (e.g. different revision).</p>
<h6 id="-321501-data_corruption"><a class="header" href="#-321501-data_corruption">-321501 <code>DATA_CORRUPTION</code></a></h6>
<p>Happens when the underlying DB has some I/O issue.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="control-flow-between-supervisor-and-managed-node"><a class="header" href="#control-flow-between-supervisor-and-managed-node">Control flow between Supervisor and Managed node</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="interop/managed-node.html#authentication">Authentication</a></li>
<li><a href="interop/managed-node.html#node---supervisor">Node <code>-&gt;</code> Supervisor</a>
<ul>
<li><a href="interop/managed-node.html#reset">Reset</a></li>
<li><a href="interop/managed-node.html#unsafeblock">UnsafeBlock</a></li>
<li><a href="interop/managed-node.html#derivationupdate">DerivationUpdate</a></li>
<li><a href="interop/managed-node.html#derivationcurrentl1update">DerivationCurrentL1Update</a></li>
<li><a href="interop/managed-node.html#exhaustl1">ExhaustL1</a></li>
<li><a href="interop/managed-node.html#replaceblock">ReplaceBlock</a></li>
</ul>
</li>
<li><a href="interop/managed-node.html#supervisor---node">Supervisor <code>-&gt;</code> Node</a>
<ul>
<li><a href="interop/managed-node.html#control-signals">Control Signals</a>
<ul>
<li><a href="interop/managed-node.html#interop_pullevent">interop_pullEvent</a></li>
<li><a href="interop/managed-node.html#interop_anchorpoint-soon-to-be-deprecated">interop_anchorPoint (Soon to be deprecated)</a></li>
<li><a href="interop/managed-node.html#interop_invalidateblock">interop_invalidateBlock</a></li>
<li><a href="interop/managed-node.html#interop_providel1">interop_provideL1</a></li>
<li><a href="interop/managed-node.html#interop_reset">interop_reset</a></li>
<li><a href="interop/managed-node.html#interop_resetpreinterop">interop_resetPreInterop</a></li>
</ul>
</li>
<li><a href="interop/managed-node.html#db">DB</a>
<ul>
<li><a href="interop/managed-node.html#interop_updatecrosssafe">interop_updateCrossSafe</a></li>
<li><a href="interop/managed-node.html#interop_updatecrossunsafe">interop_updateCrossUnsafe</a></li>
<li><a href="interop/managed-node.html#interop_updatefinalized">interop_updateFinalized</a></li>
</ul>
</li>
<li><a href="interop/managed-node.html#sync-methods">Sync Methods</a>
<ul>
<li><a href="interop/managed-node.html#interop_fetchreceipts">interop_fetchReceipts</a></li>
<li><a href="interop/managed-node.html#interop_l2blockrefbytimestamp">interop_l2BlockRefByTimestamp</a></li>
<li><a href="interop/managed-node.html#interop_l2blockrefbynumber">interop_l2BlockRefByNumber</a></li>
<li><a href="interop/managed-node.html#interop_chainid">interop_chainID</a></li>
<li><a href="interop/managed-node.html#interop_outputv0attimestamp">interop_outputV0AtTimestamp</a></li>
<li><a href="interop/managed-node.html#interop_pendingoutputv0attimestamp">interop_pendingOutputV0AtTimestamp</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="interop/managed-node.html#types">Types</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<p>This section is based on the control flow between <code>managed</code> node and <code>supervisor</code>, described
<a href="https://github.com/ethereum-optimism/optimism/blob/develop/op-supervisor/README.md">here</a>.</p>
<p>Whether the node and supervisor use a <code>pubsub</code> pattern or pulling events over HTTP is up to the implementation detail.
Both cases should be handled because <code>op-node</code> and <code>op-supervisor</code> can be using different client implementations.
In both the case, we use <code>event</code> based signaling of new information. Ideally, this should be done using bi-directional
RPC using web sockets.</p>
<h2 id="authentication"><a class="header" href="#authentication">Authentication</a></h2>
<p>Supervisor <a href="https://github.com/ethereum-optimism/optimism/issues/13182">initiates the connection</a> to the node in order
to manage it. As supervisor does the dial in, for our context, it is the client and the node is the server. For the web
socket authentication, only the initial request is authenticated and a live socket is opened.
No re-authentication is needed during the lifetime of this socket.</p>
<p>The authentication is performed using <code>JWT</code>. The construction of jwt is the same to the one
<a href="https://github.com/ethereum/execution-apis/blob/main/src/engine/authentication.md">used in Engine API</a>. The path of
the file containing the jwt secret should be provided to the supervisor instance.</p>
<h2 id="node---supervisor"><a class="header" href="#node---supervisor">Node <code>-&gt;</code> Supervisor</a></h2>
<p>Events that a supervisor should subscribe to, originating from the node, handled by the supervisor. For the used types,
refer <a href="interop/managed-node.html#types">this</a> section.</p>
<p>Every event sent from the node is of type <code>ManagedEvent</code> whose fields are populated with the events that occurred. All
non-null events are sent at once. The other fields are omitted.</p>
<pre><code class="language-javascript">ManagedEvent {
    Reset,
    UnsafeBlock,
    DerivationUpdate,
    DerivationCurrentL1Update,
    ExhaustL1,
    ReplaceBlock
}
</code></pre>
<p>Each field item is an event of the type as described below:</p>
<h3 id="reset"><a class="header" href="#reset">Reset</a></h3>
<pre><code class="language-javascript">Reset: string
</code></pre>
<p>This is emitted when the node has determined that it needs a reset. It tells the supervisor to send the
<a href="interop/managed-node.html#interop_reset">interop_reset</a> event with the required parameters.</p>
<h3 id="unsafeblock"><a class="header" href="#unsafeblock">UnsafeBlock</a></h3>
<pre><code class="language-javascript">UnsafeBlock: BlockRef //L2's BlockRef
</code></pre>
<p>New L2 unsafe block was processed, updating local-unsafe head.</p>
<h3 id="derivationupdate"><a class="header" href="#derivationupdate">DerivationUpdate</a></h3>
<pre><code class="language-javascript">DerivationUpdate: DerivedBlockRefPair {
    source: BlockRef  //L1 
    derived: BlockRef //Last L2 BlockRef
}
</code></pre>
<p>Signals that an L2 block is considered local-safe.</p>
<h3 id="derivationcurrentl1update"><a class="header" href="#derivationcurrentl1update">DerivationCurrentL1Update</a></h3>
<pre><code class="language-javascript">DerivationCurrentL1Update: DerivedBlockRefPair {
    source: BlockRef  //Newly observed L1
    derived: BlockRef //L2's BlockRef
}
</code></pre>
<p>Signals that an L2 block is considered local-safe following the observation of a new L1 block.</p>
<h3 id="exhaustl1"><a class="header" href="#exhaustl1">ExhaustL1</a></h3>
<pre><code class="language-javascript">ExhaustL1: DerivedBlockRefPair {
    source: BlockRef  //Last L1
    derived: BlockRef //Last L2 BlockRef
}
</code></pre>
<p>Emitted when no more L1 Blocks are available. Ready to take new L1 blocks from supervisor.</p>
<h3 id="replaceblock"><a class="header" href="#replaceblock">ReplaceBlock</a></h3>
<pre><code class="language-javascript">ReplaceBlock: BlockReplacement
</code></pre>
<p>Emitted when a block gets replaced for any reason.</p>
<h2 id="supervisor---node"><a class="header" href="#supervisor---node">Supervisor <code>-&gt;</code> Node</a></h2>
<p>Messages that a node should watch for, originating from supervisor, handled by node. This also includes control signals
that the supervisor can ask the node to perform. For the used types, refer <a href="interop/managed-node.html#types">this</a> section.</p>
<p><em>Note: Headings represent the actual name of the methods over RPC, payload is the serialized version of the given type.</em></p>
<p><code>-&gt; indicates return</code></p>
<h3 id="control-signals"><a class="header" href="#control-signals">Control Signals</a></h3>
<p>RPC calls that are relevant to managing the node via supervisor. These are directly called by the supervisor.</p>
<h4 id="interop_pullevent"><a class="header" href="#interop_pullevent">interop_pullEvent</a></h4>
<pre><code class="language-javascript">payload() -&gt; One of the event from node events (previous section).
</code></pre>
<p>When websocket is not available, supervisor can use this method to get the next event from node.</p>
<h4 id="interop_anchorpoint-soon-to-be-deprecated"><a class="header" href="#interop_anchorpoint-soon-to-be-deprecated">interop_anchorPoint (Soon to be deprecated)</a></h4>
<pre><code class="language-javascript">payload() -&gt; DerivedBlockRefPair {
    source: L1 BlockRef that rollup starts after (no derived transaction)
    derived: L2 BlockRef that rollup starts from (no txn, pre-configuration state)
}
</code></pre>
<p>Returns the genesis block ref for L1 and L2 that the current node used as anchor point.
This method will soon be removed in favor of fetching the information from a supervisor specific rollup config.
(Once a spec is created about <a href="https://github.com/ethereum-optimism/optimism/pull/16038">this</a> PR.)</p>
<h4 id="interop_invalidateblock"><a class="header" href="#interop_invalidateblock">interop_invalidateBlock</a></h4>
<pre><code class="language-javascript">payload (BlockSeal)  //L2's Block
</code></pre>
<p>Based on some dependency or L1 changes, supervisor can instruct the L2 to invalidate a specific block.</p>
<p><em>(Suggestion: BlockSeal can be replaced with Hash, as only that is being used in op-node.)</em></p>
<h4 id="interop_providel1"><a class="header" href="#interop_providel1">interop_provideL1</a></h4>
<pre><code class="language-javascript">payload (BlockRef) //L1 Block
</code></pre>
<p>Supervisor sends the next L1 block to the node. Ideally sent after the node emits <code>exhausted-l1</code>.</p>
<h4 id="interop_reset"><a class="header" href="#interop_reset">interop_reset</a></h4>
<pre><code class="language-javascript">payload (lUnsafe, xUnsafe, lSafe, xSafe, finalized: BlockID)
</code></pre>
<p>Forces a reset to a specific local-unsafe/local-safe/finalized starting point only if the blocks did exist. Resets may
override local-unsafe, to reset the very end of the chain. Resets may override local-safe, since post-interop we need
the local-safe block derivation to continue.</p>
<h4 id="interop_resetpreinterop"><a class="header" href="#interop_resetpreinterop">interop_resetPreInterop</a></h4>
<pre><code class="language-javascript">payload()
</code></pre>
<p>Forces a pre-interop reset on the node. It means resetting the node to a state before the Interop upgrade</p>
<h3 id="db"><a class="header" href="#db">DB</a></h3>
<p>RPC calls that a node should watch for, originating from supervisor that is called on DB updates for relevant block
safety info for a given chain and block.</p>
<h4 id="interop_updatecrosssafe"><a class="header" href="#interop_updatecrosssafe">interop_updateCrossSafe</a></h4>
<pre><code class="language-javascript">payload (derived: BlockID, source: BlockID)
</code></pre>
<p>Signal that a block can be promoted to cross-safe.</p>
<h4 id="interop_updatecrossunsafe"><a class="header" href="#interop_updatecrossunsafe">interop_updateCrossUnsafe</a></h4>
<pre><code class="language-javascript">payload (BlockID)
</code></pre>
<p>Signal that a block can be promoted to cross-unsafe.</p>
<h4 id="interop_updatefinalized"><a class="header" href="#interop_updatefinalized">interop_updateFinalized</a></h4>
<pre><code class="language-javascript">payload (BlockID)
</code></pre>
<p>Signal that a block can be marked as finalized.</p>
<h3 id="sync-methods"><a class="header" href="#sync-methods">Sync Methods</a></h3>
<p>RPC methods that are relevant for syncing the supervisor. These are directly called by the supervisor for fetching L2
data.</p>
<h4 id="interop_fetchreceipts"><a class="header" href="#interop_fetchreceipts">interop_fetchReceipts</a></h4>
<pre><code class="language-javascript">payload (Hash) -&gt; Receipts //L2 block hash
</code></pre>
<p>Fetches all transaction receipts in a given L2 block.</p>
<h4 id="interop_l2blockrefbytimestamp"><a class="header" href="#interop_l2blockrefbytimestamp">interop_l2BlockRefByTimestamp</a></h4>
<pre><code class="language-javascript">payload (uint64) -&gt; BlockRef
</code></pre>
<p>Fetches L2 BlockRef of the block that occurred at given timestamp</p>
<h4 id="interop_l2blockrefbynumber"><a class="header" href="#interop_l2blockrefbynumber">interop_l2BlockRefByNumber</a></h4>
<pre><code class="language-javascript">payload (uint64) -&gt; L2BlockRef
</code></pre>
<p>Fetches the L2 BlockRef from a given L2 block number</p>
<h4 id="interop_chainid"><a class="header" href="#interop_chainid">interop_chainID</a></h4>
<pre><code class="language-javascript">payload () -&gt; string
</code></pre>
<p>Returns chainID of the L2</p>
<h4 id="interop_outputv0attimestamp"><a class="header" href="#interop_outputv0attimestamp">interop_outputV0AtTimestamp</a></h4>
<pre><code class="language-javascript">payload (uint64) -&gt; OutputV0
</code></pre>
<p>Returns the state root, storage root and block hash for a given timestamp</p>
<h4 id="interop_pendingoutputv0attimestamp"><a class="header" href="#interop_pendingoutputv0attimestamp">interop_pendingOutputV0AtTimestamp</a></h4>
<pre><code class="language-javascript">payload (uint64) -&gt; OutputV0
</code></pre>
<p>Returns the optimistic output of the invalidated block from replacement</p>
<p><strong>Note:</strong> All events should return relevant error(s) in case of unsuccessful calls.</p>
<h2 id="types-1"><a class="header" href="#types-1">Types</a></h2>
<pre><code class="language-javascript">Hash: 0x prefixed, hex encoded, fixed-length string representing 32 bytes

BlockID {
    hash: Hash
    number: uint64
}

BlockSeal {
    hash: Hash
    number: uint64
    timestamp: uint64
}

BlockRef {
    hash: Hash
    number: uint64
    parentHash: Hash
    timestamp: uint64
}

DerivedBlockRefPair {
    source: BlockRef
    derived: BlockRef
}

BlockReplacement {
    replacement: BlockRef
    invalidated: Hash
}

Receipts -&gt; []Receipt

Receipt -&gt; op-geth/core/types/receipt

OutputV0 {
    stateRoot: Hash
    messagePasserStorageRoot: Hash
    blockHash: Hash
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="fault-proof-2"><a class="header" href="#fault-proof-2">Fault Proof</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="interop/fault-proof.html#overview">Overview</a></li>
<li><a href="interop/fault-proof.html#super-root-state-transition">Super Root State Transition</a>
<ul>
<li><a href="interop/fault-proof.html#transition-state">Transition State</a></li>
<li><a href="interop/fault-proof.html#invalid-state">Invalid State</a></li>
<li><a href="interop/fault-proof.html#local-safe-block-derivation">Local Safe Block Derivation</a></li>
<li><a href="interop/fault-proof.html#consolidation">Consolidation</a></li>
</ul>
</li>
<li><a href="interop/fault-proof.html#fault-proof-program-state-transition">Fault Proof Program State Transition</a></li>
<li><a href="interop/fault-proof.html#security-considerations">Security Considerations</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-47"><a class="header" href="#overview-47">Overview</a></h2>
<p>Interop introduces the Super Fault Dispute Game as a
new <a href="interop/../fault-proof/stage-one/dispute-game-interface.html">dispute game</a> type. It is based on the
pre-interop <a href="interop/../fault-proof/stage-one/fault-dispute-game.html">fault dispute game</a> with some modifications:</p>
<ul>
<li>Claims at and above the split depth are commitments to the state within the super root state transition described
below instead of output roots.</li>
<li>The L2 block number is replaced by the timestamp of the proposed super root.
<ul>
<li>The <code>l2BlockNumber()</code> method has been renamed <code>l2SequenceNumber()</code> in <code>IDisputeGame</code> interface to reflect that this
is an arbitrary identifier within the fully ordered sequence of chain states.</li>
</ul>
</li>
<li>The <a href="interop/../fault-proof/stage-one/fault-dispute-game.html#l2-block-number-challenge">L2 block number challenge</a> is removed.
The super root state transition is now able to invalidate all proposals with an incorrect proposal timestamp as part
of the state transition.</li>
<li>While claims in the bottom half of the game still commit to the state of the FPVM, the fault proof program being
executed changes to verify the disputed step of the super root state transition instead of the application of a
disputed L2 block.</li>
<li>The L2 block number preimage oracle local key now always provides the timestamp of the proposal.</li>
<li>The L2 chain ID preimage oracle local key is no longer used and is never populated by the dispute game.</li>
</ul>
<h2 id="super-root-state-transition"><a class="header" href="#super-root-state-transition">Super Root State Transition</a></h2>
<p>The super fault dispute game defines a state transition from the current anchor state super root to the canonical super
root at the game's proposal timestamp, if one can be derived from the available L1 data or the invalid state if not.</p>
<p>As the valid state transition always extends to the game proposal's timestamp, proposing a super root with a timestamp
less than or greater than game's proposal timestamp will be found to be invalid. Similarly any root claim that is the
hash of a <code>TransitionState</code> will be found to be invalid.</p>
<p>To reduce the amount of processing required in a single invocation of the FPVM, the state transition breaks the
transition from the super root at one timestamp to the super root at the next timestamp into 128 steps. The claims for
these intermediate steps are <code>keccak256</code> hash of a <a href="interop/fault-proof.html#transition-state">transition state</a>. These 128 steps repeat to
transition between the super root at each timestamp from the anchor state until the proposal time is reached.</p>
<h3 id="transition-state"><a class="header" href="#transition-state">Transition State</a></h3>
<p>A transition state is RLP encoded data consisting of:</p>
<ul>
<li><code>SuperOutput []byte</code> - the encoded super output at the immediately prior timestamp. This is the super root that is
being transformed <em>from</em>.</li>
<li><code>PendingProgress []LocalSafeBlock</code> - the next block derived for each chain from L1 batch data, prior to validating
executing messages.
<ul>
<li><code>LocalSafeBlock</code> is two <code>bytes32</code> RLP encoded, the first being the block hash and the second the output root for
the block.</li>
</ul>
</li>
<li><code>Step</code> a <code>uint64</code> recording the number of steps applied to this <code>TransitionState</code> since the <code>SuperOutput</code>.</li>
</ul>
<h3 id="invalid-state"><a class="header" href="#invalid-state">Invalid State</a></h3>
<p>The invalid state is defined as <code>keccak256(utf8("invalid"))</code>. This state is used to indicate a state transition where
there is no possible valid proposal. The dispute game contract MUST prevent a game from being created where the root
claim is the invalid state.</p>
<p>When the prestate is the invalid state, the post state is also the invalid state.</p>
<h3 id="local-safe-block-derivation"><a class="header" href="#local-safe-block-derivation">Local Safe Block Derivation</a></h3>
<p>The first 127 steps derive the next local safe block for one chain in the super root using
the <a href="interop/../protocol/derivation.html">derivation process</a>. Chains are processed in the order they appear in the super root
(ascending order of chain ID). The <code>Step</code> is incremented after each step.</p>
<p>For each step, the valid post state <code>TransitionState</code> is calculated by the algorithm:</p>
<ul>
<li>If the prestate is a SuperRoot, convert it to a <code>TransitionState</code> with <code>Step = 0</code> and <code>PendingProgress</code> an empty
array.</li>
<li>If <code>Step</code> is less than the number of chains included in <code>SuperOutput</code>, derive the next local safe block for the chain
at
index <code>Step</code> in the <code>SuperRoot</code> using the <a href="interop/../protocol/derivation.html">derivation process</a>. Executing messages are not
checked at this stage.
<ul>
<li>No block is derived if <code>Step</code> is greater than the number of chains in the super root.</li>
<li>If the derivation process is unable to derive the next L1 block because the L1 head is reached, the post state is
the <a href="interop/fault-proof.html#invalid-state">invalid state</a></li>
</ul>
</li>
<li>Increment <code>Step</code></li>
</ul>
<p>Since one step is required per chain in the dependency set, the current dispute game can support a maximum of 127 chains
in the dependency set. If a greater number of chains are required in the future the number of steps can be increased.</p>
<h3 id="consolidation"><a class="header" href="#consolidation">Consolidation</a></h3>
<p>When the prestate is a <code>TransitionState</code> with <code>Step = 127</code>, the validity of executing messages is checked and any
local safe blocks found to contain invalid executing messages are replaced with deposit only blocks. This includes
recursively replacing any blocks with executing messages that became invalid because of another block being replaced.</p>
<p>The post state is defined as a super output where <code>timestamp</code> is the <code>SuperOutput</code> timestamp + 1, and the output roots
are set to the output roots of the validated blocks (including any required replacements).</p>
<h2 id="fault-proof-program-state-transition"><a class="header" href="#fault-proof-program-state-transition">Fault Proof Program State Transition</a></h2>
<p>Below the split depth, claims correspond to execution trace commitments of the FPVM, as with the pre-interop
<a href="interop/../fault-proof/stage-one/fault-dispute-game.html">fault dispute game</a>. A single <strong>ABSOLUTE_PRESTATE</strong> continues to be used, with the fault proof
program identifying the type of step to perform based on the agreed prestate.</p>
<h2 id="security-considerations-12"><a class="header" href="#security-considerations-12">Security Considerations</a></h2>
<p>TODO</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="token-bridging"><a class="header" href="#token-bridging">Token Bridging</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="interop/token-bridging.html#overview">Overview</a></li>
<li><a href="interop/token-bridging.html#superchainerc20-standard"><code>SuperchainERC20</code> standard</a>
<ul>
<li><a href="interop/token-bridging.html#properties">Properties</a></li>
<li><a href="interop/token-bridging.html#ierc7802"><code>IERC7802</code></a>
<ul>
<li><a href="interop/token-bridging.html#crosschainmint"><code>crosschainMint</code></a></li>
<li><a href="interop/token-bridging.html#crosschainburn"><code>crosschainBurn</code></a></li>
<li><a href="interop/token-bridging.html#crosschainmint"><code>CrosschainMint</code></a></li>
<li><a href="interop/token-bridging.html#crosschainburn"><code>CrosschainBurn</code></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="interop/token-bridging.html#superchaintokenbridge"><code>SuperchainTokenBridge</code></a></li>
<li><a href="interop/token-bridging.html#diagram">Diagram</a></li>
<li><a href="interop/token-bridging.html#implementation">Implementation</a></li>
<li><a href="interop/token-bridging.html#future-considerations">Future Considerations</a>
<ul>
<li><a href="interop/token-bridging.html#cross-chain-transferfrom">Cross Chain <code>transferFrom</code></a></li>
<li><a href="interop/token-bridging.html#concatenated-action">Concatenated Action</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-48"><a class="header" href="#overview-48">Overview</a></h2>
<p>Without a standardized security model, bridged assets may not be fungible with each other.
The <code>SuperchainERC20</code> standard is a set of properties and an interface allowing ERC20 to be fungible across the
Superchain using the official <code>SuperchainTokenBridge</code>.
The <code>SuperchainTokenBridge</code> is a predeploy that builds on the messaging protocol as the most trust-minimized bridging solution.</p>
<h2 id="superchainerc20-standard"><a class="header" href="#superchainerc20-standard"><code>SuperchainERC20</code> standard</a></h2>
<h3 id="properties"><a class="header" href="#properties">Properties</a></h3>
<p>The standard will build on top of ERC20, implement the
<a href="https://github.com/ethereum/ERCs/pull/692"><code>IERC7802</code></a>
interface, and include the following properties:</p>
<ol>
<li>Implement the <a href="https://eips.ethereum.org/EIPS/eip-20">ERC20</a> interface</li>
<li>Implement the <a href="https://github.com/ethereum/ERCs/pull/692"><code>ERC7802</code></a> interface</li>
<li>Allow <a href="interop/./predeploys.html#superchaintokenbridge"><code>SuperchainTokenBridge</code></a> to call
<a href="interop/token-bridging.html#crosschainmint"><code>crosschainMint</code></a> and <a href="interop/token-bridging.html#crosschainburn"><code>crosschainBurn</code></a>.</li>
<li>Be deployed at the same address on every chain in the Superchain.</li>
</ol>
<p>The third property will allow the <code>SuperchainTokenBridge</code> to have a liquidity guarantee,
which would not be possible in a model based on lock/unlock.
Liquidity availability is fundamental to achieving fungibility.</p>
<p>SuperchainTokenBridge does not have to be the exclusive caller of <code>crosschainMint</code> and <code>crosschainBurn</code>;
other addresses may also be permitted to call these functions.</p>
<p>The fourth property removes the need for cross-chain access control lists.
Otherwise, the <code>SuperchainTokenBridge</code> would need a way to verify if the tokens it mints on
destination correspond to the tokens that were burned on source.
Same address abstracts away cross-chain validation.</p>
<p>One way to guarantee the same address across the Superchain (and also bind it to the same <code>init_code</code>
and constructor arguments) is to use the
<a href="interop/../protocol/preinstalls.html#create2deployer"><code>Create2Deployer</code> preinstall</a>.
There is also the <a href="interop/predeploys.html#optimismmintableerc20factory"><code>OptimismSuperchainERC20Factory</code></a>
predeploy that facilitates this process for L1 native tokens.</p>
<p>Notice that ERC20s that do not implement the standard can still be fungible
using interop message passing
using a custom bridge or implementing <code>sendERC20</code> and <code>relayERC20</code> on their own contracts.</p>
<p>An example implementation of the standard is available at <a href="https://github.com/ethereum-optimism/optimism/blob/develop/packages/contracts-bedrock/src/L2/SuperchainERC20.sol">SuperchainERC20.sol</a></p>
<h3 id="ierc7802"><a class="header" href="#ierc7802"><code>IERC7802</code></a></h3>
<p>Implementations of the <code>SuperchainERC20</code> standard will
be required to implement the <code>IERC7802</code> interface,
that includes two external functions and two events:</p>
<h4 id="crosschainmint"><a class="header" href="#crosschainmint"><code>crosschainMint</code></a></h4>
<p>Mints <code>_amount</code> of token to address <code>_account</code>.</p>
<pre><code class="language-solidity">crosschainMint(address _account, uint256 _amount)
</code></pre>
<h4 id="crosschainburn"><a class="header" href="#crosschainburn"><code>crosschainBurn</code></a></h4>
<p>Burns <code>_amount</code> of token from address <code>_account</code>.</p>
<pre><code class="language-solidity">crosschainBurn(address _account, uint256 _amount)
</code></pre>
<h4 id="crosschainmint-1"><a class="header" href="#crosschainmint-1"><code>CrosschainMint</code></a></h4>
<p>MUST trigger when <code>crosschainMint</code> is called</p>
<pre><code class="language-solidity">event CrosschainMint(address indexed _to, uint256 _amount, address indexed _sender)
</code></pre>
<h4 id="crosschainburn-1"><a class="header" href="#crosschainburn-1"><code>CrosschainBurn</code></a></h4>
<p>MUST trigger when <code>crosschainBurn</code> is called</p>
<pre><code class="language-solidity">event CrosschainBurn(address indexed _from, uint256 _amount, address indexed _sender)
</code></pre>
<h2 id="superchaintokenbridge-1"><a class="header" href="#superchaintokenbridge-1"><code>SuperchainTokenBridge</code></a></h2>
<p>The <code>SuperchainTokenBridge</code> is a predeploy that works as an abstraction
on top of the <a href="interop/./predeploys.html#l2tol2crossdomainmessenger">L2ToL2CrossDomainMessenger</a>
for token bridging.
The <code>L2ToL2CrossDomainMessenger</code> is used for replay protection,
domain binding and access to additional message information.
The <code>SuperchainTokenBridge</code> includes two functions for bridging:</p>
<ul>
<li><code>sendERC20</code>: initializes a cross-chain transfer of a <code>SuperchainERC20</code>
by burning the tokens locally and sending a message to the <code>SuperchainTokenBridge</code>
on the target chain using the <code>L2toL2CrossDomainMessenger</code>.
Additionally, it returns the <code>msgHash_</code> crafted by the <code>L2toL2CrossDomainMessenger</code>.</li>
<li><code>relayERC20</code>: processes incoming messages from the <code>L2toL2CrossDomainMessenger</code>
and mints the corresponding amount of the <code>SuperchainERC20</code>.</li>
</ul>
<p>The full specifications and invariants are detailed
in the <a href="interop/./predeploys.html#superchaintokenbridge">predeploys spec</a>.</p>
<h2 id="diagram-1"><a class="header" href="#diagram-1">Diagram</a></h2>
<p>The following diagram depicts a cross-chain transfer.</p>
<pre class="mermaid">---
config:
  theme: dark
  fontSize: 48 
---
sequenceDiagram
  participant from
  participant L2SBA as SuperchainTokenBridge (Chain A)
  participant SuperERC20_A as SuperchainERC20 (Chain A)
  participant Messenger_A as L2ToL2CrossDomainMessenger (Chain A)
  participant Inbox as CrossL2Inbox
  participant Messenger_B as L2ToL2CrossDomainMessenger (Chain B)
  participant L2SBB as SuperchainTokenBridge (Chain B)
  participant SuperERC20_B as SuperchainERC20 (Chain B)

  from-&gt;&gt;L2SBA: sendERC20(tokenAddr, to, amount, chainID)
  L2SBA-&gt;&gt;SuperERC20_A: crosschainBurn(from, amount)
  SuperERC20_A--&gt;SuperERC20_A: emit CrosschainBurn(from, amount, sender)
  L2SBA-&gt;&gt;Messenger_A: sendMessage(chainId, message)
  Messenger_A-&gt;&gt;L2SBA: return msgHash_
  L2SBA--&gt;L2SBA: emit SentERC20(tokenAddr, from, to, amount, destination)
  L2SBA-&gt;&gt;from: return msgHash_
  Inbox-&gt;&gt;Messenger_B: relayMessage()
  Messenger_B-&gt;&gt;L2SBB: relayERC20(tokenAddr, from, to, amount)
  L2SBB-&gt;&gt;SuperERC20_B: crosschainMint(to, amount)
  SuperERC20_B--&gt;SuperERC20_B: emit CrosschainMint(to, amount, sender)
  L2SBB--&gt;L2SBB: emit RelayedERC20(tokenAddr, from, to, amount, source)
</pre>
<h2 id="implementation-1"><a class="header" href="#implementation-1">Implementation</a></h2>
<p>An example implementation for the <code>sendERC20</code> and <code>relayERC20</code> functions is provided.</p>
<pre><code class="language-solidity">function sendERC20(SuperchainERC20 _token, address _to, uint256 _amount, uint256 _chainId) external returns (bytes32 msgHash_) {
  _token.crosschainBurn(msg.sender, _amount);

  bytes memory _message = abi.encodeCall(this.relayERC20, (_token, msg.sender, _to, _amount));

  msgHash_ = L2ToL2CrossDomainMessenger.sendMessage(_chainId, address(this), _message);

  emit SentERC20(address(_token), msg.sender, _to, _amount, _chainId);
}

function relayERC20(SuperchainERC20 _token, address _from, address _to, uint256 _amount) external {
  require(msg.sender == address(L2ToL2CrossChainMessenger));
  require(L2ToL2CrossChainMessenger.crossDomainMessageSender() == address(this));

  uint256 _source = L2ToL2CrossChainMessenger.crossDomainMessageSource();

  _token.crosschainMint(_to, _amount);

  emit RelayedERC20(address(_token), _from, _to, _amount, _source);
}
</code></pre>
<h2 id="future-considerations-1"><a class="header" href="#future-considerations-1">Future Considerations</a></h2>
<h3 id="cross-chain-transferfrom"><a class="header" href="#cross-chain-transferfrom">Cross Chain <code>transferFrom</code></a></h3>
<p>In addition to standard locally initialized bridging,
it is possible to allow contracts to be cross-chain interoperable.
For example, a contract in chain A could send pre-approved funds
from a user in chain B to a contract in chain C.</p>
<p>For the moment, the standard will not include any specific functionality
to facilitate such an action and rely on the usage of <code>Permit2</code> like this:</p>
<pre class="mermaid">---
config:
  theme: dark
  fontSize: 48 
---
sequenceDiagram
  participant from
  participant Intermediate_A as Initiator
  participant Messenger_A as L2ToL2CrossDomainMessenger (Chain A)
  participant Inbox as CrossL2Inbox
  participant Messenger_B as L2ToL2CrossDomainMessenger (Chain B)
  participant Permit2
  participant SuperERC20_B as SuperchainERC20 (Chain B)
  participant Recipient as to

  from-&gt;&gt;Intermediate_A: remoteTransferFrom(..., token, to, chainId, msg, signature)
  Intermediate_A-&gt;&gt;Messenger_A: permit: sendMessage(chainId, message)
  Inbox-&gt;&gt;Messenger_B: permit: relayMessage()
  Messenger_B-&gt;&gt;Permit2: permitTransferFrom(msg, sig)
  Permit2-&gt;&gt;SuperERC20_B: transferFrom(from, to, amount)

</pre>
<p>If, at some point in the future, these actions were to be included in the standard,
a possible design could introduce a <code>remoteTransferFrom()</code> function.</p>
<h3 id="concatenated-action"><a class="header" href="#concatenated-action">Concatenated Action</a></h3>
<p>It is possible to have an additional input <code>bytes _data</code> in both <code>sendERC20()</code> and <code>relayERC20()</code> that would make an
additional call to the <code>_to</code> address.
This feature could be used for cross-chain concatenated actions,
i.e. bridge funds and then do X.</p>
<p>This approach has great potential but can also be achieved outside the standard in the following way:</p>
<pre class="mermaid">---
config:
  theme: dark
  fontSize: 48 
---
sequenceDiagram
  participant from
  participant Intermediate_A as intermediate A
  participant L2SBA as L2StandardBridge (Chain A)
  participant SuperERC20_A as SuperchainERC20 (Chain A)
  participant Messenger_A as L2ToL2CrossDomainMessenger (Chain A)
  participant Inbox as CrossL2Inbox
  participant Messenger_B as L2ToL2CrossDomainMessenger (Chain B)
  participant L2SBB as L2StandardBridge (Chain B)
  participant SuperERC20_B as SuperchainERC20 (Chain B)

  from-&gt;&gt;Intermediate_A: sendWithData(data)
  Intermediate_A-&gt;&gt;L2SBA: sendERC20To(tokenAddr, to, amount, chainID)
  L2SBA-&gt;&gt;SuperERC20_A: crosschainBurn(from, amount)
  SuperERC20_A--&gt;SuperERC20_A: emit CrosschainBurn(from, amount, sender)
  L2SBA-&gt;&gt;Messenger_A: sendMessage(chainId, message)
  L2SBA--&gt;L2SBA: emit SentERC20(tokenAddr, from, to, amount, destination)
  Intermediate_A-&gt;&gt;Messenger_A: sendMessage(chainId, to, data)
  Inbox-&gt;&gt;Messenger_B: relayMessage()
  Messenger_B-&gt;&gt;L2SBB: relayERC20(tokenAddr, from, to, amount)
  L2SBB-&gt;&gt;SuperERC20_B: crosschainMint(to, amount)
  SuperERC20_B--&gt;SuperERC20_B: emit CrosschainMint(to, amount, sender)
  Inbox-&gt;&gt;Messenger_B: relayMessage(): call
  L2SBB--&gt;L2SBB: emit RelayedERC20(tokenAddr, from, to, amount, source)
  Messenger_B-&gt;&gt;to: call(data)
</pre>
<p>Adding the call to the standard would remove the dependence on the sequencer for
proper transaction ordering at the sequencer level.
However, it would also introduce additional risks for cross-chain fund transfers.
Specifically, an incorrectly formatted call could burn funds on the initiating chain,
but revert on the destination chain, and could never be successfully replayed.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="ethliquidity-1"><a class="header" href="#ethliquidity-1">ETHLiquidity</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="interop/eth-liquidity.html#overview">Overview</a></li>
<li><a href="interop/eth-liquidity.html#constants">Constants</a></li>
<li><a href="interop/eth-liquidity.html#definitions">Definitions</a>
<ul>
<li><a href="interop/eth-liquidity.html#eth-liquidity">ETH Liquidity</a></li>
<li><a href="interop/eth-liquidity.html#liquidity-minting">Liquidity Minting</a></li>
<li><a href="interop/eth-liquidity.html#liquidity-burning">Liquidity Burning</a></li>
</ul>
</li>
<li><a href="interop/eth-liquidity.html#assumptions">Assumptions</a>
<ul>
<li><a href="interop/eth-liquidity.html#ael-001-safesend-correctly-transfers-eth-to-recipients">aEL-001: SafeSend correctly transfers ETH to recipients</a>
<ul>
<li><a href="interop/eth-liquidity.html#mitigations">Mitigations</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="interop/eth-liquidity.html#invariants">Invariants</a>
<ul>
<li><a href="interop/eth-liquidity.html#iel-001-eth-balance-is-always-sufficient-for-minting--burning">iEL-001: ETH balance is always sufficient for minting / burning</a>
<ul>
<li><a href="interop/eth-liquidity.html#impact">Impact</a></li>
</ul>
</li>
<li><a href="interop/eth-liquidity.html#iel-002-only-authorized-contracts-can-call-mint-and-burn">iEL-002: Only authorized contracts can call mint and burn</a>
<ul>
<li><a href="interop/eth-liquidity.html#impact-1">Impact</a></li>
</ul>
</li>
<li><a href="interop/eth-liquidity.html#iel-003-contract-balance-never-overflows">iEL-003: Contract balance never overflows</a>
<ul>
<li><a href="interop/eth-liquidity.html#impact-2">Impact</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="interop/eth-liquidity.html#function-specification">Function Specification</a>
<ul>
<li><a href="interop/eth-liquidity.html#mint">mint</a></li>
<li><a href="interop/eth-liquidity.html#burn">burn</a></li>
</ul>
</li>
<li><a href="interop/eth-liquidity.html#events">Events</a>
<ul>
<li><a href="interop/eth-liquidity.html#liquidityminted">LiquidityMinted</a></li>
<li><a href="interop/eth-liquidity.html#liquidityburned">LiquidityBurned</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-49"><a class="header" href="#overview-49">Overview</a></h2>
<p>The <code>ETHLiquidity</code> contract is a predeploy that manages native ETH liquidity for cross-chain
transfers within the Superchain interop set. It works in conjunction with the
<code>SuperchainETHBridge</code> to facilitate the movement of ETH between chains without requiring
modifications to the EVM to generate new ETH.</p>
<p>The contract is initialized with a very large balance (<code>type(uint248).max</code> wei) to ensure it can
handle all legitimate minting operations. This design allows the <code>SuperchainETHBridge</code> to have a
guaranteed source of ETH liquidity on each chain, which is essential for the cross-chain ETH
transfer mechanism.</p>
<h2 id="constants-1"><a class="header" href="#constants-1">Constants</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Value</th></tr></thead><tbody>
<tr><td><code>ETHLiquidity</code> Address</td><td><code>0x4200000000000000000000000000000000000025</code></td></tr>
<tr><td>Initial Balance</td><td><code>type(uint248).max</code> wei</td></tr>
</tbody></table>
</div>
<h2 id="definitions-7"><a class="header" href="#definitions-7">Definitions</a></h2>
<h3 id="eth-liquidity"><a class="header" href="#eth-liquidity">ETH Liquidity</a></h3>
<p>ETH Liquidity refers to the availability of native ETH on a particular chain. The <code>ETHLiquidity</code>
contract manages this liquidity by providing a mechanism to burn and mint ETH as needed for
cross-chain transfers.</p>
<h3 id="liquidity-minting"><a class="header" href="#liquidity-minting">Liquidity Minting</a></h3>
<p>Liquidity Minting is the process of withdrawing ETH from the <code>ETHLiquidity</code> contract. This
operation is performed when ETH needs to be sent to a recipient on a destination chain as part of
a cross-chain transfer.</p>
<h3 id="liquidity-burning"><a class="header" href="#liquidity-burning">Liquidity Burning</a></h3>
<p>Liquidity Burning is the process of depositing ETH into the <code>ETHLiquidity</code> contract. This operation
is performed when ETH is being sent from a source chain to a destination chain as part of a
cross-chain transfer.</p>
<h2 id="assumptions-5"><a class="header" href="#assumptions-5">Assumptions</a></h2>
<h3 id="ael-001-safesend-correctly-transfers-eth-to-recipients"><a class="header" href="#ael-001-safesend-correctly-transfers-eth-to-recipients">aEL-001: SafeSend correctly transfers ETH to recipients</a></h3>
<p>We assume that the <code>SafeSend</code> mechanism correctly transfers ETH to recipients without reverting
for valid addresses.</p>
<h4 id="mitigations-22"><a class="header" href="#mitigations-22">Mitigations</a></h4>
<ul>
<li>Extensive testing of the <code>SafeSend</code> mechanism</li>
<li>Audits of the ETH transfer logic</li>
</ul>
<h2 id="invariants-8"><a class="header" href="#invariants-8">Invariants</a></h2>
<h3 id="iel-001-eth-balance-is-always-sufficient-for-minting--burning"><a class="header" href="#iel-001-eth-balance-is-always-sufficient-for-minting--burning">iEL-001: ETH balance is always sufficient for minting / burning</a></h3>
<p>The <code>ETHLiquidity</code> contract must always have enough ETH to fulfill all legitimate minting / burning
requests.</p>
<h4 id="impact-23"><a class="header" href="#impact-23">Impact</a></h4>
<p><strong>Severity: Critical</strong></p>
<p>If this invariant is broken, the cross-chain ETH transfer mechanism would fail, potentially leading
to users being unable to receive their ETH on destination chains.</p>
<h3 id="iel-002-only-authorized-contracts-can-call-mint-and-burn"><a class="header" href="#iel-002-only-authorized-contracts-can-call-mint-and-burn">iEL-002: Only authorized contracts can call mint and burn</a></h3>
<p>The <code>mint</code> and <code>burn</code> functions must only be callable by authorized contracts (specifically the
<code>SuperchainETHBridge</code>).</p>
<h4 id="impact-24"><a class="header" href="#impact-24">Impact</a></h4>
<p><strong>Severity: Critical</strong></p>
<p>If this invariant is broken, unauthorized parties could mint ETH without burning an equivalent
amount on a source chain, leading to inflation.</p>
<h3 id="iel-003-contract-balance-never-overflows"><a class="header" href="#iel-003-contract-balance-never-overflows">iEL-003: Contract balance never overflows</a></h3>
<p>The <code>ETHLiquidity</code> contract's balance must never overflow due to excessive burning operations.</p>
<h4 id="impact-25"><a class="header" href="#impact-25">Impact</a></h4>
<p><strong>Severity: High</strong></p>
<p>If this invariant is broken, the contract could reach an invalid state, potentially disrupting the
cross-chain ETH transfer mechanism. The invariant that avoids overflow is maintained by
<code>SuperchainETHBridge</code>, but could theoretically be broken by some future contract that is allowed to
integrate with <code>ETHLiquidity</code>. Maintainers should be careful to ensure that such future contracts
do not break this invariant.</p>
<h2 id="function-specification-4"><a class="header" href="#function-specification-4">Function Specification</a></h2>
<h3 id="mint-1"><a class="header" href="#mint-1">mint</a></h3>
<p>Withdraws ETH from the <code>ETHLiquidity</code> contract equal to the <code>_amount</code> and sends it to the
<code>msg.sender</code>.</p>
<pre><code class="language-solidity">function mint(uint256 _amount) external
</code></pre>
<ul>
<li>MUST revert if called by any address other than the <code>SuperchainETHBridge</code>.</li>
<li>MUST transfer the <code>_amount</code> of ETH to the <code>msg.sender</code> using <code>SafeSend</code>.</li>
<li>MUST emit a <code>LiquidityMinted</code> event with the <code>msg.sender</code> and <code>_amount</code>.</li>
</ul>
<h3 id="burn"><a class="header" href="#burn">burn</a></h3>
<p>Locks ETH into the <code>ETHLiquidity</code> contract.</p>
<pre><code class="language-solidity">function burn() external payable;
</code></pre>
<ul>
<li>MUST accept ETH via <code>msg.value</code>.</li>
<li>MUST revert if called by any address other than the <code>SuperchainETHBridge</code>.</li>
<li>MUST emit a <code>LiquidityBurned</code> event with the <code>msg.sender</code> and <code>msg.value</code>.</li>
</ul>
<h2 id="events-3"><a class="header" href="#events-3">Events</a></h2>
<h3 id="liquidityminted"><a class="header" href="#liquidityminted">LiquidityMinted</a></h3>
<p>MUST be triggered when <code>mint</code> is called.</p>
<pre><code class="language-solidity">event LiquidityMinted(address indexed caller, uint256 value);
</code></pre>
<h3 id="liquidityburned"><a class="header" href="#liquidityburned">LiquidityBurned</a></h3>
<p>MUST be triggered when <code>burn</code> is called.</p>
<pre><code class="language-solidity">event LiquidityBurned(address indexed caller, uint256 value);
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="superchainethbridge-1"><a class="header" href="#superchainethbridge-1">SuperchainETHBridge</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="interop/superchain-eth-bridge.html#overview">Overview</a></li>
<li><a href="interop/superchain-eth-bridge.html#constants">Constants</a></li>
<li><a href="interop/superchain-eth-bridge.html#definitions">Definitions</a>
<ul>
<li><a href="interop/superchain-eth-bridge.html#eth-bridging">ETH Bridging</a></li>
<li><a href="interop/superchain-eth-bridge.html#eth-liquidity">ETH Liquidity</a></li>
<li><a href="interop/superchain-eth-bridge.html#cross-chain-message">Cross-Chain Message</a></li>
<li><a href="interop/superchain-eth-bridge.html#source-chain">Source Chain</a></li>
<li><a href="interop/superchain-eth-bridge.html#destination-chain">Destination Chain</a></li>
</ul>
</li>
<li><a href="interop/superchain-eth-bridge.html#assumptions">Assumptions</a>
<ul>
<li><a href="interop/superchain-eth-bridge.html#aseb-001-l2tol2crossdomainmessenger-properly-delivers-messages">aSEB-001: L2ToL2CrossDomainMessenger properly delivers messages</a>
<ul>
<li><a href="interop/superchain-eth-bridge.html#mitigations">Mitigations</a></li>
</ul>
</li>
<li><a href="interop/superchain-eth-bridge.html#aseb-002-ethliquidity-contract-maintains-sufficient-liquidity">aSEB-002: <code>ETHLiquidity</code> contract maintains sufficient liquidity</a>
<ul>
<li><a href="interop/superchain-eth-bridge.html#mitigations-1">Mitigations</a></li>
</ul>
</li>
<li><a href="interop/superchain-eth-bridge.html#aseb-003-safesend-correctly-transfers-eth-to-recipients">aSEB-003: <code>SafeSend</code> correctly transfers ETH to recipients</a>
<ul>
<li><a href="interop/superchain-eth-bridge.html#mitigations-2">Mitigations</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="interop/superchain-eth-bridge.html#invariants">Invariants</a>
<ul>
<li><a href="interop/superchain-eth-bridge.html#iseb-001-eth-sent-equals-eth-received">iSEB-001: ETH sent equals ETH received</a>
<ul>
<li><a href="interop/superchain-eth-bridge.html#impact">Impact</a></li>
<li><a href="interop/superchain-eth-bridge.html#dependencies">Dependencies</a></li>
</ul>
</li>
<li><a href="interop/superchain-eth-bridge.html#iseb-002-only-authorized-contracts-can-call-relayeth">iSEB-002: Only authorized contracts can call <code>relayETH</code></a>
<ul>
<li><a href="interop/superchain-eth-bridge.html#impact-1">Impact</a></li>
<li><a href="interop/superchain-eth-bridge.html#dependencies-1">Dependencies</a></li>
</ul>
</li>
<li><a href="interop/superchain-eth-bridge.html#iseb-003-eth-cannot-be-sent-to-the-zero-address">iSEB-003: ETH cannot be sent to the zero address</a>
<ul>
<li><a href="interop/superchain-eth-bridge.html#impact-2">Impact</a></li>
<li><a href="interop/superchain-eth-bridge.html#dependencies-2">Dependencies</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="interop/superchain-eth-bridge.html#function-specification">Function Specification</a>
<ul>
<li><a href="interop/superchain-eth-bridge.html#sendeth">sendETH</a></li>
<li><a href="interop/superchain-eth-bridge.html#relayeth">relayETH</a></li>
</ul>
</li>
<li><a href="interop/superchain-eth-bridge.html#events">Events</a>
<ul>
<li><a href="interop/superchain-eth-bridge.html#sendeth">SendETH</a></li>
<li><a href="interop/superchain-eth-bridge.html#relayeth">RelayETH</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-50"><a class="header" href="#overview-50">Overview</a></h2>
<p>The <code>SuperchainETHBridge</code> is a predeploy contract that facilitates cross-chain ETH bridging within
the Superchain interop set. It serves as an abstraction layer on top of the
<code>L2toL2CrossDomainMessenger</code> specifically designed for native ETH transfers between chains. The
contract integrates with the <code>ETHLiquidity</code> contract to manage native ETH liquidity across chains,
ensuring seamless cross-chain transfers of native ETH.</p>
<p>The <code>SuperchainETHBridge</code> only handles native ETH cross-chain transfers. For interoperable ETH
withdrawals, see the <a href="interop/./eth-lockbox.html"><code>ETHLockbox</code></a> specification.</p>
<h2 id="constants-2"><a class="header" href="#constants-2">Constants</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Value</th></tr></thead><tbody>
<tr><td><code>SuperchainETHBridge</code> Address</td><td><code>0x4200000000000000000000000000000000000024</code></td></tr>
</tbody></table>
</div>
<h2 id="definitions-8"><a class="header" href="#definitions-8">Definitions</a></h2>
<h3 id="eth-bridging"><a class="header" href="#eth-bridging">ETH Bridging</a></h3>
<p>ETH Bridging refers to the process of transferring native ETH from one chain to another within the
Superchain interop set. This process involves burning ETH on the source chain and minting an
equivalent amount on the destination chain.</p>
<h3 id="eth-liquidity-1"><a class="header" href="#eth-liquidity-1">ETH Liquidity</a></h3>
<p>ETH Liquidity refers to the availability of native ETH on a particular chain. The <code>ETHLiquidity</code>
contract manages this liquidity by providing a mechanism to burn and mint ETH as needed for
cross-chain transfers.</p>
<h3 id="cross-chain-message"><a class="header" href="#cross-chain-message">Cross-Chain Message</a></h3>
<p>A Cross-Chain Message is a message sent from one chain to another using the
<code>L2ToL2CrossDomainMessenger</code>. In the context of the <code>SuperchainETHBridge</code>, these messages contain
instructions to relay ETH to a recipient on the destination chain.</p>
<h3 id="source-chain"><a class="header" href="#source-chain">Source Chain</a></h3>
<p>The Source Chain is the chain from which a user initiates an ETH transfer. On this chain, ETH is
burned from the user's account and a cross-chain message is sent to the destination chain.</p>
<h3 id="destination-chain"><a class="header" href="#destination-chain">Destination Chain</a></h3>
<p>The Destination Chain is the chain to which ETH is being transferred. On this chain, ETH is sent
to the recipient's account based on the cross-chain message received from the source chain.</p>
<h2 id="assumptions-6"><a class="header" href="#assumptions-6">Assumptions</a></h2>
<h3 id="aseb-001-l2tol2crossdomainmessenger-properly-delivers-messages"><a class="header" href="#aseb-001-l2tol2crossdomainmessenger-properly-delivers-messages">aSEB-001: L2ToL2CrossDomainMessenger properly delivers messages</a></h3>
<p>We assume that the <code>L2ToL2CrossDomainMessenger</code> contract properly and faithfully delivers messages
between chains, maintaining the integrity and authenticity of the message contents.</p>
<h4 id="mitigations-23"><a class="header" href="#mitigations-23">Mitigations</a></h4>
<ul>
<li>Extensive testing of the <code>L2ToL2CrossDomainMessenger</code> contract</li>
<li>Audits of the messaging protocol</li>
<li>Monitoring of cross-chain message delivery</li>
</ul>
<h3 id="aseb-002-ethliquidity-contract-maintains-sufficient-liquidity"><a class="header" href="#aseb-002-ethliquidity-contract-maintains-sufficient-liquidity">aSEB-002: <code>ETHLiquidity</code> contract maintains sufficient liquidity</a></h3>
<p>We assume that the <code>ETHLiquidity</code> contract maintains sufficient liquidity to fulfill all valid ETH
minting requests. This is ensured by initializing the contract with <code>type(uint248).max</code> wei.</p>
<h4 id="mitigations-24"><a class="header" href="#mitigations-24">Mitigations</a></h4>
<ul>
<li>Total ETH supply is much less than the initial balance of the <code>ETHLiquidity</code> contract</li>
<li>Contract is initially initialized with <code>type(uint248).max</code> wei and can hold up to
<code>type(uint256).max</code> wei to prevent balance overflow</li>
</ul>
<h3 id="aseb-003-safesend-correctly-transfers-eth-to-recipients"><a class="header" href="#aseb-003-safesend-correctly-transfers-eth-to-recipients">aSEB-003: <code>SafeSend</code> correctly transfers ETH to recipients</a></h3>
<p>We assume that the <code>SafeSend</code> mechanism correctly transfers ETH to recipients without reverting
for valid addresses.</p>
<h4 id="mitigations-25"><a class="header" href="#mitigations-25">Mitigations</a></h4>
<ul>
<li>Extensive testing of the <code>SafeSend</code> mechanism</li>
<li>Audits of the ETH transfer logic</li>
</ul>
<h2 id="invariants-9"><a class="header" href="#invariants-9">Invariants</a></h2>
<h3 id="iseb-001-eth-sent-equals-eth-received"><a class="header" href="#iseb-001-eth-sent-equals-eth-received">iSEB-001: ETH sent equals ETH received</a></h3>
<p>The amount of ETH sent from the source chain must equal the amount of ETH received on the
destination chain for any given cross-chain transfer.</p>
<h4 id="impact-26"><a class="header" href="#impact-26">Impact</a></h4>
<p><strong>Severity: Critical</strong></p>
<p>If this invariant is broken, users could receive more or less ETH than they sent, leading to
inflation or loss of funds.</p>
<h4 id="dependencies-12"><a class="header" href="#dependencies-12">Dependencies</a></h4>
<ul>
<li><a href="interop/superchain-eth-bridge.html#aseb-001-l2tol2crossdomainmessenger-properly-delivers-messages">aSEB-001</a></li>
<li><a href="interop/superchain-eth-bridge.html#aseb-002-ethliquidity-contract-maintains-sufficient-liquidity">aSEB-002</a></li>
</ul>
<h3 id="iseb-002-only-authorized-contracts-can-call-relayeth"><a class="header" href="#iseb-002-only-authorized-contracts-can-call-relayeth">iSEB-002: Only authorized contracts can call <code>relayETH</code></a></h3>
<p>The <code>relayETH</code> function must only be callable by the <code>L2ToL2CrossDomainMessenger</code> contract, and the
cross-domain sender must be the <code>SuperchainETHBridge</code> contract on the source chain.</p>
<h4 id="impact-27"><a class="header" href="#impact-27">Impact</a></h4>
<p><strong>Severity: Critical</strong></p>
<p>If this invariant is broken, unauthorized parties could mint ETH on the destination chain without
burning an equivalent amount on the source chain, leading to inflation.</p>
<h4 id="dependencies-13"><a class="header" href="#dependencies-13">Dependencies</a></h4>
<ul>
<li><a href="interop/superchain-eth-bridge.html#aseb-001-l2tol2crossdomainmessenger-properly-delivers-messages">aSEB-001</a></li>
</ul>
<h3 id="iseb-003-eth-cannot-be-sent-to-the-zero-address"><a class="header" href="#iseb-003-eth-cannot-be-sent-to-the-zero-address">iSEB-003: ETH cannot be sent to the zero address</a></h3>
<p>The <code>sendETH</code> function must revert if the recipient address is the zero address.</p>
<h4 id="impact-28"><a class="header" href="#impact-28">Impact</a></h4>
<p><strong>Severity: High</strong></p>
<p>If this invariant is broken, ETH could be sent to the zero address, effectively burning it without
the possibility of recovery.</p>
<h4 id="dependencies-14"><a class="header" href="#dependencies-14">Dependencies</a></h4>
<p>None</p>
<h2 id="function-specification-5"><a class="header" href="#function-specification-5">Function Specification</a></h2>
<h3 id="sendeth"><a class="header" href="#sendeth">sendETH</a></h3>
<p>Deposits the <code>msg.value</code> of ETH into the <code>ETHLiquidity</code> contract and sends a cross-chain message
to the specified <code>_chainId</code> to call <code>relayETH</code> with the <code>_to</code> address as the recipient and the
<code>msg.value</code> as the amount.</p>
<pre><code class="language-solidity">function sendETH(address _to, uint256 _chainId) external payable returns (bytes32 msgHash_);
</code></pre>
<ul>
<li>MUST accept ETH via <code>msg.value</code>.</li>
<li>MUST revert if the <code>_to</code> address is the zero address.</li>
<li>MUST transfer <code>msg.value</code> of ETH from the <code>msg.sender</code> to the <code>ETHLiquidity</code> contract by calling
<code>ETHLiquidity.burn{value: msg.value}()</code>.</li>
<li>MUST create a cross-chain message to the <code>SuperchainETHBridge</code> contract on the destination chain
with the following parameters:
<ul>
<li><code>_chainId</code>: The destination chain ID.</li>
<li><code>message</code>: An encoded call to <code>relayETH(msg.sender, _to, msg.value)</code>.</li>
</ul>
</li>
<li>MUST return the message hash <code>msgHash_</code> generated by the <code>L2ToL2CrossDomainMessenger</code>.</li>
<li>MUST emit a <code>SendETH</code> event with the <code>msg.sender</code>, <code>_to</code>, <code>msg.value</code>, and <code>_chainId</code>.</li>
</ul>
<h3 id="relayeth"><a class="header" href="#relayeth">relayETH</a></h3>
<p>Withdraws ETH from the <code>ETHLiquidity</code> contract equal to the <code>_amount</code> and sends it to the <code>_to</code> address.</p>
<pre><code class="language-solidity">function relayETH(address _from, address _to, uint256 _amount) external;
</code></pre>
<ul>
<li>MUST revert if called by any address other than the <code>L2ToL2CrossDomainMessenger</code>.</li>
<li>MUST revert if the cross-domain sender is not the <code>SuperchainETHBridge</code> contract on the source
chain.</li>
<li>MUST withdraw <code>_amount</code> of ETH from the <code>ETHLiquidity</code> contract by calling
<code>ETHLiquidity.mint(_amount)</code>.</li>
<li>MUST transfer the <code>_amount</code> of ETH to the <code>_to</code> address using
<code>new SafeSend{value: _amount}(_to)</code>.</li>
<li>MUST emit a <code>RelayETH</code> event with the <code>_from</code> address, <code>_to</code> address, <code>_amount</code>, and source chain
ID.</li>
</ul>
<h2 id="events-4"><a class="header" href="#events-4">Events</a></h2>
<h3 id="sendeth-1"><a class="header" href="#sendeth-1">SendETH</a></h3>
<p>MUST be triggered when <code>sendETH</code> is called.</p>
<pre><code class="language-solidity">event SendETH(address indexed from, address indexed to, uint256 amount, uint256 destination);
</code></pre>
<h3 id="relayeth-1"><a class="header" href="#relayeth-1">RelayETH</a></h3>
<p>MUST be triggered when <code>relayETH</code> is called.</p>
<pre><code class="language-solidity">event RelayETH(address indexed from, address indexed to, uint256 amount, uint256 source);
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="eth-bridging-1"><a class="header" href="#eth-bridging-1">ETH Bridging</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="interop/eth-bridging.html#overview">Overview</a></li>
<li><a href="interop/eth-bridging.html#constants">Constants</a></li>
<li><a href="interop/eth-bridging.html#design">Design</a>
<ul>
<li><a href="interop/eth-bridging.html#diagram">Diagram</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-51"><a class="header" href="#overview-51">Overview</a></h2>
<p>ETH is bridged between chains within the Superchain interop set by using the <code>SuperchainETHBridge</code>
predeploy for message passing and the <code>ETHLiquidity</code> contract for supplying native ETH liquidity.</p>
<h2 id="constants-3"><a class="header" href="#constants-3">Constants</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Value</th></tr></thead><tbody>
<tr><td><code>SuperchainETHBridge</code> Address</td><td><code>0x4200000000000000000000000000000000000024</code></td></tr>
<tr><td><code>ETHLiquidity</code> Address</td><td><code>0x4200000000000000000000000000000000000025</code></td></tr>
</tbody></table>
</div>
<h2 id="design"><a class="header" href="#design">Design</a></h2>
<p>See the <a href="interop/./superchain-eth-bridge.html">SuperchainETHBridge</a> spec for the design of the
<code>SuperchainETHBridge</code> predeploy and the <a href="interop/./eth-liquidity.html">ETHLiquidity</a> spec for
the design of the <code>ETHLiquidity</code> contract.</p>
<h3 id="diagram-2"><a class="header" href="#diagram-2">Diagram</a></h3>
<p>The following diagram depicts a cross-chain ETH transfer.</p>
<pre class="mermaid">---
config:
  theme: dark
  fontSize: 48
---
sequenceDiagram
  participant from as from (Chain A)
  participant L2SBA as SuperchainETHBridge (Chain A)
  participant ETHLiquidity_A as ETHLiquidity (Chain A)
  participant Messenger_A as L2ToL2CrossDomainMessenger (Chain A)
  participant Inbox as CrossL2Inbox
  participant Messenger_B as L2ToL2CrossDomainMessenger (Chain B)
  participant L2SBB as SuperchainETHBridge (Chain B)
  participant ETHLiquidity_B as ETHLiquidity (Chain B)
  participant recipient as recipient (Chain B)

  from-&gt;&gt;L2SBA: sendETH{value: amount}(to, chainId)
  L2SBA-&gt;&gt;ETHLiquidity_A: burn{value: amount}()
  ETHLiquidity_A--&gt;ETHLiquidity_A: emit LiquidityBurned(from, amount)
  L2SBA-&gt;&gt;Messenger_A: sendMessage(chainId, message)
  Messenger_A-&gt;&gt;L2SBA: return msgHash_
  L2SBA--&gt;L2SBA: emit SendETH(from, to, amount, destination)
  L2SBA-&gt;&gt;from: return msgHash_
  Inbox-&gt;&gt;Messenger_B: relayMessage()
  Messenger_B-&gt;&gt;L2SBB: relayETH(from, to, amount)
  L2SBB-&gt;&gt;ETHLiquidity_B: mint(amount)
  ETHLiquidity_B--&gt;ETHLiquidity_B: emit LiquidityMinted(SuperchainETHBridge address, amount)
  L2SBB-&gt;&gt;recipient: new SafeSend{value: amount}(to)
  L2SBB--&gt;L2SBB: emit RelayETH(from, to, amount, source)
</pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="derivation-4"><a class="header" href="#derivation-4">Derivation</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="interop/derivation.html#overview">Overview</a></li>
<li><a href="interop/derivation.html#invariants">Invariants</a></li>
<li><a href="interop/derivation.html#activation-block">Activation Block</a></li>
<li><a href="interop/derivation.html#replacing-invalid-blocks">Replacing Invalid Blocks</a>
<ul>
<li><a href="interop/derivation.html#optimistic-block-deposited-transaction">Optimistic Block Deposited Transaction</a>
<ul>
<li><a href="interop/derivation.html#optimistic-block-source-hash">Optimistic Block Source-hash</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="interop/derivation.html#network-upgrade-transactions">Network Upgrade Transactions</a>
<ul>
<li><a href="interop/derivation.html#l2tol2crossdomainmessenger-deployment">L2ToL2CrossDomainMessenger Deployment</a></li>
<li><a href="interop/derivation.html#l2tol2crossdomainmessenger-proxy-update">L2ToL2CrossDomainMessenger Proxy Update</a></li>
<li><a href="interop/derivation.html#l2-gas-limit-requirements">L2 Gas Limit Requirements</a></li>
</ul>
</li>
<li><a href="interop/derivation.html#crossl2inboxproxy-initialization">CrossL2InboxProxy Initialization</a>
<ul>
<li><a href="interop/derivation.html#crossl2inbox-deployment">CrossL2Inbox Deployment</a></li>
<li><a href="interop/derivation.html#crossl2inbox-proxy-update">CrossL2Inbox Proxy Update</a></li>
<li><a href="interop/derivation.html#l2-gas-limit-requirements-1">L2 Gas Limit Requirements</a></li>
</ul>
</li>
<li><a href="interop/derivation.html#expiry-window">Expiry Window</a></li>
<li><a href="interop/derivation.html#security-considerations">Security Considerations</a>
<ul>
<li><a href="interop/derivation.html#depositing-an-executing-message">Depositing an Executing Message</a></li>
<li><a href="interop/derivation.html#expiry-window-1">Expiry Window</a></li>
<li><a href="interop/derivation.html#reliance-on-history">Reliance on History</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-52"><a class="header" href="#overview-52">Overview</a></h2>
<p>New derivation rules are added to guarantee integrity of cross chain messages.
The fork choice rule is updated to fork out unsafe blocks that contain invalid
executing messages.</p>
<h2 id="invariants-10"><a class="header" href="#invariants-10">Invariants</a></h2>
<ul>
<li>An executing message MUST have a corresponding initiating message</li>
<li>The initiating message referenced in an executing message MUST come from a chain in its dependency set</li>
<li>A block MUST be considered invalid if it is built with any invalid executing messages</li>
<li>The block number <code>n</code> is <code>&gt;</code> the activation block number, see <a href="interop/derivation.html#activation-block">Activation Block</a>.</li>
<li>The timestamp <code>t</code> of the identifier MUST be:
<ul>
<li><code>t &lt;= execution_timestamp</code>, where <code>execution_timestamp</code> is the timestamp of the block
that includes the executing message.</li>
<li><code>t &gt; execution_timestamp - expiry_window</code>, where <code>expiry_window</code> is the expiry window in seconds.</li>
</ul>
</li>
</ul>
<p>L2 blocks that produce invalid executing messages MUST not be allowed to be considered safe.
They MAY optimistically exist as unsafe blocks for some period of time. An L2 block that is invalidated
because it includes invalid executing messages MUST be replaced by a deposits only block at the same
block height. This guarantees progression of the chain, ensuring that an infinite loop of processing
the same block in the proof system is not possible.</p>
<h2 id="activation-block"><a class="header" href="#activation-block">Activation Block</a></h2>
<p>The activation block is the first block that has a timestamp higher or equal to the
interop network upgrade timestamp.
The activation block timestamp may not exactly match the upgrade timestamp.</p>
<p>The genesis block is not technically considered an activation-block, as forks are already active.
However, the genesis block does not contain transactions, and thus also meets the activation criteria.</p>
<p>The activation block has several special properties and constraints:</p>
<ul>
<li>It MUST NOT include any non-deposit-type transactions.
Sequencers, when building the fork activation block, MUST set <code>noTxPool</code> to <code>true</code>
in the execution payload attributes for this block, instructing the builder to exclude user transactions.</li>
<li>Messages MUST NOT be executed in this block. This is implemented by only processing deposit-type transactions.</li>
<li>Any contract log events MUST NOT count as valid initiating messages.
Verifiers may use the activation block as an anchor point, without indexing the block-contents.</li>
<li>The derivation pipeline MUST enforce that the sequencer has not included any user transactions in
the batch covering the upgrade's activation block. If the sequencer includes any user transactions
within the activation block, this block and the remaining span batch it originated from
(if part of a span batch) MUST be dropped,
following the batch-dropping rules introduced in the
<a href="interop/../protocol/holocene/derivation.html#span-batches">Holocene upgrade span-batch rules</a>.</li>
</ul>
<h2 id="replacing-invalid-blocks"><a class="header" href="#replacing-invalid-blocks">Replacing Invalid Blocks</a></h2>
<p>When the <a href="interop/./messaging.html#resolving-cross-chain-safety">cross chain dependency resolution</a> determines
that a block contains an <a href="interop/./messaging.html#invalid-messages">invalid message</a>, the block is replaced
by a block with the same inputs, except for the transactions included. The transactions from the
original block are trimmed to include only deposit transactions plus an
<a href="interop/derivation.html#optimistic-block-deposited-transaction">optimistic block info deposit transaction</a>, which is appended
to the trimmed transaction list.</p>
<h3 id="optimistic-block-deposited-transaction"><a class="header" href="#optimistic-block-deposited-transaction">Optimistic Block Deposited Transaction</a></h3>
<p>An Optimistic Block Deposited Transaction is a system deposited transaction,
inserted into the replacement block,
to signal when a previously derived local-safe block (the "optimistic" block) was invalidated.</p>
<p>This transaction MUST have the following values:</p>
<ol>
<li><code>from</code> is <code>0xdeaddeaddeaddeaddeaddeaddeaddeaddead0002</code>, like the address of the
<a href="interop/../protocol/deposits.html#l1-attributes-depositor-account">L1 Attributes depositor account</a>, but incremented by 1</li>
<li><code>to</code> is <code>0x0000000000000000000000000000000000000000</code> (the zero address as no EVM code execution is expected).</li>
<li><code>mint</code> is <code>0</code></li>
<li><code>value</code> is <code>0</code></li>
<li><code>gasLimit</code> is set <code>36000</code> gas, to cover intrinsic costs, processing costs, and margin for change.</li>
<li><code>isSystemTx</code> is set to <code>false</code>.</li>
<li><code>data</code> is the preimage of the <a href="interop/../glossary.html#l2-output-root-proposals">L2 output root</a>
of the replaced block. i.e. <code>version_byte || payload</code> without applying the <code>keccak256</code> hashing.</li>
<li><code>sourceHash</code> is computed with a new deposit source-hash domain, see below.</li>
</ol>
<p>This system-initiated transaction for L1 attributes is not charged any ETH for its allocated
<code>gasLimit</code>, as it is considered part of state-transition processing.</p>
<h4 id="optimistic-block-source-hash"><a class="header" href="#optimistic-block-source-hash">Optimistic Block Source-hash</a></h4>
<p>The source hash is <a href="interop/../protocol/deposits.html#source-hash-computation">computed</a>
with a source-hash domain: <code>4</code> (instead of <code>1</code>),
combined with the <a href="interop/../glossary.html#l2-output-root-proposals">L2 output root</a> of the optimistic block that was invalidated.</p>
<p>The source-hash is thus computed as:
<code>keccak256(bytes32(uint256(4)), outputRoot))</code>.</p>
<h2 id="network-upgrade-transactions-1"><a class="header" href="#network-upgrade-transactions-1">Network Upgrade Transactions</a></h2>
<p>The interop network upgrade timestamp defines the timestamp at which all functionality in this document is considered
the consensus rules for an OP Stack based network.</p>
<p>The upgrade transaction details below are based on a nightly release at commit
hash <code>71c460ec7c7c05791ddd841b97bcb664a1f0c753</code>, and will be updated once a
contracts release is made.</p>
<p>On the <a href="interop/derivation.html#activation-block">activation block</a>, a set of deposit transaction
based upgrade transactions are deterministically generated by the derivation pipeline in the following order:</p>
<!-- To regenerate the deploy/upgrade tx docs below, run `./scripts/upgrades/gen_interop_upgrade_tx_specs.sh | pbcopy` and then paste here -->
<h3 id="l2tol2crossdomainmessenger-deployment"><a class="header" href="#l2tol2crossdomainmessenger-deployment">L2ToL2CrossDomainMessenger Deployment</a></h3>
<!-- Generated with: ./scripts/run_gen_predeploy_docs.sh
--optimism-repo-path ../optimism
--fork-name Interop
--contract-name L2ToL2CrossDomainMessenger
--from-address 0x4220000000000000000000000000000000000001
--from-address-nonce 0
--git-commit-hash 71c460ec7c7c05791ddd841b97bcb664a1f0c753
--eth-rpc-url https://optimism.rpc.subquery.network/public
--proxy-address 0x4200000000000000000000000000000000000023
--copy-contract-bytecode true -->
<p>The <code>L2ToL2CrossDomainMessenger</code> contract is deployed.</p>
<p>A deposit transaction is derived with the following attributes:</p>
<ul>
<li><code>from</code>: <code>0x4220000000000000000000000000000000000001</code></li>
<li><code>to</code>: <code>null</code></li>
<li><code>mint</code>: <code>0</code></li>
<li><code>value</code>: <code>0</code></li>
<li><code>nonce</code>: <code>0</code></li>
<li><code>gasLimit</code>: <code>1100000</code></li>
<li><code>data</code>: <code>0x6080604052348015600e575f80fd5b...</code> (<a href="interop/../static/bytecode/interop-l2-to-l2-cross-domain-messenger-deployment.txt">full bytecode</a>)</li>
<li><code>sourceHash</code>: <code>0xf5484697c7a9a791db32a3bf0763bf2ba686c77ae7d4c0a5ee8c222a92a8dcc2</code>,<br />
computed with the "Upgrade-deposited" type, with <code>intent = "Interop: L2ToL2CrossDomainMessenger Deployment"</code></li>
</ul>
<p>This results in the Interop L2ToL2CrossDomainMessenger contract being deployed to
<code>0x0D0eDd0ebd0e94d218670a8De867Eb5C4d37cadD</code>, to verify:</p>
<pre><code class="language-bash">cast compute-address --nonce=0 0x4220000000000000000000000000000000000001
Computed Address: 0x0D0eDd0ebd0e94d218670a8De867Eb5C4d37cadD
</code></pre>
<p>Verify <code>sourceHash</code>:</p>
<pre><code class="language-bash">cast keccak $(cast concat-hex 0x0000000000000000000000000000000000000000000000000000000000000002 $(cast keccak "Interop: L2ToL2CrossDomainMessenger Deployment"))
# 0xf5484697c7a9a791db32a3bf0763bf2ba686c77ae7d4c0a5ee8c222a92a8dcc2
</code></pre>
<p>Verify <code>data</code>:</p>
<pre><code class="language-bash">git checkout 71c460ec7c7c05791ddd841b97bcb664a1f0c753
make build-contracts
jq -r ".bytecode.object" packages/contracts-bedrock/forge-artifacts/L2ToL2CrossDomainMessenger.sol/L2ToL2CrossDomainMessenger.json
</code></pre>
<p>This transaction MUST deploy a contract with the following code hash<br />
<code>0x458925c90ec70736600bef3d6529643a0e7a0a848e62626d61314c057b4a71a9</code>.</p>
<p>To verify the code hash:</p>
<pre><code class="language-bash">git checkout 71c460ec7c7c05791ddd841b97bcb664a1f0c753
make build-contracts
cast k $(jq -r ".deployedBytecode.object" packages/contracts-bedrock/forge-artifacts/L2ToL2CrossDomainMessenger.sol/L2ToL2CrossDomainMessenger.json)
</code></pre>
<h3 id="l2tol2crossdomainmessenger-proxy-update"><a class="header" href="#l2tol2crossdomainmessenger-proxy-update">L2ToL2CrossDomainMessenger Proxy Update</a></h3>
<p>This transaction updates the L2ToL2CrossDomainMessenger Proxy ERC-1967
implementation slot to point to the new L2ToL2CrossDomainMessenger deployment.</p>
<p>A deposit transaction is derived with the following attributes:</p>
<ul>
<li><code>from</code>: <code>0x0000000000000000000000000000000000000000</code></li>
<li><code>to</code>: <code>0x4200000000000000000000000000000000000023</code> (L2ToL2CrossDomainMessenger Proxy)</li>
<li><code>mint</code>: <code>0</code></li>
<li><code>value</code>: <code>0</code></li>
<li><code>gasLimit</code>: <code>50,000</code></li>
<li><code>data</code>: <code>0x3659cfe60000000000000000000000000d0edd0ebd0e94d218670a8de867eb5c4d37cadd</code></li>
<li><code>sourceHash</code>: <code>0xe54b4d06bbcc857f41ae00e89d820339ac5ce0034aac722c817b2873e03a7e68</code>
computed with the "Upgrade-deposited" type, with <code>intent = "Interop: L2ToL2CrossDomainMessenger Proxy Update"</code></li>
</ul>
<p>Verify data:</p>
<pre><code class="language-bash">cast concat-hex $(cast sig "upgradeTo(address)") $(cast abi-encode "upgradeTo(address)" 0x0D0eDd0ebd0e94d218670a8De867Eb5C4d37cadD)
# 0x3659cfe60000000000000000000000000d0edd0ebd0e94d218670a8de867eb5c4d37cadd
</code></pre>
<p>Verify <code>sourceHash</code>:</p>
<pre><code class="language-bash">cast keccak $(cast concat-hex 0x0000000000000000000000000000000000000000000000000000000000000002 $(cast keccak "Interop: L2ToL2CrossDomainMessenger Proxy Update"))
# 0xe54b4d06bbcc857f41ae00e89d820339ac5ce0034aac722c817b2873e03a7e68
</code></pre>
<h3 id="l2-gas-limit-requirements"><a class="header" href="#l2-gas-limit-requirements">L2 Gas Limit Requirements</a></h3>
<p>This upgrade requires <code>3_270_000</code> in gas, plus <code>50_000</code> gas if the CrossL2Inbox proxy is initialized in the same block.
In order to upgrade successfully the following invariant MUST be maintained:</p>
<pre><code class="language-plaintext">MaxResourceLimit + SystemTxMaxGas + UpgradeGasUsage â‰¤ L2GasLimit
</code></pre>
<p>With MaxResourceLimit set to <code>20_000_000</code> and SystemTxMaxGas set to <code>1_000_000</code>,
this mean every upgrading chain MUST have their L2GasLimit set to greater than
<code>24_320_000</code>.</p>
<h2 id="crossl2inboxproxy-initialization"><a class="header" href="#crossl2inboxproxy-initialization">CrossL2InboxProxy Initialization</a></h2>
<p>On the first block at or after the interop  <a href="interop/derivation.html#activation-block">activation block</a>, where the current chain is in a
dependency set with two or more active chains, a deposit transaction based upgrade transaction is deterministically
generated by the derivation pipeline:</p>
<h3 id="crossl2inbox-deployment"><a class="header" href="#crossl2inbox-deployment">CrossL2Inbox Deployment</a></h3>
<!-- Generated with: ./scripts/run_gen_predeploy_docs.sh
--optimism-repo-path ../optimism
--fork-name Interop
--contract-name CrossL2Inbox
--from-address 0x4220000000000000000000000000000000000000
--from-address-nonce 0
--git-commit-hash 71c460ec7c7c05791ddd841b97bcb664a1f0c753
--eth-rpc-url https://optimism.rpc.subquery.network/public
--proxy-address 0x4200000000000000000000000000000000000022
--copy-contract-bytecode true -->
<p>The <code>CrossL2Inbox</code> contract is deployed.</p>
<p>A deposit transaction is derived with the following attributes:</p>
<ul>
<li><code>from</code>: <code>0x4220000000000000000000000000000000000000</code></li>
<li><code>to</code>: <code>null</code></li>
<li><code>mint</code>: <code>0</code></li>
<li><code>value</code>: <code>0</code></li>
<li><code>nonce</code>: <code>0</code></li>
<li><code>gasLimit</code>: <code>420000</code></li>
<li><code>data</code>: <code>0x6080604052348015600e575f80fd5b...</code> (<a href="interop/../static/bytecode/interop-cross-l2-inbox-deployment.txt">full bytecode</a>)</li>
<li><code>sourceHash</code>: <code>0x6e5e214f73143df8fe6f6054a3ed7eb472d373376458a9c8aecdf23475beb616</code>,<br />
computed with the "Upgrade-deposited" type, with <code>intent = "Interop: CrossL2Inbox Deployment"</code></li>
</ul>
<p>This results in the Interop CrossL2Inbox contract being deployed to
<code>0x691300f512e48B463C2617b34Eef1A9f82EE7dBf</code>, to verify:</p>
<pre><code class="language-bash">cast compute-address --nonce=0 0x4220000000000000000000000000000000000000
Computed Address: 0x691300f512e48B463C2617b34Eef1A9f82EE7dBf
</code></pre>
<p>Verify <code>sourceHash</code>:</p>
<pre><code class="language-bash">cast keccak $(cast concat-hex 0x0000000000000000000000000000000000000000000000000000000000000002 $(cast keccak "Interop: CrossL2Inbox Deployment"))
# 0x6e5e214f73143df8fe6f6054a3ed7eb472d373376458a9c8aecdf23475beb616
</code></pre>
<p>Verify <code>data</code>:</p>
<pre><code class="language-bash">git checkout 71c460ec7c7c05791ddd841b97bcb664a1f0c753
make build-contracts
jq -r ".bytecode.object" packages/contracts-bedrock/forge-artifacts/CrossL2Inbox.sol/CrossL2Inbox.json
</code></pre>
<p>This transaction MUST deploy a contract with the following code hash<br />
<code>0x0e7d028dd71bac22d1fb28966043c8d35c3232c78b7fb99fd1db112b5b60d9dd</code>.</p>
<p>To verify the code hash:</p>
<pre><code class="language-bash">git checkout 71c460ec7c7c05791ddd841b97bcb664a1f0c753
make build-contracts
cast k $(jq -r ".deployedBytecode.object" packages/contracts-bedrock/forge-artifacts/CrossL2Inbox.sol/CrossL2Inbox.json)
</code></pre>
<h3 id="crossl2inbox-proxy-update"><a class="header" href="#crossl2inbox-proxy-update">CrossL2Inbox Proxy Update</a></h3>
<p>This transaction updates the CrossL2Inbox Proxy ERC-1967
implementation slot to point to the CrossL2Inbox deployment deployed at the interop activation block.</p>
<p>A deposit transaction is derived with the following attributes:</p>
<ul>
<li><code>from</code>: <code>0x0000000000000000000000000000000000000000</code></li>
<li><code>to</code>: <code>0x4200000000000000000000000000000000000022</code> (CrossL2Inbox Proxy)</li>
<li><code>mint</code>: <code>0</code></li>
<li><code>value</code>: <code>0</code></li>
<li><code>gasLimit</code>: <code>50,000</code></li>
<li><code>data</code>: <code>0x3659cfe6000000000000000000000000691300f512e48b463c2617b34eef1a9f82ee7dbf</code></li>
<li><code>sourceHash</code>: <code>0x88c6b48354c367125a59792a93a7b60ad7cd66e516157dbba16558c68a46d3cb</code>
computed with the "Upgrade-deposited" type, with <code>intent = "Interop: CrossL2Inbox Proxy Update"</code></li>
</ul>
<p>Verify data:</p>
<pre><code class="language-bash">cast concat-hex $(cast sig "upgradeTo(address)") $(cast abi-encode "upgradeTo(address)" 0x691300f512e48B463C2617b34Eef1A9f82EE7dBf)
# 0x3659cfe6000000000000000000000000691300f512e48b463c2617b34eef1a9f82ee7dbf
</code></pre>
<p>Verify <code>sourceHash</code>:</p>
<pre><code class="language-bash">cast keccak $(cast concat-hex 0x0000000000000000000000000000000000000000000000000000000000000002 $(cast keccak "Interop: CrossL2Inbox Proxy Update"))
# 0x88c6b48354c367125a59792a93a7b60ad7cd66e516157dbba16558c68a46d3cb
</code></pre>
<h3 id="l2-gas-limit-requirements-1"><a class="header" href="#l2-gas-limit-requirements-1">L2 Gas Limit Requirements</a></h3>
<p>Deploying and initializing the CrossL2InboxProxy requires <code>470_000</code> in gas. This fits within the standard SystemTxMaxGas
of <code>1_000_000</code> even allowing for the gas used by the
<a href="interop/../glossary.html#l1-attributes-deposited-transaction">L1 attributes deposited transaction</a>.</p>
<h2 id="expiry-window"><a class="header" href="#expiry-window">Expiry Window</a></h2>
<p>The expiry window is the time period after which an initiating message is no longer considered valid.</p>
<div class="table-wrapper"><table><thead><tr><th>Constant</th><th>Value</th></tr></thead><tbody>
<tr><td><code>EXPIRY_WINDOW</code></td><td><code>604800 secs</code> (7 days)</td></tr>
</tbody></table>
</div>
<h2 id="security-considerations-13"><a class="header" href="#security-considerations-13">Security Considerations</a></h2>
<h3 id="depositing-an-executing-message"><a class="header" href="#depositing-an-executing-message">Depositing an Executing Message</a></h3>
<p>Deposit transactions (force inclusion transactions) give censorship resistance to layer two networks.
If it were possible to deposit an invalid executing message, this would force the sequencer to reorg. It would
be fairly cheap to continuously deposit invalid executing messages through L1 and cause L2 liveness
instability, therefore deposits are prevented from triggering executing messages.
A future upgrade may enable deposits to trigger executing messages.</p>
<h3 id="expiry-window-1"><a class="header" href="#expiry-window-1">Expiry Window</a></h3>
<p>The expiry window ensures that the proof can execute in a reasonable amount of time. <a href="https://eips.ethereum.org/EIPS/eip-2935"><code>EIP-2935</code></a> introduced
the capability to traverse history with sub-linear complexity, however deep lookups remain expensive. App developers and
users, in the event that they encounter a message that has expired but has yet to be relayed, can
<a href="https://github.com/ethereum-optimism/design-docs/blob/25ef5537e39b63cddf1c83479cee9f0e02431dce/protocol/resend-messages.md#L4">resend the message</a> in order to complete the process.</p>
<h3 id="reliance-on-history"><a class="header" href="#reliance-on-history">Reliance on History</a></h3>
<p>When fully executing historical blocks, a dependency on historical receipts from remote chains is present.
<a href="https://eips.ethereum.org/EIPS/eip-4444">EIP-4444</a> will eventually provide a solution for making historical receipts available without
needing to execute increasingly long chain histories.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="transaction-pool"><a class="header" href="#transaction-pool">Transaction pool</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="interop/tx-pool.html#overview">Overview</a></li>
<li><a href="interop/tx-pool.html#transaction-validation">Transaction validation</a></li>
<li><a href="interop/tx-pool.html#system-deposits-transaction-margin">System deposits transaction margin</a></li>
<li><a href="interop/tx-pool.html#security-considerations">Security Considerations</a>
<ul>
<li><a href="interop/tx-pool.html#mempool-denial-of-service">Mempool Denial of Service</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-53"><a class="header" href="#overview-53">Overview</a></h2>
<p>The transaction pool (also known as the mempool) is where pending user transactions accumulate
before being included in a block. When a user submits a transaction to a node, it is validated
and inserted into the node's transaction pool before being broadcasted via p2p network to other nodes.</p>
<p>Since there is little cost to sending invalid transactions over the p2p network maliciously,
Ethereum opts to ensure that the transactions can be validated as cheaply as possible. This validation
consists of a nonce and balance (fee payment) check, which can be done with solely state lookups and
the chain tips block header. Features that make this validation more costly have been rejected from L1
Ethereum due to the desire to ensure <a href="https://hackmd.io/@kevaundray/S1hUQuV4Jx">commodity hardware</a> can
easily participate in consensus.</p>
<p>Layer twos can make more aggressive trade-offs and raise the minimum hardware requirements of the network.
However, with interop, full EVM execution of the transaction is required to fully validate it.</p>
<h2 id="transaction-validation"><a class="header" href="#transaction-validation">Transaction validation</a></h2>
<p>In addition to the nonce and balance checks, the <a href="interop/./messaging.html#messaging-invariants">messaging invariants</a>
SHOULD be enforced before entry into the transaction pool.</p>
<p>After each new block, each transaction in the transaction pool is checked for validity again.
A transaction with a definitively invalid message-dependency SHOULD be "demoted" from the transaction pool.</p>
<p>It is possible that a transaction deemed valid becomes invalid or vice versa. The sequencer MAY choose
to demote messages which are invalid but can still technically become valid.</p>
<p>Transactions with invalid message-dependencies MUST NOT be included in block-building,
and should thus be dropped from the transaction-pool.</p>
<h2 id="system-deposits-transaction-margin"><a class="header" href="#system-deposits-transaction-margin">System deposits transaction margin</a></h2>
<p>The transaction-pool should filter out L2 transactions that spend more than the
gas limit, minus the gas spent on system transactions.
This ensures that the transaction can be included in a valid L2 block,
and does not get stuck in the transaction pool.</p>
<p>A notion of an "effective gas limit", that subtracts 100,000 gas from the regular gas limit,
should be maintained in the transaction pool.
This leaves sufficient gas for the L1 attributes transaction (under 45,000 gas),
the new deposit-context closing transaction (under 36,000 gas), and margin for error / change.</p>
<h2 id="security-considerations-14"><a class="header" href="#security-considerations-14">Security Considerations</a></h2>
<h3 id="mempool-denial-of-service"><a class="header" href="#mempool-denial-of-service">Mempool Denial of Service</a></h3>
<p>Since the validation of the executing message relies on a remote RPC request, this introduces a denial of
service attack vector. The cost of network access is magnitudes larger than in memory validity checks.
The mempool SHOULD perform low-cost checks before any sort of network access is performed.
The results of the check SHOULD be cached, such that another request does not need to be performed
when building the block, although consistency is not guaranteed.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="optimismportal-interop"><a class="header" href="#optimismportal-interop">OptimismPortal Interop</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="interop/optimism-portal.html#overview">Overview</a>
<ul>
<li><a href="interop/optimism-portal.html#integrating-ethlockbox">Integrating <code>ETHLockbox</code></a></li>
</ul>
</li>
<li><a href="interop/optimism-portal.html#interface-and-properties">Interface and properties</a>
<ul>
<li><a href="interop/optimism-portal.html#eth-management">ETH Management</a>
<ul>
<li><a href="interop/optimism-portal.html#migrateliquidity"><code>migrateLiquidity</code></a></li>
<li><a href="interop/optimism-portal.html#proxyadminowner"><code>proxyAdminOwner</code></a></li>
</ul>
</li>
<li><a href="interop/optimism-portal.html#internal-eth-functionality">Internal ETH functionality</a>
<ul>
<li><a href="interop/optimism-portal.html#locking-eth">Locking ETH</a></li>
<li><a href="interop/optimism-portal.html#unlocking-eth">Unlocking ETH</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="interop/optimism-portal.html#events">Events</a>
<ul>
<li><a href="interop/optimism-portal.html#ethmigrated"><code>ETHMigrated</code></a></li>
</ul>
</li>
<li><a href="interop/optimism-portal.html#invariants">Invariants</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-54"><a class="header" href="#overview-54">Overview</a></h2>
<p>The <code>OptimismPortal</code> contract is integrated with the <code>ETHLockbox</code> for managing unified ETH liquidity.
This liquidity consists of every ETH balance migrated from each <code>OptimismPortal</code> when joining
the op-governed dependency set.</p>
<p>It is possible to upgrade to this version without being part of the op-governed dependency set. In this case,
the corresponding chain would need to deploy and manage its own <code>ETHLockbox</code>.</p>
<h3 id="integrating-ethlockbox"><a class="header" href="#integrating-ethlockbox">Integrating <code>ETHLockbox</code></a></h3>
<p>The integration with the <code>ETHLockbox</code> involves locking ETH when executing deposit transactions and unlocking ETH
when finalizing withdrawal transactions, without altering other aspects of the current <code>OptimismPortal</code> implementation.</p>
<h2 id="interface-and-properties"><a class="header" href="#interface-and-properties">Interface and properties</a></h2>
<h3 id="eth-management"><a class="header" href="#eth-management">ETH Management</a></h3>
<h4 id="migrateliquidity"><a class="header" href="#migrateliquidity"><code>migrateLiquidity</code></a></h4>
<p>Migrates the ETH liquidity to the <code>ETHLockbox</code>. This function will only be called once by the
<code>ProxyAdmin</code> owner when updating the <code>OptimismPortal</code> contract.</p>
<pre><code class="language-solidity">function migrateLiquidity() external;
</code></pre>
<ul>
<li>MUST only be callable by the <code>ProxyAdmin</code> owner</li>
<li>MUST transfer all ETH balance to the <code>ETHLockbox</code></li>
<li>MUST emit an <code>ETHMigrated</code> event with the amount transferred</li>
</ul>
<h4 id="proxyadminowner"><a class="header" href="#proxyadminowner"><code>proxyAdminOwner</code></a></h4>
<p>Returns the <code>ProxyAdmin</code> owner that manages the <code>ETHLockbox</code>.</p>
<pre><code class="language-solidity">function proxyAdminOwner() external view returns (address);
</code></pre>
<h3 id="internal-eth-functionality"><a class="header" href="#internal-eth-functionality">Internal ETH functionality</a></h3>
<h4 id="locking-eth"><a class="header" href="#locking-eth">Locking ETH</a></h4>
<p>Called during deposit transactions to handle ETH locking.</p>
<pre><code class="language-solidity">if (msg.value &gt; 0) ethLockbox.lockETH{ value: msg.value }();
</code></pre>
<ul>
<li>MUST be invoked during <code>depositTransaction</code> when there is ETH value</li>
<li>MUST lock any ETH value in the <code>ETHLockbox</code></li>
</ul>
<h4 id="unlocking-eth"><a class="header" href="#unlocking-eth">Unlocking ETH</a></h4>
<p>Called during withdrawal finalization to handle ETH unlocking.</p>
<pre><code class="language-solidity">if (_tx.value &gt; 0) ethLockbox.unlockETH(_tx.value);
</code></pre>
<ul>
<li>MUST be invoked during withdrawal finalization when there is ETH value</li>
<li>MUST unlock the withdrawal value from the <code>ETHLockbox</code></li>
<li>MUST revert if withdrawal target is the <code>ETHLockbox</code></li>
</ul>
<h2 id="events-5"><a class="header" href="#events-5">Events</a></h2>
<h3 id="ethmigrated"><a class="header" href="#ethmigrated"><code>ETHMigrated</code></a></h3>
<p>MUST be triggered when the ETH liquidity is migrated to the <code>ETHLockbox</code>.</p>
<pre><code class="language-solidity">event ETHMigrated(uint256 amount);
</code></pre>
<h2 id="invariants-11"><a class="header" href="#invariants-11">Invariants</a></h2>
<ul>
<li>
<p>Deposits MUST lock the ETH in the <code>ETHLockbox</code></p>
</li>
<li>
<p>Withdrawals MUST unlock the ETH from the <code>ETHLockbox</code> and forward it to the withdrawal target</p>
</li>
<li>
<p>The contract MUST NOT hold any ETH balance from deposits or withdrawals</p>
</li>
<li>
<p>The contract MUST be able to handle zero ETH value operations</p>
</li>
<li>
<p>The contract MUST NOT allow withdrawals to target the <code>ETHLockbox</code> address</p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="eth-lockbox"><a class="header" href="#eth-lockbox">ETH Lockbox</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="interop/eth-lockbox.html#overview">Overview</a></li>
<li><a href="interop/eth-lockbox.html#design">Design</a>
<ul>
<li><a href="interop/eth-lockbox.html#interface-and-properties">Interface and properties</a>
<ul>
<li><a href="interop/eth-lockbox.html#initialize"><code>initialize</code></a></li>
<li><a href="interop/eth-lockbox.html#locketh"><code>lockETH</code></a></li>
<li><a href="interop/eth-lockbox.html#unlocketh"><code>unlockETH</code></a></li>
<li><a href="interop/eth-lockbox.html#authorizeportal"><code>authorizePortal</code></a></li>
<li><a href="interop/eth-lockbox.html#authorizelockbox"><code>authorizeLockbox</code></a></li>
<li><a href="interop/eth-lockbox.html#migrateliquidity"><code>migrateLiquidity</code></a></li>
<li><a href="interop/eth-lockbox.html#receiveliquidity"><code>receiveLiquidity</code></a></li>
<li><a href="interop/eth-lockbox.html#paused"><code>paused</code></a></li>
<li><a href="interop/eth-lockbox.html#superchainconfig"><code>superchainConfig</code></a></li>
<li><a href="interop/eth-lockbox.html#proxyadminowner"><code>proxyAdminOwner</code></a></li>
</ul>
</li>
<li><a href="interop/eth-lockbox.html#events">Events</a>
<ul>
<li><a href="interop/eth-lockbox.html#ethlocked"><code>ETHLocked</code></a></li>
<li><a href="interop/eth-lockbox.html#ethunlocked"><code>ETHUnlocked</code></a></li>
<li><a href="interop/eth-lockbox.html#portalauthorized"><code>PortalAuthorized</code></a></li>
<li><a href="interop/eth-lockbox.html#lockboxauthorized"><code>LockboxAuthorized</code></a></li>
<li><a href="interop/eth-lockbox.html#liquiditymigrated"><code>LiquidityMigrated</code></a></li>
<li><a href="interop/eth-lockbox.html#liquidityreceived"><code>LiquidityReceived</code></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="interop/eth-lockbox.html#invariants">Invariants</a>
<ul>
<li><a href="interop/eth-lockbox.html#system-level-invariants">System level invariants</a></li>
<li><a href="interop/eth-lockbox.html#contract-level-invariants">Contract level invariants</a></li>
</ul>
</li>
<li><a href="interop/eth-lockbox.html#architecture">Architecture</a>
<ul>
<li><a href="interop/eth-lockbox.html#eth-management">ETH Management</a></li>
<li><a href="interop/eth-lockbox.html#merge-process">Merge process</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-55"><a class="header" href="#overview-55">Overview</a></h2>
<p>With interoperable ETH, withdrawals will fail if the referenced <code>OptimismPortal</code> lacks sufficient ETH.
This is due to having the possibility to move ETH liquidity across the different chains and it could happen
that a chain ends up with more liquidity than its <code>OptimismPortal</code>.
The <code>ETHLockbox</code> improves the Superchain's interoperable ETH withdrawal user experience and avoids this issue.
To do so, it unifies ETH L1 liquidity in a single contract (<code>ETHLockbox</code>), enabling seamless withdrawals of ETH
from any OP chain in the Superchain, regardless of where the ETH was initially deposited.</p>
<h2 id="design-1"><a class="header" href="#design-1">Design</a></h2>
<p>The <code>ETHLockbox</code> contract is designed to manage the unified ETH liquidity for the Superchain.
It implements two main functions: <code>lockETH</code> for depositing ETH into the lockbox,
and <code>unlockETH</code> for withdrawing ETH from the lockbox.</p>
<p>These functions are called by the <code>OptimismPortal</code> contracts to manage the shared ETH liquidity
when making deposits or finalizing withdrawals.</p>
<p>Authorization of <code>OptimismPortal</code>s is managed by the <code>ProxyAdmin</code> owner.
The <code>ETHLockbox</code> contract is proxied and managed by the L1 <code>ProxyAdmin</code>.</p>
<h3 id="interface-and-properties-1"><a class="header" href="#interface-and-properties-1">Interface and properties</a></h3>
<h4 id="initialize-4"><a class="header" href="#initialize-4"><code>initialize</code></a></h4>
<p>Initializes the ETHLockbox contract.</p>
<ul>
<li>MUST only be callable by the ProxyAdmin or its owner.</li>
<li>MUST set the SystemConfig contract.</li>
<li>MUST authorize all portals provided in the initialization array.</li>
<li>MUST check that all portals have the same SuperchainConfig as the ETHLockbox.</li>
</ul>
<h4 id="locketh"><a class="header" href="#locketh"><code>lockETH</code></a></h4>
<p>Deposits and locks ETH into the lockbox's liquidity pool.</p>
<ul>
<li>The function MUST accept ETH.</li>
<li>Only authorized <code>OptimismPortal</code> addresses MUST be allowed to interact.</li>
<li>The function MUST NOT revert when called by an authorized <code>OptimismPortal</code></li>
<li>The function MUST emit the <code>ETHLocked</code> event with the <code>portal</code> that called it and the <code>amount</code>.</li>
<li>The function CAN be called by an OptimismPortal while it is executing a withdrawal transaction.</li>
</ul>
<pre><code class="language-solidity">function lockETH() external payable;
</code></pre>
<h4 id="unlocketh"><a class="header" href="#unlocketh"><code>unlockETH</code></a></h4>
<p>Withdraws a specified amount of ETH from the lockbox's liquidity pool to the <code>OptimismPortal</code> calling it.</p>
<ul>
<li>Only authorized <code>OptimismPortal</code> addresses MUST be allowed to interact.</li>
<li>The function MUST NOT revert when called by an authorized <code>OptimismPortal</code> unless paused.</li>
<li>The function MUST check if the ETHLockbox has sufficient balance to fulfill the withdrawal.</li>
<li>The function MUST emit the <code>ETHUnlocked</code> event with the <code>portal</code> that called it and the <code>amount</code>.</li>
<li>The function MUST use <code>donateETH</code> when sending ETH to avoid triggering deposits.</li>
<li>The function MUST NOT allow to be called as part of a withdrawal transaction (<code>OptimismPortal.l2Sender()</code> MUST be the <code>DEFAULT_L2_SENDER</code>).</li>
<li>The function MUST revert if an OptimismPortal attempts to call it while executing a
withdrawal transaction.</li>
</ul>
<pre><code class="language-solidity">function unlockETH(uint256 _value) external;
</code></pre>
<h4 id="authorizeportal"><a class="header" href="#authorizeportal"><code>authorizePortal</code></a></h4>
<p>Authorizes an <code>OptimismPortal</code> to interact with the <code>ETHLockbox</code>.</p>
<ul>
<li>Only the <code>ProxyAdmin</code> owner can call the function.</li>
<li>The <code>ProxyAdmin</code> owner of the <code>OptimismPortal</code> must be the same as the <code>ProxyAdmin</code> owner of the <code>ETHLockbox</code>.</li>
<li>The <code>OptimismPortal</code> and <code>ETHLockbox</code> MUST share the same <code>SuperchainConfig</code> address</li>
<li>The function MUST emit the <code>PortalAuthorized</code> event with the <code>portal</code>.</li>
</ul>
<pre><code class="language-solidity">function authorizePortal(address _portal) external;
</code></pre>
<h4 id="authorizelockbox"><a class="header" href="#authorizelockbox"><code>authorizeLockbox</code></a></h4>
<p>Authorizes another <code>ETHLockbox</code> to migrate its ETH liquidity to the current <code>ETHLockbox</code>.</p>
<ul>
<li>Only the <code>ProxyAdmin</code> owner can call the function.</li>
<li>The <code>ProxyAdmin</code> owner of the source lockbox must be the same as the <code>ProxyAdmin</code> owner of the destination lockbox.</li>
<li>Once a lockbox is authorized, it cannot be removed from the authorized list.</li>
<li>The function MUST emit the <code>LockboxAuthorized</code> event with the <code>lockbox</code> that is being authorized.</li>
</ul>
<pre><code class="language-solidity">function authorizeLockbox(address _lockbox) external;
</code></pre>
<h4 id="migrateliquidity-1"><a class="header" href="#migrateliquidity-1"><code>migrateLiquidity</code></a></h4>
<p>Migrates the ETH liquidity from the current <code>ETHLockbox</code> to another <code>ETHLockbox</code>.</p>
<ul>
<li>Only the <code>ProxyAdmin</code> owner can call the function.</li>
<li>The <code>ProxyAdmin</code> owner of the source lockbox must be the same as the <code>ProxyAdmin</code> owner of the destination lockbox.</li>
<li>The function MUST call <code>receiveLiquidity</code> from the destination <code>ETHLockbox</code> with the entire ETH balance.</li>
<li>SHOULD be called atomically with <code>OptimismPortal.migrateToSuperRoots()</code> in the same transaction
batch, or otherwise the <code>OptimismPortal</code> may not be able to unlock ETH from the ETHLockbox on
finalized withdrawals.</li>
<li>The function MUST emit the <code>LiquidityMigrated</code> event with the <code>lockbox</code> that is being migrated to
and the amount of ETH migrated.</li>
</ul>
<pre><code class="language-solidity">function migrateLiquidity(address _lockbox) external;
</code></pre>
<h4 id="receiveliquidity"><a class="header" href="#receiveliquidity"><code>receiveLiquidity</code></a></h4>
<p>Receives the ETH liquidity from another <code>ETHLockbox</code>.</p>
<ul>
<li>Only an authorized <code>ETHLockbox</code> can call the function.</li>
<li>The function MUST emit the <code>LiquidityReceived</code> event with the <code>lockbox</code> that is being received
from and the amount of ETH received.</li>
</ul>
<pre><code class="language-solidity">function receiveLiquidity() external payable;
</code></pre>
<h4 id="paused-4"><a class="header" href="#paused-4"><code>paused</code></a></h4>
<p>Returns whether the contract is paused, delegating to the SystemConfig.</p>
<h4 id="superchainconfig-4"><a class="header" href="#superchainconfig-4"><code>superchainConfig</code></a></h4>
<p>Returns the SuperchainConfig contract from the SystemConfig.</p>
<h4 id="proxyadminowner-1"><a class="header" href="#proxyadminowner-1"><code>proxyAdminOwner</code></a></h4>
<p>Returns the <code>ProxyAdmin</code> owner that manages the <code>ETHLockbox</code>.</p>
<h3 id="events-6"><a class="header" href="#events-6">Events</a></h3>
<h4 id="ethlocked"><a class="header" href="#ethlocked"><code>ETHLocked</code></a></h4>
<p>MUST be triggered when <code>lockETH</code> is called</p>
<pre><code class="language-solidity">event ETHLocked(OptimismPortal indexed portal, uint256 amount);
</code></pre>
<h4 id="ethunlocked"><a class="header" href="#ethunlocked"><code>ETHUnlocked</code></a></h4>
<p>MUST be triggered when <code>unlockETH</code> is called</p>
<pre><code class="language-solidity">event ETHUnlocked(OptimismPortal indexed portal, uint256 amount);
</code></pre>
<h4 id="portalauthorized"><a class="header" href="#portalauthorized"><code>PortalAuthorized</code></a></h4>
<p>MUST be triggered when <code>authorizePortal</code> is called</p>
<pre><code class="language-solidity">event PortalAuthorized(OptimismPortal indexed portal);
</code></pre>
<h4 id="lockboxauthorized"><a class="header" href="#lockboxauthorized"><code>LockboxAuthorized</code></a></h4>
<p>MUST be triggered when <code>authorizeLockbox</code> is called</p>
<pre><code class="language-solidity">event LockboxAuthorized(ETHLockbox indexed lockbox);
</code></pre>
<h4 id="liquiditymigrated"><a class="header" href="#liquiditymigrated"><code>LiquidityMigrated</code></a></h4>
<p>MUST be triggered when <code>migrateLiquidity</code> is called</p>
<pre><code class="language-solidity">event LiquidityMigrated(ETHLockbox indexed lockbox, uint256 amount);
</code></pre>
<h4 id="liquidityreceived"><a class="header" href="#liquidityreceived"><code>LiquidityReceived</code></a></h4>
<p>MUST be triggered when <code>receiveLiquidity</code> is called</p>
<pre><code class="language-solidity">event LiquidityReceived(ETHLockbox indexed lockbox, uint256 amount);
</code></pre>
<h2 id="invariants-12"><a class="header" href="#invariants-12">Invariants</a></h2>
<h3 id="system-level-invariants"><a class="header" href="#system-level-invariants">System level invariants</a></h3>
<ul>
<li>
<p>The ETH held in the <code>ETHLockbox</code> MUST never be less than the amount deposited but not yet withdrawn by the <code>OptimismPortal</code>s</p>
</li>
<li>
<p>All chains joining the same <code>ETHLockbox</code> MUST have the same <code>ProxyAdmin</code> owner</p>
</li>
<li>
<p>The total withdrawable ETH amount present on all the dependency set's chains MUST NEVER be more than the amount held
by the <code>ETHLockbox</code> of the cluster</p>
<blockquote>
<p>With "withdrawable amount", the ETH balance held on <code>ETHLiquidity</code> is excluded</p>
</blockquote>
</li>
</ul>
<h3 id="contract-level-invariants"><a class="header" href="#contract-level-invariants">Contract level invariants</a></h3>
<ul>
<li>
<p>It MUST allow only authorized portals to lock ETH</p>
</li>
<li>
<p>It MUST allow only authorized portals to unlock ETH</p>
</li>
<li>
<p>It MUST be in paused state if the <code>SuperchainConfig</code> is paused</p>
</li>
<li>
<p>No Ether MUST flow out of the contract when in a paused state</p>
</li>
<li>
<p>It MUST NOT trigger a new deposit when ETH amount is being unlocked from the <code>ETHLockbox</code> by the <code>OptimismPortal</code></p>
</li>
<li>
<p>It MUST allow only the <code>ProxyAdmin</code> owner to call the <code>authorizePortal</code>, <code>authorizeLockbox</code> and <code>migrateLiquidity</code> functions</p>
</li>
<li>
<p>It MUST allow only authorized lockboxes to call the <code>receiveLiquidity</code> function</p>
</li>
<li>
<p>It MUST migrate the whole ETH liquidity from the source <code>ETHLockbox</code> to the destination <code>ETHLockbox</code> when calling <code>migrateLiquidity</code></p>
</li>
<li>
<p>It MUST emit:</p>
<ul>
<li>
<p>An <code>ETHLocked</code> event when locking ETH</p>
</li>
<li>
<p>An <code>ETHUnlocked</code> event when unlocking ETH</p>
</li>
<li>
<p>A <code>PortalAuthorized</code> event when authorizing a portal</p>
</li>
<li>
<p>A <code>LockboxAuthorized</code> event when authorizing a lockbox</p>
</li>
<li>
<p>A <code>LiquidityMigrated</code> event when migrating liquidity</p>
</li>
<li>
<p>A <code>LiquidityReceived</code> event when receiving liquidity</p>
</li>
</ul>
</li>
</ul>
<h2 id="architecture-1"><a class="header" href="#architecture-1">Architecture</a></h2>
<h3 id="eth-management-1"><a class="header" href="#eth-management-1">ETH Management</a></h3>
<ul>
<li>
<p>ETH is locked in the <code>ETHLockbox</code> when:</p>
<ul>
<li>
<p>A portal migrates its ETH liquidity when updating</p>
</li>
<li>
<p>A deposit is made with ETH value on an authorized portal</p>
</li>
</ul>
</li>
<li>
<p>ETH is unlocked from the <code>ETHLockbox</code> when:</p>
<ul>
<li>An authorized portal finalizes a withdrawal that requires ETH</li>
</ul>
</li>
</ul>
<h3 id="merge-process"><a class="header" href="#merge-process">Merge process</a></h3>
<p>The merge process is the process of merging two <code>ETHLockbox</code>es into a single one,
transferring the ETH liquidity from the both source <code>ETHLockbox</code> to the destination <code>ETHLockbox</code>.</p>
<p>For each source <code>ETHLockbox</code>, the following steps MUST be followed:</p>
<ul>
<li>
<p>The destination <code>ETHLockbox</code> MUST call <code>authorizeLockbox</code> with the source <code>ETHLockbox</code> as argument.</p>
</li>
<li>
<p>The source <code>ETHLockbox</code> MUST call <code>migrateLiquidity</code> with the destination <code>ETHLockbox</code> as argument.</p>
</li>
<li>
<p><code>migrateLiquidity</code> MUST call <code>receiveLiquidity</code> from the destination <code>ETHLockbox</code>.</p>
</li>
</ul>
<p>This process ensures that the ETH liquidity is migrated from the source <code>ETHLockbox</code> to the correct destination <code>ETHLockbox</code>.</p>
<p>These transactions SHOULD be executed atomically. A possible way is through the <code>OPCM</code> contract.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="op-contracts-manager"><a class="header" href="#op-contracts-manager">OP Contracts Manager</a></h1>
<p>The OP Contracts Manager is a contract that deploys the L1 contracts for an OP Stack chain in a single
transaction. It provides a minimal set of user-configurable parameters to ensure that the resulting
chain meets the <a href="experimental/../protocol/configurability.html">standard configuration</a> requirements.</p>
<p>The version deployed is always a governance-approved contract release. The set
of governance approved <a href="https://github.com/ethereum-optimism/optimism/blob/develop/packages/contracts-bedrock/book/src/policies/versioning.md">contract releases</a> can be found on the
<a href="https://github.com/ethereum-optimism/optimism/releases">Optimism Monorepo releases</a> page, and is the set of releases named
<code>op-contracts/vX.Y.Z</code>.</p>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="experimental/op-contracts-manager.html#overview">Overview</a></li>
<li><a href="experimental/op-contracts-manager.html#getter-methods">Getter Methods</a></li>
<li><a href="experimental/op-contracts-manager.html#deployment">Deployment</a>
<ul>
<li><a href="experimental/op-contracts-manager.html#interface">Interface</a>
<ul>
<li><a href="experimental/op-contracts-manager.html#deploy"><code>deploy</code></a></li>
</ul>
</li>
<li><a href="experimental/op-contracts-manager.html#implementation">Implementation</a>
<ul>
<li><a href="experimental/op-contracts-manager.html#batch-inbox-address">Batch Inbox Address</a></li>
<li><a href="experimental/op-contracts-manager.html#contract-deployments">Contract Deployments</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="experimental/op-contracts-manager.html#upgrading">Upgrading</a>
<ul>
<li><a href="experimental/op-contracts-manager.html#interface-1">Interface</a>
<ul>
<li><a href="experimental/op-contracts-manager.html#upgrade"><code>upgrade</code></a></li>
</ul>
</li>
<li><a href="experimental/op-contracts-manager.html#implementation-1">Implementation</a>
<ul>
<li><a href="experimental/op-contracts-manager.html#requirements-on-the-op-chain-contracts">Requirements on the OP Chain contracts</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="experimental/op-contracts-manager.html#adding-game-types">Adding game types</a>
<ul>
<li><a href="experimental/op-contracts-manager.html#interface-2">Interface</a>
<ul>
<li><a href="experimental/op-contracts-manager.html#addgametype"><code>addGameType</code></a></li>
</ul>
</li>
<li><a href="experimental/op-contracts-manager.html#implementation-2">Implementation</a></li>
</ul>
</li>
<li><a href="experimental/op-contracts-manager.html#security-considerations">Security Considerations</a>
<ul>
<li><a href="experimental/op-contracts-manager.html#chain-id-source-of-truth">Chain ID Source of Truth</a></li>
<li><a href="experimental/op-contracts-manager.html#chain-id-frontrunning">Chain ID Frontrunning</a></li>
<li><a href="experimental/op-contracts-manager.html#chain-id-value">Chain ID Value</a></li>
<li><a href="experimental/op-contracts-manager.html#proxy-admin-owner">Proxy Admin Owner</a></li>
<li><a href="experimental/op-contracts-manager.html#safely-using-delegatecall">Safely using <code>DELEGATECALL</code></a></li>
<li><a href="experimental/op-contracts-manager.html#atomicity-of-upgrades">Atomicity of upgrades</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-56"><a class="header" href="#overview-56">Overview</a></h2>
<p>The OP Contracts Manager refers to a series of contracts, of which a new singleton is deployed
for each new release of the OP Stack contracts.</p>
<p>The OP Contracts Manager corresponding to each release can be used to:</p>
<ol>
<li>Deploy a new OP chain.</li>
<li>Upgrade the contracts for an existing OP chain from the previous release to the new release.</li>
<li>Orchestrate adding a new game type on a per-chain basis</li>
</ol>
<p>Upgrades must be performed by the <a href="experimental/../protocol/stage-1.html#roles-for-stage-1">Proxy Admin Owner</a> Safe for a chain.</p>
<h2 id="getter-methods"><a class="header" href="#getter-methods">Getter Methods</a></h2>
<p>The following interface defines the available getter methods:</p>
<pre><code class="language-solidity">/// @notice Returns the release string with the format `op-contracts/vX.Y.Z`. 
/// Appends "-rc" if this is a release candidate.
function l1ContractsRelease() external view returns (string memory);
/// @notice Addresses of the Blueprint contracts.
function blueprints() external view returns (Blueprints memory);
/// @notice Maps an L2 chain ID to an L1 batch inbox address
function chainIdToBatchInboxAddress(uint256 _l2ChainId) external pure returns (address);
/// @notice Addresses of the latest implementation contracts.
function implementations() external view returns (Implementations memory);
/// @notice Address of the ProtocolVersions contract shared by all chains.
function protocolVersions() external view returns (address);
/// @notice Address of the SuperchainConfig contract shared by all chains.
function superchainConfig() external view returns (ISuperchainConfig);
/// @notice Semver version specific to the OPContractsManager
function version() external view returns (string memory);
</code></pre>
<h2 id="deployment"><a class="header" href="#deployment">Deployment</a></h2>
<h3 id="interface-14"><a class="header" href="#interface-14">Interface</a></h3>
<h4 id="deploy-1"><a class="header" href="#deploy-1"><code>deploy</code></a></h4>
<p>The <code>deploy</code> method is used to deploy the full set of L1 contracts required to setup a new OP Stack
chain that complies with the <a href="experimental/../protocol/configurability.html">standard configuration</a>. It has the following interface:</p>
<pre><code class="language-solidity">/// @notice Represents the roles that can be set when deploying a standard OP Stack chain.
struct Roles {
    address opChainProxyAdminOwner;
    address systemConfigOwner;
    address batcher;
    address unsafeBlockSigner;
    address proposer;
    address challenger;
}

/// @notice The full set of inputs to deploy a new OP Stack chain.
struct DeployInput {
    Roles roles;
    uint32 basefeeScalar;
    uint32 blobBasefeeScalar;
    uint256 l2ChainId;
    bytes startingAnchorRoot;
    string saltMixer;
    uint64 gasLimit;
    uint32 disputeGameType;
    bytes32 disputeAbsolutePrestate;
    uint256 disputeMaxGameDepth;
    uint256 disputeSplitDepth;
    uint64 disputeClockExtension;
    uint64 disputeMaxClockDuration;
}

/// @notice The full set of outputs from deploying a new OP Stack chain.
struct DeployOutput {
    IProxyAdmin opChainProxyAdmin;
    IAddressManager addressManager;
    IL1ERC721Bridge l1ERC721BridgeProxy;
    ISystemConfig systemConfigProxy;
    IOptimismMintableERC20Factory optimismMintableERC20FactoryProxy;
    IL1StandardBridge l1StandardBridgeProxy;
    IL1CrossDomainMessenger l1CrossDomainMessengerProxy;
    // Fault proof contracts below.
    IOptimismPortal2 optimismPortalProxy;
    IDisputeGameFactory disputeGameFactoryProxy;
    IAnchorStateRegistry anchorStateRegistryProxy;
    IFaultDisputeGame faultDisputeGame;
    IPermissionedDisputeGame permissionedDisputeGame;
    IDelayedWETH delayedWETHPermissionedGameProxy;
    IDelayedWETH delayedWETHPermissionlessGameProxy;
}

/// @notice Deploys a new OP Chain
/// @param _input DeployInput containing chain specific config information.
/// @return DeployOutput containing the new addresses.
function deploy(DeployInput calldata _input) external returns (DeployOutput memory)
</code></pre>
<p>The <code>l2ChainId</code> has the following restrictions:</p>
<ul>
<li>It must not be equal to 0.</li>
<li>It must not be equal to the chain ID of the chain the OP Contracts Manager is
deployed on.</li>
<li>It must not be equal to a chain ID that is already present in the
<a href="https://github.com/ethereum-lists/chains">ethereum-lists/chains</a> repository. This is not enforced onchain, but may matter
for future versions of OP Contracts Manager that handle upgrades.</li>
</ul>
<p>On success, the following event is emitted:</p>
<pre><code class="language-solidity">event Deployed(uint256 indexed l2ChainId, address indexed deployer, bytes deployOutput);
</code></pre>
<p>This method reverts on failure. This occurs when:</p>
<ul>
<li>The input <code>l2ChainId</code> does not comply with the enforced restrictions above.</li>
<li>The resulting configuration is not compliant with the <a href="experimental/../protocol/configurability.html">standard configuration</a>.</li>
</ul>
<h3 id="implementation-2"><a class="header" href="#implementation-2">Implementation</a></h3>
<h4 id="batch-inbox-address-1"><a class="header" href="#batch-inbox-address-1">Batch Inbox Address</a></h4>
<p>The chain's <a href="experimental/../protocol/configurability.html#consensus-parameters">Batch Inbox</a> address is computed at deploy time using the recommend approach defined
in the <a href="experimental/../protocol/configurability.html">standard configuration</a>. This improves UX by removing an input, and ensures uniqueness of
the batch inbox addresses.</p>
<h4 id="contract-deployments"><a class="header" href="#contract-deployments">Contract Deployments</a></h4>
<p>All contracts deployed by the OP Contracts Manager are deployed with <code>CREATE2</code>, using the following salt:</p>
<pre><code class="language-solidity">keccak256(abi.encode(_l2ChainId, _saltMixer, _contractName));
</code></pre>
<p>The <code>saltMixer</code> value is provided as a field in the <code>DeployInput</code> struct.</p>
<p>This provides the following benefits:</p>
<ul>
<li>Contract addresses for a chain can be derived as a function of chain ID without any RPC calls.</li>
<li>Chain ID uniqueness is enforced for free, as a deploy using the same chain ID
will result in attempting to deploy to the same address, which is prohibited by
the EVM.
<ul>
<li>This property is contingent on the proxy and <code>AddressManager</code> code not
changing when OP Contracts Manager is upgraded. Both of these are not planned to
change.</li>
<li>The OP Contracts Manager is not responsible for enforcing chain ID uniqueness, so it is acceptable
if this property is not preserved in future versions of the OP Contracts Manager.</li>
</ul>
</li>
</ul>
<h2 id="upgrading"><a class="header" href="#upgrading">Upgrading</a></h2>
<h3 id="interface-15"><a class="header" href="#interface-15">Interface</a></h3>
<h4 id="upgrade-4"><a class="header" href="#upgrade-4"><code>upgrade</code></a></h4>
<p>The <code>upgrade</code> method is used by the Proxy Admin Owner to upgrade the full set of L1 contracts for
all chains that it controls.</p>
<p>It has the following interface:</p>
<pre><code class="language-solidity">/// @notice The input required to identify a chain for upgrading, along with new prestate hashes
struct OpChainConfig {
    ISystemConfig systemConfigProxy;
    IProxyAdmin proxyAdmin;
    bytes32 absolutePrestate;
}

/// @notice Upgrades a set of chains to the latest implementation contracts
/// @param _opChainConfigs Array of OpChain structs, one per chain to upgrade
/// @dev This function is intended to be called via DELEGATECALL from the Proxy Admin Owner Safe
function upgrade(OpChainConfig[] memory _opChainConfigs) external
</code></pre>
<p>For each chain successfully upgraded, the following event is emitted:</p>
<pre><code class="language-solidity">event Upgraded(uint256 indexed l2ChainId, ISystemConfig indexed systemConfig, address indexed upgrader);
</code></pre>
<p>This method reverts if the upgrade is not successful for any of the chains.</p>
<h3 id="implementation-3"><a class="header" href="#implementation-3">Implementation</a></h3>
<p>The high level logic of the upgrade method is as follows:</p>
<ol>
<li>The Proxy Admin Owner Safe will <code>DELEGATECALL</code> to the <code>OPCM.upgrade()</code> method.</li>
<li>The SuperchainConfig contract will be upgraded, if not yet done.</li>
<li>The ProtocolVersions contract will be upgraded, if not yet done.</li>
<li>For each <code>_systemConfig</code>, the list of addresses in the chain is retrieved.</li>
<li>For each address:
<ol>
<li>If it is receiving new state variables, a call is made to:
<code>ProxyAdmin.upgradeAndCall()</code> with data corresponding to the new value being set.</li>
<li>Otherwise, <code>ProxyAdmin.upgrade()</code> is called on that address.</li>
</ol>
</li>
</ol>
<p>This approach requires that any contracts which are receiving new state variables
have an upgrade function which:</p>
<ol>
<li>Writes the new state variables</li>
<li>MUST only be callable once</li>
</ol>
<h4 id="requirements-on-the-op-chain-contracts"><a class="header" href="#requirements-on-the-op-chain-contracts">Requirements on the OP Chain contracts</a></h4>
<p>In general, all contracts used in an OP Chain SHOULD be proxied with a single shared implementation.
This means that all values which are not constant across OP Chains SHOULD be held in storage rather
than the bytecode of the implementation.</p>
<p>Any contracts which do not meet this requirement will need to be deployed by the <code>upgrade()</code>
function, increasing the cost and reducing the number of OP Chains which can be atomically upgraded.</p>
<h2 id="adding-game-types"><a class="header" href="#adding-game-types">Adding game types</a></h2>
<p>Because different OP Chains within a Superchain may use different dispute game types, and are
expected to move from a permissioned to permissionless game over time, an <code>addGameType()</code> method is
provided to enable adding a new game type to multiple games at once.</p>
<h3 id="interface-16"><a class="header" href="#interface-16">Interface</a></h3>
<h4 id="addgametype"><a class="header" href="#addgametype"><code>addGameType</code></a></h4>
<p>The <code>addGameType</code> method is used to orchestrate the actions required to add a new game type to one
or more chains.</p>
<pre><code class="language-solidity">struct AddGameInput {
    string saltMixer;
    ISystemConfig systemConfig;
    IProxyAdmin proxyAdmin;
    IDelayedWETH delayedWETH;
    uint32 disputeGameType;
    bytes32 disputeAbsolutePrestate;
    uint256 disputeMaxGameDepth;
    uint256 disputeSplitDepth;
    uint64 disputeClockExtension;
    uint64 disputeMaxClockDuration;
    uint256 initialBond;
    IBigStepper vm;
    bool permissioned;
}

struct AddGameOutput {
    IDelayedWETH delayedWETH;
    IFaultDisputeGame faultDisputeGame;
}

/// @notice addGameType deploys a new dispute game and links it to the DisputeGameFactory. The inputted _gameConfigs
/// must be added in ascending GameType order.
function addGameType(AddGameInput[] memory _gameConfigs) external returns (AddGameOutput[] memory)
</code></pre>
<p>On success, the following event is emitted:</p>
<pre><code class="language-solidity">event GameTypeAdded(uint256 indexed l2ChainId, uint32 indexed gameType, address indexed deployer);
</code></pre>
<h3 id="implementation-4"><a class="header" href="#implementation-4">Implementation</a></h3>
<p>The high level logic of the <code>addGameType</code> method is as follows (for each chain):</p>
<ol>
<li>Deploy and initialize new <code>DelayedWethProxy</code> for the new game type, if one hasn't already been specified.</li>
<li>Deploy a new dispute game contract, based on the specified game type. The constructor args must be provided as
arguments, unless otherwise specified in the table below.</li>
<li>Read the <code>DisputeGameFactory</code> address from the <code>SystemConfig</code>.</li>
<li>Call <code>DisputeGameFactory.setImplementation()</code> to register the new game.</li>
</ol>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th><th>Source</th></tr></thead><tbody>
<tr><td>weth</td><td>address</td><td>Address of the DelayedWeth contract</td><td>Newly deployed contract, or provided</td></tr>
<tr><td>anchorStateRegistry</td><td>address</td><td>Registry contract address</td><td>Copied from existing <code>PermissionedGame</code></td></tr>
<tr><td>l2ChainId</td><td>uint256</td><td>Chain ID of the L2 network</td><td>Copied from existing <code>PermissionedGame</code></td></tr>
</tbody></table>
</div>
<h2 id="security-considerations-15"><a class="header" href="#security-considerations-15">Security Considerations</a></h2>
<h3 id="chain-id-source-of-truth"><a class="header" href="#chain-id-source-of-truth">Chain ID Source of Truth</a></h3>
<p>One of the implicit restrictions on chain ID is that <code>deploy</code> can only be called
once per chain ID, because contract addresses are a function of chain ID. However,
future versions of OP Contracts Manager may:</p>
<ul>
<li>Change the Proxy code used, which would allow a duplicate chain ID to be deployed
if there is only the implicit check.</li>
<li>Manage upgrades, which will require "registering" existing pre-OP Contracts Manager
chains in the OP Contracts Manager. Registration will be a privileged action, and the <a href="https://github.com/ethereum-optimism/superchain-registry">superchain registry</a> will be
used as the source of truth for registrations.</li>
</ul>
<p>This means, for example, if deploying a chain with a chain ID of 10â€”which is OP
Mainnet's chain IDâ€”deployment will execute successfully, but the entry in OP
Contracts Manager may be overwritten in a future upgrade. Therefore, chain ID
uniqueness is not enforced by the OP Contracts Manager, and it is strongly
recommended to only use chain IDs that are not already present in the
<a href="https://github.com/ethereum-lists/chains">ethereum-lists/chains</a> repository.</p>
<h3 id="chain-id-frontrunning"><a class="header" href="#chain-id-frontrunning">Chain ID Frontrunning</a></h3>
<p>Contract addresses for a chain are a function of chain ID, which implies you
can counterfactually compute and use those chain addresses before the chain is
deployed. However, this property should not be relied uponâ€”new chain deployments
are permissionless, so you cannot guarantee usage of a given chain ID, as deploy
transactions can be frontrun.</p>
<h3 id="chain-id-value"><a class="header" href="#chain-id-value">Chain ID Value</a></h3>
<p>While not specific to OP Contracts Manager, when choosing a chain ID is important
to consider that not all chain IDs are well supported by tools. For example,
MetaMask <a href="https://gist.github.com/rekmarks/a47bd5f2525936c4b8eee31a16345553">only supports</a>
chain IDs up to <code>4503599627370476</code>, well below the max allowable 256-bit value.</p>
<p>OP Contracts Manager does not consider factors such as these. The EVM supports
256-bit chain IDs, so OP Contracts Manager sticks with the full 256-bit range to
maximize compatibility.</p>
<h3 id="proxy-admin-owner-2"><a class="header" href="#proxy-admin-owner-2">Proxy Admin Owner</a></h3>
<p>The proxy admin owner is a very powerful role, as it allows upgrading protocol
contracts. When choosing the initial proxy admin owner, a Safe is recommended
to ensure admin privileges are sufficiently secured.</p>
<h3 id="safely-using-delegatecall"><a class="header" href="#safely-using-delegatecall">Safely using <code>DELEGATECALL</code></a></h3>
<p>Because a Safe will <code>DELEGATECALL</code> to the <code>upgrade()</code> and <code>addGameType()</code> methods, it is
critical that no storage writes occur. This should be enforced in multiple ways, including:</p>
<ul>
<li>By static analysis of the <code>upgrade()</code> and <code>addGameType()</code> methods during the development process.</li>
<li>By simulating and verifying the state changes which occur in the Proxy Admin Owner Safe prior to execution.</li>
</ul>
<h3 id="atomicity-of-upgrades"><a class="header" href="#atomicity-of-upgrades">Atomicity of upgrades</a></h3>
<p>Although atomicity of a superchain upgrade is not essential for many types of upgrade, it will
at times be necessary. It is certainly always desirable for operational reasons.</p>
<p>For this reason, efficiency should be kept in mind when designing the upgrade path. When the size of
the superchain reaches a size that nears the block gas limit, upgrades may need to be broken up into
stages, so that components which must be upgrade atomically can be. For example, all
<code>OptimismPortal</code> contracts may need to be upgraded in one transaction, followed by another
transaction which upgrades all <code>L1CrossDomainMessenger</code> contracts.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="governance-token-3"><a class="header" href="#governance-token-3">Governance Token</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="experimental/gov-token.html#overview">Overview</a>
<ul>
<li><a href="experimental/gov-token.html#hook-based-integration-with-governancedelegation">Hook-based Integration with <code>GovernanceDelegation</code></a></li>
<li><a href="experimental/gov-token.html#token-minting">Token Minting</a></li>
<li><a href="experimental/gov-token.html#token-burning">Token Burning</a></li>
<li><a href="experimental/gov-token.html#voting-power">Voting Power</a>
<ul>
<li><a href="experimental/gov-token.html#queries">Queries</a></li>
</ul>
</li>
<li><a href="experimental/gov-token.html#delegation">Delegation</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-57"><a class="header" href="#overview-57">Overview</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Constants</th><th>Value</th></tr></thead><tbody>
<tr><td>Address</td><td><code>0x4200000000000000000000000000000000000042</code></td></tr>
<tr><td>Token name</td><td><code>Optimism</code></td></tr>
<tr><td>Token symbol</td><td><code>OP</code></td></tr>
<tr><td>Token decimals</td><td><code>18</code></td></tr>
</tbody></table>
</div>
<p><code>GovernanceToken</code> is an <a href="https://eips.ethereum.org/EIPS/eip-20">ERC20</a> token contract that inherits from <code>ERC20Burnable</code>,
<code>ERC20Votes</code>, and <code>Ownable</code>. It allows token holders to delegate their voting power to other addresses, enabling a representative
voting system. The contract integrates with the <code>GovernanceDelegation</code> contract through a hook-based approach to support
advanced delegation.</p>
<h3 id="hook-based-integration-with-governancedelegation"><a class="header" href="#hook-based-integration-with-governancedelegation">Hook-based Integration with <code>GovernanceDelegation</code></a></h3>
<p>Advanced delegation includes relative and absolute partial delegation, which allow delegators to distribute their voting
power among multiple delegates in a fractional manner. The <code>_afterTokenTransfer</code> function in the <code>GovernanceToken</code> is
modified to call the <code>afterTokenTransfer</code> function in the <code>GovernanceDelegation</code> contract, allowing the <code>GovernanceDelegation</code>
contract to consume the hooks and update its delegation and checkpoint mappings accordingly.</p>
<p>If the call to the <code>GovernanceDelegation</code>'s <code>afterTokenTransfer</code> function fails, the token transfer MUST revert. This ensures
that the <code>GovernanceDelegation</code> contract remains in sync with the <code>GovernanceToken</code>. Otherwise, the <code>GovernanceToken</code> could
be left in an inconsistent state relative to the <code>GovernanceDelegation</code> contract, such as when a token transfer is successful
but the delegation state is not updated.</p>
<p>All delegation-related state, including the <code>delegates</code>, <code>checkpoints</code>, and <code>numCheckpoints</code> mappings, is gradually
shifted from the <code>GovernanceToken</code> to the <code>GovernanceDelegation</code> contract through transactions that call the
<code>GovernanceDelegation</code>'s hook (e.g. transfers). In the hook, the <code>GovernanceDelegation</code> contract should check if the <code>to</code>
and <code>from</code> addresses have been migrated. If an address hasn't been migrated, the <code>GovernanceDelegation</code> contract should
write the data from the <code>GovernanceToken</code>'s mappings for that address to its own state. When reading delegation data in the
<code>GovernanceDelegation</code> contract for a delegator that hasn't been migrated, the <code>GovernanceDelegation</code> should pull the data
from the <code>GovernanceToken</code>'s state.</p>
<p>For backwards compatibility, the getter methods in the <code>GovernanceToken</code> MUST check if the data of a given address has been
migrated or not. If the data has been migrated, the <code>GovernanceToken</code> MUST forward the call to the <code>GovernanceDelegation</code>
contract. Otherwise, the <code>GovernanceToken</code> MUST read from its state.</p>
<p>The <code>delegate</code> and <code>delegateBySig</code> functions in the <code>GovernanceToken</code> MUST forward the calls to the <code>GovernanceDelegation</code>
contract, which implements the required delegation logic.</p>
<h3 id="token-minting-1"><a class="header" href="#token-minting-1">Token Minting</a></h3>
<p><code>GovernanceToken</code> MUST have a <code>mint(address,uint256)</code> function with external visibility that allows the contract owner
to mint an arbitrary number of new tokens to a specific address. This function MUST only be called by the contract
owner, the <code>MintManager</code>, as enforced by the <code>onlyOwner</code> modifier inherited from the <code>Ownable</code> contract. When tokens
are minted, the voting power of the recipient address MUST be updated accordingly in the <code>GovernanceDelegation</code> contract
via the <code>afterTokenTransfer</code> hook. The total token supply is capped to <code>2^208 - 1</code> to prevent overflow risks in the voting
system. If the total supply exceeds this limit, <code>_mint(address,uint256)</code>, as inherited from <code>ERC20Votes</code>, MUST revert.</p>
<h3 id="token-burning-1"><a class="header" href="#token-burning-1">Token Burning</a></h3>
<p>The contract MUST allow token holders to burn their own tokens using the inherited <code>burn(uint256)</code> or
<code>burnFrom(address,uint256)</code> functions inherited from <code>ERC20Burnable</code>. When tokens are burned, the total supply and the
holder's voting power MUST be reduced accordingly in the <code>GovernanceDelegation</code> contract via the <code>afterTokenTransfer</code> hook.</p>
<h3 id="voting-power-1"><a class="header" href="#voting-power-1">Voting Power</a></h3>
<p>Each token corresponds to one unit of voting power.
By default, token balance does not account for voting power. To have their voting power counted, token holders MUST delegate
their voting power to an address (can be their own address).
The contract MUST offer public accessors for querying voting power, as outlined below.</p>
<h4 id="queries"><a class="header" href="#queries">Queries</a></h4>
<ul>
<li>The <code>getVotes(address)(uint256)</code> function MUST retrieve the current voting power of an address from the
<code>GovernanceDelegation</code> contract.</li>
<li>The <code>getPastVotes(address,uint256)(uint256)</code> function MUST allow querying the voting power of an address at a specific
block number in the past from the <code>GovernanceDelegation</code> contract.</li>
<li>The <code>getPastTotalSupply(uint256)(uint256)</code> function MUST return the total voting power at a specific block number in
the past from the <code>GovernanceDelegation</code> contract.</li>
</ul>
<h3 id="delegation-1"><a class="header" href="#delegation-1">Delegation</a></h3>
<p>Voting power can be delegated either by calling the <code>delegate(address)</code> function directly (to delegate as the <code>msg.sender</code>)
or by providing a signature to be used with function <code>delegateBySig(address,uint256,uint256,uint8,bytes32,bytes32)</code>,
as inherited from <code>ERC20Votes</code>. These functions are modified to forward the calls to the <code>GovernanceDelegation</code> contract
which implements the required logic.</p>
<p>The <code>GovernanceDelegation</code> contract maintains the necessary invariants, such as preventing circular delegation chains, ensuring
vote weight consistency, and managing checkpoints. It is incorporated as a predeploy of the OP stack to avoid manual deployments
across the Superchain.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="livenessguard"><a class="header" href="#livenessguard">LivenessGuard</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="experimental/contracts/safe/liveness-guard.html#overview">Overview</a></li>
<li><a href="experimental/contracts/safe/liveness-guard.html#definitions">Definitions</a>
<ul>
<li><a href="experimental/contracts/safe/liveness-guard.html#liveness-timestamp">Liveness Timestamp</a></li>
</ul>
</li>
<li><a href="experimental/contracts/safe/liveness-guard.html#assumptions">Assumptions</a></li>
<li><a href="experimental/contracts/safe/liveness-guard.html#invariants">Invariants</a>
<ul>
<li><a href="experimental/contracts/safe/liveness-guard.html#i01-001-liveness-tracking-accuracy">i01-001: Liveness tracking accuracy</a>
<ul>
<li><a href="experimental/contracts/safe/liveness-guard.html#impact">Impact</a></li>
</ul>
</li>
<li><a href="experimental/contracts/safe/liveness-guard.html#i02-002-liveness-demonstration-capability">i02-002: Liveness demonstration capability</a>
<ul>
<li><a href="experimental/contracts/safe/liveness-guard.html#impact-1">Impact</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="experimental/contracts/safe/liveness-guard.html#function-specification">Function Specification</a>
<ul>
<li><a href="experimental/contracts/safe/liveness-guard.html#constructor">constructor</a></li>
<li><a href="experimental/contracts/safe/liveness-guard.html#safe">safe</a></li>
<li><a href="experimental/contracts/safe/liveness-guard.html#checktransaction">checkTransaction</a></li>
<li><a href="experimental/contracts/safe/liveness-guard.html#checkafterexecution">checkAfterExecution</a></li>
<li><a href="experimental/contracts/safe/liveness-guard.html#showliveness">showLiveness</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview-58"><a class="header" href="#overview-58">Overview</a></h2>
<p>The LivenessGuard tracks the liveness of Safe multisig owners by recording timestamps when owners sign transactions or
explicitly demonstrate activity. It serves as a monitoring mechanism to identify inactive owners who may have lost
access to their keys.</p>
<h2 id="definitions-9"><a class="header" href="#definitions-9">Definitions</a></h2>
<h3 id="liveness-timestamp"><a class="header" href="#liveness-timestamp">Liveness Timestamp</a></h3>
<p>The most recent block timestamp at which an owner either signed a Safe transaction or called the <code>showLiveness</code>
function. This timestamp is publicly queryable via the <code>lastLive</code> mapping.</p>
<h2 id="assumptions-7"><a class="header" href="#assumptions-7">Assumptions</a></h2>
<p>N/A</p>
<h2 id="invariants-13"><a class="header" href="#invariants-13">Invariants</a></h2>
<h3 id="i01-001-liveness-tracking-accuracy"><a class="header" href="#i01-001-liveness-tracking-accuracy">i01-001: Liveness tracking accuracy</a></h3>
<p>Owner activity is accurately tracked and properly synchronized with the Safe's owner set.</p>
<h4 id="impact-29"><a class="header" href="#impact-29">Impact</a></h4>
<p><strong>Severity: High</strong></p>
<p>If liveness tracking is inaccurate, inactive owners could appear active (preventing their removal) or active owners
could appear inactive (enabling improper removal). This undermines the entire liveness monitoring mechanism and could
lead to unauthorized changes to the Safe's owner set.</p>
<h3 id="i02-002-liveness-demonstration-capability"><a class="header" href="#i02-002-liveness-demonstration-capability">i02-002: Liveness demonstration capability</a></h3>
<p>Owners are always capable of showing liveness if the owner is actually live. The guard never prevents legitimate owners
from demonstrating their liveness through either transaction signatures or direct <code>showLiveness</code> calls.</p>
<h4 id="impact-30"><a class="header" href="#impact-30">Impact</a></h4>
<p><strong>Severity: Critical</strong></p>
<p>If legitimate owners cannot demonstrate liveness, they could be incorrectly identified as inactive and removed from the
Safe. This could lead to loss of access to the Safe's assets and functionality, potentially causing permanent fund
loss if enough owners are incorrectly removed.</p>
<h2 id="function-specification-6"><a class="header" href="#function-specification-6">Function Specification</a></h2>
<h3 id="constructor-4"><a class="header" href="#constructor-4">constructor</a></h3>
<p>Initializes the LivenessGuard for a specific Safe contract and records all current owners with the deployment
timestamp.</p>
<p><strong>Parameters:</strong></p>
<ul>
<li><code>_safe</code>: The Safe contract instance that this guard will monitor</li>
</ul>
<p><strong>Behavior:</strong></p>
<ul>
<li>MUST set the immutable <code>SAFE</code> reference to the provided Safe contract</li>
<li>MUST query the Safe's current owner list via <code>getOwners()</code></li>
<li>MUST set <code>lastLive[owner]</code> to <code>block.timestamp</code> for each current owner</li>
<li>MUST emit <code>OwnerRecorded</code> event for each current owner</li>
</ul>
<h3 id="safe-1"><a class="header" href="#safe-1">safe</a></h3>
<p>Returns the Safe contract instance that this guard monitors.</p>
<p><strong>Behavior:</strong></p>
<ul>
<li>MUST return the immutable <code>SAFE</code> contract reference</li>
</ul>
<h3 id="checktransaction"><a class="header" href="#checktransaction">checkTransaction</a></h3>
<p>Records liveness for owners who signed the current transaction. Called by the Safe before transaction execution.</p>
<p><strong>Parameters:</strong></p>
<ul>
<li><code>_to</code>: Transaction target address</li>
<li><code>_value</code>: ETH value to send</li>
<li><code>_data</code>: Transaction calldata</li>
<li><code>_operation</code>: Operation type (Call or DelegateCall)</li>
<li><code>_safeTxGas</code>: Gas allocated for Safe transaction execution</li>
<li><code>_baseGas</code>: Gas costs independent of transaction execution</li>
<li><code>_gasPrice</code>: Gas price for refund calculation</li>
<li><code>_gasToken</code>: Token address for gas payment (zero address for ETH)</li>
<li><code>_refundReceiver</code>: Address receiving gas refund</li>
<li><code>_signatures</code>: Packed signature data from Safe owners</li>
<li><code>_msgSender</code>: Original transaction sender</li>
</ul>
<p><strong>Behavior:</strong></p>
<ul>
<li>MUST revert if caller is not the associated Safe contract</li>
<li>MUST cache the current Safe owner list for comparison after transaction execution</li>
<li>MUST reconstruct the transaction hash using Safe's <code>getTransactionHash()</code> with nonce decremented by 1</li>
<li>MUST extract exactly <code>threshold</code> number of signers from <code>_signatures</code> using <code>SafeSigners.getNSigners()</code></li>
<li>MUST set <code>lastLive[signer]</code> to <code>block.timestamp</code> for each extracted signer</li>
<li>MUST emit <code>OwnerRecorded</code> event for each signer</li>
<li>MUST NOT revert due to signature parsing or owner extraction failures</li>
</ul>
<h3 id="checkafterexecution"><a class="header" href="#checkafterexecution">checkAfterExecution</a></h3>
<p>Updates the <code>lastLive</code> mapping to reflect any changes in the Safe's owner set. Called by the Safe after transaction
execution.</p>
<p><strong>Parameters:</strong></p>
<ul>
<li>First parameter (unnamed): Transaction hash (unused)</li>
<li>Second parameter (unnamed): Transaction success status (unused)</li>
</ul>
<p><strong>Behavior:</strong></p>
<ul>
<li>MUST revert if caller is not the associated Safe contract</li>
<li>MUST query the current Safe owner list via <code>getOwners()</code></li>
<li>MUST process each current owner:
<ul>
<li>If owner existed before transaction execution, mark as processed</li>
<li>If owner did not exist before transaction execution, set <code>lastLive[owner]</code> to <code>block.timestamp</code> (new owner added)</li>
</ul>
</li>
<li>MUST process each owner that existed before but not after transaction execution:
<ul>
<li>Delete <code>lastLive[owner]</code> entry (owner was removed from Safe)</li>
</ul>
</li>
<li>MUST ensure internal owner tracking state is completely cleared after execution</li>
<li>MUST NOT revert due to owner set changes or state inconsistencies</li>
</ul>
<h3 id="showliveness"><a class="header" href="#showliveness">showLiveness</a></h3>
<p>Allows a Safe owner to directly demonstrate liveness without signing a transaction.</p>
<p><strong>Behavior:</strong></p>
<ul>
<li>MUST revert if caller is not a current owner of the Safe (verified via <code>SAFE.isOwner()</code>)</li>
<li>MUST set <code>lastLive[msg.sender]</code> to <code>block.timestamp</code></li>
<li>MUST emit <code>OwnerRecorded</code> event with <code>msg.sender</code> as the owner</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<!-- markdownlint-disable MD053 -->
<h1 id="glossary"><a class="header" href="#glossary">Glossary</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="glossary.html#general-terms">General Terms</a>
<ul>
<li><a href="glossary.html#layer-1-l1">Layer 1 (L1)</a></li>
<li><a href="glossary.html#layer-2-l2">Layer 2 (L2)</a></li>
<li><a href="glossary.html#block">Block</a></li>
<li><a href="glossary.html#eoa">EOA</a></li>
<li><a href="glossary.html#merkle-patricia-trie">Merkle Patricia Trie</a></li>
<li><a href="glossary.html#chain-re-organization">Chain Re-Organization</a></li>
<li><a href="glossary.html#predeployed-contract-predeploy">Predeployed Contract ("Predeploy")</a></li>
<li><a href="glossary.html#preinstalled-contract-preinstall">Preinstalled Contract ("Preinstall")</a></li>
<li><a href="glossary.html#precompiled-contract-precompile">Precompiled Contract ("Precompile")</a></li>
<li><a href="glossary.html#receipt">Receipt</a></li>
<li><a href="glossary.html#transaction-type">Transaction Type</a></li>
<li><a href="glossary.html#fork-choice-rule">Fork Choice Rule</a></li>
<li><a href="glossary.html#priority-gas-auction">Priority Gas Auction</a></li>
</ul>
</li>
<li><a href="glossary.html#sequencing">Sequencing</a>
<ul>
<li><a href="glossary.html#sequencer">Sequencer</a></li>
<li><a href="glossary.html#sequencing-window">Sequencing Window</a></li>
<li><a href="glossary.html#sequencing-epoch">Sequencing Epoch</a></li>
<li><a href="glossary.html#l1-origin">L1 Origin</a></li>
</ul>
</li>
<li><a href="glossary.html#deposits">Deposits</a>
<ul>
<li><a href="glossary.html#deposited-transaction">Deposited Transaction</a></li>
<li><a href="glossary.html#l1-attributes-deposited-transaction">L1 Attributes Deposited Transaction</a></li>
<li><a href="glossary.html#user-deposited-transaction">User-Deposited Transaction</a></li>
<li><a href="glossary.html#depositing-call">Depositing Call</a></li>
<li><a href="glossary.html#depositing-transaction">Depositing Transaction</a></li>
<li><a href="glossary.html#depositor">Depositor</a></li>
<li><a href="glossary.html#deposited-transaction-type">Deposited Transaction Type</a></li>
<li><a href="glossary.html#deposit-contract">Deposit Contract</a></li>
</ul>
</li>
<li><a href="glossary.html#withdrawals">Withdrawals</a>
<ul>
<li><a href="glossary.html#relayer">Relayer</a></li>
<li><a href="glossary.html#finalization-period">Finalization Period</a></li>
</ul>
</li>
<li><a href="glossary.html#batch-submission">Batch Submission</a>
<ul>
<li><a href="glossary.html#data-availability">Data Availability</a></li>
<li><a href="glossary.html#data-availability-provider">Data Availability Provider</a></li>
<li><a href="glossary.html#sequencer-batch">Sequencer Batch</a></li>
<li><a href="glossary.html#channel">Channel</a></li>
<li><a href="glossary.html#channel-frame">Channel Frame</a></li>
<li><a href="glossary.html#batcher">Batcher</a></li>
<li><a href="glossary.html#batcher-transaction">Batcher Transaction</a></li>
<li><a href="glossary.html#batch-submission-frequency">Batch submission frequency</a></li>
<li><a href="glossary.html#channel-timeout">Channel Timeout</a></li>
</ul>
</li>
<li><a href="glossary.html#l2-output-root-proposals">L2 Output Root Proposals</a>
<ul>
<li><a href="glossary.html#proposer">Proposer</a></li>
</ul>
</li>
<li><a href="glossary.html#l2-chain-derivation">L2 Chain Derivation</a>
<ul>
<li><a href="glossary.html#l2-derivation-inputs">L2 Derivation Inputs</a></li>
<li><a href="glossary.html#system-configuration">System Configuration</a></li>
<li><a href="glossary.html#payload-attributes">Payload Attributes</a></li>
<li><a href="glossary.html#l2-genesis-block">L2 Genesis Block</a></li>
<li><a href="glossary.html#l2-chain-inception">L2 Chain Inception</a></li>
<li><a href="glossary.html#safe-l2-block">Safe L2 Block</a></li>
<li><a href="glossary.html#safe-l2-head">Safe L2 Head</a></li>
<li><a href="glossary.html#unsafe-l2-block">Unsafe L2 Block</a></li>
<li><a href="glossary.html#unsafe-l2-head">Unsafe L2 Head</a></li>
<li><a href="glossary.html#unsafe-block-consolidation">Unsafe Block Consolidation</a></li>
<li><a href="glossary.html#finalized-l2-head">Finalized L2 Head</a></li>
</ul>
</li>
<li><a href="glossary.html#other-l2-chain-concepts">Other L2 Chain Concepts</a>
<ul>
<li><a href="glossary.html#address-aliasing">Address Aliasing</a></li>
<li><a href="glossary.html#rollup-node">Rollup Node</a></li>
<li><a href="glossary.html#rollup-driver">Rollup Driver</a></li>
<li><a href="glossary.html#l1-attributes-predeployed-contract">L1 Attributes Predeployed Contract</a></li>
<li><a href="glossary.html#l2-output-root">L2 Output Root</a></li>
<li><a href="glossary.html#l2-output-oracle-contract">L2 Output Oracle Contract</a></li>
<li><a href="glossary.html#validator">Validator</a></li>
<li><a href="glossary.html#fault-proof">Fault Proof</a></li>
<li><a href="glossary.html#time-slot">Time Slot</a></li>
<li><a href="glossary.html#block-time">Block Time</a></li>
<li><a href="glossary.html#unsafe-sync">Unsafe Sync</a></li>
</ul>
</li>
<li><a href="glossary.html#execution-engine-concepts">Execution Engine Concepts</a>
<ul>
<li><a href="glossary.html#execution-engine">Execution Engine</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<hr />
<h1 id="general-terms"><a class="header" href="#general-terms">General Terms</a></h1>
<h2 id="layer-1-l1"><a class="header" href="#layer-1-l1">Layer 1 (L1)</a></h2>
<p>Refers the Ethereum blockchain, used in contrast to <a href="glossary.html#layer-2-L2">layer 2</a>, which refers to Optimism.</p>
<h2 id="layer-2-l2"><a class="header" href="#layer-2-l2">Layer 2 (L2)</a></h2>
<p>Refers to the Optimism blockchain (specified in this repository), used in contrast to <a href="glossary.html#layer-1-L1">layer 1</a>, which
refers to the Ethereum blockchain.</p>
<h2 id="block"><a class="header" href="#block">Block</a></h2>
<p>Can refer to an <a href="glossary.html#layer-1-L1">L1</a> block, or to an <a href="glossary.html#layer-2-L2">L2</a> block, which are structured similarly.</p>
<p>A block is a sequential list of transactions, along with a couple of properties stored in the <em>header</em> of the block. A
description of these properties can be found in code comments <a href="https://github.com/norswap/nanoeth/blob/cc5d94a349c90627024f3cd629a2d830008fec72/src/com/norswap/nanoeth/blocks/BlockHeader.java#L22-L156">here</a>, or in the <a href="https://ethereum.github.io/yellowpaper/paper.pdf">Ethereum yellow paper
(pdf)</a>, section 4.3.</p>
<p>It is useful to distinguish between input block properties, which are known before executing the transactions in the
block, and output block properties, which are derived after executing the block's transactions. These include various
<a href="glossary.html#merkle-patricia-trie">Merkle Patricia Trie roots</a> that notably commit to the L2 state and to the log events emitted during execution.</p>
<h2 id="eoa"><a class="header" href="#eoa">EOA</a></h2>
<p>"Externally Owned Account", an Ethereum term to designate addresses operated by users, as opposed to contract addresses.</p>
<h2 id="merkle-patricia-trie"><a class="header" href="#merkle-patricia-trie">Merkle Patricia Trie</a></h2>
<p>A <a href="https://github.com/norswap/nanoeth/blob/d4c0c89cc774d4225d16970aa44c74114c1cfa63/src/com/norswap/nanoeth/trees/patricia/README.md">Merkle Patricia Trie (MPT)</a> is a sparse trie, which is a tree-like structure that maps keys to values.
The root hash of a MPT is a commitment to the contents of the tree, which allows a
proof to be constructed for any key-value mapping encoded in the tree. Such a proof is called a Merkle proof, and can be
verified against the Merkle root.</p>
<h2 id="chain-re-organization"><a class="header" href="#chain-re-organization">Chain Re-Organization</a></h2>
<p>A re-organization, or re-org for short, is whenever the head of a blockchain (its last block) changes (as dictated by
the <a href="glossary.html#fork-choice-rule">fork choice rule</a>) to a block that is not a child of the previous head.</p>
<p>L1 re-orgs can happen because of network conditions or attacks. L2 re-orgs are a consequence of L1 re-orgs, mediated via
<a href="glossary.html#L2-chain-derivation">L2 chain derivation</a>.</p>
<h2 id="predeployed-contract-predeploy"><a class="header" href="#predeployed-contract-predeploy">Predeployed Contract ("Predeploy")</a></h2>
<p>A contract placed in the L2 genesis state (i.e. at the start of the chain).</p>
<p>All predeploy contracts are specified in the <a href="./protocol/predeploys.html">predeploys specification</a>.</p>
<h2 id="preinstalled-contract-preinstall"><a class="header" href="#preinstalled-contract-preinstall">Preinstalled Contract ("Preinstall")</a></h2>
<p>A contract placed in the L2 genesis state (i.e. at the start of the chain). These contracts do not share the same
security guarantees as <a href="glossary.html#predeployed-contract-predeploy">predeploys</a>, but are general use contracts made
available to improve the L2's UX.</p>
<p>All preinstall contracts are specified in the <a href="./protocol/preinstalls.html">preinstalls specification</a>.</p>
<h2 id="precompiled-contract-precompile"><a class="header" href="#precompiled-contract-precompile">Precompiled Contract ("Precompile")</a></h2>
<p>A contract implemented natively in the EVM that performs a specific operation more efficiently than a bytecode
(e.g. Solidity) implementation. Precompiles exist at predefined addresses. They are created and modified through
network upgrades.</p>
<p>All precompile contracts are specified in the <a href="./protocol/precompiles.html">precompiles specification</a>.</p>
<h2 id="receipt"><a class="header" href="#receipt">Receipt</a></h2>
<p>A receipt is an output generated by a transaction, comprising a status code, the amount of gas used, a list of log
entries, and a <a href="https://en.wikipedia.org/wiki/Bloom_filter">bloom filter</a> indexing these entries. Log entries are most notably used to encode <a href="https://docs.soliditylang.org/en/latest/contracts.html?highlight=events#events">Solidity events</a>.</p>
<p>Receipts are not stored in blocks, but blocks store a <a href="glossary.html#merkle-patricia-trie">Merkle Patricia Trie root</a> for a tree containing the receipt
for every transaction in the block.</p>
<p>Receipts are specified in the <a href="https://ethereum.github.io/yellowpaper/paper.pdf">yellow paper (pdf)</a> section 4.3.1.</p>
<h2 id="transaction-type"><a class="header" href="#transaction-type">Transaction Type</a></h2>
<p>Ethereum provides a mechanism (as described in <a href="https://eips.ethereum.org/EIPS/eip-2718">EIP-2718</a>) for defining different transaction types.
Different transaction types can contain different payloads, and be handled differently by the protocol.</p>
<h2 id="fork-choice-rule"><a class="header" href="#fork-choice-rule">Fork Choice Rule</a></h2>
<p>The fork choice rule is the rule used to determine which block is to be considered as the head of a blockchain. On L1,
this is determined by the proof of stake rules.</p>
<p>L2 also has a fork choice rule, although the rules vary depending on whether we want the <a href="glossary.html#safe-l2-head">safe L2 head</a>,
the <a href="glossary.html#unsafe-l2-head">unsafe L2 head</a> or the <a href="glossary.html#finalized-l2-head">finalized L2 head</a>.</p>
<h2 id="priority-gas-auction"><a class="header" href="#priority-gas-auction">Priority Gas Auction</a></h2>
<p>Transactions in ethereum are ordered by the price that the transaction pays to the miner. Priority Gas Auctions
(PGAs) occur when multiple parties are competing to be the first transaction in a block. Each party continuously
updates the gas price of their transaction. PGAs occur when there is value in submitting a transaction before other
parties (like being the first deposit or submitting a deposit before there is not more guaranteed gas remaining).
PGAs tend to have negative externalities on the network due to a large amount of transactions being submitted in a
very short amount of time.</p>
<hr />
<h1 id="sequencing"><a class="header" href="#sequencing">Sequencing</a></h1>
<p>Transactions in the rollup can be included in two ways:</p>
<ul>
<li>Through a <a href="glossary.html#deposited-transaction">deposited transaction</a>, enforced by the system</li>
<li>Through a regular transaction, embedded in a <a href="glossary.html#sequencer-batch">sequencer batch</a></li>
</ul>
<p>Submitting transactions for inclusion in a batch saves costs by reducing overhead, and enables the sequencer to
pre-confirm the transactions before the L1 confirms the data.</p>
<h2 id="sequencer-1"><a class="header" href="#sequencer-1">Sequencer</a></h2>
<p>A sequencer is either a <a href="glossary.html#rollup-node">rollup node</a> ran in sequencer mode, or the operator of this rollup node.</p>
<p>The sequencer is a privileged actor, which receives L2 transactions from L2 users, creates L2 blocks using them, which
it then submits to <a href="glossary.html#data-availability-provider">data availability provider</a> (via a <a href="glossary.html#batcher">batcher</a>). It also submits <a href="glossary.html#l2-output-root">output
roots</a> to L1.</p>
<h2 id="sequencing-window"><a class="header" href="#sequencing-window">Sequencing Window</a></h2>
<p>A sequencing window is a range of L1 blocks from which a <a href="glossary.html#sequencing-epoch">sequencing epoch</a> can be derived.</p>
<p>A sequencing window whose first L1 block has number <code>N</code> contains <a href="glossary.html#batcher-transaction">batcher transactions</a> for epoch
<code>N</code>. The window contains blocks <code>[N, N + SWS)</code> where <code>SWS</code> is the sequencer window size.</p>
<p>The current default <code>sws</code> is 3600 epochs.</p>
<p>Additionally, the first block in the window defines the <a href="glossary.html#depositing-transaction">depositing transactions</a> which determine the
<a href="glossary.html#deposits">deposits</a> to be included in the first L2 block of the epoch.</p>
<h2 id="sequencing-epoch"><a class="header" href="#sequencing-epoch">Sequencing Epoch</a></h2>
<p>A sequencing epoch is sequential range of L2 blocks derived from a <a href="glossary.html#sequencing-window">sequencing window</a> of L1 blocks.</p>
<p>Each epoch is identified by an epoch number, which is equal to the block number of the first L1 block in the
sequencing window.</p>
<p>Epochs can have variable size, subject to some constraints. See the <a href="./protocol/derivation.html">L2 chain derivation specification</a>
for more details.</p>
<h2 id="l1-origin"><a class="header" href="#l1-origin">L1 Origin</a></h2>
<p>The L1 origin of an L2 block is the L1 block corresponding to its <a href="glossary.html#sequencing-epoch">sequencing epoch</a>.</p>
<hr />
<h1 id="deposits-2"><a class="header" href="#deposits-2">Deposits</a></h1>
<p>In general, a deposit is an L2 transaction derived from an L1 block (by the <a href="glossary.html#rollup-driver">rollup driver</a>).</p>
<p>While transaction deposits are notably (but not only) used to "deposit" (bridge) ETH and tokens to L2, the word
<em>deposit</em> should be understood as "a transaction <em>deposited</em> to L2 from L1".</p>
<p>This term <em>deposit</em> is somewhat ambiguous as these "transactions" exist at multiple levels. This section disambiguates
all deposit-related terms.</p>
<p>Notably, a <em>deposit</em> can refer to:</p>
<ul>
<li>A <a href="glossary.html#deposited-transaction">deposited transaction</a> (on L2) that is part of a deposit block.</li>
<li>A <a href="glossary.html#depositing-call">depositing call</a> that causes a <a href="glossary.html#deposited-transaction">deposited transaction</a> to be derived.</li>
<li>The event/log data generated by the <a href="glossary.html#depositing-call">depositing call</a>, which is what the <a href="glossary.html#rollup-driver">rollup driver</a> reads to
derive the <a href="glossary.html#deposited-transaction">deposited transaction</a>.</li>
</ul>
<p>We sometimes also talk about <em>user deposit</em> which is a similar term that explicitly excludes <a href="glossary.html#l1-attributes-deposited-transaction">L1 attributes deposited
transactions</a>.</p>
<p>Deposits are specified in the <a href="./protocol/deposits.html">deposits specification</a>.</p>
<h2 id="deposited-transaction"><a class="header" href="#deposited-transaction">Deposited Transaction</a></h2>
<p>A <em>deposited transaction</em> is a L2 transaction that was derived from L1 and included in a L2 block.</p>
<p>There are two kinds of deposited transactions:</p>
<ul>
<li><a href="glossary.html#l1-attributes-deposited-transaction">L1 attributes deposited transaction</a>, which submits the L1 block's attributes to the <a href="glossary.html#l1-attributes-predeployed-contract">L1 Attributes
Predeployed Contract</a>.</li>
<li><a href="glossary.html#user-deposited-transaction">User-deposited transactions</a>, which are transactions derived from an L1 call to the <a href="glossary.html#deposit-contract">deposit
contract</a>.</li>
</ul>
<h2 id="l1-attributes-deposited-transaction-1"><a class="header" href="#l1-attributes-deposited-transaction-1">L1 Attributes Deposited Transaction</a></h2>
<p>An <em>L1 attributes deposited transaction</em> is <a href="glossary.html#deposited-transaction">deposited transaction</a> that is used to register the L1 block
attributes (number, timestamp, ...) on L2 via a call to the <a href="glossary.html#l1-attributes-predeployed-contract">L1 Attributes Predeployed Contract</a>.
That contract can then be used to read the attributes of the L1 block corresponding to the current L2 block.</p>
<p>L1 attributes deposited transactions are specified in the <a href="./protocol/deposits.html#l1-attributes-deposited-transaction">L1 Attributes Deposit</a> section of the
deposits specification.</p>
<h2 id="user-deposited-transaction"><a class="header" href="#user-deposited-transaction">User-Deposited Transaction</a></h2>
<p>A <em>user-deposited transaction</em> is a <a href="glossary.html#deposited-transaction">deposited transaction</a> which is derived from an L1 call to the <a href="glossary.html#deposit-contract">deposit
contract</a> (a <a href="glossary.html#depositing-call">depositing call</a>).</p>
<p>User-deposited transactions are specified in the <a href="./protocol/deposits.html#user-deposited-transactions">Transaction Deposits</a> section of the deposits
specification.</p>
<h2 id="depositing-call"><a class="header" href="#depositing-call">Depositing Call</a></h2>
<p>A <em>depositing call</em> is an L1 call to the <a href="glossary.html#deposit-contract">deposit contract</a>, which will be derived to a
<a href="glossary.html#user-deposited-transaction">user-deposited transaction</a> by the <a href="glossary.html#rollup-driver">rollup driver</a>.</p>
<p>This call specifies all the data (destination, value, calldata, ...) for the deposited transaction.</p>
<h2 id="depositing-transaction"><a class="header" href="#depositing-transaction">Depositing Transaction</a></h2>
<p>A <em>depositing transaction</em> is an L1 transaction that makes one or more <a href="glossary.html#depositing-call">depositing calls</a>.</p>
<h2 id="depositor"><a class="header" href="#depositor">Depositor</a></h2>
<p>The <em>depositor</em> is the L1 account (contract or <a href="glossary.html#EOA">EOA</a>) that makes (is the <code>msg.sender</code> of) the <a href="glossary.html#depositing-call">depositing
call</a>. The <em>depositor</em> is <strong>NOT</strong> the originator of the depositing transaction (i.e. <code>tx.origin</code>).</p>
<h2 id="deposited-transaction-type"><a class="header" href="#deposited-transaction-type">Deposited Transaction Type</a></h2>
<p>The <em>deposited transaction type</em> is an <a href="https://eips.ethereum.org/EIPS/eip-2718">EIP-2718</a> <a href="glossary.html#transaction-type">transaction type</a>, which specifies the input fields
and correct handling of a <a href="glossary.html#deposited-transaction">deposited transaction</a>.</p>
<p>See the <a href="./protocol/deposits.html#the-deposited-transaction-type">corresponding section</a> of the deposits spec for more information.</p>
<h2 id="deposit-contract-1"><a class="header" href="#deposit-contract-1">Deposit Contract</a></h2>
<p>The <em>deposit contract</em> is an <a href="glossary.html#layer-1-L1">L1</a> contract to which <a href="glossary.html#EOA">EOAs</a> and contracts may send <a href="glossary.html#deposits">deposits</a>. The deposits are
emitted as log records (in Solidity, these are called <em>events</em>) for consumption by <a href="glossary.html#rollup-node">rollup nodes</a>.</p>
<p>Advanced note: the deposits are not stored in calldata because they can be sent by contracts, in which case the calldata
is part of the <em>internal</em> execution between contracts, and this intermediate calldata is not captured in one of the
<a href="glossary.html#merkle-patricia-trie">Merkle Patricia Trie roots</a> included in the L1 block.</p>
<p>cf. <a href="./protocol/deposits.html">Deposits Specification</a></p>
<hr />
<h1 id="withdrawals-1"><a class="header" href="#withdrawals-1">Withdrawals</a></h1>
<blockquote>
<p><strong>TODO</strong> expand this whole section to be clearer</p>
</blockquote>
<p>In general, a withdrawal is a transaction sent from L2 to L1 that may transfer data and/or value.</p>
<p>The term <em>withdrawal</em> is somewhat ambiguous as these "transactions" exist at multiple levels. In order to differentiate
between the L1 and L2 components of a withdrawal we introduce the following terms:</p>
<ul>
<li>A <em>withdrawal initiating transaction</em> refers specifically to a transaction on L2 sent to the Withdrawals predeploy.</li>
<li>A <em>withdrawal finalizing transaction</em> refers specifically to an L1 transaction which finalizes and relays the
withdrawal.</li>
</ul>
<h2 id="relayer"><a class="header" href="#relayer">Relayer</a></h2>
<p>An EOA on L1 which finalizes a withdrawal by submitting the data necessary to verify its inclusion on L2.</p>
<h2 id="finalization-period"><a class="header" href="#finalization-period">Finalization Period</a></h2>
<p>The finalization period â€” sometimes also called <em>withdrawal delay</em> â€” is the minimum amount of time (in seconds) that
must elapse before a <a href="glossary.html#withdrawals">withdrawal</a> can be finalized.</p>
<p>The finalization period is necessary to afford sufficient time for <a href="glossary.html#validator">validators</a> to make a <a href="glossary.html#fault-proof">fault
proof</a>.</p>
<blockquote>
<p><strong>TODO</strong> specify current value for finalization period</p>
</blockquote>
<hr />
<h1 id="batch-submission-1"><a class="header" href="#batch-submission-1">Batch Submission</a></h1>
<h2 id="data-availability"><a class="header" href="#data-availability">Data Availability</a></h2>
<p>Data availability is the guarantee that some data will be "available" (i.e. <em>retrievable</em>) during a reasonably long time
window. In Optimism's case, the data in question are <a href="glossary.html#sequencer-batch">sequencer batches</a> that <a href="glossary.html#validator">validators</a>
need in order to verify the sequencer's work and validate the L2 chain.</p>
<p>The <a href="glossary.html#finalization-period">finalization period</a> should be taken as the lower bound on the availability window, since
that is when data availability is the most crucial, as it is needed to perform a <a href="glossary.html#fault-proof">fault proof</a>.</p>
<p>"Availability" <strong>does not</strong> mean guaranteed long-term storage of the data.</p>
<h2 id="data-availability-provider"><a class="header" href="#data-availability-provider">Data Availability Provider</a></h2>
<p>A data availability provider is a service that can be used to make data available. See the <a href="glossary.html#data-availability">Data
Availability</a> for more information on what this means.</p>
<p>Ideally, a good data availability provider provides strong <em>verifiable</em> guarantees of data availability</p>
<p>At present, the supported data availability providers include Ethereum call data and blob data.</p>
<h2 id="sequencer-batch"><a class="header" href="#sequencer-batch">Sequencer Batch</a></h2>
<p>A sequencer batch is list of L2 transactions (that were submitted to a sequencer) tagged with an <a href="glossary.html#sequencing-epoch">epoch
number</a> and an L2 block timestamp (which can trivially be converted to a block number, given our
block time is constant).</p>
<p>Sequencer batches are part of the <a href="glossary.html#l2-derivation-inputs">L2 derivation inputs</a>. Each batch represents the inputs needed to build
<strong>one</strong> L2 block (given the existing L2 chain state) â€” except for the first block of each epoch, which also needs
information about deposits (cf. the section on <a href="glossary.html#l2-derivation-inputs">L2 derivation inputs</a>).</p>
<h2 id="channel"><a class="header" href="#channel">Channel</a></h2>
<p>A channel is a sequence of <a href="glossary.html#sequencer-batch">sequencer batches</a> (for sequential blocks) compressed together. The reason
to group multiple batches together is simply to obtain a better compression rate, hence reducing data availability
costs.</p>
<p>A channel can be split in <a href="glossary.html#channel-frame">frames</a> in order to be transmitted via <a href="glossary.html#batcher-transaction">batcher
transactions</a>. The reason to split a channel into frames is that a channel might be too large to
include in a single batcher transaction.</p>
<p>A channel is uniquely identified by its timestamp (UNIX time at which the channel was created) and a random value. See
the <a href="./protocol/derivation.html#frame-format">Frame Format</a> section of the L2 Chain Derivation specification for more information.</p>
<p>On the side of the <a href="glossary.html#rollup-node">rollup node</a> (which is the consumer of channels), a channel is considered to be
<em>opened</em> if its final frame (explicitly marked as such) has not been read, or closed otherwise.</p>
<h2 id="channel-frame"><a class="header" href="#channel-frame">Channel Frame</a></h2>
<p>A channel frame is a chunk of data belonging to a <a href="glossary.html#channel">channel</a>. <a href="glossary.html#batcher-transaction">Batcher transactions</a> carry one or
multiple frames. The reason to split a channel into frames is that a channel might too large to include in a single
batcher transaction.</p>
<h2 id="batcher-1"><a class="header" href="#batcher-1">Batcher</a></h2>
<p>A batcher is a software component (independent program) that is responsible to make channels available on a data
availability provider. The batcher communicates with the rollup node in order to retrieve the channels. The channels are
then made available using <a href="glossary.html#batcher-transaction">batcher transactions</a>.</p>
<blockquote>
<p><strong>TODO</strong> In the future, we might want to make the batcher responsible for constructing the channels, letting it only
query the rollup node for L2 block inputs.</p>
</blockquote>
<h2 id="batcher-transaction"><a class="header" href="#batcher-transaction">Batcher Transaction</a></h2>
<p>A batcher transaction is a transaction submitted by a <a href="glossary.html#batcher">batcher</a> to a data availability provider, in order to make
channels available. These transactions carry one or more full frames, which may belong to different channels. A
channel's frames may be split between multiple batcher transactions.</p>
<p>When submitted to Ethereum calldata, the batcher transaction's receiver must be the sequencer inbox address. The
transaction must also be signed by a recognized batch submitter account. The recognized batch submitter account
is stored in the <a href="glossary.html#system-configuration">System Configuration</a>.</p>
<h2 id="batch-submission-frequency-1"><a class="header" href="#batch-submission-frequency-1">Batch submission frequency</a></h2>
<p>Within the <a href="glossary.html#sequencing-window">sequencing-window</a> constraints the batcher is permitted by the protocol to submit L2 blocks for
data-availability at any time. The batcher software allows for dynamic policy configuration by its operator.
The rollup enforces safety guarantees and liveness through the sequencing window, if the batcher does not submit
data within this allotted time.</p>
<p>By submitting new L2 data in smaller more frequent steps, there is less delay in confirmation of the L2 block
inputs. This allows verifiers to ensure safety of L2 blocks sooner. This also reduces the time to finality of
the data on L1, and thus the time to L2 input-finality.</p>
<p>By submitting new L2 data in larger less frequent steps, there is more time to aggregate more L2 data, and
thus reduce fixed overhead of the batch-submission work. This can reduce batch-submission costs, especially
for lower throughput chains that do not fill data-transactions (typically 128 KB of calldata, or 800 KB
of blobdata) as quickly.</p>
<h2 id="channel-timeout"><a class="header" href="#channel-timeout">Channel Timeout</a></h2>
<p>The channel timeout is a duration (in L1 blocks) during which <a href="glossary.html#channel-frame">channel frames</a> may land on L1 within
<a href="glossary.html#batcher-transaction">batcher transactions</a>.</p>
<p>The acceptable time range for the frames of a <a href="glossary.html#channel">channel</a> is <code>[channel_id.timestamp, channel_id.timestamp + CHANNEL_TIMEOUT]</code>. The acceptable L1 block range for these frames are any L1 block whose timestamp falls inside this
time range. (Note that <code>channel_id.timestamp</code> must be lower than the L1 block timestamp of any L1 block in which frames
of the channel are seen, or else these frames are ignored.)</p>
<p>The purpose of channel timeouts is dual:</p>
<ul>
<li>Avoid keeping old unclosed channel data around forever (an unclosed channel is a channel whose final frame was not
sent).</li>
<li>Bound the number of L1 blocks we have to look back in order to decode <a href="glossary.html#sequencer-batch">sequencer batches</a> from
channels. This is particularly relevant during L1 re-orgs, see the <a href="./protocol/derivation.html#resetting-channel-buffering">Resetting Channel Buffering</a>
section of the L2 Chain Derivation specification for more information.</li>
</ul>
<blockquote>
<p><strong>TODO</strong> specify <code>CHANNEL_TIMEOUT</code></p>
</blockquote>
<hr />
<h1 id="l2-output-root-proposals"><a class="header" href="#l2-output-root-proposals">L2 Output Root Proposals</a></h1>
<h2 id="proposer"><a class="header" href="#proposer">Proposer</a></h2>
<p>The proposer's role is to construct and submit output roots, which are commitments to the L2's state, to the
L2OutputOracle contract on L1 (the settlement layer). To do this, the proposer periodically queries the rollup node for
the latest output root derived from the latest finalized L1 block. It then takes the output root and submits it to the
L2OutputOracle contract on the settlement layer (L1).</p>
<hr />
<h1 id="l2-chain-derivation"><a class="header" href="#l2-chain-derivation">L2 Chain Derivation</a></h1>
<p>L2 chain derivation is a process that reads <a href="glossary.html#l2-derivation-inputs">L2 derivation inputs</a> from L1 in order to derive the L2
chain.</p>
<p>See the <a href="./protocol/derivation.html">L2 chain derivation specification</a> for more details.</p>
<h2 id="l2-derivation-inputs"><a class="header" href="#l2-derivation-inputs">L2 Derivation Inputs</a></h2>
<p>This term refers to data that is found in L1 blocks and is read by the <a href="glossary.html#rollup-node">rollup node</a> to construct <a href="glossary.html#payload-attributes">payload
attributes</a>.</p>
<p>L2 derivation inputs include:</p>
<ul>
<li>L1 block attributes
<ul>
<li>block number</li>
<li>timestamp</li>
<li>basefee</li>
<li>blob base fee</li>
</ul>
</li>
<li><a href="glossary.html#deposits">deposits</a> (as log data)</li>
<li><a href="glossary.html#sequencer-batch">sequencer batches</a> (as transaction data)</li>
<li><a href="glossary.html#system-configuration">System configuration</a> updates (as log data)</li>
</ul>
<h2 id="system-configuration"><a class="header" href="#system-configuration">System Configuration</a></h2>
<p>This term refers to the collection of dynamically configurable rollup parameters maintained
by the <a href="glossary.html#system-configuration"><code>SystemConfig</code></a> contract on L1 and read by the L2 <a href="glossary.html#L2-chain-derivation">derivation</a> process.
These parameters enable keys to be rotated regularly and external cost parameters to be adjusted
without the network upgrade overhead of a hardfork.</p>
<h2 id="payload-attributes"><a class="header" href="#payload-attributes">Payload Attributes</a></h2>
<p>This term refers to an object that can be derived from <a href="glossary.html#l2-derivation-inputs">L2 chain derivation inputs</a> found on L1, which are
then passed to the <a href="glossary.html#execution-engine">execution engine</a> to construct L2 blocks.</p>
<p>The payload attributes object essentially encodes <a href="glossary.html#block">a block without output properties</a>.</p>
<p>Payload attributes are originally specified in the <a href="https://github.com/ethereum/execution-apis/blob/main/src/engine/shanghai.md#PayloadAttributesV2">Ethereum Engine API specification</a>, which we expand in
the <a href="./protocol/exec-engine.html">Execution Engine Specification</a>.</p>
<p>See also the <a href="./protocol/rollup-node.html#building-the-payload-attributes">Building The Payload Attributes</a> section of the rollup node specification.</p>
<h2 id="l2-genesis-block"><a class="header" href="#l2-genesis-block">L2 Genesis Block</a></h2>
<p>The L2 genesis block is the first block of the L2 chain in its current version.</p>
<p>The state of the L2 genesis block comprises:</p>
<ul>
<li>State inherited from the previous version of the L2 chain.
<ul>
<li>This state was possibly modified by "state surgeries". For instance, the migration to Bedrock entailed changes on
how native ETH balances were stored in the storage trie.</li>
</ul>
</li>
<li><a href="glossary.html#predeployed-contract-predeploy">Predeployed contracts</a></li>
</ul>
<p>The timestamp of the L2 genesis block must be a multiple of the <a href="glossary.html#block-time">block time</a> (i.e. a even number, since the
block time is 2 seconds).</p>
<p>When updating the rollup protocol to a new version, we may perform a <em>squash fork</em>, a process that entails the creation
of a new L2 genesis block. This new L2 genesis block will have block number <code>X + 1</code>, where <code>X</code> is the block number of
the final L2 block before the update.</p>
<p>A squash fork is not to be confused with a <em>re-genesis</em>, a similar process that we employed in the past, which also
resets L2 block numbers, such that the new L2 genesis block has number 0. We will not employ re-genesis in the future.</p>
<p>Squash forks are superior to re-geneses because they avoid duplicating L2 block numbers, which breaks a lot of external
tools.</p>
<h2 id="l2-chain-inception"><a class="header" href="#l2-chain-inception">L2 Chain Inception</a></h2>
<p>The L1 block number at which the output roots for the <a href="glossary.html#l2-genesis-block">genesis block</a> were proposed on the <a href="glossary.html#l2-output-oracle-contract">output
oracle</a> contract.</p>
<p>In the current implementation, this is the L1 block number at which the output oracle contract was deployed or upgraded.</p>
<h2 id="safe-l2-block"><a class="header" href="#safe-l2-block">Safe L2 Block</a></h2>
<p>A safe L2 block is an L2 block that can be derived entirely from L1 by a <a href="glossary.html#rollup-node">rollup node</a>. This can vary
between different nodes, based on their view of the L1 chain.</p>
<h2 id="safe-l2-head"><a class="header" href="#safe-l2-head">Safe L2 Head</a></h2>
<p>The safe L2 head is the highest <a href="glossary.html#safe-l2-block">safe L2 block</a> that a <a href="glossary.html#rollup-node">rollup node</a> knows about.</p>
<h2 id="unsafe-l2-block"><a class="header" href="#unsafe-l2-block">Unsafe L2 Block</a></h2>
<p>An unsafe L2 block is an L2 block that a <a href="glossary.html#rollup-node">rollup node</a> knows about, but which was not derived from the L1
chain. In sequencer mode, this will be a block sequenced by the sequencer itself. In validator mode, this will be a
block acquired from the sequencer via <a href="glossary.html#unsafe-sync">unsafe sync</a>.</p>
<h2 id="unsafe-l2-head"><a class="header" href="#unsafe-l2-head">Unsafe L2 Head</a></h2>
<p>The unsafe L2 head is the highest <a href="glossary.html#unsafe-l2-block">unsafe L2 block</a> that a <a href="glossary.html#rollup-node">rollup node</a> knows about.</p>
<h2 id="unsafe-block-consolidation"><a class="header" href="#unsafe-block-consolidation">Unsafe Block Consolidation</a></h2>
<p>Unsafe block consolidation is the process through which the <a href="glossary.html#rollup-node">rollup node</a> attempts to move the <a href="glossary.html#safe-l2-head">safe L2
head</a> a block forward, so that the oldest <a href="glossary.html#unsafe-l2-block">unsafe L2 block</a> becomes the new safe L2 head.</p>
<p>In order to perform consolidation, the node verifies that the <a href="glossary.html#payload-attributes">payload attributes</a> derived from the L1
chain match the oldest unsafe L2 block exactly.</p>
<p>See the <a href="./protocol/derivation.html#engine-queue">Engine Queue section</a> of the L2 chain derivation spec for more information.</p>
<h2 id="finalized-l2-head"><a class="header" href="#finalized-l2-head">Finalized L2 Head</a></h2>
<p>The finalized L2 head is the highest L2 block that can be derived from <em><a href="https://hackmd.io/@prysmaticlabs/finality">finalized</a></em> L1 blocks â€” i.e. L1
blocks older than two L1 epochs (64 L1 <a href="glossary.html#time-slot">time slots</a>).</p>
<hr />
<h1 id="other-l2-chain-concepts"><a class="header" href="#other-l2-chain-concepts">Other L2 Chain Concepts</a></h1>
<h2 id="address-aliasing-1"><a class="header" href="#address-aliasing-1">Address Aliasing</a></h2>
<p>When a contract submits a <a href="glossary.html#deposits">deposit</a> from L1 to L2, its address (as returned by <code>ORIGIN</code> and <code>CALLER</code>) will be
aliased with a modified representation of the address of a contract.</p>
<ul>
<li>cf. <a href="./protocol/deposits.html#address-aliasing">Deposit Specification</a></li>
</ul>
<h2 id="rollup-node"><a class="header" href="#rollup-node">Rollup Node</a></h2>
<p>The rollup node is responsible for <a href="glossary.html#L2-chain-derivation">deriving the L2 chain</a> from the L1 chain (L1 <a href="glossary.html#block">blocks</a> and their
associated <a href="glossary.html#receipt">receipts</a>).</p>
<p>The rollup node can run either in <em>validator</em> or <em>sequencer</em> mode.</p>
<p>In sequencer mode, the rollup node receives L2 transactions from users, which it uses to create L2 blocks. These are
then submitted to a <a href="glossary.html#data-availability-provider">data availability provider</a> via <a href="glossary.html#batch-submission">batch submission</a>. The L2 chain
derivation then acts as a sanity check and a way to detect L1 chain <a href="glossary.html#chain-re-organization">re-orgs</a>.</p>
<p>In validator mode, the rollup node performs derivation as indicated above, but is also able to "run ahead" of the L1
chain by getting blocks directly from the sequencer, in which case derivation serves to validate the sequencer's
behavior.</p>
<p>A rollup node running in validator mode is sometimes called <em>a replica</em>.</p>
<blockquote>
<p><strong>TODO</strong> expand this to include output root submission</p>
</blockquote>
<p>See the <a href="./protocol/rollup-node.html">rollup node specification</a> for more information.</p>
<h2 id="rollup-driver"><a class="header" href="#rollup-driver">Rollup Driver</a></h2>
<p>The rollup driver is the <a href="glossary.html#rollup-node">rollup node</a> component responsible for <a href="glossary.html#L2-chain-derivation">deriving the L2 chain</a>
from the L1 chain (L1 <a href="glossary.html#block">blocks</a> and their associated <a href="glossary.html#receipt">receipts</a>).</p>
<blockquote>
<p><strong>TODO</strong> delete this entry, alongside its reference â€” can be replaced by "derivation process" or "derivation logic"
where needed</p>
</blockquote>
<h2 id="l1-attributes-predeployed-contract-2"><a class="header" href="#l1-attributes-predeployed-contract-2">L1 Attributes Predeployed Contract</a></h2>
<p>A <a href="glossary.html#predeployed-contract-predeploy">predeployed contract</a> on L2 that can be used to retrieve the L1 block attributes of L1 blocks with a given
block number or a given block hash.</p>
<p>cf. <a href="./protocol/deposits.html#l1-attributes-predeployed-contract">L1 Attributes Predeployed Contract Specification</a></p>
<h2 id="l2-output-root"><a class="header" href="#l2-output-root">L2 Output Root</a></h2>
<p>A 32 byte value which serves as a commitment to the current state of the L2 chain.</p>
<p>cf. <a href="./protocol/proposals.html#l2-output-root-proposals-specification">Proposing L2 output commitments</a></p>
<h2 id="l2-output-oracle-contract"><a class="header" href="#l2-output-oracle-contract">L2 Output Oracle Contract</a></h2>
<p>An L1 contract to which <a href="glossary.html#l2-output-root">L2 output roots</a> are posted by the <a href="glossary.html#sequencer">sequencer</a>.</p>
<h2 id="validator"><a class="header" href="#validator">Validator</a></h2>
<p>A validator is an entity (individual or organization) that runs a <a href="glossary.html#rollup-node">rollup node</a> in validator mode.</p>
<p>Doing so grants a lot of benefits similar to running an Ethereum node, such as the ability to simulate L2 transactions
locally, without rate limiting.</p>
<p>It also lets the validator verify the work of the <a href="glossary.html#sequencer">sequencer</a>, by re-deriving <a href="glossary.html#l2-output-root">output roots</a> and comparing
them against those submitted by the sequencer. In case of a mismatch, the validator can perform a <a href="glossary.html#fault-proof">fault
proof</a>.</p>
<h2 id="fault-proof-3"><a class="header" href="#fault-proof-3">Fault Proof</a></h2>
<p>An on-chain <em>interactive</em> proof, performed by <a href="glossary.html#validator">validators</a>, that demonstrates that a <a href="glossary.html#sequencer">sequencer</a> provided
erroneous <a href="glossary.html#l2-output-root">output roots</a>.</p>
<p>cf. <a href="fault-proof/index.html">Fault Proofs</a></p>
<h2 id="time-slot"><a class="header" href="#time-slot">Time Slot</a></h2>
<p>On L2, there is a block every 2 second (this duration is known as the <a href="glossary.html#block-time">block time</a>).</p>
<p>We say that there is a "time slot" every multiple of 2s after the timestamp of the <a href="glossary.html#l2-genesis-block">L2 genesis block</a>.</p>
<p>On L1, post-<a href="https://ethereum.org/en/eth2/merge/">merge</a>, the time slots are every 12s. However, an L1 block may not be produced for every time slot, in case
of even benign consensus issues.</p>
<h2 id="block-time"><a class="header" href="#block-time">Block Time</a></h2>
<p>The L2 block time is 2 second, meaning there is an L2 block at every 2s <a href="glossary.html#time-slot">time slot</a>.</p>
<p>Post-<a href="https://ethereum.org/en/eth2/merge/">merge</a>, it could be said that the L1 block time is 12s as that is the L1 <a href="glossary.html#time-slot">time slot</a>. However, in
reality the block time is variable as some time slots might be skipped.</p>
<p>Pre-merge, the L1 block time is variable, though it is on average 13s.</p>
<h2 id="unsafe-sync"><a class="header" href="#unsafe-sync">Unsafe Sync</a></h2>
<p>Unsafe sync is the process through which a <a href="glossary.html#validator">validator</a> learns about <a href="glossary.html#unsafe-l2-block">unsafe L2 blocks</a> from
the <a href="glossary.html#sequencer">sequencer</a>.</p>
<p>These unsafe blocks will later need to be confirmed by the L1 chain (via <a href="glossary.html#unsafe-block-consolidation">unsafe block consolidation</a>).</p>
<hr />
<h1 id="execution-engine-concepts"><a class="header" href="#execution-engine-concepts">Execution Engine Concepts</a></h1>
<h2 id="execution-engine"><a class="header" href="#execution-engine">Execution Engine</a></h2>
<p>The execution engine is responsible for executing transactions in blocks and computing the resulting state roots,
receipts roots and block hash.</p>
<p>Both L1 (post-<a href="https://ethereum.org/en/eth2/merge/">merge</a>) and L2 have an execution engine.</p>
<p>On L1, the executed blocks can come from L1 block synchronization; or from a block freshly minted by the execution
engine (using transactions from the L1 <a href="https://www.quicknode.com/guides/defi/how-to-access-ethereum-mempool">mempool</a>), at the request of the L1 consensus layer.</p>
<p>On L2, the executed blocks are freshly minted by the execution engine at the request of the <a href="glossary.html#rollup-node">rollup node</a>,
using transactions <a href="glossary.html#L2-chain-derivation">derived from L1 blocks</a>.</p>
<p>In these specifications, "execution engine" always refer to the L2 execution engine, unless otherwise specified.</p>
<ul>
<li>cf. <a href="./protocol/exec-engine.html">Execution Engine Specification</a></li>
</ul>
<!-- Internal Links -->
<!-- External Links -->

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="specs/static/solidity.min.js"></script>
        <script src="specs/static/mermaid.min.js"></script>
        <script src="specs/static/mermaid-init.js"></script>
        <script src="theme/js/footer.js"></script>

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
