<!DOCTYPE HTML>
<html lang="en" class="ayu sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Execution Engine - OP Stack Specification</title>


        <!-- Custom HTML head -->
        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-YNLKSPKGWN"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag() { dataLayer.push(arguments); }
            gtag('js', new Date());
            gtag('config', 'G-YNLKSPKGWN');
        </script>
        <meta name="google-site-verification" content="1XjEcxxHshd6NM_mxbl_uv-SyamI6_99aOpILYI3_mk" />

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../theme/css/footer.css">


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "ayu";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">OP Stack Specification</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/ethereum-optimism/specs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/ethereum-optimism/specs/edit/main/specs/protocol/isthmus/exec-engine.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="l2-execution-engine"><a class="header" href="#l2-execution-engine">L2 Execution Engine</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#timestamp-activation">Timestamp Activation</a></li>
<li><a href="#l2tol1messagepasser-storage-root-in-header"><code>L2ToL1MessagePasser</code> Storage Root in Header</a>
<ul>
<li><a href="#header-validity-rules">Header Validity Rules</a></li>
<li><a href="#header-withdrawals-root">Header Withdrawals Root</a>
<ul>
<li><a href="#rationale">Rationale</a></li>
<li><a href="#genesis-block">Genesis Block</a></li>
<li><a href="#state-processing">State Processing</a></li>
<li><a href="#p2p">P2P</a></li>
<li><a href="#backwards-compatibility-considerations">Backwards Compatibility Considerations</a></li>
<li><a href="#forwards-compatibility-considerations">Forwards Compatibility Considerations</a></li>
<li><a href="#client-implementation-considerations">Client Implementation Considerations</a>
<ul>
<li><a href="#transaction-simulation">Transaction Simulation</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#deposit-requests">Deposit Requests</a></li>
<li><a href="#block-body-withdrawals-list">Block Body Withdrawals List</a></li>
<li><a href="#evm-changes">EVM Changes</a>
<ul>
<li><a href="#bls-precompiles">BLS Precompiles</a></li>
</ul>
</li>
<li><a href="#block-sealing">Block Sealing</a></li>
<li><a href="#engine-api-updates">Engine API Updates</a>
<ul>
<li><a href="#update-to-executionpayload">Update to <code>ExecutionPayload</code></a></li>
<li><a href="#engine_newpayloadv4-api"><code>engine_newPayloadV4</code> API</a></li>
</ul>
</li>
<li><a href="#fees">Fees</a>
<ul>
<li><a href="#operator-fee">Operator Fee</a>
<ul>
<li><a href="#fee-formula">Fee Formula</a></li>
<li><a href="#deposit-operator-fees">Deposit Operator Fees</a></li>
<li><a href="#evm-fee-semantics">EVM Fee Semantics</a></li>
<li><a href="#transaction-pool-changes">Transaction Pool Changes</a></li>
<li><a href="#configuring-operator-fee-parameters">Configuring Operator Fee Parameters</a></li>
</ul>
</li>
<li><a href="#fee-vaults">Fee Vaults</a></li>
<li><a href="#receipts">Receipts</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<!-- All glossary references in this file. -->
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>The storage root of the <code>L2ToL1MessagePasser</code> is included in the block header's
<code>withdrawalRoot</code> field.</p>
<h2 id="timestamp-activation"><a class="header" href="#timestamp-activation">Timestamp Activation</a></h2>
<p>Isthmus, like other network upgrades, is activated at a timestamp.
Changes to the L2 Block execution rules are applied when the <code>L2 Timestamp &gt;= activation time</code>.</p>
<h2 id="l2tol1messagepasser-storage-root-in-header"><a class="header" href="#l2tol1messagepasser-storage-root-in-header"><code>L2ToL1MessagePasser</code> Storage Root in Header</a></h2>
<p>After Isthmus hardfork's activation, the L2 block header's <code>withdrawalsRoot</code> field will consist of the 32-byte
<a href="../../protocol/predeploys.html#L2ToL1MessagePasser"><code>L2ToL1MessagePasser</code></a> account storage root from the world state identified by the stateRoot
field in the block header. The storage root should be the same root that is returned by <code>eth_getProof</code>
at the given block number.</p>
<h3 id="header-validity-rules"><a class="header" href="#header-validity-rules">Header Validity Rules</a></h3>
<p>Prior to isthmus activation:</p>
<ul>
<li>the L2 block header's <code>withdrawalsRoot</code> field must be:
<ul>
<li><code>nil</code> if Canyon has not been activated.</li>
<li><code>keccak256(rlp(empty_string_code))</code> if Canyon has been activated.</li>
</ul>
</li>
<li>the L2 block header's <code>requestsHash</code> field must be omitted.</li>
</ul>
<p>After Isthmus activation, an L2 block header is valid iff:</p>
<ol>
<li>The <code>withdrawalsRoot</code> field
<ol>
<li>Is 32 bytes in length.</li>
<li>Matches the <a href="../../protocol/predeploys.html#L2ToL1MessagePasser"><code>L2ToL1MessagePasser</code></a> account storage root,
as committed to in the <code>storageRoot</code> within the block header</li>
</ol>
</li>
<li>The <code>requestsHash</code> field is equal to <code>sha256('') = 0xe3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855</code>
indicating no requests in the block.</li>
</ol>
<h3 id="header-withdrawals-root"><a class="header" href="#header-withdrawals-root">Header Withdrawals Root</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Byte offset</th><th>Description</th></tr></thead><tbody>
<tr><td><code>[0, 32)</code></td><td><a href="../../protocol/predeploys.html#L2ToL1MessagePasser"><code>L2ToL1MessagePasser</code></a> account storage root</td></tr>
</tbody></table>
</div>
<h4 id="rationale"><a class="header" href="#rationale">Rationale</a></h4>
<p>Currently, to generate <a href="../../glossary.html#l2-output-root">L2 output roots</a> for historical blocks, an archival node is required. This directly
places a burden on users of the system in a post-fault-proofs world, where:</p>
<ol>
<li>A proposer must have an archive node to propose an output root at the safe head.</li>
<li>A user that is proving their withdrawal must have an archive node to verify that the output root they are proving
their withdrawal against is indeed valid and included within the safe chain.</li>
</ol>
<p>Placing the <a href="../../protocol/predeploys.html#L2ToL1MessagePasser"><code>L2ToL1MessagePasser</code></a> account storage root in the <code>withdrawalsRoot</code> field alleviates this burden
for users and protocol participants alike, allowing them to propose and verify other proposals with lower operating costs.</p>
<h4 id="genesis-block"><a class="header" href="#genesis-block">Genesis Block</a></h4>
<p>If Isthmus is active at genesis block, the <code>withdrawalsRoot</code> in the genesis block header is set to the
<a href="../../protocol/predeploys.html#L2ToL1MessagePasser"><code>L2ToL1MessagePasser</code></a> account storage root.</p>
<h4 id="state-processing"><a class="header" href="#state-processing">State Processing</a></h4>
<p>At the time of state processing, the header for which transactions are being validated should not make it's <code>withdrawalsRoot</code>
available to the EVM/application layer.</p>
<h4 id="p2p"><a class="header" href="#p2p">P2P</a></h4>
<p>During sync, we expect the withdrawals list in the block body to be empty (OP stack does not make
use of the withdrawals list) and hence the hash of the withdrawals list to be the MPT root of an empty list.
When verifying the header chain using the final header that is synced, the header timestamp is used to
determine whether Isthmus is active at the said block. If it is, we expect that the header <code>withdrawalsRoot</code>
MPT hash can be any non-null value (since it is expected to contain the <code>L2ToL1MessagePasser</code>'s storage root).</p>
<h4 id="backwards-compatibility-considerations"><a class="header" href="#backwards-compatibility-considerations">Backwards Compatibility Considerations</a></h4>
<p>Beginning at Canyon (which includes Shanghai hardfork support) and prior to Isthmus activation,
the <code>withdrawalsRoot</code> field is set to the MPT root of an empty withdrawals list. This is the
same root as an empty storage root. The withdrawals are captured in the L2 state, however
they are not reflected in the <code>withdrawalsRoot</code>. Hence, prior to Isthmus activation,
even if a <code>withdrawalsRoot</code> is present and a MPT root is present in the header, it should not be used.
Any implementation that calculates output root should be careful not to use the header <code>withdrawalsRoot</code>.</p>
<p>Note that there is always nonzero storage in the <a href="../../protocol/predeploys.html#L2ToL1MessagePasser"><code>L2ToL1MessagePasser</code></a>,
because it is a <a href="../../protocol/predeploys.html">proxied predeploy</a> -- from genesis it
stores an implementation address and owner address. So from Isthmus,
the <code>withdrawalsRoot</code> will always be non-nil and never be the MPT root of an empty list.</p>
<h4 id="forwards-compatibility-considerations"><a class="header" href="#forwards-compatibility-considerations">Forwards Compatibility Considerations</a></h4>
<p>As it stands, the <code>withdrawalsRoot</code> field is unused within the OP Stack's header consensus format, and will never be
used for other reasons that are currently planned. Setting this value to the account storage root of the withdrawal
directly fits with the OP Stack, and makes use of the existing field in the L1 header consensus format.</p>
<h4 id="client-implementation-considerations"><a class="header" href="#client-implementation-considerations">Client Implementation Considerations</a></h4>
<p>Various EL clients store historical state of accounts differently. If, as a contrived case, an OP Stack chain did not have
an outbound withdrawal for a long period of time, the node may not have access to the account storage root of the
<a href="../../protocol/predeploys.html#L2ToL1MessagePasser"><code>L2ToL1MessagePasser</code></a>. In this case, the client would be unable to keep consensus. However, most modern
clients are able to at the very least reconstruct the account storage root at a given block on the fly if it does not
directly store this information.</p>
<h5 id="transaction-simulation"><a class="header" href="#transaction-simulation">Transaction Simulation</a></h5>
<p>In response to RPC methods like <code>eth_simulateV1</code> that allow simulation of arbitrary transactions within one or more blocks,
an empty withdrawals root should be included in the header of a block that consists of such simulated transactions. The same
is applicable for scenarios where the actual withdrawals root value is not readily available.</p>
<h2 id="deposit-requests"><a class="header" href="#deposit-requests">Deposit Requests</a></h2>
<p><a href="https://eips.ethereum.org/EIPS/eip-6110">EIP-6110</a> shifts deposit to the execution layer, introducing a new <a href="https://eips.ethereum.org/EIPS/eip-7685">EIP-7685</a> deposit request of type
<code>DEPOSIT_REQUEST_TYPE</code>. Deposit requests then appear in the <a href="https://eips.ethereum.org/EIPS/eip-7685">EIP-7685</a> requests list. The OP Stack needs to ignore these
requests. Requests generation must be modified to exclude <a href="https://eips.ethereum.org/EIPS/eip-6110">EIP-6110</a> deposit requests. Note that since the <a href="https://eips.ethereum.org/EIPS/eip-6110">EIP-6110</a>
request type did <em>not</em> exist prior to Pectra on L1 and the Isthmus hardfork on L2, no activation time is needed since these
deposit type requests may always be excluded.</p>
<h2 id="block-body-withdrawals-list"><a class="header" href="#block-body-withdrawals-list">Block Body Withdrawals List</a></h2>
<p>Withdrawals list in the block body is encoded as an empty RLP list.</p>
<h2 id="evm-changes"><a class="header" href="#evm-changes">EVM Changes</a></h2>
<h3 id="bls-precompiles"><a class="header" href="#bls-precompiles">BLS Precompiles</a></h3>
<p>Similar to the <code>bn256Pairing</code> precompile in the <a href="../granite/exec-engine.html">granite hardfork</a>,
<a href="https://eips.ethereum.org/EIPS/eip-2537">EIP-2537</a> introduces a BLS
precompile that short-circuits depending on input size in the EVM.</p>
<p>The input size limits of the BLS precompile contracts are listed below:</p>
<ul>
<li>G1 multiple-scalar-multiply: <code>input_size &lt;= 513760 bytes</code></li>
<li>G2 multiple-scalar-multiply: <code>input_size &lt;= 488448 bytes</code></li>
<li>Pairing check: <code>input_size &lt;= 235008 bytes</code></li>
</ul>
<p>The rest of the BLS precompiles are fixed-size operations which have a fixed gas cost.</p>
<p>All of the BLS precompiles should be <a href="../../fault-proof/index.html#precompile-accelerators">accelerated</a> in fault proof
programs so they call out to the L1 instead of calculating the result inside the program.</p>
<h2 id="block-sealing"><a class="header" href="#block-sealing">Block Sealing</a></h2>
<p>In the OP Stack, <code>EIP-7685</code> is no-op'd, and the <code>requestsHash</code> is always set to <code>sha256('')</code> (as noted in
<a href="#header-validity-rules">header validity rules</a>). As such, <a href="https://eips.ethereum.org/EIPS/eip-6110">EIP-6110</a>,
<a href="https://eips.ethereum.org/EIPS/eip-7002">EIP-7002</a>, and <a href="https://eips.ethereum.org/EIPS/eip-7251">EIP-7251</a> are not
enabled either. The OP Stack execution layer must ensure that the post-block filtering of events in the deposit contract
(EIP-6110) as well as the <code>EIP-7002</code> + <code>EIP-7251</code> system calls are <em>not invoked</em> during the block sealing process after
Isthmus activation.</p>
<p>Users of the OP Stack may still permissionlessly deploy these smart contracts, but they will not be treated as special
by the OP Stack execution layer, and the system calls introduced in L1's Pectra hardfork are not considered.</p>
<h2 id="engine-api-updates"><a class="header" href="#engine-api-updates">Engine API Updates</a></h2>
<h3 id="update-to-executionpayload"><a class="header" href="#update-to-executionpayload">Update to <code>ExecutionPayload</code></a></h3>
<p><code>ExecutionPayload</code> will contain an extra field for <code>withdrawalsRoot</code> after Isthmus hard fork.</p>
<h3 id="engine_newpayloadv4-api"><a class="header" href="#engine_newpayloadv4-api"><code>engine_newPayloadV4</code> API</a></h3>
<p>Post Isthmus, <code>engine_newPayloadV4</code> will be used.</p>
<p>The <code>executionRequests</code> parameter MUST be an empty array.</p>
<h2 id="fees"><a class="header" href="#fees">Fees</a></h2>
<p>New OP stack variants have different resource consumption patterns, and thus require a more flexible
pricing model. To enable more customizable fee structures, Isthmus adds a new component to the fee
calculation: the <code>operatorFee</code>, which is parameterized by two scalars: the <code>operatorFeeScalar</code>
and the <code>operatorFeeConstant</code>.</p>
<h3 id="operator-fee"><a class="header" href="#operator-fee">Operator Fee</a></h3>
<p>The operator fee is integrated directly into the EVM, alongside the standard gas fee and the OP Stack specific L1 data
fee. This fee follows the same semantics of existing fees charged in the EVM<sup class="footnote-reference"><a href="#1">1</a></sup>, just with a new fee beneficiary account.</p>
<h4 id="fee-formula"><a class="header" href="#fee-formula">Fee Formula</a></h4>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">operatorFee</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">gas</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">operatorFeeScalar</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">÷</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.1141em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">6</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">operatorFeeConstant</span></span></span></span></span></span></p>
<p>Where:</p>
<ul>
<li><code>gas</code> is the amount of gas that the transaction used. When calculating the amount of gas that is bought at the
beginning of the transaction, this should be the <code>gas_limit</code>. When determining how much gas should be refunded,
based off of how much of the <code>gas_limit</code> the transaction used, this should be the <code>gas_used</code>.</li>
<li><code>operatorFeeScalar</code> is a <code>uint32</code> scalar set by the chain operator, scaled by <code>1e6</code>.</li>
<li><code>operatorFeeConstant</code> is a <code>uint64</code> scalar set by the chain operator.</li>
</ul>
<p>Note that the operator fee's maximum value has 77 bits, which can be calculated from the maximum input parameters:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9275em;vertical-align:-0.2441em;"></span><span class="mord"><span class="mord text"><span class="mord">operatorFee</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.0573em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">max</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord text"><span class="mord">uint64</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">max</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8179em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord text"><span class="mord">uint32</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">max</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">÷</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.1141em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">6</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8179em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord text"><span class="mord">uint64</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">max</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">7.924660923989131</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8641em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">22</span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>So implementations don't need to check for overflows if they perform the calculations with <code>uint256</code> types.</p>
<h4 id="deposit-operator-fees"><a class="header" href="#deposit-operator-fees">Deposit Operator Fees</a></h4>
<p>Deposit transactions do not get charged operator fees. For all deposit transactions, regardless of the operator fee
parameter configuration, the operator fee should be <strong>zero</strong>. Deposit transactions also do not receive operator fee gas
refunds, since they never buy the operator fee gas to begin with.</p>
<h4 id="evm-fee-semantics"><a class="header" href="#evm-fee-semantics">EVM Fee Semantics</a></h4>
<p>Like other fees in the EVM, the operator fee should be charged following the pattern below:</p>
<ol>
<li>During pre-execution validation, the account must have enough ETH to cover the existing worst-case gas + L1 data fees
<em>as well as</em> the worst-case operator fee (for deposits, the worst-case fee is <code>0</code>). To compute this value, use the
<a href="#fee-formula">fee formula</a> with <code>gas</code> set to the <code>gas_limit</code> of the transaction, and add it to the existing
worst-case transaction fee.</li>
<li>When buying gas prior to execution, charge the account the worst-case operator fee. To compute this value, use the
<a href="#fee-formula">fee formula</a> with <code>gas</code> set to the <code>gas_limit</code> of the transaction.</li>
<li>After execution, when issuing refunds, transactions that bought operator fee gas should be refunded the operator fee
gas that was unused (i.e., the caller should only be charged the <em>effective</em> operator fee.) The refund should be
calculated as <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">opFeeRefund</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">opFeeWorstCase</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">opFeeActual</span></span></span></span></span>, where:
<ul>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">opFeeWorstCase</span></span></span></span></span> is as described in #1 + #2.</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">opFeeActual</span></span></span></span></span> is the amount of the operator fee that was actually used. This value is computed using the
<a href="#fee-formula">fee formula</a> with <code>gas</code> set to the <code>gas_limit - gas_used + refunded_gas</code>. <code>refunded_gas</code> is as
described in <a href="https://eips.ethereum.org/EIPS/eip-3529">EIP-3529</a>.</li>
</ul>
</li>
<li>After execution, when rewarding the fee beneficiaries, send the <em>spent operator fee</em> to the
<a href="#fee-vaults">operator fee vault</a>. This value is exactly <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">opFeeActual</span></span></span></span></span> as described above.</li>
</ol>
<p>Implementations must ensure ETH is neither minted nor destroyed as a result of the operator fee.</p>
<h4 id="transaction-pool-changes"><a class="header" href="#transaction-pool-changes">Transaction Pool Changes</a></h4>
<p>To account for the additional fee factored into transaction validity mentioned above, the transaction pool must reject
transactions that do not have enough balance to cover the worst-case cost of the transaction fee. This worst-case cost
of a transaction now includes the worst-case operator fee.</p>
<h4 id="configuring-operator-fee-parameters"><a class="header" href="#configuring-operator-fee-parameters">Configuring Operator Fee Parameters</a></h4>
<p><code>operatorFeeScalar</code> and <code>operatorFeeConstant</code> are loaded in a similar way to the <code>baseFeeScalar</code> and
<code>blobBaseFeeScalar</code> used in the <a href="../../protocol/exec-engine.html#ecotone-l1-cost-fee-changes-eip-4844-da"><code>L1Fee</code></a>.
calculation. In more detail, these parameters can be accessed in two interchangable ways.</p>
<ul>
<li>read from the deposited L1 attributes (<code>operatorFeeScalar</code> and <code>operatorFeeConstant</code>) of the current L2 block</li>
<li>read from the L1 Block Info contract (<code>0x4200000000000000000000000000000000000015</code>)
<ul>
<li>using the respective solidity getter functions (<code>operatorFeeScalar</code>, <code>operatorFeeConstant</code>)</li>
<li>using direct storage-reads:
<ul>
<li>Operator fee scalar as big-endian <code>uint32</code> in slot <code>8</code> at offset <code>0</code>.</li>
<li>Operator fee constant as big-endian <code>uint64</code> in slot <code>8</code> at offset <code>4</code>.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="fee-vaults"><a class="header" href="#fee-vaults">Fee Vaults</a></h3>
<p>These collected fees are sent to a new vault for the <code>operatorFee</code>: the <a href="predeploys.html#operatorfeevault"><code>OperatorFeeVault</code></a>.</p>
<p>Like the existing vaults, this is a hardcoded address, pointing at a pre-deployed proxy contract.
The proxy is backed by a vault contract deployment, based on <code>FeeVault</code>, to route vault funds to L1 securely.</p>
<h3 id="receipts"><a class="header" href="#receipts">Receipts</a></h3>
<p>After Isthmus activation, 2 new fields <code>operatorFeeScalar</code> and <code>operatorFeeConstant</code> are added to transaction receipts
if and only if at least one of them is non zero.</p>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>Wood, G., &amp; Ethereum Contributors. (n.d.-a). Ethereum Yellow Paper. <a href="https://ethereum.github.io/yellowpaper/paper.pdf">https://ethereum.github.io/yellowpaper/paper.pdf</a> Page 8, section 5: "Gas and Payment"</p>
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../protocol/isthmus/overview.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../protocol/isthmus/derivation.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../protocol/isthmus/overview.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../protocol/isthmus/derivation.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../specs/static/solidity.min.js"></script>
        <script src="../../specs/static/mermaid.min.js"></script>
        <script src="../../specs/static/mermaid-init.js"></script>
        <script src="../../theme/js/footer.js"></script>


    </div>
    </body>
</html>
