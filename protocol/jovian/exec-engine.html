<!DOCTYPE HTML>
<html lang="en" class="ayu sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Execution Engine - OP Stack Specification</title>


        <!-- Custom HTML head -->
        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-YNLKSPKGWN"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag() { dataLayer.push(arguments); }
            gtag('js', new Date());
            gtag('config', 'G-YNLKSPKGWN');
        </script>
        <meta name="google-site-verification" content="1XjEcxxHshd6NM_mxbl_uv-SyamI6_99aOpILYI3_mk" />

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../theme/css/footer.css">


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "ayu";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">OP Stack Specification</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/ethereum-optimism/specs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/ethereum-optimism/specs/edit/main/specs/protocol/jovian/exec-engine.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="jovian-execution-engine"><a class="header" href="#jovian-execution-engine">Jovian: Execution Engine</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="#minimum-base-fee">Minimum Base Fee</a>
<ul>
<li><a href="#minimum-base-fee-in-block-header">Minimum Base Fee in Block Header</a></li>
<li><a href="#minimum-base-fee-in-payloadattributesv3">Minimum Base Fee in <code>PayloadAttributesV3</code></a></li>
<li><a href="#rationale">Rationale</a></li>
</ul>
</li>
<li><a href="#da-footprint-block-limit">DA Footprint Block Limit</a>
<ul>
<li><a href="#scalar-loading">Scalar loading</a></li>
<li><a href="#rationale-1">Rationale</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="minimum-base-fee"><a class="header" href="#minimum-base-fee">Minimum Base Fee</a></h2>
<p>Jovian introduces a
<a href="https://github.com/ethereum-optimism/design-docs/blob/main/protocol/minimum-base-fee.md">configurable minimum base fee</a>
to reduce the duration of priority-fee auctions on OP Stack chains.</p>
<p>The minimum base fee is configured via <code>SystemConfig</code> (see <code>./system-config.md</code>) and enforced by the execution engine
via the block header <code>extraData</code> encoding and the Engine API <code>PayloadAttributesV3</code> parameters.</p>
<h3 id="minimum-base-fee-in-block-header"><a class="header" href="#minimum-base-fee-in-block-header">Minimum Base Fee in Block Header</a></h3>
<p>Like <a href="../holocene/exec-engine.html#dynamic-eip-1559-parameters">Holocene's dynamic EIP-1559 parameters</a>, Jovian encodes
fee parameters in the <code>extraData</code> field of each L2 block header. The format is extended to include an additional
<code>u64</code> field for the minimum base fee in wei.</p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Byte Offset</th></tr></thead><tbody>
<tr><td><code>minBaseFee</code></td><td><code>u64 (big-endian)</code></td><td><code>[9, 17)</code></td></tr>
</tbody></table>
</div>
<p>Constraints:</p>
<ul>
<li><code>version</code> MUST be <code>1</code> (incremented from Holocene's <code>0</code>).</li>
<li>There MUST NOT be any data beyond these 17 bytes.</li>
</ul>
<p>The <code>minBaseFee</code> field is an absolute minimum expressed in wei. During base fee computation, if the
computed <code>baseFee</code> is less than <code>minBaseFee</code>, it MUST be clamped to <code>minBaseFee</code>.</p>
<pre><code class="language-javascript">if (baseFee &lt; minBaseFee) {
  baseFee = minBaseFee
}
</code></pre>
<p>Note: <code>extraData</code> has a maximum capacity of 32 bytes (to fit the L1 beacon-chain <code>extraData</code> type) and may be
extended by future upgrades.</p>
<h3 id="minimum-base-fee-in-payloadattributesv3"><a class="header" href="#minimum-base-fee-in-payloadattributesv3">Minimum Base Fee in <code>PayloadAttributesV3</code></a></h3>
<p>The Engine API <a href="../exec-engine.html#extended-payloadattributesv3"><code>PayloadAttributesV3</code></a> is extended with a new
field <code>minBaseFee</code>. The existing <code>eip1559Params</code> remains 8 bytes (Holocene format).</p>
<pre><code class="language-text">PayloadAttributesV3: {
    timestamp: QUANTITY
    prevRandao: DATA (32 bytes)
    suggestedFeeRecipient: DATA (20 bytes)
    withdrawals: array of WithdrawalV1
    parentBeaconBlockRoot: DATA (32 bytes)
    transactions: array of DATA
    noTxPool: bool
    gasLimit: QUANTITY or null
    eip1559Params: DATA (8 bytes) or null
    minBaseFee: QUANTITY or null
}
</code></pre>
<p>The <code>minBaseFee</code> MUST be <code>null</code> prior to the Jovian fork, and MUST be non-<code>null</code> after the Jovian fork.</p>
<h3 id="rationale"><a class="header" href="#rationale">Rationale</a></h3>
<p>As with <a href="../holocene/exec-engine.html#rationale">Holocene's dynamic EIP-1559 parameters</a>, placing the
minimum base fee in the block header allows us to avoid reaching into the state during block sealing.
This retains the purity of the function that computes the next block's base fee from its parent block
header, while still allowing them to be dynamically configured. Dynamic configuration is handled
similarly to <code>gasLimit</code>, with the derivation pipeline providing the appropriate <code>SystemConfig</code>
contract values to the block builder via <code>PayloadAttributesV3</code> parameters.</p>
<h2 id="da-footprint-block-limit"><a class="header" href="#da-footprint-block-limit">DA Footprint Block Limit</a></h2>
<p>A <em>DA footprint block limit</em> is introduced to limit the total amount of estimated compressed
transaction data that can fit into a block.
For each transaction, a new resource called DA footprint is tracked, next to its gas usage.
It is scaled to the gas dimension so that its block total can also be limited by
the block gas limit, like a block's total gas usage.</p>
<p>Let a block's <code>daFootprint</code> be defined as follows:</p>
<pre><code class="language-python">def daFootprint(block: Block) -&gt; int:
  daFootprint = 0

  for tx in block.transactions:
      if tx.type == DEPOSIT_TX_TYPE:
          continue

      daUsageEstimate = max(
          minTransactionSize,
          (intercept + fastlzCoef * tx.fastlzSize) // 1e6
      )
      daFootprint += daUsageEstimate * daFootprintGasScalar

  return daFootprint 
</code></pre>
<p>where <code>intercept</code>, <code>minTransactionSize</code>, <code>fastlzCoef</code> and <code>fastlzSize</code>
are defined in the <a href="../fjord/exec-engine.html">Fjord specs</a>, <code>DEPOSIT_TX_TYPE</code> is <code>0x7E</code>,
and <code>//</code> represents integer floor division.</p>
<p>From Jovian, the <code>gasUsed</code> property of each block header is equal to the maximum over
that block's <code>daFootprint</code> and the sum of the gas used by each transaction
(the pre-Jovian definition of a block's <code>gasUsed</code> field).
As a result, blocks with high DA usage may cause the base fee to increase in subsequent blocks.</p>
<p>The <code>gasUsed</code> must continue to be less than or equal to the block gas limit, meaning that
(since the <code>daFootprint</code> must also be less than or equal to the block gas limit),
blocks may have no more than <code>gasLimit/daFootprintGasScalar</code> total estimated DA usage.</p>
<p>Note that, since the base fee continues to be updated according to a block's <code>gasUsed</code> field, the base fee may be
directly influenced by DA usage.</p>
<h3 id="scalar-loading"><a class="header" href="#scalar-loading">Scalar loading</a></h3>
<p>The <code>daFootprintGasScalar</code> is loaded in a similar way to the <code>operatorFeeScalar</code> and <code>operatorFeeConstant</code>
<a href="../isthmus/exec-engine.html#operator-fee">included</a> in the Isthmus fork. It can be read in two interchangable ways:</p>
<ul>
<li>read from the deposited L1 attributes (<code>daFootprintGasScalar</code>) of the current L2 block
(decoded according to the <a href="./l1-attributes.html">jovian schema</a>)</li>
<li>read from the L1 Block Info contract (<code>0x4200000000000000000000000000000000000015</code>)
<ul>
<li>using the solidity getter function <code>daFootprintGasScalar</code></li>
<li>using a direct storage-read: big-endian <code>uint16</code> in slot <code>9</code> at offset <code>0</code>.</li>
</ul>
</li>
</ul>
<p>It takes on a default value as described in the section on <a href="./l1-attributes.html">L1 Attributes</a>.</p>
<h3 id="rationale-1"><a class="header" href="#rationale-1">Rationale</a></h3>
<p>While the current L1 fee mechanism charges for DA usage based on an estimate of the DA footprint of a transaction, no
protocol mechanism currently reflects the limited available <em>DA throughput on L1</em>. E.g. on Ethereum L1 with Pectra
enabled, the available blob throughput is <code>~96 kB/s</code> (with a target of <code>~64 kB/s</code>), but the calldata floor gas price of
<code>40</code> for calldata-heavy L2 transactions allows for more incompressible transaction data to be included on most OP Stack
chains than the Ethereum blob space could handle. This is currently mitigated at the policy level by batcher-sequencer
throttling: a mechanism which artificially constricts block building. This can cause base fees to fall, which implies
unnecessary losses for chain operators and a negative user experience (transaction inclusion delays, priority fee
auctions). So hard-limiting a block's DA footprint in a way that also influences the base fee mitigates the
aforementioned problems of policy-based solutions.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../protocol/jovian/overview.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../protocol/jovian/derivation.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../protocol/jovian/overview.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../protocol/jovian/derivation.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../specs/static/solidity.min.js"></script>
        <script src="../../specs/static/mermaid.min.js"></script>
        <script src="../../specs/static/mermaid-init.js"></script>
        <script src="../../theme/js/footer.js"></script>


    </div>
    </body>
</html>
