<!DOCTYPE HTML>
<html lang="en" class="ayu sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>LivenessGuard - OP Stack Specification</title>


        <!-- Custom HTML head -->
        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-YNLKSPKGWN"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag() { dataLayer.push(arguments); }
            gtag('js', new Date());
            gtag('config', 'G-YNLKSPKGWN');
        </script>
        <meta name="google-site-verification" content="1XjEcxxHshd6NM_mxbl_uv-SyamI6_99aOpILYI3_mk" />

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../../theme/css/footer.css">


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "ayu";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">OP Stack Specification</h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/ethereum-optimism/specs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/ethereum-optimism/specs/edit/main/specs/experimental/contracts/safe/liveness-guard.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="livenessguard"><a class="header" href="#livenessguard">LivenessGuard</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#definitions">Definitions</a>
<ul>
<li><a href="#liveness-timestamp">Liveness Timestamp</a></li>
</ul>
</li>
<li><a href="#assumptions">Assumptions</a></li>
<li><a href="#invariants">Invariants</a>
<ul>
<li><a href="#i01-001-liveness-tracking-accuracy">i01-001: Liveness tracking accuracy</a>
<ul>
<li><a href="#impact">Impact</a></li>
</ul>
</li>
<li><a href="#i02-002-liveness-demonstration-capability">i02-002: Liveness demonstration capability</a>
<ul>
<li><a href="#impact-1">Impact</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#function-specification">Function Specification</a>
<ul>
<li><a href="#constructor">constructor</a></li>
<li><a href="#safe">safe</a></li>
<li><a href="#checktransaction">checkTransaction</a></li>
<li><a href="#checkafterexecution">checkAfterExecution</a></li>
<li><a href="#showliveness">showLiveness</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>The LivenessGuard tracks the liveness of Safe multisig owners by recording timestamps when owners sign transactions or
explicitly demonstrate activity. It serves as a monitoring mechanism to identify inactive owners who may have lost
access to their keys.</p>
<h2 id="definitions"><a class="header" href="#definitions">Definitions</a></h2>
<h3 id="liveness-timestamp"><a class="header" href="#liveness-timestamp">Liveness Timestamp</a></h3>
<p>The most recent block timestamp at which an owner either signed a Safe transaction or called the <code>showLiveness</code>
function. This timestamp is publicly queryable via the <code>lastLive</code> mapping.</p>
<h2 id="assumptions"><a class="header" href="#assumptions">Assumptions</a></h2>
<p>N/A</p>
<h2 id="invariants"><a class="header" href="#invariants">Invariants</a></h2>
<h3 id="i01-001-liveness-tracking-accuracy"><a class="header" href="#i01-001-liveness-tracking-accuracy">i01-001: Liveness tracking accuracy</a></h3>
<p>Liveness for each owner is tracked accurately. The <code>lastLive</code> mapping correctly reflects when owners sign transactions
or call <code>showLiveness</code>, and owner additions/removals are properly synchronized with the Safe's owner set.</p>
<h4 id="impact"><a class="header" href="#impact">Impact</a></h4>
<p><strong>Severity: High</strong></p>
<p>If liveness tracking is inaccurate, inactive owners could appear active (preventing their removal) or active owners
could appear inactive (enabling improper removal). This undermines the entire liveness monitoring mechanism and could
lead to unauthorized changes to the Safe's owner set.</p>
<h3 id="i02-002-liveness-demonstration-capability"><a class="header" href="#i02-002-liveness-demonstration-capability">i02-002: Liveness demonstration capability</a></h3>
<p>Owners are always capable of showing liveness if the owner is actually live. The guard never prevents legitimate owners
from demonstrating their liveness through either transaction signatures or direct <code>showLiveness</code> calls.</p>
<h4 id="impact-1"><a class="header" href="#impact-1">Impact</a></h4>
<p><strong>Severity: Critical</strong></p>
<p>If legitimate owners cannot demonstrate liveness, they could be incorrectly identified as inactive and removed from the
Safe. This could lead to loss of access to the Safe's assets and functionality, potentially causing permanent fund
loss if enough owners are incorrectly removed.</p>
<h2 id="function-specification"><a class="header" href="#function-specification">Function Specification</a></h2>
<h3 id="constructor"><a class="header" href="#constructor">constructor</a></h3>
<p>Initializes the LivenessGuard for a specific Safe contract and records all current owners with the deployment
timestamp.</p>
<p><strong>Parameters:</strong></p>
<ul>
<li><code>_safe</code>: The Safe contract instance that this guard will monitor</li>
</ul>
<p><strong>Behavior:</strong></p>
<ul>
<li>MUST set the immutable <code>SAFE</code> reference to the provided Safe contract</li>
<li>MUST query the Safe's current owner list via <code>getOwners()</code></li>
<li>MUST set <code>lastLive[owner]</code> to <code>block.timestamp</code> for each current owner</li>
<li>MUST emit <code>OwnerRecorded</code> event for each current owner</li>
</ul>
<h3 id="safe"><a class="header" href="#safe">safe</a></h3>
<p>Returns the Safe contract instance that this guard monitors.</p>
<p><strong>Behavior:</strong></p>
<ul>
<li>MUST return the immutable <code>SAFE</code> contract reference</li>
</ul>
<h3 id="checktransaction"><a class="header" href="#checktransaction">checkTransaction</a></h3>
<p>Records liveness for owners who signed the current transaction. Called by the Safe before transaction execution.</p>
<p><strong>Parameters:</strong></p>
<ul>
<li><code>_to</code>: Transaction target address</li>
<li><code>_value</code>: ETH value to send</li>
<li><code>_data</code>: Transaction calldata</li>
<li><code>_operation</code>: Operation type (Call or DelegateCall)</li>
<li><code>_safeTxGas</code>: Gas allocated for Safe transaction execution</li>
<li><code>_baseGas</code>: Gas costs independent of transaction execution</li>
<li><code>_gasPrice</code>: Gas price for refund calculation</li>
<li><code>_gasToken</code>: Token address for gas payment (zero address for ETH)</li>
<li><code>_refundReceiver</code>: Address receiving gas refund</li>
<li><code>_signatures</code>: Packed signature data from Safe owners</li>
<li><code>_msgSender</code>: Original transaction sender</li>
</ul>
<p><strong>Behavior:</strong></p>
<ul>
<li>MUST revert if caller is not the associated Safe contract</li>
<li>MUST cache the current Safe owner list for comparison after transaction execution</li>
<li>MUST reconstruct the transaction hash using Safe's <code>getTransactionHash()</code> with nonce decremented by 1</li>
<li>MUST extract exactly <code>threshold</code> number of signers from <code>_signatures</code> using <code>SafeSigners.getNSigners()</code></li>
<li>MUST set <code>lastLive[signer]</code> to <code>block.timestamp</code> for each extracted signer</li>
<li>MUST emit <code>OwnerRecorded</code> event for each signer</li>
<li>MUST NOT revert due to signature parsing or owner extraction failures</li>
</ul>
<h3 id="checkafterexecution"><a class="header" href="#checkafterexecution">checkAfterExecution</a></h3>
<p>Updates the <code>lastLive</code> mapping to reflect any changes in the Safe's owner set. Called by the Safe after transaction
execution.</p>
<p><strong>Parameters:</strong></p>
<ul>
<li>First parameter (unnamed): Transaction hash (unused)</li>
<li>Second parameter (unnamed): Transaction success status (unused)</li>
</ul>
<p><strong>Behavior:</strong></p>
<ul>
<li>MUST revert if caller is not the associated Safe contract</li>
<li>MUST query the current Safe owner list via <code>getOwners()</code></li>
<li>MUST process each current owner:
<ul>
<li>If owner existed before transaction execution, mark as processed</li>
<li>If owner did not exist before transaction execution, set <code>lastLive[owner]</code> to <code>block.timestamp</code> (new owner added)</li>
</ul>
</li>
<li>MUST process each owner that existed before but not after transaction execution:
<ul>
<li>Delete <code>lastLive[owner]</code> entry (owner was removed from Safe)</li>
</ul>
</li>
<li>MUST ensure internal owner tracking state is completely cleared after execution</li>
<li>MUST NOT revert due to owner set changes or state inconsistencies</li>
</ul>
<h3 id="showliveness"><a class="header" href="#showliveness">showLiveness</a></h3>
<p>Allows a Safe owner to directly demonstrate liveness without signing a transaction.</p>
<p><strong>Behavior:</strong></p>
<ul>
<li>MUST revert if caller is not a current owner of the Safe (verified via <code>SAFE.isOwner()</code>)</li>
<li>MUST set <code>lastLive[msg.sender]</code> to <code>block.timestamp</code></li>
<li>MUST emit <code>OwnerRecorded</code> event with <code>msg.sender</code> as the owner</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../experimental/gov-token.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../../glossary.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../experimental/gov-token.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../../glossary.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../elasticlunr.min.js"></script>
        <script src="../../../mark.min.js"></script>
        <script src="../../../searcher.js"></script>

        <script src="../../../clipboard.min.js"></script>
        <script src="../../../highlight.js"></script>
        <script src="../../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../../specs/static/solidity.min.js"></script>
        <script src="../../../specs/static/mermaid.min.js"></script>
        <script src="../../../specs/static/mermaid-init.js"></script>
        <script src="../../../theme/js/footer.js"></script>


    </div>
    </body>
</html>
