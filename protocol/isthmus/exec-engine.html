<!DOCTYPE HTML>
<html lang="en" class="ayu sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Execution Engine - OP Stack Specification</title>


        <!-- Custom HTML head -->
        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-YNLKSPKGWN"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag() { dataLayer.push(arguments); }
            gtag('js', new Date());
            gtag('config', 'G-YNLKSPKGWN');
        </script>
        <meta name="google-site-verification" content="1XjEcxxHshd6NM_mxbl_uv-SyamI6_99aOpILYI3_mk" />

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <div class="sidebar-scrollbox"></div>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <script async src="../../toc.js"></script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">OP Stack Specification</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/ethereum-optimism/specs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/ethereum-optimism/specs/edit/main/specs/protocol/isthmus/exec-engine.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="l2-execution-engine"><a class="header" href="#l2-execution-engine">L2 Execution Engine</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#timestamp-activation">Timestamp Activation</a></li>
<li><a href="#l2tol1messagepasser-storage-root-in-header"><code>L2ToL1MessagePasser</code> Storage Root in Header</a>
<ul>
<li><a href="#header-validity-rules">Header Validity Rules</a></li>
<li><a href="#header-withdrawals-root">Header Withdrawals Root</a>
<ul>
<li><a href="#rationale">Rationale</a></li>
<li><a href="#genesis-block">Genesis Block</a></li>
<li><a href="#state-processing">State Processing</a></li>
<li><a href="#p2p">P2P</a></li>
<li><a href="#backwards-compatibility-considerations">Backwards Compatibility Considerations</a></li>
<li><a href="#forwards-compatibility-considerations">Forwards Compatibility Considerations</a></li>
<li><a href="#client-implementation-considerations">Client Implementation Considerations</a>
<ul>
<li><a href="#transaction-simulation">Transaction Simulation</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#block-body-withdrawals-list">Block Body Withdrawals List</a></li>
<li><a href="#engine-api-updates">Engine API Updates</a>
<ul>
<li><a href="#update-to-executabledata">Update to <code>ExecutableData</code></a></li>
<li><a href="#engine_newpayloadv3-api"><code>engine_newPayloadV3</code> API</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<!-- All glossary references in this file. -->
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>The storage root of the <code>L2ToL1MessagePasser</code> is included in the block header's
<code>withdrawalRoot</code> field.</p>
<h2 id="timestamp-activation"><a class="header" href="#timestamp-activation">Timestamp Activation</a></h2>
<p>Isthmus, like other network upgrades, is activated at a timestamp.
Changes to the L2 Block execution rules are applied when the <code>L2 Timestamp &gt;= activation time</code>.</p>
<h2 id="l2tol1messagepasser-storage-root-in-header"><a class="header" href="#l2tol1messagepasser-storage-root-in-header"><code>L2ToL1MessagePasser</code> Storage Root in Header</a></h2>
<p>After Isthmus hardfork's activation, the L2 block header's <code>withdrawalsRoot</code> field will consist of the 32-byte
<a href="../../protocol/predeploys.html#L2ToL1MessagePasser"><code>L2ToL1MessagePasser</code></a> account storage root from the world state identified by the stateRoot
field in the block header. The storage root should be the same root that is returned by <code>eth_getProof</code>
at the given block number.</p>
<h3 id="header-validity-rules"><a class="header" href="#header-validity-rules">Header Validity Rules</a></h3>
<p>Prior to isthmus activation, the L2 block header's <code>withdrawalsRoot</code> field must be:</p>
<ul>
<li><code>nil</code> if Canyon has not been activated.</li>
<li><code>keccak256(rlp(empty_string_code))</code> if Canyon has been activated.</li>
</ul>
<p>After Isthmus activation, an L2 block header's <code>withdrawalsRoot</code> field is valid iff:</p>
<ol>
<li>It is exactly 32 bytes in length.</li>
<li>The <a href="../../protocol/predeploys.html#L2ToL1MessagePasser"><code>L2ToL1MessagePasser</code></a> account storage root, as committed to in the <code>storageRoot</code> within the block
header, is equal to the header's <code>withdrawalsRoot</code> field.</li>
</ol>
<h3 id="header-withdrawals-root"><a class="header" href="#header-withdrawals-root">Header Withdrawals Root</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Byte offset</th><th>Description</th></tr></thead><tbody>
<tr><td><code>[0, 32)</code></td><td><a href="../../protocol/predeploys.html#L2ToL1MessagePasser"><code>L2ToL1MessagePasser</code></a> account storage root</td></tr>
</tbody></table>
</div>
<h4 id="rationale"><a class="header" href="#rationale">Rationale</a></h4>
<p>Currently, to generate <a href="../../glossary.html#l2-output-root">L2 output roots</a> for historical blocks, an archival node is required. This directly
places a burden on users of the system in a post-fault-proofs world, where:</p>
<ol>
<li>A proposer must have an archive node to propose an output root at the safe head.</li>
<li>A user that is proving their withdrawal must have an archive node to verify that the output root they are proving
their withdrawal against is indeed valid and included within the safe chain.</li>
</ol>
<p>Placing the <a href="../../protocol/predeploys.html#L2ToL1MessagePasser"><code>L2ToL1MessagePasser</code></a> account storage root in the <code>withdrawalsRoot</code> field alleviates this burden
for users and protocol participants alike, allowing them to propose and verify other proposals with lower operating costs.</p>
<h4 id="genesis-block"><a class="header" href="#genesis-block">Genesis Block</a></h4>
<p>If Isthmus is active at genesis block, the <code>withdrawalsRoot</code> in the genesis block header is set to the
<a href="../../protocol/predeploys.html#L2ToL1MessagePasser"><code>L2ToL1MessagePasser</code></a> account storage root.</p>
<h4 id="state-processing"><a class="header" href="#state-processing">State Processing</a></h4>
<p>At the time of state processing, the header for which transactions are being validated should not make it's <code>withdrawalsRoot</code>
available to the EVM/application layer.</p>
<h4 id="p2p"><a class="header" href="#p2p">P2P</a></h4>
<p>During sync, we expect the withdrawals list in the block body to be empty (OP stack does not make
use of the withdrawals list) and hence the hash of the withdrawals list to be the MPT root of an empty list.
When verifying the header chain using the final header that is synced, the header timesetamp is used to
determine whether Isthmus is active at the said block. If it is, we expect that the header <code>withdrawalsRoot</code>
MPT hash can be any non-null value (since it is expected to contain the <code>L2ToL1MessagePasser</code>'s storage root).</p>
<h4 id="backwards-compatibility-considerations"><a class="header" href="#backwards-compatibility-considerations">Backwards Compatibility Considerations</a></h4>
<p>Beginning at Canyon (which includes Shanghai hardfork support) and prior to Isthmus activation,
the <code>withdrawalsRoot</code> field is set to the MPT root of an empty withdrawals list. This is the
same root as an empty storage root. The withdrawals are captured in the L2 state, however
they are not reflected in the <code>withdrawalsRoot</code>. Hence, prior to Isthmus activation,
even if a <code>withdrawalsRoot</code> is present and a MPT root is present in the header, it should not be used.
Any implementation that calculates output root should be careful not to use the header <code>withdrawalsRoot</code>.</p>
<p>After Isthmus activation, if there was never any withdrawal contract storage, a MPT root of an empty list
can be set as the <code>withdrawalsRoot</code></p>
<h4 id="forwards-compatibility-considerations"><a class="header" href="#forwards-compatibility-considerations">Forwards Compatibility Considerations</a></h4>
<p>As it stands, the <code>withdrawalsRoot</code> field is unused within the OP Stack's header consensus format, and will never be
used for other reasons that are currently planned. Setting this value to the account storage root of the withdrawal
directly fits with the OP Stack, and makes use of the existing field in the L1 header consensus format.</p>
<h4 id="client-implementation-considerations"><a class="header" href="#client-implementation-considerations">Client Implementation Considerations</a></h4>
<p>Varous EL clients store historical state of accounts differently. If, as a contrived case, an OP Stack chain did not have
an outbound withdrawal for a long period of time, the node may not have access to the account storage root of the
<a href="../../protocol/predeploys.html#L2ToL1MessagePasser"><code>L2ToL1MessagePasser</code></a>. In this case, the client would be unable to keep consensus. However, most modern
clients are able to at the very least reconstruct the account storage root at a given block on the fly if it does not
directly store this information.</p>
<h5 id="transaction-simulation"><a class="header" href="#transaction-simulation">Transaction Simulation</a></h5>
<p>In response to RPC methods like <code>eth_simulateV1</code> that allow simulation of arbitrary transactions within one or more blocks,
an empty withdrawals root should be included in the header of a block that consists of such simulated transactions. The same
is applicable for scenarios where the actual withdrawals root value is not readily available.</p>
<h2 id="block-body-withdrawals-list"><a class="header" href="#block-body-withdrawals-list">Block Body Withdrawals List</a></h2>
<p>Withdrawals list in the block body is encoded as an empty RLP list.</p>
<h2 id="engine-api-updates"><a class="header" href="#engine-api-updates">Engine API Updates</a></h2>
<h3 id="update-to-executabledata"><a class="header" href="#update-to-executabledata">Update to <code>ExecutableData</code></a></h3>
<p><code>ExecutableData</code> will contain an extra field for <code>withdrawalsRoot</code> after Isthmus hard fork.</p>
<h3 id="engine_newpayloadv3-api"><a class="header" href="#engine_newpayloadv3-api"><code>engine_newPayloadV3</code> API</a></h3>
<p>Post Isthmus, <code>engine_newPayloadV3</code> will be used with the additional <code>ExecutionPayload</code> attribute. This attribute
is omitted prior to Isthmus.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../protocol/isthmus/overview.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../protocol/isthmus/superchain-config.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../protocol/isthmus/overview.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../protocol/isthmus/superchain-config.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../specs/static/solidity.min.js"></script>
        <script src="../../specs/static/mermaid.min.js"></script>
        <script src="../../specs/static/mermaid-init.js"></script>


    </div>
    </body>
</html>
