<!DOCTYPE HTML>
<html lang="en" class="ayu" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Multithreaded Cannon FPVM - OP Stack Specification</title>


        <!-- Custom HTML head -->
        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-YNLKSPKGWN"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag() { dataLayer.push(arguments); }
            gtag('js', new Date());
            gtag('config', 'G-YNLKSPKGWN');
        </script>
        <meta name="google-site-verification" content="1XjEcxxHshd6NM_mxbl_uv-SyamI6_99aOpILYI3_mk" />

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('ayu')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../root.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../background.html"><strong aria-hidden="true">2.</strong> Background</a></li><li class="chapter-item expanded "><a href="../protocol/overview.html"><strong aria-hidden="true">3.</strong> OP Stack Protocol</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../protocol/bridges.html"><strong aria-hidden="true">3.1.</strong> Bridges</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../protocol/messengers.html"><strong aria-hidden="true">3.1.1.</strong> Messengers</a></li><li class="chapter-item expanded "><a href="../protocol/deposits.html"><strong aria-hidden="true">3.1.2.</strong> Deposits</a></li><li class="chapter-item expanded "><a href="../protocol/withdrawals.html"><strong aria-hidden="true">3.1.3.</strong> Withdrawals</a></li><li class="chapter-item expanded "><a href="../protocol/guaranteed-gas-market.html"><strong aria-hidden="true">3.1.4.</strong> Guaranteed Gas Market</a></li><li class="chapter-item expanded "><a href="../protocol/proposals.html"><strong aria-hidden="true">3.1.5.</strong> Proposals</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.2.</strong> Clients</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../protocol/exec-engine.html"><strong aria-hidden="true">3.2.1.</strong> Execution Engine</a></li><li class="chapter-item expanded "><a href="../protocol/rollup-node.html"><strong aria-hidden="true">3.2.2.</strong> Rollup Node</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../protocol/rollup-node-p2p.html"><strong aria-hidden="true">3.2.2.1.</strong> Rollup Node P2P</a></li><li class="chapter-item expanded "><a href="../protocol/derivation.html"><strong aria-hidden="true">3.2.2.2.</strong> Derivation</a></li></ol></li><li class="chapter-item expanded "><a href="../protocol/batcher.html"><strong aria-hidden="true">3.2.3.</strong> Batch Submitter</a></li></ol></li><li class="chapter-item expanded "><a href="../fault-proof/index.html"><strong aria-hidden="true">3.3.</strong> Fault Proof</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../fault-proof/cannon-fault-proof-vm.html"><strong aria-hidden="true">3.3.1.</strong> Cannon Fault Proof VM</a></li><li class="chapter-item expanded "><a href="../fault-proof/stage-one/index.html"><strong aria-hidden="true">3.3.2.</strong> Stage One Decentralization</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../fault-proof/stage-one/dispute-game-interface.html"><strong aria-hidden="true">3.3.2.1.</strong> Dispute Game Interface</a></li><li class="chapter-item expanded "><a href="../fault-proof/stage-one/fault-dispute-game.html"><strong aria-hidden="true">3.3.2.2.</strong> Fault Dispute Game</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../fault-proof/stage-one/honest-challenger-fdg.html"><strong aria-hidden="true">3.3.2.2.1.</strong> Honest Challenger</a></li><li class="chapter-item expanded "><a href="../fault-proof/stage-one/bond-incentives.html"><strong aria-hidden="true">3.3.2.2.2.</strong> Bond Incentives</a></li></ol></li><li class="chapter-item expanded "><a href="../fault-proof/stage-one/bridge-integration.html"><strong aria-hidden="true">3.3.2.3.</strong> Bridge Integration</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../protocol/precompiles.html"><strong aria-hidden="true">3.4.</strong> Precompiles</a></li><li class="chapter-item expanded "><a href="../protocol/predeploys.html"><strong aria-hidden="true">3.5.</strong> Predeploys</a></li><li class="chapter-item expanded "><a href="../protocol/preinstalls.html"><strong aria-hidden="true">3.6.</strong> Preinstalls</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.7.</strong> Superchain</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../protocol/superchain-configuration.html"><strong aria-hidden="true">3.7.1.</strong> Superchain Configuration</a></li><li class="chapter-item expanded "><a href="../protocol/superchain-upgrades.html"><strong aria-hidden="true">3.7.2.</strong> Superchain Upgrades</a></li></ol></li><li class="chapter-item expanded "><a href="../protocol/system-config.html"><strong aria-hidden="true">3.8.</strong> System Config</a></li><li class="chapter-item expanded "><a href="../protocol/configurability.html"><strong aria-hidden="true">3.9.</strong> Configurability</a></li><li class="chapter-item expanded "><a href="../protocol/safe-extensions.html"><strong aria-hidden="true">3.10.</strong> Safe Extensions</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../protocol/stage-1.html"><strong aria-hidden="true">3.10.1.</strong> Stage 1 Roles and Requirements</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.11.</strong> Protocol Upgrades</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../protocol/regolith/overview.html"><strong aria-hidden="true">3.11.1.</strong> Regolith</a></li><li class="chapter-item expanded "><a href="../protocol/canyon/overview.html"><strong aria-hidden="true">3.11.2.</strong> Canyon</a></li><li class="chapter-item expanded "><a href="../protocol/delta/overview.html"><strong aria-hidden="true">3.11.3.</strong> Delta</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../protocol/delta/span-batches.html"><strong aria-hidden="true">3.11.3.1.</strong> Span Batches</a></li></ol></li><li class="chapter-item expanded "><a href="../protocol/ecotone/overview.html"><strong aria-hidden="true">3.11.4.</strong> Ecotone</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../protocol/ecotone/derivation.html"><strong aria-hidden="true">3.11.4.1.</strong> Derivation</a></li><li class="chapter-item expanded "><a href="../protocol/ecotone/l1-attributes.html"><strong aria-hidden="true">3.11.4.2.</strong> L1 attributes</a></li></ol></li><li class="chapter-item expanded "><a href="../protocol/fjord/overview.html"><strong aria-hidden="true">3.11.5.</strong> Fjord</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../protocol/fjord/exec-engine.html"><strong aria-hidden="true">3.11.5.1.</strong> Execution Engine</a></li><li class="chapter-item expanded "><a href="../protocol/fjord/derivation.html"><strong aria-hidden="true">3.11.5.2.</strong> Derivation</a></li><li class="chapter-item expanded "><a href="../protocol/fjord/predeploys.html"><strong aria-hidden="true">3.11.5.3.</strong> Predeploys</a></li></ol></li><li class="chapter-item expanded "><a href="../protocol/granite/overview.html"><strong aria-hidden="true">3.11.6.</strong> Granite</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../protocol/granite/exec-engine.html"><strong aria-hidden="true">3.11.6.1.</strong> Execution Engine</a></li><li class="chapter-item expanded "><a href="../protocol/granite/derivation.html"><strong aria-hidden="true">3.11.6.2.</strong> Derivation</a></li></ol></li><li class="chapter-item expanded "><a href="../protocol/holocene/overview.html"><strong aria-hidden="true">3.11.7.</strong> Holocene</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../protocol/holocene/derivation.html"><strong aria-hidden="true">3.11.7.1.</strong> Derivation</a></li><li class="chapter-item expanded "><a href="../protocol/holocene/exec-engine.html"><strong aria-hidden="true">3.11.7.2.</strong> Execution Engine</a></li><li class="chapter-item expanded "><a href="../protocol/holocene/system-config.html"><strong aria-hidden="true">3.11.7.3.</strong> System Config</a></li></ol></li><li class="chapter-item expanded "><a href="../protocol/isthmus/overview.html"><strong aria-hidden="true">3.11.8.</strong> Isthmus</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../protocol/isthmus/exec-engine.html"><strong aria-hidden="true">3.11.8.1.</strong> Execution Engine</a></li><li class="chapter-item expanded "><a href="../protocol/isthmus/superchain-config.html"><strong aria-hidden="true">3.11.8.2.</strong> Superchain Config</a></li></ol></li></ol></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> Governance</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../governance/gov-token.html"><strong aria-hidden="true">4.1.</strong> Governance Token</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> Experimental</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../experimental/custom-gas-token.html"><strong aria-hidden="true">5.1.</strong> Custom Gas Token</a></li><li class="chapter-item expanded "><a href="../experimental/alt-da.html"><strong aria-hidden="true">5.2.</strong> Alt-DA</a></li><li class="chapter-item expanded "><a href="../interop/overview.html"><strong aria-hidden="true">5.3.</strong> Interoperability</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../interop/dependency-set.html"><strong aria-hidden="true">5.3.1.</strong> Dependency Set</a></li><li class="chapter-item expanded "><a href="../interop/messaging.html"><strong aria-hidden="true">5.3.2.</strong> Messaging</a></li><li class="chapter-item expanded "><a href="../interop/predeploys.html"><strong aria-hidden="true">5.3.3.</strong> Predeploys</a></li><li class="chapter-item expanded "><a href="../interop/sequencer.html"><strong aria-hidden="true">5.3.4.</strong> Sequencer</a></li><li class="chapter-item expanded "><a href="../interop/verifier.html"><strong aria-hidden="true">5.3.5.</strong> Verifier</a></li><li class="chapter-item expanded "><a href="../interop/rollup-node-p2p.html"><strong aria-hidden="true">5.3.6.</strong> Rollup Node P2P</a></li><li class="chapter-item expanded "><a href="../interop/fault-proof.html"><strong aria-hidden="true">5.3.7.</strong> Fault Proof</a></li><li class="chapter-item expanded "><a href="../interop/upgrade.html"><strong aria-hidden="true">5.3.8.</strong> Upgrade</a></li><li class="chapter-item expanded "><a href="../interop/token-bridging.html"><strong aria-hidden="true">5.3.9.</strong> Token Bridging</a></li><li class="chapter-item expanded "><a href="../interop/superchain-weth.html"><strong aria-hidden="true">5.3.10.</strong> SuperchainWETH</a></li><li class="chapter-item expanded "><a href="../interop/derivation.html"><strong aria-hidden="true">5.3.11.</strong> Derivation</a></li><li class="chapter-item expanded "><a href="../interop/tx-pool.html"><strong aria-hidden="true">5.3.12.</strong> Transaction Pool</a></li></ol></li><li class="chapter-item expanded "><a href="../experimental/op-contracts-manager.html"><strong aria-hidden="true">5.4.</strong> OP Contracts Manager</a></li><li class="chapter-item expanded "><a href="../experimental/gov-token.html"><strong aria-hidden="true">5.5.</strong> Governance Token</a></li><li class="chapter-item expanded "><a href="../experimental/cannon-fault-proof-vm-mt.html" class="active"><strong aria-hidden="true">5.6.</strong> Multithreaded Cannon FPVM</a></li></ol></li><li class="chapter-item expanded "><a href="../glossary.html"><strong aria-hidden="true">6.</strong> Glossary</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">OP Stack Specification</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/ethereum-optimism/specs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/ethereum-optimism/specs/edit/main/specs/experimental/cannon-fault-proof-vm-mt.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="multithreaded-cannon-fault-proof-virtual-machine"><a class="header" href="#multithreaded-cannon-fault-proof-virtual-machine">Multithreaded Cannon Fault Proof Virtual Machine</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="#overview">Overview</a>
<ul>
<li><a href="#definitions">Definitions</a>
<ul>
<li><a href="#concepts">Concepts</a>
<ul>
<li><a href="#natural-alignment">Natural Alignment</a></li>
</ul>
</li>
<li><a href="#data-types">Data types</a></li>
<li><a href="#constants">Constants</a></li>
</ul>
</li>
<li><a href="#new-features">New Features</a>
<ul>
<li><a href="#multithreading">Multithreading</a></li>
<li><a href="#64-bit-architecture">64-bit Architecture</a></li>
<li><a href="#robustness">Robustness</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#multithreading-1">Multithreading</a>
<ul>
<li><a href="#thread-management">Thread Management</a></li>
<li><a href="#thread-traversal-mechanics">Thread Traversal Mechanics</a>
<ul>
<li><a href="#thread-preemption">Thread Preemption</a></li>
</ul>
</li>
<li><a href="#wakeup-traversal">Wakeup Traversal</a></li>
<li><a href="#exited-threads">Exited Threads</a></li>
<li><a href="#waiting-threads">Waiting Threads</a></li>
<li><a href="#voluntary-preemption">Voluntary Preemption</a></li>
<li><a href="#forced-preemption">Forced Preemption</a></li>
</ul>
</li>
<li><a href="#stateful-instructions">Stateful Instructions</a>
<ul>
<li><a href="#load-linked--store-conditional-word">Load Linked / Store Conditional Word</a></li>
<li><a href="#load-linked--store-conditional-doubleword">Load Linked / Store Conditional Doubleword</a></li>
</ul>
</li>
<li><a href="#fpvm-state">FPVM State</a>
<ul>
<li><a href="#state">State</a></li>
<li><a href="#state-hash">State Hash</a></li>
<li><a href="#thread-state">Thread State</a></li>
<li><a href="#thread-hash">Thread Hash</a></li>
<li><a href="#thread-stack-hashing">Thread Stack Hashing</a></li>
</ul>
</li>
<li><a href="#memory">Memory</a>
<ul>
<li><a href="#heap">Heap</a></li>
</ul>
</li>
<li><a href="#delay-slots">Delay Slots</a></li>
<li><a href="#syscalls">Syscalls</a>
<ul>
<li><a href="#supported-syscalls">Supported Syscalls</a></li>
<li><a href="#noop-syscalls">Noop Syscalls</a></li>
</ul>
</li>
<li><a href="#io">I/O</a>
<ul>
<li><a href="#standard-streams">Standard Streams</a></li>
<li><a href="#hint-communication">Hint Communication</a></li>
<li><a href="#pre-image-communication">Pre-image Communication</a>
<ul>
<li><a href="#pre-image-io-alignment">Pre-image I/O Alignment</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#exceptions">Exceptions</a></li>
<li><a href="#security-model">Security Model</a>
<ul>
<li><a href="#compiler-correctness">Compiler Correctness</a></li>
<li><a href="#compiler-assumptions">Compiler Assumptions</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>This is a description of the second iteration of the Cannon Fault Proof Virtual Machine (FPVM).
When necessary to distinguish this version from the initial implementation,
it can be referred to as Multithreaded Cannon (MTCannon). Similarly,
the original Cannon implementation can be referred to as Singlethreaded Cannon (STCannon) where necessary for clarity.</p>
<p>The MTCannon FPVM emulates a minimal uniprocessor Linux-based system running on big-endian 64-bit MIPS64 architecture.
A lot of its behaviors are copied from Linux/MIPS with a few tweaks made for fault proofs.
For the rest of this doc, we refer to the MTCannon FPVM as simply the FPVM.</p>
<p>Operationally, the FPVM is a state transition function. This state transition is referred to as a <em>Step</em>,
that executes a single instruction. We say the VM is a function <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span>, given an input state <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">re</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>, steps on a
single instruction encoded in the state to produce a new state <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">os</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>.
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">re</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">os</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p>Thus, the trace of a program executed by the FPVM is an ordered set of VM states.</p>
<h3 id="definitions"><a class="header" href="#definitions">Definitions</a></h3>
<h4 id="concepts"><a class="header" href="#concepts">Concepts</a></h4>
<h5 id="natural-alignment"><a class="header" href="#natural-alignment">Natural Alignment</a></h5>
<p>A memory address is said to be "naturally aligned" in the context of some data type
if it is a multiple of that data type's byte size.
For example, the address of a 32-bit (4-byte) value is naturally aligned if it is a multiple of 4 (e.g. <code>0x1000</code>, <code>0x1004</code>).
Similarly, the address of a 64-bit (8-byte) value is naturally aligned if it is a multiple of 8 (e.g. <code>0x1000</code>, <code>0x1008</code>).</p>
<p>A non-aligned address can be naturally aligned by dropping the least significant bits of the address:
<code>aligned = unaligned &amp; ^(byteSize - 1)</code>.
For example, to align the address <code>0x1002</code> targeting a 32-bit value:
<code>aligned = 0x1002 &amp; ^(0x3) = 0x1000</code>.</p>
<h4 id="data-types"><a class="header" href="#data-types">Data types</a></h4>
<ul>
<li><code>Boolean</code> - An 8-bit boolean value equal to 0 (false) or 1 (true).</li>
<li><code>Hash</code> - A 256-bit fixed-size value produced by the Keccak-256 cryptographic hash function.</li>
<li><code>UInt8</code> - An 8-bit unsigned integer value.</li>
<li><code>UInt64</code> - A 64-bit unsigned integer value.</li>
<li><code>Word</code> - A 64-bit value.</li>
</ul>
<h4 id="constants"><a class="header" href="#constants">Constants</a></h4>
<ul>
<li><code>EBADF</code> - A Linux error number indicating a bad file descriptor: <code>0x9</code>.</li>
<li><code>MaxWord</code> - A <code>Word</code> with all bits set to 1: <code>0xFFFFFFFFFFFFFFFF</code>.
When interpreted as a signed value, this is equivalent to -1.</li>
<li><code>ProgramBreakAddress</code> - The fixed memory address for the program break: <code>Word(0x0000_4000_0000_0000)</code>.</li>
<li><code>WordSize</code> - The number of bytes in a <code>Word</code> (8).</li>
</ul>
<h3 id="new-features"><a class="header" href="#new-features">New Features</a></h3>
<h4 id="multithreading"><a class="header" href="#multithreading">Multithreading</a></h4>
<p>MTCannon adds support for <a href="https://en.wikipedia.org/wiki/Thread_(computing)">multithreading</a>.
Thread management and scheduling are typically handled by the
<a href="https://en.wikipedia.org/wiki/Kernel_%28operating_system%29">operating system (OS) kernel</a>:
programs make thread-related requests to the OS kernel via <a href="https://en.wikipedia.org/wiki/System_call">syscalls</a>.
As such, this implementation includes a few new Linux-specific thread-related <a href="#syscalls">syscalls</a>.
Additionally, the <a href="#fpvm-state">FPVM state</a> has been modified in order to track the set of active threads
and thread-related global state.</p>
<h4 id="64-bit-architecture"><a class="header" href="#64-bit-architecture">64-bit Architecture</a></h4>
<p>MTCannon emulates a MIPS64 machine whereas STCannon emulates a MIPS32 machine.  The transition from MIPS32 to MIPS64
means the address space goes from 32-bit to 64-bit, greatly expanding addressable memory.</p>
<h4 id="robustness"><a class="header" href="#robustness">Robustness</a></h4>
<p>In the initial implementation of Cannon, unrecognized syscalls were treated as
noops (see <a href="#noop-syscalls">"Noop Syscalls"</a>). To ensure no unexpected behaviors are triggered,
MTCannon will now raise an exception if unrecognized syscalls are encountered during program execution.</p>
<h2 id="multithreading-1"><a class="header" href="#multithreading-1">Multithreading</a></h2>
<p>The MTCannon FPVM rotates between threads to provide
<a href="https://en.wikipedia.org/wiki/Computer_multitasking">multitasking</a> rather than
true <a href="https://en.wikipedia.org/wiki/Parallel_computing">parallel processing</a>.
The VM state holds an ordered set of thread state objects representing all executing threads.</p>
<p>On any given step, there is one active thread that will be processed.</p>
<h3 id="thread-management"><a class="header" href="#thread-management">Thread Management</a></h3>
<p>The FPVM state contains two thread stacks that are used to represent the set of all threads: <code>leftThreadStack</code> and
<code>rightThreadStack</code>. An additional boolean value (<code>traverseRight</code>) determines which stack contains the currently active
thread and how threads are rearranged when the active thread is preempted (see <a href="#thread-preemption">"Thread Preemption"</a>
for details).</p>
<p>When traversing right, the thread on the top of the right stack is the active thread, the right stack is referred to as
the "active" stack,
and the left the "inactive" stack.  Conversely, when traversing left, the active thread is on top of the left stack,
the left stack is "active", and the right is "inactive".</p>
<p>Representing the set of threads as two stacks allows for a succinct commitment to the contents of all threads.
For details, see <a href="#thread-stack-hashing">“Thread Stack Hashing”</a>.</p>
<h3 id="thread-traversal-mechanics"><a class="header" href="#thread-traversal-mechanics">Thread Traversal Mechanics</a></h3>
<p>Threads are traversed deterministically by moving from the first thread to the last thread,
then from the last thread to the first thread repeatedly.  For example, given the set of threads: {0,1,2,3},
the FPVM would traverse to each as follows: 0, 1, 2, 3, 3, 2, 1, 0, 0, 1, 2, 3, 3, 2, ….</p>
<h4 id="thread-preemption"><a class="header" href="#thread-preemption">Thread Preemption</a></h4>
<p>Threads are traversed via "preemption": the currently active thread is popped from the active stack and pushed to the
inactive stack.  If the active stack is empty, the FPVM state's <code>traverseRight</code> field is flipped ensuring that
there is always an active thread.</p>
<h3 id="wakeup-traversal"><a class="header" href="#wakeup-traversal">Wakeup Traversal</a></h3>
<p>When a futex wake syscall is made, the FPVM state’s <code>wakeup</code> field is set to the memory address specified by this
syscall.  This causes the FPVM to enter a "wakeup traversal" mode where it iterates
through the existing threads, looking for a thread that is currently waiting on the <code>wakeup</code> address.
The wakeup traversal will continue until such a thread is found or else all threads have been checked.
During wakeup traversal, no instructions are processed and no threads are updated, the VM simply steps through threads
one at a time until wakeup traversal completes.</p>
<p>Wakeup traversal proceeds as follows across multiple steps:</p>
<ul>
<li>When a futex wakeup syscall is made:
<ul>
<li>The state's <code>wakeup</code> field is set to an address specified by the syscall.</li>
<li>The currently active thread is preempted.</li>
<li>The FPVM state is set to traverse left, if possible (if the left thread stack is non-empty).</li>
</ul>
</li>
<li>On each subsequent step while <code>wakeup</code> is set:
<ul>
<li>The currently active thread's <code>futexAddr</code> is checked for a match with <code>wakeup</code>.</li>
<li>If a match is found:
<ul>
<li>The wakeup traversal completes <sup class="footnote-reference"><a href="#traversal-completion">1</a></sup>, leaving the matching thread as the currently active thread.</li>
</ul>
</li>
<li>If the currently active thread is not a match:
<ul>
<li>The active thread is preempted.</li>
<li>If the right thread stack is now empty:
<ul>
<li>This means all threads have been visited (the traversal begins by moving
left, then right so this is the end of the traversal).</li>
<li>The wakeup traversal completes <sup class="footnote-reference"><a href="#traversal-completion">1</a></sup>.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="footnote-definition" id="traversal-completion"><sup class="footnote-definition-label">1</sup>
<p>Wakeup traversal is completed by setting the FPVM state's <code>wakeup</code> field to <code>MaxWord</code>,
causing the FPVM to resume normal execution.</p>
</div>
<h3 id="exited-threads"><a class="header" href="#exited-threads">Exited Threads</a></h3>
<p>When the VM encounters an active thread that has exited, it is popped from the active thread stack, removing it from
the VM state.</p>
<h3 id="waiting-threads"><a class="header" href="#waiting-threads">Waiting Threads</a></h3>
<p>Threads enter a waiting state when a futex wait syscall is successfully executed, setting the thread's
<code>futexAddr</code>, <code>futexVal</code>, and <code>futexTimeoutStep</code> fields according to the futex syscall arguments.</p>
<p>During normal execution, when the active thread is in a waiting state (its <code>futexAddr</code> is not equal to <code>MaxWord</code>), the VM
checks if it can be woken up.</p>
<p>A waiting thread will be woken up if:</p>
<ul>
<li>The current <code>step</code> (after incrementing) is greater than <code>futexTimeoutStep</code></li>
<li>The memory value at <code>futexAddr</code> is no longer equal to <code>futexVal</code></li>
</ul>
<p>The VM will wake such a thread by resetting its futex fields:</p>
<ul>
<li><code>futexAddr</code> = <code>MaxWord</code></li>
<li><code>futexVal</code> = 0</li>
<li><code>futexTimeoutStep</code> = 0</li>
</ul>
<p>If the current thread is waiting and cannot be woken, it is preempted.</p>
<h3 id="voluntary-preemption"><a class="header" href="#voluntary-preemption">Voluntary Preemption</a></h3>
<p>In addition to the futex wait syscall (see <a href="#waiting-threads">"Waiting Threads"</a>), there are a few other syscalls that
will cause a thread to be "voluntarily" preempted: <code>sched_yield</code>, <code>nanosleep</code>.</p>
<h3 id="forced-preemption"><a class="header" href="#forced-preemption">Forced Preemption</a></h3>
<p>To avoid thread starvation (for example where a thread hogs resources by never executing a sleep, yield, or wait),
the FPVM will force a context switch if the active thread has been executing too long.</p>
<p>For each step executed on a particular thread, the state field <code>stepsSinceLastContextSwitch</code> is incremented.
When a thread is preempted, <code>StepsSinceLastContextSwitch</code> is reset to 0.
If <code>StepsSinceLastContextSwitch</code> reaches a maximum value (<code>SchedQuantum</code> = 100_000),
the FPVM preempts the active thread.</p>
<h2 id="stateful-instructions"><a class="header" href="#stateful-instructions">Stateful Instructions</a></h2>
<h3 id="load-linked--store-conditional-word"><a class="header" href="#load-linked--store-conditional-word">Load Linked / Store Conditional Word</a></h3>
<p>The Load Linked Word (<code>ll</code>) and Store Conditional Word (<code>sc</code>) instructions provide the low-level
primitives used to implement atomic read-modify-write (RMW) operations.  A typical RMW sequence might play out as
follows:</p>
<ul>
<li><code>ll</code> places a "reservation" targeting a 32-bit value in memory and returns the current value at this location.</li>
<li>Subsequent instructions take this value and perform some operation on it:
<ul>
<li>For example, maybe a counter variable is loaded and then incremented.</li>
</ul>
</li>
<li><code>sc</code> is called and the modified value overwrites the original value in memory
only if the memory reservation is still intact.</li>
</ul>
<p>This RMW sequence ensures that if another thread or process modifies a reserved value while
an atomic update is being performed, the reservation will be invalidated and the atomic update will fail.</p>
<p>Prior to MTCannon, we could be assured that no intervening process would modify such a reserved value because
STCannon is singlethreaded.  With the introduction of multithreading, additional fields need to be stored in the
FPVM state to track memory reservations initiated by <code>ll</code> operations.</p>
<p>When an <code>ll</code> instruction is executed:</p>
<ul>
<li><code>llReservationStatus</code> is set to <code>1</code>.</li>
<li><code>llAddress</code> is set to the virtual memory address specified by <code>ll</code>.</li>
<li><code>llOwnerThread</code> is set to the <code>threadID</code> of the active thread.</li>
</ul>
<p>Only a single memory reservation can be active at a given time - a new reservation will clear any previous reservation.</p>
<p>When the VM writes any data to memory, these <code>ll</code>-related fields are checked and any existing memory reservation
is cleared if a memory write touches the naturally-aligned <code>Word</code> that contains <code>llAddress</code>.</p>
<p>When an <code>sc</code> instruction is executed, the operation will only succeed if:</p>
<ul>
<li>The <code>llReservationStatus</code> field is equal to <code>1</code>.</li>
<li>The active thread's <code>threadID</code> matches <code>llOwnerThread</code>.</li>
<li>The virtual address specified by <code>sc</code> matches <code>llAddress</code>.</li>
</ul>
<p>On success, <code>sc</code> stores a value to the specified address after it is naturally aligned,
clears the memory reservation by zeroing out <code>llReservationStatus</code>, <code>llOwnerThread</code>, and <code>llAddress</code>
and returns <code>1</code>.</p>
<p>On failure, <code>sc</code> returns <code>0</code>.</p>
<h3 id="load-linked--store-conditional-doubleword"><a class="header" href="#load-linked--store-conditional-doubleword">Load Linked / Store Conditional Doubleword</a></h3>
<p>With the transition to MIPS64, Load Linked Doubleword (<code>lld</code>), and Store Conditional Doubleword (<code>scd</code>) instructions
are also now supported.
These instructions are similar to <code>ll</code> and <code>sc</code>, but they operate on 64-bit rather than 32-bit values.</p>
<p>The <code>lld</code> instruction functions similarly to <code>ll</code>, but the <code>llReservationStatus</code> is set to <code>2</code>.
The <code>scd</code> instruction functions similarly to <code>sc</code>, but the <code>llReservationStatus</code> must be equal to <code>2</code>
for the operation to succeed.  In other words, an <code>scd</code> instruction must be preceded by a matching <code>lld</code> instruction
just as the <code>sc</code> instruction must be preceded by a matching <code>ll</code> instruction if the store operation is to succeed.</p>
<h2 id="fpvm-state"><a class="header" href="#fpvm-state">FPVM State</a></h2>
<h3 id="state"><a class="header" href="#state">State</a></h3>
<p>The FPVM is a state transition function that operates on a state object consisting of the following fields:</p>
<ol>
<li><code>memRoot</code> - [<code>Hash</code>] A value representing the merkle root of VM memory.</li>
<li><code>preimageKey</code> - [<code>Hash</code>] The value of the last requested pre-image key.</li>
<li><code>preimageOffset</code> - [<code>Word</code>] The value of the last requested pre-image offset.</li>
<li><code>heap</code> - [<code>Word</code>] The base address of the most recent memory allocation via mmap.</li>
<li><code>llReservationStatus</code> - [<code>UInt8</code>] The current memory reservation status where: <code>0</code> means there is no
reservation, <code>1</code> means an <code>ll</code>/<code>sc</code>-compatible reservation is active,
and <code>2</code> means an <code>lld</code>/<code>scd</code>-compatible reservation is active.
Memory is reserved via Load Linked Word (<code>ll</code>)  and Load Linked Doubleword (<code>lld</code>) instructions.</li>
<li><code>llAddress</code> - [<code>Word</code>] If a memory reservation is active, the value of
the address specified by the last <code>ll</code> or <code>lld</code> instruction.
Otherwise, set to <code>0</code>.</li>
<li><code>llOwnerThread</code> - [<code>Word</code>] The id of the thread that initiated the current memory reservation
or <code>0</code> if there is no active reservation.</li>
<li><code>exitCode</code> - [<code>UInt8</code>] The exit code value.</li>
<li><code>exited</code> - [<code>Boolean</code>] Indicates whether the VM has exited.</li>
<li><code>step</code> - [<code>UInt64</code>] A step counter.</li>
<li><code>stepsSinceLastContextSwitch</code> - [<code>UInt64</code>] A step counter that tracks the number of steps executed on the current
thread since the last <a href="#thread-preemption">preemption</a>.</li>
<li><code>wakeup</code> - [<code>Word</code>] The address set via a futex syscall signaling that the VM has entered wakeup traversal or else
<code>MaxWord</code> if there is no active wakeup signal. For details see <a href="#wakeup-traversal">"Wakeup Traversal"</a>.</li>
<li><code>traverseRight</code> - [<code>Boolean</code>] Indicates whether the currently active thread is on the left or right thread
stack, as well as some details on thread traversal mechanics.
See <a href="#thread-traversal-mechanics">"Thread Traversal Mechanics"</a> for details.</li>
<li><code>leftThreadStack</code> - [<code>Hash</code>] A hash of the contents of the left thread stack.
For details, see the <a href="#thread-stack-hashing">“Thread Stack Hashing” section.</a></li>
<li><code>rightThreadStack</code> - [<code>Hash</code>] A hash of the contents of the right thread stack.
For details, see the <a href="#thread-stack-hashing">“Thread Stack Hashing” section.</a></li>
<li><code>nextThreadID</code> - [<code>Word</code>] The value defining the id to assign to the next thread that is created.</li>
</ol>
<p>The state is represented by packing the above fields, in order, into a 196-byte buffer.</p>
<h3 id="state-hash"><a class="header" href="#state-hash">State Hash</a></h3>
<p>The state hash is computed by hashing the 196-byte state buffer with the Keccak256 hash function
and then setting the high-order byte to the respective VM status.</p>
<p>The VM status can be derived from the state's <code>exited</code> and <code>exitCode</code> fields.</p>
<pre><code class="language-rs">enum VmStatus {
    Valid = 0,
    Invalid = 1,
    Panic = 2,
    Unfinished = 3,
}

fn vm_status(exit_code: u8, exited: bool) -&gt; u8 {
    if exited {
        match exit_code {
            0 =&gt; VmStatus::Valid,
            1 =&gt; VmStatus::Invalid,
            _ =&gt; VmStatus::Panic,
        }
    } else {
        VmStatus::Unfinished
    }
}
</code></pre>
<h3 id="thread-state"><a class="header" href="#thread-state">Thread State</a></h3>
<p>The state of a single thread is tracked and represented by a thread state object consisting of the following fields:</p>
<ol>
<li><code>threadID</code> - [<code>Word</code>] A unique thread identifier.</li>
<li><code>exitCode</code> - [<code>UInt8</code>] The exit code value.</li>
<li><code>exited</code> - [<code>Boolean</code>] Indicates whether the thread has exited.</li>
<li><code>futexAddr</code> - [<code>Word</code>] An address set via a futex syscall indicating that this thread is waiting on a value change
at this address.</li>
<li><code>futexVal</code> - [<code>Word</code>] A value representing the memory contents at <code>futexAddr</code> when this thread began waiting.</li>
<li><code>futexTimeoutStep</code> - [<code>UInt64</code>] A value representing the future <code>step</code> at which the futex wait will time out.
Set to <code>MaxWord</code> if no timeout is active.</li>
<li><code>pc</code> - [<code>Word</code>] The program counter.</li>
<li><code>nextPC</code> - [<code>Word</code>] The next program counter. Note that this value may not always be <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">4</span></span></span></span>
when executing a branch/jump delay slot.</li>
<li><code>lo</code> - [<code>Word</code>] The MIPS LO special register.</li>
<li><code>hi</code> - [<code>Word</code>] The MIPS HI special register.</li>
<li><code>registers</code> - 32 general-purpose MIPS registers numbered 0 - 31. Each register contains a <code>Word</code> value.</li>
</ol>
<p>A thread is represented by packing the above fields, in order, into a 322-byte buffer.</p>
<h3 id="thread-hash"><a class="header" href="#thread-hash">Thread Hash</a></h3>
<p>A thread hash is computed by hashing the 322-byte thread state buffer with the Keccak256 hash function.</p>
<h3 id="thread-stack-hashing"><a class="header" href="#thread-stack-hashing">Thread Stack Hashing</a></h3>
<blockquote>
<p><strong>Note:</strong> The <code>++</code> operation represents concatenation of 2 byte string arguments</p>
</blockquote>
<p>Each thread stack is represented in the FPVM state by a "hash onion" construction using the Keccak256 hash
function. This construction provides a succinct commitment to the contents of a thread stack using a single <code>bytes32</code>
value:</p>
<ul>
<li>An empty stack is represented by the value:
<ul>
<li><code>c0 = hash(bytes32(0) ++ bytes32(0))</code></li>
</ul>
</li>
<li>To push a thread to the stack, hash the concatenation of the current stack commitment with the thread hash:
<ul>
<li><code>push(c0, el0) =&gt; c1 = hash(c0 ++ hash(el0))</code>.</li>
</ul>
</li>
<li>To push another thread:
<ul>
<li><code>push(c1, el1) =&gt; c2 = hash(c1 ++ hash(el1))</code>.</li>
</ul>
</li>
<li>To pop an element from the stack, peel back the last hash (push) operation:
<ul>
<li><code>pop(c2) =&gt; c3 = c1</code></li>
</ul>
</li>
<li>To prove the top value <code>elTop</code> on the stack, given some commitment <code>c</code>, you just need to reveal the <code>bytes32</code>
commitment <code>c'</code> for the stack without <code>elTop</code> and verify:
<ul>
<li><code>c = hash(c' ++ hash(elTop))</code></li>
</ul>
</li>
</ul>
<h2 id="memory"><a class="header" href="#memory">Memory</a></h2>
<p>Memory is represented as a binary merkle tree.
The tree has a fixed-depth of 59 levels, with leaf values of 32 bytes each.
This spans the full 64-bit address space, where each leaf contains the memory at that part of the tree.
The state <code>memRoot</code> represents the merkle root of the tree, reflecting the effects of memory writes.
As a result of this memory representation, all memory operations are <code>WordSize</code>-byte aligned.
Memory access doesn't require any privileges. An instruction step can access any memory
location as the entire address space is unprotected.</p>
<h3 id="heap"><a class="header" href="#heap">Heap</a></h3>
<p>FPVM state contains a <code>heap</code> that tracks the base address of the most recent memory allocation.
Heap pages are bump allocated at the page boundary, per <code>mmap</code> syscall.
mmap-ing is purely to satisfy program runtimes that need the memory-pointer
result of the syscall to locate free memory. The page size is 4096.</p>
<p>The FPVM has a fixed program break at <code>ProgramBreakAddress</code>. However, the FPVM is permitted to extend the
heap beyond this limit via mmap syscalls.
For simplicity, there are no memory protections against "heap overruns" against other memory segments.
Such VM steps are still considered valid state transitions.</p>
<p>Specification of memory mappings is outside the scope of this document as it is irrelevant to
the VM state. FPVM implementers may refer to the Linux/MIPS kernel for inspiration.</p>
<h2 id="delay-slots"><a class="header" href="#delay-slots">Delay Slots</a></h2>
<p>The post-state of a step updates the <code>nextPC</code>, indicating the instruction following the <code>pc</code>.
However, in the case of where a branch instruction is being stepped, the <code>nextPC</code> post-state is
set to the branch target. And the <code>pc</code> post-state set to the branch delay slot as usual.</p>
<p>A VM state transition is invalid whenever the current instruction is a delay slot that is filled
with jump or branch type instruction.
That is, where <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">n</span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mord mathnormal" style="margin-right:0.07153em;">tPC</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel"><span class="mrel"><span class="mord vbox"><span class="thinbox"><span class="rlap"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="inner"><span class="mord"><span class="mrel"></span></span></span><span class="fix"></span></span></span></span></span><span class="mrel">=</span></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">4</span></span></span></span> while stepping on a jump/branch instruction.
Otherwise, there would be two consecutive delay slots. While this is considered "undefined"
behavior in typical MIPS implementations, FPVM must raise an exception when stepping on such states.</p>
<h2 id="syscalls"><a class="header" href="#syscalls">Syscalls</a></h2>
<p>Syscalls work similar to <a href="https://www.linux-mips.org/wiki/Syscall">Linux/MIPS</a>, including the
syscall calling conventions and general syscall handling behavior.
However, the FPVM supports a subset of Linux/MIPS syscalls with slightly different behaviors.
These syscalls have identical syscall numbers and ABIs as Linux/MIPS.</p>
<p>For all of the following syscalls, an error is indicated by setting the return
register (<code>$v0</code>) to <code>MaxWord</code> and <code>errno</code> (<code>$a3</code>) is set accordingly.
The VM must not modify any register other than <code>$v0</code> and <code>$a3</code> during syscall handling.</p>
<p>The following tables summarize supported syscalls and their behaviors.
If an unsupported syscall is encountered, the VM will raise an exception.</p>
<h3 id="supported-syscalls"><a class="header" href="#supported-syscalls">Supported Syscalls</a></h3>
<div class="table-wrapper"><table><thead><tr><th>$v0</th><th>system call</th><th>$a0</th><th>$a1</th><th>$a2</th><th>$a3</th><th>Effect</th></tr></thead><tbody>
<tr><td>5009</td><td>mmap</td><td>uint64 addr</td><td>uint64 len</td><td>🚫</td><td>🚫</td><td>Allocates a page from the heap. See <a href="#heap">heap</a> for details.</td></tr>
<tr><td>5012</td><td>brk</td><td>🚫</td><td>🚫</td><td>🚫</td><td>🚫</td><td>Returns a fixed address for the program break at <code>ProgramBreakAddress</code></td></tr>
<tr><td>5205</td><td>exit_group</td><td>uint8 exit_code</td><td>🚫</td><td>🚫</td><td>🚫</td><td>Sets the exited and exitCode state fields to <code>true</code> and <code>$a0</code> respectively.</td></tr>
<tr><td>5000</td><td>read</td><td>uint64 fd</td><td>char *buf</td><td>uint64 count</td><td>🚫</td><td>Similar behavior as Linux/MIPS with support for unaligned reads. See <a href="#io">I/O</a> for more details.</td></tr>
<tr><td>5001</td><td>write</td><td>uint64 fd</td><td>char *buf</td><td>uint64 count</td><td>🚫</td><td>Similar behavior as Linux/MIPS with support for unaligned writes. See <a href="#io">I/O</a> for more details.</td></tr>
<tr><td>5070</td><td>fcntl</td><td>uint64 fd</td><td>int64 cmd</td><td>🚫</td><td>🚫</td><td>Similar behavior as Linux/MIPS. Only the <code>F_GETFD</code>(1) and <code>F_GETFL</code> (3) cmds are supported. Sets errno to <code>0x16</code> for all other commands.</td></tr>
<tr><td>5055</td><td>clone</td><td>uint64 flags</td><td>uint64 stack_ptr</td><td>🚫</td><td>🚫</td><td>Creates a new thread based on the currently active thread's state.  Supports a <code>flags</code> argument equal to <code>0x00050f00</code>, other values cause the VM to exit with exit_code <code>VmStatus.PANIC</code>.</td></tr>
<tr><td>5058</td><td>exit</td><td>uint8 exit_code</td><td>🚫</td><td>🚫</td><td>🚫</td><td>Sets the active thread's exited and exitCode state fields to <code>true</code> and <code>$a0</code> respectively.</td></tr>
<tr><td>5023</td><td>sched_yield</td><td>🚫</td><td>🚫</td><td>🚫</td><td>🚫</td><td>Preempts the active thread and returns 0.</td></tr>
<tr><td>5178</td><td>gettid</td><td>🚫</td><td>🚫</td><td>🚫</td><td>🚫</td><td>Returns the active thread's threadID field.</td></tr>
<tr><td>5194</td><td>futex</td><td>uint64 addr</td><td>uint64 futex_op</td><td>uint64 val</td><td>uint64 *timeout</td><td>Supports <code>futex_op</code>'s <code>FUTEX_WAIT_PRIVATE</code> (128) and <code>FUTEX_WAKE_PRIVATE</code> (129). Other operations set errno to <code>0x16</code>.</td></tr>
<tr><td>5002</td><td>open</td><td>🚫</td><td>🚫</td><td>🚫</td><td>🚫</td><td>Sets errno to <code>EBADF</code>.</td></tr>
<tr><td>5034</td><td>nanosleep</td><td>🚫</td><td>🚫</td><td>🚫</td><td>🚫</td><td>Preempts the active thread and returns 0.</td></tr>
<tr><td>5222</td><td>clock_gettime</td><td>uint64 clock_id</td><td>uint64 addr</td><td>🚫</td><td>🚫</td><td>Supports <code>clock_id</code>'s <code>REALTIME</code>(0) and <code>MONOTONIC</code>(1). For other <code>clock_id</code>'s, sets errno to <code>0x16</code>.  Calculates a deterministic time value based on the state's <code>step</code> field and a constant <code>HZ</code> (10,000,000) where <code>HZ</code> represents the approximate clock rate (steps / second) of the FPVM:<br/><br/><code>seconds = step/HZ</code><br/><code>nsecs = (step % HZ) * 10^9/HZ</code><br/><br/>Seconds are set at memory address <code>addr</code> and nsecs are set at <code>addr + WordSize</code>.</td></tr>
<tr><td>5038</td><td>getpid</td><td>🚫</td><td>🚫</td><td>🚫</td><td>🚫</td><td>Returns 0.</td></tr>
</tbody></table>
</div>
<h3 id="noop-syscalls"><a class="header" href="#noop-syscalls">Noop Syscalls</a></h3>
<p>For the following noop syscalls, the VM must do nothing except to zero out the syscall return (<code>$v0</code>)
and errno (<code>$a3</code>) registers.</p>
<div class="table-wrapper"><table><thead><tr><th>$v0</th><th>system call</th></tr></thead><tbody>
<tr><td>5011</td><td>munmap</td></tr>
<tr><td>5196</td><td>sched_get_affinity</td></tr>
<tr><td>5027</td><td>madvise</td></tr>
<tr><td>5014</td><td>rt_sigprocmask</td></tr>
<tr><td>5129</td><td>sigaltstack</td></tr>
<tr><td>5013</td><td>rt_sigaction</td></tr>
<tr><td>5297</td><td>prlimit64</td></tr>
<tr><td>5003</td><td>close</td></tr>
<tr><td>5016</td><td>pread64</td></tr>
<tr><td>5004</td><td>stat</td></tr>
<tr><td>5005</td><td>fstat</td></tr>
<tr><td>5247</td><td>openat</td></tr>
<tr><td>5087</td><td>readlink</td></tr>
<tr><td>5257</td><td>readlinkat</td></tr>
<tr><td>5015</td><td>ioctl</td></tr>
<tr><td>5285</td><td>epoll_create1</td></tr>
<tr><td>5287</td><td>pipe2</td></tr>
<tr><td>5208</td><td>epoll_ctl</td></tr>
<tr><td>5272</td><td>epoll_pwait</td></tr>
<tr><td>5313</td><td>getrandom</td></tr>
<tr><td>5061</td><td>uname</td></tr>
<tr><td>5100</td><td>getuid</td></tr>
<tr><td>5102</td><td>getgid</td></tr>
<tr><td>5026</td><td>mincore</td></tr>
<tr><td>5225</td><td>tgkill</td></tr>
<tr><td>5095</td><td>getrlimit</td></tr>
<tr><td>5008</td><td>lseek</td></tr>
<tr><td>5036</td><td>setitimer</td></tr>
<tr><td>5216</td><td>timer_create</td></tr>
<tr><td>5217</td><td>timer_settime</td></tr>
<tr><td>5220</td><td>timer_delete</td></tr>
</tbody></table>
</div>
<h2 id="io"><a class="header" href="#io">I/O</a></h2>
<p>The VM does not support Linux open(2). However, the VM can read from and write to a predefined set of file descriptors.</p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>File descriptor</th><th>Description</th></tr></thead><tbody>
<tr><td>stdin</td><td>0</td><td>read-only standard input stream.</td></tr>
<tr><td>stdout</td><td>1</td><td>write-only standard output stream.</td></tr>
<tr><td>stderr</td><td>2</td><td>write-only standard error stream.</td></tr>
<tr><td>hint response</td><td>3</td><td>read-only. Used to read the status of <a href="../fault-proof/index.html#hinting">pre-image hinting</a>.</td></tr>
<tr><td>hint request</td><td>4</td><td>write-only. Used to provide <a href="../fault-proof/index.html#hinting">pre-image hints</a></td></tr>
<tr><td>pre-image response</td><td>5</td><td>read-only. Used to <a href="../fault-proof/index.html#pre-image-communication">read pre-images</a>.</td></tr>
<tr><td>pre-image request</td><td>6</td><td>write-only. Used to <a href="../fault-proof/index.html#pre-image-communication">request pre-images</a>.</td></tr>
</tbody></table>
</div>
<p>Syscalls referencing unknown file descriptors fail with an <code>EBADF</code> errno as done on Linux.</p>
<p>Writing to and reading from standard output, input and error streams have no effect on the FPVM state.
FPVM implementations may use them for debugging purposes as long as I/O is stateless.</p>
<p>All I/O operations are restricted to a maximum of <code>WordSize</code> bytes per operation.
Any read or write syscall request exceeding this limit will be truncated to <code>WordSize</code> bytes.
Consequently, the return value of read/write syscalls is at most <code>WordSize</code> bytes,
indicating the actual number of bytes read/written.</p>
<h3 id="standard-streams"><a class="header" href="#standard-streams">Standard Streams</a></h3>
<p>Writing to stderr/stdout standard stream always succeeds with the write count input returned,
effectively continuing execution without writing work.
Reading from stdin has no effect other than to return zero and errno set to 0, signalling that there is no input.</p>
<h3 id="hint-communication"><a class="header" href="#hint-communication">Hint Communication</a></h3>
<p>Hint requests and responses have no effect on the VM state other than setting the <code>$v0</code> return
register to the requested read/write count.
VM implementations may utilize hints to setup subsequent pre-image requests.</p>
<h3 id="pre-image-communication"><a class="header" href="#pre-image-communication">Pre-image Communication</a></h3>
<p>The <code>preimageKey</code> and <code>preimageOffset</code> state are updated via read/write syscalls to the pre-image
read and write file descriptors (see <a href="#io">I/O</a>).
The <code>preimageKey</code> buffers the stream of bytes written to the pre-image write fd.
The <code>preimageKey</code> buffer is shifted to accommodate new bytes written to the end of it.
A write also resets the <code>preimageOffset</code> to 0, indicating the intent to read a new pre-image.</p>
<p>When handling pre-image reads, the <code>preimageKey</code> is used to lookup the pre-image data from an Oracle.
A max <code>WordSize</code>-byte chunk of the pre-image at the <code>preimageOffset</code> is read to the specified address.
Each read operation increases the <code>preimageOffset</code> by the number of bytes requested
(truncated to <code>WordSize</code> bytes and subject to alignment constraints).</p>
<h4 id="pre-image-io-alignment"><a class="header" href="#pre-image-io-alignment">Pre-image I/O Alignment</a></h4>
<p>As mentioned earlier in <a href="#memory">memory</a>, all memory operations are <code>WordSize</code>-byte aligned.
Since pre-image I/O occurs on memory, all pre-image I/O operations must strictly adhere to alignment boundaries.
This means the start and end of a read/write operation must fall within the same alignment boundary.
If an operation were to violate this, the input <code>count</code> of the read/write syscall must be
truncated such that the effective address of the last byte read/written matches the input effective address.</p>
<p>The VM must read/write the maximum amount of bytes possible without crossing the input address alignment boundary.
For example, the effect of a write request for a 3-byte aligned buffer must be exactly 3 bytes.
If the buffer is misaligned, then the VM may write less than 3 bytes depending on the size of the misalignment.</p>
<h2 id="exceptions"><a class="header" href="#exceptions">Exceptions</a></h2>
<p>The FPVM may raise an exception rather than output a post-state to signal an invalid state
transition. Nominally, the FPVM must raise an exception in at least the following cases:</p>
<ul>
<li>Invalid instruction (either via an invalid opcode or an instruction referencing registers
outside the general purpose registers).</li>
<li>Unsupported syscall.</li>
<li>Pre-image read at an offset larger than the size of the pre-image.</li>
<li>Delay slot contains branch/jump instruction types.</li>
<li>Invalid thread state: the active thread stack is empty.</li>
</ul>
<p>VM implementations may raise an exception in other cases that is specific to the implementation.
For example, an on-chain FPVM that relies on pre-supplied merkle proofs for memory access may
raise an exception if the supplied merkle proof does not match the pre-state <code>memRoot</code>.</p>
<h2 id="security-model"><a class="header" href="#security-model">Security Model</a></h2>
<h3 id="compiler-correctness"><a class="header" href="#compiler-correctness">Compiler Correctness</a></h3>
<p>MTCannon is designed to prove the correctness of a particular state transition that emulates a MIPS64 machine.
MTCannon does not guarantee that the MIPS64 instructions correctly implement the program that the user intends to prove.
As a result, MTCannon's use as a Fault Proof system inherently depends to some extent on the correctness of the compiler
used to generate the MIPS64 instructions over which MTCannon operates.</p>
<p>To illustrate this concept, suppose that a user intends to prove simple program <code>input + 1 = output</code>.
Suppose then that the user's compiler for this program contains a bug and errantly generates the MIPS instructions for a
slightly different program <code>input + 2 = output</code>. Although MTCannon would correctly prove the operation of this compiled program,
the result proven would differ from the user's intent. MTCannon proves the MIPS state transition but makes no assertion about
the correctness of the translation between the user's high-level code and the resulting MIPS program.</p>
<p>As a consequence of the above, it is the responsibility of a program developer to develop tests that demonstrate that MTCannon
is capable of proving their intended program correctly over a large number of possible inputs. Such tests defend against
bugs in the user's compiler as well as ways in which the compiler may inadvertently break one of MTCannon's
<a href="#compiler-assumptions">Compiler Assumptions</a>. Users of Fault Proof systems are strongly encouraged to utilize multiple
proof systems and/or compilers to mitigate the impact of errant behavior in any one toolchain.</p>
<h3 id="compiler-assumptions"><a class="header" href="#compiler-assumptions">Compiler Assumptions</a></h3>
<p>MTCannon makes the simplifying assumption that users are utilizing compilers that do not rely on MIPS exception states for
standard program behavior. In other words, MTCannon generally assumes that the user's compiler generates spec-compliant
instructions that would not trigger an exception. Refer to <a href="#exceptions">Exceptions</a> for a list of conditions that are
explicitly handled.</p>
<p>Certain cases that would typically be asserted by a strict implementation of the MIPS64 specification are not handled by
MTCannon as follows:</p>
<ul>
<li><code>add</code>, <code>addi</code>, and <code>sub</code> do not trigger an exception on signed integer overflow.</li>
<li>Instruction encoding validation does not trigger an exception for fields that should be zero.</li>
<li>Memory instructions do not trigger an exception when addresses are not naturally aligned.</li>
</ul>
<p>Many compilers, including the Golang compiler, will not generate code that would trigger these conditions under bug-free
operation. Given the inherent reliance on <a href="#compiler-correctness">Compiler Correctness</a> in applications using MTCannon, the
tests and defense mechanisms that must necessarily be employed by MTCannon users to protect their particular programs
against compiler bugs should also suffice to surface bugs that would break these compiler assumptions. Stated simply, MTCannon
can rely on specific compiler behaviors because users inherently must employ safety nets to guard against compiler bugs.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../experimental/gov-token.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../glossary.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../experimental/gov-token.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../glossary.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../specs/static/solidity.min.js"></script>
        <script src="../specs/static/mermaid.min.js"></script>
        <script src="../specs/static/mermaid-init.js"></script>


    </div>
    </body>
</html>
