<!DOCTYPE HTML>
<html lang="en" class="ayu" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Predeploys - OP Stack Specification</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('ayu')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../root.html"><strong aria-hidden="true">1.</strong> Root</a></li><li class="chapter-item expanded "><a href="../introduction.html"><strong aria-hidden="true">2.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../protocol/overview.html"><strong aria-hidden="true">3.</strong> OP Stack Protocol</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../protocol/bridges.html"><strong aria-hidden="true">3.1.</strong> Bridges</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../protocol/messengers.html"><strong aria-hidden="true">3.1.1.</strong> Messengers</a></li><li class="chapter-item expanded "><a href="../protocol/deposits.html"><strong aria-hidden="true">3.1.2.</strong> Deposits</a></li><li class="chapter-item expanded "><a href="../protocol/withdrawals.html"><strong aria-hidden="true">3.1.3.</strong> Withdrawals</a></li><li class="chapter-item expanded "><a href="../protocol/guaranteed-gas-market.html"><strong aria-hidden="true">3.1.4.</strong> Guaranteed Gas Market</a></li><li class="chapter-item expanded "><a href="../protocol/proposals.html"><strong aria-hidden="true">3.1.5.</strong> Proposals</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.2.</strong> Clients</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../protocol/exec-engine.html"><strong aria-hidden="true">3.2.1.</strong> Execution Engine</a></li><li class="chapter-item expanded "><a href="../protocol/rollup-node.html"><strong aria-hidden="true">3.2.2.</strong> Rollup Node</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../protocol/rollup-node-p2p.html"><strong aria-hidden="true">3.2.2.1.</strong> Rollup Node P2P</a></li><li class="chapter-item expanded "><a href="../protocol/derivation.html"><strong aria-hidden="true">3.2.2.2.</strong> Derivation</a></li><li class="chapter-item expanded "><a href="../protocol/span-batches.html"><strong aria-hidden="true">3.2.2.3.</strong> Span Batches</a></li></ol></li><li class="chapter-item expanded "><a href="../protocol/batcher.html"><strong aria-hidden="true">3.2.3.</strong> Batch Submitter</a></li></ol></li><li class="chapter-item expanded "><a href="../protocol/safe-liveness-checking.html"><strong aria-hidden="true">3.3.</strong> Safe Liveness Checking</a></li><li class="chapter-item expanded "><a href="../protocol/predeploys.html"><strong aria-hidden="true">3.4.</strong> Predeploys</a></li><li class="chapter-item expanded "><a href="../protocol/preinstalls.html"><strong aria-hidden="true">3.5.</strong> Preinstalls</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.6.</strong> Superchain</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../protocol/superchain-configuration.html"><strong aria-hidden="true">3.6.1.</strong> Superchain Configuration</a></li><li class="chapter-item expanded "><a href="../protocol/superchain-upgrades.html"><strong aria-hidden="true">3.6.2.</strong> Superchain Upgrades</a></li></ol></li><li class="chapter-item expanded "><a href="../protocol/system_config.html"><strong aria-hidden="true">3.7.</strong> System Config</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> Experimental</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../experimental/fault-proof/index.html"><strong aria-hidden="true">4.1.</strong> Fault Proof</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../experimental/fault-proof/cannon-fault-proof-vm.html"><strong aria-hidden="true">4.1.1.</strong> Cannon Fault Proof VM</a></li><li class="chapter-item expanded "><a href="../experimental/fault-proof/stage-one/index.html"><strong aria-hidden="true">4.1.2.</strong> Stage One Decentralization</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../experimental/fault-proof/stage-one/dispute-game-interface.html"><strong aria-hidden="true">4.1.2.1.</strong> Dispute Game Interface</a></li><li class="chapter-item expanded "><a href="../experimental/fault-proof/stage-one/fault-dispute-game.html"><strong aria-hidden="true">4.1.2.2.</strong> Fault Dispute Game</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../experimental/fault-proof/stage-one/honest-challenger-fdg.html"><strong aria-hidden="true">4.1.2.2.1.</strong> Honest Challenger</a></li><li class="chapter-item expanded "><a href="../experimental/fault-proof/stage-one/bond-incentives.html"><strong aria-hidden="true">4.1.2.2.2.</strong> Bond Incentives</a></li></ol></li><li class="chapter-item expanded "><a href="../experimental/fault-proof/stage-one/bridge-integration.html"><strong aria-hidden="true">4.1.2.3.</strong> Bridge Integration</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../experimental/plasma.html"><strong aria-hidden="true">4.2.</strong> Plasma</a></li><li class="chapter-item expanded "><a href="../interop/index.html"><strong aria-hidden="true">4.3.</strong> Interoperability</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../interop/dependency_set.html"><strong aria-hidden="true">4.3.1.</strong> Dependency Set</a></li><li class="chapter-item expanded "><a href="../interop/messaging.html"><strong aria-hidden="true">4.3.2.</strong> Messaging</a></li><li class="chapter-item expanded "><a href="../interop/predeploys.html" class="active"><strong aria-hidden="true">4.3.3.</strong> Predeploys</a></li><li class="chapter-item expanded "><a href="../interop/execution.html"><strong aria-hidden="true">4.3.4.</strong> Execution</a></li><li class="chapter-item expanded "><a href="../interop/sequencer.html"><strong aria-hidden="true">4.3.5.</strong> Sequencer</a></li><li class="chapter-item expanded "><a href="../interop/verifier.html"><strong aria-hidden="true">4.3.6.</strong> Verifier</a></li><li class="chapter-item expanded "><a href="../interop/rollup_node_p2p.html"><strong aria-hidden="true">4.3.7.</strong> Rollup Node P2P</a></li><li class="chapter-item expanded "><a href="../interop/fault_proof.html"><strong aria-hidden="true">4.3.8.</strong> Fault Proof</a></li><li class="chapter-item expanded "><a href="../interop/upgrade.html"><strong aria-hidden="true">4.3.9.</strong> Upgrade</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../glossary.html"><strong aria-hidden="true">5.</strong> Glossary</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">OP Stack Specification</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/ethereum-optimism/specs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/ethereum-optimism/specs/edit/main/specs/interop/predeploys.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="predeploys"><a class="header" href="#predeploys">Predeploys</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="#crossl2inbox">CrossL2Inbox</a>
<ul>
<li><a href="#message-execution-arguments">Message execution arguments</a>
<ul>
<li><a href="#_msg"><code>_msg</code></a></li>
<li><a href="#_id"><code>_id</code></a></li>
<li><a href="#_target"><code>_target</code></a></li>
</ul>
</li>
<li><a href="#reference-implementation">Reference implementation</a></li>
<li><a href="#identifier-getters"><code>Identifier</code> Getters</a></li>
</ul>
</li>
<li><a href="#l2tol2crossdomainmessenger">L2ToL2CrossDomainMessenger</a>
<ul>
<li><a href="#relaymessage-invariants"><code>relayMessage</code> Invariants</a></li>
<li><a href="#message-versioning">Message Versioning</a></li>
<li><a href="#transferring-ether-in-a-cross-chain-message">Transferring Ether in a Cross Chain Message</a></li>
<li><a href="#interfaces">Interfaces</a>
<ul>
<li><a href="#sending-messages">Sending Messages</a></li>
<li><a href="#relaying-messages">Relaying Messages</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#l1block">L1Block</a>
<ul>
<li><a href="#l1attributes">L1Attributes</a></li>
</ul>
</li>
<li><a href="#security-considerations">Security Considerations</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<p>Two new system level predeploys are introduced for managing cross chain messaging along with
an update to the <code>L1Block</code> contract with additional functionality.</p>
<h2 id="crossl2inbox"><a class="header" href="#crossl2inbox">CrossL2Inbox</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Constant</th><th>Value</th></tr></thead><tbody>
<tr><td>Address</td><td><code>0x4200000000000000000000000000000000000022</code></td></tr>
</tbody></table>
</div>
<p>The <code>CrossL2Inbox</code> is responsible for executing a cross chain message on the destination chain.
It is permissionless to execute a cross chain message on behalf of any user.</p>
<p>To ensure safety of the protocol, the <a href="./messaging.html#messaging-invariants">Message Invariants</a> must be enforced.</p>
<h3 id="message-execution-arguments"><a class="header" href="#message-execution-arguments">Message execution arguments</a></h3>
<p>The following fields are required for executing a cross chain message:</p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>_msg</code></td><td><code>bytes</code></td><td>The <a href="./messaging.html#message-payload">message payload</a>, matching the initiating message.</td></tr>
<tr><td><code>_id</code></td><td><code>Identifier</code></td><td>A <a href="./messaging.html#message-identifier"><code>Identifier</code></a> pointing to the initiating message.</td></tr>
<tr><td><code>_target</code></td><td><code>address</code></td><td>Account that is called with <code>_msg</code>.</td></tr>
</tbody></table>
</div>
<h4 id="_msg"><a class="header" href="#_msg"><code>_msg</code></a></h4>
<p>The <a href="./messaging.html#message-payload">message payload</a> of the executing message.</p>
<p>This must match the emitted payload of the initiating message identified by <code>_id</code>.</p>
<h4 id="_id"><a class="header" href="#_id"><code>_id</code></a></h4>
<p>A pointer to the <code>_msg</code> in a remote (or local) chain.</p>
<p>The message <a href="./messaging.html#message-identifier"><code>Identifier</code></a> of the executing message.
This is required to enforce the message executes an existing and valid initiating message.</p>
<p>By including the <a href="./messaging.html#message-identifier"><code>Identifier</code></a> in the calldata, it makes static analysis much easier for block builders.
It is impossible to check that the <a href="./messaging.html#message-identifier"><code>Identifier</code></a> matches the cross chain message on chain. If the block
builder includes a message that does not correspond to the <a href="./messaging.html#message-identifier"><code>Identifier</code></a>, their block will be reorganized
by the derivation pipeline.</p>
<p>A possible upgrade path to this contract would involve adding a new function. If any fields in the <a href="./messaging.html#message-identifier"><code>Identifier</code></a>
change, then a new 4byte selector will be generated by solc.</p>
<h4 id="_target"><a class="header" href="#_target"><code>_target</code></a></h4>
<p>Messages are broadcast, not directed. Upon execution the caller can specify which <code>address</code> to target:
there is no protocol enforcement on what this value is.</p>
<p>The <code>_target</code> is called with the <code>_msg</code> as input.
In practice, the <code>_target</code> will be a contract that needs to know the schema of the <code>_msg</code> so that it can be decoded.
It MAY call back to the <code>CrossL2Inbox</code> to authenticate
properties about the <code>_msg</code> using the information in the <code>Identifier</code>.</p>
<h3 id="reference-implementation"><a class="header" href="#reference-implementation">Reference implementation</a></h3>
<p>A simple implementation of the <code>executeMessage</code> function is included below.</p>
<pre><code class="language-solidity">function executeMessage(address _target, bytes calldata _msg, Identifier calldata _id) public payable {
    require(msg.sender == tx.origin);
    require(_id.timestamp &lt;= block.timestamp);
    require(L1Block.isInDependencySet(_id.chainid));

    assembly {
      tstore(ORIGIN_SLOT, _id.origin)
      tstore(BLOCKNUMBER_SLOT, _id.blocknumber)
      tstore(LOG_INDEX_SLOT, _id.logIndex)
      tstore(TIMESTAMP_SLOT, _id.timestamp)
      tstore(CHAINID_SLOT, _id.chainid)
    }

    bool success = SafeCall.call({
      _target: _target,
      _value: msg.value,
      _calldata: _msg
    });

    require(success);
}
</code></pre>
<h3 id="identifier-getters"><a class="header" href="#identifier-getters"><code>Identifier</code> Getters</a></h3>
<p>The <code>Identifier</code> MUST be exposed via <code>public</code> getters so that contracts can call back to authenticate
properties about the <code>_msg</code>.</p>
<h2 id="l2tol2crossdomainmessenger"><a class="header" href="#l2tol2crossdomainmessenger">L2ToL2CrossDomainMessenger</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Constant</th><th>Value</th></tr></thead><tbody>
<tr><td>Address</td><td><code>0x4200000000000000000000000000000000000023</code></td></tr>
<tr><td><code>MESSAGE_VERSION</code></td><td><code>uint256(0)</code></td></tr>
<tr><td><code>INITIAL_BALANCE</code></td><td><code>type(uint248).max</code></td></tr>
</tbody></table>
</div>
<p>The <code>L2ToL2CrossDomainMessenger</code> is a higher level abstraction on top of the <code>CrossL2Inbox</code> that
provides features necessary for secure transfers of <code>ether</code> and ERC20 tokens between L2 chains.
Messages sent through the <code>L2ToL2CrossDomainMessenger</code> on the source chain receive both replay protection
as well as domain binding, ie the executing transaction can only be valid on a single chain.</p>
<h3 id="relaymessage-invariants"><a class="header" href="#relaymessage-invariants"><code>relayMessage</code> Invariants</a></h3>
<ul>
<li>Only callable by the <code>CrossL2Inbox</code></li>
<li>The <code>Identifier.origin</code> MUST be <code>address(L2ToL2CrossDomainMessenger)</code></li>
<li>The <code>_destination</code> chainid MUST be equal to the local chainid</li>
<li>The <code>CrossL2Inbox</code> cannot call itself</li>
</ul>
<h3 id="message-versioning"><a class="header" href="#message-versioning">Message Versioning</a></h3>
<p>Versioning is handled in the most significant bits of the nonce, similarly to how it is handled by
the <code>CrossDomainMessenger</code>.</p>
<pre><code class="language-solidity">function messageNonce() public view returns (uint256) {
    return Encoding.encodeVersionedNonce(nonce, MESSAGE_VERSION);
}
</code></pre>
<h3 id="transferring-ether-in-a-cross-chain-message"><a class="header" href="#transferring-ether-in-a-cross-chain-message">Transferring Ether in a Cross Chain Message</a></h3>
<p>The <code>L2ToL2CrossDomainMessenger</code> MUST be initially set in state with an ether balance of <code>INITIAL_BALANCE</code>.
This initial balance exists to provide liquidity for cross chain transfers. It is large enough to always have
ether present to dispurse while still being able to accept inbound transfers of ether without overflowing.
The <code>L2ToL2CrossDomainMessenger</code> MUST only ensure all invariants are held before transferring out any ether.</p>
<p>The <code>L2CrossDomainMessenger</code> is not updated to include the <code>L2ToL2CrossDomainMessenger</code> functionality because
there is no need to introduce complexity between the L1 to L2 messages and the L2 to L2 liquidity.</p>
<h3 id="interfaces"><a class="header" href="#interfaces">Interfaces</a></h3>
<p>The <code>L2ToL2CrossDomainMessenger</code> uses a similar interface to the <code>L2CrossDomainMessenger</code> but
the <code>_minGasLimit</code> is removed to prevent complexity around EVM gas introspection and the <code>_destination</code>
chain is included instead.</p>
<h4 id="sending-messages"><a class="header" href="#sending-messages">Sending Messages</a></h4>
<p>The initiating message is represented by the following event:</p>
<pre><code class="language-solidity">event SentMessage(bytes message) anonymous;
</code></pre>
<p>The <code>bytes</code> are an ABI encoded call to <code>relayMessage</code>. The event is defined as <code>anonymous</code> so that no topics
are prefixed to the abi encoded call.</p>
<p>An explicit <code>_destination</code> chain and <code>nonce</code> are used to ensure that the message can only be played on a single remote
chain a single time. The <code>_destination</code> is enforced to not be the local chain to avoid edge cases.</p>
<pre><code class="language-solidity">function sendMessage(uint256 _destination, address _target, bytes calldata _message) external payable {
    require(_destination != block.chainid);

    bytes memory data = abi.encodeCall(L2ToL2CrossDomainMessenger.relayMessage, (_destination, messageNonce(), msg.sender, _target, msg.value, _message));
    emit SentMessage(data);
    nonce++;
}
</code></pre>
<h4 id="relaying-messages"><a class="header" href="#relaying-messages">Relaying Messages</a></h4>
<p>When relaying a message through the <code>L2ToL2CrossDomainMessenger</code>, it is important to require that
the <code>_destination</code> equal to <code>block.chainid</code> to ensure that the message is only valid on a single
chain. The hash of the message is used for replay protection.</p>
<p>It is important to ensure that the source chain is in the dependency set of the destination chain, otherwise
it is possible to send a message that is not playable.</p>
<pre><code class="language-solidity">function relayMessage(uint256 _destination, uint256 _nonce, address _sender, address _target, uint256 _value, bytes memory _message) external {
    require(msg.sender == address(CROSS_L2_INBOX));
    require(_destination == block.chainid);
    require(CROSS_L2_INBOX.origin() == address(this));
    require(_target != address(this));

    bytes32 messageHash = keccak256(abi.encode(_destination, _nonce, _sender, _target, _value, _message));
    require(sentMessages[messageHash] == false);

    assembly {
      tstore(CROSS_DOMAIN_MESSAGE_SENDER_SLOT, _sender)
    }

    bool success = SafeCall.call({
       _target: _target,
       _value: _value,
       _calldata: _message
    });

    require(success);

    sentMessages[messageHash] = true;
}
</code></pre>
<h2 id="l1block"><a class="header" href="#l1block">L1Block</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Constant</th><th>Value</th></tr></thead><tbody>
<tr><td>Address</td><td><code>0x4200000000000000000000000000000000000015</code></td></tr>
</tbody></table>
</div>
<p>The <code>L1Block</code> contract is updated to include the set of allowed chains. The L1 Attributes transaction
sets the set of allowed chains. The <code>L1Block</code> contract MUST provide a public getter to check if a particular
chain is in the dependency set called <code>isInDependencySet(uint256)</code>. This function MUST return true when
the chain's chain id is passed in as an argument.</p>
<p>The <code>setL1BlockValuesInterop()</code> function MUST be called on every block after the interop upgrade block.
The interop upgrade block itself MUST include a call to <code>setL1BlockValuesEcotone</code>.</p>
<h3 id="l1attributes"><a class="header" href="#l1attributes">L1Attributes</a></h3>
<p>The L1 Atrributes transaction is updated to include the dependency set. Since the dependency set is dynamically sized,
a <code>uint8</code> "interopSetSize" parameter prefixes tightly packed <code>uint256</code> values that represent each chain id.</p>
<div class="table-wrapper"><table><thead><tr><th>Input arg</th><th>Type</th><th>Calldata bytes</th><th>Segment</th></tr></thead><tbody>
<tr><td>{0x760ee04d}</td><td>bytes4</td><td>0-3</td><td>n/a</td></tr>
<tr><td>baseFeeScalar</td><td>uint32</td><td>4-7</td><td>1</td></tr>
<tr><td>blobBaseFeeScalar</td><td>uint32</td><td>8-11</td><td></td></tr>
<tr><td>sequenceNumber</td><td>uint64</td><td>12-19</td><td></td></tr>
<tr><td>l1BlockTimestamp</td><td>uint64</td><td>20-27</td><td></td></tr>
<tr><td>l1BlockNumber</td><td>uint64</td><td>28-35</td><td></td></tr>
<tr><td>basefee</td><td>uint256</td><td>36-67</td><td>2</td></tr>
<tr><td>blobBaseFee</td><td>uint256</td><td>68-99</td><td>3</td></tr>
<tr><td>l1BlockHash</td><td>bytes32</td><td>100-131</td><td>4</td></tr>
<tr><td>batcherHash</td><td>bytes32</td><td>132-163</td><td>5</td></tr>
<tr><td>interopSetSize</td><td>uint8</td><td>164-165</td><td>6</td></tr>
<tr><td>chainIds</td><td>uint256[interopSetSize]</td><td>165-(32*interopSetSize)</td><td>6+</td></tr>
</tbody></table>
</div>
<h2 id="security-considerations"><a class="header" href="#security-considerations">Security Considerations</a></h2>
<p>TODO</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../interop/messaging.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../interop/execution.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../interop/messaging.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../interop/execution.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../specs/static/solidity.min.js"></script>
        <script src="../specs/static/mermaid.min.js"></script>
        <script src="../specs/static/mermaid-init.js"></script>


    </div>
    </body>
</html>
