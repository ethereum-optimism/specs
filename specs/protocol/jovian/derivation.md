# Derivation

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
**Table of Contents**

- [Activation Block Rules](#activation-block-rules)
- [Network Upgrade Transactions](#network-upgrade-transactions)
  - [L1Block Deployment](#l1block-deployment)
  - [L1Block Proxy Update](#l1block-proxy-update)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

## Activation Block Rules

The first block with a timestamp at or after the Jovian activation time is considered the _Jovian activation block_.

To not modify or interrupt the system behavior regarding gas computations, the activation block must not include any
non-deposit transactions. Sequencer must enforce this by setting `noTxPool` to `true` in the payload attributes. This
rule must be checked during derivation at the batch verification stage, and if the batch for the activation block
contains any transactions, it must be `DROP`ped.

On the Jovian activation block, in addition to the L1 attributes deposit and potentially any user deposits from L1, a
set of deposit transaction-based upgrade transactions are deterministically generated by the derivation pipeline in the
following order:

- L1 Attributes Transaction (still calling the old `L1Block.setL1BlockValuesIsthmus()`)
- User deposits from L1 (if any)
- Network Upgrade Transactions
  - L1Block deployment
  - Update L1Block Proxy ERC-1967 Implementation

The network upgrade transactions are specified in the next section.

## Network Upgrade Transactions

The upgrade transaction details below are based on the monorepo at commit hash
`7daaabbf2c2cce892aa171bc7e1331ad31bcc8ca`, and will be updated once a contracts release is made.

### L1Block Deployment
<!-- Generated with: ./scripts/run_gen_predeploy_docs.sh --optimism-repo-path ../../optimism \
--fork-name Jovian \
--contract-name L1Block \
--from-address 0x4210000000000000000000000000000000000006 \
--from-address-nonce 0 \
--git-commit-hash 7daaabbf2c2cce892aa171bc7e1331ad31bcc8ca \
--eth-rpc-url https://optimism.rpc.subquery.network/public \
--proxy-address 0x4200000000000000000000000000000000000015 \
--copy-contract-bytecode true -->

The `L1Block` contract is deployed.

A deposit transaction is derived with the following attributes:

- `from`: `0x4210000000000000000000000000000000000006`
- `to`: `null`
- `mint`: `0`
- `value`: `0`
- `nonce`: `0`
- `gasLimit`: `444775`
- `data`: `0x0x608060405234801561001057600080...` ([full bytecode](../../../specs/static/bytecode/jovian-l1-block-deployment.txt))
- `sourceHash`: `0x98faf23b9795967bc0b1c543144739d50dba3ea40420e77ad6ca9848dbfb62e8`,
  computed with the "Upgrade-deposited" type, with `intent = "Jovian: L1Block Deployment"`

This results in the Jovian L1Block contract being deployed to
`0x3Ba4007f5C922FBb33C454B41ea7a1f11E83df2C`, to verify:

```bash
cast compute-address --nonce=0 0x4210000000000000000000000000000000000006
Computed Address: 0x3Ba4007f5C922FBb33C454B41ea7a1f11E83df2C
```

Verify `sourceHash`:

```bash
cast keccak $(cast concat-hex 0x0000000000000000000000000000000000000000000000000000000000000002 $(cast keccak "Jovian: L1Block Deployment"))
# 0x98faf23b9795967bc0b1c543144739d50dba3ea40420e77ad6ca9848dbfb62e8
```

Verify `data`:

```bash
git checkout 7daaabbf2c2cce892aa171bc7e1331ad31bcc8ca
make build-contracts
jq -r ".bytecode.object" packages/contracts-bedrock/forge-artifacts/L1Block.sol/L1Block.json
```

This transaction MUST deploy a contract with the following code hash
`0xf7b6ef0de2a53625d467d98c2932a5a5d64ffa1a331ebbde5bb06e2591b5835a`.

To verify the code hash:

```bash
git checkout 7daaabbf2c2cce892aa171bc7e1331ad31bcc8ca
make build-contracts
cast k $(jq -r ".deployedBytecode.object" packages/contracts-bedrock/forge-artifacts/L1Block.sol/L1Block.json)
```

### L1Block Proxy Update

This transaction updates the L1Block Proxy ERC-1967
implementation slot to point to the new L1Block deployment.

A deposit transaction is derived with the following attributes:

- `from`: `0x0000000000000000000000000000000000000000`
- `to`: `0x4200000000000000000000000000000000000015` (L1Block Proxy)
- `mint`: `0`
- `value`: `0`
- `gasLimit`: `50,000`
- `data`: `0x3659cfe60000000000000000000000003ba4007f5c922fbb33c454b41ea7a1f11e83df2c`
- `sourceHash`: `0x08447273a4fbce97bc8c515f97ac74efc461f6a4001553712f31ebc11288bad2`
  computed with the "Upgrade-deposited" type, with `intent = "Jovian: L1Block Proxy Update"`

Verify data:

```bash
cast concat-hex $(cast sig "upgradeTo(address)") $(cast abi-encode "upgradeTo(address)" 0x3Ba4007f5C922FBb33C454B41ea7a1f11E83df2C)
# 0x3659cfe60000000000000000000000003ba4007f5c922fbb33c454b41ea7a1f11e83df2c
```

Verify `sourceHash`:

```bash
cast keccak $(cast concat-hex 0x0000000000000000000000000000000000000000000000000000000000000002 $(cast keccak "Jovian: L1Block Proxy Update"))
# 0x08447273a4fbce97bc8c515f97ac74efc461f6a4001553712f31ebc11288bad2
```
