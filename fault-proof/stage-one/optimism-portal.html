<!DOCTYPE HTML>
<html lang="en" class="ayu sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Optimism Portal - OP Stack Specification</title>


        <!-- Custom HTML head -->
        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-YNLKSPKGWN"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag() { dataLayer.push(arguments); }
            gtag('js', new Date());
            gtag('config', 'G-YNLKSPKGWN');
        </script>
        <meta name="google-site-verification" content="1XjEcxxHshd6NM_mxbl_uv-SyamI6_99aOpILYI3_mk" />

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../theme/css/footer.css">


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "ayu";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">OP Stack Specification</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/ethereum-optimism/specs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/ethereum-optimism/specs/edit/main/specs/fault-proof/stage-one/optimism-portal.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="optimismportal"><a class="header" href="#optimismportal">OptimismPortal</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#definitions">Definitions</a>
<ul>
<li><a href="#proof-maturity-delay">Proof Maturity Delay</a></li>
<li><a href="#proven-withdrawal">Proven Withdrawal</a></li>
<li><a href="#finalized-withdrawal">Finalized Withdrawal</a></li>
<li><a href="#valid-withdrawal">Valid Withdrawal</a></li>
<li><a href="#invalid-withdrawal">Invalid Withdrawal</a></li>
<li><a href="#l2-withdrawal-sender">L2 Withdrawal Sender</a></li>
<li><a href="#receive-default-gas-limit">Receive Default Gas Limit</a></li>
<li><a href="#minimum-gas-limit">Minimum Gas Limit</a></li>
<li><a href="#unsafe-target">Unsafe Target</a></li>
<li><a href="#block-output">Block Output</a></li>
<li><a href="#output-root">Output Root</a></li>
<li><a href="#super-output">Super Output</a></li>
<li><a href="#super-root">Super Root</a></li>
</ul>
</li>
<li><a href="#assumptions">Assumptions</a>
<ul>
<li><a href="#aop-001-dispute-game-contracts-properly-report-important-properties">aOP-001: Dispute Game contracts properly report important properties</a>
<ul>
<li><a href="#mitigations">Mitigations</a></li>
</ul>
</li>
<li><a href="#aop-002-disputegamefactory-properly-reports-its-created-games">aOP-002: DisputeGameFactory properly reports its created games</a>
<ul>
<li><a href="#mitigations-1">Mitigations</a></li>
</ul>
</li>
<li><a href="#aop-003-incorrectly-resolving-games-will-be-invalidated-before-they-have-valid-claims">aOP-003: Incorrectly resolving games will be invalidated before they have Valid Claims</a>
<ul>
<li><a href="#mitigations-2">Mitigations</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#dependencies">Dependencies</a></li>
<li><a href="#invariants">Invariants</a>
<ul>
<li><a href="#iop-001-invalid-withdrawals-can-never-be-finalized">iOP-001: Invalid Withdrawals can never be finalized</a>
<ul>
<li><a href="#impact">Impact</a></li>
</ul>
</li>
<li><a href="#iop-002-valid-withdrawals-can-always-be-finalized-in-bounded-time">iOP-002: Valid Withdrawals can always be finalized in bounded time</a>
<ul>
<li><a href="#impact-1">Impact</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#function-specification">Function Specification</a>
<ul>
<li><a href="#constructor">constructor</a></li>
<li><a href="#initialize">initialize</a></li>
<li><a href="#paused">paused</a></li>
<li><a href="#guardian">guardian</a></li>
<li><a href="#ethlockbox">ethLockbox</a></li>
<li><a href="#proofmaturitydelayseconds">proofMaturityDelaySeconds</a></li>
<li><a href="#disputegamefactory">disputeGameFactory</a></li>
<li><a href="#disputegamefinalitydelayseconds">disputeGameFinalityDelaySeconds</a></li>
<li><a href="#respectedgametype">respectedGameType</a></li>
<li><a href="#respectedgametypeupdatedat">respectedGameTypeUpdatedAt</a></li>
<li><a href="#l2sender">l2Sender</a></li>
<li><a href="#provewithdrawaltransaction">proveWithdrawalTransaction</a></li>
<li><a href="#checkwithdrawal">checkWithdrawal</a></li>
<li><a href="#finalizewithdrawaltransaction">finalizeWithdrawalTransaction</a></li>
<li><a href="#donateeth">donateETH</a></li>
<li><a href="#finalizewithdrawaltransactionexternalproof">finalizeWithdrawalTransactionExternalProof</a></li>
<li><a href="#numproofsubmitters">numProofSubmitters</a></li>
<li><a href="#receive">receive</a></li>
<li><a href="#minimumgaslimit">minimumGasLimit</a></li>
<li><a href="#superchainconfig">superchainConfig</a></li>
<li><a href="#disputegameblacklist">disputeGameBlacklist</a></li>
<li><a href="#deposittransaction">depositTransaction</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>The <code>OptimismPortal</code> contract is the primary interface for deposits and withdrawals between the L1
and L2 chains within an OP Stack system. The <code>OptimismPortal</code> contract allows users to create
"deposit transactions" on the L1 chain that are automatically executed on the L2 chain within a
bounded amount of time. Additionally, the <code>OptimismPortal</code> contract allows users to execute
withdrawal transactions by proving that such a withdrawal was initiated on the L2 chain. The
<code>OptimismPortal</code> verifies the correctness of these withdrawal transactions against Output Roots
that have been declared valid by the L1 Fault Proof system.</p>
<h2 id="definitions"><a class="header" href="#definitions">Definitions</a></h2>
<h3 id="proof-maturity-delay"><a class="header" href="#proof-maturity-delay">Proof Maturity Delay</a></h3>
<p>The <strong>Proof Maturity Delay</strong> is the minimum amount of time that a withdrawal must be a
<a href="#proven-withdrawal">Proven Withdrawal</a> before it can be finalized.</p>
<h3 id="proven-withdrawal"><a class="header" href="#proven-withdrawal">Proven Withdrawal</a></h3>
<p>A <strong>Proven Withdrawal</strong> is a withdrawal transaction that has been proven against some Output Root
by a user. Users can prove withdrawals against any Dispute Game contract that meets the following
conditions:</p>
<ul>
<li>The game is a <a href="./anchor-state-registry.html#registered-game">Registered Game</a></li>
<li>The game is not a <a href="./anchor-state-registry.html#retired-game">Retired Game</a></li>
<li>The game has a game type that matches the current
<a href="./anchor-state-registry.html#respected-game-type">Respected Game Type</a></li>
<li>The game has not resolved in favor of the Challenger</li>
</ul>
<p>Notably, the <code>OptimismPortal</code> allows users to prove withdrawals against games that are currently
in progress (games that are not <a href="./anchor-state-registry.html#resolved-game">Resolved Games</a>).</p>
<p>Users may re-prove a withdrawal at any time. User withdrawals are stored on a per-user basis such
that re-proving a withdrawal cannot cause the timer for
<a href="#finalized-withdrawal">finalizing a withdrawal</a> to be reset for another user.</p>
<h3 id="finalized-withdrawal"><a class="header" href="#finalized-withdrawal">Finalized Withdrawal</a></h3>
<p>A <strong>Finalized Withdrawal</strong> is a withdrawal transaction that was previously a Proven Withdrawal and
meets a number of additional conditions that allow the withdrawal to be executed.</p>
<p>Users can finalize a withdrawal if they have previously proven the withdrawal and their withdrawal
meets the following conditions:</p>
<ul>
<li>Withdrawal is a <a href="#proven-withdrawal">Proven Withdrawal</a></li>
<li>Withdrawal was proven at least <a href="#proof-maturity-delay">Proof Maturity Delay</a> seconds ago</li>
<li>Withdrawal was proven against a game with a <a href="./anchor-state-registry.html#valid-claim">Valid Claim</a></li>
<li>Withdrawal was not previously finalized</li>
</ul>
<h3 id="valid-withdrawal"><a class="header" href="#valid-withdrawal">Valid Withdrawal</a></h3>
<p>A <strong>Valid Withdrawal</strong> is a withdrawal transaction that was correctly executed on the L2 system as
would be reported by a perfect oracle for the query.</p>
<h3 id="invalid-withdrawal"><a class="header" href="#invalid-withdrawal">Invalid Withdrawal</a></h3>
<p>An <strong>Invalid Withdrawal</strong> is any withdrawal that is not a <a href="#valid-withdrawal">Valid Withdrawal</a>.</p>
<h3 id="l2-withdrawal-sender"><a class="header" href="#l2-withdrawal-sender">L2 Withdrawal Sender</a></h3>
<p>The <strong>L2 Withdrawal Sender</strong> is the address of the account that triggered a given withdrawal
transaction on L2. The <code>OptimismPortal</code> is expected to expose a variable that includes this value
when <a href="#finalized-withdrawal">finalizing</a> a withdrawal.</p>
<h3 id="receive-default-gas-limit"><a class="header" href="#receive-default-gas-limit">Receive Default Gas Limit</a></h3>
<p>The receive default gas limit is the gas limit provided for simple ETH deposits that are triggered
when a user sends ETH to the <code>OptimismPortal</code> via the <code>receive</code> function. This gas limit is
currently set to a value of 100000 gas.</p>
<h3 id="minimum-gas-limit"><a class="header" href="#minimum-gas-limit">Minimum Gas Limit</a></h3>
<p>The minimum gas limit is the minimum amount of L2 gas that must be purchased when creating a
deposit transaction. This limit increases linearly based on the size of the calldata to prevent
users from creating L2 resource usage without paying for it. The minimum gas limit is calculated
as: calldata_byte_count * 40 + 21000.</p>
<h3 id="unsafe-target"><a class="header" href="#unsafe-target">Unsafe Target</a></h3>
<p>An <strong>Unsafe Target</strong> is a target address that is considered unsafe for withdrawal or deposit
transactions. Unsafe targets include the OptimismPortal contract itself and the ETHLockbox
contract. Targeting these addresses could potentially create attack vectors.</p>
<h3 id="block-output"><a class="header" href="#block-output">Block Output</a></h3>
<p>A <strong>Block Output</strong>, commonly called an <strong>Output</strong>, is a data structure that wraps the key hash
elements of a given L2 block.</p>
<p>The structure of the Block Output is versioned (32 bytes). The current Block Output version is
<code>0x0000000000000000000000000000000000000000000000000000000000000000</code> (V0). A V0 Block Output has
the following structure:</p>
<pre><code class="language-solidity">struct BlockOutput {
  bytes32 version;
  bytes32 stateRoot;
  bytes32 messagePasserStorageRoot;
  bytes32 blockHash;
}
</code></pre>
<p>Where:</p>
<ul>
<li><code>version</code> is a version identifier that describes the structure of the Output Root</li>
<li><code>stateRoot</code> is the state root of the L2 block this Output Root corresponds to</li>
<li><code>messagePasserStorageRoot</code> is the storage root of the <code>L2ToL1MessagePasser</code> contract at the L2
block this Output Root corresponds to</li>
<li><code>blockHash</code> is the block hash of the L2 block this Output Root corresponds to</li>
</ul>
<h3 id="output-root"><a class="header" href="#output-root">Output Root</a></h3>
<p>An <strong>Output Root</strong> is a commitment to a <a href="#block-output">Block Output</a>. A detailed description of
this commitment can be found <a href="../../protocol/proposals.html#l2-output-commitment-construction">on this page</a>.</p>
<h3 id="super-output"><a class="header" href="#super-output">Super Output</a></h3>
<p>A <strong>Super Output</strong> is a data structure that commits all of the <a href="#block-output">Block Outputs</a> for
all chains within the Superchain Interop Set at a given timestamp. A Super Output can also commit
to a single Block Output to maintain compatibility with chains outside of the Interop Set.</p>
<p>The structure of the Super Output is versioned (1 byte). The current version is <code>0x01</code> (V1). A V1
Super Output has the following structure:</p>
<pre><code class="language-solidity">struct OutputRootWithChainId {
  uint256 chainId;
  bytes32 root;
}

struct SuperOutput {
  uint64 timestamp;
  OutputRootWithChainid[] outputRoots;
}
</code></pre>
<p>The output root for each chain in the super root MUST be for the block with a timestamp where
<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal">im</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7335em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">Bl</span><span class="mord mathnormal">oc</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal">im</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal">im</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal">im</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> where <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal">im</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is the super root timestamp, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">Bl</span><span class="mord mathnormal">oc</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal">im</span><span class="mord mathnormal">e</span></span></span></span> is the chain block time
and <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal">im</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is the block timestamp. That is the output root must be from the last possible block at or before the super
root timestamp.</p>
<p>The output roots in the super root MUST be sorted by chain ID ascending.</p>
<h3 id="super-root"><a class="header" href="#super-root">Super Root</a></h3>
<p>A <strong>Super Root</strong> is a commitment to a <a href="#super-output">Super Output</a>, computed as:</p>
<pre><code class="language-solidity">keccak256(encodeSuperRoot(SuperRoot))
</code></pre>
<p>Where <code>encodeSuperRoot</code> for the V1 Super Output is:</p>
<pre><code class="language-solidity">function encodeSuperRoot(SuperRoot memory root) returns (bytes) {
  require(root.outputRoots.length &gt; 0); // Super Root must have at least one Output Root.
  return concat(
    0x01, // Super Root version byte
    root.timestamp,
    [
      concat(outputRoot.chainId, outputRoot.root)
      for outputRoot
      in root.outputRoots
    ]
  );
}
</code></pre>
<h2 id="assumptions"><a class="header" href="#assumptions">Assumptions</a></h2>
<h3 id="aop-001-dispute-game-contracts-properly-report-important-properties"><a class="header" href="#aop-001-dispute-game-contracts-properly-report-important-properties">aOP-001: Dispute Game contracts properly report important properties</a></h3>
<p>We assume that the <code>FaultDisputeGame</code> and <code>PermissionedDisputeGame</code> contracts properly and
faithfully report the following properties:</p>
<ul>
<li>Game type</li>
<li>L2 block number</li>
<li>Root claim value</li>
<li>Game extra data</li>
<li>Creation timestamp</li>
<li>Resolution timestamp</li>
<li>Resolution result</li>
<li>Whether the game was the respected game type at creation</li>
</ul>
<p>We also specifically assume that the game creation timestamp and the resolution timestamp are not
set to values in the future.</p>
<h4 id="mitigations"><a class="header" href="#mitigations">Mitigations</a></h4>
<ul>
<li>Existing audit on the <code>FaultDisputeGame</code> contract</li>
<li>Integration testing</li>
</ul>
<h3 id="aop-002-disputegamefactory-properly-reports-its-created-games"><a class="header" href="#aop-002-disputegamefactory-properly-reports-its-created-games">aOP-002: DisputeGameFactory properly reports its created games</a></h3>
<p>We assume that the <code>DisputeGameFactory</code> contract properly and faithfully reports the games it has
created.</p>
<h4 id="mitigations-1"><a class="header" href="#mitigations-1">Mitigations</a></h4>
<ul>
<li>Existing audit on the <code>DisputeGameFactory</code> contract</li>
<li>Integration testing</li>
</ul>
<h3 id="aop-003-incorrectly-resolving-games-will-be-invalidated-before-they-have-valid-claims"><a class="header" href="#aop-003-incorrectly-resolving-games-will-be-invalidated-before-they-have-valid-claims">aOP-003: Incorrectly resolving games will be invalidated before they have Valid Claims</a></h3>
<p>We assume that any games that are resolved incorrectly will be invalidated either by
<a href="./anchor-state-registry.html#blacklisted-game">blacklisting</a> or by
<a href="./anchor-state-registry.html#retired-game">retirement</a> BEFORE they are considered to have
<a href="./anchor-state-registry.html#valid-claim">Valid Claims</a>.</p>
<p>Proper Games that resolve in favor the Defender will be considered to have Valid Claims after the
<a href="./anchor-state-registry.html#dispute-game-finality-delay-airgap">Dispute Game Finality Delay</a> has
elapsed UNLESS the Pause Mechanism is active. Therefore, in the absence of the Pause Mechanism,
parties responsible for game invalidation have exactly the Dispute Game Finality Delay to
invalidate a withdrawal after it resolves incorrectly. If the Pause Mechanism is active, then any
incorrectly resolving games must be invalidated before the pause is deactivated.</p>
<h4 id="mitigations-2"><a class="header" href="#mitigations-2">Mitigations</a></h4>
<ul>
<li>Stakeholder incentives / processes</li>
<li>Incident response plan</li>
<li>Monitoring</li>
</ul>
<h2 id="dependencies"><a class="header" href="#dependencies">Dependencies</a></h2>
<ul>
<li><a href="./anchor-state-registry.html#iasr-001-games-are-represented-as-proper-games-accurately">iASR-001</a></li>
<li><a href="./anchor-state-registry.html#iasr-002-all-valid-claims-are-truly-valid-claims">iASR-002</a></li>
</ul>
<h2 id="invariants"><a class="header" href="#invariants">Invariants</a></h2>
<h3 id="iop-001-invalid-withdrawals-can-never-be-finalized"><a class="header" href="#iop-001-invalid-withdrawals-can-never-be-finalized">iOP-001: Invalid Withdrawals can never be finalized</a></h3>
<p>We require that <a href="#invalid-withdrawal">Invalid Withdrawals</a> can never be
<a href="#finalized-withdrawal">finalized</a> for any reason.</p>
<h4 id="impact"><a class="header" href="#impact">Impact</a></h4>
<p><strong>Severity: Critical</strong></p>
<p>If this invariant is broken, any number of arbitrarily bad outcomes could happen. Most obviously,
we would expect all bridge systems relying on the <code>OptimismPortal</code> to be immediately compromised.</p>
<h3 id="iop-002-valid-withdrawals-can-always-be-finalized-in-bounded-time"><a class="header" href="#iop-002-valid-withdrawals-can-always-be-finalized-in-bounded-time">iOP-002: Valid Withdrawals can always be finalized in bounded time</a></h3>
<p>We require that <a href="#valid-withdrawal">Valid Withdrawals</a> can always be
<a href="#finalized-withdrawal">finalized</a> within some reasonable, bounded amount of time.</p>
<h4 id="impact-1"><a class="header" href="#impact-1">Impact</a></h4>
<p><strong>Severity: Critical</strong></p>
<p>If this invariant is broken, we would expect that users are unable to withdraw bridged assets. We
see this as a critical system risk.</p>
<h2 id="function-specification"><a class="header" href="#function-specification">Function Specification</a></h2>
<h3 id="constructor"><a class="header" href="#constructor">constructor</a></h3>
<ul>
<li>MUST set the value of the <a href="#proof-maturity-delay">Proof Maturity Delay</a>.</li>
</ul>
<h3 id="initialize"><a class="header" href="#initialize">initialize</a></h3>
<ul>
<li>MUST only be callable by the ProxyAdmin or its owner.</li>
<li>MUST set the value of the <code>SystemConfig</code> contract.</li>
<li>MUST set the value of the <code>AnchorStateRegistry</code> contract.</li>
<li>MUST assert that the ETHLockbox state is valid based on the feature flag.</li>
<li>MUST set the value of the <a href="#l2-withdrawal-sender">L2 Withdrawal Sender</a> variable to the default
value if the value is not set already.</li>
<li>MUST initialize the resource metering configuration.</li>
</ul>
<h3 id="paused"><a class="header" href="#paused">paused</a></h3>
<p>Returns the current state of the <code>SystemConfig.paused()</code> function.</p>
<h3 id="guardian"><a class="header" href="#guardian">guardian</a></h3>
<p>Returns the address of the Guardian as per <code>SystemConfig.guardian()</code>.</p>
<h3 id="ethlockbox"><a class="header" href="#ethlockbox">ethLockbox</a></h3>
<p>Returns the address of the ETHLockbox configured for this contract. If the contract has not been
configured for this OptimismPortal, this function will return <code>address(0)</code>.</p>
<h3 id="proofmaturitydelayseconds"><a class="header" href="#proofmaturitydelayseconds">proofMaturityDelaySeconds</a></h3>
<p>Returns the value of the <a href="#proof-maturity-delay">Proof Maturity Delay</a>.</p>
<h3 id="disputegamefactory"><a class="header" href="#disputegamefactory">disputeGameFactory</a></h3>
<p>Returns the DisputeGameFactory contract from the AnchorStateRegistry contract.</p>
<h3 id="disputegamefinalitydelayseconds"><a class="header" href="#disputegamefinalitydelayseconds">disputeGameFinalityDelaySeconds</a></h3>
<p><strong>Legacy Function</strong></p>
<p>Returns the value of the
<a href="./anchor-state-registry.html#dispute-game-finality-delay-airgap">Dispute Game Finality Delay</a> as per
a call to <code>AnchorStateRegistry.disputeGameFinalityDelaySeconds()</code>.</p>
<h3 id="respectedgametype"><a class="header" href="#respectedgametype">respectedGameType</a></h3>
<p><strong>Legacy Function</strong></p>
<p>Returns the value of the current
<a href="./anchor-state-registry.html#respected-game-type">Respected Game Type</a> as per a call to
<code>AnchorStateRegistry.respectedGameType</code>.</p>
<h3 id="respectedgametypeupdatedat"><a class="header" href="#respectedgametypeupdatedat">respectedGameTypeUpdatedAt</a></h3>
<p><strong>Legacy Function</strong></p>
<p>Returns the value of the current
<a href="./anchor-state-registry.html#retirement-timestamp">Retirement Timestamp</a> as per a call to
`AnchorStateRegistry.retirementTimestamp.</p>
<h3 id="l2sender"><a class="header" href="#l2sender">l2Sender</a></h3>
<p>Returns the address of the <a href="#l2-withdrawal-sender">L2 Withdrawal Sender</a>. If the <code>OptimismPortal</code>
has not been initialized then this value will be <code>address(0)</code> and should not be used. If the
<code>OptimismPortal</code> is not currently executing an withdrawal transaction then this value will be
<code>0x000000000000000000000000000000000000dEaD</code> and should not be used.</p>
<h3 id="provewithdrawaltransaction"><a class="header" href="#provewithdrawaltransaction">proveWithdrawalTransaction</a></h3>
<p>Allows a user to <a href="#proven-withdrawal">prove</a> a withdrawal transaction.</p>
<ul>
<li>MUST revert if the system is paused.</li>
<li>MUST revert if the withdrawal target is an <a href="#unsafe-target">Unsafe Target</a>.</li>
<li>MUST revert if the withdrawal is being proven against a game that is not a
<a href="./anchor-state-registry.html#proper-game">Proper Game</a>.</li>
<li>MUST revert if the withdrawal is being proven against a game that is not a
<a href="./anchor-state-registry.html#respected-game">Respected Game</a>.</li>
<li>MUST revert if the withdrawal is being proven against a game that has resolved in favor of the
Challenger.</li>
<li>MUST revert if the current timestamp is less than or equal to the dispute game's creation
timestamp.</li>
<li>MUST revert if the proof provided by the user of the preimage of the Output Root that the dispute
game argues about is invalid. This proof is verified by hashing the user-provided preimage and
comparing them to the root claim of the referenced dispute game.</li>
<li>MUST revert if the provided merkle trie proof that the withdrawal was included within the root
claim of the provided dispute game is invalid.</li>
<li>MUST otherwise store a record of the withdrawal proof that includes the hash of the proven
withdrawal, the address of the game against which it was proven, and the block timestamp at which
the proof transaction was submitted.</li>
<li>MUST add the proof submitter to the list of submitters for this withdrawal hash.</li>
<li>MUST emit a <code>WithdrawalProven</code> event with the withdrawal hash, sender, and target.</li>
<li>MUST emit a <code>WithdrawalProvenExtension1</code> event with the withdrawal hash and proof submitter address.</li>
</ul>
<h3 id="checkwithdrawal"><a class="header" href="#checkwithdrawal">checkWithdrawal</a></h3>
<p>Checks that a withdrawal transaction can be <a href="#finalized-withdrawal">finalized</a>.</p>
<ul>
<li>MUST revert if the withdrawal being finalized has already been finalized.</li>
<li>MUST revert if the withdrawal being finalized has not been proven.</li>
<li>MUST revert if the withdrawal was proven at a timestamp less than or equal to the creation
timestamp of the dispute game it was proven against, which would signal an unexpected proving
bug. Note that prevents withdrawals from being proven in the same block that a dispute game is
created.</li>
<li>MUST revert if the withdrawal being finalized has been proven less than
<a href="#proof-maturity-delay">Proof Maturity Delay</a> seconds ago.</li>
<li>MUST revert if the withdrawal being finalized was proven against a game that does not have a
<a href="./anchor-state-registry.html#valid-claim">Valid Claim</a>.</li>
</ul>
<h3 id="finalizewithdrawaltransaction"><a class="header" href="#finalizewithdrawaltransaction">finalizeWithdrawalTransaction</a></h3>
<p>Allows a user to <a href="#finalized-withdrawal">finalize</a> a withdrawal transaction.</p>
<ul>
<li>MUST delegate to <code>finalizeWithdrawalTransactionExternalProof</code> with <code>msg.sender</code> as the proof
submitter.</li>
</ul>
<h3 id="donateeth"><a class="header" href="#donateeth">donateETH</a></h3>
<p>Allows any address to donate ETH to the contract without triggering a deposit to L2.</p>
<ul>
<li>MUST accept ETH payments via the payable modifier.</li>
<li>MUST not perform any state-changing operations.</li>
<li>MUST not trigger a deposit transaction to L2.</li>
</ul>
<h3 id="finalizewithdrawaltransactionexternalproof"><a class="header" href="#finalizewithdrawaltransactionexternalproof">finalizeWithdrawalTransactionExternalProof</a></h3>
<p>Allows a user to <a href="#finalized-withdrawal">finalize</a> a withdrawal transaction using a proof submitted
by another address.</p>
<ul>
<li>MUST revert if the system is paused.</li>
<li>MUST revert if the function is called while a previous withdrawal is being executed.</li>
<li>MUST revert if the withdrawal target is an <a href="#unsafe-target">Unsafe Target</a>.</li>
<li>MUST revert if the withdrawal being finalized does not pass <code>checkWithdrawal</code>.</li>
<li>MUST mark the withdrawal as finalized.</li>
<li>MUST unlock ETH from the ETHLockbox if the withdrawal includes an ETH value AND the OptimismPortal
has an ETHLockbox configured AND the ETHLockbox system feature is active.</li>
<li>MUST set the L2 Withdrawal Sender variable correctly.</li>
<li>MUST execute the withdrawal transaction by executing a contract call to the target address with
the data and ETH value specified within the withdrawal using AT LEAST the minimum amount of gas
specified by the withdrawal.</li>
<li>MUST unset the L2 Withdrawal Sender after the withdrawal call.</li>
<li>MUST emit a <code>WithdrawalFinalized</code> event with the withdrawal hash and success status.</li>
<li>MUST lock any unused ETH back into the ETHLockbox if the call to the target address fails AND the
OptimismPortal has an ETHLockbox configured AND the ETHLockbox system feature is active.</li>
<li>MUST revert if the withdrawal call fails and the transaction origin is the estimation address, to
help determine exact gas costs.</li>
</ul>
<h3 id="numproofsubmitters"><a class="header" href="#numproofsubmitters">numProofSubmitters</a></h3>
<p>Returns the number of proof submitters for a given withdrawal hash.</p>
<ul>
<li>MUST return the length of the proofSubmitters array for the specified withdrawal hash.</li>
<li>MUST NOT change state.</li>
</ul>
<h3 id="receive"><a class="header" href="#receive">receive</a></h3>
<p>Accepts ETH value and creates a deposit transaction to the sender's address on L2.</p>
<ul>
<li>MUST be payable and accept ETH.</li>
<li>MUST create a deposit transaction where the sender and target are the same address, refer to
<a href="#deposittransaction">depositTransaction</a> for full specification of expected behavior.</li>
<li>MUST use the <a href="#receive-default-gas-limit">receive default gas limit</a> as the gas limit.</li>
<li>MUST set contract creation flag to false.</li>
<li>MUST use empty data for the deposit.</li>
<li>MUST transform the sender address to its alias if the caller is a contract.</li>
<li>MUST emit a TransactionDeposited event with the appropriate parameters.</li>
</ul>
<h3 id="minimumgaslimit"><a class="header" href="#minimumgaslimit">minimumGasLimit</a></h3>
<p>Computes the minimum gas limit for a deposit transaction based on calldata size.</p>
<ul>
<li>MUST calculate the minimum gas limit using the formula: calldata_byte_count * 40 + 21000.</li>
</ul>
<h3 id="superchainconfig"><a class="header" href="#superchainconfig">superchainConfig</a></h3>
<p>Returns the <code>SuperchainConfig</code> contract address.</p>
<ul>
<li>MUST return the address of the <code>SuperchainConfig</code> contract stored in the <code>SystemConfig</code> contract
that was set during initialization.</li>
</ul>
<h3 id="disputegameblacklist"><a class="header" href="#disputegameblacklist">disputeGameBlacklist</a></h3>
<p><strong>Legacy Function</strong></p>
<p>Checks if a dispute game is blacklisted.</p>
<ul>
<li>MUST delegate to the blacklist of the <code>AnchorStateRegistry</code> contract that was set during initialization.</li>
<li>MUST return whether the given dispute game is blacklisted.</li>
</ul>
<h3 id="deposittransaction"><a class="header" href="#deposittransaction">depositTransaction</a></h3>
<p>Accepts deposits of ETH and data, and emits a TransactionDeposited event for use in
deriving deposit transactions. Note that if a deposit is made by a contract, its
address will be aliased when retrieved using <code>tx.origin</code> or <code>msg.sender</code>. Consider
using the CrossDomainMessenger contracts for a simpler developer experience.</p>
<ul>
<li>MUST lock any ETH value (msg.value) in the ETHLockbox contract if the OptimismPortal has an
ETHLockbox configured AND the ETHLockbox system feature is active.</li>
<li>MUST revert if the target address is not address(0) for contract creations.</li>
<li>MUST revert if the gas limit provided is below the <a href="#minimum-gas-limit">minimum gas limit</a>.</li>
<li>MUST revert if the calldata is too large (&gt; 120,000 bytes).</li>
<li>MUST transform the sender address to its alias if the caller is a contract.</li>
<li>MUST apply resource metering to the gas limit parameter.</li>
<li>MUST emit a TransactionDeposited event with the from address, to address, deposit version, and
opaque data.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../fault-proof/stage-one/bridge-integration.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../protocol/precompiles.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../fault-proof/stage-one/bridge-integration.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../protocol/precompiles.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../specs/static/solidity.min.js"></script>
        <script src="../../specs/static/mermaid.min.js"></script>
        <script src="../../specs/static/mermaid-init.js"></script>
        <script src="../../theme/js/footer.js"></script>


    </div>
    </body>
</html>
