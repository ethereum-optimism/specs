version: 2.1

orbs:
  slack: circleci/slack@4.10.1
  utils: ethereum-optimism/circleci-utils@0.0.11

executors:
  base:
    machine:
      image: ubuntu-2204:2022.07.1
  builder:
    docker:
      - image: us-docker.pkg.dev/oplabs-tools-artifacts/images/ci-builder-rust:v0.35.0

commands:
  notify-failures-on-develop:
    description: "Notify Slack"
    parameters:
      channel:
        type: string
        default: C03N11M0BBN
    steps:
      - slack/notify:
          channel: << parameters.channel >>
          event: fail
          template: basic_fail_1
          branch_pattern: develop

jobs:
  lint-specs:
    executor: builder
    steps:
      - checkout
      - run:
          name: Install deps
          command: just deps
      - run:
          name: markdown lint
          command: just lint-specs-md-check
      - run:
          name: markdown toc
          command: just lint-specs-toc-check
      - run:
          name: build book
          command: just build

  lint-links:
    executor: base
    steps:
      - checkout
      - run:
          name: Lint check
          command: just lint-links
      - notify-failures-on-develop:
          channel: C055R639XT9 #notify-link-check

  publish-pages:
    executor: builder
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: just deps
      - run:
          name: Build
          command: just build
      - run:
          name: Add CNAME file
          command: echo "specs.optimism.io" > ./book/html/CNAME
      - utils/get-github-access-token
      - utils/github-pages-deploy:
          src-pages-dir: ./book/html

workflows:
  specs-check:
    when:
      not:
        equal: [scheduled_pipeline, << pipeline.trigger_source >>]
    jobs:
      - lint-specs
  scheduled-links-check:
    when:
      equal: [build_daily, <<pipeline.schedule.name>>]
    jobs:
      - lint-links:
          context: slack

  publish:
    jobs:
      - publish-pages:
          filters: 
            branches:
              only: main
